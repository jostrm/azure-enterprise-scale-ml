{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "1600851655190887317"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "aiServices": {
      "type": "string",
      "defaultValue": "aiservices",
      "minLength": 3,
      "metadata": {
        "description": "Base name prefix for new AI Services resources when new resources are created."
      }
    },
    "aiAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional override for the AI Services account name. When empty a unique name is generated."
      }
    },
    "deploymentTimestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMddHHmmss')]",
      "metadata": {
        "description": "Timestamp used to generate deterministic resource names (format yyyyMMddHHmmss)."
      }
    },
    "firstProjectName": {
      "type": "string",
      "defaultValue": "project",
      "metadata": {
        "description": "Name prefix for the default project."
      }
    },
    "projectDescription": {
      "type": "string",
      "defaultValue": "A project for the AI Foundry account with network secured deployed Agent",
      "metadata": {
        "description": "Description for the default project."
      }
    },
    "displayName": {
      "type": "string",
      "defaultValue": "network secured agent project",
      "metadata": {
        "description": "Display name for the default project."
      }
    },
    "privateEndpointSubnetResourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the subnet used for private endpoints."
      }
    },
    "agentSubnetResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource ID of the subnet used for agent network injection. Leave empty to skip injection."
      }
    },
    "disableAgentNetworkInjection": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Disable agent network injection even when an agent subnet is provided."
      }
    },
    "aiSearchResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing AI Search service resource ID. Leave empty to create a new instance."
      }
    },
    "azureStorageAccountResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing primary Storage account resource ID. Leave empty to create a new instance."
      }
    },
    "azureStorageAccountResourceIdSecondary": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing secondary Storage account resource ID. Leave empty to create a new instance for capability host workloads."
      }
    },
    "azureCosmosDBAccountResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Cosmos DB account resource ID. Leave empty to create a new instance."
      }
    },
    "apiManagementResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing API Management resource ID (for optional private endpoint)."
      }
    },
    "existingDnsZones": {
      "type": "object",
      "defaultValue": {
        "privatelink.services.ai.azure.com": "",
        "privatelink.openai.azure.com": "",
        "privatelink.cognitiveservices.azure.com": "",
        "privatelink.search.windows.net": "",
        "[format('privatelink.blob.{0}', environment().suffixes.storage)]": "",
        "privatelink.documents.azure.com": "",
        "privatelink.azure-api.net": ""
      },
      "metadata": {
        "description": "Object mapping Private DNS zone names to their resource group. Leave value empty to create the zone in the current resource group."
      }
    },
    "privateLinksDnsZones": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Private DNS zones configuration emitted from the networking landing zone."
      }
    },
    "allowPublicAccessWhenBehindVnet": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow public HTTP access while traffic flows through perimeter controls."
      }
    },
    "enablePublicGenAIAccess": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable public access to AI Services endpoints."
      }
    },
    "ipAllowList": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "IP addresses or CIDR ranges allowed through network ACLs when public access is enabled."
      }
    },
    "enableCapabilityHost": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable capability host configuration for the project."
      }
    },
    "projectCapHost": {
      "type": "string",
      "defaultValue": "caphostproj",
      "metadata": {
        "description": "Name suffix for the capability host resource."
      }
    },
    "userRoleObjectIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Array of user object IDs for Cognitive Services RBAC assignments."
      }
    },
    "servicePrincipalIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Array of service principal IDs for Cognitive Services RBAC assignments."
      }
    },
    "useAdGroups": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Treat entries in userRoleObjectIds as Azure AD groups instead of users."
      }
    },
    "extraModelDeployments": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional list of additional model deployments to create. Expected shape matches Microsoft.CognitiveServices/accounts/deployments properties."
      }
    },
    "modelName": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "metadata": {
        "description": "Model name for the default deployment."
      }
    },
    "modelFormat": {
      "type": "string",
      "defaultValue": "OpenAI",
      "metadata": {
        "description": "Model provider format for the default deployment."
      }
    },
    "modelVersion": {
      "type": "string",
      "defaultValue": "2024-11-20",
      "metadata": {
        "description": "Model version for the default deployment."
      }
    },
    "modelSkuName": {
      "type": "string",
      "defaultValue": "GlobalStandard",
      "metadata": {
        "description": "Model SKU for the default deployment."
      }
    },
    "modelCapacity": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Tokens per minute capacity for the default model deployment."
      }
    },
    "enableCosmosDb": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Cosmos DB integration."
      }
    },
    "enableAISearch": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable AI Search integration."
      }
    },
    "enableProject": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable creation of a default project."
      }
    },
    "centralDnsZoneByPolicyInHub": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Bypass Private DNS zone linking when central DNS zones are managed in a hub."
      }
    },
    "restrictOutboundNetworkAccess": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Restrict outbound network access for the AI Services account."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional tags applied to newly created resources."
      }
    },
    "aiAccountSku": {
      "type": "string",
      "defaultValue": "S0",
      "allowedValues": [
        "S0",
        "S",
        "S1",
        "S2",
        "S3",
        "S4",
        "S5",
        "S6",
        "S7",
        "S8",
        "S9"
      ],
      "metadata": {
        "description": "SKU tier for the AI Services account."
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "ipRules",
        "count": "[length(parameters('ipAllowList'))]",
        "input": {
          "value": "[if(contains(parameters('ipAllowList')[copyIndex('ipRules')], '/'), toLower(parameters('ipAllowList')[copyIndex('ipRules')]), format('{0}/32', toLower(parameters('ipAllowList')[copyIndex('ipRules')])))]"
        }
      },
      {
        "name": "dnsZoneValidation",
        "count": "[length(variables('dnsZoneNames'))]",
        "input": {
          "name": "[variables('dnsZoneNames')[copyIndex('dnsZoneValidation')]]",
          "exists": "[not(empty(string(parameters('existingDnsZones')[variables('dnsZoneNames')[copyIndex('dnsZoneValidation')]])))]"
        }
      }
    ],
    "uniqueSuffix": "[substring(uniqueString(format('{0}-{1}', resourceGroup().id, parameters('deploymentTimestamp'))), 0, 4)]",
    "baseAccountName": "[if(empty(parameters('aiAccountName')), toLower(format('{0}{1}', parameters('aiServices'), variables('uniqueSuffix'))), toLower(parameters('aiAccountName')))]",
    "accountName": "[take(variables('baseAccountName'), 63)]",
    "projectName": "[toLower(format('{0}{1}', parameters('firstProjectName'), variables('uniqueSuffix')))]",
    "storagePassedIn": "[not(empty(parameters('azureStorageAccountResourceId')))]",
    "storageParts": "[if(variables('storagePassedIn'), split(parameters('azureStorageAccountResourceId'), '/'), split('', '/'))]",
    "storageSubscriptionId": "[if(variables('storagePassedIn'), variables('storageParts')[2], subscription().subscriptionId)]",
    "storageResourceGroupName": "[if(variables('storagePassedIn'), variables('storageParts')[4], resourceGroup().name)]",
    "storageAccountName": "[if(variables('storagePassedIn'), last(variables('storageParts')), take(replace(toLower(format('{0}{1}storage', parameters('aiServices'), variables('uniqueSuffix'))), '-', ''), 24))]",
    "storageSecondPassedIn": "[not(empty(parameters('azureStorageAccountResourceIdSecondary')))]",
    "storageSecondParts": "[if(variables('storageSecondPassedIn'), split(parameters('azureStorageAccountResourceIdSecondary'), '/'), split('', '/'))]",
    "storageSecondSubscriptionId": "[if(variables('storageSecondPassedIn'), variables('storageSecondParts')[2], subscription().subscriptionId)]",
    "storageSecondResourceGroupName": "[if(variables('storageSecondPassedIn'), variables('storageSecondParts')[4], resourceGroup().name)]",
    "storageAccountNameSecondary": "[if(variables('storageSecondPassedIn'), last(variables('storageSecondParts')), take(replace(toLower(format('{0}{1}stor2', parameters('aiServices'), variables('uniqueSuffix'))), '-', ''), 24))]",
    "searchPassedIn": "[not(empty(parameters('aiSearchResourceId')))]",
    "searchParts": "[if(variables('searchPassedIn'), split(parameters('aiSearchResourceId'), '/'), split('', '/'))]",
    "aiSearchSubscriptionId": "[if(variables('searchPassedIn'), variables('searchParts')[2], subscription().subscriptionId)]",
    "aiSearchServiceResourceGroupName": "[if(variables('searchPassedIn'), variables('searchParts')[4], resourceGroup().name)]",
    "aiSearchName": "[if(variables('searchPassedIn'), last(variables('searchParts')), take(replace(toLower(format('{0}{1}search', parameters('aiServices'), variables('uniqueSuffix'))), '-', ''), 24))]",
    "cosmosPassedIn": "[not(empty(parameters('azureCosmosDBAccountResourceId')))]",
    "cosmosParts": "[if(variables('cosmosPassedIn'), split(parameters('azureCosmosDBAccountResourceId'), '/'), split('', '/'))]",
    "cosmosSubscriptionId": "[if(variables('cosmosPassedIn'), variables('cosmosParts')[2], subscription().subscriptionId)]",
    "cosmosResourceGroupName": "[if(variables('cosmosPassedIn'), variables('cosmosParts')[4], resourceGroup().name)]",
    "cosmosAccountName": "[if(variables('cosmosPassedIn'), last(variables('cosmosParts')), take(replace(toLower(format('{0}{1}cosmosdb', parameters('aiServices'), variables('uniqueSuffix'))), '-', ''), 44))]",
    "apiManagementProvided": "[not(empty(parameters('apiManagementResourceId')))]",
    "apiManagementParts": "[if(variables('apiManagementProvided'), split(parameters('apiManagementResourceId'), '/'), split('', '/'))]",
    "apiManagementSubscriptionId": "[if(variables('apiManagementProvided'), variables('apiManagementParts')[2], '')]",
    "apiManagementResourceGroupName": "[if(variables('apiManagementProvided'), variables('apiManagementParts')[4], '')]",
    "apiManagementName": "[if(variables('apiManagementProvided'), last(variables('apiManagementParts')), '')]",
    "privateEndpointSubnetSegments": "[split(parameters('privateEndpointSubnetResourceId'), '/subnets/')]",
    "virtualNetworkId": "[variables('privateEndpointSubnetSegments')[0]]",
    "privateEndpointSubnetName": "[variables('privateEndpointSubnetSegments')[1]]",
    "vnetSegments": "[split(variables('virtualNetworkId'), '/')]",
    "virtualNetworkName": "[variables('vnetSegments')[sub(length(variables('vnetSegments')), 1)]]",
    "virtualNetworkResourceGroupName": "[variables('vnetSegments')[4]]",
    "virtualNetworkSubscriptionId": "[variables('vnetSegments')[2]]",
    "agentNetworkInjectionEnabled": "[and(not(parameters('disableAgentNetworkInjection')), not(empty(parameters('agentSubnetResourceId'))))]",
    "hasNetworkAcls": "[or(or(not(empty(variables('ipRules'))), parameters('enablePublicGenAIAccess')), parameters('allowPublicAccessWhenBehindVnet'))]",
    "networkAcls": "[if(variables('hasNetworkAcls'), createObject('defaultAction', if(and(parameters('enablePublicGenAIAccess'), empty(variables('ipRules'))), 'Allow', 'Deny'), 'virtualNetworkRules', createArray(), 'ipRules', variables('ipRules')), null())]",
    "publicNetworkAccess": "[if(or(parameters('enablePublicGenAIAccess'), parameters('allowPublicAccessWhenBehindVnet')), 'Enabled', 'Disabled')]",
    "aiServicesDnsZoneName": "privatelink.services.ai.azure.com",
    "openAiDnsZoneName": "privatelink.openai.azure.com",
    "cognitiveServicesDnsZoneName": "privatelink.cognitiveservices.azure.com",
    "searchDnsZoneName": "privatelink.search.windows.net",
    "storageDnsZoneName": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
    "cosmosDnsZoneName": "privatelink.documents.azure.com",
    "apiManagementDnsZoneName": "privatelink.azure-api.net",
    "dnsZoneNames": [
      "[variables('aiServicesDnsZoneName')]",
      "[variables('openAiDnsZoneName')]",
      "[variables('cognitiveServicesDnsZoneName')]",
      "[variables('searchDnsZoneName')]",
      "[variables('storageDnsZoneName')]",
      "[variables('cosmosDnsZoneName')]",
      "[variables('apiManagementDnsZoneName')]"
    ],
    "servicesAiZoneFromLanding": "[if(contains(parameters('privateLinksDnsZones'), 'servicesai'), string(parameters('privateLinksDnsZones').servicesai.id), '')]",
    "openAiZoneFromLanding": "[if(contains(parameters('privateLinksDnsZones'), 'openai'), string(parameters('privateLinksDnsZones').openai.id), '')]",
    "cognitiveServicesZoneFromLanding": "[if(contains(parameters('privateLinksDnsZones'), 'cognitiveservices'), string(parameters('privateLinksDnsZones').cognitiveservices.id), '')]",
    "searchZoneFromLanding": "[if(contains(parameters('privateLinksDnsZones'), 'searchService'), string(parameters('privateLinksDnsZones').searchService.id), '')]",
    "storageZoneFromLanding": "[if(contains(parameters('privateLinksDnsZones'), 'blob'), string(parameters('privateLinksDnsZones').blob.id), '')]",
    "cosmosZoneFromLanding": "[if(contains(parameters('privateLinksDnsZones'), 'cosmosdbnosql'), string(parameters('privateLinksDnsZones').cosmosdbnosql.id), '')]",
    "apiManagementZoneFromLanding": "[if(contains(parameters('privateLinksDnsZones'), 'azureApiManagement'), string(parameters('privateLinksDnsZones').azureApiManagement.id), '')]",
    "aiServicesDnsZoneId": "[if(not(empty(variables('servicesAiZoneFromLanding'))), variables('servicesAiZoneFromLanding'), if(empty(string(parameters('existingDnsZones')[variables('aiServicesDnsZoneName')])), resourceId('Microsoft.Network/privateDnsZones', variables('aiServicesDnsZoneName')), resourceId(subscription().subscriptionId, string(parameters('existingDnsZones')[variables('aiServicesDnsZoneName')]), 'Microsoft.Network/privateDnsZones', variables('aiServicesDnsZoneName'))))]",
    "openAiDnsZoneId": "[if(not(empty(variables('openAiZoneFromLanding'))), variables('openAiZoneFromLanding'), if(empty(string(parameters('existingDnsZones')[variables('openAiDnsZoneName')])), resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName')), resourceId(subscription().subscriptionId, string(parameters('existingDnsZones')[variables('openAiDnsZoneName')]), 'Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))))]",
    "cognitiveServicesDnsZoneId": "[if(not(empty(variables('cognitiveServicesZoneFromLanding'))), variables('cognitiveServicesZoneFromLanding'), if(empty(string(parameters('existingDnsZones')[variables('cognitiveServicesDnsZoneName')])), resourceId('Microsoft.Network/privateDnsZones', variables('cognitiveServicesDnsZoneName')), resourceId(subscription().subscriptionId, string(parameters('existingDnsZones')[variables('cognitiveServicesDnsZoneName')]), 'Microsoft.Network/privateDnsZones', variables('cognitiveServicesDnsZoneName'))))]",
    "searchDnsZoneId": "[if(not(empty(variables('searchZoneFromLanding'))), variables('searchZoneFromLanding'), if(empty(string(parameters('existingDnsZones')[variables('searchDnsZoneName')])), resourceId('Microsoft.Network/privateDnsZones', variables('searchDnsZoneName')), resourceId(subscription().subscriptionId, string(parameters('existingDnsZones')[variables('searchDnsZoneName')]), 'Microsoft.Network/privateDnsZones', variables('searchDnsZoneName'))))]",
    "storageDnsZoneId": "[if(not(empty(variables('storageZoneFromLanding'))), variables('storageZoneFromLanding'), if(empty(string(parameters('existingDnsZones')[variables('storageDnsZoneName')])), resourceId('Microsoft.Network/privateDnsZones', variables('storageDnsZoneName')), resourceId(subscription().subscriptionId, string(parameters('existingDnsZones')[variables('storageDnsZoneName')]), 'Microsoft.Network/privateDnsZones', variables('storageDnsZoneName'))))]",
    "cosmosDnsZoneId": "[if(not(empty(variables('cosmosZoneFromLanding'))), variables('cosmosZoneFromLanding'), if(empty(string(parameters('existingDnsZones')[variables('cosmosDnsZoneName')])), resourceId('Microsoft.Network/privateDnsZones', variables('cosmosDnsZoneName')), resourceId(subscription().subscriptionId, string(parameters('existingDnsZones')[variables('cosmosDnsZoneName')]), 'Microsoft.Network/privateDnsZones', variables('cosmosDnsZoneName'))))]",
    "apiManagementDnsZoneId": "[if(not(empty(variables('apiManagementZoneFromLanding'))), variables('apiManagementZoneFromLanding'), if(empty(string(parameters('existingDnsZones')[variables('apiManagementDnsZoneName')])), resourceId('Microsoft.Network/privateDnsZones', variables('apiManagementDnsZoneName')), resourceId(subscription().subscriptionId, string(parameters('existingDnsZones')[variables('apiManagementDnsZoneName')]), 'Microsoft.Network/privateDnsZones', variables('apiManagementDnsZoneName'))))]",
    "storageInCurrentRg": "[and(equals(variables('storageResourceGroupName'), resourceGroup().name), equals(variables('storageSecondResourceGroupName'), resourceGroup().name))]",
    "searchInCurrentRg": "[equals(variables('aiSearchServiceResourceGroupName'), resourceGroup().name)]",
    "cosmosInCurrentRg": "[equals(variables('cosmosResourceGroupName'), resourceGroup().name)]",
    "defaultDeploymentName": "[take(format('{0}-{1}', parameters('modelName'), variables('uniqueSuffix')), 64)]",
    "aiAccountDnsConfigs": "[concat(if(and(not(empty(variables('aiServicesDnsZoneId'))), not(parameters('centralDnsZoneByPolicyInHub'))), createArray(createObject('name', 'aiservices', 'properties', createObject('privateDnsZoneId', variables('aiServicesDnsZoneId')))), createArray()), if(and(not(empty(variables('openAiDnsZoneId'))), not(parameters('centralDnsZoneByPolicyInHub'))), createArray(createObject('name', 'openai', 'properties', createObject('privateDnsZoneId', variables('openAiDnsZoneId')))), createArray()), if(and(not(empty(variables('cognitiveServicesDnsZoneId'))), not(parameters('centralDnsZoneByPolicyInHub'))), createArray(createObject('name', 'cognitiveservices', 'properties', createObject('privateDnsZoneId', variables('cognitiveServicesDnsZoneId')))), createArray()))]",
    "storageAccountId": "[if(variables('storagePassedIn'), parameters('azureStorageAccountResourceId'), resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')))]",
    "storageAccountSecondaryId": "[if(variables('storageSecondPassedIn'), parameters('azureStorageAccountResourceIdSecondary'), resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameSecondary')))]",
    "aiSearchResourceIdEffective": "[if(variables('searchPassedIn'), parameters('aiSearchResourceId'), if(parameters('enableAISearch'), resourceId('Microsoft.Search/searchServices', variables('aiSearchName')), ''))]",
    "cosmosResourceIdEffective": "[if(variables('cosmosPassedIn'), parameters('azureCosmosDBAccountResourceId'), if(parameters('enableCosmosDb'), resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName')), ''))]",
    "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68",
    "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908",
    "openAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
    "openAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
    "searchServiceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
    "searchIndexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
    "searchIndexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
    "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "storageFileDataPrivilegedContributorRoleId": "69566ab7-960f-4753-8033-0f276bb0955b",
    "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
    "aiAccountId": "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
    "storageAccountSubscriptionId": "[variables('storageSubscriptionId')]",
    "storageAccountResourceGroup": "[variables('storageResourceGroupName')]",
    "storageAccountSecondarySubscriptionId": "[variables('storageSecondSubscriptionId')]",
    "storageAccountSecondaryResourceGroup": "[variables('storageSecondResourceGroupName')]",
    "cosmosAccountSubscriptionId": "[variables('cosmosSubscriptionId')]",
    "cosmosAccountResourceGroup": "[variables('cosmosResourceGroupName')]",
    "aiSearchSubscriptionEffective": "[variables('aiSearchSubscriptionId')]",
    "aiSearchResourceGroupEffective": "[variables('aiSearchServiceResourceGroupName')]"
  },
  "resources": [
    {
      "condition": "[not(variables('storagePassedIn'))]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard_ZRS"
      },
      "kind": "StorageV2",
      "properties": {
        "minimumTlsVersion": "TLS1_2",
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": false,
        "publicNetworkAccess": "Disabled",
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny",
          "virtualNetworkRules": [],
          "ipRules": []
        }
      }
    },
    {
      "condition": "[not(variables('storageSecondPassedIn'))]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('storageAccountNameSecondary')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard_ZRS"
      },
      "kind": "StorageV2",
      "properties": {
        "minimumTlsVersion": "TLS1_2",
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": false,
        "publicNetworkAccess": "Disabled",
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny",
          "virtualNetworkRules": [],
          "ipRules": []
        }
      }
    },
    {
      "condition": "[and(parameters('enableAISearch'), not(variables('searchPassedIn')))]",
      "type": "Microsoft.Search/searchServices",
      "apiVersion": "2023-11-01",
      "name": "[variables('aiSearchName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "sku": {
        "name": "standard"
      },
      "properties": {
        "disableLocalAuth": false,
        "hostingMode": "default",
        "publicNetworkAccess": "disabled",
        "semanticSearch": "disabled",
        "networkRuleSet": {
          "ipRules": []
        },
        "encryptionWithCmk": {
          "enforcement": "Unspecified"
        }
      }
    },
    {
      "condition": "[and(parameters('enableCosmosDb'), not(variables('cosmosPassedIn')))]",
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2024-11-15",
      "name": "[variables('cosmosAccountName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "kind": "GlobalDocumentDB",
      "properties": {
        "databaseAccountOfferType": "Standard",
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session"
        },
        "disableLocalAuth": true,
        "enableAutomaticFailover": false,
        "enableMultipleWriteLocations": false,
        "enableFreeTier": false,
        "publicNetworkAccess": "Disabled",
        "locations": [
          {
            "locationName": "[parameters('location')]",
            "failoverPriority": 0,
            "isZoneRedundant": false
          }
        ]
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2025-04-01-preview",
      "name": "[variables('accountName')]",
      "kind": "AIServices",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "[parameters('aiAccountSku')]"
      },
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "allowProjectManagement": "[parameters('enableProject')]",
        "defaultProject": "[if(parameters('enableProject'), variables('projectName'), null())]",
        "customSubDomainName": "[variables('accountName')]",
        "networkAcls": "[variables('networkAcls')]",
        "publicNetworkAccess": "[variables('publicNetworkAccess')]",
        "disableLocalAuth": false,
        "networkInjections": "[if(variables('agentNetworkInjectionEnabled'), createArray(createObject('scenario', 'agent', 'subnetArmId', parameters('agentSubnetResourceId'), 'useMicrosoftManagedNetwork', false())), null())]",
        "restrictOutboundNetworkAccess": "[parameters('restrictOutboundNetworkAccess')]",
        "dynamicThrottlingEnabled": false
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2025-04-01-preview",
      "name": "[format('{0}/{1}', variables('accountName'), variables('defaultDeploymentName'))]",
      "properties": {
        "model": {
          "name": "[parameters('modelName')]",
          "format": "[parameters('modelFormat')]",
          "version": "[parameters('modelVersion')]"
        }
      },
      "sku": {
        "name": "[parameters('modelSkuName')]",
        "capacity": "[parameters('modelCapacity')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]"
      ]
    },
    {
      "copy": {
        "name": "aiAccountDeploymentsAdditional",
        "count": "[length(parameters('extraModelDeployments'))]"
      },
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2025-04-01-preview",
      "name": "[format('{0}/{1}', variables('accountName'), take(string(coalesce(parameters('extraModelDeployments')[copyIndex()].name, format('deployment{0}', copyIndex()))), 64))]",
      "properties": {
        "model": "[parameters('extraModelDeployments')[copyIndex()].model]",
        "raiPolicyName": "[parameters('extraModelDeployments')[copyIndex()].raiPolicyName]",
        "versionUpgradeOption": "[parameters('extraModelDeployments')[copyIndex()].versionUpgradeOption]"
      },
      "sku": "[coalesce(parameters('extraModelDeployments')[copyIndex()].sku, createObject('name', parameters('modelSkuName'), 'capacity', parameters('modelCapacity')))]",
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]"
      ]
    },
    {
      "condition": "[and(and(empty(string(parameters('existingDnsZones')[variables('aiServicesDnsZoneName')])), not(parameters('centralDnsZoneByPolicyInHub'))), empty(variables('servicesAiZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('aiServicesDnsZoneName')]",
      "location": "global"
    },
    {
      "condition": "[and(and(empty(string(parameters('existingDnsZones')[variables('openAiDnsZoneName')])), not(parameters('centralDnsZoneByPolicyInHub'))), empty(variables('openAiZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('openAiDnsZoneName')]",
      "location": "global"
    },
    {
      "condition": "[and(and(empty(string(parameters('existingDnsZones')[variables('cognitiveServicesDnsZoneName')])), not(parameters('centralDnsZoneByPolicyInHub'))), empty(variables('cognitiveServicesZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('cognitiveServicesDnsZoneName')]",
      "location": "global"
    },
    {
      "condition": "[and(and(empty(string(parameters('existingDnsZones')[variables('searchDnsZoneName')])), not(parameters('centralDnsZoneByPolicyInHub'))), empty(variables('searchZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('searchDnsZoneName')]",
      "location": "global"
    },
    {
      "condition": "[and(and(empty(string(parameters('existingDnsZones')[variables('storageDnsZoneName')])), not(parameters('centralDnsZoneByPolicyInHub'))), empty(variables('storageZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('storageDnsZoneName')]",
      "location": "global"
    },
    {
      "condition": "[and(and(empty(string(parameters('existingDnsZones')[variables('cosmosDnsZoneName')])), not(parameters('centralDnsZoneByPolicyInHub'))), empty(variables('cosmosZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('cosmosDnsZoneName')]",
      "location": "global"
    },
    {
      "condition": "[and(and(and(empty(string(parameters('existingDnsZones')[variables('apiManagementDnsZoneName')])), not(parameters('centralDnsZoneByPolicyInHub'))), variables('apiManagementProvided')), empty(variables('apiManagementZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('apiManagementDnsZoneName')]",
      "location": "global"
    },
    {
      "condition": "[and(and(not(parameters('centralDnsZoneByPolicyInHub')), empty(string(parameters('existingDnsZones')[variables('aiServicesDnsZoneName')]))), empty(variables('servicesAiZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2024-06-01",
      "name": "[format('{0}/{1}-link', variables('aiServicesDnsZoneName'), variables('virtualNetworkName'))]",
      "properties": {
        "virtualNetwork": {
          "id": "[variables('virtualNetworkId')]"
        },
        "registrationEnabled": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('aiServicesDnsZoneName'))]"
      ]
    },
    {
      "condition": "[and(and(not(parameters('centralDnsZoneByPolicyInHub')), empty(string(parameters('existingDnsZones')[variables('openAiDnsZoneName')]))), empty(variables('openAiZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2024-06-01",
      "name": "[format('{0}/{1}-link', variables('openAiDnsZoneName'), variables('virtualNetworkName'))]",
      "properties": {
        "virtualNetwork": {
          "id": "[variables('virtualNetworkId')]"
        },
        "registrationEnabled": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))]"
      ]
    },
    {
      "condition": "[and(and(not(parameters('centralDnsZoneByPolicyInHub')), empty(string(parameters('existingDnsZones')[variables('cognitiveServicesDnsZoneName')]))), empty(variables('cognitiveServicesZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2024-06-01",
      "name": "[format('{0}/{1}-link', variables('cognitiveServicesDnsZoneName'), variables('virtualNetworkName'))]",
      "properties": {
        "virtualNetwork": {
          "id": "[variables('virtualNetworkId')]"
        },
        "registrationEnabled": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('cognitiveServicesDnsZoneName'))]"
      ]
    },
    {
      "condition": "[and(and(not(parameters('centralDnsZoneByPolicyInHub')), empty(string(parameters('existingDnsZones')[variables('searchDnsZoneName')]))), empty(variables('searchZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2024-06-01",
      "name": "[format('{0}/{1}-link', variables('searchDnsZoneName'), variables('virtualNetworkName'))]",
      "properties": {
        "virtualNetwork": {
          "id": "[variables('virtualNetworkId')]"
        },
        "registrationEnabled": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('searchDnsZoneName'))]"
      ]
    },
    {
      "condition": "[and(and(not(parameters('centralDnsZoneByPolicyInHub')), empty(string(parameters('existingDnsZones')[variables('storageDnsZoneName')]))), empty(variables('storageZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2024-06-01",
      "name": "[format('{0}/{1}-link', variables('storageDnsZoneName'), variables('virtualNetworkName'))]",
      "properties": {
        "virtualNetwork": {
          "id": "[variables('virtualNetworkId')]"
        },
        "registrationEnabled": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('storageDnsZoneName'))]"
      ]
    },
    {
      "condition": "[and(and(not(parameters('centralDnsZoneByPolicyInHub')), empty(string(parameters('existingDnsZones')[variables('cosmosDnsZoneName')]))), empty(variables('cosmosZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2024-06-01",
      "name": "[format('{0}/{1}-link', variables('cosmosDnsZoneName'), variables('virtualNetworkName'))]",
      "properties": {
        "virtualNetwork": {
          "id": "[variables('virtualNetworkId')]"
        },
        "registrationEnabled": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('cosmosDnsZoneName'))]"
      ]
    },
    {
      "condition": "[and(and(and(not(parameters('centralDnsZoneByPolicyInHub')), variables('apiManagementProvided')), empty(string(parameters('existingDnsZones')[variables('apiManagementDnsZoneName')]))), empty(variables('apiManagementZoneFromLanding')))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2024-06-01",
      "name": "[format('{0}/{1}-link', variables('apiManagementDnsZoneName'), variables('virtualNetworkName'))]",
      "properties": {
        "virtualNetwork": {
          "id": "[variables('virtualNetworkId')]"
        },
        "registrationEnabled": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('apiManagementDnsZoneName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}-pe', take(variables('accountName'), 40))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[format('{0}-account', take(variables('accountName'), 40))]",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
              "groupIds": [
                "account"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]"
      ]
    },
    {
      "condition": "[and(not(parameters('centralDnsZoneByPolicyInHub')), not(empty(variables('aiAccountDnsConfigs'))))]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/cognitiveservices-dns', format('{0}-pe', take(variables('accountName'), 40)))]",
      "properties": {
        "privateDnsZoneConfigs": "[variables('aiAccountDnsConfigs')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', take(variables('accountName'), 40)))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}-blob-pe', take(variables('storageAccountName'), 40))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[format('{0}-blob', take(variables('storageAccountName'), 40))]",
            "properties": {
              "privateLinkServiceId": "[variables('storageAccountId')]",
              "groupIds": [
                "blob"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', take(variables('accountName'), 40)))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "condition": "[not(parameters('centralDnsZoneByPolicyInHub'))]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/blob-dns', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "blob",
            "properties": {
              "privateDnsZoneId": "[variables('storageDnsZoneId')]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]"
      ]
    },
    {
      "condition": "[parameters('enableCapabilityHost')]",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}-blob-pe', take(variables('storageAccountNameSecondary'), 40))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[format('{0}-blob', take(variables('storageAccountNameSecondary'), 40))]",
            "properties": {
              "privateLinkServiceId": "[variables('storageAccountSecondaryId')]",
              "groupIds": [
                "blob"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameSecondary'))]"
      ]
    },
    {
      "condition": "[and(not(parameters('centralDnsZoneByPolicyInHub')), parameters('enableCapabilityHost'))]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/blob-dns', format('{0}-blob-pe', take(variables('storageAccountNameSecondary'), 40)))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "blob",
            "properties": {
              "privateDnsZoneId": "[variables('storageDnsZoneId')]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountNameSecondary'), 40)))]"
      ]
    },
    {
      "condition": "[parameters('enableAISearch')]",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}-search-pe', take(variables('aiSearchName'), 40))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[format('{0}-search', take(variables('aiSearchName'), 40))]",
            "properties": {
              "privateLinkServiceId": "[variables('aiSearchResourceIdEffective')]",
              "groupIds": [
                "searchService"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Search/searchServices', variables('aiSearchName'))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]"
      ]
    },
    {
      "condition": "[and(not(parameters('centralDnsZoneByPolicyInHub')), parameters('enableAISearch'))]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/search-dns', format('{0}-search-pe', take(variables('aiSearchName'), 40)))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "search",
            "properties": {
              "privateDnsZoneId": "[variables('searchDnsZoneId')]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-search-pe', take(variables('aiSearchName'), 40)))]"
      ]
    },
    {
      "condition": "[parameters('enableCosmosDb')]",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}-cosmos-pe', take(variables('cosmosAccountName'), 40))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[format('{0}-cosmos', take(variables('cosmosAccountName'), 40))]",
            "properties": {
              "privateLinkServiceId": "[variables('cosmosResourceIdEffective')]",
              "groupIds": [
                "Sql"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName'))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]"
      ]
    },
    {
      "condition": "[and(not(parameters('centralDnsZoneByPolicyInHub')), parameters('enableCosmosDb'))]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/cosmos-dns', format('{0}-cosmos-pe', take(variables('cosmosAccountName'), 40)))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "cosmos",
            "properties": {
              "privateDnsZoneId": "[variables('cosmosDnsZoneId')]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-cosmos-pe', take(variables('cosmosAccountName'), 40)))]"
      ]
    },
    {
      "condition": "[variables('apiManagementProvided')]",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}-apim-pe', take(variables('apiManagementName'), 40))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[format('{0}-apim', take(variables('apiManagementName'), 40))]",
            "properties": {
              "privateLinkServiceId": "[parameters('apiManagementResourceId')]",
              "groupIds": [
                "Gateway"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]"
      ]
    },
    {
      "condition": "[and(not(parameters('centralDnsZoneByPolicyInHub')), variables('apiManagementProvided'))]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/apim-dns', format('{0}-apim-pe', take(variables('apiManagementName'), 40)))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "apim",
            "properties": {
              "privateDnsZoneId": "[variables('apiManagementDnsZoneId')]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-apim-pe', take(variables('apiManagementName'), 40)))]"
      ]
    },
    {
      "condition": "[parameters('enableProject')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('projectName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "cosmosDBname": "[if(parameters('enableCosmosDb'), createObject('value', variables('cosmosAccountName')), createObject('value', ''))]",
          "storageName": {
            "value": "[variables('storageAccountName')]"
          },
          "storageName2": {
            "value": "[variables('storageAccountNameSecondary')]"
          },
          "aiFoundryV2Name": {
            "value": "[variables('accountName')]"
          },
          "aiSearchName": "[if(parameters('enableAISearch'), createObject('value', variables('aiSearchName')), createObject('value', ''))]",
          "enablePublicAccessWithPerimeter": {
            "value": "[parameters('allowPublicAccessWhenBehindVnet')]"
          },
          "defaultProjectName": {
            "value": "[variables('projectName')]"
          },
          "defaultProjectDisplayName": {
            "value": "[parameters('displayName')]"
          },
          "defaultProjectDescription": {
            "value": "[parameters('projectDescription')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "18444544150178826740"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "minLength": 3,
              "maxLength": 12,
              "metadata": {
                "description": "The name of the environment. Use alphanumeric characters only."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Specifies the location for all the Azure resources. Defaults to the location of the resource group."
              }
            },
            "cosmosDBname": {
              "type": "string",
              "metadata": {
                "description": "Name of the customers existing CosmosDB Resource"
              }
            },
            "storageName": {
              "type": "string",
              "metadata": {
                "description": "Name of the customers existing Azure Storage Account"
              }
            },
            "storageName2": {
              "type": "string"
            },
            "aiFoundryV2Name": {
              "type": "string",
              "metadata": {
                "description": "Foundry Account Name"
              }
            },
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "Azure Search Service Name"
              }
            },
            "enablePublicAccessWithPerimeter": {
              "type": "bool",
              "defaultValue": false
            },
            "defaultProjectName": {
              "type": "string",
              "defaultValue": "[parameters('name')]",
              "metadata": {
                "description": "Name of the first project"
              }
            },
            "defaultProjectDisplayName": {
              "type": "string",
              "defaultValue": "[parameters('name')]"
            },
            "defaultProjectDescription": {
              "type": "string",
              "defaultValue": "AI Factory created this default project for AI Foundry with enterprise grade security and your corp networking."
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "displayName": "[parameters('defaultProjectDisplayName')]",
                "description": "[parameters('defaultProjectDescription')]"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName'))]",
              "properties": {
                "category": "AzureStorageAccount",
                "target": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), '2023-01-01').primaryEndpoints.blob]",
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "authType": "AAD",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]",
                  "location": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), '2023-01-01', 'full').location]",
                  "accountName": "[parameters('storageName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName2'))]",
              "properties": {
                "category": "AzureStorageAccount",
                "target": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2')), '2023-01-01').primaryEndpoints.blob]",
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "authType": "AAD",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2'))]",
                  "location": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2')), '2023-01-01', 'full').location]",
                  "accountName": "[parameters('storageName2')]",
                  "containerName": "default"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('aiSearchName'))]",
              "properties": {
                "category": "CognitiveSearch",
                "target": "[format('https://{0}.search.windows.net/', parameters('aiSearchName'))]",
                "authType": "AAD",
                "isSharedToAll": true,
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.Search/searchServices', parameters('aiSearchName'))]",
                  "location": "[reference(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), '2024-06-01-preview', 'full').location]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName2'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('cosmosDBname')))]",
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('cosmosDBname'))]",
              "properties": {
                "category": "CosmosDB",
                "target": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname')), '2025-05-01-preview').documentEndpoint]",
                "authType": "AAD",
                "isSharedToAll": true,
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname'))]",
                  "location": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname')), '2025-05-01-preview', 'full').location]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('aiSearchName'))]"
              ]
            }
          ],
          "outputs": {
            "projectId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]"
            },
            "projectName": {
              "type": "string",
              "value": "[parameters('defaultProjectName')]"
            },
            "projectPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName')), '2025-07-01-preview', 'full').identity.principalId]"
            },
            "projectWorkspaceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName')), '2025-07-01-preview').internalId]"
            },
            "cosmosDBConnection": {
              "type": "string",
              "value": "[parameters('cosmosDBname')]"
            },
            "azureStorageConnection": {
              "type": "string",
              "value": "[parameters('storageName')]"
            },
            "aiSearchConnection": {
              "type": "string",
              "value": "[parameters('aiSearchName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
        "[resourceId('Microsoft.Search/searchServices', variables('aiSearchName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName'))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', take(variables('accountName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-apim-pe', take(variables('apiManagementName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-cosmos-pe', take(variables('cosmosAccountName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-search-pe', take(variables('aiSearchName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountNameSecondary'), 40)))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameSecondary'))]"
      ]
    },
    {
      "condition": "[and(and(and(parameters('enableCapabilityHost'), parameters('enableProject')), parameters('enableAISearch')), parameters('enableCosmosDb'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('aifoundry-caphost-{0}', variables('uniqueSuffix')), 64)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBConnection": {
            "value": "[string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.cosmosDBConnection.value)]"
          },
          "azureStorageConnection": {
            "value": "[string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.azureStorageConnection.value)]"
          },
          "aiSearchConnection": {
            "value": "[string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.aiSearchConnection.value)]"
          },
          "projectName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectName.value]"
          },
          "accountName": {
            "value": "[variables('accountName')]"
          },
          "projectCapHostName": {
            "value": "[parameters('projectCapHost')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14627596929158472342"
            }
          },
          "parameters": {
            "cosmosDBConnection": {
              "type": "string"
            },
            "azureStorageConnection": {
              "type": "string"
            },
            "aiSearchConnection": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "accountName": {
              "type": "string"
            },
            "projectCapHostName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional name for the capability host. If omitted, a deterministic name is generated based on the selected level."
              }
            },
            "accountLevel": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When true, deploy the capability host at the account scope instead of the project scope."
              }
            }
          },
          "variables": {
            "defaultProjectCapabilityHostName": "[format('chagent{0}', replace(parameters('projectName'), '-', ''))]",
            "defaultAccountCapabilityHostName": "[format('chagent{0}', replace(parameters('accountName'), '-', ''))]",
            "resolvedProjectCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultProjectCapabilityHostName'), parameters('projectCapHostName'))]",
            "resolvedAccountCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultAccountCapabilityHostName'), parameters('projectCapHostName'))]"
          },
          "resources": [
            {
              "condition": "[parameters('accountLevel')]",
              "type": "Microsoft.CognitiveServices/accounts/capabilityHosts",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}', parameters('accountName'), variables('resolvedAccountCapabilityHostName'))]",
              "properties": {
                "capabilityHostKind": "Agents"
              }
            },
            {
              "condition": "[not(parameters('accountLevel'))]",
              "type": "Microsoft.CognitiveServices/accounts/projects/capabilityHosts",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), variables('resolvedProjectCapabilityHostName'))]",
              "properties": {
                "capabilityHostKind": "Agents",
                "threadStorageConnections": [
                  "[format('{0}', parameters('cosmosDBConnection'))]"
                ],
                "vectorStoreConnections": [
                  "[format('{0}', parameters('aiSearchConnection'))]"
                ],
                "storageConnections": [
                  "[format('{0}', parameters('azureStorageConnection'))]"
                ]
              }
            }
          ],
          "outputs": {
            "projectCapHost": {
              "type": "string",
              "value": "[if(not(parameters('accountLevel')), string(variables('resolvedProjectCapabilityHostName')), '')]"
            },
            "accountCapHost": {
              "type": "string",
              "value": "[if(parameters('accountLevel'), string(variables('resolvedAccountCapabilityHostName')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', take(variables('accountName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-cosmos-pe', take(variables('cosmosAccountName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-search-pe', take(variables('aiSearchName'), 40)))]",
        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-blob-pe', take(variables('storageAccountName'), 40)))]",
        "[resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[or(or(not(empty(parameters('userRoleObjectIds'))), not(empty(parameters('servicePrincipalIds')))), parameters('enableProject'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('aifoundry-rbac-{0}', variables('uniqueSuffix')), 64)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "userObjectIds": {
            "value": "[parameters('userRoleObjectIds')]"
          },
          "servicePrincipalIds": {
            "value": "[parameters('servicePrincipalIds')]"
          },
          "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]",
          "cognitiveServicesAccountName": {
            "value": "[variables('accountName')]"
          },
          "cognitiveServicesContributorRoleId": {
            "value": "[variables('cognitiveServicesContributorRoleId')]"
          },
          "cognitiveServicesUserRoleId": {
            "value": "[variables('cognitiveServicesUserRoleId')]"
          },
          "openAIContributorRoleId": {
            "value": "[variables('openAIContributorRoleId')]"
          },
          "openAIUserRoleId": {
            "value": "[variables('openAIUserRoleId')]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11175577047624681490"
            }
          },
          "parameters": {
            "userObjectIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of user object IDs to assign roles to"
              }
            },
            "servicePrincipalIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of service principal IDs to assign roles to"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Project principal ID to assign roles to"
              }
            },
            "cognitiveServicesAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Cognitive Services account to assign roles for"
              }
            },
            "cognitiveServicesContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for Cognitive Services Contributor"
              }
            },
            "cognitiveServicesUserRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for Cognitive Services User"
              }
            },
            "openAIContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for OpenAI Contributor"
              }
            },
            "openAIUserRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for OpenAI User"
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to use AD Groups instead of individual users"
              }
            }
          },
          "resources": [
            {
              "copy": {
                "name": "openAIContributorRoleAssignmentUsers",
                "count": "[length(parameters('userObjectIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('userObjectIds')[copyIndex()], parameters('openAIContributorRoleId'), 'user-openai-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[copyIndex()]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "!01: user-openai-contributor-manual"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesContributorRoleAssignmentUsers",
                "count": "[length(parameters('userObjectIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('userObjectIds')[copyIndex()], parameters('cognitiveServicesContributorRoleId'), 'user-cs-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[copyIndex()]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "!02: user-cs-contributor-manual"
              }
            },
            {
              "copy": {
                "name": "openAIUserRoleAssignmentServicePrincipals",
                "count": "[length(parameters('servicePrincipalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('servicePrincipalIds')[copyIndex()], parameters('openAIUserRoleId'), 'sp-user-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIUserRoleId'))]",
                "principalId": "[parameters('servicePrincipalIds')[copyIndex()]]",
                "principalType": "ServicePrincipal",
                "description": "!05: sp-user-manual (2 rows OK)"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('openAIContributorRoleId'), 'project-openai-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "!06:project-openai-contributor-manual: AI Foundry project managed identity - OpenAI Contributor for project operations"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('cognitiveServicesContributorRoleId'), 'project-cs-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "!07:project-cs-contributor-manual:AI Foundry project managed identity - Cognitive Services Contributor for project operations"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('cognitiveServicesUserRoleId'), 'project-cs-user-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesUserRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "!08:project-cs-user-manual: AI Foundry project managed identity - Cognitive Services User for project operations"
              }
            }
          ],
          "outputs": {
            "userRoleNames": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('userObjectIds'))]",
                "input": "[format('User {0} assigned OpenAI Contributor, Cognitive Services Contributor, and Cognitive Services User roles', parameters('userObjectIds')[copyIndex()])]"
              }
            },
            "servicePrincipalRoleNames": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('servicePrincipalIds'))]",
                "input": "[format('Service Principal {0} assigned OpenAI User role', parameters('servicePrincipalIds')[copyIndex()])]"
              }
            },
            "projectPrincipalRoleNames": {
              "type": "string",
              "value": "[if(not(empty(parameters('projectPrincipalId'))), format('Project Principal {0} assigned OpenAI Contributor, Cognitive Services Contributor, and Cognitive Services User roles', parameters('projectPrincipalId')), 'No project principal provided')]"
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(add(mul(length(parameters('userObjectIds')), 3), length(parameters('servicePrincipalIds'))), if(not(empty(parameters('projectPrincipalId'))), 3, 0))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
        "[resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(parameters('enableAISearch'), variables('searchInCurrentRg'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('aifoundry-rbacsearch-{0}', variables('uniqueSuffix')), 64)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": {
            "value": "[variables('aiSearchName')]"
          },
          "aiFoundryAccountName": {
            "value": "[variables('accountName')]"
          },
          "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]",
          "searchServiceContributorRoleId": {
            "value": "[variables('searchServiceContributorRoleId')]"
          },
          "searchIndexDataReaderRoleId": {
            "value": "[variables('searchIndexDataReaderRoleId')]"
          },
          "searchIndexDataContributorRoleId": {
            "value": "[variables('searchIndexDataContributorRoleId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2603168697541818607"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Search service"
              }
            },
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry account to get the principal ID from"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The principal ID of the AI Foundry project system-assigned managed identity"
              }
            },
            "searchServiceContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Search Service Contributor role ID"
              }
            },
            "searchIndexDataReaderRoleId": {
              "type": "string",
              "metadata": {
                "description": "Search Index Data Reader role ID"
              }
            },
            "searchIndexDataContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Search Index Data Contributor role ID"
              }
            },
            "azureAIDeveloperRoleId": {
              "type": "string",
              "defaultValue": "64702f94-c441-49e6-a78b-ef80e0188fee",
              "metadata": {
                "description": "Azure AI Developer role ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchServiceContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchServiceContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchIndexDataReaderRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataReaderRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchIndexDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('azureAIDeveloperRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('azureAIDeveloperRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchServiceContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchServiceContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchIndexDataReaderRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataReaderRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchIndexDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('azureAIDeveloperRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('azureAIDeveloperRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "rbacAssignmentsCompleted": {
              "type": "bool",
              "metadata": {
                "description": "AI Search RBAC assignments completed successfully"
              },
              "value": true
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(4, if(not(empty(parameters('projectPrincipalId'))), 4, 0))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
        "[resourceId('Microsoft.Search/searchServices', variables('aiSearchName'))]",
        "[resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(variables('storageInCurrentRg'), parameters('enableProject'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('aifoundry-rbacstorage-{0}', variables('uniqueSuffix')), 64)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "storageAccountName2": {
            "value": "[variables('storageAccountNameSecondary')]"
          },
          "aiFoundryAccountName": {
            "value": "[variables('accountName')]"
          },
          "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]",
          "storageBlobDataContributorRoleId": {
            "value": "[variables('storageBlobDataContributorRoleId')]"
          },
          "storageFileDataPrivilegedContributorRoleId": {
            "value": "[variables('storageFileDataPrivilegedContributorRoleId')]"
          },
          "storageQueueDataContributorRoleId": {
            "value": "[variables('storageQueueDataContributorRoleId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "6675038280987538785"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account"
              }
            },
            "storageAccountName2": {
              "type": "string"
            },
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry account to get the principal ID from"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The principal ID of the AI Foundry project system-assigned managed identity"
              }
            },
            "storageBlobDataContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Storage Blob Data Contributor role ID"
              }
            },
            "storageFileDataPrivilegedContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Storage File Data Privileged Contributor role ID"
              }
            },
            "storageQueueDataContributorRoleId": {
              "type": "string",
              "defaultValue": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
              "metadata": {
                "description": "Storage Queue Data Contributor role ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataPrivilegedContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageBlobDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageFileDataPrivilegedContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageQueueDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataPrivilegedContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageBlobDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageFileDataPrivilegedContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageQueueDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "rbacAssignmentsCompleted": {
              "type": "bool",
              "metadata": {
                "description": "Storage Account RBAC assignments completed successfully"
              },
              "value": true
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(6, if(not(empty(parameters('projectPrincipalId'))), 6, 0))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('accountName'))]",
        "[resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountNameSecondary'))]"
      ]
    },
    {
      "condition": "[and(and(and(parameters('enableCapabilityHost'), parameters('enableProject')), parameters('enableCosmosDb')), variables('cosmosInCurrentRg'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('aifoundry-rbaccap-pre-{0}', variables('uniqueSuffix')), 64)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosAccountName": {
            "value": "[variables('cosmosAccountName')]"
          },
          "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2091610910663070548"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the CosmosDB Account resource"
              }
            },
            "cosmosSQLDBName": {
              "type": "string",
              "defaultValue": "enterprise_memory",
              "metadata": {
                "description": "Name of the CosmosDB SQL Database in the account"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the AI project"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosAccountName'))]",
              "name": "[guid(parameters('projectPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName'))]",
        "[resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(and(parameters('enableCapabilityHost'), parameters('enableProject')), parameters('enableCosmosDb')), variables('cosmosInCurrentRg')), variables('storageInCurrentRg'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('aifoundry-rbaccap-post-{0}', variables('uniqueSuffix')), 64)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosAccountName": {
            "value": "[variables('cosmosAccountName')]"
          },
          "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]",
          "storageName": {
            "value": "[variables('storageAccountName')]"
          },
          "projectWorkspaceId": "[if(and(parameters('enableProject'), not(empty(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), '')))), createObject('value', format('{0}-{1}-{2}-{3}-{4}', substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 0, 8), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 8, 4), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 12, 4), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 16, 4), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 20, 12))), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "13923047496032866540"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the CosmosDB Account resource"
              }
            },
            "cosmosSQLDBName": {
              "type": "string",
              "defaultValue": "enterprise_memory",
              "metadata": {
                "description": "Name of the CosmosDB SQL Database in the account"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the AI project"
              }
            },
            "storageName": {
              "type": "string",
              "metadata": {
                "description": "Name of the storage account"
              }
            },
            "projectWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Workspace Id of the AI Project"
              }
            }
          },
          "variables": {
            "userThreadName": "[format('{0}-thread-message-store', parameters('projectWorkspaceId'))]",
            "systemThreadName": "[format('{0}-system-thread-message-store', parameters('projectWorkspaceId'))]",
            "entityStoreName": "[format('{0}-agent-entity-store', parameters('projectWorkspaceId'))]",
            "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosAccountName'), '00000000-0000-0000-0000-000000000002')]",
            "scopeSystemContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('systemThreadName'))]",
            "scopeUserContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('userThreadName'))]",
            "scopeEntityContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('entityStoreName'))]",
            "conditionStr": "[format('((!(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/read''}})  AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/filter/action''}}) AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/write''}}) ) OR (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringStartsWithIgnoreCase ''{0}'' AND @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringLikeIgnoreCase ''*-azureml-agent''))', parameters('projectWorkspaceId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('userThreadName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "scope": "[variables('scopeUserContainer')]"
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('systemThreadName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "scope": "[variables('scopeSystemContainer')]"
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('entityStoreName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "scope": "[variables('scopeEntityContainer')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
              "name": "[guid(resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b'), resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                "principalType": "ServicePrincipal",
                "conditionVersion": "2.0",
                "condition": "[variables('conditionStr')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', take(format('aifoundry-caphost-{0}', variables('uniqueSuffix')), 64))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName'))]",
        "[resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    }
  ],
  "outputs": {
    "aiAccountName": {
      "type": "string",
      "metadata": {
        "description": "The name of the cognitive services account."
      },
      "value": "[variables('accountName')]"
    },
    "aiAccountId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the cognitive services account."
      },
      "value": "[variables('aiAccountId')]"
    },
    "aiAccountEndpoint": {
      "type": "string",
      "metadata": {
        "description": "The service endpoint of the cognitive services account."
      },
      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('accountName')), '2025-04-01-preview').endpoint]"
    },
    "aiAccountPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "The principal ID of the system assigned identity."
      },
      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('accountName')), '2025-04-01-preview', 'full').identity.principalId]"
    },
    "aiFoundryProjectDeployed": {
      "type": "bool",
      "metadata": {
        "description": "Indicates whether the default project was deployed."
      },
      "value": "[parameters('enableProject')]"
    },
    "projectNameOutput": {
      "type": "string",
      "metadata": {
        "description": "The name of the AI Foundry project."
      },
      "value": "[if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectName.value), '')]"
    },
    "projectId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the AI Foundry project."
      },
      "value": "[if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectId.value), '')]"
    },
    "projectPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "The principal ID of the AI Foundry project managed identity."
      },
      "value": "[if(parameters('enableProject'), reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value, '')]"
    },
    "projectWorkspaceGuid": {
      "type": "string",
      "metadata": {
        "description": "Formatted project workspace ID (GUID)."
      },
      "value": "[if(and(parameters('enableProject'), not(empty(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), '')))), format('{0}-{1}-{2}-{3}-{4}', substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 0, 8), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 8, 4), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 12, 4), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 16, 4), substring(if(parameters('enableProject'), string(reference(resourceId('Microsoft.Resources/deployments', take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), ''), 20, 12)), '')]"
    },
    "storageAccount": {
      "type": "object",
      "metadata": {
        "description": "Primary storage account information."
      },
      "value": {
        "name": "[variables('storageAccountName')]",
        "subscriptionId": "[variables('storageAccountSubscriptionId')]",
        "resourceGroup": "[variables('storageAccountResourceGroup')]"
      }
    },
    "storageAccountSecondary": {
      "type": "object",
      "metadata": {
        "description": "Secondary storage account information."
      },
      "value": {
        "name": "[variables('storageAccountNameSecondary')]",
        "subscriptionId": "[variables('storageAccountSecondarySubscriptionId')]",
        "resourceGroup": "[variables('storageAccountSecondaryResourceGroup')]"
      }
    },
    "cosmosAccount": {
      "type": "object",
      "metadata": {
        "description": "Cosmos DB account information."
      },
      "value": "[if(parameters('enableCosmosDb'), createObject('name', variables('cosmosAccountName'), 'subscriptionId', variables('cosmosAccountSubscriptionId'), 'resourceGroup', variables('cosmosAccountResourceGroup')), createObject('name', '', 'subscriptionId', '', 'resourceGroup', ''))]"
    },
    "aiSearchService": {
      "type": "object",
      "metadata": {
        "description": "AI Search service information."
      },
      "value": "[if(parameters('enableAISearch'), createObject('name', variables('aiSearchName'), 'subscriptionId', variables('aiSearchSubscriptionEffective'), 'resourceGroup', variables('aiSearchResourceGroupEffective')), createObject('name', '', 'subscriptionId', '', 'resourceGroup', ''))]"
    },
    "dnsZoneValidation": {
      "type": "array",
      "metadata": {
        "description": "Validation summary for expected private DNS zones."
      },
      "value": "[variables('dnsZoneValidation')]"
    }
  }
}