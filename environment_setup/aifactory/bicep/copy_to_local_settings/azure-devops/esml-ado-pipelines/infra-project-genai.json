{"source":2,"revision":1,"description":null,"createdBy":{"displayName":"Joakim Åström","url":"https://spsprodweu4.vssps.visualstudio.com/Ae8dda09f-c2b4-4692-b8a9-19b9ca10e69b/_apis/Identities/557c9a45-3a85-6eff-ab88-9f8a5f00114e","_links":{"avatar":{"href":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"}},"id":"557c9a45-3a85-6eff-ab88-9f8a5f00114e","uniqueName":"ESML_AI_Factory@microsoft.com","imageUrl":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl","descriptor":"aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"},"createdOn":"2025-01-08T09:29:43.803Z","modifiedBy":{"displayName":"Joakim Åström","url":"https://spsprodweu4.vssps.visualstudio.com/Ae8dda09f-c2b4-4692-b8a9-19b9ca10e69b/_apis/Identities/557c9a45-3a85-6eff-ab88-9f8a5f00114e","_links":{"avatar":{"href":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"}},"id":"557c9a45-3a85-6eff-ab88-9f8a5f00114e","uniqueName":"ESML_AI_Factory@microsoft.com","imageUrl":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl","descriptor":"aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"},"modifiedOn":"2025-01-08T09:29:43.803Z","isDeleted":false,"isDisabled":false,"variables":{"admin_aifactorySuffixRG":{"value":"-001"},"admin_aks_gpu_sku_dev_override":{"value":"Standard_B4ms"},"admin_aks_gpu_sku_test_prod_override":{"value":"Standard_DS13-2_v2"},"admin_aks_nodes_dev_override":{"value":"1"},"admin_aks_nodes_testProd_override":{"value":"3"},"admin_aks_version_override":{"value":"1.30.3"},"admin_aml_cluster_maxNodes_dev_override":{"value":"3"},"admin_aml_cluster_maxNodes_testProd_override":{"value":"3"},"admin_aml_cluster_sku_dev_override":{"value":"Standard_DS3_v2"},"admin_aml_cluster_sku_testProd_override":{"value":"Standard_D13_v2"},"admin_aml_computeInstance_dev_sku_override":{"value":"Standard_DS11_v2"},"admin_aml_computeInstance_testProd_sku_override":{"value":"Standard_ND96amsr_A100_v4"},"admin_commonResourceSuffix":{"value":"-001"},"admin_enablePublicGenAIAccess":{"value":"true"},"admin_hybridBenefit":{"value":"true"},"admin_ip_fw":{"value":""},"admin_location":{"value":"swedencentral"},"admin_locationSuffix":{"value":"sdc"},"admin_private_azureMLStudioUI":{"value":"true"},"admin_private_DatabricksUI":{"value":"false"},"admin_prjResourceSuffix":{"value":"-001"},"admin_projectType":{"value":"genai-1"},"admin_seeding_keyvault":{"value":"TODO_kv-seeding-sdc-001"},"admin_seeding_keyvault_rg":{"value":"TODO_rg-kv-seeding-sdc-001"},"admin_seeding_keyvault_subscription":{"value":"TODO_subscriptionID-rt123qsed-f1234asdf1-23asdf2134f"},"optional_serviceSettingDeployAIDocIntelligence":{"value":"false"},"optional_serviceSettingDeployAzureAIVision":{"value":"false"},"optional_serviceSettingDeployAzureSpeech":{"value":"false"},"project_IP_whitelist":{"value":"TODO_comma_separated_Ips_100.123.123.12,90.123..12/24"},"project_number_000":{"value":"001"},"project_service_principal_AppID_seed_kv_name":{"value":"esml-project001-sp-id"},"project_service_principal_OID_seed_kv_name":{"value":"esml-project001-sp-oid"},"project_service_principal_secret_seed_kv_name":{"value":"esml-project001-sp-secret"},"technical_admins_ad_object_id":{"value":"TODO_comma_separeated_objectIds_adfsafd123-asdfsdf1-123eqe-asdasf-, TODO2_asdfs1123-asdf234-123"},"technical_admins_email":{"value":"TODO_comma_separated_names_batman, robin"}},"variableGroups":[],"environments":[{"id":104,"name":"aifactory-project-dev","rank":1,"owner":{"displayName":"Joakim Åström","url":"https://spsprodweu4.vssps.visualstudio.com/Ae8dda09f-c2b4-4692-b8a9-19b9ca10e69b/_apis/Identities/557c9a45-3a85-6eff-ab88-9f8a5f00114e","_links":{"avatar":{"href":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"}},"id":"557c9a45-3a85-6eff-ab88-9f8a5f00114e","uniqueName":"ESML_AI_Factory@microsoft.com","imageUrl":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl","descriptor":"aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"},"variables":{"dev_test_prod":{"value":"dev"},"dev_test_prod_sub_id":{"value":"TODO_subscriptionID-234asd-f123asdf2134f"}},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":314}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":319},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":320}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"windows-2022"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":92,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"01_pwsh_get_IP_for_ADO_agent","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"ps","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"$resp = $resp = Invoke-RestMethod http://ipinfo.io/json | Select -exp ip\n        Write-Host $resp\n        Write-Host \"##vso[task.setvariable variable=admin_ip_fw]$resp\"\n        $ipAddr = $resp\n        Write-Host ipAddr is: $admin_ip_fw","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"02_az_set_ADO_ip_to_sedding_keyvault_FW_whitelist","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az keyvault network-rule add --resource-group $(admin_seeding_keyvault_rg) --name $(admin_seeding_keyvault) --ip-address $(admin_ip_fw)\naz bicep version\n\n#az bicep upgrade \n","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"1e244d32-2dd4-4165-96fb-b7441ca9331e","version":"2.*","name":"03_download_seeding_keyvault","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceName":"47b43cde-c003-4a0d-8ad1-40d4050d326e","KeyVaultName":"esaifac-seeding-sdc-001","SecretsFilter":"*","RunAsPreJob":"false"}},{"environment":{},"taskId":"72a1931b-effb-4d2e-8fd8-f8472a07cb62","version":"4.*","name":"04_pwsh_calculate_subnet_allocations","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","ScriptType":"FilePath","ScriptPath":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/subnetCalc.ps1","Inline":"# You can write your azure powershell scripts inline here. \n# You can also pass predefined and custom variables to this script using arguments","ScriptArguments":"-bicepPar1 \"../../../../../aifactory/parameters/10-esml-globals-1.json\" -bicepPar2 \"../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json\" -bicepPar3 \"../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json\" -bicepPar4 \"../../../../../aifactory/parameters/21-22-esml-prj-parameters.json\" -filePath \"../../../../../aifactory/parameters/\" -spObjId \"$(esml-common-bicep-sp-id)\" -spSecret \"$(esml-common-bicep-sp-secret)\" -env \"$(dev_test_prod)\" -subscriptionId \"$(dev_test_prod_sub_id)\" -prjResourceSuffix \"$(admin_prjResourceSuffix)\" -aifactorySuffixRGADO \"$(admin_aifactorySuffixRG)\" -commonResourceSuffixADO \"$(admin_commonResourceSuffix)\" -locationADO \"$(admin_location)\" -locationSuffixADO \"$(admin_locationSuffix)\" -useServicePrincipal -bicepPar5 \"../../../../../aifactory/parameters/10-esml-globals-override.json\" -projectTypeADO \"$(admin_projectType)\"","errorActionPreference":"stop","FailOnStandardError":"false","RestrictContextToCurrentTask":"false","TargetAzurePs":"LatestVersion","CustomTargetAzurePs":"3.5.0","pwsh":"true","validateScriptSignature":"false","workingDirectory":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"05_bicep_deploy_subnets_and_NSG","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az deployment group create \\\n--name \"esml-p$(project_number_000)-$(dev_test_prod)-$(admin_locationSuffix)$(admin_aifactorySuffixRG)SubnetDeplProj\" \\\n--subscription \"$(dev_test_prod_sub_id)\" \\\n--resource-group \"$(cat \"..\\..\\..\\..\\aifactory\\parameters\\subnetParameters.json\" | grep vnetResourceGroup -A1 | tail -n1 | cut -d: -f2 | tr -d \" \\\"\")\" \\\n--template-file \"esml-genai-1\\31-network.bicep\" \\\n--parameters @\"..\\..\\..\\..\\aifactory\\parameters\\subnetParameters.json\" \\\n--parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-override.json\" \\\n--parameters env=\"$(dev_test_prod)\" \\\n--parameters projectNumber=\"$(project_number_000)\"","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"06_pwsh_fetch_network_parameters","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"pscore","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/genDynamicNetworkParamFile.ps1","inlineScript":"","scriptArguments":"-spObjId \"$(esml-common-bicep-sp-id)\" -spSecret \"$(esml-common-bicep-sp-secret)\" -useServicePrincipal -bicepPar1 \"../../../../../aifactory/parameters/10-esml-globals-1.json\" -bicepPar2 \"../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json\" -bicepPar3 \"../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json\" -bicepPar4 \"../../../../../aifactory/parameters/21-22-esml-prj-parameters.json\" -filePath \"../../../../../aifactory/parameters/\" -env \"$(dev_test_prod)\" -locationSuffixADO \"$(admin_locationSuffix)\" -aifactorySuffixRGADO \"$(admin_aifactorySuffixRG)\" -projectNumber \"$(project_number_000)\" -subscriptionId \"$(dev_test_prod_sub_id)\" -bicepPar5 \"../../../../../aifactory/parameters/10-esml-globals-override.json\" -projectTypeADO \"$(admin_projectType)\"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"07_pwsh_bicep_deploy_genai_project","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"output=$(az deployment sub create \\\n  --name \"esml-p$(project_number_000)-$(dev_test_prod)-$(admin_locationSuffix)-$(admin_prjResourceSuffix)$(admin_commonResourceSuffix)$PrjDepl\" \\\n  --subscription \"$(dev_test_prod_sub_id)\" \\\n  --location \"$(admin_location)\" \\\n  --template-file \"esml-genai-1\\32-main.bicep\" \\\n  --parameters adminPassword=\"$(cat /dev/urandom | tr -dc 'A-Za-z0-9_!@#$%^&*()\\-+=' | head -c24 ; echo)\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-1.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-2-12_13_21_22.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-3-12_13.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-4-13_21_22.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-5-13_23.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-override.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\21-22-esml-prj-parameters.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\dynamicNetworkParams.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\23-esml-prj-rbac-parameters.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\31-esgenai-default.json\" \\\n  --parameters env=\"$(dev_test_prod)\" \\\n  --parameters projectNumber=\"$(project_number_000)\" \\\n  --parameters technicalAdminsObjectID=\"$(technical_admins_ad_object_id)\" \\\n  --parameters technicalAdminsEmail=\"$(technical_admins_email)\" \\\n  --parameters location=\"$(admin_location)\" \\\n  --parameters locationSuffix=\"$(admin_locationSuffix)\" \\\n  --parameters resourceSuffix=\"$(admin_prjResourceSuffix)\" \\\n  --parameters aifactorySuffixRG=\"$(admin_aifactorySuffixRG)\" \\\n  --parameters commonResourceSuffix=\"$(admin_commonResourceSuffix)\" \\\n  --parameters projectServicePrincipleOID_SeedingKeyvaultName=\"$(project_service_principal_OID_seed_kv_name)\" \\\n  --parameters projectServicePrincipleAppID_SeedingKeyvaultName=\"$(project_service_principal_AppID_seed_kv_name)\" \\\n  --parameters projectServicePrincipleSecret_SeedingKeyvaultName=\"$(project_service_principal_secret_seed_kv_name)\" \\\n  --parameters inputKeyvault=\"$(admin_seeding_keyvault)\" \\\n  --parameters inputKeyvaultResourcegroup=\"$(admin_seeding_keyvault_rg)\" \\\n  --parameters inputKeyvaultSubscription=\"$(admin_seeding_keyvault_subscription)\" \\\n  --parameters aks_dev_sku_override=\"$(admin_aks_gpu_sku_dev_override)\" \\\n  --parameters aks_test_prod_sku_override=\"$(admin_aks_gpu_sku_test_prod_override)\" \\\n  --parameters aks_dev_nodes_override=\"$(admin_aks_nodes_dev_override)\" \\\n  --parameters aks_test_prod_nodes_override=\"$(admin_aks_nodes_testProd_override)\" \\\n  --parameters aks_version_override=\"$(admin_aks_version_override)\" \\\n  --parameters aml_cluster_dev_sku_override=\"$(admin_aml_cluster_sku_dev_override)\" \\\n  --parameters aml_cluster_test_prod_sku_override=\"$(admin_aml_cluster_sku_testProd_override)\" \\\n  --parameters aml_cluster_dev_nodes_override=\"$(admin_aml_cluster_maxNodes_dev_override)\" \\\n  --parameters aml_cluster_test_prod_nodes_override=\"$(admin_aml_cluster_maxNodes_testProd_override)\" \\\n  --parameters aml_ci_dev_sku_override=\"$(admin_aml_computeInstance_dev_sku_override)\" \\\n  --parameters aml_ci_test_prod_sku_override=\"$(admin_aml_computeInstance_testProd_sku_override)\" \\\n  --parameters enablePublicGenAIAccess=\"$(admin_enablePublicGenAIAccess)\" \\\n  --parameters serviceSettingDeployAzureAIVision=\"$(optional_serviceSettingDeployAzureAIVision)\" \\\n  --parameters serviceSettingDeployAzureSpeech=\"$optional_serviceSettingDeployAzureSpeech)\" \\\n  --parameters serviceSettingDeployAIDocIntelligence=\"$(optional_serviceSettingDeployAIDocIntelligence)\" \\\n  --parameters IPwhiteList=\"$(project_IP_whitelist)\" \\\n  2>&1)\nexit_code=$?\n\nif [ $exit_code -eq 0 ]; then\n    echo \"Deployment succeeded.\"\nelse\n    if echo \"$output\" | grep -q \"The role assignment already disable exists.\"; then\n        echo \"The role assignment already exists. Error: $output\"\n        exit 0\n    else\n        echo \"Deployment failed. Error: $output\"\n        exit $exit_code\n    fi\nfi","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"08_az_remove_ip_from_seeding_keyvault_FW_whitelist","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"always()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az keyvault network-rule remove --resource-group $(admin_seeding_keyvault_rg) --name $(admin_seeding_keyvault) --ip-address $(admin_ip_fw)","args":"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"https://vsrm.dev.azure.com/ESML_AI_Factory/07da37fe-9071-4440-9127-f52f859d3062/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/ESML_AI_Factory/_apis/public/Release/badge/07da37fe-9071-4440-9127-f52f859d3062/38/104"},{"id":105,"name":"aifactory-project-test","rank":2,"owner":{"displayName":"Joakim Åström","url":"https://spsprodweu4.vssps.visualstudio.com/Ae8dda09f-c2b4-4692-b8a9-19b9ca10e69b/_apis/Identities/557c9a45-3a85-6eff-ab88-9f8a5f00114e","_links":{"avatar":{"href":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"}},"id":"557c9a45-3a85-6eff-ab88-9f8a5f00114e","uniqueName":"ESML_AI_Factory@microsoft.com","imageUrl":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl","descriptor":"aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"},"variables":{"dev_test_prod":{"value":"test"},"dev_test_prod_sub_id":{"value":"TODO_subscriptionID-23qsed-f1234asdf1-23asdf2134f"}},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":315}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":318},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":321}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"windows-2022"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":92,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"01_pwsh_get_IP_for_ADO_agent","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"ps","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"$resp = $resp = Invoke-RestMethod http://ipinfo.io/json | Select -exp ip\n        Write-Host $resp\n        Write-Host \"##vso[task.setvariable variable=admin_ip_fw]$resp\"\n        $ipAddr = $resp\n        Write-Host ipAddr is: $admin_ip_fw","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"02_az_set_ADO_ip_to_sedding_keyvault_FW_whitelist","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az keyvault network-rule add --resource-group $(admin_seeding_keyvault_rg) --name $(admin_seeding_keyvault) --ip-address $(admin_ip_fw)","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"1e244d32-2dd4-4165-96fb-b7441ca9331e","version":"2.*","name":"03_download_seeding_keyvault","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceName":"47b43cde-c003-4a0d-8ad1-40d4050d326e","KeyVaultName":"esaifac-seeding-sdc-001","SecretsFilter":"*","RunAsPreJob":"false"}},{"environment":{},"taskId":"72a1931b-effb-4d2e-8fd8-f8472a07cb62","version":"4.*","name":"04_pwsh_calculate_subnet_allocations","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","ScriptType":"FilePath","ScriptPath":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/subnetCalc.ps1","Inline":"# You can write your azure powershell scripts inline here. \n# You can also pass predefined and custom variables to this script using arguments","ScriptArguments":"-bicepPar1 \"../../../../../aifactory/parameters/10-esml-globals-1.json\" -bicepPar2 \"../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json\" -bicepPar3 \"../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json\" -bicepPar4 \"../../../../../aifactory/parameters/21-22-esml-prj-parameters.json\" -filePath \"../../../../../aifactory/parameters/\" -spObjId \"$(esml-common-bicep-sp-id)\" -spSecret \"$(esml-common-bicep-sp-secret)\" -env \"$(dev_test_prod)\" -subscriptionId \"$(dev_test_prod_sub_id)\" -prjResourceSuffix \"$(admin_prjResourceSuffix)\" -aifactorySuffixRGADO \"$(admin_aifactorySuffixRG)\" -commonResourceSuffixADO \"$(admin_commonResourceSuffix)\" -locationADO \"$(admin_location)\" -locationSuffixADO \"$(admin_locationSuffix)\" -useServicePrincipal -bicepPar5 \"../../../../../aifactory/parameters/10-esml-globals-override.json\" -projectTypeADO \"$(admin_projectType)\"","errorActionPreference":"stop","FailOnStandardError":"false","RestrictContextToCurrentTask":"false","TargetAzurePs":"LatestVersion","CustomTargetAzurePs":"3.5.0","pwsh":"true","validateScriptSignature":"false","workingDirectory":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"05_bicep_deploy_subnets_and_NSG","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az deployment group create \\\n--name \"esml-p$(project_number_000)-$(dev_test_prod)-$(admin_locationSuffix)$(admin_aifactorySuffixRG)SubnetDeplProj\" \\\n--subscription \"$(dev_test_prod_sub_id)\" \\\n--resource-group \"$(cat \"..\\..\\..\\..\\aifactory\\parameters\\subnetParameters.json\" | grep vnetResourceGroup -A1 | tail -n1 | cut -d: -f2 | tr -d \" \\\"\")\" \\\n--template-file \"esml-genai-1\\31-network.bicep\" \\\n--parameters @\"..\\..\\..\\..\\aifactory\\parameters\\subnetParameters.json\" \\\n--parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-override.json\" \\\n--parameters env=\"$(dev_test_prod)\" \\\n--parameters projectNumber=\"$(project_number_000)\"","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"06_pwsh_fetch_network_parameters","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"pscore","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/genDynamicNetworkParamFile.ps1","inlineScript":"","scriptArguments":"-spObjId \"$(esml-common-bicep-sp-id)\" -spSecret \"$(esml-common-bicep-sp-secret)\" -useServicePrincipal -bicepPar1 \"../../../../../aifactory/parameters/10-esml-globals-1.json\" -bicepPar2 \"../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json\" -bicepPar3 \"../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json\" -bicepPar4 \"../../../../../aifactory/parameters/21-22-esml-prj-parameters.json\" -filePath \"../../../../../aifactory/parameters/\" -env \"$(dev_test_prod)\" -locationSuffixADO \"$(admin_locationSuffix)\" -aifactorySuffixRGADO \"$(admin_aifactorySuffixRG)\" -projectNumber \"$(project_number_000)\" -subscriptionId \"$(dev_test_prod_sub_id)\" -bicepPar5 \"../../../../../aifactory/parameters/10-esml-globals-override.json\" -projectTypeADO \"$(admin_projectType)\"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"07_pwsh_bicep_deploy_genai_project","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"output=$(az deployment sub create \\\n  --name \"esml-p$(project_number_000)-$(dev_test_prod)-$(admin_locationSuffix)-$(admin_prjResourceSuffix)$(admin_commonResourceSuffix)$PrjDepl\" \\\n  --subscription \"$(dev_test_prod_sub_id)\" \\\n  --location \"$(admin_location)\" \\\n  --template-file \"esml-genai-1\\32-main.bicep\" \\\n  --parameters adminPassword=\"$(cat /dev/urandom | tr -dc 'A-Za-z0-9_!@#$%^&*()\\-+=' | head -c24 ; echo)\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-1.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-2-12_13_21_22.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-3-12_13.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-4-13_21_22.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-5-13_23.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-override.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\21-22-esml-prj-parameters.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\dynamicNetworkParams.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\23-esml-prj-rbac-parameters.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\31-esgenai-default.json\" \\\n  --parameters env=\"$(dev_test_prod)\" \\\n  --parameters projectNumber=\"$(project_number_000)\" \\\n  --parameters technicalAdminsObjectID=\"$(technical_admins_ad_object_id)\" \\\n  --parameters technicalAdminsEmail=\"$(technical_admins_email)\" \\\n  --parameters location=\"$(admin_location)\" \\\n  --parameters locationSuffix=\"$(admin_locationSuffix)\" \\\n  --parameters resourceSuffix=\"$(admin_prjResourceSuffix)\" \\\n  --parameters aifactorySuffixRG=\"$(admin_aifactorySuffixRG)\" \\\n  --parameters commonResourceSuffix=\"$(admin_commonResourceSuffix)\" \\\n  --parameters projectServicePrincipleOID_SeedingKeyvaultName=\"$(project_service_principal_OID_seed_kv_name)\" \\\n  --parameters projectServicePrincipleAppID_SeedingKeyvaultName=\"$(project_service_principal_AppID_seed_kv_name)\" \\\n  --parameters projectServicePrincipleSecret_SeedingKeyvaultName=\"$(project_service_principal_secret_seed_kv_name)\" \\\n  --parameters inputKeyvault=\"$(admin_seeding_keyvault)\" \\\n  --parameters inputKeyvaultResourcegroup=\"$(admin_seeding_keyvault_rg)\" \\\n  --parameters inputKeyvaultSubscription=\"$(admin_seeding_keyvault_subscription)\" \\\n  --parameters aks_dev_sku_override=\"$(admin_aks_gpu_sku_dev_override)\" \\\n  --parameters aks_test_prod_sku_override=\"$(admin_aks_gpu_sku_test_prod_override)\" \\\n  --parameters aks_dev_nodes_override=\"$(admin_aks_nodes_dev_override)\" \\\n  --parameters aks_test_prod_nodes_override=\"$(admin_aks_nodes_testProd_override)\" \\\n  --parameters aks_version_override=\"$(admin_aks_version_override)\" \\\n  --parameters aml_cluster_dev_sku_override=\"$(admin_aml_cluster_sku_dev_override)\" \\\n  --parameters aml_cluster_test_prod_sku_override=\"$(admin_aml_cluster_sku_testProd_override)\" \\\n  --parameters aml_cluster_dev_nodes_override=\"$(admin_aml_cluster_maxNodes_dev_override)\" \\\n  --parameters aml_cluster_test_prod_nodes_override=\"$(admin_aml_cluster_maxNodes_testProd_override)\" \\\n  --parameters aml_ci_dev_sku_override=\"$(admin_aml_computeInstance_dev_sku_override)\" \\\n  --parameters aml_ci_test_prod_sku_override=\"$(admin_aml_computeInstance_testProd_sku_override)\" \\\n  --parameters enablePublicGenAIAccess=\"$(admin_enablePublicGenAIAccess)\" \\\n  --parameters serviceSettingDeployAzureAIVision=\"$(optional_serviceSettingDeployAzureAIVision)\" \\\n  --parameters serviceSettingDeployAzureSpeech=\"$optional_serviceSettingDeployAzureSpeech)\" \\\n  --parameters serviceSettingDeployAIDocIntelligence=\"$(optional_serviceSettingDeployAIDocIntelligence)\" \\\n  --parameters IPwhiteList=\"$(project_IP_whitelist)\" \\\n  2>&1)\nexit_code=$?\n\nif [ $exit_code -eq 0 ]; then\n    echo \"Deployment succeeded.\"","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"08_az_remove_ip_from_seeding_keyvault_FW_whitelist","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"always()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az keyvault network-rule remove --resource-group $(admin_seeding_keyvault_rg) --name $(admin_seeding_keyvault) --ip-address $(admin_ip_fw)","args":"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"https://vsrm.dev.azure.com/ESML_AI_Factory/07da37fe-9071-4440-9127-f52f859d3062/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/ESML_AI_Factory/_apis/public/Release/badge/07da37fe-9071-4440-9127-f52f859d3062/38/105"},{"id":106,"name":"aifactory-project-prod","rank":3,"owner":{"displayName":"Joakim Åström","url":"https://spsprodweu4.vssps.visualstudio.com/Ae8dda09f-c2b4-4692-b8a9-19b9ca10e69b/_apis/Identities/557c9a45-3a85-6eff-ab88-9f8a5f00114e","_links":{"avatar":{"href":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"}},"id":"557c9a45-3a85-6eff-ab88-9f8a5f00114e","uniqueName":"ESML_AI_Factory@microsoft.com","imageUrl":"https://dev.azure.com/ESML_AI_Factory/_apis/GraphProfile/MemberAvatars/aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl","descriptor":"aad.NTU3YzlhNDUtM2E4NS03ZWZmLWFiODgtOWY4YTVmMDAxMTRl"},"variables":{"dev_test_prod":{"value":"prod"},"dev_test_prod_sub_id":{"value":"TODO_subscriptionID-rt123qsed-f1234asdf-123asdf2134f"}},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":316}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":317},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":322}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"windows-2022"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"_esml-aifactory","artifactType":"Git","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":92,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"01_pwsh_get_IP_for_ADO_agent","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"ps","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"$resp = $resp = Invoke-RestMethod http://ipinfo.io/json | Select -exp ip\n        Write-Host $resp\n        Write-Host \"##vso[task.setvariable variable=admin_ip_fw]$resp\"\n        $ipAddr = $resp\n        Write-Host ipAddr is: $admin_ip_fw","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"02_az_set_ADO_ip_to_sedding_keyvault_FW_whitelist","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az keyvault network-rule add --resource-group $(admin_seeding_keyvault_rg) --name $(admin_seeding_keyvault) --ip-address $(admin_ip_fw)","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"1e244d32-2dd4-4165-96fb-b7441ca9331e","version":"2.*","name":"03_download_seeding_keyvault","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceName":"47b43cde-c003-4a0d-8ad1-40d4050d326e","KeyVaultName":"esaifac-seeding-sdc-001","SecretsFilter":"*","RunAsPreJob":"false"}},{"environment":{},"taskId":"72a1931b-effb-4d2e-8fd8-f8472a07cb62","version":"5.*","name":"04_pwsh_calculate_subnet_allocations","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","ScriptType":"FilePath","ScriptPath":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/subnetCalc.ps1","Inline":"# You can write your azure powershell scripts inline here. \n# You can also pass predefined and custom variables to this script using arguments","ScriptArguments":"-bicepPar1 \"../../../../../aifactory/parameters/10-esml-globals-1.json\" -bicepPar2 \"../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json\" -bicepPar3 \"../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json\" -bicepPar4 \"../../../../../aifactory/parameters/21-22-esml-prj-parameters.json\" -filePath \"../../../../../aifactory/parameters/\" -spObjId \"$(esml-common-bicep-sp-id)\" -spSecret \"$(esml-common-bicep-sp-secret)\" -env \"$(dev_test_prod)\" -subscriptionId \"$(dev_test_prod_sub_id)\" -prjResourceSuffix \"$(admin_prjResourceSuffix)\" -aifactorySuffixRGADO \"$(admin_aifactorySuffixRG)\" -commonResourceSuffixADO \"$(admin_commonResourceSuffix)\" -locationADO \"$(admin_location)\" -locationSuffixADO \"$(admin_locationSuffix)\" -useServicePrincipal -bicepPar5 \"../../../../../aifactory/parameters/10-esml-globals-override.json\" -projectTypeADO \"$(admin_projectType)\"","errorActionPreference":"stop","FailOnStandardError":"false","TargetAzurePs":"LatestVersion","CustomTargetAzurePs":"3.5.0","pwsh":"true","validateScriptSignature":"false","workingDirectory":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"05_bicep_deploy_subnets_and_NSG","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az deployment group create \\\n--name \"esml-p$(project_number_000)-$(dev_test_prod)-$(admin_locationSuffix)$(admin_aifactorySuffixRG)SubnetDeplProj\" \\\n--subscription \"$(dev_test_prod_sub_id)\" \\\n--resource-group \"$(cat \"..\\..\\..\\..\\aifactory\\parameters\\subnetParameters.json\" | grep vnetResourceGroup -A1 | tail -n1 | cut -d: -f2 | tr -d \" \\\"\")\" \\\n--template-file \"esml-genai-1\\31-network.bicep\" \\\n--parameters @\"..\\..\\..\\..\\aifactory\\parameters\\subnetParameters.json\" \\\n--parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-override.json\" \\\n--parameters env=\"$(dev_test_prod)\" \\\n--parameters projectNumber=\"$(project_number_000)\"","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"06_pwsh_fetch_network_parameters","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"pscore","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/genDynamicNetworkParamFile.ps1","inlineScript":"","scriptArguments":"-spObjId \"$(esml-common-bicep-sp-id)\" -spSecret \"$(esml-common-bicep-sp-secret)\" -useServicePrincipal -bicepPar1 \"../../../../../aifactory/parameters/10-esml-globals-1.json\" -bicepPar2 \"../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json\" -bicepPar3 \"../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json\" -bicepPar4 \"../../../../../aifactory/parameters/21-22-esml-prj-parameters.json\" -filePath \"../../../../../aifactory/parameters/\" -env \"$(dev_test_prod)\" -locationSuffixADO \"$(admin_locationSuffix)\" -aifactorySuffixRGADO \"$(admin_aifactorySuffixRG)\" -projectNumber \"$(project_number_000)\" -subscriptionId \"$(dev_test_prod_sub_id)\" -bicepPar5 \"../../../../../aifactory/parameters/10-esml-globals-override.json\" -projectTypeADO \"$(admin_projectType)\"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"2.*","name":"07_pwsh_bicep_deploy_genai_project","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptType":"bash","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"output=$(az deployment sub create \\\n  --name \"esml-p$(project_number_000)-$(dev_test_prod)-$(admin_locationSuffix)-$(admin_prjResourceSuffix)$(admin_commonResourceSuffix)$PrjDepl\" \\\n  --subscription \"$(dev_test_prod_sub_id)\" \\\n  --location \"$(admin_location)\" \\\n  --template-file \"esml-genai-1\\32-main.bicep\" \\\n  --parameters adminPassword=\"$(cat /dev/urandom | tr -dc 'A-Za-z0-9_!@#$%^&*()\\-+=' | head -c24 ; echo)\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-1.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-2-12_13_21_22.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-3-12_13.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-4-13_21_22.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-5-13_23.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\10-esml-globals-override.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\21-22-esml-prj-parameters.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\dynamicNetworkParams.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\23-esml-prj-rbac-parameters.json\" \\\n  --parameters @\"..\\..\\..\\..\\aifactory\\parameters\\31-esgenai-default.json\" \\\n  --parameters env=\"$(dev_test_prod)\" \\\n  --parameters projectNumber=\"$(project_number_000)\" \\\n  --parameters technicalAdminsObjectID=\"$(technical_admins_ad_object_id)\" \\\n  --parameters technicalAdminsEmail=\"$(technical_admins_email)\" \\\n  --parameters location=\"$(admin_location)\" \\\n  --parameters locationSuffix=\"$(admin_locationSuffix)\" \\\n  --parameters resourceSuffix=\"$(admin_prjResourceSuffix)\" \\\n  --parameters aifactorySuffixRG=\"$(admin_aifactorySuffixRG)\" \\\n  --parameters commonResourceSuffix=\"$(admin_commonResourceSuffix)\" \\\n  --parameters projectServicePrincipleOID_SeedingKeyvaultName=\"$(project_service_principal_OID_seed_kv_name)\" \\\n  --parameters projectServicePrincipleAppID_SeedingKeyvaultName=\"$(project_service_principal_AppID_seed_kv_name)\" \\\n  --parameters projectServicePrincipleSecret_SeedingKeyvaultName=\"$(project_service_principal_secret_seed_kv_name)\" \\\n  --parameters inputKeyvault=\"$(admin_seeding_keyvault)\" \\\n  --parameters inputKeyvaultResourcegroup=\"$(admin_seeding_keyvault_rg)\" \\\n  --parameters inputKeyvaultSubscription=\"$(admin_seeding_keyvault_subscription)\" \\\n  --parameters aks_dev_sku_override=\"$(admin_aks_gpu_sku_dev_override)\" \\\n  --parameters aks_test_prod_sku_override=\"$(admin_aks_gpu_sku_test_prod_override)\" \\\n  --parameters aks_dev_nodes_override=\"$(admin_aks_nodes_dev_override)\" \\\n  --parameters aks_test_prod_nodes_override=\"$(admin_aks_nodes_testProd_override)\" \\\n  --parameters aks_version_override=\"$(admin_aks_version_override)\" \\\n  --parameters aml_cluster_dev_sku_override=\"$(admin_aml_cluster_sku_dev_override)\" \\\n  --parameters aml_cluster_test_prod_sku_override=\"$(admin_aml_cluster_sku_testProd_override)\" \\\n  --parameters aml_cluster_dev_nodes_override=\"$(admin_aml_cluster_maxNodes_dev_override)\" \\\n  --parameters aml_cluster_test_prod_nodes_override=\"$(admin_aml_cluster_maxNodes_testProd_override)\" \\\n  --parameters aml_ci_dev_sku_override=\"$(admin_aml_computeInstance_dev_sku_override)\" \\\n  --parameters aml_ci_test_prod_sku_override=\"$(admin_aml_computeInstance_testProd_sku_override)\" \\\n  --parameters enablePublicGenAIAccess=\"$(admin_enablePublicGenAIAccess)\" \\\n  --parameters serviceSettingDeployAzureAIVision=\"$(optional_serviceSettingDeployAzureAIVision)\" \\\n  --parameters serviceSettingDeployAzureSpeech=\"$optional_serviceSettingDeployAzureSpeech)\" \\\n  --parameters serviceSettingDeployAIDocIntelligence=\"$(optional_serviceSettingDeployAIDocIntelligence)\" \\\n  --parameters IPwhiteList=\"$(project_IP_whitelist)\" \\\n  2>&1)\nexit_code=$?\n\nif [ $exit_code -eq 0 ]; then\n    echo \"Deployment succeeded.\"\nelse\n    if echo \"$output\" | grep -q \"The role assignment already disable exists.\"; then\n        echo \"The role assignment already exists. Error: $output\"\n        exit 0\n    else\n        echo \"Deployment failed. Error: $output\"\n        exit $exit_code\n    fi\nfi","scriptArguments":"","powerShellErrorActionPreference":"stop","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_esml-aifactory/azure-enterprise-scale-ml/environment_setup/aifactory/bicep","failOnStandardError":"false","powerShellIgnoreLASTEXITCODE":"false","visibleAzLogin":"true","keepAzSessionActive":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"08_az_remove_ip_from_seeding_keyvault_FW_whitelist","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"always()","inputs":{"connectedServiceNameARM":"47b43cde-c003-4a0d-8ad1-40d4050d326e","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az keyvault network-rule remove --resource-group $(admin_seeding_keyvault_rg) --name $(admin_seeding_keyvault) --ip-address $(admin_ip_fw)","args":"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"https://vsrm.dev.azure.com/ESML_AI_Factory/07da37fe-9071-4440-9127-f52f859d3062/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/ESML_AI_Factory/_apis/public/Release/badge/07da37fe-9071-4440-9127-f52f859d3062/38/106"}],"artifacts":[{"sourceId":"07da37fe-9071-4440-9127-f52f859d3062:b3db2f04-55e4-4892-833e-0c119d24d587","type":"Git","alias":"_esml-aifactory","definitionReference":{"branches":{"id":"main","name":"main"},"checkoutNestedSubmodules":{"id":"True","name":"Any nested submodules within"},"checkoutSubmodules":{"id":"true","name":"true"},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionType":{"id":"latestFromBranchType","name":"Latest from the default branch"},"definition":{"id":"b3db2f04-55e4-4892-833e-0c119d24d587","name":"aifactory-infra-001"},"fetchDepth":{"id":"","name":""},"gitLfsSupport":{"id":"","name":""},"project":{"id":"07da37fe-9071-4440-9127-f52f859d3062","name":"ESML-MLOps"}},"isPrimary":true,"isRetained":false}],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseClone"},"IntegrateBoardsWorkItems":{"$type":"System.String","$value":"False"},"IntegrateJiraWorkItems":{"$type":"System.String","$value":"false"}},"id":38,"name":"infra-project-genai","path":"\\202408-esml-aifactory-001","projectReference":null,"url":"https://vsrm.dev.azure.com/ESML_AI_Factory/07da37fe-9071-4440-9127-f52f859d3062/_apis/Release/definitions/38","_links":{"self":{"href":"https://vsrm.dev.azure.com/ESML_AI_Factory/07da37fe-9071-4440-9127-f52f859d3062/_apis/Release/definitions/38"},"web":{"href":"https://dev.azure.com/ESML_AI_Factory/07da37fe-9071-4440-9127-f52f859d3062/_release?definitionId=38"}}}