name: infra-project-genai

on:
    #push:
    workflow_dispatch:
      inputs:
        environment:
          description: 'Github Environment to get variables and secrets from [dev,stage,prod]'
          required: true
          default: 'dev'
env:
    # Flow control
    ENABLE_STEP: 'false' # Enable/Disable a step
    ENABLE_DEBUG_STEP: 'false' # Enable/Disable a step
    ENABLE_NETWORKING_JOB: "${{ vars.RUN_JOB1_NETWORKING }}"
        
    AIFACTORY_VERSION_MAJOR: "${{ vars.AIFACTORY_VERSION_MAJOR }}" # Minor version of the AIFactory. 1 in 1.12
    AIFACTORY_VERSION_MINOR: "${{ vars.AIFACTORY_VERSION_MINOR }}" # Minor as 21 in 1.21 
    BYO_SUBNETS: "${{ vars.BYO_SUBNETS }}" # Minor version of the AIFactory. 1 in 1.12
    NETWORK_ENV: "${{ vars.NETWORK_ENV }}" # Minor as 21 in 1.21 
    AIFACTORY_SALT: "${{ vars.AIFACTORY_SALT }}" # random salt for the AIFactory.Determenistic salt, for datalake, storage, keyvault. Set before Datalake structure upload
    AIFACTORY_SALT_RANDOM: "${{ vars.AIFACTORY_SALT_RANDOM }}" # random salt for the AIFactory. AIServices, ManagedIdentties. Set before UPDATING/Adding resoures
    
    # ADMIN usual culprits - verify, twice. (only configure once)
    admin_bicep_input_keyvault_subscription: "${{ secrets.AIFACTORY_SEEDING_KEYVAULT_SUBSCRIPTION_ID }}" # seeding keyvault, subscription id
    admin_bicep_kv_fw: "${{ vars.AIFACTORY_SEEDING_KEYVAULT_NAME }}" # seeding keyvault, name
    admin_bicep_kv_fw_rg: "${{ vars.AIFACTORY_SEEDING_KEYVAULT_RG }}" #seeding keyvault, resource group
    admin_aifactorySuffixRG: "${{ vars.AIFACTORY_SUFFIX }}"  #"-002"
    admin_aifactoryPrefixRG: "${{ vars.AIFACTORY_PREFIX }}"  # <company>-<aifactoryname> Examples: ["acme-ai-", "mrvel-1-", "contoso-", "ms-ai-"]
    common-sp-appid-seeding-kv-name: "${{ vars.COMMON_SERVICE_PRINCIPAL_KV_S_NAME_APPID}}" # "esml-common-bicep-sp-id"
    common-sp-secret-seeding-kv-name: "${{ vars.COMMON_SERVICE_PRINCIPAL_KV_S_NAME_SECRET}}" # "esml-common-bicep-sp-secret"
    admin_hybridBenefit: false # Enable Hybrid Benefits if provisioning VM access via Bastion
    admin_commonResourceSuffix: "-001"
    admin_prjResourceSuffix: "-001"
    admin_keyvaultSoftDeleteDays: "${{ vars.KEYVAULT_SOFT_DELETE}}"  # 90 days is default. 0 is disabled. 90 days is recommended.
    use_groups: "${{ vars.USE_AD_GROUPS }}" # true, use AD groups for project members & advanced Personas. false, use individual ObjectID's and simple mode Personas
    tenantId: "${{ secrets.TENANT_ID }}" # "12345678-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    semanticSearchTier: "${{ vars.AISEARCH_SEMANTIC_TIER }}" # "S0" or "S1". S0 is free tier. S1 is paid tier.

    # ADMIN specific START (only configure once)
    admin_ip_fw: "192.x.x.x" # Do not touch. leave as-is. This is just a placeholder a script will populate later.
    admin_location: "${{ vars.AIFACTORY_LOCATION }}"
    admin_locationSuffix: "${{ vars.AIFACTORY_LOCATION_SHORT }}"
    dev_test_prod_sub_id: "${{ vars.AZURE_SUBSCRIPTION_ID }}" # "a1234567-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    dev_test_prod: "${{ vars.AZURE_ENV_NAME }}" # ESML AIFactory environment: [dev,test,prod]
   
    # PROJECT specific START (configure for each project)
    project_IP_whitelist: "${{ secrets.PROJECT_MEMBERS_IP_ADDRESS }}" # "192.x.x.x"
    technical_admins_ad_object_id: "${{ secrets.PROJECT_MEMBERS }}"  # comma separated list with no spaces: "012345ab-xxxx-xxxx-xxxx-xxxxxxxxxxxx,1234f-af-234-adfssdf,12312-aef23431"
    technical_admins_email: "${{ vars.PROJECT_MEMBERS_EMAILS }}"  # comma separated list
    project_number_000: "${{ vars.PROJECT_NUMBER }}"  # Project number (3 digits), example "003"
    project_service_principal_AppID_seeding_kv_name: "${{ vars.PROJECT_SERVICE_PRINCIPAL_KV_S_NAME_APPID }}" # Service principle ID, name from seeding keyvault (need to be from enterprise application)
    project_service_principal_OID_seeding_kv_name: "${{ vars.PROJECT_SERVICE_PRINCIPAL_KV_S_NAME_OID }}" # Service principle Object ID, name from seeding keyvault (need to be from enterprise application)
    project_service_principal_Secret_seeding_kv_name: "${{ vars.PROJECT_SERVICE_PRINCIPAL_KV_S_NAME_S }}" # Service principle secret, name from seeding keyvault
    
    # PROJECT TYPE specific
    admin_projectType: "genai-1" # Project type, [esml,genai-1]
    useCommonACR: "${{ vars.USE_COMMON_ACR_FOR_PROJECTS }}" # Use common Azure Container Registry (save cost), insted of each project having its own.

    # OPTIONAL - GENAI specific
    azure_machinelearning_sp_oid: "${{ vars.TENANT_AZUREML_OID }}" # Azure Machine Learning service principle Object ID. In Entra ID called "Azure Machine Learning" with AppId:0736f41a-0425-4b46-bdb5-1563eff02385

    # See PARAMETER folder instead. 31-esgenai-default.json

    # admin_enablePublicGenAIAccess: false # Enable public access to GenAI
    # optional_serviceSettingDeployAIDocIntelligence: false # Deploy AI Doc Intelligence
    # optional_serviceSettingDeployAzureAIVision: false # Deploy Azure AI Vision
    # optional_serviceSettingDeployAzureSpeech: false # Deploy Azure Speech
    # optional_serviceSettingDeployAzureAppService: false # Deploy Azure App Service and a WebApp
    # optional_serviceSettingDeployAzureFunction: false # Deploy Azure App Service and a WebApp
    # optional_serviceSettingDeployAzureContainerApps: false # Deploy Azure ContainerApps
    # optional_serviceSettingDeployAzureCosmosDB: false # Deploy Azure CosmosDB

    # See PARAMETER folder instead, END

    # OPTIONAL - ESML specific https://learn.microsoft.com/en-us/azure/virtual-machines/ncads-h100-v5
    admin_aks_gpu_sku_dev_override: "Standard_B4ms" # GPU train: [Standard_NC24rs_v3,Standard_ND96amsr_A100_v4] GPU Inference [Standard_NC40ads_H100_v5,Standard_NC80adis_H100_v5]. CPU["Standard_B4ms"]
    admin_aks_gpu_sku_test_prod_override: Standard_DS13-2_v2 # AKS GPU SKU for test/prod
    admin_aks_nodes_dev_override: 1 # AKS nodes for dev
    admin_aks_nodes_testProd_override: 3 # AKS nodes for test/prod
    admin_aks_version_override: "1.30.3" # AKS version (1.30.3 | 1.30.7: LTS in UKS, SDC, EASTUS2)
    admin_aml_cluster_maxNodes_dev_override: 3 # AML cluster max nodes for dev
    admin_aml_cluster_maxNodes_testProd_override: 5 # AML cluster max nodes for test/prod
    admin_aml_cluster_sku_dev_override: "Standard_DS3_v2" # AML cluster SKU for dev. GPU Train: Standard_ND96amsr_A100_v4.  GPU Inference [Standard_NC40ads_H100_v5,Standard_NC80adis_H100_v5]
    admin_aml_cluster_sku_testProd_override: "Standard_D13_v2" # AML cluster SKU for test/prod
    admin_aml_computeInstance_dev_sku_override: "Standard_DS11_v2" # AML compute instance SKU for dev
    admin_aml_computeInstance_testProd_sku_override: "Standard_ND96amsr_A100_v4" # AML compute instance SKU for test/prod
    admin_private_azureMLStudioUI: true # Private Azure ML Studio UI
    admin_private_DatabricksUI: false # Private Databricks UI
jobs:
  job1-deploy-networking-project-genai:
    name: ESGenAI_Private_Networking
    environment: ${{github.event.inputs.environment}}
    runs-on: ubuntu-latest
    if: vars.RUN_JOB1_NETWORKING != 'false'
    defaults:
      run:
        shell: pwsh
        #working-directory: "${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/"
    steps:
    - name: Print info
      run: |
        echo "The value of vars.RUN_JOB1_NETWORKING  is: ${{ vars.RUN_JOB1_NETWORKING }}"
        echo "The value of env.ENABLE_NETWORKING_JOB  is: ${{ env.ENABLE_NETWORKING_JOB }}"
        echo "The value of env.admin_enablePublicGenAIAccess is: ${{ env.admin_enablePublicGenAIAccess }}"
        echo "The value of env.project_number_000  is: ${{ env.project_number_000 }}"
        echo "The value of env.admin_aks_version_override  is: ${{ env.technical_admins_email }}"
        echo "The value of env.admin_projectType  is: ${{ env.admin_projectType }}"
        echo "The value of env.useCommonACR  is: ${{ env.useCommonACR }}"
        echo "The value of env.admin_aks_version_override  is: ${{ env.admin_aks_version_override }}"
    - name: Set TLS 1.2
      run: |
        pwsh -Command "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12"
    - name: Set as Powershell repo as trusted
      run: |
        pwsh -Command "Register-PSRepository -Default"
    - name: Install PowershellGet manually
      run: |
        pwsh -Command "Install-Module -Name PowerShellGet -Force -AllowClobber"
    - name: Azure Login
      uses: azure/login@v2
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        enable-AzPSSession: true
    - name: GIT
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      uses: actions/checkout@v4
      with:
        submodules: true
    - name: 01_pwsh_get_IP_for_GH_runner
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      continue-on-error: true
      run: |
        $resp = Invoke-RestMethod http://ipinfo.io/json | Select -exp ip
        echo "runner_ip=$resp" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
        echo "Environment is (vars.AZURE_ENV_NAME): ${{env.dev_test_prod}}"
      shell: pwsh
    - name: Use environment variable
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      run: |
        echo "The value of runner_ip is: ${{ env.runner_ip }}"
    - name: 02_az_set_ip_to_seeding_keyvault_FW_whitelist
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      continue-on-error: true
      uses: azure/cli@v2
      with:
        inlineScript: |
          az account set --subscription ${{ env.admin_bicep_input_keyvault_subscription }}
          az keyvault network-rule add --resource-group ${{ env.admin_bicep_kv_fw_rg }} --name ${{ env.admin_bicep_kv_fw }} --ip-address ${{ env.runner_ip }}
        azcliversion: latest
    - name: 03_az_download_seeding_keyvault
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      uses: azure/cli@v2
      with:
        inlineScript: |
          az account set --subscription ${{ env.admin_bicep_input_keyvault_subscription }}
          echo "common-sp-appid-value=$(az keyvault secret show --vault-name ${{ env.admin_bicep_kv_fw }} --name ${{ env.common-sp-appid-seeding-kv-name }} --query 'value' --output tsv)" >> $GITHUB_ENV
          echo "common-sp-secret-value=$(az keyvault secret show --vault-name ${{ env.admin_bicep_kv_fw }} --name ${{ env.common-sp-secret-seeding-kv-name }} --query 'value' --output tsv)" >> $GITHUB_ENV
        azcliversion: latest
    - name: Set permissions 755 on WORKSPACE
      if: env.ENABLE_NETWORKING_JOB  != 'false' && env.ENABLE_DEBUG_STEP == 'true'
      run: chmod -R 755 ${{ github.workspace }}
    - name: Set permissions 757 on scripts
      if: env.ENABLE_NETWORKING_JOB  != 'false' && env.ENABLE_DEBUG_STEP == 'true'
      run: chmod -R 757 ${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts
    - name: 04_pwsh_calculate_subnet_allocations
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      working-directory: ${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts
      run: |
        sudo pwsh -Command  ${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/subnetCalc_v2.ps1 -bicepPar1 '../../../../../aifactory/parameters/10-esml-globals-1.json' -bicepPar2 '../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json' -bicepPar3 '../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json' -bicepPar4 '../../../../../aifactory/parameters/21-22-esml-prj-parameters.json' -bicepPar5 '../../../../../aifactory/parameters/10-esml-globals-override.json' -filePath '../../../../../aifactory/parameters/' -spObjId '${{ env.common-sp-appid-value }}' -spSecret '${{ env.common-sp-secret-value }}' -env '${{ env.dev_test_prod }}' -subscriptionId '${{ env.dev_test_prod_sub_id }}' -prjResourceSuffix '${{ env.admin_prjResourceSuffix }}' -aifactorySuffixRGADO '${{ env.admin_aifactorySuffixRG }}' -commonRGNamePrefixVar '${{ env.admin_aifactoryPrefixRG }}' -commonResourceSuffixADO '${{ env.admin_commonResourceSuffix }}' -locationADO '${{ env.admin_location}}' -locationSuffixADO '${{ env.admin_locationSuffix }}' -projectTypeADO '${{ env.admin_projectType }}' -useServicePrincipal
      shell: pwsh
    - name: 04B_pwsh_calculate_subnet_allocations
      if: env.ENABLE_NETWORKING_JOB  != 'false' && env.ENABLE_DEBUG_STEP == 'true'
      uses: azure/powershell@v2
      #working-directory: "${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/"
      with: # Warning: Unexpected input(s) 'working-directory', valid inputs are ['inlineScript', 'azcliversion'] Solution: Set-Location -Path
        inlineScript: |
          sudo pwsh -Command "
            Set-Location -Path '${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts';
            ./subnetCalc_v2.ps1 -bicepPar1 '../../../../../aifactory/parameters/10-esml-globals-1.json' -bicepPar2 '../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json' -bicepPar3 '../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json' -bicepPar4 '../../../../../aifactory/parameters/21-22-esml-prj-parameters.json' -bicepPar5 '../../../../../aifactory/parameters/10-esml-globals-override.json' -filePath '../../../../../aifactory/parameters/' -spObjId '${{ env.common-sp-appid-value }}' -spSecret '${{ env.common-sp-secret-value }}' -env '${{ env.dev_test_prod }}' -subscriptionId '${{ env.dev_test_prod_sub_id }}' -prjResourceSuffix '${{ env.admin_prjResourceSuffix }}' -aifactorySuffixRGADO '${{ env.admin_aifactorySuffixRG }}' -commonRGNamePrefixVar '${{ env.admin_aifactoryPrefixRG }}' -commonResourceSuffixADO '${{ env.admin_commonResourceSuffix }}' -locationADO '${{ env.admin_location}}' -locationSuffixADO '${{ env.admin_locationSuffix }}' -projectTypeADO '${{ env.admin_projectType }}' -useServicePrincipal
          "
        azPSVersion: latest
    - name: 05_az_bicep_deploy_subnets_and_NSGs
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      uses: azure/cli@v2
      with: 
        #working-directory: "${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/"
        inlineScript: |
          echo "Deploying subnets and NSG to subscription: ${{ env.dev_test_prod_sub_id }}"
          az account set --subscription ${{ env.dev_test_prod_sub_id }}
          az deployment group create \
          --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}${{ env.admin_aifactorySuffixRG }}SubnetDeplProj" \
          --subscription "${{ env.dev_test_prod_sub_id }}" \
          --resource-group "$( cat "./aifactory/parameters/subnetParameters.json" | grep vnetResourceGroup -A1 | tail -n1 | cut -d: -f2 | tr -d " \"" )" \
          --template-file "azure-enterprise-scale-ml\environment_setup\aifactory\bicep\esml-genai-1\31-network.bicep" \
          --parameters @"./aifactory/parameters/subnetParameters.json" \
          --parameters @"./aifactory/parameters/10-esml-globals-1.json" \
          --parameters @"./aifactory/parameters/10-esml-globals-override.json" \
          --parameters env="${{ env.dev_test_prod }}" \
          --parameters projectNumber="${{ env.project_number_000 }}" \
          --parameters location="${{ env.admin_location}}" \
          --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
          --parameters useCommonACR="${{ env.useCommonACR }}" \
          --debug
        azcliversion: latest
    - name: 06_az_remove_ip_from_seeding_keyvault_FW_whitelist
      if: env.ENABLE_NETWORKING_JOB  != 'false'
      uses: azure/cli@v2
      with:
        inlineScript: | 
          az account set --subscription ${{ env.admin_bicep_input_keyvault_subscription }}        
          az keyvault network-rule remove --resource-group ${{ env.admin_bicep_kv_fw_rg }} --name ${{ env.admin_bicep_kv_fw }} --ip-address $runner_ip
        azcliversion: latest
      #if: always()
  job2-deploy-services-project-genai:
      name: ESGenAI_Services
      environment: ${{github.event.inputs.environment}}
      runs-on: ubuntu-latest
      needs: job1-deploy-networking-project-genai
      if: always()
      defaults:
        run:
          shell: pwsh
          #working-directory: "${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/"
      steps:
      - name: Print info
        run: |
          echo "The value of env.admin_enablePublicGenAIAccess is: ${{ env.admin_enablePublicGenAIAccess }}"
          echo "The value of env.project_number_000  is: ${{ env.project_number_000 }}"
          echo "The value of env.admin_aks_version_override  is: ${{ env.technical_admins_email }}"
          echo "The value of env.admin_projectType  is: ${{ env.admin_projectType }}"
          echo "The value of env.useCommonACR  is: ${{ env.useCommonACR }}"
          echo "The value of env.ENABLE_NETWORKING_JOB  is: ${{ env.ENABLE_NETWORKING_JOB }}"
          echo "The value of env.admin_aks_version_override  is: ${{ env.admin_aks_version_override }}"
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true
      - name: GIT
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: 01_pwsh_get_IP_for_GH_runner
        run: |
          $resp = Invoke-RestMethod http://ipinfo.io/json | Select -exp ip
          echo "runner_ip=$resp" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          echo "Environment is (env.AZURE_ENV_NAME): ${{env.dev_test_prod}}"
        shell: pwsh
      - name: Use environment variable
        run: |
          echo "The value of runner_ip is $runner_ip"
      - name: 02_az_set_ip_to_seeding_keyvault_FW_whitelist
        uses: azure/cli@v2
        with:
          inlineScript: |
            az account set --subscription ${{ env.admin_bicep_input_keyvault_subscription }}
            
            echo "Setting Key Vault network access to 'selected networks'..."
            az keyvault update --name ${{ env.admin_bicep_kv_fw }} \
              --resource-group ${{ env.admin_bicep_kv_fw_rg }} \
              --default-action Deny \
              --public-network-access Enabled
            
            # Wait for network configuration to propagate
            echo "Waiting for network configuration to propagate..."
            sleep 15

            az keyvault network-rule add --resource-group ${{ env.admin_bicep_kv_fw_rg }} --name ${{ env.admin_bicep_kv_fw }} --ip-address $runner_ip
          azcliversion: latest
      - name: 03_az_download_seeding_keyvault
        uses: azure/cli@v2
        with:
          inlineScript: |
            az account set --subscription ${{ env.admin_bicep_input_keyvault_subscription }}
            echo "common-sp-appid-value=$(az keyvault secret show --vault-name ${{ env.admin_bicep_kv_fw }} --name ${{ env.common-sp-appid-seeding-kv-name }} --query 'value' --output tsv)" >> $GITHUB_ENV
            echo "common-sp-secret-value=$(az keyvault secret show --vault-name ${{ env.admin_bicep_kv_fw }} --name ${{ env.common-sp-secret-seeding-kv-name }} --query 'value' --output tsv)" >> $GITHUB_ENV
            echo "project_sp_oid_value=$(az keyvault secret show --vault-name ${{ env.admin_bicep_kv_fw }} --name ${{ env.project_service_principal_OID_seeding_kv_name }} --query 'value' --output tsv)" >> $GITHUB_ENV
          azcliversion: latest
      - name: 04_Generate dynamic network parameters
        working-directory: ${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts
        run: |
          sudo pwsh -Command "${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts/genDynamicNetworkParamFile.ps1 -spObjId '${{env.common-sp-appid-value}}' -spSecret '${{env.common-sp-secret-value}}' -useServicePrincipal -bicepPar1 '../../../../../aifactory/parameters/10-esml-globals-1.json' -bicepPar2 '../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json' -bicepPar3 '../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json' -bicepPar4 '../../../../../aifactory/parameters/21-22-esml-prj-parameters.json' -filePath '../../../../../aifactory/parameters/' -env '${{env.dev_test_prod}}' -locationSuffixADO '${{env.admin_locationSuffix}}' -aifactorySuffixRGADO '${{env.admin_aifactorySuffixRG}}' -commonRGNamePrefixVar '${{ env.admin_aifactoryPrefixRG }}' -projectNumber '${{ env.project_number_000 }}' -subscriptionId '${{env.dev_test_prod_sub_id}}' -bicepPar5 '../../../../../aifactory/parameters/10-esml-globals-override.json' -projectTypeADO '${{env.admin_projectType}}'"
        shell: pwsh
      - name: 05_Import_or_Build default image offline, to private registry (ACR) if not exists
        uses: azure/cli@v2
        with:
          inlineScript: |
            #!/bin/bash
            
            az account set --subscription ${{ env.dev_test_prod_sub_id }}
            
            # Configuration flags
            use_public_image=true  # Set to true to use public image instead of building
            mcr_ms_hello='mcr.microsoft.com/azuredocs/containerapps-helloworld:latest'
            
            # Create registry name from variables
            registryNameOrg="acrcommon${{ env.AIFACTORY_SALT }}${{ env.admin_locationSuffix }}${{ env.admin_commonResourceSuffix }}${{ env.dev_test_prod }}"
            registryName=$(echo "${registryNameOrg}" | tr -d '-')
            echo "Registry name: $registryName"
            
            # Set registry name for cleanup task
            echo "acr_registry_name=$registryName" >> $GITHUB_ENV

            # Check if image already exists first (before any network configuration)
            echo "Checking if image containerapps-default:latest already exists in registry..."
            if az acr repository show --name $registryName --image containerapps-default:latest &> /dev/null; then
              echo "✅  Image containerapps-default:latest already exists in registry $registryName"
              echo "Skipping image creation and network configuration."
              exit 0
            fi
            
            echo "❌  Image does not exist, proceeding with creation..."

            # Configure ACR for selective network access
            echo "Configuring ACR for selective network access"
            az acr update --name $registryName --public-network-enabled true --default-action Deny

            # Wait for network rules to propagate
            echo "Waiting for network rules to propagate..."
            sleep 30
            
            # Get current IP addresses
            echo "Getting current IP addresses right before ACR operations..."
            CURRENT_IP1=$(curl -s http://ipinfo.io/ip 2>/dev/null || echo "")
            CURRENT_IP2=$(curl -s https://api.ipify.org 2>/dev/null || echo "")
            CURRENT_IP3=$(curl -s https://checkip.amazonaws.com 2>/dev/null || echo "")
            CURRENT_IP4=$(curl -s https://icanhazip.com 2>/dev/null || echo "")
            
            echo "Current IPs detected: $CURRENT_IP1, $CURRENT_IP2, $CURRENT_IP3, $CURRENT_IP4"
            
            # Store IPs that we actually add for cleanup - using GitHub environment variables
            ADDED_IPS_LIST=""
            
            # Add broader IP ranges for GitHub Actions agents
            echo "Adding GitHub Actions service IP ranges (more permissive approach)"
            
            PRIMARY_IP=$(curl -s http://ipinfo.io/ip 2>/dev/null)
            if [ -n "$PRIMARY_IP" ]; then
              IP_BASE_16=$(echo $PRIMARY_IP | cut -d'.' -f1-2)
              BROAD_RANGE_16="${IP_BASE_16}.0.0/16"
              echo "Adding very broad IP range: $BROAD_RANGE_16"
              az acr network-rule add --name $registryName --ip-address "$BROAD_RANGE_16" || true
              ADDED_IPS_LIST="$ADDED_IPS_LIST,$BROAD_RANGE_16"
              
              IP_BASE_24=$(echo $PRIMARY_IP | cut -d'.' -f1-3)
              BROAD_RANGE_24="${IP_BASE_24}.0/24"
              echo "Adding broad IP range: $BROAD_RANGE_24"
              az acr network-rule add --name $registryName --ip-address "$BROAD_RANGE_24" || true
              ADDED_IPS_LIST="$ADDED_IPS_LIST,$BROAD_RANGE_24"
            fi
            
            # Add common GitHub Actions IP ranges (updated for GitHub's documented ranges)
            GITHUB_ACTIONS_RANGES=(
              "13.107.6.0/24"
              "13.107.9.0/24"
              "13.107.42.0/24"
              "13.107.43.0/24"
              "104.208.0.0/16"
              "52.0.0.0/8"
              "13.0.0.0/8"
              "140.82.112.0/20"
              "185.199.108.0/22"
              "192.30.252.0/22"
            )
            
            for range in "${GITHUB_ACTIONS_RANGES[@]}"; do
              echo "Adding GitHub Actions IP range: $range"
              az acr network-rule add --name $registryName --ip-address "$range" || true
              ADDED_IPS_LIST="$ADDED_IPS_LIST,$range"
            done
            
            # Add individual detected IPs as backup
            CURRENT_IPS=("$CURRENT_IP1" "$CURRENT_IP2" "$CURRENT_IP3" "$CURRENT_IP4")
            for current_ip in "${CURRENT_IPS[@]}"; do
              if [ -n "$current_ip" ]; then
                echo "Adding detected IP: $current_ip"
                az acr network-rule add --name $registryName --ip-address "$current_ip" || true
                ADDED_IPS_LIST="$ADDED_IPS_LIST,$current_ip"
              fi
            done
            
            # Store the list of added IPs for cleanup (remove leading comma)
            ADDED_IPS_LIST=$(echo "$ADDED_IPS_LIST" | sed 's/^,//')
            echo "acr_added_ips=$ADDED_IPS_LIST" >> $GITHUB_ENV
            echo "Stored IPs for cleanup: $ADDED_IPS_LIST"
            
            # Wait for network rules to propagate
            echo "Waiting for network rules to propagate..."
            sleep 30
            
            # Create the image (since we already confirmed it doesn't exist)
            echo "Creating new image..."
            
            if [ "$use_public_image" = true ]; then
              echo "Using public image: $mcr_ms_hello"
              timestamp=$(date +%Y%m%d-%H%M%S)
              
              echo "Importing public image to ACR with latest tag..."
              az acr import --name $registryName \
                            --source $mcr_ms_hello \
                            --image containerapps-default:latest \
                            --force
              
              echo "Importing public image to ACR with timestamp tag..."
              az acr import --name $registryName \
                            --source $mcr_ms_hello \
                            --image containerapps-default:$timestamp \
                            --force
              
              echo "Public image imported to ACR successfully!"
            else
              echo "Building custom image using ACR build..."
              az acr build --registry $registryName \
                          --image containerapps-default:latest \
                          --file azure-enterprise-scale-ml/environment_setup/aifactory/dockerfiles/acaDefault/Dockerfile \
                          azure-enterprise-scale-ml/environment_setup/aifactory/dockerfiles/acaDefault/
            fi

            # Verify image was created successfully
            sleep 30
            if az acr repository show --name $registryName --image containerapps-default:latest &> /dev/null; then
              echo "Image exists. Verified."
            else
              echo "Tried to verify Image, but it does NOT exist"
              exit 1
            fi
          azcliversion: latest
      - name: 05a_Check if Private DNS Zones exist
        uses: azure/cli@v2
        with:
          inlineScript: |
            #!/bin/bash

            az account set --subscription ${{ env.dev_test_prod_sub_id }}

            # Input parameters
            privDnsSubscription="${{ env.dev_test_prod_sub_id }}"
            privDnsResourceGroupName="${{ env.admin_aifactoryPrefixRG }}esml-common-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}"
            location="${{ env.admin_location }}"

            # Define key-value pairs for DNS Zones
            declare -A dnsZones=(
              [zoneazurecontainerapps]="privatelink.${location}.azurecontainerapps.io"
              [zoneredis]="privatelink.redis.cache.windows.net"
              [zonepostgres]="privatelink.postgres.database.azure.com"
              [zonesql]="privatelink.database.windows.net"
              [zoneMongo]="privatelink.mongo.cosmos.azure.com"
            )

            # Helper function to check if a Private DNS Zone exists
            dns_zone_exists() {
              local subscription="$1"
              local resourceGroup="$2"
              local dnsZoneName="$3"

              # Run the az network private-dns zone show command and capture its output and exit status
              local output
              output=$(az network private-dns zone show --subscription "$subscription" --resource-group "$resourceGroup" --name "$dnsZoneName" 2>&1)
              local status=$?

              # Check if the command succeeded
              if [ $status -ne 0 ]; then
                echo "false"
              else
                echo "true"
              fi
            }

            # Check each DNS Zone
            for key in "${!dnsZones[@]}"; do
              dnsZoneName="${dnsZones[$key]}"
              exists=$(dns_zone_exists "$privDnsSubscription" "$privDnsResourceGroupName" "$dnsZoneName")
              echo "${key}Exists=${exists}" >> $GITHUB_ENV
              echo "Checked DNS Zone: $dnsZoneName, Exists: $exists"
            done

            # Print variables for debugging
            echo "Private DNS Subscription: $privDnsSubscription"
            echo "Private DNS Resource Group: $privDnsResourceGroupName"
            echo "Location: $location"

          azcliversion: latest
      - name: 05b_Check if resource exists
        uses: azure/cli@v2
        with:
          inlineScript: |
            #!/bin/bash

            az account set --subscription ${{ env.dev_test_prod_sub_id }}

            # Input parameters
            commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}"
            projectNumber="${{ env.project_number_000 }}"
            projectName="prj${projectNumber}"
            locationSuffix="${{ env.admin_locationSuffix }}"
            envName="${{ env.dev_test_prod }}"
            aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}"
            resourceSuffix="${{ env.admin_prjResourceSuffix }}"
            prjResourceSuffixNoDash="${resourceSuffix#-}"
            twoNumbers="${resourceSuffix:2:2}"

            # Construct resource group name
            projectNameReplaced="${projectName/prj/project}"
            targetResourceGroup="${commonRGNamePrefix}esml-${projectNameReplaced}-${locationSuffix}-${envName}${aifactorySuffixRG}-rg"

            # Check if target resource group exists first
            echo "Checking if target resource group exists: $targetResourceGroup"
            if ! az group show --name "$targetResourceGroup" --subscription "${{ env.dev_test_prod_sub_id }}" &> /dev/null; then
              echo "Target resource group '$targetResourceGroup' does not exist. Setting all resource existence flags to false."
              
              # Set all resource existence flags to false
              echo "aiHubExists=false" >> $GITHUB_ENV
              echo "aifProjectExists=false" >> $GITHUB_ENV
              echo "amlExists=false" >> $GITHUB_ENV
              echo "openaiExists=false" >> $GITHUB_ENV
              echo "aiSearchExists=false" >> $GITHUB_ENV
              echo "dashboardInsightsExists=false" >> $GITHUB_ENV
              echo "applicationInsightExists=false" >> $GITHUB_ENV
              echo "aiServicesExists=false" >> $GITHUB_ENV
              echo "bingExists=false" >> $GITHUB_ENV
              echo "containerAppsEnvExists=false" >> $GITHUB_ENV
              echo "containerAppAExists=false" >> $GITHUB_ENV
              echo "containerAppWExists=false" >> $GITHUB_ENV
              echo "cosmosDBExists=false" >> $GITHUB_ENV
              echo "functionAppExists=false" >> $GITHUB_ENV
              echo "webAppExists=false" >> $GITHUB_ENV
              echo "funcAppServicePlanExists=false" >> $GITHUB_ENV
              echo "webAppServicePlanExists=false" >> $GITHUB_ENV
              echo "keyvaultExists=false" >> $GITHUB_ENV
              echo "miACAExists=false" >> $GITHUB_ENV
              echo "miPrjExists=false" >> $GITHUB_ENV
              echo "storageAccount1001Exists=false" >> $GITHUB_ENV
              echo "storageAccount2001Exists=false" >> $GITHUB_ENV
              echo "aifExists=false" >> $GITHUB_ENV
              echo "redisExists=false" >> $GITHUB_ENV
              echo "postgreSQLExists=false" >> $GITHUB_ENV
              echo "sqlServerExists=false" >> $GITHUB_ENV
              echo "sqlDBExists=false" >> $GITHUB_ENV
              echo "acrProjectExists=false" >> $GITHUB_ENV
              echo "vmExists=false" >> $GITHUB_ENV
              
              echo "Resource group does not exist - skipping resource checks"
              exit 0
            fi

            echo "Target resource group exists. Proceeding with resource checks."

            # Helper function for fuzzy resource existence check
            resource_exists_fuzzy() {
              local rg="$1"
              local type="$2"
              local prefix="$3"
              local suffix="$4"

              # Run the az resource list command and capture its output and exit status
              local output
              output=$(az resource list --resource-group "$rg" --resource-type "$type" --query "[?starts_with(name, '$prefix') && ends_with(name, '$suffix')]" 2>&1)
              local status=$?

              # Check if the command succeeded
              if [ $status -ne 0 ]; then
                echo "Warning: Failed to list resources in resource group '$rg' with type '$type'."
                echo "Details: $output"
                echo "false"
                return 0
              fi

              # Check if the resource exists
              if echo "$output" | grep -q "$prefix"; then
                echo "true"
              else
                echo "false"
              fi
            }

            # Helper function for exact resource existence check
            resource_exists_exact() {
              local rg="$1"
              local type="$2"
              local name="$3"
              if az resource show --resource-group "$rg" --name "$name" --resource-type "$type" &> /dev/null; then
                echo "true"
              else
                echo "false"
              fi
            }

            # Resource name variables
            suffixStandard="${resourceSuffix}"
            suffixStandardNoDash="${prjResourceSuffixNoDash}"
            suffixStorage1=$(echo "1${prjResourceSuffixNoDash}${envName}" | tr -d '-')
            suffixStorage2=$(echo "2${prjResourceSuffixNoDash}${envName}" | tr -d '-')
            suffixAppServicePlan="${resourceSuffix}-plan"
            suffixAcr="${env}{prjResourceSuffixNoDash}"
            suffixKeyvault="${twoNumbers}"

            aiHubName="ai-hub-${projectName}-${locationSuffix}-${envName}"
            aifProjectName="ai-prj${projectNumber}-01-${locationSuffix}-${env}"
            amlName="aml-${projectName}-${locationSuffix}-${envName}"
            openaiName="aoai-${projectName}-${locationSuffix}-${env}"
            safeNameAISearch="aisearch${projectName}${locationSuffix}${envName}"
            dashboardInsightsName="AIFactory${aifactorySuffixRG}-${projectName}-insights-${envName}"
            applicationInsightName="ain-${projectName}-${locationSuffix}-${envName}"
            aiServicesPrefix="aiservices${projectName}${locationSuffix}${envName}"
            bingName="bing-${projectName}-${locationSuffix}-${envName}"
            containerAppsEnvName="aca-env-${projectName}-${locationSuffix}-${envName}"
            containerAppAName="aca-a-${projectName}${locationSuffix}${envName}"
            containerAppWName="aca-w-${projectName}${locationSuffix}${envName}"
            cosmosDBName="cosmos-${projectName}-${locationSuffix}-${envName}"
            functionAppName="func-${projectName}-${locationSuffix}-${envName}"
            webAppName="webapp-${projectName}-${locationSuffix}-${envName}"
            funcAppServicePlanName="func-${projectName}-${locationSuffix}-${envName}"
            webbAppServicePlanName="webapp-${projectName}-${locationSuffix}-${envName}"
            keyvaultName="kv-p${projectNumber}-${locationSuffix}-${envName}"
            miACAPrefix="mi-aca-${projectName}-${locationSuffix}-${envName}"
            miPrjPrefix="mi-${projectName}-${locationSuffix}-${envName}"
            storageAccount1001Name="sa${projectName}${locationSuffix}"
            storageAccount2001Name="sa${projectName}${locationSuffix}"
            aifName="aif-hub-${projectName}-${locationSuffix}-${envName}"
            redisName="redis-${projectName}-${locationSuffix}-${envName}"
            postgreSQLName="pg-flex-${projectName}-${locationSuffix}-${envName}"
            sqlServerName="sql-${projectName}-${locationSuffix}-${envName}"
            sqlDBName="sqldb-${projectName}-${locationSuffix}-${envName}"
            acrProjectName="acr${projectName}genai${locationSuffix}"
            vmName="dsvm-${projectName}-${locationSuffix}-${env}"


            # Check resources (fuzzy for those with randomSalt,unique, exact for others)
            echo "aiHubExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.MachineLearningServices/workspaces" "$aiHubName" "$suffixStandard")" >> $GITHUB_ENV
            echo "aifProjectExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.MachineLearningServices/workspaces" "$aifProjectName" "$suffixStandard")" >> $GITHUB_ENV
            echo "amlExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.MachineLearningServices/workspaces" "$amlName" "$suffixStandard")" >> $GITHUB_ENV
            echo "openaiExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.CognitiveServices/accounts" "$openaiName" "$suffixStandard")" >> $GITHUB_ENV
            echo "aiSearchExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Search/searchServices" "$safeNameAISearch" "$suffixStandardNoDash")" >> $GITHUB_ENV
            echo "dashboardInsightsExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Insights/components" "$dashboardInsightsName" "$suffixStandard")" >> $GITHUB_ENV
            echo "applicationInsightExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Insights/components" "$applicationInsightName" "$suffixStandard")" >> $GITHUB_ENV
            echo "aiServicesExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.CognitiveServices/accounts" "$aiServicesPrefix" "$suffixStandardNoDash")" >> $GITHUB_ENV
            echo "bingExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.CognitiveServices/accounts" "$bingName" "$suffixStandard")" >> $GITHUB_ENV
            echo "containerAppsEnvExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.App/managedEnvironments" "$containerAppsEnvName" "$suffixStandard")" >> $GITHUB_ENV
            echo "containerAppAExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.App/containerApps" "$containerAppAName" "$suffixStandard")" >> $GITHUB_ENV
            echo "containerAppWExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.App/containerApps" "$containerAppWName" "$suffixStandard")" >> $GITHUB_ENV
            echo "cosmosDBExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.DocumentDB/databaseAccounts" "$cosmosDBName" "$suffixStandard")" >> $GITHUB_ENV
            echo "functionAppExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Web/sites" "$functionAppName" "$suffixStandard")" >> $GITHUB_ENV
            echo "webAppExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Web/sites" "$webAppName" "$suffixStandard")" >> $GITHUB_ENV
            echo "funcAppServicePlanExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Web/serverfarms" "$funcAppServicePlanName" "$suffixAppServicePlan")" >> $GITHUB_ENV
            echo "webAppServicePlanExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Web/serverfarms" "$webbAppServicePlanName" "$suffixAppServicePlan")" >> $GITHUB_ENV
            echo "keyvaultExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.KeyVault/vaults" "$keyvaultName" "$suffixKeyvault")" >> $GITHUB_ENV
            echo "miACAExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.ManagedIdentity/userAssignedIdentities" "$miACAPrefix" "$suffixStandard")" >> $GITHUB_ENV
            echo "miPrjExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.ManagedIdentity/userAssignedIdentities" "$miPrjPrefix" "$suffixStandard")" >> $GITHUB_ENV
            echo "storageAccount1001Exists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Storage/storageAccounts" "$storageAccount1001Name" "$suffixStorage1")" >> $GITHUB_ENV
            echo "storageAccount2001Exists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Storage/storageAccounts" "$storageAccount2001Name" "$suffixStorage2")" >> $GITHUB_ENV
            echo "aifExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.MachineLearningServices/workspaces" "$aifName" "$suffixStandard")" >> $GITHUB_ENV
            echo "redisExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Cache/Redis" "$redisName" "$suffixStandard")" >> $GITHUB_ENV
            echo "postgreSQLExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.DBforPostgreSQL/flexibleServers" "$postgreSQLName" "$suffixStandard")" >> $GITHUB_ENV
            echo "sqlServerExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Sql/servers" "$sqlServerName" "$suffixStandard")" >> $GITHUB_ENV
            echo "sqlDBExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Sql/servers/databases" "$sqlDBName" "*")" >> $GITHUB_ENV
            echo "acrProjectExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.ContainerRegistry/registries" "$acrProjectName" "$suffixAcr")" >> $GITHUB_ENV
            echo "vmExists=$(resource_exists_fuzzy "$targetResourceGroup" "Microsoft.Compute/virtualMachines" "$vmName" "$suffixStandard")" >> $GITHUB_ENV

            echo "Resource existence check completed successfully."
            echo "Target Resource Group: $targetResourceGroup"
            echo "Key Vault Name: $keyvaultName"
          azcliversion: latest
      - name: 05c_Validate Required Parameters
        run: |
          # List of required environment variables
          required_vars=(
            "env.aiHubExists"  
            "env.aifProjectExists"
            "env.amlExists"   
            "env.aiSearchExists" 
            "env.dashboardInsightsExists"  
            "env.applicationInsightExists"  
            "env.aiServicesExists"  
            "env.bingExists"
            "env.containerAppsEnvExists"  
            "env.containerAppWExists"
            "env.containerAppAExists"
            "env.cosmosDBExists"
            "env.functionAppExists"
            "env.webAppExists"
            "env.funcAppServicePlanExists"
            "env.webAppServicePlanExists"
            "env.keyvaultExists"
            "env.miACAExists"
            "env.miPrjExists"
            "env.storageAccount1001Exists"
            "env.storageAccount2001Exists"
            "env.aifExists"
            "env.redisExists"
            "env.postgreSQLExists"
            "env.sqlServerExists"
            "env.sqlDBExists"
            "env.acrProjectExists"
            "env.vmExists"
            "env.zoneazurecontainerappsExists"
            "env.zoneredisExists"
            "env.zonepostgresExists"
            "env.zonesqlExists"
            "env.zoneMongoExists"
          )

          # List of environment variables that should only generate warnings
          warning_vars=(
            "env.AIFACTORY_SALT_RANDOM"
          )

          # Validate each variable
          for var in "${required_vars[@]}"; do
            # Remove the 'env.' prefix to get the actual environment variable name
            var_name="${var#env.}"
            value="${!var_name}"
            echo "Checking variable: $var, Value: $value"
            if [ -z "$value" ]; then
              echo "Warning: Required environment variable $var is not set or empty."
              exit 0
            fi
          done

          # Check warning variables (don't exit on failure)
          for var in "${warning_vars[@]}"; do
            # Remove the 'env.' prefix to get the actual environment variable name
            var_name="${var#env.}"
            value="${!var_name}"
            echo "Checking variable: $var, Value: $value"
            if [ -z "$value" ] || [ ${#value} -lt 4 ]; then
              echo "Warning: Environment variable $var is not set, empty, or less than 4 characters (It should be 10). AIFACTORY_SALT_RANDOM is fine to be empty, if you init a project, But needed if UPDATING a project/adding services"
            fi
          done

          echo "All required parameters are set and valid."
        shell: bash
      - name: 06_az_bicep_deploy_genai_project
        uses: azure/cli@v2
        with:
          #working-directory: "${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/"
          inlineScript: |
            az account set --subscription ${{ env.dev_test_prod_sub_id }}
            az deployment sub create \
            --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}$PrjDepl" \
            --subscription "${{ env.dev_test_prod_sub_id }}" \
            --location "${{ env.admin_location }}" \
            --template-file "azure-enterprise-scale-ml\environment_setup\aifactory\bicep\esml-genai-1\32-main.bicep" \
            --parameters adminPassword="$( date +%s | sha256sum | base64 | head -c 32 ; echo )" \
            --parameters @"./aifactory/parameters/10-esml-globals-1.json" \
            --parameters @"./aifactory/parameters/10-esml-globals-2-12_13_21_22.json" \
            --parameters @"./aifactory/parameters/10-esml-globals-3-12_13.json" \
            --parameters @"./aifactory/parameters/10-esml-globals-4-13_21_22.json" \
            --parameters @"./aifactory/parameters/10-esml-globals-5-13_23.json" \
            --parameters @"./aifactory/parameters/10-esml-globals-override.json" \
            --parameters @"./aifactory/parameters/21-22-esml-prj-parameters.json" \
            --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
            --parameters @"./aifactory/parameters/23-esml-prj-rbac-parameters.json" \
            --parameters @"./aifactory/parameters/31-esgenai-default.json" \
            --parameters env="${{ env.dev_test_prod }}" \
            --parameters projectNumber="${{ env.project_number_000 }}" \
            --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
            --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
            --parameters location="${{ env.admin_location }}" \
            --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
            --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
            --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
            --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
            --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
            --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
            --parameters projectServicePrincipleAppID_SeedingKeyvaultName="${{ env.project_service_principal_AppID_seeding_kv_name }}" \
            --parameters projectServicePrincipleSecret_SeedingKeyvaultName="${{ env.project_service_principal_Secret_seeding_kv_name }}" \
            --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
            --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
            --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
            --parameters aks_dev_sku_override="${{ env.admin_aks_gpu_sku_dev_override }}" \
            --parameters aks_test_prod_sku_override="${{ env.admin_aks_gpu_sku_test_prod_override }}" \
            --parameters aks_dev_nodes_override="${{ env.admin_aks_nodes_dev_override }}" \
            --parameters aks_test_prod_nodes_override="${{ env.admin_aks_nodes_testProd_override }}" \
            --parameters aks_version_override="${{ env.admin_aks_version_override }}" \
            --parameters aml_cluster_dev_sku_override="${{ env.admin_aml_cluster_sku_dev_override }}" \
            --parameters aml_cluster_test_prod_sku_override="${{ env.admin_aml_cluster_sku_testProd_override }}" \
            --parameters aml_cluster_dev_nodes_override="${{ env.admin_aml_cluster_maxNodes_dev_override }}" \
            --parameters aml_ci_dev_sku_override="${{ env.admin_aml_computeInstance_dev_sku_override }}" \
            --parameters aml_ci_test_prod_sku_override="${{ env.admin_aml_computeInstance_testProd_sku_override }}" \
            --parameters azureMachineLearningObjectId="${{ env.azure_machinelearning_sp_oid }}" \
            --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
            --parameters keyvaultSoftDeleteDays="${{ env.admin_keyvaultSoftDeleteDays }}" \
            --parameters useAdGroups="${{ env.use_groups }}" \
            --parameters useCommonACR="${{ env.useCommonACR }}" \
            --parameters tenantId="${{ env.tenantId }}" \
            --parameters BYO_subnets="${{ env.BYO_SUBNETS }}" \
            --parameters network_env="${{ env.NETWORK_ENV }}" \
            --parameters aifactoryVersionMajor="${{ env.AIFACTORY_VERSION_MAJOR }}" \
            --parameters aifactoryVersionMinor="${{ env.AIFACTORY_VERSION_MINOR }}" \
            --parameters semanticSearchTier="${{ env.semanticSearchTier }}" \
            --parameters aiHubExists="${{ env.aiHubExists }}" \
            --parameters aifProjectExists="${{ env.aifProjectExists }}" \
            --parameters amlExists="${{ env.amlExists }}" \
            --parameters aiSearchExists="${{ env.aiSearchExists }}" \
            --parameters dashboardInsightsExists="${{ env.dashboardInsightsExists }}" \
            --parameters applicationInsightExists="${{ env.applicationInsightExists }}" \
            --parameters aiServicesExists="${{ env.aiServicesExists }}" \
            --parameters bingExists="${{ env.bingExists }}" \
            --parameters containerAppsEnvExists="${{ env.containerAppsEnvExists }}" \
            --parameters containerAppAExists="${{ env.containerAppAExists }}" \
            --parameters containerAppWExists="${{ env.containerAppWExists }}" \
            --parameters cosmosDBExists="${{ env.cosmosDBExists }}" \
            --parameters functionAppExists="${{ env.functionAppExists }}" \
            --parameters webAppExists="${{ env.webAppExists }}" \
            --parameters funcAppServicePlanExists="${{ env.funcAppServicePlanExists }}" \
            --parameters webAppServicePlanExists="${{ env.webAppServicePlanExists }}" \
            --parameters keyvaultExists="${{ env.keyvaultExists }}" \
            --parameters miACAExists="${{ env.miACAExists }}" \
            --parameters miPrjExists="${{ env.miPrjExists }}" \
            --parameters storageAccount1001Exists="${{ env.storageAccount1001Exists }}" \
            --parameters storageAccount2001Exists="${{ env.storageAccount2001Exists }}" \
            --parameters aifExists="${{ env.aifExists }}" \
            --parameters redisExists="${{ env.redisExists }}" \
            --parameters postgreSQLExists="${{ env.postgreSQLExists }}" \
            --parameters sqlServerExists="${{ env.sqlServerExists }}" \
            --parameters sqlDBExists="${{ env.sqlDBExists }}" \
            --parameters acrProjectExists="${{ env.acrProjectExists }}" \
            --parameters vmExists="${{ env.vmExists }}" \
            --parameters zoneAzurecontainerappsExists="${{ env.zoneazurecontainerappsExists }}" \
            --parameters zoneRedisExists="${{ env.zoneredisExists }}" \
            --parameters zonePostgresExists="${{ env.zonepostgresExists }}" \
            --parameters zoneSqlExists="${{ env.zonesqlExists }}" \
            --parameters zoneMongoExists="${{ env.zoneMongoExists }}" \
            --parameters aifactorySalt10char="${{ env.AIFACTORY_SALT_RANDOM }}" \
            --debug
          azcliversion: latest
      - name: 06_az_remove_ip_from_seeding_keyvault_FW_whitelist
        continue-on-error: true
        uses: azure/cli@v2
        with:
          inlineScript: | 
            az account set --subscription ${{ env.admin_bicep_input_keyvault_subscription }}
            az keyvault network-rule remove --resource-group ${{ env.admin_bicep_kv_fw_rg }} --name ${{ env.admin_bicep_kv_fw }} --ip-address $runner_ip
          azcliversion: latest
        if: always()
      - name: 07_az_remove_ips_from_ACR_FW_whitelist
        uses: azure/cli@v2
        if: always()
        with:
          inlineScript: |
            #!/bin/bash
            
            # Get the registry name and IPs from previous task
            registryName="${{ env.acr_registry_name }}"
            added_ips_string="${{ env.acr_added_ips }}"
            
            echo "Registry name: $registryName"
            echo "IPs to remove: $added_ips_string"
            
            # Check if we have IPs to remove
            if [ -n "$added_ips_string" ] && [ "$added_ips_string" != "" ]; then
              echo "Cleaning up: Removing IPs and ranges that were added during ACR operations"
              
              # Convert comma-separated string to array
              IFS=',' read -ra ADDED_IPS <<< "$added_ips_string"
              
              for ip in "${ADDED_IPS[@]}"; do
                if [ -n "$ip" ]; then
                  echo "Removing IP/range from ACR whitelist: $ip"
                  az acr network-rule remove --name "$registryName" --ip-address "$ip" || echo "Failed to remove $ip or it was already removed"
                fi
              done
              
              echo "ACR firewall cleanup completed."
            else
              echo "No IPs to remove from ACR firewall."
            fi
          azcliversion: latest