name: infra-project

on:
  workflow_dispatch:
    inputs:
      environment:
        description: GitHub Environment to load variables/secrets from [dev,stage,prod]
        required: true
        default: dev

jobs:
  deploy-project:
    name: Project (Networking + Services)
    environment: ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh
    env:
      dev_test_prod: ${{ vars.AZURE_ENV_NAME }}
      dev_test_prod_sub_id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      # Single source of truth for environment (matches ADO): dev_test_prod drives everything
      # network_env uses per-environment repo vars when provided, falls back to shared NETWORK_ENV or AZURE_ENV_NAME
      network_env: ${{ github.event.inputs.environment == 'dev' && (vars.DEV_NETWORK_ENV || vars.NETWORK_ENV || 'dev')
        || github.event.inputs.environment == 'stage' && (vars.STAGE_NETWORK_ENV || vars.NETWORK_ENV || 'test')
        || github.event.inputs.environment == 'prod' && (vars.PROD_NETWORK_ENV || vars.NETWORK_ENV || 'prod')
        || vars.NETWORK_ENV || vars.AZURE_ENV_NAME || '' }}

      admin_location: ${{ vars.AIFACTORY_LOCATION }}
      admin_locationSuffix: ${{ vars.AIFACTORY_LOCATION_SHORT }}
      admin_aifactoryPrefixRG: ${{ vars.AIFACTORY_PREFIX }}
      admin_aifactorySuffixRG: ${{ vars.AIFACTORY_SUFFIX }}
      admin_commonResourceSuffix: ${{ vars.ADMIN_COMMON_RESOURCE_SUFFIX || '-001' }}
      admin_prjResourceSuffix: ${{ vars.ADMIN_PRJ_RESOURCE_SUFFIX || '-001' }}

      admin_keyvaultSoftDeleteDays: ${{ vars.KEYVAULT_SOFT_DELETE || '7' }}
      tenantId: ${{ secrets.TENANT_ID }}
      use_groups: ${{ vars.USE_AD_GROUPS || 'true' }}

      # Seeding Key Vault
      admin_bicep_input_keyvault_subscription: ${{ secrets.AIFACTORY_SEEDING_KEYVAULT_SUBSCRIPTION_ID }}
      admin_bicep_kv_fw: ${{ vars.AIFACTORY_SEEDING_KEYVAULT_NAME }}
      admin_bicep_kv_fw_rg: ${{ vars.AIFACTORY_SEEDING_KEYVAULT_RG }}
      common_sp_appid_seeding_kv_name: ${{ vars.COMMON_SERVICE_PRINCIPAL_KV_S_NAME_APPID }}
      common_sp_secret_seeding_kv_name: ${{ vars.COMMON_SERVICE_PRINCIPAL_KV_S_NAME_SECRET }}

      # Project settings
      project_number_000: ${{ vars.PROJECT_NUMBER }}
      project_IP_whitelist: ${{ secrets.PROJECT_MEMBERS_IP_ADDRESS }}
      technical_admins_ad_object_id: ${{ secrets.PROJECT_MEMBERS }}
      technical_admins_email: ${{ vars.PROJECT_MEMBERS_EMAILS }}
      project_service_principal_AppID_seeding_kv_name: ${{ vars.PROJECT_SERVICE_PRINCIPAL_KV_S_NAME_APPID }}
      project_service_principal_OID_seeding_kv_name: ${{ vars.PROJECT_SERVICE_PRINCIPAL_KV_S_NAME_OID }}
      project_service_principal_Secret_seeding_kv_name: ${{ vars.PROJECT_SERVICE_PRINCIPAL_KV_S_NAME_S }}

      # Flow control
      BYO_subnets: ${{ vars.BYO_SUBNETS || 'false' }}
      runNetworkingVar: ${{ vars.RUN_JOB1_NETWORKING || 'true' }}
      disable_whitelisting_for_build_agents: ${{ vars.DISABLE_WHITELISTING_FOR_BUILD_AGENTS || 'false' }}
      disable_whitelisting_for_built_agents: ${{ vars.DISABLE_WHITELISTING_FOR_BUILD_AGENTS || vars.DISABLE_WHITELISTING_FOR_BUILT_AGENTS || 'false' }}

      # Versioning/salt
      AIFACTORY_VERSION_MAJOR: ${{ vars.AIFACTORY_VERSION_MAJOR }}
      AIFACTORY_VERSION_MINOR: ${{ vars.AIFACTORY_VERSION_MINOR }}
      AIFACTORY_SALT: ${{ vars.AIFACTORY_SALT }}
      AIFACTORY_SALT_RANDOM: ${{ vars.AIFACTORY_SALT_RANDOM }}
      deployment_random_value: ''

      # Network env debug mirrors (match ADO debug params)
      network_env_dev: ${{ vars.DEV_NETWORK_ENV || vars.NETWORK_ENV || 'dev' }}
      network_env_stage: ${{ vars.STAGE_NETWORK_ENV || vars.NETWORK_ENV || 'test' }}
      network_env_prod: ${{ vars.PROD_NETWORK_ENV || vars.NETWORK_ENV || 'prod' }}

      # Project types are merged in ADO
      admin_projectType: all

      # Cost optimization
      useCommonACR: ${{ vars.USE_COMMON_ACR_FOR_PROJECTS || 'true' }}
      useCommonACR_override: ${{ vars.USE_COMMON_ACR_OVERRIDE || vars.USE_COMMON_ACR_FOR_PROJECTS || 'true' }}

      # Optional overrides
      azure_machinelearning_sp_oid: ${{ vars.TENANT_AZUREML_OID }}
      admin_aks_gpu_sku_dev_override: ${{ vars.ADMIN_AKS_GPU_SKU_DEV_OVERRIDE || 'Standard_B4ms' }}
      admin_aks_gpu_sku_testProd_override: ${{ vars.ADMIN_AKS_GPU_SKU_TEST_PROD_OVERRIDE || 'Standard_DS13-2_v2' }}
      admin_aks_nodes_dev_override: ${{ vars.ADMIN_AKS_NODES_DEV_OVERRIDE || '1' }}
      admin_aks_nodes_testProd_override: ${{ vars.ADMIN_AKS_NODES_TEST_PROD_OVERRIDE || '3' }}
      admin_aks_version_override: ${{ vars.ADMIN_AKS_VERSION_OVERRIDE || '1.30.3' }}
      admin_aml_cluster_maxNodes_dev_override: ${{ vars.ADMIN_AML_CLUSTER_MAX_NODES_DEV_OVERRIDE || '3' }}
      admin_aml_cluster_maxNodes_testProd_override: ${{ vars.ADMIN_AML_CLUSTER_MAX_NODES_TEST_PROD_OVERRIDE || '5' }}
      admin_aml_cluster_sku_dev_override: ${{ vars.ADMIN_AML_CLUSTER_SKU_DEV_OVERRIDE || 'Standard_DS3_v2' }}
      admin_aml_cluster_sku_testProd_override: ${{ vars.ADMIN_AML_CLUSTER_SKU_TEST_PROD_OVERRIDE || 'Standard_D13_v2' }}
      admin_aml_computeInstance_dev_sku_override: ${{ vars.ADMIN_AML_COMPUTE_INSTANCE_DEV_SKU_OVERRIDE || 'Standard_DS11_v2' }}
      admin_aml_computeInstance_testProd_sku_override: ${{ vars.ADMIN_AML_COMPUTE_INSTANCE_TEST_PROD_SKU_OVERRIDE || 'Standard_ND96amsr_A100_v4' }}
      admin_private_azureMLStudioUI: ${{ vars.AML_STUDIO_UI_PRIVATE || 'true' }}
      admin_private_DatabricksUI: ${{ vars.DATABRICKS_PRIVATE || 'false' }}

      # Naming / network bases
      vnetNameBase: ${{ vars.VNET_NAME_BASE || 'vnt-esmlcmn' }}
      vnetResourceGroupBase: ${{ vars.VNET_RESOURCE_GROUP_BASE || 'esml-common' }}
      common_subnet_name: ${{ vars.COMMON_SUBNET_NAME || 'snet-esml-cmn-001' }}
      centralDnsZoneByPolicyInHub: ${{ vars.CENTRAL_DNS_ZONE_BY_POLICY_IN_HUB || 'false' }}
      privDnsSubscription_param: ${{ vars.PRIV_DNS_SUBSCRIPTION_PARAM || '' }}
      privDnsResourceGroup_param: ${{ vars.PRIV_DNS_RESOURCE_GROUP_PARAM || '' }}
      commonResourceGroup_param: ${{ vars.COMMON_RESOURCE_GROUP_PARAM || '' }}
      datalakeName_param: ${{ vars.DATALAKE_NAME_PARAM || '' }}
      kvNameFromCOMMON_param: ${{ vars.KV_NAME_FROM_COMMON_PARAM || '' }}

      # BYO overrides
      vnetResourceGroup_param: ${{ vars.VNET_RESOURCE_GROUP_PARAM || '' }}
      vnetNameFull_param: ${{ vars.VNET_NAME_FULL_PARAM || '' }}
      subnetCommon: ${{ vars.BYO_SUBNETS == 'true' && (vars.SUBNET_COMMON || '') || '' }}
      subnetCommonScoring: ${{ vars.BYO_SUBNETS == 'true' && (vars.SUBNET_COMMON_SCORING || '') || '' }}
      subnetCommonPowerbiGw: ${{ vars.BYO_SUBNETS == 'true' && (vars.SUBNET_COMMON_POWERBI_GW || '') || '' }}
      subnetProjGenAI: ${{ vars.SUBNET_PROJ_GENAI || '' }}
      subnetProjAKS: ${{ vars.SUBNET_PROJ_AKS || '' }}
      subnetProjAKS2: ${{ vars.SUBNET_PROJ_AKS2 || '' }}
      subnetProjACA: ${{ vars.SUBNET_PROJ_ACA || '' }}
      subnetProjACA2: ${{ vars.SUBNET_PROJ_ACA2 || '' }}
      subnetProjDatabricksPublic: ${{ vars.SUBNET_PROJ_DATABRICKS_PUBLIC || '' }}
      subnetProjDatabricksPrivate: ${{ vars.SUBNET_PROJ_DATABRICKS_PRIVATE || '' }}
      byoASEv3: ${{ vars.BYO_ASEV3 || 'false' }}
      byoAseFullResourceId: ${{ vars.BYO_ASE_FULL_RESOURCE_ID || '' }}
      byoAseAppServicePlanResourceId: ${{ vars.BYO_ASE_APP_SERVICE_PLAN_RESOURCE_ID || '' }}

      # Feature flags / services
      enableAIServices: ${{ vars.ENABLE_AI_SERVICES || 'false' }}
      enableAISearch: ${{ vars.ENABLE_AI_SEARCH || 'true' }}
      addAISearch: ${{ vars.ADD_AI_SEARCH || 'true' }}
      AISEARCH_SEMANTIC_TIER: ${{ vars.AISEARCH_SEMANTIC_TIER || 'free' }}
      enableAISearchSharedPrivateLink: ${{ vars.ENABLE_AI_SEARCH_SHARED_PRIVATE_LINK || 'true' }}
      enableAzureOpenAI: ${{ vars.ENABLE_AZURE_OPENAI || 'false' }}
      enableAzureAIVision: ${{ vars.ENABLE_AZURE_AI_VISION || 'false' }}
      enableAzureSpeech: ${{ vars.ENABLE_AZURE_SPEECH || 'false' }}
      enableAIDocIntelligence: ${{ vars.ENABLE_AI_DOC_INTELLIGENCE || 'false' }}
      enableContentSafety: ${{ vars.ENABLE_CONTENT_SAFETY || 'false' }}
      enableBing: ${{ vars.ENABLE_BING || 'false' }}
      enableBingCustomSearch: ${{ vars.ENABLE_BING_CUSTOM_SEARCH || 'false' }}
      enableAIFoundryHub: ${{ vars.ENABLE_AI_FOUNDRY_HUB || 'false' }}
      addAIFoundryHub: ${{ vars.ADD_AI_FOUNDRY_HUB || 'false' }}
      enableAIFoundry: ${{ vars.ENABLE_AI_FOUNDRY || 'true' }}
      updateAIFoundry: ${{ vars.UPDATE_AI_FOUNDRY || 'false' }}
      addAIFoundry: ${{ vars.ADD_AI_FOUNDRY || 'false' }}
      enableAFoundryCaphost: ${{ vars.ENABLE_FOUNDRY_CAPHOST || 'true' }}
      foundryDeploymentType: ${{ vars.FOUNDRY_DEPLOYMENT_TYPE || '1' }}
      enableAIFactoryCreatedDefaultProjectForAIFv2: ${{ vars.ENABLE_AIFACTORY_CREATED_DEFAULT_PROJECT_FOR_AIFV2 || 'true' }}
      disableAgentNetworkInjection: ${{ vars.DISABLE_AGENT_NETWORK_INJECTION || 'false' }}
      enableDatafactory: ${{ vars.ENABLE_DATAFACTORY || 'false' }}
      enableAzureMachineLearning: ${{ vars.ENABLE_AZURE_MACHINE_LEARNING || 'false' }}
      addAzureMachineLearning: ${{ vars.ADD_AZURE_MACHINE_LEARNING || 'false' }}
      enableDatafactoryCommon: ${{ vars.ENABLE_DATAFACTORY_COMMON || 'false' }}
      enableDatabricks: ${{ vars.ENABLE_DATABRICKS || 'false' }}
      enableAksForAzureML: ${{ vars.ENABLE_AKS_FOR_AZURE_ML || 'true' }}
      aksOutboundType: ${{ vars.AKS_OUTBOUND_TYPE || 'loadBalancer' }}
      aksPrivateDNSZone: ${{ vars.AKS_PRIVATE_DNS_ZONE || 'system' }}
      aksAzureFirewallPrivateIp: ${{ vars.AKS_AZURE_FIREWALL_PRIVATE_IP || '' }}
      enableContainerApps: ${{ vars.ENABLE_CONTAINER_APPS || 'false' }}
      enableAppInsightsDashboard: ${{ vars.ENABLE_APPINSIGHTS_DASHBOARD || 'false' }}
      enableFunction: ${{ vars.ENABLE_FUNCTION || 'false' }}
      functionRuntime: ${{ vars.FUNCTION_RUNTIME || 'dotnet' }}
      functionVersion: ${{ vars.FUNCTION_VERSION || 'v7.0' }}
      enableWebApp: ${{ vars.ENABLE_WEBAPP || 'false' }}
      webAppRuntime: ${{ vars.WEBAPP_RUNTIME || 'python' }}
      webAppRuntimeVersion: ${{ vars.WEBAPP_RUNTIME_VERSION || '3.11' }}
      aseSku: ${{ vars.ASE_SKU || 'IsolatedV2' }}
      aseSkuCode: ${{ vars.ASE_SKU_CODE || 'I1v2' }}
      aseSkuWorkers: ${{ vars.ASE_SKU_WORKERS || '1' }}
      enableLogicApps: ${{ vars.ENABLE_LOGIC_APPS || 'false' }}
      enableEventHubs: ${{ vars.ENABLE_EVENT_HUBS || 'false' }}
      enableBotService: ${{ vars.ENABLE_BOT_SERVICE || 'true' }}
      enableCosmosDB: ${{ vars.ENABLE_COSMOS_DB || 'false' }}
      cosmosKind: ${{ vars.COSMOS_KIND || 'GlobalDocumentDB' }}
      enablePostgreSQL: ${{ vars.ENABLE_POSTGRESQL || 'false' }}
      enableRedisCache: ${{ vars.ENABLE_REDIS_CACHE || 'false' }}
      enableSQLDatabase: ${{ vars.ENABLE_SQL_DATABASE || 'false' }}
      enablePublicGenAIAccess: ${{ vars.ENABLE_PUBLIC_GENAI_ACCESS || 'false' }}
      allowPublicAccessWhenBehindVnet: ${{ vars.ALLOW_PUBLIC_ACCESS_WHEN_BEHIND_VNET || 'false' }}
      enablePublicAccessWithPerimeter: ${{ vars.ENABLE_PUBLIC_ACCESS_WITH_PERIMETER || 'false' }}
      updateKeyvaultRbac: ${{ vars.UPDATE_KEYVAULT_RBAC || 'false' }}
      updateRbac: ${{ vars.UPDATE_RBAC || 'false' }}
      disableContributorAccessForUsers: ${{ vars.DISABLE_CONTRIBUTOR_ACCESS_FOR_USERS || 'false' }}
      disableRBACAdminOnRGForUsers: ${{ vars.DISABLE_RBAC_ADMIN_ON_RG_FOR_USERS || 'false' }}
      BYO_CONTRIBUTOR_ROLE_ID: ${{ vars.BYO_CONTRIBUTOR_ROLE_ID || 'b24988ac-6180-42a0-ab88-20f7382dd24c' }}
      enableDefenderforAISubLevel: ${{ vars.ENABLE_DEFENDER_FOR_AI_SUB_LEVEL || 'false' }}
      enableDefenderforAIResourceLevel: ${{ vars.ENABLE_DEFENDER_FOR_AI_RESOURCE_LEVEL || 'false' }}

      # Complete mode vs Incremental mode
      enableDeleteForDisabledResources: ${{ vars.ENABLE_DELETE_FOR_DISABLED_RESOURCES || 'true' }}
      deleteAllServicesForProject: ${{ vars.DELETE_ALL_SERVICES_FOR_PROJECT || 'true' }}

      # DNS zone existence flags (for parity with ADO debug params)
      zoneAzurecontainerappsExists: ${{ vars.ZONE_AZURECONTAINERAPPS_EXISTS || 'false' }}
      zoneRedisExists: ${{ vars.ZONE_REDIS_EXISTS || 'false' }}
      zonePostgresExists: ${{ vars.ZONE_POSTGRES_EXISTS || 'false' }}
      zoneSqlExists: ${{ vars.ZONE_SQL_EXISTS || 'false' }}
      zoneMongoExists: ${{ vars.ZONE_MONGO_EXISTS || 'false' }}
      zoneServicesAiExists: ${{ vars.ZONE_SERVICES_AI_EXISTS || 'false' }}
      zoneAPIMExists: ${{ vars.ZONE_APIM_EXISTS || 'false' }}

      # Private DNS global link toggle
      privateDnsAndVnetLinkAllGlobalLocation: ${{ vars.PRIVATE_DNS_AND_VNET_LINK_ALL_GLOBAL_LOCATION || 'false' }}

      # Model deployment defaults
      deployModel_gpt_X: ${{ vars.DEPLOY_MODEL_GPT_X || 'false' }}
      modelGPTXName: ${{ vars.MODEL_GPTX_NAME || 'gpt-5-mini' }}
      modelGPTXVersion: ${{ vars.MODEL_GPTX_VERSION || '' }}
      modelGPTXSku: ${{ vars.MODEL_GPTX_SKU || 'DataZoneStandard' }}
      modelGPTXCapacity: ${{ vars.MODEL_GPTX_CAPACITY || '30' }}
      deployModel_text_embedding_ada_002: ${{ vars.DEPLOY_MODEL_TEXT_EMBEDDING_ADA_002 || 'false' }}
      deployModel_text_embedding_3_large: ${{ vars.DEPLOY_MODEL_TEXT_EMBEDDING_3_LARGE || 'true' }}
      deployModel_text_embedding_3_small: ${{ vars.DEPLOY_MODEL_TEXT_EMBEDDING_3_SMALL || 'false' }}
      default_embedding_capacity: ${{ vars.DEFAULT_EMBEDDING_CAPACITY || '25' }}
      deployModel_gpt_4o: ${{ vars.DEPLOY_MODEL_GPT_4O || 'true' }}
      deployModel_gpt_4: ${{ vars.DEPLOY_MODEL_GPT_4 || 'false' }}
      default_gpt_4o_version: ${{ vars.DEFAULT_GPT_4O_VERSION || '2024-11-20' }}
      deployModel_gpt_4o_mini: ${{ vars.DEPLOY_MODEL_GPT_4O_MINI || 'false' }}
      default_gpt_4o_mini_version: ${{ vars.DEFAULT_GPT_4O_MINI_VERSION || '2024-07-18' }}
      default_gpt_capacity: ${{ vars.DEFAULT_GPT_CAPACITY || '40' }}
      default_model_sku: ${{ vars.DEFAULT_MODEL_SKU || 'Standard' }}

      # Diagnostics / tags
      diagnosticSettingLevel: ${{ vars.DIAGNOSTIC_SETTING_LEVEL || 'gold' }}
      tags: ${{ vars.TAGS || '{}' }}
      tagsProject: ${{ vars.TAGS_PROJECT || '{}' }}

      # CMK
      cmk: ${{ vars.CMK || 'false' }}
      cmkKeyName: ${{ vars.CMK_KEY_NAME || 'aifactory-cmk-key' }}
      cmkKeyVersion: ${{ vars.CMK_KEY_VERSION || '' }}

      # ACR / compute options
      acr_adminUserEnabled: ${{ vars.ACR_ADMIN_USER_ENABLED || 'false' }}
      acr_dedicated: ${{ vars.ACR_DEDICATED || 'false' }}
      acr_SKU: ${{ vars.ACR_SKU || 'Premium' }}
      enableProjectVM: ${{ vars.ENABLE_PROJECT_VM || 'false' }}
      aca_a_registry_image: ${{ vars.ACA_W_REGISTRY_IMAGE || 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest' }}
      aca_w_registry_image: ${{ vars.ACA_W_REGISTRY_IMAGE || 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest' }}

      # Foundry / APIM
      foundryApiManagementResourceId: ${{ vars.FOUNDRY_API_MANAGEMENT_RESOURCE_ID || '' }}

      # Existence flags defaults (set by validations)
      aiHubExists: 'false'
      aifProjectExists: 'false'
      aiFoundryV2Exists: 'false'
      aiFoundryV2ProjectExists: 'false'
      dataFactoryExists: 'false'
      botServiceExists: 'false'
      aksExists: 'false'
      amlExists: 'false'
      openaiExists: 'false'
      aiSearchExists: 'false'
      aiServicesExists: 'false'
      containerAppsEnvExists: 'false'
      containerAppAExists: 'false'
      containerAppWExists: 'false'
      keyvaultExists: 'false'
      miACAExists: 'false'
      miPrjExists: 'false'
      storageAccount1001Exists: 'false'
      storageAccount2001Exists: 'false'
      cosmosDBExists: 'false'
      redisExists: 'false'
      postgreSQLExists: 'false'
      sqlServerExists: 'false'
      logicAppsExists: 'false'
      eventHubsExists: 'false'
      functionAppExists: 'false'
      webAppExists: 'false'
      funcAppServicePlanExists: 'false'
      webAppServicePlanExists: 'false'
      applicationInsightExists: 'false'
      acrProjectExists: 'false'
      databricksExists: 'false'
      skipACRAssignments: 'false'
      sntGenaiExists: 'false'
      sntAcaExists: 'false'
      sntAca002Exists: 'false'
      sntAksExists: 'false'
      sntAks002Exists: 'false'
      sntDatabricksPrivExists: 'false'
      sntDatabricksPubExists: 'false'
      LAKE_PREFIX: ${{ vars.LAKE_PREFIX || 'lake' }}

      projectPrefix: ${{ vars.PROJECT_PREFIX || 'esml-' }}
      projectSuffix: ${{ vars.PROJECT_SUFFIX || '-rg' }}

    steps:
      - name: 00_Azure_Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 00_Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: 00_Validate_Required_Configuration
        run: |
          $required = @(
            'dev_test_prod',
            'dev_test_prod_sub_id',
            'admin_location',
            'admin_locationSuffix',
            'admin_aifactoryPrefixRG',
            'admin_aifactorySuffixRG',
            'admin_bicep_input_keyvault_subscription',
            'admin_bicep_kv_fw',
            'admin_bicep_kv_fw_rg',
            'tenantId',
            'project_number_000',
            'project_service_principal_AppID_seeding_kv_name',
            'project_service_principal_OID_seeding_kv_name',
            'project_service_principal_Secret_seeding_kv_name',
            'AIFACTORY_SALT',
            'AIFACTORY_SALT_RANDOM'
          )
          $placeholders = @('<todo>', '<todo_id>', 'TODO', 'todo', '-')
          $errors = @()
          foreach ($key in $required) {
            $val = (Get-Item "Env:$key" -ErrorAction SilentlyContinue).Value
            if (-not $val) { $errors += "$key is required"; continue }
            if ($placeholders -contains $val) { $errors += "$key still has placeholder value '$val'" }
          }
          if ($Env:BYO_subnets -eq 'true') {
            foreach ($k in @('vnetResourceGroup_param', 'vnetNameFull_param')) {
              $v = (Get-Item "Env:$k" -ErrorAction SilentlyContinue).Value
              if (-not $v) { $errors += "$k is required when BYO_subnets=true" }
            }
          }
          if (-not $Env:project_IP_whitelist -or $Env:project_IP_whitelist -eq '<todo_ip>') {
            Write-Warning 'PROJECT_MEMBERS_IP_ADDRESS is empty; deployments relying on IP allow lists may fail.'
          }
          if ($errors) { $errors | ForEach-Object { Write-Error $_ }; exit 1 }

      - name: 00_Initialize_Derived_Variables
        run: |
          $net = '${{ env.network_env }}'
          if (-not $net) { $net = '${{ env.dev_test_prod }}' }
          "network_env=$net" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          if (-not $Env:deployment_random_value -or $Env:deployment_random_value -eq '') {
            $rand = [System.Guid]::NewGuid().ToString('N').Substring(0,10)
            "deployment_random_value=$rand" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          }
          if (-not $Env:privDnsSubscription_param -or $Env:privDnsSubscription_param -eq '') {
            "privDnsSubscription_param=${{ env.dev_test_prod_sub_id }}" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          }
          
          # Normalize IP whitelist: convert "-" placeholder to empty string
          $ipWhitelist = '${{ env.project_IP_whitelist }}'
          if ($ipWhitelist -eq '-' -or $ipWhitelist -eq '<todo_ip>') {
            Write-Host "Converting project_IP_whitelist from '$ipWhitelist' to empty string"
            "project_IP_whitelist=" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "project_IP_whitelist value: '$ipWhitelist'"
          }
          
          $tagsValue = '${{ env.tags }}'
          $tagsProjectValue = '${{ env.tagsProject }}'
          if (-not $Env:tags) { "tags=$tagsValue" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append }
          if (-not $Env:tagsProject) { "tagsProject=$tagsProjectValue" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append }
          if (-not $Env:aifactory_salt_random -or $Env:aifactory_salt_random -eq '') { "aifactory_salt_random=${{ env.AIFACTORY_SALT_RANDOM }}" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append }

      - name: 00_Resolve_Network_Env_Placeholders
        shell: bash
        run: |
          set -e
          NETWORK_ENV="${{ env.network_env }}"
          VNET_RG="${{ env.vnetResourceGroup_param }}"
          VNET_NAME="${{ env.vnetNameFull_param }}"

          echo "Original vnetResourceGroup_param: $VNET_RG"
          echo "Original vnetNameFull_param: $VNET_NAME"
          echo "network_env value: $NETWORK_ENV"

          # If empty, construct default values
          if [ -z "$VNET_RG" ]; then
            VNET_RG="${{ env.admin_aifactoryPrefixRG }}${{ env.vnetResourceGroupBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}"
            echo "vnetResourceGroup_param was empty, using default: $VNET_RG"
          fi

          if [ -z "$VNET_NAME" ]; then
            VNET_NAME="${{ env.vnetNameBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_commonResourceSuffix }}"
            echo "vnetNameFull_param was empty, using default: $VNET_NAME"
          fi

          # Replace <network_env> placeholder if present
          if [[ "$VNET_RG" == *"<network_env>"* ]]; then
            echo "Found <network_env> placeholder in vnetResourceGroup_param"
            VNET_RG="${VNET_RG//<network_env>/$NETWORK_ENV}"
          fi

          if [[ "$VNET_NAME" == *"<network_env>"* ]]; then
            echo "Found <network_env> placeholder in vnetNameFull_param"
            VNET_NAME="${VNET_NAME//<network_env>/$NETWORK_ENV}"
          fi

          echo "vnetResourceGroup_resolved=$VNET_RG" >> $GITHUB_ENV
          echo "vnetNameFull_resolved=$VNET_NAME" >> $GITHUB_ENV
          echo "Resolved vnetResourceGroup: $VNET_RG"
          echo "Resolved vnetNameFull: $VNET_NAME"

      - name: 00_Print_Info
        run: |
          echo "env.dev_test_prod=${{ env.dev_test_prod }}"
          echo "env.project_number_000=${{ env.project_number_000 }}"
          echo "env.runNetworkingVar=${{ env.runNetworkingVar }}"
          echo "env.BYO_subnets=${{ env.BYO_subnets }}"
          echo "env.admin_projectType=${{ env.admin_projectType }}"
          echo "env.useCommonACR=${{ env.useCommonACR }}"
          echo "env.network_env=${{ env.network_env }}"

      - name: 00_Validate_Project_Subnet_Exists_(Networking-START)
        if: env.runNetworkingVar != 'false' && env.BYO_subnets != 'true'
        shell: bash
        run: |
          set -e
          az account set --subscription "${{ env.dev_test_prod_sub_id }}"
          PROJECT_SUBNET_NAME="snt-prj${{ env.project_number_000 }}-aks"
          VNET_NAME="${{ env.vnetNameFull_resolved }}"
          VNET_RG="${{ env.vnetResourceGroup_resolved }}"
          if [ -z "$VNET_NAME" ]; then VNET_NAME="${{ env.vnetNameBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_commonResourceSuffix }}"; fi
          if [ -z "$VNET_RG" ]; then VNET_RG="${{ env.admin_aifactoryPrefixRG }}${{ env.vnetResourceGroupBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}"; fi
          echo "Using VNET $VNET_NAME in RG $VNET_RG"
          if ! az network vnet show --name "$VNET_NAME" --resource-group "$VNET_RG" >/dev/null 2>&1; then
            echo "VNET $VNET_NAME not found in $VNET_RG"; exit 1; fi
          if az network vnet subnet show --name "$PROJECT_SUBNET_NAME" --vnet-name "$VNET_NAME" --resource-group "$VNET_RG" >/dev/null 2>&1; then
            echo "Subnet already exists; networking can be skipped if desired."; exit 0; fi
          echo "Subnet missing, networking will deploy create-if-not-exists."

      - name: 01_Get_Runner_Public_IP
        if: env.disable_whitelisting_for_build_agents != 'true'
        run: |
          $resp = Invoke-RestMethod http://ipinfo.io/json | Select -exp ip
          "runner_ip=$resp" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          echo "runner_ip=$resp"

      - name: 02_Allow_Runner_IP_on_Seeding_KeyVault
        if: env.disable_whitelisting_for_build_agents != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.admin_bicep_input_keyvault_subscription }}"
            az keyvault update \
              --name "${{ env.admin_bicep_kv_fw }}" \
              --resource-group "${{ env.admin_bicep_kv_fw_rg }}" \
              --default-action Deny \
              --public-network-access Enabled
            echo "Waiting for Key Vault network rules to propagate..."
            sleep 15
            az keyvault network-rule add \
              --resource-group "${{ env.admin_bicep_kv_fw_rg }}" \
              --name "${{ env.admin_bicep_kv_fw }}" \
              --ip-address "${{ env.runner_ip }}"

      - name: 03_Download_Secrets_From_Seeding_KeyVault
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.admin_bicep_input_keyvault_subscription }}"
            
            echo "=== Attempting to retrieve secrets from Key Vault ==="
            echo "Key Vault: ${{ env.admin_bicep_kv_fw }}"
            echo "Subscription: ${{ env.admin_bicep_input_keyvault_subscription }}"
            echo "Secret 1: ${{ env.common_sp_appid_seeding_kv_name }}"
            echo "Secret 2: ${{ env.common_sp_secret_seeding_kv_name }}"
            echo "Secret 3: ${{ env.project_service_principal_OID_seeding_kv_name }}"
            
            # Test Key Vault access
            echo "Testing Key Vault access..."
            az keyvault secret list --vault-name "${{ env.admin_bicep_kv_fw }}" --query '[].name' -o tsv || echo "Failed to list secrets"
            
            # Retrieve secrets with error handling
            echo "Retrieving common_sp_appid..."
            APPID=$(az keyvault secret show --vault-name "${{ env.admin_bicep_kv_fw }}" --name "${{ env.common_sp_appid_seeding_kv_name }}" --query 'value' --output tsv 2>&1)
            if [ $? -eq 0 ]; then
              echo "✓ Retrieved common_sp_appid (length: ${#APPID})"
              echo "common_sp_appid_value=$APPID" >> $GITHUB_ENV
            else
              echo "✗ Failed to retrieve common_sp_appid: $APPID"
              echo "common_sp_appid_value=" >> $GITHUB_ENV
            fi
            
            echo "Retrieving common_sp_secret..."
            SECRET=$(az keyvault secret show --vault-name "${{ env.admin_bicep_kv_fw }}" --name "${{ env.common_sp_secret_seeding_kv_name }}" --query 'value' --output tsv 2>&1)
            if [ $? -eq 0 ]; then
              echo "✓ Retrieved common_sp_secret (length: ${#SECRET})"
              echo "common_sp_secret_value=$SECRET" >> $GITHUB_ENV
            else
              echo "✗ Failed to retrieve common_sp_secret: $SECRET"
              echo "common_sp_secret_value=" >> $GITHUB_ENV
            fi
            
            echo "Retrieving project_sp_oid..."
            OID=$(az keyvault secret show --vault-name "${{ env.admin_bicep_kv_fw }}" --name "${{ env.project_service_principal_OID_seeding_kv_name }}" --query 'value' --output tsv 2>&1)
            if [ $? -eq 0 ]; then
              echo "✓ Retrieved project_sp_oid (length: ${#OID})"
              echo "project_sp_oid_value=$OID" >> $GITHUB_ENV
            else
              echo "✗ Failed to retrieve project_sp_oid: $OID"
              echo "project_sp_oid_value=" >> $GITHUB_ENV
            fi

      - name: 03b_Validate_Service_Principal_Credentials
        run: |
          Write-Host "=== Validating Service Principal Credentials ==="
          Write-Host "Key Vault: ${{ env.admin_bicep_kv_fw }}"
          Write-Host "Expected secret names:"
          Write-Host "  - common_sp_appid: ${{ env.common_sp_appid_seeding_kv_name }}"
          Write-Host "  - common_sp_secret: ${{ env.common_sp_secret_seeding_kv_name }}"
          Write-Host "  - project_sp_oid: ${{ env.project_service_principal_OID_seeding_kv_name }}"
          
          $hasError = $false
          
          $appId = $Env:common_sp_appid_value
          if ([string]::IsNullOrWhiteSpace($appId)) {
            Write-Error "common_sp_appid_value is empty! Secret '${{ env.common_sp_appid_seeding_kv_name }}' not found in Key Vault."
            $hasError = $true
          } else {
            Write-Host "✓ common_sp_appid retrieved (length: $($appId.Length))"
          }
          
          $spSecret = $Env:common_sp_secret_value
          if ([string]::IsNullOrWhiteSpace($spSecret)) {
            Write-Error "common_sp_secret_value is empty! Secret '${{ env.common_sp_secret_seeding_kv_name }}' not found in Key Vault."
            $hasError = $true
          } else {
            Write-Host "✓ common_sp_secret retrieved (length: $($spSecret.Length))"
          }
          
          $spOid = $Env:project_sp_oid_value
          if ([string]::IsNullOrWhiteSpace($spOid)) {
            Write-Error "project_sp_oid_value is empty! Secret '${{ env.project_service_principal_OID_seeding_kv_name }}' not found in Key Vault."
            $hasError = $true
          } else {
            Write-Host "✓ project_sp_oid retrieved (length: $($spOid.Length))"
          }
          
          if ($hasError) {
            Write-Host ""
            Write-Host "TROUBLESHOOTING:"
            Write-Host "1. Verify the secrets exist in Key Vault '${{ env.admin_bicep_kv_fw }}'"
            Write-Host "2. Check the secret names match exactly (case-sensitive)"
            Write-Host "3. Ensure the GitHub Actions identity has 'Get' permission on secrets"
            Write-Host "4. Run: az keyvault secret list --vault-name ${{ env.admin_bicep_kv_fw }} --query '[].name'"
            exit 1
          }

      - name: 04_Create_Temporary_JSON_Parameter_Files
        if: env.runNetworkingVar != 'false' && env.BYO_subnets != 'true'
        run: |
          $paramDir = Join-Path $Env:GITHUB_WORKSPACE 'aifactory/parameters'
          New-Item -ItemType Directory -Force -Path $paramDir | Out-Null

          $globals1 = @{
            '$schema' = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
            contentVersion = '1.0.0.0'
            parameters = @{
              aifactorySuffixRG    = @{ value = '${{ env.admin_aifactorySuffixRG }}' }
              commonRGNamePrefix   = @{ value = '${{ env.admin_aifactoryPrefixRG }}' }
              locationSuffix       = @{ value = '${{ env.admin_locationSuffix }}' }
              location             = @{ value = '${{ env.admin_location }}' }
            }
          }
          $globals1 | ConvertTo-Json -Depth 5 | Out-File (Join-Path $paramDir '10-esml-globals-1.json') -Encoding utf8

          $globals2 = @{
            '$schema' = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
            contentVersion = '1.0.0.0'
            parameters = @{
              commonResourceSuffix = @{ value = '${{ env.admin_commonResourceSuffix }}' }
              vnetNameBase         = @{ value = '${{ env.vnetNameBase }}' }
            }
          }
          $globals2 | ConvertTo-Json -Depth 5 | Out-File (Join-Path $paramDir '10-esml-globals-2-12_13_21_22.json') -Encoding utf8

          $globals4 = @{
            '$schema' = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
            contentVersion = '1.0.0.0'
            parameters = @{
              resourceSuffix = @{ value = '${{ env.admin_prjResourceSuffix }}' }
              tenantId       = @{ value = '${{ env.tenantId }}' }
            }
          }
          $globals4 | ConvertTo-Json -Depth 5 | Out-File (Join-Path $paramDir '10-esml-globals-4-13_21_22.json') -Encoding utf8

          $projectParams = @{
            '$schema' = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
            contentVersion = '1.0.0.0'
            parameters = @{
              vnetResourceGroupBase = @{ value = '${{ env.vnetResourceGroupBase }}' }
            }
          }
          $projectParams | ConvertTo-Json -Depth 5 | Out-File (Join-Path $paramDir '21-22-esml-prj-parameters.json') -Encoding utf8

          $override = @{
            '$schema' = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
            contentVersion = '1.0.0.0'
            parameters = @{
              vnetResourceGroup_param = @{ value = '${{ env.vnetResourceGroup_resolved }}' }
              vnetNameFull_param      = @{ value = '${{ env.vnetNameFull_resolved }}' }
            }
          }
          $override | ConvertTo-Json -Depth 5 | Out-File (Join-Path $paramDir '10-esml-globals-override.json') -Encoding utf8

      - name: 05_Calculate_Subnet_Allocations
        if: env.runNetworkingVar != 'false' && env.BYO_subnets != 'true'
        working-directory: ${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts
        run: |
          sudo pwsh -Command '
          Write-Host "=== Subnet Calculation Starting ==="
          Write-Host "Parameters:"
          Write-Host "  Environment: ${{ env.dev_test_prod }}"
          Write-Host "  Subscription: ${{ env.dev_test_prod_sub_id }}"
          Write-Host "  VNet Name: ${{ env.vnetNameFull_resolved }}"
          Write-Host "  VNet RG: ${{ env.vnetResourceGroup_resolved }}"
          Write-Host "  Project Type: ${{ env.admin_projectType }}"
          
          & "./subnetCalc_v2.ps1" `
            -bicepPar1 "../../../../../aifactory/parameters/10-esml-globals-1.json" `
            -bicepPar2 "../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json" `
            -bicepPar3 "../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json" `
            -bicepPar4 "../../../../../aifactory/parameters/21-22-esml-prj-parameters.json" `
            -bicepPar5 "../../../../../aifactory/parameters/10-esml-globals-override.json" `
            -filePath "../../../../../aifactory/parameters/" `
            -spObjId "${{ env.common_sp_appid_value }}" `
            -spSecret "${{ env.common_sp_secret_value }}" `
            -env "${{ env.dev_test_prod }}" `
            -subscriptionId "${{ env.dev_test_prod_sub_id }}" `
            -prjResourceSuffix "${{ env.admin_prjResourceSuffix }}" `
            -aifactorySuffixRGADO "${{ env.admin_aifactorySuffixRG }}" `
            -commonRGNamePrefixVar "${{ env.admin_aifactoryPrefixRG }}" `
            -commonResourceSuffixADO "${{ env.admin_commonResourceSuffix }}" `
            -locationADO "${{ env.admin_location }}" `
            -locationSuffixADO "${{ env.admin_locationSuffix }}" `
            -projectTypeADO "${{ env.admin_projectType }}" `
            -vnetResourceGroupBase "${{ env.vnetResourceGroupBase }}" `
            -vnetNameBase "${{ env.vnetNameBase }}" `
            -tenantId "${{ env.tenantId }}" `
            -vnetResourceGroup_param "${{ env.vnetResourceGroup_resolved }}" `
            -vnetNameFull_param "${{ env.vnetNameFull_resolved }}" `
            -useServicePrincipal
          
          Write-Host ""
          Write-Host "=== Listing generated parameter files ==="
          Get-ChildItem "../../../../../aifactory/parameters/" | Format-Table Name, Length
          
          Write-Host ""
          Write-Host "=== Content of subnetParameters.json ==="
          if (Test-Path "../../../../../aifactory/parameters/subnetParameters.json") {
            Get-Content "../../../../../aifactory/parameters/subnetParameters.json" | Write-Host
          } else {
            Write-Error "subnetParameters.json was not created!"
            exit 1
          }
          '

      - name: 06_Check_Subnet_Existence
        if: env.runNetworkingVar != 'false' && env.BYO_subnets != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            set -e
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"

            projectNumber="${{ env.project_number_000 }}"
            vnetName="${{ env.vnetNameFull_resolved }}"
            vnetRg="${{ env.vnetResourceGroup_resolved }}"

            if [ -z "$vnetName" ]; then
              vnetName="${{ env.vnetNameBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_commonResourceSuffix }}"
            fi

            if [ -z "$vnetRg" ]; then
              vnetRg="${{ env.admin_aifactoryPrefixRG }}${{ env.vnetResourceGroupBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}"
            fi

            check_subnet_exists() {
              local subnet_name="$1"
              local var_name="$2"

              if az network vnet subnet show --name "$subnet_name" --vnet-name "$vnetName" --resource-group "$vnetRg" >/dev/null 2>&1; then
                echo "${var_name}=true" >> $GITHUB_ENV
              else
                echo "${var_name}=false" >> $GITHUB_ENV
              fi
            }

            check_subnet_exists "snt-prj${projectNumber}-genai" "sntGenaiExists"
            check_subnet_exists "snt-prj${projectNumber}-aca" "sntAcaExists"
            check_subnet_exists "snt-prj${projectNumber}-aca-002" "sntAca002Exists"
            check_subnet_exists "snt-prj${projectNumber}-aks" "sntAksExists"
            check_subnet_exists "snt-prj${projectNumber}-aks-002" "sntAks002Exists"
            check_subnet_exists "snt-prj${projectNumber}-dbxpriv" "sntDatabricksPrivExists"
            check_subnet_exists "snt-prj${projectNumber}-dbxpub" "sntDatabricksPubExists"

      - name: 07_Deploy_Subnet_IfNotExists
        if: env.runNetworkingVar != 'false' && env.BYO_subnets != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            
            echo "=== Verifying parameter files exist ==="
            ls -la "${{ github.workspace }}/aifactory/parameters/"
            echo "=== Content of subnetParameters.json ==="
            cat "${{ github.workspace }}/aifactory/parameters/subnetParameters.json"
            
            az deployment group create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}${{ env.admin_aifactorySuffixRG }}SubnetDeplProj" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --resource-group "${{ env.admin_aifactoryPrefixRG }}${{ env.vnetResourceGroupBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}" \
              --template-file "${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/31-network.bicep" \
              --parameters @"${{ github.workspace }}/aifactory/parameters/subnetParameters.json" \
              --parameters @"${{ github.workspace }}/aifactory/parameters/10-esml-globals-1.json" \
              --parameters @"${{ github.workspace }}/aifactory/parameters/10-esml-globals-override.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters vnetResourceGroup="${{ env.admin_aifactoryPrefixRG }}${{ env.vnetResourceGroupBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters datalakeName_param="${{ env.datalakeName_param }}" \
              --parameters kvNameFromCOMMON_param="${{ env.kvNameFromCOMMON_param }}" \
              --parameters useCommonACR="${{ env.useCommonACR_override }}" \
              --parameters byoASEv3="${{ env.byoASEv3 }}" \
              --parameters byoAseFullResourceId="${{ env.byoAseFullResourceId }}" \
              --parameters byoAseAppServicePlanResourceId="${{ env.byoAseAppServicePlanResourceId }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters sntGenaiExists="${{ env.sntGenaiExists }}" \
              --parameters sntAcaExists="${{ env.sntAcaExists }}" \
              --parameters sntAca002Exists="${{ env.sntAca002Exists }}" \
              --parameters sntAksExists="${{ env.sntAksExists }}" \
              --parameters sntAks002Exists="${{ env.sntAks002Exists }}" \
              --parameters sntDatabricksPrivExists="${{ env.sntDatabricksPrivExists }}" \
              --parameters sntDatabricksPubExists="${{ env.sntDatabricksPubExists }}" \
              --parameters aksOutboundType="${{ env.aksOutboundType }}" \
              --parameters azureFirewallPrivateIp="${{ env.aksAzureFirewallPrivateIp }}" \
              --debug

      - name: 08_Remove_IP_From_Seeding_Keyvault_(Networking-END)
        if: always() && env.disable_whitelisting_for_build_agents != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.admin_bicep_input_keyvault_subscription }}"
            az keyvault network-rule remove \
              --resource-group "${{ env.admin_bicep_kv_fw_rg }}" \
              --name "${{ env.admin_bicep_kv_fw }}" \
              --ip-address "${{ env.runner_ip }}" || true

      - name: 09_Check_For_Submodule
        run: |
          Write-Host "Checking git submodule status..."
          git submodule status

      - name: 10_Check_Subnet_Existence
        if: env.runNetworkingVar != 'false' && env.BYO_subnets != 'true'
        run: |
          Write-Host "Subnet existence flags:"
          Write-Host "  sntGenaiExists=${{ env.sntGenaiExists }}"
          Write-Host "  sntAcaExists=${{ env.sntAcaExists }}"
          Write-Host "  sntAca002Exists=${{ env.sntAca002Exists }}"
          Write-Host "  sntAksExists=${{ env.sntAksExists }}"
          Write-Host "  sntAks002Exists=${{ env.sntAks002Exists }}"
          Write-Host "  sntDatabricksPrivExists=${{ env.sntDatabricksPrivExists }}"
          Write-Host "  sntDatabricksPubExists=${{ env.sntDatabricksPubExists }}"

      - name: 11_Generate_Random_Value
        run: |
          $randomValue = [System.Guid]::NewGuid().ToString('N').Substring(0,10)
          "deployment_random_value=$randomValue" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Generated deployment_random_value=$randomValue"

      - name: 12_Allow_Runner_IP_on_Seeding_KeyVault
        if: env.disable_whitelisting_for_build_agents != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.admin_bicep_input_keyvault_subscription }}"
            az keyvault update \
              --name "${{ env.admin_bicep_kv_fw }}" \
              --resource-group "${{ env.admin_bicep_kv_fw_rg }}" \
              --default-action Deny \
              --public-network-access Enabled
            echo "Waiting for Key Vault network rules to propagate..."
            sleep 10
            az keyvault network-rule add \
              --resource-group "${{ env.admin_bicep_kv_fw_rg }}" \
              --name "${{ env.admin_bicep_kv_fw }}" \
              --ip-address "${{ env.runner_ip }}"

      - name: 14_Generate_Dynamic_Network_Parameters
        working-directory: ${{ github.workspace }}/azure-enterprise-scale-ml/environment_setup/aifactory/bicep/scripts
        run: |
          sudo pwsh -Command '
          & "./genDynamicNetworkParamFile.ps1" `
            -spObjId "${{ env.common_sp_appid_value }}" `
            -spSecret "${{ env.common_sp_secret_value }}" `
            -BYO_subnets "${{ env.BYO_subnets }}" `
            -network_env "${{ env.network_env }}" `
            -useServicePrincipal `
            -bicepPar1 "../../../../../aifactory/parameters/10-esml-globals-1.json" `
            -bicepPar2 "../../../../../aifactory/parameters/10-esml-globals-2-12_13_21_22.json" `
            -bicepPar3 "../../../../../aifactory/parameters/10-esml-globals-4-13_21_22.json" `
            -bicepPar4 "../../../../../aifactory/parameters/21-22-esml-prj-parameters.json" `
            -bicepPar5 "../../../../../aifactory/parameters/10-esml-globals-override.json" `
            -filePath "../../../../../aifactory/parameters/" `
            -env "${{ env.dev_test_prod }}" `
            -locationSuffixADO "${{ env.admin_locationSuffix }}" `
            -aifactorySuffixRGADO "${{ env.admin_aifactorySuffixRG }}" `
            -projectNumber "${{ env.project_number_000 }}" `
            -subscriptionId "${{ env.dev_test_prod_sub_id }}" `
            -commonRGNamePrefixVar "${{ env.admin_aifactoryPrefixRG }}" `
            -projectTypeADO "${{ env.admin_projectType }}"
          '

      - name: 15_Check_Private_DNS_Zones
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            set -e
            privDnsSubscription="${{ env.privDnsSubscription_param || env.dev_test_prod_sub_id }}"
            privDnsRg="${{ env.privDnsResourceGroup_param }}"
            if [ -z "$privDnsRg" ]; then
              privDnsRg="${{ env.admin_aifactoryPrefixRG }}${{ env.vnetResourceGroupBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}"
            fi
            az account set --subscription "$privDnsSubscription"
            declare -A zones=(
              [zoneazurecontainerapps]="privatelink.${{ env.admin_location }}.azurecontainerapps.io"
              [zoneredis]="privatelink.redis.cache.windows.net"
              [zonepostgres]="privatelink.postgres.database.azure.com"
              [zonesql]="privatelink.database.windows.net"
              [zoneMongo]="privatelink.mongo.cosmos.azure.com"
              [zoneServicesAi]="privatelink.services.ai.azure.com"
              [zoneAPIM]="privatelink.azure-api.net"
            )
            for key in "${!zones[@]}"; do
              dnsZoneName="${zones[$key]}"
              exists=$(az network private-dns zone show --subscription "$privDnsSubscription" --resource-group "$privDnsRg" --name "$dnsZoneName" >/dev/null 2>&1 && echo true || echo false)
              echo "${key}Exists=$exists" >> $GITHUB_ENV
            done

      - name: 16_Check_Resource_Existence
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            set -e
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}"
            projectNumber="${{ env.project_number_000 }}"
            projectName="prj${projectNumber}"
            locationSuffix="${{ env.admin_locationSuffix }}"
            envName="${{ env.dev_test_prod }}"
            aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}"
            projectPrefix="${{ env.projectPrefix }}"
            projectSuffix="${{ env.projectSuffix }}"
            projectNameReplaced="${projectName/prj/project}"
            targetRG="${commonRGNamePrefix}${projectPrefix}${projectNameReplaced}-${locationSuffix}-${envName}${aifactorySuffixRG}${projectSuffix}"
            echo "targetRG=$targetRG"
            if ! az group show --name "$targetRG" >/dev/null 2>&1; then
              exit 0
            fi
            resource_exists_fuzzy(){
              local rg=$1; local type=$2; local prefix=$3; local suffix=$4
              local output
              output=$(az resource list --resource-group "$rg" --resource-type "$type" --query "[?starts_with(name, '$prefix') && ends_with(name, '$suffix') ].name" -o tsv 2>/dev/null)
              if [ -n "$output" ]; then echo true; else echo false; fi
            }
            resource_exists_identity(){
              local rg=$1; local prefix=$2
              local output
              output=$(az resource list --resource-group "$rg" --resource-type "Microsoft.ManagedIdentity/userAssignedIdentities" --query "[?starts_with(name, '$prefix')].name" -o tsv 2>/dev/null)
              if [ -n "$output" ]; then echo true; else echo false; fi
            }
            suffixStandard="${{ env.admin_prjResourceSuffix }}"
            suffixStandardNoDash="${suffixStandard#-}"
            suffixAppServicePlan="${suffixStandard}-plan"
            twoNumbers="${suffixStandard: -2}"
            aiHubName="aif-hub-${projectNumber}-${locationSuffix}-${envName}"
            aifProjectName="aif-p-${projectNumber}-1-${locationSuffix}-${envName}"
            aiFoundryV2Name="aif2"
            aiFoundryV2ProjectName="aif2-p${projectNumber}"
            botServiceName="bot-${projectNumber}-${locationSuffix}-${envName}"
            dataFactoryName="adf-${projectNumber}-${locationSuffix}-${envName}"
            aksName="aks${projectNumber}-${locationSuffix}-${envName}"
            amlName="aml-${projectNumber}-${locationSuffix}-${envName}"
            openaiName="aoai-${projectName}-${locationSuffix}-${envName}"
            safeNameAISearch="aisearch${projectName}${locationSuffix}${envName}"
            aiServicesPrefix="aiservices${projectName}${locationSuffix}${envName}"
            containerAppsEnvName="aca-env-${projectName}-${locationSuffix}-${envName}"
            containerAppAName="aca-a-${projectName}${locationSuffix}${envName}"
            containerAppWName="aca-w-${projectName}${locationSuffix}${envName}"
            keyvaultName="kv-p${projectNumber}-${locationSuffix}-${envName}"
            miACAPrefix="mi-aca-${projectName}-${locationSuffix}-${envName}"
            miPrjPrefix="mi-${projectName}-${locationSuffix}-${envName}"
            storageAccount1001Name="sa${projectName}${locationSuffix}"
            storageAccount2001Name="sa${projectName}${locationSuffix}"
            databricksName="dbw-${projectName}-${locationSuffix}-${envName}"
            redisName="redis${projectName}${locationSuffix}${envName}"
            cosmosDbAccountName="cosmos-${projectName}-${locationSuffix}-${envName}"
            logicAppName="la-${projectName}-${locationSuffix}-${envName}"
            eventHubNsName="evhns-${projectName}-${locationSuffix}-${envName}"
            funcAppName="func-${projectName}-${locationSuffix}-${envName}"
            webAppResourceName="app-${projectName}-${locationSuffix}-${envName}"
            pgServerName="pg-${projectName}-${locationSuffix}-${envName}"
            bingAccountName="bing-${projectName}-${locationSuffix}-${envName}"
            bingCustomName="bingcustom-${projectName}-${locationSuffix}-${envName}"
            set_env() {
              local key="$1" val="$2"
              echo "${key}=${val}" >> $GITHUB_ENV
              echo "Checking variable: ${key}, Value: ${val}"
            }
            set_env "aiHubExists"            "$(resource_exists_fuzzy "$targetRG" "Microsoft.MachineLearningServices/workspaces" "$aiHubName" "$suffixStandard")"
            set_env "aifProjectExists"       "$(resource_exists_fuzzy "$targetRG" "Microsoft.MachineLearningServices/workspaces" "$aifProjectName" "$suffixStandard")"
            set_env "aiFoundryV2Exists"      "$(resource_exists_fuzzy "$targetRG" "Microsoft.CognitiveServices/accounts" "$aiFoundryV2Name" "")"
            # Nested projects can't be enumerated with az resource list — use REST API instead
            _subId=$(az account show --query id -o tsv)
            _fdryAcct=$(az cognitiveservices account list --resource-group "$targetRG" \
              --query "[?starts_with(name, 'aif2')].name" -o tsv 2>/dev/null | head -n1)
            if [ -n "$_fdryAcct" ]; then
              _projCount=$(az rest --method GET \
                --url "https://management.azure.com/subscriptions/${_subId}/resourceGroups/${targetRG}/providers/Microsoft.CognitiveServices/accounts/${_fdryAcct}/projects?api-version=2025-12-01" \
                --query "length(value)" -o tsv 2>/dev/null || echo "0")
              if [ "${_projCount:-0}" -gt 0 ]; then
                set_env "aiFoundryV2ProjectExists" "true"
              else
                # Fallback: derive project name from account name suffix (accountName e.g. 'aif2ahbbc2e4' → suffix 'ahbbc2e4')
                # Project name = take('aif2-p{num}{acctSuffix}', 12) → e.g. 'aif2-p002ahb'
                _acctSuffix="${_fdryAcct:4}"
                _projName=$(echo "aif2-p${{ env.project_number_000 }}${_acctSuffix}" | cut -c1-12)
                echo "  Fallback: trying direct GET for derived project name '${_projName}' ..."
                _httpStatus=$(az rest --method GET \
                  --url "https://management.azure.com/subscriptions/${_subId}/resourceGroups/${targetRG}/providers/Microsoft.CognitiveServices/accounts/${_fdryAcct}/projects/${_projName}?api-version=2025-12-01" \
                  -o none 2>/dev/null && echo "200" || echo "404")
                if [ "$_httpStatus" = "200" ]; then
                  set_env "aiFoundryV2ProjectExists" "true"
                else
                  set_env "aiFoundryV2ProjectExists" "false"
                fi
              fi
            else
              set_env "aiFoundryV2ProjectExists" "false"
            fi
            set_env "dataFactoryExists"      "$(resource_exists_fuzzy "$targetRG" "Microsoft.DataFactory/factories" "$dataFactoryName" "$suffixStandard")"
            set_env "botServiceExists"       "$(resource_exists_fuzzy "$targetRG" "Microsoft.BotService/botServices" "$botServiceName" "$suffixStandard")"
            set_env "aksExists"              "$(resource_exists_fuzzy "$targetRG" "Microsoft.ContainerService/managedClusters" "$aksName" "$suffixStandard")"
            set_env "amlExists"              "$(resource_exists_fuzzy "$targetRG" "Microsoft.MachineLearningServices/workspaces" "$amlName" "$suffixStandard")"
            set_env "openaiExists"           "$(resource_exists_fuzzy "$targetRG" "Microsoft.CognitiveServices/accounts" "$openaiName" "$suffixStandard")"
            set_env "aiSearchExists"         "$(resource_exists_fuzzy "$targetRG" "Microsoft.Search/searchServices" "$safeNameAISearch" "$suffixStandardNoDash")"
            set_env "aiServicesExists"       "$(resource_exists_fuzzy "$targetRG" "Microsoft.CognitiveServices/accounts" "$aiServicesPrefix" "$suffixStandardNoDash")"
            set_env "containerAppsEnvExists" "$(resource_exists_fuzzy "$targetRG" "Microsoft.App/managedEnvironments" "$containerAppsEnvName" "$suffixStandard")"
            set_env "containerAppAExists"    "$(resource_exists_fuzzy "$targetRG" "Microsoft.App/containerApps" "$containerAppAName" "$suffixStandard")"
            set_env "containerAppWExists"    "$(resource_exists_fuzzy "$targetRG" "Microsoft.App/containerApps" "$containerAppWName" "$suffixStandard")"
            set_env "keyvaultExists"         "$(resource_exists_fuzzy "$targetRG" "Microsoft.KeyVault/vaults" "$keyvaultName" "$twoNumbers")"
            set_env "miACAExists"            "$(resource_exists_identity "$targetRG" "$miACAPrefix")"
            set_env "miPrjExists"            "$(resource_exists_identity "$targetRG" "$miPrjPrefix")"
            set_env "storageAccount1001Exists" "$(resource_exists_fuzzy "$targetRG" "Microsoft.Storage/storageAccounts" "$storageAccount1001Name" "")"
            set_env "storageAccount2001Exists" "$(resource_exists_fuzzy "$targetRG" "Microsoft.Storage/storageAccounts" "$storageAccount2001Name" "")"
            set_env "databricksExists"       "$(resource_exists_fuzzy "$targetRG" "Microsoft.Databricks/workspaces" "$databricksName" "$suffixStandard")"
            set_env "redisExists"            "$(resource_exists_fuzzy "$targetRG" "Microsoft.Cache/Redis" "$redisName" "$suffixStandardNoDash")"
            set_env "cosmosDBExists"         "$(resource_exists_fuzzy "$targetRG" "Microsoft.DocumentDB/databaseAccounts" "$cosmosDbAccountName" "$suffixStandard")"
            set_env "logicAppsExists"        "$(resource_exists_fuzzy "$targetRG" "Microsoft.Logic/workflows" "$logicAppName" "$suffixStandard")"
            set_env "eventHubsExists"        "$(resource_exists_fuzzy "$targetRG" "Microsoft.EventHub/namespaces" "$eventHubNsName" "$suffixStandard")"
            set_env "functionAppExists"      "$(resource_exists_fuzzy "$targetRG" "Microsoft.Web/sites" "$funcAppName" "$suffixStandard")"
            set_env "webAppExists"           "$(resource_exists_fuzzy "$targetRG" "Microsoft.Web/sites" "$webAppResourceName" "$suffixStandard")"
            set_env "postgreSQLExists"       "$(resource_exists_fuzzy "$targetRG" "Microsoft.DBforPostgreSQL/flexibleServers" "$pgServerName" "$suffixStandard")"
            set_env "bingExists"             "$(resource_exists_fuzzy "$targetRG" "Microsoft.Bing/accounts" "$bingAccountName" "$suffixStandard")"
            set_env "bingCustomSearchExists" "$(resource_exists_fuzzy "$targetRG" "Microsoft.CognitiveServices/accounts" "$bingCustomName" "$suffixStandard")"

      - name: 17_Extract_aifactory_salt_random
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            if [ "${{ env.miPrjExists }}" != "true" ]; then exit 0; fi
            commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}"
            projectNumber="${{ env.project_number_000 }}"
            projectName="prj${projectNumber}"
            locationSuffix="${{ env.admin_locationSuffix }}"
            envName="${{ env.dev_test_prod }}"
            aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}"
            projectPrefix="${{ env.projectPrefix }}"
            projectSuffix="${{ env.projectSuffix }}"
            projectNameReplaced="${projectName/prj/project}"
            targetResourceGroup="${commonRGNamePrefix}${projectPrefix}${projectNameReplaced}-${locationSuffix}-${envName}${aifactorySuffixRG}${projectSuffix}"
            miPrjPrefix="mi-${projectName}-${locationSuffix}-${envName}"
            miName=$(az identity list --resource-group "$targetResourceGroup" --query "[?starts_with(name, '$miPrjPrefix')].name" -o tsv | head -n1)
            if [ -n "$miName" ]; then
              salt="${miName: -14:10}"
              echo "aifactory_salt_random=$salt" >> $GITHUB_ENV
            fi

      - name: 18_Delete_Service_If_Not_Enabled_And_Exists
        if: env.enableDeleteForDisabledResources == 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}"
            projectNumber="${{ env.project_number_000 }}"
            projectName="prj${projectNumber}"
            locationSuffix="${{ env.admin_locationSuffix }}"
            envName="${{ env.dev_test_prod }}"
            aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}"
            projectPrefix="${{ env.projectPrefix }}"
            projectSuffix="${{ env.projectSuffix }}"
            projectNameReplaced="${projectName/prj/project}"
            targetRG="${commonRGNamePrefix}${projectPrefix}${projectNameReplaced}-${locationSuffix}-${envName}${aifactorySuffixRG}${projectSuffix}"

            echo "Target resource group: $targetRG"
            delete_all="${{ env.deleteAllServicesForProject }}"

            # Never deleted regardless of flags: RG itself, KeyVault, Storage Accounts, Application Insights.
            # Those are intentionally absent from the list below.

            delete_resource() {
              local rtype="$1" rname="$2" rg="$3"
              echo "Deleting $rtype '$rname' in $rg ..."
              case "$rtype" in
                Microsoft.CognitiveServices/accounts)
                  # Nested projects require REST — az resource list cannot enumerate child types
                  subId=$(az account show --query id -o tsv)
                  # Option A (primary): LIST projects and strip "accountName/" prefix that ARM returns for nested resources
                  projectNames=$(az rest --method GET \
                    --url "https://management.azure.com/subscriptions/${subId}/resourceGroups/${rg}/providers/Microsoft.CognitiveServices/accounts/${rname}/projects?api-version=2025-12-01" \
                    --query "value[].name" -o tsv 2>/dev/null | sed 's|.*/||' || echo "")
                  # Option B (fallback): derive project name from account name suffix
                  # Account name e.g. 'aif2ahbbc2e4' → suffix after 'aif2' = 'ahbbc2e4'
                  # Project name = take('aif2-p{num}{suffix}', 12) → e.g. 'aif2-p002ahb'
                  if [ -z "$projectNames" ]; then
                    _acctSuffix="${rname:4}"
                    _directProjName=$(echo "aif2-p${{ env.project_number_000 }}${_acctSuffix}" | cut -c1-12)
                    echo "  Fallback: trying direct GET for derived project name '${_directProjName}' ..."
                    _chk=$(az rest --method GET \
                      --url "https://management.azure.com/subscriptions/${subId}/resourceGroups/${rg}/providers/Microsoft.CognitiveServices/accounts/${rname}/projects/${_directProjName}?api-version=2025-12-01" \
                      -o none 2>/dev/null && echo "exists" || echo "")
                    [ -n "$_chk" ] && projectNames="$_directProjName"
                  fi
                  if [ -n "$projectNames" ]; then
                    while IFS= read -r proj; do
                      [ -z "$proj" ] && continue
                      proj="${proj##*/}"  # strip any residual accountName/ prefix
                      echo "  Deleting nested project '$proj' under account '$rname' ..."
                      az rest --method DELETE \
                        --url "https://management.azure.com/subscriptions/${subId}/resourceGroups/${rg}/providers/Microsoft.CognitiveServices/accounts/${rname}/projects/${proj}?api-version=2025-12-01" \
                        || echo "WARN: failed to delete project $proj"
                    done <<< "$projectNames"
                    echo "  Polling until all projects are gone (max 3min)..."
                    for i in $(seq 1 18); do
                      remaining=$(az rest --method GET \
                        --url "https://management.azure.com/subscriptions/${subId}/resourceGroups/${rg}/providers/Microsoft.CognitiveServices/accounts/${rname}/projects?api-version=2025-12-01" \
                        --query "length(value)" -o tsv 2>/dev/null || echo "0")
                      [ "${remaining:-0}" -eq 0 ] && break
                      echo "  Still $remaining project(s) remaining, waiting 10s (attempt $i/18)..."
                      sleep 10
                    done
                  fi
                  az cognitiveservices account delete --resource-group "$rg" --name "$rname" || echo "WARN: failed to delete $rname"
                  # Clean up private endpoint and NIC: {accountName}-pend, {accountName}-pend-nic
                  _aif2PE="${rname}-pend"
                  _aif2NIC="${rname}-pend-nic"
                  echo "  Deleting private endpoint '${_aif2PE}' ..."
                  az network private-endpoint delete --resource-group "$rg" --name "$_aif2PE" 2>/dev/null || echo "  INFO: PE '${_aif2PE}' not found or already deleted"
                  echo "  Deleting NIC '${_aif2NIC}' ..."
                  az network nic delete --resource-group "$rg" --name "$_aif2NIC" 2>/dev/null || echo "  INFO: NIC '${_aif2NIC}' not found or already deleted" ;;
                Microsoft.Search/searchServices)
                  # Delete shared private link resources first, then poll until all gone
                  subId=$(az account show --query id -o tsv)
                  splNames=$(az rest --method GET \
                    --url "https://management.azure.com/subscriptions/${subId}/resourceGroups/${rg}/providers/Microsoft.Search/searchServices/${rname}/sharedPrivateLinkResources?api-version=2023-11-01" \
                    --query "value[].name" -o tsv 2>/dev/null || echo "")
                  if [ -n "$splNames" ]; then
                    while IFS= read -r spl; do
                      [ -z "$spl" ] && continue
                      echo "  Deleting shared private link '$spl' ..."
                      az rest --method DELETE \
                        --url "https://management.azure.com/subscriptions/${subId}/resourceGroups/${rg}/providers/Microsoft.Search/searchServices/${rname}/sharedPrivateLinkResources/${spl}?api-version=2023-11-01" \
                        || echo "WARN: failed to delete SPL $spl"
                    done <<< "$splNames"
                    echo "  Polling until all SPLs are gone (max 5min)..."
                    for i in $(seq 1 30); do
                      remaining=$(az rest --method GET \
                        --url "https://management.azure.com/subscriptions/${subId}/resourceGroups/${rg}/providers/Microsoft.Search/searchServices/${rname}/sharedPrivateLinkResources?api-version=2023-11-01" \
                        --query "length(value)" -o tsv 2>/dev/null || echo "0")
                      [ "$remaining" -eq 0 ] && break
                      echo "  Still $remaining SPL(s) remaining, waiting 10s (attempt $i/30)..."
                      sleep 10
                    done
                  fi
                  az search service delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname"
                  # Clean up private endpoint and NIC: {searchName}-pend, {searchName}-pend-nic
                  _srchPE="${rname}-pend"
                  _srchNIC="${rname}-pend-nic"
                  echo "  Deleting private endpoint '${_srchPE}' ..."
                  az network private-endpoint delete --resource-group "$rg" --name "$_srchPE" 2>/dev/null || echo "  INFO: PE '${_srchPE}' not found or already deleted"
                  echo "  Deleting NIC '${_srchNIC}' ..."
                  az network nic delete --resource-group "$rg" --name "$_srchNIC" 2>/dev/null || echo "  INFO: NIC '${_srchNIC}' not found or already deleted" ;;
                Microsoft.MachineLearningServices/workspaces)
                  az ml workspace delete --resource-group "$rg" --name "$rname" --yes --no-wait || echo "WARN: failed to delete $rname" ;;
                Microsoft.App/containerApps)
                  az containerapp delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname" ;;
                Microsoft.App/managedEnvironments)
                  az containerapp env delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname" ;;
                Microsoft.ContainerService/managedClusters)
                  az aks delete --resource-group "$rg" --name "$rname" --yes --no-wait || echo "WARN: failed to delete $rname" ;;
                Microsoft.DataFactory/factories)
                  az datafactory delete --resource-group "$rg" --factory-name "$rname" --yes || echo "WARN: failed to delete $rname" ;;
                Microsoft.DocumentDB/databaseAccounts)
                  az cosmosdb delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname"
                  # Delete associated private endpoint(s): name starts with 'cosmos', ends with 'pend'
                  pendNames=$(az network private-endpoint list --resource-group "$rg" \
                    --query "[?starts_with(name, 'cosmos') && ends_with(name, 'pend')].name" -o tsv 2>/dev/null || echo "")
                  if [ -n "$pendNames" ]; then
                    while IFS= read -r pend; do
                      [ -z "$pend" ] && continue
                      echo "  Deleting private endpoint '$pend' ..."
                      az network private-endpoint delete --resource-group "$rg" --name "$pend" || echo "WARN: failed to delete PE $pend"
                    done <<< "$pendNames"
                  fi
                  # Delete associated NICs: name starts with 'cosmos', ends with 'pend-nic'
                  nicNames=$(az network nic list --resource-group "$rg" \
                    --query "[?starts_with(name, 'cosmos') && ends_with(name, 'pend-nic')].name" -o tsv 2>/dev/null || echo "")
                  if [ -n "$nicNames" ]; then
                    while IFS= read -r nic; do
                      [ -z "$nic" ] && continue
                      echo "  Deleting NIC '$nic' ..."
                      az network nic delete --resource-group "$rg" --name "$nic" || echo "WARN: failed to delete NIC $nic"
                    done <<< "$nicNames"
                  fi ;;
                Microsoft.DBforPostgreSQL/flexibleServers)
                  az postgres flexible-server delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname" ;;
                Microsoft.Cache/Redis)
                  az redis delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname" ;;
                Microsoft.Web/sites)
                  az webapp delete --resource-group "$rg" --name "$rname" || echo "WARN: failed to delete $rname" ;;
                Microsoft.Databricks/workspaces)
                  az databricks workspace delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname" ;;
                Microsoft.Logic/workflows)
                  az logicapp delete --resource-group "$rg" --name "$rname" --yes || echo "WARN: failed to delete $rname" ;;
                Microsoft.EventHub/namespaces)
                  az eventhubs namespace delete --resource-group "$rg" --namespace-name "$rname" || echo "WARN: failed to delete $rname" ;;
                Microsoft.BotService/botServices)
                  az bot delete --resource-group "$rg" --name "$rname" || echo "WARN: failed to delete bot $rname"
                  # Delete bot managed identity (suffix: <name>-identity)
                  botIdentity=$(az resource list --resource-group "$rg" \
                    --resource-type "Microsoft.ManagedIdentity/userAssignedIdentities" \
                    --query "[?starts_with(name, '${rname}') && ends_with(name, '-identity')].name" -o tsv 2>/dev/null | head -n1)
                  if [ -n "$botIdentity" ]; then
                    echo "  Deleting bot managed identity '$botIdentity' ..."
                    az identity delete --resource-group "$rg" --name "$botIdentity" || echo "WARN: failed to delete identity $botIdentity"
                  fi ;;
                Microsoft.Bing/accounts)
                  az resource delete --resource-group "$rg" --name "$rname" --resource-type "Microsoft.Bing/accounts" || echo "WARN: failed to delete $rname" ;;
                *)
                  az resource delete --resource-group "$rg" --name "$rname" --resource-type "$rtype" || echo "WARN: failed to delete $rname" ;;
              esac
            }

            # delete_all=true  → always attempt deletion (live query decides if resource exists).
            # delete_all=false → only delete if service is explicitly disabled AND not known absent.
            should_delete() {
              local enabled="$1" exists="$2"
              if [ "$delete_all" == "true" ]; then return 0; fi
              if [ "$exists" == "false" ]; then return 1; fi
              if [ "$enabled" == "false" ] || [ "$enabled" == "'false'" ]; then return 0; fi
              return 1
            }

            if should_delete "${{ env.enableAIFoundryHub }}" "${{ env.aiHubExists }}"; then
              hubName=$(az ml workspace list --resource-group "$targetRG" --query "[?kind=='hub'].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$hubName" ] && delete_resource "Microsoft.MachineLearningServices/workspaces" "$hubName" "$targetRG"
            fi
            if should_delete "${{ env.enableAIFoundry }}" "${{ env.aiFoundryV2Exists }}"; then
              fdryName=$(az cognitiveservices account list --resource-group "$targetRG" --query "[?kind=='AIServices'].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$fdryName" ] && delete_resource "Microsoft.CognitiveServices/accounts" "$fdryName" "$targetRG"
            fi
            # Unconditional sweep: clean up orphaned AI Foundry V2 private endpoints and NICs
            # (runs even if the account was already deleted but PE/NIC cleanup previously failed)
            echo "Sweeping for orphaned AI Foundry V2 private endpoints (aif2*-pend) ..."
            orphanPEs=$(az network private-endpoint list --resource-group "$targetRG" \
              --query "[?starts_with(name, 'aif2') && ends_with(name, '-pend')].name" -o tsv 2>/dev/null || echo "")
            if [ -n "$orphanPEs" ]; then
              while IFS= read -r pe; do
                [ -z "$pe" ] && continue
                echo "  Deleting orphaned PE '$pe' ..."
                az network private-endpoint delete --resource-group "$targetRG" --name "$pe" 2>/dev/null \
                  || echo "  INFO: PE '$pe' not found or already deleted"
                _orphanNIC="${pe}-nic"
                echo "  Deleting orphaned NIC '${_orphanNIC}' ..."
                az network nic delete --resource-group "$targetRG" --name "$_orphanNIC" 2>/dev/null \
                  || echo "  INFO: NIC '${_orphanNIC}' not found or already deleted"
              done <<< "$orphanPEs"
            else
              echo "  No orphaned AI Foundry V2 PEs found."
            fi
            if should_delete "${{ env.enableAISearch }}" "${{ env.aiSearchExists }}"; then
              srchName=$(az search service list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$srchName" ] && delete_resource "Microsoft.Search/searchServices" "$srchName" "$targetRG"
            fi
            # Unconditional sweep: clean up orphaned AI Search private endpoints and NICs
            # (runs even if the service was already deleted but PE/NIC cleanup previously failed)
            echo "Sweeping for orphaned AI Search private endpoints (aisearch*-pend) ..."
            orphanSrchPEs=$(az network private-endpoint list --resource-group "$targetRG" \
              --query "[?starts_with(name, 'aisearch') && ends_with(name, '-pend')].name" -o tsv 2>/dev/null || echo "")
            if [ -n "$orphanSrchPEs" ]; then
              while IFS= read -r pe; do
                [ -z "$pe" ] && continue
                echo "  Deleting orphaned PE '$pe' ..."
                az network private-endpoint delete --resource-group "$targetRG" --name "$pe" 2>/dev/null \
                  || echo "  INFO: PE '$pe' not found or already deleted"
                _orphanNIC="${pe}-nic"
                echo "  Deleting orphaned NIC '${_orphanNIC}' ..."
                az network nic delete --resource-group "$targetRG" --name "$_orphanNIC" 2>/dev/null \
                  || echo "  INFO: NIC '${_orphanNIC}' not found or already deleted"
              done <<< "$orphanSrchPEs"
            else
              echo "  No orphaned AI Search PEs found."
            fi
            if should_delete "${{ env.enableAzureOpenAI }}" "${{ env.openaiExists }}"; then
              openaiName=$(az cognitiveservices account list --resource-group "$targetRG" --query "[?kind=='OpenAI'].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$openaiName" ] && delete_resource "Microsoft.CognitiveServices/accounts" "$openaiName" "$targetRG"
            fi
            if should_delete "${{ env.enableContainerApps }}" "${{ env.containerAppAExists }}"; then
              az containerapp list --resource-group "$targetRG" --query "[].name" -o tsv 2>/dev/null | while read -r name; do
                [ -n "$name" ] && delete_resource "Microsoft.App/containerApps" "$name" "$targetRG"
              done
              # Also delete the managed environment once apps are removed
              acaEnvName=$(az containerapp env list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$acaEnvName" ] && delete_resource "Microsoft.App/managedEnvironments" "$acaEnvName" "$targetRG"
            fi
            if should_delete "${{ env.enableCosmosDB }}" "${{ env.cosmosDBExists }}"; then
              cosmosName=$(az cosmosdb list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$cosmosName" ] && delete_resource "Microsoft.DocumentDB/databaseAccounts" "$cosmosName" "$targetRG"
            fi
            if should_delete "${{ env.enablePostgreSQL }}" "${{ env.postgreSQLExists }}"; then
              pgName=$(az postgres flexible-server list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$pgName" ] && delete_resource "Microsoft.DBforPostgreSQL/flexibleServers" "$pgName" "$targetRG"
            fi
            if should_delete "${{ env.enableRedisCache }}" "${{ env.redisExists }}"; then
              redisName=$(az redis list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$redisName" ] && delete_resource "Microsoft.Cache/Redis" "$redisName" "$targetRG"
            fi
            if should_delete "${{ env.enableFunction }}" "${{ env.functionAppExists }}"; then
              funcName=$(az functionapp list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$funcName" ] && delete_resource "Microsoft.Web/sites" "$funcName" "$targetRG"
            fi
            if should_delete "${{ env.enableWebApp }}" "${{ env.webAppExists }}"; then
              webName=$(az webapp list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$webName" ] && delete_resource "Microsoft.Web/sites" "$webName" "$targetRG"
            fi
            if should_delete "${{ env.enableDatabricks }}" "${{ env.databricksExists }}"; then
              dbwName=$(az databricks workspace list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$dbwName" ] && delete_resource "Microsoft.Databricks/workspaces" "$dbwName" "$targetRG"
            fi
            if should_delete "${{ env.enableDatafactory }}" "${{ env.dataFactoryExists }}"; then
              adfName=$(az datafactory list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$adfName" ] && delete_resource "Microsoft.DataFactory/factories" "$adfName" "$targetRG"
            fi
            if should_delete "${{ env.enableLogicApps }}" "${{ env.logicAppsExists }}"; then
              laName=$(az logicapp list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$laName" ] && delete_resource "Microsoft.Logic/workflows" "$laName" "$targetRG"
            fi
            if should_delete "${{ env.enableEventHubs }}" "${{ env.eventHubsExists }}"; then
              ehNs=$(az eventhubs namespace list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$ehNs" ] && delete_resource "Microsoft.EventHub/namespaces" "$ehNs" "$targetRG"
            fi
            if should_delete "${{ env.enableAzureMachineLearning }}" "${{ env.amlExists }}"; then
              amlName=$(az ml workspace list --resource-group "$targetRG" --query "[?kind=='Default'].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$amlName" ] && delete_resource "Microsoft.MachineLearningServices/workspaces" "$amlName" "$targetRG"
            fi
            if should_delete "${{ env.enableAIServices }}" "${{ env.aiServicesExists }}"; then
              # Filter by name prefix 'aiservices' to avoid matching AI Foundry V2 accounts (prefix 'aif2')
              aiSvcName=$(az cognitiveservices account list --resource-group "$targetRG" --query "[?starts_with(name, 'aiservices')].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$aiSvcName" ] && delete_resource "Microsoft.CognitiveServices/accounts" "$aiSvcName" "$targetRG"
            fi
            if should_delete "${{ env.enableAksForAzureML }}" "${{ env.aksExists }}"; then
              aksName=$(az aks list --resource-group "$targetRG" --query "[0].name" -o tsv 2>/dev/null)
              [ -n "$aksName" ] && delete_resource "Microsoft.ContainerService/managedClusters" "$aksName" "$targetRG"
            fi
            if should_delete "${{ env.enableBotService }}" "${{ env.botServiceExists }}"; then
              # Bot name pattern: bot-{projectNumber}-{locationSuffix}-{envName}-{suffix}
              botName=$(az resource list --resource-group "$targetRG" \
                --resource-type "Microsoft.BotService/botServices" \
                --query "[?starts_with(name, 'bot-${projectNumber}')].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$botName" ] && delete_resource "Microsoft.BotService/botServices" "$botName" "$targetRG"
            fi
            if should_delete "${{ env.enableBing }}" "${{ env.bingExists }}"; then
              bingName=$(az resource list --resource-group "$targetRG" \
                --resource-type "Microsoft.Bing/accounts" \
                --query "[?starts_with(name, 'bing-${projectName}')].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$bingName" ] && delete_resource "Microsoft.Bing/accounts" "$bingName" "$targetRG"
            fi
            if should_delete "${{ env.enableBingCustomSearch }}" "${{ env.bingCustomSearchExists }}"; then
              bingCustName=$(az cognitiveservices account list --resource-group "$targetRG" \
                --query "[?kind=='Bing.CustomSearch' || starts_with(name, 'bingcustom')].name" -o tsv 2>/dev/null | head -n1)
              [ -n "$bingCustName" ] && delete_resource "Microsoft.CognitiveServices/accounts" "$bingCustName" "$targetRG"
            fi
            echo "18_Delete_Service_If_Not_Enabled_And_Exists completed."

      - name: 18_Purge_Soft_Deleted
        if: env.enableDeleteForDisabledResources == 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            set -e
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            echo "Waiting 5 minutes for soft-delete to process before purging..."
            sleep 300
            projectNumber="${{ env.project_number_000 }}"
            projectName="prj${projectNumber}"
            envName="${{ env.dev_test_prod }}"
            locationSuffix="${{ env.admin_locationSuffix }}"
            projectPrefix="${{ env.projectPrefix }}"
            projectSuffix="${{ env.projectSuffix }}"
            location="${{ env.admin_location }}"
            projectNameReplaced="${projectName/prj/project}"
            targetRG="${{ env.admin_aifactoryPrefixRG }}${projectPrefix}${projectNameReplaced}-${locationSuffix}-${envName}${{ env.admin_aifactorySuffixRG }}${projectSuffix}"
            echo "Target RG for purge: $targetRG"

            # Purge soft-deleted AI Foundry / AI Hub (Cognitive Services) accounts
            if [[ "${{ env.aiFoundryV2Exists }}" == "true" || "${{ env.aiHubExists }}" == "true" ]]; then
              echo "Scanning for soft-deleted Cognitive Services accounts in $targetRG..."
              deletedAccounts=$(az cognitiveservices account list-deleted \
                --query "[?resourceGroup=='${targetRG}'].name" \
                -o tsv 2>/dev/null || echo "")
              if [ -n "$deletedAccounts" ]; then
                while IFS= read -r accountName; do
                  echo "Purging soft-deleted Cognitive Services account: $accountName"
                  if ! az cognitiveservices account purge \
                    --location "$location" \
                    --resource-group "$targetRG" \
                    --name "$accountName"; then
                    echo "ERROR: Failed to purge Cognitive Services account '$accountName'" >&2
                    exit 1
                  fi
                done <<< "$deletedAccounts"
              else
                echo "No soft-deleted Cognitive Services accounts found in $targetRG."
              fi
            fi

            # Purge soft-deleted AML workspaces via REST API
            if [[ "${{ env.amlExists }}" == "true" ]]; then
              echo "Scanning for soft-deleted AML workspaces in $targetRG..."
              subId="${{ env.dev_test_prod_sub_id }}"
              deletedWorkspaces=$(az rest \
                --method GET \
                --url "https://management.azure.com/subscriptions/${subId}/providers/Microsoft.MachineLearningServices/locations/${location}/deletedWorkspaces?api-version=2024-04-01" \
                --query "value[?resourceGroup=='${targetRG}'].name" \
                -o tsv 2>/dev/null || echo "")
              if [ -n "$deletedWorkspaces" ]; then
                while IFS= read -r wsName; do
                  echo "Purging soft-deleted AML workspace: $wsName"
                  if ! az rest \
                    --method DELETE \
                    --url "https://management.azure.com/subscriptions/${subId}/providers/Microsoft.MachineLearningServices/locations/${location}/deletedWorkspaces/${wsName}?api-version=2024-04-01"; then
                    echo "ERROR: Failed to purge AML workspace '$wsName'" >&2
                    exit 1
                  fi
                done <<< "$deletedWorkspaces"
              else
                echo "No soft-deleted AML workspaces found in $targetRG."
              fi
            fi

            echo "18_Purge_Soft_Deleted completed."

      # === Deploy sequences ===

      - name: 61-foundation
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-61-foundation" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/01-foundation.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroupBase="${{ env.vnetResourceGroupBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters miACAExists="${{ env.miACAExists }}" \
              --parameters miPrjExists="${{ env.miPrjExists }}" \
              --parameters keyvaultExists="${{ env.keyvaultExists }}" \
              --parameters storageAccount1001Exists="${{ env.storageAccount1001Exists }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters privateDnsAndVnetLinkAllGlobalLocation="${{ env.privateDnsAndVnetLinkAllGlobalLocation }}" \
              --parameters zoneAzurecontainerappsExists="${{ env.zoneAzurecontainerappsExists }}" \
              --parameters zoneRedisExists="${{ env.zoneRedisExists }}" \
              --parameters zonePostgresExists="${{ env.zonePostgresExists }}" \
              --parameters zoneSqlExists="${{ env.zoneSqlExists }}" \
              --parameters zoneMongoExists="${{ env.zoneMongoExists }}" \
              --parameters zoneServicesAiExists="${{ env.zoneServicesAiExists }}" \
              --parameters zoneAPIMExists="${{ env.zoneAPIMExists }}" \
              --parameters enableDebugging="true" \
              --parameters DEBUG_enableAIServices="${{ env.enableAIServices }}" \
              --parameters DEBUG_enableAIFoundryHub="${{ env.enableAIFoundryHub }}" \
              --parameters DEBUG_enableAISearch="${{ env.enableAISearch }}" \
              --parameters DEBUG_enableAzureMachineLearning="${{ env.enableAzureMachineLearning }}" \
              --parameters DEBUG_enableFunction="${{ env.enableFunction }}" \
              --parameters DEBUG_functionRuntime="${{ env.functionRuntime }}" \
              --parameters DEBUG_functionVersion="${{ env.functionVersion }}" \
              --parameters DEBUG_enableWebApp="${{ env.enableWebApp }}" \
              --parameters DEBUG_webAppRuntime="${{ env.webAppRuntime }}" \
              --parameters DEBUG_webAppRuntimeVersion="${{ env.webAppRuntimeVersion }}" \
              --parameters DEBUG_aseSku="${{ env.aseSku }}" \
              --parameters DEBUG_aseSkuCode="${{ env.aseSkuCode }}" \
              --parameters DEBUG_aseSkuWorkers="${{ env.aseSkuWorkers }}" \
              --parameters DEBUG_enableContainerApps="${{ env.enableContainerApps }}" \
              --parameters DEBUG_enableAppInsightsDashboard="${{ env.enableAppInsightsDashboard }}" \
              --parameters DEBUG_aca_a_registry_image="${{ env.aca_a_registry_image }}" \
              --parameters DEBUG_aca_w_registry_image="${{ env.aca_w_registry_image }}" \
              --parameters DEBUG_enableBingSearch="${{ env.enableBing }}" \
              --parameters DEBUG_enableCosmosDB="${{ env.enableCosmosDB }}" \
              --parameters DEBUG_enableAzureOpenAI="${{ env.enableAzureOpenAI }}" \
              --parameters DEBUG_enableAzureAIVision="${{ env.enableAzureAIVision }}" \
              --parameters DEBUG_enableAzureSpeech="${{ env.enableAzureSpeech }}" \
              --parameters DEBUG_enableAIDocIntelligence="${{ env.enableAIDocIntelligence }}" \
              --parameters DEBUG_disableContributorAccessForUsers="${{ env.disableContributorAccessForUsers }}" \
              --parameters DEBUG_enablePostgreSQL="${{ env.enablePostgreSQL }}" \
              --parameters DEBUG_enableRedisCache="${{ env.enableRedisCache }}" \
              --parameters DEBUG_enableSQLDatabase="${{ env.enableSQLDatabase }}" \
              --parameters DEBUG_BYO_subnets="${{ env.BYO_subnets }}" \
              --parameters DEBUG_network_env_dev="${{ env.network_env_dev }}" \
              --parameters DEBUG_network_env_stage="${{ env.network_env_stage }}" \
              --parameters DEBUG_network_env_prod="${{ env.network_env_prod }}" \
              --parameters DEBUG_vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters DEBUG_vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters DEBUG_commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters DEBUG_datalakeName_param="${{ env.datalakeName_param }}" \
              --parameters DEBUG_kvNameFromCOMMON_param="${{ env.kvNameFromCOMMON_param }}" \
              --parameters DEBUG_useCommonACR_override="${{ env.useCommonACR_override }}" \
              --parameters DEBUG_subnetCommon="${{ env.subnetCommon }}" \
              --parameters DEBUG_subnetCommonScoring="${{ env.subnetCommonScoring }}" \
              --parameters DEBUG_subnetCommonPowerbiGw="${{ env.subnetCommonPowerbiGw }}" \
              --parameters DEBUG_subnetProjGenAI="${{ env.subnetProjGenAI }}" \
              --parameters DEBUG_subnetProjAKS="${{ env.subnetProjAKS }}" \
              --parameters DEBUG_subnetProjACA="${{ env.subnetProjACA }}" \
              --parameters DEBUG_subnetProjDatabricksPublic="${{ env.subnetProjDatabricksPublic }}" \
              --parameters DEBUG_subnetProjDatabricksPrivate="${{ env.subnetProjDatabricksPrivate }}" \
              --parameters DEBUG_byoASEv3="${{ env.byoASEv3 }}" \
              --parameters DEBUG_byoAseFullResourceId="${{ env.byoAseFullResourceId }}" \
              --parameters DEBUG_byoAseAppServicePlanResourceId="${{ env.byoAseAppServicePlanResourceId }}" \
              --parameters DEBUG_enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters DEBUG_allowPublicAccessWhenBehindVnet="${{ env.allowPublicAccessWhenBehindVnet }}" \
              --parameters DEBUG_enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters DEBUG_admin_aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters DEBUG_admin_commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters DEBUG_admin_prjResourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters DEBUG_aifactory_salt="${{ env.AIFACTORY_SALT }}" \
              --parameters DEBUG_admin_projectType="${{ env.admin_projectType }}" \
              --parameters DEBUG_project_number_000="${{ env.project_number_000 }}" \
              --parameters DEBUG_project_service_principal_AppID_seeding_kv_name="${{ env.project_service_principal_AppID_seeding_kv_name }}" \
              --parameters DEBUG_project_service_principal_OID_seeding_kv_name="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters DEBUG_project_service_principal_Secret_seeding_kv_name="${{ env.project_service_principal_Secret_seeding_kv_name }}" \
              --parameters DEBUG_project_IP_whitelist="${{ env.project_IP_whitelist }}" \
              --parameters DEBUG_deployModel_gpt_4="${{ env.deployModel_gpt_4 }}" \
              --parameters DEBUG_deployModel_text_embedding_ada_002="${{ env.deployModel_text_embedding_ada_002 }}" \
              --parameters DEBUG_deployModel_text_embedding_3_large="${{ env.deployModel_text_embedding_3_large }}" \
              --parameters DEBUG_deployModel_text_embedding_3_small="${{ env.deployModel_text_embedding_3_small }}" \
              --parameters DEBUG_deployModel_gpt_4o_mini="${{ env.deployModel_gpt_4o_mini }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --debug

      - name: 62-core-infrastructure
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            ADMIN_PASSWORD=$(date +%s | sha256sum | base64 | head -c 32)
            echo "=== Debug: IP Whitelist value ==="
            echo "project_IP_whitelist: [${{ env.project_IP_whitelist }}]"
            
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-62-core-infrastructure" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/02-core-infrastructure.bicep" \
              --parameters adminPassword="$ADMIN_PASSWORD" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters useCommonACR="${{ env.useCommonACR_override }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters common_subnet_name="${{ env.common_subnet_name }}" \
              --parameters subnetCommon="${{ env.subnetCommon }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters projectServicePrincipleAppID_SeedingKeyvaultName="${{ env.project_service_principal_AppID_seeding_kv_name }}" \
              --parameters projectServicePrincipleSecret_SeedingKeyvaultName="${{ env.project_service_principal_Secret_seeding_kv_name }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters cmk="${{ env.cmk }}" \
              --parameters cmkKeyName="${{ env.cmkKeyName }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters storageAccount1001Exists="${{ env.storageAccount1001Exists }}" \
              --parameters storageAccount2001Exists="${{ env.storageAccount2001Exists }}" \
              --parameters keyvaultExists="${{ env.keyvaultExists }}" \
              --parameters acrProjectExists="${{ env.acrProjectExists }}" \
              --parameters miACAExists="${{ env.miACAExists }}" \
              --parameters miPrjExists="${{ env.miPrjExists }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters keyvaultSoftDeleteDays="${{ env.admin_keyvaultSoftDeleteDays }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters allowPublicAccessWhenBehindVnet="${{ env.allowPublicAccessWhenBehindVnet }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters acr_adminUserEnabled="${{ env.acr_adminUserEnabled }}" \
              --parameters acr_dedicated="${{ env.acr_dedicated }}" \
              --parameters containerRegistrySkuName="${{ env.acr_SKU }}" \
              --parameters enableProjectVM="${{ env.enableProjectVM }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters updateKeyvaultRbac="${{ env.updateKeyvaultRbac }}" \
              --parameters enableLogicApps="${{ env.enableLogicApps }}" \
              --debug

      - name: 63-cognitive-services
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-63-cognitive-services" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/03-cognitive-services.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters openaiExists="${{ env.openaiExists }}" \
              --parameters aiSearchExists="${{ env.aiSearchExists }}" \
              --parameters aiServicesExists="${{ env.aiServicesExists }}" \
              --parameters keyvaultExists="${{ env.keyvaultExists }}" \
              --parameters storageAccount2001Exists="${{ env.storageAccount2001Exists }}" \
              --parameters storageAccount1001Exists="${{ env.storageAccount1001Exists }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters keyvaultSoftDeleteDays="${{ env.admin_keyvaultSoftDeleteDays }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters enableAIServices="${{ env.enableAIServices }}" \
              --parameters enableAISearch="${{ env.enableAISearch }}" \
              --parameters aiSearchSKUName="${{ vars.ADMIN_AISEARCH_TIER || 'standard' }}" \
              --parameters semanticSearchTier="${{ env.AISEARCH_SEMANTIC_TIER || 'free' }}" \
              --parameters enableAzureOpenAI="${{ env.enableAzureOpenAI }}" \
              --parameters enableContentSafety="${{ env.enableContentSafety }}" \
              --parameters enableAzureAIVision="${{ env.enableAzureAIVision }}" \
              --parameters enableAzureSpeech="${{ env.enableAzureSpeech }}" \
              --parameters enableAIDocIntelligence="${{ env.enableAIDocIntelligence }}" \
              --parameters deployModel_text_embedding_3_large="${{ env.deployModel_text_embedding_3_large }}" \
              --parameters deployModel_text_embedding_3_small="${{ env.deployModel_text_embedding_3_small }}" \
              --parameters deployModel_text_embedding_ada_002="${{ env.deployModel_text_embedding_ada_002 }}" \
              --parameters deployModel_gpt_4o_mini="${{ env.deployModel_gpt_4o_mini }}" \
              --parameters default_gpt_capacity="${{ env.default_gpt_capacity }}" \
              --parameters default_model_sku="${{ env.default_model_sku }}" \
              --parameters modelGPTXName="${{ env.modelGPTXName }}" \
              --parameters modelGPTXVersion="${{ env.modelGPTXVersion }}" \
              --parameters modelGPTXSku="${{ env.modelGPTXSku }}" \
              --parameters modelGPTXCapacity="${{ env.modelGPTXCapacity }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters miACAExists="${{ env.miACAExists }}" \
              --parameters miPrjExists="${{ env.miPrjExists }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters enableBingCustomSearch="${{ env.enableBingCustomSearch }}" \
              --parameters enableBing="${{ env.enableBing }}" \
              --parameters enableAFoundryCaphost="${{ env.enableAFoundryCaphost }}" \
              --parameters enableAIFoundry="${{ env.enableAIFoundry }}" \
              --parameters enableAISearchSharedPrivateLink="${{ env.enableAISearchSharedPrivateLink }}" \
              --parameters cmk="${{ env.cmk }}" \
              --parameters cmkKeyName="${{ env.cmkKeyName }}" \
              --parameters addAISearch="${{ env.addAISearch }}" \
              --debug

      - name: 64-databases
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-64-databases" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/04-databases.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters cosmosDBExists="${{ env.cosmosDBExists }}" \
              --parameters redisExists="${{ env.redisExists }}" \
              --parameters postgreSQLExists="${{ env.postgreSQLExists }}" \
              --parameters sqlServerExists="${{ env.sqlServerExists }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters enableCosmosDB="${{ env.enableCosmosDB }}" \
              --parameters cosmosKind="${{ env.cosmosKind }}" \
              --parameters enablePostgreSQL="${{ env.enablePostgreSQL }}" \
              --parameters enableRedisCache="${{ env.enableRedisCache }}" \
              --parameters enableSQLDatabase="${{ env.enableSQLDatabase }}" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters enableAFoundryCaphost="${{ env.enableAFoundryCaphost }}" \
              --parameters enableAIFoundry="${{ env.enableAIFoundry }}" \
              --parameters cmk="${{ env.cmk }}" \
              --parameters cmkKeyName="${{ env.cmkKeyName }}" \
              --debug

      - name: 65-compute-services
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-65-compute-services" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/05-compute-services.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters useCommonACR="${{ env.useCommonACR_override }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters containerAppsEnvExists="${{ env.containerAppsEnvExists }}" \
              --parameters containerAppAExists="${{ env.containerAppAExists }}" \
              --parameters containerAppWExists="${{ env.containerAppWExists }}" \
              --parameters functionAppExists="${{ env.functionAppExists }}" \
              --parameters webAppExists="${{ env.webAppExists }}" \
              --parameters funcAppServicePlanExists="${{ env.funcAppServicePlanExists }}" \
              --parameters webAppServicePlanExists="${{ env.webAppServicePlanExists }}" \
              --parameters applicationInsightExists="${{ env.applicationInsightExists }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters enableContainerApps="${{ env.enableContainerApps }}" \
              --parameters enableFunction="${{ env.enableFunction }}" \
              --parameters enableWebApp="${{ env.enableWebApp }}" \
              --parameters enableBingSearch="${{ env.enableBing }}" \
              --parameters enableAzureOpenAI="${{ env.enableAzureOpenAI }}" \
              --parameters enableAISearch="${{ env.enableAISearch }}" \
              --parameters enableAIServices="${{ env.enableAIServices }}" \
              --parameters functionRuntime="${{ env.functionRuntime }}" \
              --parameters functionVersion="${{ env.functionVersion }}" \
              --parameters webAppRuntime="${{ env.webAppRuntime }}" \
              --parameters webAppRuntimeVersion="${{ env.webAppRuntimeVersion }}" \
              --parameters aseSku="${{ env.aseSku }}" \
              --parameters aseSkuCode="${{ env.aseSkuCode }}" \
              --parameters aseSkuWorkers="${{ env.aseSkuWorkers }}" \
              --parameters byoASEv3="${{ env.byoASEv3 }}" \
              --parameters byoAseFullResourceId="${{ env.byoAseFullResourceId }}" \
              --parameters enableAppInsightsDashboard="${{ env.enableAppInsightsDashboard }}" \
              --parameters aca_a_registry_image="${{ env.aca_a_registry_image }}" \
              --parameters aca_w_registry_image="${{ env.aca_w_registry_image }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters aiFoundryV2Exists="${{ env.aiFoundryV2Exists }}" \
              --parameters enableAIFoundry="${{ env.enableAIFoundry }}" \
              --parameters disableAgentNetworkInjection="${{ env.disableAgentNetworkInjection }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters addAISearch="${{ env.addAISearch }}" \
              --debug

      - name: 66-ai-platform
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-66-ai-platform" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/06-ai-platform.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters useCommonACR="${{ env.useCommonACR_override }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters aiHubExists="${{ env.aiHubExists }}" \
              --parameters aifProjectExists="${{ env.aifProjectExists }}" \
              --parameters miPrjExists="${{ env.miPrjExists }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters enableAIFoundryHub="${{ env.enableAIFoundryHub }}" \
              --parameters addAIFoundryHub="${{ env.addAIFoundryHub }}" \
              --parameters enableAISearch="${{ env.enableAISearch }}" \
              --parameters enableAIServices="${{ env.enableAIServices }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters deployModel_text_embedding_ada_002="${{ env.deployModel_text_embedding_ada_002 }}" \
              --parameters deployModel_text_embedding_3_large="${{ env.deployModel_text_embedding_3_large }}" \
              --parameters deployModel_text_embedding_3_small="${{ env.deployModel_text_embedding_3_small }}" \
              --parameters default_embedding_capacity="${{ env.default_embedding_capacity }}" \
              --parameters deployModel_gpt_4o_mini="${{ env.deployModel_gpt_4o_mini }}" \
              --parameters default_gpt_capacity="${{ env.default_gpt_capacity }}" \
              --parameters default_model_sku="${{ env.default_model_sku }}" \
              --parameters deployModel_gpt_4o="${{ env.deployModel_gpt_4o }}" \
              --parameters deployModel_gpt_X="${{ env.deployModel_gpt_X }}" \
              --parameters modelGPTXName="${{ env.modelGPTXName }}" \
              --parameters modelGPTXVersion="${{ env.modelGPTXVersion }}" \
              --parameters modelGPTXSku="${{ env.modelGPTXSku }}" \
              --parameters modelGPTXCapacity="${{ env.modelGPTXCapacity }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters allowPublicAccessWhenBehindVnet="${{ env.allowPublicAccessWhenBehindVnet }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters common_subnet_name="${{ env.common_subnet_name }}" \
              --parameters subnetCommon="${{ env.subnetCommon }}" \
              --parameters subnetCommonScoring="${{ env.subnetCommonScoring }}" \
              --parameters subscriptionIdDevTestProd="${{ env.dev_test_prod_sub_id }}" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters cmk="${{ env.cmk }}" \
              --parameters cmkKeyName="${{ env.cmkKeyName }}" \
              --parameters addAISearch="${{ env.addAISearch }}" \
              --debug

      - name: 67-data_ml_platform
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-67-data-ml-platform" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/07-ml-data-platform.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters subscriptionIdDevTestProd="${{ env.dev_test_prod_sub_id }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters network_env="${{ env.network_env }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters aks_dev_sku_override="${{ env.admin_aks_gpu_sku_dev_override }}" \
              --parameters aks_test_prod_sku_override="${{ env.admin_aks_gpu_sku_test_prod_override }}" \
              --parameters aks_version_override="${{ env.admin_aks_version_override }}" \
              --parameters aks_dev_nodes_override="${{ env.admin_aks_nodes_dev_override }}" \
              --parameters aks_test_prod_nodes_override="${{ env.admin_aks_nodes_testProd_override }}" \
              --parameters aml_ci_dev_sku_override="${{ env.admin_aml_computeInstance_dev_sku_override }}" \
              --parameters aml_ci_test_prod_sku_override="${{ env.admin_aml_computeInstance_testProd_sku_override }}" \
              --parameters aml_cluster_dev_sku_override="${{ env.admin_aml_cluster_sku_dev_override }}" \
              --parameters aml_cluster_test_prod_sku_override="${{ env.admin_aml_cluster_sku_testProd_override }}" \
              --parameters aml_cluster_dev_nodes_override="${{ env.admin_aml_cluster_maxNodes_dev_override }}" \
              --parameters aml_cluster_test_prod_nodes_override="${{ env.admin_aml_cluster_maxNodes_testProd_override }}" \
              --parameters AMLStudioUIPrivate="${{ env.admin_private_azureMLStudioUI }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters useCommonACR="${{ env.useCommonACR_override }}" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters amlExists="${{ env.amlExists }}" \
              --parameters aksExists="${{ env.aksExists }}" \
              --parameters dataFactoryExists="${{ env.dataFactoryExists }}" \
              --parameters databricksExists="${{ env.databricksExists }}" \
              --parameters enableDatafactory="${{ env.enableDatafactory }}" \
              --parameters enableAzureMachineLearning="${{ env.enableAzureMachineLearning }}" \
              --parameters enableDatabricks="${{ env.enableDatabricks }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters addAzureMachineLearning="${{ env.addAzureMachineLearning }}" \
              --parameters enableAksForAzureML="${{ env.enableAksForAzureML }}" \
              --parameters aksOutboundType="${{ env.aksOutboundType }}" \
              --parameters aksPrivateDNSZone="${{ env.aksPrivateDNSZone }}" \
              --parameters cmk="${{ env.cmk }}" \
              --parameters cmkKeyName="${{ env.cmkKeyName }}"

      - name: 68-integration
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-68-integration" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/11-integration.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters subscriptionIdDevTestProd="${{ env.dev_test_prod_sub_id }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters network_env="${{ env.network_env }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters useCommonACR="${{ env.useCommonACR_override }}" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters enableLogicApps="${{ env.enableLogicApps }}" \
              --parameters enableEventHubs="${{ env.enableEventHubs }}" \
              --parameters logicAppsExists="${{ env.logicAppsExists }}" \
              --parameters eventHubsExists="${{ env.eventHubsExists }}" \
              --parameters functionAppExists="${{ env.functionAppExists }}" \
              --parameters enableFunction="${{ env.enableFunction }}" \
              --parameters enableWebApp="${{ env.enableWebApp }}" \
              --parameters webAppExists="${{ env.webAppExists }}" \
              --parameters enableBotService="${{ env.enableBotService }}" \
              --parameters addAIFoundry="${{ env.addAIFoundry }}" \
              --parameters botServiceExists="${{ env.botServiceExists }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}"

      - name: 99_check_acr_role_assignments
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            commonResourceGroup="${{ env.admin_aifactoryPrefixRG }}${{ env.vnetResourceGroupBase }}-${{ env.admin_locationSuffix }}-${{ env.dev_test_prod }}${{ env.admin_aifactorySuffixRG }}"
            acrName=$(az acr list --resource-group "$commonResourceGroup" --query "[0].name" -o tsv 2>/dev/null || true)
            if [ -z "$acrName" ]; then echo "skipACRAssignments=false" >> $GITHUB_ENV; exit 0; fi
            acrPushRoleId="8311e382-0749-4cb8-b61a-304f252e45ec"
            acrScope="/subscriptions/${{ env.dev_test_prod_sub_id }}/resourceGroups/${commonResourceGroup}/providers/Microsoft.ContainerRegistry/registries/${acrName}"
            assignments=$(az role assignment list --scope "$acrScope" --role "$acrPushRoleId" --query "[?principalType=='User' || principalType=='Group']" -o tsv 2>/dev/null || true)
            if [ -n "$assignments" ]; then echo "skipACRAssignments=true" >> $GITHUB_ENV; else echo "skipACRAssignments=false" >> $GITHUB_ENV; fi

      - name: 100-rbac-security
        if: env.deleteAllServicesForProject != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-100-rbac-security" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/08-rbac-security.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters useCommonACR="${{ env.useCommonACR_override }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters azureMachineLearningObjectId="${{ env.azure_machinelearning_sp_oid }}" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters enableAzureMachineLearning="${{ env.enableAzureMachineLearning }}" \
              --parameters enableAIFoundryHub="${{ env.enableAIFoundryHub }}" \
              --parameters addAIFoundryHub="${{ env.addAIFoundryHub }}" \
              --parameters enableAIServices="${{ env.enableAIServices }}" \
              --parameters enableAIFoundry="${{ env.enableAIFoundry }}" \
              --parameters enableAISearch="${{ env.enableAISearch }}" \
              --parameters enableFunction="${{ env.enableFunction }}" \
              --parameters enableWebApp="${{ env.enableWebApp }}" \
              --parameters enableContainerApps="${{ env.enableContainerApps }}" \
              --parameters enableAppInsightsDashboard="${{ env.enableAppInsightsDashboard }}" \
              --parameters enableAzureOpenAI="${{ env.enableAzureOpenAI }}" \
              --parameters enableAzureAIVision="${{ env.enableAzureAIVision }}" \
              --parameters enableAzureSpeech="${{ env.enableAzureSpeech }}" \
              --parameters enableAIDocIntelligence="${{ env.enableAIDocIntelligence }}" \
              --parameters disableContributorAccessForUsers="${{ env.disableContributorAccessForUsers }}" \
              --parameters disableRBACAdminOnRGForUsers="${{ env.disableRBACAdminOnRGForUsers }}" \
              --parameters enableCosmosDB="${{ env.enableCosmosDB }}" \
              --parameters enablePostgreSQL="${{ env.enablePostgreSQL }}" \
              --parameters enableRedisCache="${{ env.enableRedisCache }}" \
              --parameters enableSQLDatabase="${{ env.enableSQLDatabase }}" \
              --parameters enableLogicApps="${{ env.enableLogicApps }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters commonLakeNamePrefixMax8chars="${{ env.LAKE_PREFIX }}" \
              --parameters tags='${{ env.tags }}' \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters dataFactoryExists="${{ env.dataFactoryExists }}" \
              --parameters aksExists="${{ env.aksExists }}" \
              --parameters amlExists="${{ env.amlExists }}" \
              --parameters aiHubExists="${{ env.aiHubExists }}" \
              --parameters aiServicesExists="${{ env.aiServicesExists }}" \
              --parameters openaiExists="${{ env.openaiExists }}" \
              --parameters updateRbac="${{ env.updateRbac }}" \
              --parameters miPrjExists="${{ env.miPrjExists }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters addAISearch="${{ env.addAISearch }}" \
              --parameters skipExistingRoleAssignments="${{ env.skipACRAssignments }}" \
              --parameters contributorRoleId="${{ env.BYO_CONTRIBUTOR_ROLE_ID }}" \
              --debug

      - name: 69a-aifoundry-2025-2ndOption-Account
        if: env.deleteAllServicesForProject != 'true' && env.debug_disable_69_aifoundry_2025 != 'true' && env.aiFoundryV2Exists != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-69-aif-a" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/09-ai-foundry-2025-v4.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters enableAISearch="${{ env.enableAISearch }}" \
              --parameters enableCosmosDB="${{ env.enableCosmosDB }}" \
              --parameters deployModel_gpt_X="${{ env.deployModel_gpt_X }}" \
              --parameters modelGPTXName="${{ env.modelGPTXName }}" \
              --parameters modelGPTXVersion="${{ env.modelGPTXVersion }}" \
              --parameters modelGPTXSku="${{ env.modelGPTXSku }}" \
              --parameters modelGPTXCapacity="${{ env.modelGPTXCapacity }}" \
              --parameters deployModel_text_embedding_ada_002="${{ env.deployModel_text_embedding_ada_002 }}" \
              --parameters deployModel_text_embedding_3_large="${{ env.deployModel_text_embedding_3_large }}" \
              --parameters deployModel_text_embedding_3_small="${{ env.deployModel_text_embedding_3_small }}" \
              --parameters default_embedding_capacity="${{ env.default_embedding_capacity }}" \
              --parameters default_gpt_capacity="${{ env.default_gpt_capacity }}" \
              --parameters deployModel_gpt_4o="${{ env.deployModel_gpt_4o }}" \
              --parameters default_gpt_4o_version="${{ env.default_gpt_4o_version }}" \
              --parameters deployModel_gpt_4o_mini="${{ env.deployModel_gpt_4o_mini }}" \
              --parameters default_gpt_4o_mini_version="${{ env.default_gpt_4o_mini_version }}" \
              --parameters default_model_sku="${{ env.default_model_sku }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters allowPublicAccessWhenBehindVnet="${{ env.allowPublicAccessWhenBehindVnet }}" \
              --parameters contributorRoleId="${{ env.BYO_CONTRIBUTOR_ROLE_ID }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters common_subnet_name="${{ env.common_subnet_name }}" \
              --parameters subnetCommon="${{ env.subnetCommon }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters subscriptionIdDevTestProd="${{ env.dev_test_prod_sub_id }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters disableAgentNetworkInjection="${{ env.disableAgentNetworkInjection }}" \
              --parameters enableAIFactoryCreatedDefaultProjectForAIFv2="${{ env.enableAIFactoryCreatedDefaultProjectForAIFv2 }}" \
              --parameters containerAppsEnvExists="${{ env.containerAppsEnvExists }}" \
              --parameters enableCaphost="${{ env.enableAFoundryCaphost }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters apiManagementResourceId="${{ env.foundryApiManagementResourceId }}" \
              --parameters foundryV22AccountOnly="true" \
              --parameters cmk="${{ env.cmk }}" \
              --parameters cmkKeyName="${{ env.cmkKeyName }}" \
              --parameters cmkKeyVersion="${{ env.cmkKeyVersion }}" \
              --parameters addAISearch="${{ env.addAISearch }}" \
              --parameters enableAIFoundry="${{ env.enableAIFoundry }}" \
              --parameters aiFoundryV2Exists="${{ env.aiFoundryV2Exists }}" \
              --parameters aiFoundryV2ProjectExists="${{ env.aiFoundryV2ProjectExists }}" \
              --parameters useAVMFoundry="false" \
              --parameters updateAIFoundry="${{ env.updateAIFoundry }}" \
              --parameters enableDefenderforAISubLevel="${{ env.enableDefenderforAISubLevel }}" \
              --parameters enableDefenderforAIResourceLevel="${{ env.enableDefenderforAIResourceLevel }}" \
              --parameters addAIFoundry="${{ env.addAIFoundry }}" \
              --debug

      - name: 69-Rehydrate
        if: success() && env.deleteAllServicesForProject != 'true' && env.debug_disable_69_aifoundry_2025 != 'true' && env.aiFoundryV2Exists != 'true'
        shell: bash
        run: |
          echo "Rehydration takes 2.5 to 5 minutes to allow AI Foundry account to finish..."
          sleep 15

      - name: 69b-aifoundry-2025-2ndOption-AccountUpdate
        if: success() && env.deleteAllServicesForProject != 'true' && env.debug_disable_69_aifoundry_2025 != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            az deployment sub create \
              --name "esml-p${{ env.project_number_000 }}-${{ env.dev_test_prod }}-${{ env.admin_locationSuffix }}-${{ env.admin_prjResourceSuffix }}${{ env.admin_commonResourceSuffix }}PrjDepl-69-aif-b" \
              --subscription "${{ env.dev_test_prod_sub_id }}" \
              --location "${{ env.admin_location }}" \
              --template-file "azure-enterprise-scale-ml/environment_setup/aifactory/bicep/esml-genai-1/09-ai-foundry-2025-v4.bicep" \
              --parameters @"./aifactory/parameters/dynamicNetworkParams.json" \
              --parameters env="${{ env.dev_test_prod }}" \
              --parameters projectNumber="${{ env.project_number_000 }}" \
              --parameters location="${{ env.admin_location }}" \
              --parameters locationSuffix="${{ env.admin_locationSuffix }}" \
              --parameters commonResourceSuffix="${{ env.admin_commonResourceSuffix }}" \
              --parameters resourceSuffix="${{ env.admin_prjResourceSuffix }}" \
              --parameters enableAIFoundry="${{ env.enableAIFoundry }}" \
              --parameters enableAISearch="${{ env.enableAISearch }}" \
              --parameters enableCosmosDB="${{ env.enableCosmosDB }}" \
              --parameters deployModel_gpt_X="${{ env.deployModel_gpt_X }}" \
              --parameters modelGPTXName="${{ env.modelGPTXName }}" \
              --parameters modelGPTXVersion="${{ env.modelGPTXVersion }}" \
              --parameters modelGPTXSku="${{ env.modelGPTXSku }}" \
              --parameters modelGPTXCapacity="${{ env.modelGPTXCapacity }}" \
              --parameters deployModel_text_embedding_ada_002="${{ env.deployModel_text_embedding_ada_002 }}" \
              --parameters deployModel_text_embedding_3_large="${{ env.deployModel_text_embedding_3_large }}" \
              --parameters deployModel_text_embedding_3_small="${{ env.deployModel_text_embedding_3_small }}" \
              --parameters default_embedding_capacity="${{ env.default_embedding_capacity }}" \
              --parameters default_gpt_capacity="${{ env.default_gpt_capacity }}" \
              --parameters deployModel_gpt_4o="${{ env.deployModel_gpt_4o }}" \
              --parameters default_gpt_4o_version="${{ env.default_gpt_4o_version }}" \
              --parameters deployModel_gpt_4o_mini="${{ env.deployModel_gpt_4o_mini }}" \
              --parameters default_gpt_4o_mini_version="${{ env.default_gpt_4o_mini_version }}" \
              --parameters default_model_sku="${{ env.default_model_sku }}" \
              --parameters enablePublicAccessWithPerimeter="${{ env.enablePublicAccessWithPerimeter }}" \
              --parameters enablePublicGenAIAccess="${{ env.enablePublicGenAIAccess }}" \
              --parameters allowPublicAccessWhenBehindVnet="${{ env.allowPublicAccessWhenBehindVnet }}" \
              --parameters contributorRoleId="${{ env.BYO_CONTRIBUTOR_ROLE_ID }}" \
              --parameters IPwhiteList="${{ env.project_IP_whitelist }}" \
              --parameters centralDnsZoneByPolicyInHub="${{ env.centralDnsZoneByPolicyInHub }}" \
              --parameters vnetNameBase="${{ env.vnetNameBase }}" \
              --parameters vnetResourceGroup_param="${{ env.vnetResourceGroup_resolved }}" \
              --parameters vnetNameFull_param="${{ env.vnetNameFull_resolved }}" \
              --parameters network_env="${{ env.network_env }}" \
              --parameters common_subnet_name="${{ env.common_subnet_name }}" \
              --parameters subnetCommon="${{ env.subnetCommon }}" \
              --parameters privDnsSubscription_param="${{ env.privDnsSubscription_param }}" \
              --parameters privDnsResourceGroup_param="${{ env.privDnsResourceGroup_param }}" \
              --parameters commonResourceGroup_param="${{ env.commonResourceGroup_param }}" \
              --parameters tagsProject='${{ env.tagsProject }}' \
              --parameters aifactorySuffixRG="${{ env.admin_aifactorySuffixRG }}" \
              --parameters commonRGNamePrefix="${{ env.admin_aifactoryPrefixRG }}" \
              --parameters commonResourceName="${{ env.vnetResourceGroupBase }}" \
              --parameters aifactorySalt10char="${{ env.aifactory_salt_random }}" \
              --parameters randomValue="${{ env.deployment_random_value }}" \
              --parameters technicalAdminsObjectID="${{ env.technical_admins_ad_object_id }}" \
              --parameters technicalAdminsEmail="${{ env.technical_admins_email }}" \
              --parameters subscriptionIdDevTestProd="${{ env.dev_test_prod_sub_id }}" \
              --parameters projectPrefix="${{ env.projectPrefix }}" \
              --parameters projectSuffix="${{ env.projectSuffix }}" \
              --parameters inputKeyvault="${{ env.admin_bicep_kv_fw }}" \
              --parameters inputKeyvaultResourcegroup="${{ env.admin_bicep_kv_fw_rg }}" \
              --parameters inputKeyvaultSubscription="${{ env.admin_bicep_input_keyvault_subscription }}" \
              --parameters projectServicePrincipleOID_SeedingKeyvaultName="${{ env.project_service_principal_OID_seeding_kv_name }}" \
              --parameters useAdGroups="${{ env.use_groups }}" \
              --parameters disableAgentNetworkInjection="${{ env.disableAgentNetworkInjection }}" \
              --parameters enableAIFactoryCreatedDefaultProjectForAIFv2="${{ env.enableAIFactoryCreatedDefaultProjectForAIFv2 }}" \
              --parameters containerAppsEnvExists="${{ env.containerAppsEnvExists }}" \
              --parameters enableCaphost="${{ env.enableAFoundryCaphost }}" \
              --parameters diagnosticSettingLevel="${{ env.diagnosticSettingLevel }}" \
              --parameters apiManagementResourceId="${{ env.foundryApiManagementResourceId }}" \
              --parameters foundryV22AccountOnly="false" \
              --parameters cmk="${{ env.cmk }}" \
              --parameters cmkKeyName="${{ env.cmkKeyName }}" \
              --parameters cmkKeyVersion="${{ env.cmkKeyVersion }}" \
              --parameters addAISearch="${{ env.addAISearch }}" \
              --parameters useAVMFoundry="false" \
              --parameters updateAIFoundry="${{ env.updateAIFoundry }}" \
              --parameters aiFoundryV2Exists="${{ env.aiFoundryV2Exists }}" \
              --parameters aiFoundryV2ProjectExists="${{ env.aiFoundryV2ProjectExists }}" \
              --parameters enableDefenderforAISubLevel="${{ env.enableDefenderforAISubLevel }}" \
              --parameters enableDefenderforAIResourceLevel="${{ env.enableDefenderforAIResourceLevel }}" \
              --parameters addAIFoundry="${{ env.addAIFoundry }}"

      - name: Foundry agent (optional)
        if: success() && env.deleteAllServicesForProject != 'true' && env.enableAIFoundry == 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.dev_test_prod_sub_id }}"
            projectNumber="${{ env.project_number_000 }}"
            projectName="prj${projectNumber}"
            locationSuffix="${{ env.admin_locationSuffix }}"
            envName="${{ env.dev_test_prod }}"
            projectPrefix="${{ env.projectPrefix }}"
            projectSuffix="${{ env.projectSuffix }}"
            projectNameReplaced="${projectName/prj/project}"
            projectRG="${{ env.admin_aifactoryPrefixRG }}${projectPrefix}${projectNameReplaced}-${locationSuffix}-${envName}${{ env.admin_aifactorySuffixRG }}${projectSuffix}"
            foundry=$(az cognitiveservices account list --subscription "${{ env.dev_test_prod_sub_id }}" --resource-group "$projectRG" --query "[?starts_with(name, 'aif2')].[name,resourceGroup]" -o tsv | head -n1)
            foundryName=$(echo "$foundry" | cut -f1)
            foundryRg=$(echo "$foundry" | cut -f2)
            if [ -z "$foundryName" ]; then echo "No Foundry found; skipping agent"; exit 0; fi
            endpoint=$(az cognitiveservices account show --name "$foundryName" --resource-group "$foundryRg" --query properties.endpoint -o tsv)
            access_token=$(az account get-access-token --resource https://cognitiveservices.azure.com/ --query accessToken -o tsv)
            payload='{"name":"agent-001","model":"gpt-4o-mini","description":"Created by workflow","metadata":{"source":"gha"}}'
            curl -sS -X POST "$endpoint/openai/agents?api-version=2024-10-01-preview" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $access_token" \
              -d "$payload" || true

      - name: Remove runner IP from seeding Key Vault
        if: always() && env.disable_whitelisting_for_build_agents != 'true'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set --subscription "${{ env.admin_bicep_input_keyvault_subscription }}"
            az keyvault network-rule remove \
              --resource-group "${{ env.admin_bicep_kv_fw_rg }}" \
              --name "${{ env.admin_bicep_kv_fw }}" \
              --ip-address "${{ env.runner_ip }}" || true




