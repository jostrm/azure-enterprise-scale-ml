{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "14586901830359222866"
    }
  },
  "parameters": {
    "diagnosticSettingLevel": {
      "type": "string",
      "defaultValue": "silver",
      "allowedValues": [
        "gold",
        "silver",
        "bronze"
      ],
      "metadata": {
        "description": "Diagnostic setting level for monitoring and logging"
      }
    },
    "env": {
      "type": "string",
      "allowedValues": [
        "dev",
        "test",
        "prod"
      ],
      "metadata": {
        "description": "Environment: dev, test, prod"
      }
    },
    "projectNumber": {
      "type": "string",
      "metadata": {
        "description": "Project number (e.g., \"005\")"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "locationSuffix": {
      "type": "string",
      "metadata": {
        "description": "Location suffix (e.g., \"weu\", \"swc\")"
      }
    },
    "commonResourceSuffix": {
      "type": "string",
      "metadata": {
        "description": "Common resource suffix (e.g., \"-001\")"
      }
    },
    "aifactorySuffixRG": {
      "type": "string"
    },
    "resourceSuffix": {
      "type": "string",
      "metadata": {
        "description": "Project-specific resource suffix"
      }
    },
    "aifactorySalt10char": {
      "type": "string",
      "defaultValue": ""
    },
    "randomValue": {
      "type": "string"
    },
    "technicalAdminsObjectID": {
      "type": "string",
      "defaultValue": ""
    },
    "technicalAdminsEmail": {
      "type": "string",
      "defaultValue": ""
    },
    "subscriptionIdDevTestProd": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]"
    },
    "genaiSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Required subnet IDs from subnet calculator"
      }
    },
    "aksSubnetId": {
      "type": "string"
    },
    "acaSubnetId": {
      "type": "string"
    },
    "aca2SubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional subnets from subnet calculator"
      }
    },
    "aks2SubnetId": {
      "type": "string",
      "defaultValue": ""
    },
    "dbxPubSubnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "if projectype is not genai-1, but instead all"
      }
    },
    "dbxPrivSubnetName": {
      "type": "string",
      "defaultValue": ""
    },
    "commonRGNamePrefix": {
      "type": "string"
    },
    "enableAzureMachineLearning": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure Machine Learning deployment"
      }
    },
    "enableDatafactory": {
      "type": "bool",
      "defaultValue": false
    },
    "enableAIFoundryHub": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable AI Foundry Hub deployment"
      }
    },
    "addAIFoundryHub": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Add AI Foundry Hub with random naming for debugging/testing"
      }
    },
    "addAzureMachineLearning": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Add Azure Machine Learning with random naming for debugging/testing"
      }
    },
    "enableAIFoundryV2": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable AI Foundry V2 deployment"
      }
    },
    "enableAIFoundryV21": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable AI Foundry V21 deployment"
      }
    },
    "addAISearch": {
      "type": "bool",
      "defaultValue": false
    },
    "enableAIServices": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable AI Services deployment"
      }
    },
    "enableAISearch": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable AI Search deployment"
      }
    },
    "enableAzureOpenAI": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure OpenAI deployment"
      }
    },
    "enableAzureAIVision": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure AI Vision deployment"
      }
    },
    "enableAzureSpeech": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure Speech deployment"
      }
    },
    "enableAIDocIntelligence": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable AI Document Intelligence deployment"
      }
    },
    "enableFunction": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure Function deployment"
      }
    },
    "enableWebApp": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure Web App deployment"
      }
    },
    "enableContainerApps": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Container Apps deployment"
      }
    },
    "enableAppInsightsDashboard": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Application Insights Dashboard deployment"
      }
    },
    "enableCosmosDB": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Cosmos DB deployment"
      }
    },
    "enablePostgreSQL": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable PostgreSQL deployment"
      }
    },
    "enableRedisCache": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Redis Cache deployment"
      }
    },
    "enableSQLDatabase": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable SQL Database deployment"
      }
    },
    "addBastionHost": {
      "type": "bool",
      "defaultValue": false
    },
    "bastionResourceGroup": {
      "type": "string",
      "defaultValue": ""
    },
    "bastionSubscription": {
      "type": "string",
      "defaultValue": ""
    },
    "bastionName": {
      "type": "string",
      "defaultValue": ""
    },
    "vnetNameFullBastion": {
      "type": "string",
      "defaultValue": ""
    },
    "disableContributorAccessForUsers": {
      "type": "bool",
      "defaultValue": false
    },
    "disableRBACAdminOnRGForUsers": {
      "type": "bool",
      "defaultValue": false
    },
    "vnetNameBase": {
      "type": "string"
    },
    "vnetResourceGroup_param": {
      "type": "string",
      "defaultValue": ""
    },
    "vnetNameFull_param": {
      "type": "string",
      "defaultValue": ""
    },
    "network_env": {
      "type": "string",
      "defaultValue": ""
    },
    "centralDnsZoneByPolicyInHub": {
      "type": "bool",
      "defaultValue": false
    },
    "privDnsSubscription_param": {
      "type": "string",
      "defaultValue": ""
    },
    "privDnsResourceGroup_param": {
      "type": "string",
      "defaultValue": ""
    },
    "commonResourceGroup_param": {
      "type": "string",
      "defaultValue": ""
    },
    "projectPrefix": {
      "type": "string",
      "defaultValue": "esml-"
    },
    "projectSuffix": {
      "type": "string",
      "defaultValue": "-rg"
    },
    "inputKeyvault": {
      "type": "string"
    },
    "inputKeyvaultResourcegroup": {
      "type": "string"
    },
    "inputKeyvaultSubscription": {
      "type": "string"
    },
    "projectServicePrincipleOID_SeedingKeyvaultName": {
      "type": "string"
    },
    "useAdGroups": {
      "type": "bool",
      "defaultValue": true
    },
    "azureMachineLearningObjectId": {
      "type": "string",
      "defaultValue": ""
    },
    "datalakeName_param": {
      "type": "string",
      "defaultValue": ""
    },
    "commonLakeNamePrefixMax8chars": {
      "type": "string"
    },
    "useCommonACR": {
      "type": "bool",
      "defaultValue": true
    },
    "tagsProject": {
      "type": "object",
      "defaultValue": {}
    },
    "tags": {
      "type": "object",
      "defaultValue": {}
    },
    "updateRbac": {
      "type": "bool",
      "defaultValue": false
    },
    "amlExists": {
      "type": "bool",
      "defaultValue": false
    },
    "aksExists": {
      "type": "bool",
      "defaultValue": false
    },
    "aiHubExists": {
      "type": "bool",
      "defaultValue": false
    },
    "aiServicesExists": {
      "type": "bool",
      "defaultValue": false
    },
    "aiSearchExists": {
      "type": "bool",
      "defaultValue": false
    },
    "dataFactoryExists": {
      "type": "bool",
      "defaultValue": false
    },
    "openaiExists": {
      "type": "bool",
      "defaultValue": false
    },
    "skipExistingRoleAssignments": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Skip role assignments if they already exist (helps with re-runs)"
      }
    },
    "forceRecreateRoleAssignments": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Force recreation of role assignments (use with caution)"
      }
    },
    "deploymentId": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMddHHmmss')]",
      "metadata": {
        "description": "Unique deployment identifier to avoid conflicts"
      }
    },
    "commonResourceName": {
      "type": "string",
      "defaultValue": "esml-common",
      "metadata": {
        "description": "Common resource name identifier. Default is \"esml-common\""
      }
    }
  },
  "variables": {
    "prjResourceSuffixNoDash": "[replace(parameters('resourceSuffix'), '-', '')]",
    "randomSalt": "[if(or(empty(parameters('aifactorySalt10char')), lessOrEquals(length(parameters('aifactorySalt10char')), 5)), substring(parameters('randomValue'), 0, 10), parameters('aifactorySalt10char'))]",
    "deploymentProjSpecificUniqueSuffix": "[format('{0}-{1}-{2}-{3}', variables('projectName'), parameters('env'), parameters('randomValue'), parameters('deploymentId'))]",
    "cleanRandomValue2": "[take(variables('randomSalt'), 2)]",
    "projectResourceGroup_rgId": "[resourceId(parameters('subscriptionIdDevTestProd'), 'Microsoft.Resources/resourceGroups', variables('targetResourceGroup'))]",
    "datalakeName": "[if(not(equals(parameters('datalakeName_param'), '')), parameters('datalakeName_param'), format('{0}{1}esml{2}{3}', parameters('commonLakeNamePrefixMax8chars'), variables('uniqueInAIFenv_Static'), replace(parameters('commonResourceSuffix'), '-', ''), parameters('env')))]",
    "projectName": "[format('prj{0}', parameters('projectNumber'))]",
    "commonResourceGroup": "[if(not(empty(parameters('commonResourceGroup_param'))), parameters('commonResourceGroup_param'), format('{0}{1}-{2}-{3}{4}', parameters('commonRGNamePrefix'), parameters('commonResourceName'), parameters('locationSuffix'), parameters('env'), parameters('aifactorySuffixRG')))]",
    "targetResourceGroup": "[format('{0}{1}{2}-{3}-{4}{5}{6}', parameters('commonRGNamePrefix'), parameters('projectPrefix'), replace(variables('projectName'), 'prj', 'project'), parameters('locationSuffix'), parameters('env'), parameters('aifactorySuffixRG'), parameters('projectSuffix'))]",
    "vnetNameFull": "[if(not(empty(parameters('vnetNameFull_param'))), replace(parameters('vnetNameFull_param'), '<network_env>', parameters('network_env')), format('{0}-{1}-{2}{3}', parameters('vnetNameBase'), parameters('locationSuffix'), parameters('env'), parameters('commonResourceSuffix')))]",
    "vnetResourceGroupName": "[if(not(empty(parameters('vnetResourceGroup_param'))), replace(parameters('vnetResourceGroup_param'), '<network_env>', parameters('network_env')), variables('commonResourceGroup'))]",
    "privDnsResourceGroupName": "[if(and(not(empty(parameters('privDnsResourceGroup_param'))), parameters('centralDnsZoneByPolicyInHub')), parameters('privDnsResourceGroup_param'), variables('vnetResourceGroupName'))]",
    "privDnsSubscription": "[if(and(not(empty(parameters('privDnsSubscription_param'))), parameters('centralDnsZoneByPolicyInHub')), parameters('privDnsSubscription_param'), subscription().subscriptionId)]",
    "uniqueInAIFenv_Static": "[substring(uniqueString(subscriptionResourceId(parameters('subscriptionIdDevTestProd'), 'Microsoft.Resources/resourceGroups', variables('commonResourceGroup'))), 0, 5)]",
    "cleanRandomValue": "[take(variables('randomSalt'), 2)]",
    "amlWithRandom": "[take(format('aml-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), variables('cleanRandomValue'), parameters('resourceSuffix')), 64)]",
    "amlName_Static": "[if(parameters('addAzureMachineLearning'), variables('amlWithRandom'), format('aml-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('resourceSuffix')))]",
    "aifWithRandom": "[take(format('aif-hub-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), variables('cleanRandomValue'), parameters('resourceSuffix')), 64)]",
    "aiHubName_Static": "[if(parameters('addAIFoundryHub'), variables('aifWithRandom'), format('aif-hub-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('resourceSuffix')))]",
    "aiHubProjectName_Static": "[format('aif-p-{0}-1-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('resourceSuffix'))]",
    "openAIName_Static": "[format('aoai-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('resourceSuffix'))]",
    "aiServicesName_Static": "[replace(toLower(format('aiservices{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), variables('randomSalt'), variables('prjResourceSuffixNoDash'))), '-', '')]",
    "aiSearchName_Static": "[if(parameters('addAISearch'), replace(toLower(format('aisearch{0}{1}{2}{3}{4}{5}{6}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), variables('randomSalt'), variables('cleanRandomValue'), parameters('resourceSuffix'))), '-', ''), replace(toLower(format('aisearch{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), variables('randomSalt'), parameters('resourceSuffix'))), '-', ''))]",
    "visionName_Static": "[format('vision-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('commonResourceSuffix'))]",
    "speechName_Static": "[format('speech-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('commonResourceSuffix'))]",
    "docsName_Static": "[format('docs-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('commonResourceSuffix'))]",
    "subnetIdParts": "[split(parameters('genaiSubnetId'), '/')]",
    "subnetSubscriptionId": "[variables('subnetIdParts')[2]]",
    "subnetResourceGroup": "[variables('subnetIdParts')[4]]",
    "subnetVNetName": "[variables('subnetIdParts')[8]]",
    "subnetName": "[variables('subnetIdParts')[10]]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-naming-{0}', variables('targetResourceGroup')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "env": {
            "value": "[parameters('env')]"
          },
          "projectNumber": {
            "value": "[parameters('projectNumber')]"
          },
          "locationSuffix": {
            "value": "[parameters('locationSuffix')]"
          },
          "commonResourceSuffix": {
            "value": "[parameters('commonResourceSuffix')]"
          },
          "resourceSuffix": {
            "value": "[parameters('resourceSuffix')]"
          },
          "aifactorySalt10char": {
            "value": "[parameters('aifactorySalt10char')]"
          },
          "randomValue": {
            "value": "[parameters('randomValue')]"
          },
          "aifactorySuffixRG": {
            "value": "[parameters('aifactorySuffixRG')]"
          },
          "commonRGNamePrefix": {
            "value": "[parameters('commonRGNamePrefix')]"
          },
          "technicalAdminsObjectID": {
            "value": "[parameters('technicalAdminsObjectID')]"
          },
          "technicalAdminsEmail": {
            "value": "[parameters('technicalAdminsEmail')]"
          },
          "commonResourceGroupName": {
            "value": "[variables('commonResourceGroup')]"
          },
          "subscriptionIdDevTestProd": {
            "value": "[parameters('subscriptionIdDevTestProd')]"
          },
          "acaSubnetId": {
            "value": "[parameters('acaSubnetId')]"
          },
          "aksSubnetId": {
            "value": "[parameters('aksSubnetId')]"
          },
          "genaiSubnetId": {
            "value": "[parameters('genaiSubnetId')]"
          },
          "aca2SubnetId": {
            "value": "[parameters('aca2SubnetId')]"
          },
          "aks2SubnetId": {
            "value": "[parameters('aks2SubnetId')]"
          },
          "addAIFoundryHub": {
            "value": "[parameters('addAIFoundryHub')]"
          },
          "addAzureMachineLearning": {
            "value": "[parameters('addAzureMachineLearning')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14620113903890155467"
            }
          },
          "definitions": {
            "aifactoryNamingType": {
              "type": "object",
              "properties": {
                "genaiSubnetName": {
                  "type": "string"
                },
                "aksSubnetName": {
                  "type": "string"
                },
                "aks2SubnetName": {
                  "type": "string"
                },
                "acaSubnetName": {
                  "type": "string"
                },
                "aca2SubnetName": {
                  "type": "string"
                },
                "defaultSubnet": {
                  "type": "string"
                },
                "aifV1HubName": {
                  "type": "string"
                },
                "aifV1ProjectName": {
                  "type": "string"
                },
                "aifV2Name": {
                  "type": "string"
                },
                "aifV2PrjName": {
                  "type": "string"
                },
                "aoaiName": {
                  "type": "string"
                },
                "amlName": {
                  "type": "string"
                },
                "safeNameAISearch": {
                  "type": "string"
                },
                "aiServicesName": {
                  "type": "string"
                },
                "dashboardInsightsName": {
                  "type": "string"
                },
                "applicationInsightName": {
                  "type": "string"
                },
                "applicationInsightName2": {
                  "type": "string"
                },
                "bingName": {
                  "type": "string"
                },
                "containerAppsEnvName": {
                  "type": "string"
                },
                "containerAppAName": {
                  "type": "string"
                },
                "containerAppWName": {
                  "type": "string"
                },
                "cosmosDBName": {
                  "type": "string"
                },
                "redisName": {
                  "type": "string"
                },
                "postgreSQLName": {
                  "type": "string"
                },
                "sqlServerName": {
                  "type": "string"
                },
                "sqlDBName": {
                  "type": "string"
                },
                "functionAppName": {
                  "type": "string"
                },
                "webAppName": {
                  "type": "string"
                },
                "funcAppServicePlanName": {
                  "type": "string"
                },
                "webbAppServicePlanName": {
                  "type": "string"
                },
                "vmName": {
                  "type": "string"
                },
                "keyvaultName": {
                  "type": "string"
                },
                "storageAccount1001Name": {
                  "type": "string"
                },
                "storageAccount2001Name": {
                  "type": "string"
                },
                "acrProjectName": {
                  "type": "string"
                },
                "acrCommonName": {
                  "type": "string"
                },
                "miACAName": {
                  "type": "string"
                },
                "miPrjName": {
                  "type": "string"
                },
                "laWorkspaceName": {
                  "type": "string"
                },
                "projectName": {
                  "type": "string"
                },
                "cmnName": {
                  "type": "string"
                },
                "kvNameCommon": {
                  "type": "string"
                },
                "genaiName": {
                  "type": "string"
                },
                "prjResourceSuffixNoDash": {
                  "type": "string"
                },
                "twoNumbers": {
                  "type": "string"
                },
                "p011_genai_team_lead_array": {
                  "type": "array"
                },
                "p011_genai_team_lead_email_array": {
                  "type": "array"
                },
                "uniqueInAIFenv": {
                  "type": "string"
                },
                "randomSalt": {
                  "type": "string"
                },
                "projectTypeESMLName": {
                  "type": "string"
                },
                "projectTypeGenAIName": {
                  "type": "string"
                },
                "aksClusterName": {
                  "type": "string"
                },
                "dataFactoryName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../types/aifactoryNaming.bicep"
                }
              }
            }
          },
          "parameters": {
            "env": {
              "type": "string",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Environment: dev, test, prod"
              }
            },
            "projectNumber": {
              "type": "string",
              "metadata": {
                "description": "Project number (e.g., \"005\")"
              }
            },
            "locationSuffix": {
              "type": "string",
              "metadata": {
                "description": "Location suffix (e.g., \"weu\", \"swc\")"
              }
            },
            "commonResourceSuffix": {
              "type": "string",
              "metadata": {
                "description": "Common resource suffix (e.g., \"-001\")"
              }
            },
            "resourceSuffix": {
              "type": "string",
              "metadata": {
                "description": "Project-specific resource suffix"
              }
            },
            "aifactorySalt10char": {
              "type": "string",
              "metadata": {
                "description": "Random salt for unique naming"
              }
            },
            "randomValue": {
              "type": "string"
            },
            "aifactorySuffixRG": {
              "type": "string",
              "metadata": {
                "description": "AI Factory suffix for resource groups"
              }
            },
            "commonRGNamePrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Common resource group name prefix"
              }
            },
            "technicalAdminsObjectID": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "User Admins OID list"
              }
            },
            "technicalAdminsEmail": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "User Admins EMAIL list"
              }
            },
            "commonResourceGroupName": {
              "type": "string"
            },
            "subscriptionIdDevTestProd": {
              "type": "string"
            },
            "genaiSubnetId": {
              "type": "string"
            },
            "aksSubnetId": {
              "type": "string"
            },
            "aks2SubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "acaSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "aca2SubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "postGresAdminEmails": {
              "type": "string",
              "defaultValue": ""
            },
            "addAIFoundryHub": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Add AI Foundry Hub with random naming for debugging/testing"
              }
            },
            "addAzureMachineLearning": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Add Azure Machine Learning with random naming for debugging/testing"
              }
            }
          },
          "variables": {
            "projectName": "[format('prj{0}', parameters('projectNumber'))]",
            "cmnName": "cmn",
            "genaiName": "genai",
            "prjResourceSuffixNoDash": "[replace(parameters('resourceSuffix'), '-', '')]",
            "twoNumbers": "[substring(parameters('resourceSuffix'), 2, 2)]",
            "resourceSuffixPlusOne": "[format('-{0}', padLeft(string(add(int(substring(parameters('resourceSuffix'), 1, 3)), 1)), 3, '0'))]",
            "technicalAdminsObjectID_array": "[array(split(replace(parameters('technicalAdminsObjectID'), '\\s+', ''), ','))]",
            "p011_genai_team_lead_array": "[if(empty(parameters('technicalAdminsObjectID')), createArray(), union(variables('technicalAdminsObjectID_array'), createArray()))]",
            "postGresAdminEmailsLocal_array": "[array(split(replace(parameters('postGresAdminEmails'), '\\s+', ''), ','))]",
            "postGresAdminEmailsLocal": "[if(empty(parameters('postGresAdminEmails')), createArray(), union(variables('postGresAdminEmailsLocal_array'), createArray()))]",
            "technicalAdminsEmail_array": "[array(split(parameters('technicalAdminsEmail'), ','))]",
            "p011_genai_team_lead_email_array": "[if(empty(parameters('technicalAdminsEmail')), createArray(), variables('technicalAdminsEmail_array'))]",
            "randomSalt": "[if(or(empty(parameters('aifactorySalt10char')), lessOrEquals(length(parameters('aifactorySalt10char')), 5)), substring(parameters('randomValue'), 0, 10), parameters('aifactorySalt10char'))]",
            "uniqueInAIFenv": "[substring(uniqueString(subscriptionResourceId(parameters('subscriptionIdDevTestProd'), 'Microsoft.Resources/resourceGroups', parameters('commonResourceGroupName'))), 0, 5)]",
            "cleanRandomValue": "[toLower(replace(replace(variables('randomSalt'), '-', ''), '_', ''))]",
            "aifRandom": "[take(variables('cleanRandomValue'), 2)]",
            "aifWithRandom": "[take(format('aif-hub-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('aifRandom'), parameters('resourceSuffix')), 64)]",
            "aifV1HubName": "[if(parameters('addAIFoundryHub'), variables('aifWithRandom'), format('aif-hub-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix')))]",
            "aifV1ProjectName": "[format('aif-p-{0}-1-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "aifV2Name": "[take(replace(toLower(format('aif2{0}{1}', variables('uniqueInAIFenv'), variables('randomSalt'))), '-', ''), 12)]",
            "aifV2PrjName": "[take(replace(toLower(format('aif2p{0}{1}', variables('uniqueInAIFenv'), variables('randomSalt'))), '-', ''), 12)]",
            "aoaiName": "[format('aoai-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "amlWithRandom": "[take(format('aml-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('aifRandom'), parameters('resourceSuffix')), 64)]",
            "amlName": "[if(parameters('addAzureMachineLearning'), variables('amlWithRandom'), format('aml-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix')))]",
            "safeNameAISearch": "[take(replace(toLower(format('aisearch{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('prjResourceSuffixNoDash'))), '-', ''), 64)]",
            "aiServicesName": "[take(replace(toLower(format('aiservices{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('prjResourceSuffixNoDash'))), '-', ''), 64)]",
            "dashboardInsightsName": "[format('AIFactory{0}-{1}-insights-{2}-{3}{4}', parameters('aifactorySuffixRG'), variables('projectName'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "applicationInsightName": "[format('ain-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "applicationInsightName2": "[format('ain-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('resourceSuffixPlusOne'))]",
            "bingName": "[format('bing-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppsEnvName": "[format('aca-env-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppAName": "[format('aca-a-{0}{1}{2}{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppWName": "[format('aca-w-{0}{1}{2}{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "cosmosDBName": "[format('cosmos-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "redisName": "[format('redis-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "postgreSQLName": "[format('pg-flex-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "sqlServerName": "[format('sql-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "sqlDBName": "[format('sqldb-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "functionAppName": "[format('func-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "webAppName": "[format('webapp-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "funcAppServicePlanName": "[format('func-{0}-{1}-{2}-{3}{4}-plan', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "webbAppServicePlanName": "[format('webapp-{0}-{1}-{2}-{3}{4}-plan', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "vmName": "[format('dsvm-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "keyvaultName": "[format('kv-p{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('twoNumbers'))]",
            "storageAccount1001Name": "[replace(format('sa{0}{1}{2}1{3}{4}', variables('projectName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), variables('prjResourceSuffixNoDash'), parameters('env')), '-', '')]",
            "storageAccount2001Name": "[replace(format('sa{0}{1}{2}2{3}{4}', variables('projectName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), variables('prjResourceSuffixNoDash'), parameters('env')), '-', '')]",
            "acrProjectName": "[format('acr{0}{1}{2}{3}{4}{5}', variables('projectName'), variables('genaiName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), parameters('env'), variables('prjResourceSuffixNoDash'))]",
            "acrCommonName": "[replace(format('acrcommon{0}{1}{2}{3}', variables('uniqueInAIFenv'), parameters('locationSuffix'), parameters('commonResourceSuffix'), parameters('env')), '-', '')]",
            "miACAName": "[format('mi-aca-{0}-{1}-{2}-{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), parameters('resourceSuffix'))]",
            "miPrjName": "[format('mi-{0}-{1}-{2}-{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), parameters('resourceSuffix'))]",
            "laWorkspaceName": "[format('la-{0}-{1}-{2}-{3}{4}', variables('cmnName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]",
            "segments": "[split(parameters('genaiSubnetId'), '/')]",
            "genaiSubnetName": "[variables('segments')[sub(length(variables('segments')), 1)]]",
            "defaultSubnet": "[variables('genaiSubnetName')]",
            "segmentsAKS": "[split(parameters('aksSubnetId'), '/')]",
            "segmentsAKS2": "[split(parameters('aks2SubnetId'), '/')]",
            "aksSubnetName": "[variables('segmentsAKS')[sub(length(variables('segmentsAKS')), 1)]]",
            "aks2SubnetName": "[variables('segmentsAKS2')[sub(length(variables('segmentsAKS2')), 1)]]",
            "segmentsACA": "[split(parameters('acaSubnetId'), '/')]",
            "segmentsACA2": "[split(parameters('aca2SubnetId'), '/')]",
            "acaSubnetName": "[variables('segmentsACA')[sub(length(variables('segmentsACA')), 1)]]",
            "aca2SubnetName": "[variables('segmentsACA2')[sub(length(variables('segmentsACA2')), 1)]]",
            "adfName": "[format('adf-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]"
          },
          "resources": {
            "commonResourceGroupRef": {
              "existing": true,
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-07-01",
              "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
              "name": "[parameters('commonResourceGroupName')]"
            }
          },
          "outputs": {
            "genaiSubnetName": {
              "type": "string",
              "value": "[variables('genaiSubnetName')]"
            },
            "aksSubnetName": {
              "type": "string",
              "value": "[variables('aksSubnetName')]"
            },
            "aks2SubnetName": {
              "type": "string",
              "value": "[variables('aks2SubnetName')]"
            },
            "acaSubnetName": {
              "type": "string",
              "value": "[variables('acaSubnetName')]"
            },
            "aca2SubnetName": {
              "type": "string",
              "value": "[variables('aca2SubnetName')]"
            },
            "defaultSubnet": {
              "type": "string",
              "value": "[variables('defaultSubnet')]"
            },
            "aoaiName": {
              "type": "string",
              "value": "[variables('aoaiName')]"
            },
            "amlName": {
              "type": "string",
              "value": "[variables('amlName')]"
            },
            "safeNameAISearch": {
              "type": "string",
              "value": "[variables('safeNameAISearch')]"
            },
            "aiServicesName": {
              "type": "string",
              "value": "[variables('aiServicesName')]"
            },
            "dashboardInsightsName": {
              "type": "string",
              "value": "[variables('dashboardInsightsName')]"
            },
            "applicationInsightName": {
              "type": "string",
              "value": "[variables('applicationInsightName')]"
            },
            "applicationInsightName2": {
              "type": "string",
              "value": "[variables('applicationInsightName2')]"
            },
            "bingName": {
              "type": "string",
              "value": "[variables('bingName')]"
            },
            "containerAppsEnvName": {
              "type": "string",
              "value": "[variables('containerAppsEnvName')]"
            },
            "containerAppAName": {
              "type": "string",
              "value": "[variables('containerAppAName')]"
            },
            "containerAppWName": {
              "type": "string",
              "value": "[variables('containerAppWName')]"
            },
            "cosmosDBName": {
              "type": "string",
              "value": "[variables('cosmosDBName')]"
            },
            "redisName": {
              "type": "string",
              "value": "[variables('redisName')]"
            },
            "postgreSQLName": {
              "type": "string",
              "value": "[variables('postgreSQLName')]"
            },
            "sqlServerName": {
              "type": "string",
              "value": "[variables('sqlServerName')]"
            },
            "sqlDBName": {
              "type": "string",
              "value": "[variables('sqlDBName')]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[variables('functionAppName')]"
            },
            "webAppName": {
              "type": "string",
              "value": "[variables('webAppName')]"
            },
            "funcAppServicePlanName": {
              "type": "string",
              "value": "[variables('funcAppServicePlanName')]"
            },
            "webbAppServicePlanName": {
              "type": "string",
              "value": "[variables('webbAppServicePlanName')]"
            },
            "vmName": {
              "type": "string",
              "value": "[variables('vmName')]"
            },
            "aifV1HubName": {
              "type": "string",
              "value": "[variables('aifV1HubName')]"
            },
            "aifV1ProjectName": {
              "type": "string",
              "value": "[variables('aifV1ProjectName')]"
            },
            "aifV2Name": {
              "type": "string",
              "value": "[variables('aifV2Name')]"
            },
            "aifV2PrjName": {
              "type": "string",
              "value": "[variables('aifV2PrjName')]"
            },
            "keyvaultName": {
              "type": "string",
              "value": "[variables('keyvaultName')]"
            },
            "storageAccount1001Name": {
              "type": "string",
              "value": "[variables('storageAccount1001Name')]"
            },
            "storageAccount2001Name": {
              "type": "string",
              "value": "[variables('storageAccount2001Name')]"
            },
            "acrProjectName": {
              "type": "string",
              "value": "[variables('acrProjectName')]"
            },
            "acrCommonName": {
              "type": "string",
              "value": "[variables('acrCommonName')]"
            },
            "miACAName": {
              "type": "string",
              "value": "[variables('miACAName')]"
            },
            "miPrjName": {
              "type": "string",
              "value": "[variables('miPrjName')]"
            },
            "laWorkspaceName": {
              "type": "string",
              "value": "[variables('laWorkspaceName')]"
            },
            "projectName": {
              "type": "string",
              "value": "[variables('projectName')]"
            },
            "cmnName": {
              "type": "string",
              "value": "[variables('cmnName')]"
            },
            "kvNameCommon": {
              "type": "string",
              "value": "[format('kv-{0}{1}-{2}{3}', variables('cmnName'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]"
            },
            "genaiName": {
              "type": "string",
              "value": "[variables('genaiName')]"
            },
            "prjResourceSuffixNoDash": {
              "type": "string",
              "value": "[variables('prjResourceSuffixNoDash')]"
            },
            "twoNumbers": {
              "type": "string",
              "value": "[variables('twoNumbers')]"
            },
            "p011_genai_team_lead_array": {
              "type": "array",
              "value": "[variables('p011_genai_team_lead_array')]"
            },
            "postGresAdminEmails": {
              "type": "array",
              "value": "[variables('postGresAdminEmailsLocal')]"
            },
            "p011_genai_team_lead_email_array": {
              "type": "array",
              "value": "[variables('p011_genai_team_lead_email_array')]"
            },
            "uniqueInAIFenv": {
              "type": "string",
              "value": "[variables('uniqueInAIFenv')]"
            },
            "randomSalt": {
              "type": "string",
              "value": "[variables('randomSalt')]"
            },
            "projectTypeESMLName": {
              "type": "string",
              "value": "esml"
            },
            "projectTypeGenAIName": {
              "type": "string",
              "value": "genai"
            },
            "aksClusterName": {
              "type": "string",
              "value": "[format('esml{0}-{1}-{2}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'))]"
            },
            "dataFactoryName": {
              "type": "string",
              "value": "[variables('adfName')]"
            },
            "namingConvention": {
              "$ref": "#/definitions/aifactoryNamingType",
              "value": {
                "genaiSubnetName": "[variables('genaiSubnetName')]",
                "aksSubnetName": "[variables('aksSubnetName')]",
                "aks2SubnetName": "[variables('aks2SubnetName')]",
                "acaSubnetName": "[variables('acaSubnetName')]",
                "aca2SubnetName": "[variables('aca2SubnetName')]",
                "defaultSubnet": "[variables('defaultSubnet')]",
                "aifV1HubName": "[variables('aifV1HubName')]",
                "aifV1ProjectName": "[variables('aifV1ProjectName')]",
                "aifV2Name": "[variables('aifV2Name')]",
                "aifV2PrjName": "[variables('aifV2PrjName')]",
                "aoaiName": "[variables('aoaiName')]",
                "amlName": "[variables('amlName')]",
                "safeNameAISearch": "[variables('safeNameAISearch')]",
                "aiServicesName": "[variables('aiServicesName')]",
                "dashboardInsightsName": "[variables('dashboardInsightsName')]",
                "applicationInsightName": "[variables('applicationInsightName')]",
                "applicationInsightName2": "[variables('applicationInsightName2')]",
                "bingName": "[variables('bingName')]",
                "containerAppsEnvName": "[variables('containerAppsEnvName')]",
                "containerAppAName": "[variables('containerAppAName')]",
                "containerAppWName": "[variables('containerAppWName')]",
                "cosmosDBName": "[variables('cosmosDBName')]",
                "redisName": "[variables('redisName')]",
                "postgreSQLName": "[variables('postgreSQLName')]",
                "sqlServerName": "[variables('sqlServerName')]",
                "sqlDBName": "[variables('sqlDBName')]",
                "functionAppName": "[variables('functionAppName')]",
                "webAppName": "[variables('webAppName')]",
                "funcAppServicePlanName": "[variables('funcAppServicePlanName')]",
                "webbAppServicePlanName": "[variables('webbAppServicePlanName')]",
                "vmName": "[variables('vmName')]",
                "keyvaultName": "[variables('keyvaultName')]",
                "storageAccount1001Name": "[variables('storageAccount1001Name')]",
                "storageAccount2001Name": "[variables('storageAccount2001Name')]",
                "acrProjectName": "[variables('acrProjectName')]",
                "acrCommonName": "[variables('acrCommonName')]",
                "miACAName": "[variables('miACAName')]",
                "miPrjName": "[variables('miPrjName')]",
                "laWorkspaceName": "[variables('laWorkspaceName')]",
                "projectName": "[variables('projectName')]",
                "cmnName": "[variables('cmnName')]",
                "kvNameCommon": "[format('kv-{0}{1}-{2}{3}', variables('cmnName'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]",
                "genaiName": "[variables('genaiName')]",
                "prjResourceSuffixNoDash": "[variables('prjResourceSuffixNoDash')]",
                "twoNumbers": "[variables('twoNumbers')]",
                "p011_genai_team_lead_array": "[variables('p011_genai_team_lead_array')]",
                "p011_genai_team_lead_email_array": "[variables('p011_genai_team_lead_email_array')]",
                "uniqueInAIFenv": "[variables('uniqueInAIFenv')]",
                "randomSalt": "[variables('randomSalt')]",
                "projectTypeESMLName": "esml",
                "projectTypeGenAIName": "genai",
                "aksClusterName": "[format('esml{0}-{1}-{2}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'))]",
                "dataFactoryName": "[variables('adfName')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-getMI-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.miPrjName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "1018302119329499090"
            }
          },
          "parameters": {
            "managedIdentityName": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity name"
              }
            }
          },
          "resources": [],
          "outputs": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').clientId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Managed identity name"
              },
              "value": "[parameters('managedIdentityName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityOID": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-getMI-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.principalId.value]"
          },
          "servicePrincipleOIDFromSecret": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('inputKeyvaultSubscription'), parameters('inputKeyvaultResourcegroup')), 'Microsoft.KeyVault/vaults', parameters('inputKeyvault'))]"
              },
              "secretName": "[parameters('projectServicePrincipleOID_SeedingKeyvaultName')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4489054275663592001"
            }
          },
          "parameters": {
            "servicePrincipleOIDFromSecret": {
              "type": "securestring"
            },
            "managedIdentityOID": {
              "type": "string"
            }
          },
          "variables": {
            "toArray": [
              "[parameters('servicePrincipleOIDFromSecret')]",
              "[parameters('managedIdentityOID')]"
            ]
          },
          "resources": [],
          "outputs": {
            "spAndMiArray": {
              "type": "array",
              "value": "[variables('toArray')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-getMI-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(empty(parameters('bastionResourceGroup')), parameters('addBastionHost'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbac1GenAIRUsCmnKV{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('commonResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "common_kv_name": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.kvNameCommon.value]"
          },
          "user_object_ids": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "bastion_service_name": "[if(empty(parameters('bastionName')), createObject('value', format('bastion-{0}-{1}{2}', parameters('locationSuffix'), parameters('env'), parameters('commonResourceSuffix'))), createObject('value', parameters('bastionName')))]",
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "9895493337093229926"
            }
          },
          "parameters": {
            "common_kv_name": {
              "type": "string"
            },
            "user_object_ids": {
              "type": "array",
              "metadata": {
                "description": "Additional optional Object ID of more people to access Resource group"
              }
            },
            "bastion_service_name": {
              "type": "string"
            },
            "addBastion": {
              "type": "bool",
              "defaultValue": false
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "readerRoleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
          },
          "resources": [
            {
              "copy": {
                "name": "readerUserCommonKv",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('common_kv_name'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('common_kv_name'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleDefinitionId'))]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Reader to USER with OID  {0} for keyvault: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('common_kv_name'))]"
              }
            },
            {
              "copy": {
                "name": "readerUserBastion",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "condition": "[parameters('addBastion')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/bastionHosts/{0}', parameters('bastion_service_name'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('bastion_service_name'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleDefinitionId'))]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Reader to USER with OID  {0} for Bastion service: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('bastion_service_name'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('08-rbacGenAIUsVn{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacPrjKV{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.keyvaultName.value]"
          },
          "userObjectIds": {
            "value": []
          },
          "servicePrincipalIds": {
            "value": [
              "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value[0]]"
            ]
          },
          "managedIdentityIds": {
            "value": []
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11318105128575366960"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              }
            },
            "userObjectIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of user object IDs"
              }
            },
            "servicePrincipalIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of service principal object IDs"
              }
            },
            "managedIdentityIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of managed identity object IDs"
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Whether user principals are Azure AD Groups"
              }
            },
            "keyVaultAdministratorRoleId": {
              "type": "string",
              "defaultValue": "00482a5a-887f-4fb3-b363-3b7fe8e74483",
              "metadata": {
                "description": "Key Vault Administrator role ID - Full access"
              }
            },
            "keyVaultSecretsOfficerRoleId": {
              "type": "string",
              "defaultValue": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
              "metadata": {
                "description": "Key Vault Secrets Officer role ID - Manage secrets"
              }
            },
            "keyVaultSecretsUserRoleId": {
              "type": "string",
              "defaultValue": "4633458b-17de-408a-b874-0445c86b69e6",
              "metadata": {
                "description": "Key Vault Secrets User role ID - Read secrets"
              }
            },
            "keyVaultContributorRoleId": {
              "type": "string",
              "defaultValue": "f25e0fa2-a7c8-4377-a976-54943a77a395",
              "metadata": {
                "description": "Key Vault Contributor role ID - Management operations"
              }
            }
          },
          "resources": [
            {
              "copy": {
                "name": "keyVaultSecretsUserAssignments",
                "count": "[length(parameters('userObjectIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('userObjectIds')[copyIndex()], parameters('keyVaultSecretsUserRoleId'), string(copyIndex()))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultSecretsUserRoleId'))]",
                "principalId": "[parameters('userObjectIds')[copyIndex()]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]"
              }
            },
            {
              "copy": {
                "name": "keyVaultSecretsOfficerSpAssignments",
                "count": "[length(parameters('servicePrincipalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('servicePrincipalIds')[copyIndex()], parameters('keyVaultSecretsOfficerRoleId'), string(copyIndex()))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('servicePrincipalIds')[copyIndex()]]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "copy": {
                "name": "keyVaultSecretsOfficerMiAssignments",
                "count": "[length(parameters('managedIdentityIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('managedIdentityIds')[copyIndex()], parameters('keyVaultSecretsOfficerRoleId'), string(copyIndex()))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('managedIdentityIds')[copyIndex()]]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "rbacAssignmentsCompleted": {
              "type": "bool",
              "metadata": {
                "description": "Key Vault RBAC assignments completed successfully"
              },
              "value": true
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(add(length(parameters('userObjectIds')), length(parameters('servicePrincipalIds'))), length(parameters('managedIdentityIds')))]"
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(empty(parameters('bastionResourceGroup'))), not(empty(parameters('bastionSubscription'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbac2GenAIUsersBas{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('bastionSubscription')]",
      "resourceGroup": "[parameters('bastionResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "user_object_ids": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "bastion_service_name": "[if(empty(parameters('bastionName')), createObject('value', format('bastion-{0}-{1}{2}', parameters('locationSuffix'), parameters('env'), parameters('commonResourceSuffix'))), createObject('value', parameters('bastionName')))]",
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "8829912748312753645"
            }
          },
          "parameters": {
            "user_object_ids": {
              "type": "array",
              "metadata": {
                "description": "Additional optional Object ID of more people to access Resource group"
              }
            },
            "bastion_service_name": {
              "type": "string"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "readerRoleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
          },
          "resources": [
            {
              "copy": {
                "name": "readerUserBastion",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/bastionHosts/{0}', parameters('bastion_service_name'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('bastion_service_name'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleDefinitionId'))]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Reader to USER with OID  {0} for Bastion service: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('bastion_service_name'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('08-rbacGenAIUsVn{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-storageReader1001{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "aiProjectName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV1ProjectName.value]"
          },
          "blobPrivateEndpointName": {
            "value": "[format('{0}-blob-pend', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12058641796878832919"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name to assign Reader role for"
              }
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "AI Project name (Azure ML workspace name)"
              }
            },
            "blobPrivateEndpointName": {
              "type": "string",
              "metadata": {
                "description": "Blob private endpoint name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('blobPrivateEndpointName'))]",
              "name": "[guid(resourceId('Microsoft.Network/privateEndpoints', parameters('blobPrivateEndpointName')), resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName')), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7'), 'blob-reader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                "principalType": "ServicePrincipal",
                "principalId": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName')), '2025-07-01-preview', 'full').identity.principalId]"
              },
              "metadata": {
                "description": "Assign the AI Project system-assigned managed identity Reader role on the storage blob private endpoint."
              }
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name that was configured"
              },
              "value": "[parameters('storageAccountName')]"
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "AI Project name that was assigned the Reader role"
              },
              "value": "[parameters('aiProjectName')]"
            },
            "blobPrivateEndpointName": {
              "type": "string",
              "metadata": {
                "description": "Blob private endpoint name that was configured"
              },
              "value": "[parameters('blobPrivateEndpointName')]"
            },
            "roleAssignmentCompleted": {
              "type": "bool",
              "metadata": {
                "description": "Role assignment completed successfully"
              },
              "value": true
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-storageReader2001{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiProjectName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV1ProjectName.value]"
          },
          "blobPrivateEndpointName": {
            "value": "[format('{0}-blob-pend', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12058641796878832919"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name to assign Reader role for"
              }
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "AI Project name (Azure ML workspace name)"
              }
            },
            "blobPrivateEndpointName": {
              "type": "string",
              "metadata": {
                "description": "Blob private endpoint name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('blobPrivateEndpointName'))]",
              "name": "[guid(resourceId('Microsoft.Network/privateEndpoints', parameters('blobPrivateEndpointName')), resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName')), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7'), 'blob-reader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                "principalType": "ServicePrincipal",
                "principalId": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName')), '2025-07-01-preview', 'full').identity.principalId]"
              },
              "metadata": {
                "description": "Assign the AI Project system-assigned managed identity Reader role on the storage blob private endpoint."
              }
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name that was configured"
              },
              "value": "[parameters('storageAccountName')]"
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "AI Project name that was assigned the Reader role"
              },
              "value": "[parameters('aiProjectName')]"
            },
            "blobPrivateEndpointName": {
              "type": "string",
              "metadata": {
                "description": "Blob private endpoint name that was configured"
              },
              "value": "[parameters('blobPrivateEndpointName')]"
            },
            "roleAssignmentCompleted": {
              "type": "bool",
              "metadata": {
                "description": "Role assignment completed successfully"
              },
              "value": true
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(parameters('enableAzureOpenAI'), not(parameters('openaiExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbac3OpenAI{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiSearchName": "[if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), variables('cleanRandomValue2'), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', ''))]",
          "openAIServicePrincipal": "[if(and(not(parameters('openaiExists')), parameters('enableAzureOpenAI')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', variables('openAIName_Static')), '2024-10-01', 'full').identity.principalId), createObject('value', ''))]",
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "openAIName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aoaiName.value]"
          },
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "956532646074107392"
            }
          },
          "parameters": {
            "openAIServicePrincipal": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountName2": {
              "type": "string"
            },
            "aiSearchName": {
              "type": "string"
            },
            "openAIName": {
              "type": "string"
            },
            "userObjectIds": {
              "type": "array"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
            "searchIndexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
            "searchServiceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
            "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
            "cognitiveServicesOpenAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
            "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68",
            "cognitiveServicesUsagesReaderId": "bba48692-92b0-4667-a9ad-c31c7b334ac2"
          },
          "resources": [
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataContributorRoleId'), parameters('openAIServicePrincipal'))]",
              "properties": {
                "principalId": "[parameters('openAIServicePrincipal')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataContributorRoleId'))]",
                "description": "010"
              },
              "metadata": {
                "description": "Role Assignment for Azure AI Search: SearchIndexDataContributor for Azure OpenAI MI"
              }
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataReader'), resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), '2024-04-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataReader'))]",
                "description": "010"
              }
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchServiceContributorRoleId'), parameters('openAIServicePrincipal'))]",
              "properties": {
                "principalId": "[parameters('openAIServicePrincipal')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchServiceContributorRoleId'))]",
                "description": "012"
              },
              "metadata": {
                "description": "Role Assignment for Azure AI Search: SearchServiceContributor for Azure OpenAI MI"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('openAIServicePrincipal'))]",
              "properties": {
                "principalId": "[parameters('openAIServicePrincipal')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "013"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage: StorageBlobDataContributor for Azure OpenAI MI"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataContributorRoleId'), parameters('openAIServicePrincipal'))]",
              "properties": {
                "principalId": "[parameters('openAIServicePrincipal')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "014"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage 2: StorageBlobDataContributor for Azure OpenAI MI"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataContributorRoleId'), parameters('openAIServicePrincipal'))]",
              "properties": {
                "principalId": "[parameters('openAIServicePrincipal')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "description": "019b"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage: File Data Privileged Contributor for Azure OpenAI MI"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataContributorRoleId'), parameters('openAIServicePrincipal'))]",
              "properties": {
                "principalId": "[parameters('openAIServicePrincipal')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "description": "019a"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage 2: File Data Privileged Contributor for Azure OpenAI MI"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesContributorRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('023: cognitiveServicesContributor role to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('openAIName'))]"
              },
              "metadata": {
                "description": "Users to Azure AI Services: Cognitive Services Contributor for users. All, except: Access quota, Make inference API call with Microsoft Entra ID"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesContributorRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesContributor role to project service principal/Mi OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('openAIName'))]"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesUsagesReader",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesUsagesReaderId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesUsagesReaderId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('023: cognitiveServicesUsagesReaderId role to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('openAIName'))]"
              },
              "metadata": {
                "description": "Users to Azure AI Services: Cognitive Services Usage Reader for users. Only Access quota (Minimal permission to view Cognitive Services usages)"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesUsagesReaderSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesUsagesReaderId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesUsagesReaderId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesUsagesReader role to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('openAIName'))]"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesOpenAIContributorUsers",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesOpenAIContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('023: OpenAIContributorRole to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('openAIName'))]"
              },
              "metadata": {
                "description": "Users to Azure AI Services: Cognitive Services OpenAI Contributor for users. Full access including the ability to fine-tune, deploy and generate text"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesOpenAIContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesOpenAIContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesOpenAIContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('openAIName'))]"
              }
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesOpenAIContributorRoleId'), resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), '2024-03-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesOpenAIContributorRoleId to project service principal OID:{0} to {1}', reference(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), '2024-03-01-preview', 'full').identity.principalId, parameters('aiSearchName'))]"
              }
            },
            {
              "copy": {
                "name": "roleAssignmentCognitiveServicesOpenAIUsers",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesOpenAIUserRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIUserRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('024: OpenAICognitiveServicesUSer to USER with OID  {0} for : {1} to list API keys', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('openAIName'))]"
              },
              "metadata": {
                "description": "Users to Azure AI Services: Cognitive Services OpenAI User:Read access to view files, models, deployments. The ability to create completion and embedding calls."
              }
            },
            {
              "copy": {
                "name": "roleAssignmentCognitiveServicesOpenAISP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('openAIName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIName')), variables('cognitiveServicesOpenAIUserRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIUserRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesOpenAIUserRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('openAIName'))]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentSearchIndexDataContributorGUID": {
              "type": "string",
              "value": "[if(not(empty(parameters('aiSearchName'))), guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataContributorRoleId'), parameters('openAIServicePrincipal')), '')]"
            },
            "roleAssignmentSearchServiceContributorGUID": {
              "type": "string",
              "value": "[if(not(empty(parameters('aiSearchName'))), guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchServiceContributorRoleId'), parameters('openAIServicePrincipal')), '')]"
            },
            "roleAssignmentStorageBlobDataContributorGUID1": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('openAIServicePrincipal'))]"
            },
            "roleAssignmentStorageFileDataContributorGUID1": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataContributorRoleId'), parameters('openAIServicePrincipal'))]"
            },
            "roleAssignmentStorageBlobDataContributorGUID2": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataContributorRoleId'), parameters('openAIServicePrincipal'))]"
            },
            "roleAssignmentStorageFileDataContributorGUID2": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataContributorRoleId'), parameters('openAIServicePrincipal'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('08-rbacGenAIUsVn{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('aiServicesExists')), parameters('enableAIServices'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbac4AIServ{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiSearchName": "[if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), variables('cleanRandomValue2'), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', ''))]",
          "aiServicesPrincipalId": "[if(and(not(parameters('aiServicesExists')), parameters('enableAIServices')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', variables('aiServicesName_Static')), '2024-10-01', 'full').identity.principalId), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2090004415983565691"
            }
          },
          "parameters": {
            "aiServicesPrincipalId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountName2": {
              "type": "string"
            },
            "aiSearchName": {
              "type": "string"
            }
          },
          "variables": {
            "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c",
            "acrPushRoleId": "8311e382-0749-4cb8-b61a-304f252e45ec",
            "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
            "azureMLDataScientistRoleId": "f6c7c914-8db3-469d-8ca1-694a8f32e121",
            "azureAIDeveloperRoleId": "64702f94-c441-49e6-a78b-ef80e0188fee",
            "cognitiveServicesCustomVisionContributorRoleId": "c1ff6cc2-c111-46fe-8896-e0ef812ad9f3",
            "azureAIInferenceDeploymentOperatorRoleId": "3afb7f49-54cb-416e-8c09-6dc049efa503",
            "azureAIAdministrator": "b78c5d69-af96-48a3-bf8d-a8b4d589de94",
            "azureMachineLearningWorkspaceConnectionSecretsReaderRoleId": "ea01e6af-a1c1-4350-9563-ad00f8c72ec5",
            "azureMLMetricsWriter": "635dd51f-9968-44d3-b7fb-6d9a6bd613ae",
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
            "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
            "searchIndexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
            "searchServiceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
            "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908"
          },
          "resources": [
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataContributorRoleId'), parameters('aiServicesPrincipalId'))]",
              "properties": {
                "principalId": "[parameters('aiServicesPrincipalId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataContributorRoleId'))]",
                "description": "010"
              }
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataReader'), parameters('aiServicesPrincipalId'))]",
              "properties": {
                "principalId": "[parameters('aiServicesPrincipalId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataReader'))]",
                "description": "010"
              }
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchServiceContributorRoleId'), parameters('aiServicesPrincipalId'))]",
              "properties": {
                "principalId": "[parameters('aiServicesPrincipalId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchServiceContributorRoleId'))]",
                "description": "012"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiServicesPrincipalId'))]",
              "properties": {
                "principalId": "[parameters('aiServicesPrincipalId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "013"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataContributorRoleId'), parameters('aiServicesPrincipalId'))]",
              "properties": {
                "principalId": "[parameters('aiServicesPrincipalId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "014"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataContributorRoleId'), parameters('aiServicesPrincipalId'))]",
              "properties": {
                "principalId": "[parameters('aiServicesPrincipalId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "description": "019b"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataContributorRoleId'), parameters('aiServicesPrincipalId'))]",
              "properties": {
                "principalId": "[parameters('aiServicesPrincipalId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "description": "019a"
              }
            }
          ],
          "outputs": {
            "roleAssignmentSearchIndexDataContributorGUID": {
              "type": "string",
              "value": "[if(not(empty(parameters('aiSearchName'))), guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataContributorRoleId'), parameters('aiServicesPrincipalId')), '')]"
            },
            "roleAssignmentSearchServiceContributorGUID": {
              "type": "string",
              "value": "[if(not(empty(parameters('aiSearchName'))), guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchServiceContributorRoleId'), parameters('aiServicesPrincipalId')), '')]"
            },
            "roleAssignmentStorageBlobDataContributorGUID1": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiServicesPrincipalId'))]"
            },
            "roleAssignmentStorageFileDataContributorGUID1": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataContributorRoleId'), parameters('aiServicesPrincipalId'))]"
            },
            "roleAssignmentStorageBlobDataContributorGUID2": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataContributorRoleId'), parameters('aiServicesPrincipalId'))]"
            },
            "roleAssignmentStorageFileDataContributorGUID2": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataContributorRoleId'), parameters('aiServicesPrincipalId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('aiSearchExists')), parameters('enableAISearch'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbac5Search{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiServicesName": "[if(parameters('enableAIServices'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aiServicesName.value), createObject('value', ''))]",
          "aiSearchMIObjectId": "[if(and(not(parameters('aiSearchExists')), parameters('enableAISearch')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Search/searchServices', variables('aiSearchName_Static')), '2024-06-01-preview', 'full').identity.principalId), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2749312611289125324"
            }
          },
          "parameters": {
            "aiSearchMIObjectId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountName2": {
              "type": "string"
            },
            "aiServicesName": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataPrivilegedContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "cognitiveServicesOpenAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiSearchMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSearchMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "013"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataContributorRoleId'), parameters('aiSearchMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSearchMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "014"
              }
            },
            {
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesOpenAIContributorRoleId'), parameters('aiSearchMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSearchMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIContributorRoleId'))]",
                "description": "018"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataPrivilegedContributorRoleId'), parameters('aiSearchMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSearchMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataPrivilegedContributorRoleId'))]",
                "description": "019b"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataPrivilegedContributorRoleId'), parameters('aiSearchMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSearchMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataPrivilegedContributorRoleId'))]",
                "description": "019a"
              }
            }
          ],
          "outputs": {
            "roleAssignmentStorageBlobDataContributorName": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiSearchMIObjectId'))]"
            },
            "roleAssignmentCognitiveServicesOpenAIContributorName": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesOpenAIContributorRoleId'), parameters('aiSearchMIObjectId'))]"
            },
            "roleAssignmentStorageBlobDataContributorGUID": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiSearchMIObjectId'))]"
            },
            "roleAssignmentCognitiveServicesOpenAIContributorGUID": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesOpenAIContributorRoleId'), parameters('aiSearchMIObjectId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(and(not(parameters('aiHubExists')), not(empty(parameters('azureMachineLearningObjectId')))), parameters('enableAIFoundryHub'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbac6Aml2RG{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "azureMachineLearningObjectId": {
            "value": "[parameters('azureMachineLearningObjectId')]"
          },
          "aiHubName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV1HubName.value]"
          },
          "aiHubPrincipalId": "[if(and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.MachineLearningServices/workspaces', variables('aiHubName_Static')), '2024-10-01-preview', 'full').identity.principalId), createObject('value', ''))]",
          "aiHubProjectName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV1ProjectName.value]"
          },
          "aiHubProjectPrincipalId": "[if(and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.MachineLearningServices/workspaces', variables('aiHubProjectName_Static')), '2024-10-01-preview', 'full').identity.principalId), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "15693478761519950523"
            }
          },
          "parameters": {
            "azureMachineLearningObjectId": {
              "type": "string"
            },
            "aiHubName": {
              "type": "string",
              "defaultValue": ""
            },
            "aiHubPrincipalId": {
              "type": "string",
              "defaultValue": ""
            },
            "aiHubProjectName": {
              "type": "string",
              "defaultValue": ""
            },
            "aiHubProjectPrincipalId": {
              "type": "string",
              "defaultValue": ""
            },
            "aiSearchName": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "aml_appId": "0736f41a-0425-4b46-bdb5-1563eff02385",
            "azureAIAdministrator": "b78c5d69-af96-48a3-bf8d-a8b4d589de94",
            "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c",
            "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
            "searchServiceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
            "searchIndexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7"
          },
          "resources": [
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchServiceContributorRoleId'), resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchServiceContributorRoleId'))]",
                "principalId": "[parameters('aiHubProjectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "001 - searchServiceContributorRoleId to AI Hub project"
              },
              "metadata": {
                "description": "Role Assignment to Azure AI Search: SearchIndexDataContributor AI Hub project. Grants full access to Azure Cognitive Search index data"
              }
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataReader'), resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataReader'))]",
                "principalId": "[parameters('aiHubProjectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "002 - searchIndexDataReader to AI Hub project"
              },
              "metadata": {
                "description": "Role Assignment to Azure AI Search: searchIndexDataReader for users. \tGrants full access to Azure Cognitive Search index data"
              }
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataContributorRoleId'), resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataContributorRoleId'))]",
                "principalId": "[parameters('aiHubProjectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "003 - searchIndexDataContributorRoleId to AI Hub project"
              },
              "metadata": {
                "description": "Role Assignment to Azure AI Search: searchIndexDataReader for users. \tGrants full access to Azure Cognitive Search index data"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, variables('contributorRoleId'), parameters('azureMachineLearningObjectId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleId'))]",
                "principalId": "[parameters('azureMachineLearningObjectId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('010 - Contributor on RG for AML SP on RG: {0}', resourceGroup().id)]"
              },
              "metadata": {
                "description": "Role Assignment for ResoureGroup: AzureML OID for Contributor"
              }
            },
            {
              "condition": "[not(empty(parameters('aiHubName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, variables('contributorRoleId'), parameters('aiHubPrincipalId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleId'))]",
                "principalId": "[parameters('aiHubPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('011 - Contributor on RG for AI Hub: {0}', parameters('aiHubName'))]"
              },
              "metadata": {
                "description": "AI Hub: contributorRoleId:"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[or(and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub')), and(not(parameters('aiServicesExists')), parameters('enableAIServices')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacUsersAIHub{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiServicesName": "[if(parameters('enableAIServices'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aiServicesName.value), createObject('value', ''))]",
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "resourceGroupId": {
            "value": "[variables('projectResourceGroup_rgId')]"
          },
          "userObjectIds": {
            "value": "[union(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value)]"
          },
          "aiHubName": "[if(parameters('enableAIFoundryHub'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV1HubName.value), createObject('value', ''))]",
          "aiHubProjectName": "[if(parameters('enableAIFoundryHub'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV1ProjectName.value), createObject('value', ''))]",
          "servicePrincipleAndMIArray": {
            "value": "[union(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value)]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "disableContributorAccessForUsers": {
            "value": "[parameters('disableContributorAccessForUsers')]"
          },
          "disableRBACAdminOnRGForUsers": {
            "value": "[parameters('disableRBACAdminOnRGForUsers')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "857869172977761610"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountName2": {
              "type": "string"
            },
            "resourceGroupId": {
              "type": "string"
            },
            "userObjectIds": {
              "type": "array"
            },
            "aiServicesName": {
              "type": "string"
            },
            "aiHubName": {
              "type": "string"
            },
            "aiHubProjectName": {
              "type": "string"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "disableContributorAccessForUsers": {
              "type": "bool",
              "defaultValue": false
            },
            "disableRBACAdminOnRGForUsers": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "acrPushRoleId": "8311e382-0749-4cb8-b61a-304f252e45ec",
            "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
            "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c",
            "roleBasedAccessControlAdministratorRG": "f58310d9-a9f6-439a-9e8d-f62e7b41a168",
            "ownerRoleId": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
            "userAccessAdministratorRoleId": "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9",
            "rbacAdministratorRoleId": "f58310d9-a9f6-439a-9e8d-f62e7b41a168",
            "excludePrivilegedRolesCondition": "[format('((!(ActionMatches{{''Microsoft.Authorization/roleAssignments/write''}} AND @Request[Microsoft.Authorization/roleAssignments:RoleDefinitionId] ForAnyOfAnyValues:GuidEquals {{{0}, {1}, {2}}})))', variables('ownerRoleId'), variables('userAccessAdministratorRoleId'), variables('rbacAdministratorRoleId'))]",
            "aiUserRoleId": "53ca6127-db72-4b80-b1b0-d745d6d5456d",
            "azureMLDataScientistRoleId": "f6c7c914-8db3-469d-8ca1-694a8f32e121",
            "azureAIDeveloperRoleId": "64702f94-c441-49e6-a78b-ef80e0188fee",
            "azureAIInferenceDeploymentOperatorRoleId": "3afb7f49-54cb-416e-8c09-6dc049efa503",
            "azureAIAdministrator": "b78c5d69-af96-48a3-bf8d-a8b4d589de94",
            "azureMachineLearningWorkspaceConnectionSecretsReaderRoleId": "ea01e6af-a1c1-4350-9563-ad00f8c72ec5",
            "azureMLMetricsWriter": "635dd51f-9968-44d3-b7fb-6d9a6bd613ae",
            "cognitiveServicesCustomVisionContributorRoleId": "c1ff6cc2-c111-46fe-8896-e0ef812ad9f3",
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
            "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
            "cognitiveServicesOpenAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
            "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68",
            "cognitiveServicesUsagesReaderId": "bba48692-92b0-4667-a9ad-c31c7b334ac2",
            "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908"
          },
          "resources": [
            {
              "condition": "[and(not(empty(parameters('aiHubProjectName'))), not(empty(parameters('aiServicesName'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('azureAIDeveloperRoleId'), resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIDeveloperRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')), '2024-10-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal",
                "description": "[format('001 - Azure AI Developer On AIServices From AIProject MI OID of: {0} to {1}', parameters('aiHubProjectName'), parameters('aiServicesName'))]"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesUsagesReaderU",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesUsagesReaderId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesUsagesReaderId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('002 - cognitiveServicesUsagesReaderId role to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiServicesName'))]"
              },
              "metadata": {
                "description": "Users to Azure AI Services: Cognitive Services Usage Reader for users. Only Access quota (Minimal permission to view Cognitive Services usages)"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesUsagesReaderSPU",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesUsagesReaderId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesUsagesReaderId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('003 - cognitiveServicesUsagesReader role to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiServicesName'))]"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesOpenAIContributorUsersU",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesOpenAIContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('004 - OpenAIContributorRole to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiServicesName'))]"
              },
              "metadata": {
                "description": "Users to Azure AI Services: Cognitive Services OpenAI Contributor for users. Full access including the ability to fine-tune, deploy and generate text"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesOpenAIContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesOpenAIContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('005 - cognitiveServicesOpenAIContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiServicesName'))]"
              }
            },
            {
              "copy": {
                "name": "roleAssignmentCognitiveServicesOpenAIUsers",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesOpenAIUserRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIUserRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('006 - OpenAICognitiveServicesUSer to USER with OID  {0} for : {1} to list API keys', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiServicesName'))]"
              },
              "metadata": {
                "description": "Users to Azure AI Services: Cognitive Services OpenAI User:Read access to view files, models, deployments. The ability to create completion and embedding calls."
              }
            },
            {
              "copy": {
                "name": "roleAssignmentCognitiveServicesOpenAISP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesOpenAIUserRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesOpenAIUserRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('007 - cognitiveServicesOpenAIUserRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiServicesName'))]"
              }
            },
            {
              "copy": {
                "name": "userStorageBlobDataContributorRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('008 - StorageBlobDataContributor to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('storageAccountName'))]"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage 1: StorageBlobDataContributor for users. Grants read/write/delete permissions to Blob storage resources"
              }
            },
            {
              "copy": {
                "name": "userStorageBlobDataContributorRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('009 - storageBlobDataContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('storageAccountName'))]"
              }
            },
            {
              "copy": {
                "name": "roleAssignmentStorageUserFileDataPrivilegedContributor",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('010 - FileDataPrivilegedContributor to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('storageAccountName'))]"
              },
              "metadata": {
                "description": "Azure Storage 1: FileDataPrivilegedContributor. Allows for read, write, delete, and modify ACLs on files/directories in Azure file shares by overriding existing ACLs/NTFS permissions. This role has no built-in equivalent on Windows file servers."
              }
            },
            {
              "copy": {
                "name": "roleAssignmentStorageUserFileDataPrivilegedContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('011 - storageFileDataContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('storageAccountName'))]"
              }
            },
            {
              "copy": {
                "name": "userStorageBlobDataContributorRole2",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('storageAccountName2')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('012 - StorageBlobDataContributor to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('storageAccountName2'))]"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage 2: StorageBlobDataContributor for users. Grants read/write/delete permissions to Blob storage resources"
              }
            },
            {
              "copy": {
                "name": "userStorageBlobDataContributorRole2SP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('storageAccountName2')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('013 - storageBlobDataContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('storageAccountName2'))]"
              }
            },
            {
              "copy": {
                "name": "roleAssignmentStorageUserFileDataPrivilegedContributor2",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('storageAccountName2')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('014 - FileDataPrivilegedContributor to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('storageAccountName2'))]"
              },
              "metadata": {
                "description": "Azure Storage 2: FileDataPrivilegedContributor. Allows for read, write, delete, and modify ACLs on files/directories in Azure file shares by overriding existing ACLs/NTFS permissions. This role has no built-in equivalent on Windows file servers."
              }
            },
            {
              "copy": {
                "name": "roleAssignmentStorageUserFileDataPrivilegedContributor2SP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('storageAccountName2')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('015 - storageFileDataContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('storageAccountName2'))]"
              }
            },
            {
              "copy": {
                "name": "userStorageQueueDataContributorRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageQueueDataContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('016 - Storage Queue Data Contributor to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('storageAccountName'))]"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage: StorageQueueDataContributor for users. Grants read/write/delete permissions to Queue storage resources for Azure Functions"
              }
            },
            {
              "copy": {
                "name": "userStorageQueueDataContributorRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageQueueDataContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('017 - Storage Queue Data Contributor to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('storageAccountName'))]"
              }
            },
            {
              "copy": {
                "name": "userStorageQueueDataContributorRole2",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('storageAccountName2')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageQueueDataContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('018 - Storage Queue Data Contributor to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('storageAccountName2'))]"
              },
              "metadata": {
                "description": "Role Assignment for Azure Storage 2: StorageQueueDataContributor for users. Grants read/write/delete permissions to Queue storage resources for Azure Functions"
              }
            },
            {
              "copy": {
                "name": "userStorageQueueDataContributorRole2SP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('storageAccountName2')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageQueueDataContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('019 - Storage Queue Data Contributor to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('storageAccountName2'))]"
              }
            },
            {
              "copy": {
                "name": "azureAIDeveloperRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiHubName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName')), variables('azureAIDeveloperRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIDeveloperRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('020 - AzureAIDeveloper role to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiHubName'))]"
              },
              "metadata": {
                "description": ""
              }
            },
            {
              "copy": {
                "name": "azureAIDeveloperRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiHubName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName')), variables('azureAIDeveloperRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIDeveloperRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('021 - azureAIDeveloperRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiHubName'))]"
              }
            },
            {
              "copy": {
                "name": "azureAIAdministratorAssignment",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiHubProjectName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubProjectName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')), variables('azureAIAdministrator'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIAdministrator'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('022 - azureAIAdministrator role to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiHubProjectName'))]"
              },
              "metadata": {
                "description": "AI Project: azureAIAdministrator:"
              }
            },
            {
              "copy": {
                "name": "azureAIAdministratorAssignmentSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiHubProjectName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubProjectName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')), variables('azureAIAdministrator'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIAdministrator'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('023 - azureAIAdministrator to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiHubProjectName'))]"
              }
            },
            {
              "copy": {
                "name": "aiDevOnAIProject",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiHubProjectName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubProjectName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')), variables('azureAIDeveloperRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIDeveloperRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('024 - azureAIDeveloperRoleId role to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiHubProjectName'))]"
              },
              "metadata": {
                "description": "AI Project: Azure AI Developer:"
              }
            },
            {
              "copy": {
                "name": "aiDevOnAIProjectSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiHubProjectName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubProjectName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubProjectName')), variables('azureAIDeveloperRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIDeveloperRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('025 - azureAIDeveloperRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiHubProjectName'))]"
              }
            },
            {
              "copy": {
                "name": "cogServiceContribOnAIProjectUser",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('026 - cognitiveServicesContributorRoleId role to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiServicesName'))]"
              },
              "metadata": {
                "description": "AI Services: Azure Cognitive services contributor"
              }
            },
            {
              "copy": {
                "name": "cogServiceContribOnAIProjectSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiServicesName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), variables('cognitiveServicesContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('027 - cognitiveServicesContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiServicesName'))]"
              },
              "metadata": {
                "description": "AI Services: Azure Cognitive services contributor"
              }
            },
            {
              "copy": {
                "name": "aiUserUser",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('aiUserRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('aiUserRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('028 - Azure AI User role to USER with OID  {0} for RG level', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]"
              },
              "metadata": {
                "description": "RG:AI Project: AzureAIInferenceDeploymentOperator:Can perform all actions required to create a resource deployment within a resource group. "
              }
            },
            {
              "copy": {
                "name": "aiUserSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('aiUserRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('aiUserRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('029 - Azure AI User to project service principal OID:{0} to RG level', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]"
              }
            },
            {
              "copy": {
                "name": "cogServicesUser",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('cognitiveServicesUserRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesUserRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('030 - cognitiveServicesUserRoleId role to USER with OID  {0} for RG level', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]"
              },
              "metadata": {
                "description": "RG:AI Project: AzureAIInferenceDeploymentOperator:Can perform all actions required to create a resource deployment within a resource group. "
              }
            },
            {
              "copy": {
                "name": "cogServicesUserSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('cognitiveServicesUserRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesUserRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('031 - cognitiveServicesUserRoleId to project service principal OID:{0} to RG level', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]"
              }
            },
            {
              "copy": {
                "name": "azureAIInferenceDeploymentOperatorRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('azureAIInferenceDeploymentOperatorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIInferenceDeploymentOperatorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('032 - AzureAIInferenceDeploymentOperator role to USER with OID  {0} for {1} on RG level', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiHubName'))]"
              },
              "metadata": {
                "description": "RG:AI Project: AzureAIInferenceDeploymentOperator:Can perform all actions required to create a resource deployment within a resource group. "
              }
            },
            {
              "copy": {
                "name": "azureAIInferenceDeploymentOperatorRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('azureAIInferenceDeploymentOperatorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIInferenceDeploymentOperatorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('033 - azureAIInferenceDeploymentOperatorRoleId to project service principal OID:{0} to {1} on RG level', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiHubName'))]"
              }
            },
            {
              "copy": {
                "name": "azureMLDataScientistRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('azureMLDataScientistRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureMLDataScientistRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('034 - AzureMLDataScientist role to USER with OID  {0} for : {1} on RG level', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiHubName'))]"
              },
              "metadata": {
                "description": "RG:AI Hub, AI Project: Azure ML Data scientist: Can perform all actions within an AML workspace, except for creating or deleting compute resources and modifying the workspace itself."
              }
            },
            {
              "copy": {
                "name": "azureMLDataScientistRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('azureMLDataScientistRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureMLDataScientistRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('035 - azureMLDataScientistRoleId to project service principal OID:{0} to {1} on RG level', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiHubName'))]"
              }
            },
            {
              "copy": {
                "name": "amlWorkspaceConnectionSecretsReader",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('azureMachineLearningWorkspaceConnectionSecretsReaderRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureMachineLearningWorkspaceConnectionSecretsReaderRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('036 - AzureMachineLearningWorkspaceConnectionSecretsReader role to USER with OID  {0} for : {1} on RG level', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiHubName'))]"
              },
              "metadata": {
                "description": "RG:AI Hub, AI Project: AzureMachineLearningWorkspaceConnectionSecretsReader: Can perform all actions within an AML workspace, except for creating or deleting compute resources and modifying the workspace itself."
              }
            },
            {
              "copy": {
                "name": "amlWorkspaceConnectionSecretsReaderSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('azureMachineLearningWorkspaceConnectionSecretsReaderRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureMachineLearningWorkspaceConnectionSecretsReaderRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('037 - azureMachineLearningWorkspaceConnectionSecretsReaderRoleId to project service principal OID:{0} to {1} on RG level', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiHubName'))]"
              }
            },
            {
              "copy": {
                "name": "contributorRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(parameters('disableContributorAccessForUsers'))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('contributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('038 - CONTRIBUTOR on RG to USER with OID  {0} for {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('resourceGroupId'))]"
              },
              "metadata": {
                "description": "Role Assignment for ResoureGroup: CONTRIBUTOR for users."
              }
            },
            {
              "copy": {
                "name": "contributorRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('contributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('039 - contributorRoleId to project service principal OID:{0} for {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('resourceGroupId'))]"
              }
            },
            {
              "copy": {
                "name": "roleBasedAccessControlAdminRGRole",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(parameters('disableRBACAdminOnRGForUsers'))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('roleBasedAccessControlAdministratorRG'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleBasedAccessControlAdministratorRG'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('040 - RoleBasedAccessControlAdministrator on RG to USER with OID  {0} for : {1} - excludes privileged administrator roles', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('resourceGroupId'))]",
                "condition": "[variables('excludePrivilegedRolesCondition')]",
                "conditionVersion": "2.0"
              },
              "metadata": {
                "description": "Role Assignment for ResoureGroup: RoleBasedAccessControlAdministrator for users with conditions to exclude privileged roles."
              }
            },
            {
              "copy": {
                "name": "roleBasedAccessControlAdminRGRoleSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('roleBasedAccessControlAdministratorRG'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleBasedAccessControlAdministratorRG'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('041 - roleBasedAccessControlAdministrator to project service principal OID:{0} for RG: {1} - excludes privileged administrator roles', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('resourceGroupId'))]",
                "condition": "[variables('excludePrivilegedRolesCondition')]",
                "conditionVersion": "2.0"
              }
            },
            {
              "copy": {
                "name": "acrPush",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('acrPushRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('acrPushRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('042 - acrPush role on RG to USER with OID  {0} for RG: {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('resourceGroupId'))]"
              },
              "metadata": {
                "description": "Role Assignment for ResoureGroup: acrPushRoleId for users."
              }
            },
            {
              "copy": {
                "name": "acrPushSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('resourceGroupId'), variables('acrPushRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('acrPushRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('043 - acrPush role to project service principal OID:{0} for RG: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('resourceGroupId'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('aiSearchExists')), parameters('enableAISearch'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacAISearch{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": "[if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), variables('cleanRandomValue2'), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', ''))]",
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "484977773035005766"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string"
            },
            "userObjectIds": {
              "type": "array"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
            "searchIndexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
            "searchServiceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
            "azureAIDeveloperRoleId": "64702f94-c441-49e6-a78b-ef80e0188fee"
          },
          "resources": [
            {
              "copy": {
                "name": "searchIndexDataContributor",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('020: SearchIndexUserDataContributor to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiSearchName'))]"
              },
              "metadata": {
                "description": "Role Assignment for Azure AI Search: SearchIndexDataContributor for users. \tGrants full access to Azure Cognitive Search index data"
              }
            },
            {
              "copy": {
                "name": "searchIndexDataReaderAssign",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataReader'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataReader'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('021: searchIndexDataReader to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiSearchName'))]"
              }
            },
            {
              "copy": {
                "name": "searchIndexDataContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchIndexDataContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchIndexDataContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('searchIndexDataContributorRoleId to project service principal OID: {0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiSearchName'))]"
              }
            },
            {
              "copy": {
                "name": "searchServiceContributor",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchServiceContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchServiceContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('022: CONTRIBUTOR to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiSearchName'))]"
              },
              "metadata": {
                "description": "Role Assignment for Azure AI Search: Search Service Contributor for users. Lets you manage Search services, but not access to them."
              }
            },
            {
              "copy": {
                "name": "azureAIDeveloperUsers",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('azureAIDeveloperRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('azureAIDeveloperRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('023: Azure AI Developer to USER with OID  {0} for : {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('aiSearchName'))]"
              },
              "metadata": {
                "description": "Role Assignment for Azure AI Search: Azure AI Developer for users. CRITICAL for Chat with data scenarios."
              }
            },
            {
              "copy": {
                "name": "searchServiceContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), variables('searchServiceContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('searchServiceContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('searchServiceContributorRoleId to project service principal OID:{0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('aiSearchName'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('dataFactoryExists')), parameters('enableDatafactory'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacDatafactory{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "additionalUserIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "datafactoryName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.dataFactoryName.value]"
          },
          "disableContributorAccessForUsers": {
            "value": "[parameters('disableContributorAccessForUsers')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "334645024771474613"
            }
          },
          "parameters": {
            "userPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Specifies the objectId of the technical contact"
              }
            },
            "datafactoryName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the name the datafactory resource"
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "additionalUserIds": {
              "type": "array",
              "metadata": {
                "description": "Additional optional Object ID of more people to access Resource group"
              }
            },
            "servicePrincipleAndMIArray": {
              "type": "array",
              "defaultValue": []
            },
            "disableContributorAccessForUsers": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "roleContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
            "roleDataFactoryContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '673868aa-7521-48a0-acc6-0f60742d39f5')]",
            "roleDataFactoryDataFlowDeveloper": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e5c9c5c8-8c8a-4f2d-9b9a-4b4b4b4b4b4b')]",
            "allUsers": "[parameters('additionalUserIds')]"
          },
          "resources": [
            {
              "copy": {
                "name": "contributorUser",
                "count": "[length(range(0, length(variables('allUsers'))))]"
              },
              "condition": "[not(parameters('disableContributorAccessForUsers'))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.DataFactory/factories/{0}', parameters('datafactoryName'))]",
              "name": "[guid(variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]], variables('roleContributor'), resourceId('Microsoft.DataFactory/factories', parameters('datafactoryName')), 'contributor-adf')]",
              "properties": {
                "roleDefinitionId": "[variables('roleContributor')]",
                "principalId": "[variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('01 - ADF: Contributor to USER with OID  {0} for Data Factory: {1}', variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]], parameters('datafactoryName'))]"
              }
            },
            {
              "copy": {
                "name": "dataFactoryContributorUser",
                "count": "[length(range(0, length(variables('allUsers'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.DataFactory/factories/{0}', parameters('datafactoryName'))]",
              "name": "[guid(variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]], variables('roleDataFactoryContributor'), resourceId('Microsoft.DataFactory/factories', parameters('datafactoryName')), 'adf-contributor')]",
              "properties": {
                "roleDefinitionId": "[variables('roleDataFactoryContributor')]",
                "principalId": "[variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('02 - ADF: Data Factory Contributor to USER with OID  {0} for Data Factory: {1}', variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]], parameters('datafactoryName'))]"
              }
            },
            {
              "copy": {
                "name": "dataFactoryDataFlowDeveloperUser",
                "count": "[length(range(0, length(variables('allUsers'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.DataFactory/factories/{0}', parameters('datafactoryName'))]",
              "name": "[guid(variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]], variables('roleDataFactoryDataFlowDeveloper'), resourceId('Microsoft.DataFactory/factories', parameters('datafactoryName')), 'adf-dataflow-dev')]",
              "properties": {
                "roleDefinitionId": "[variables('roleDataFactoryDataFlowDeveloper')]",
                "principalId": "[variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('03 - ADF: Data Factory Data Flow Developer to USER with OID  {0} for Data Factory: {1}', variables('allUsers')[range(0, length(variables('allUsers')))[copyIndex()]], parameters('datafactoryName'))]"
              }
            },
            {
              "copy": {
                "name": "contributorServicePrincipal",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "condition": "[not(parameters('disableContributorAccessForUsers'))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.DataFactory/factories/{0}', parameters('datafactoryName'))]",
              "name": "[guid(parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], variables('roleContributor'), resourceId('Microsoft.DataFactory/factories', parameters('datafactoryName')), 'sp-contributor')]",
              "properties": {
                "roleDefinitionId": "[variables('roleContributor')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('04 - ADF: Contributor to SERVICE PRINCIPAL with OID  {0} for Data Factory: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('datafactoryName'))]"
              }
            },
            {
              "copy": {
                "name": "dataFactoryContributorServicePrincipal",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.DataFactory/factories/{0}', parameters('datafactoryName'))]",
              "name": "[guid(parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], variables('roleDataFactoryContributor'), resourceId('Microsoft.DataFactory/factories', parameters('datafactoryName')), 'sp-adf-contributor')]",
              "properties": {
                "roleDefinitionId": "[variables('roleDataFactoryContributor')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('05 - ADF: Data Factory Contributor to SERVICE PRINCIPAL with OID  {0} for Data Factory: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('datafactoryName'))]"
              }
            },
            {
              "copy": {
                "name": "dataFactoryDataFlowDeveloperServicePrincipal",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.DataFactory/factories/{0}', parameters('datafactoryName'))]",
              "name": "[guid(parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], variables('roleDataFactoryDataFlowDeveloper'), resourceId('Microsoft.DataFactory/factories', parameters('datafactoryName')), 'sp-adf-dataflow-dev')]",
              "properties": {
                "roleDefinitionId": "[variables('roleDataFactoryDataFlowDeveloper')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('06 - ADF: Data Factory Data Flow Developer to SERVICE PRINCIPAL with OID  {0} for Data Factory: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('datafactoryName'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-rbacUsersAIHub{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[parameters('enableAzureAIVision')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacVision{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiVisionMIObjectId": "[if(parameters('enableAzureAIVision'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', variables('visionName_Static')), '2024-10-01', 'full').identity.principalId), createObject('value', ''))]",
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "visonServiceName": {
            "value": "[variables('visionName_Static')]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "3746189495030053250"
            }
          },
          "parameters": {
            "aiVisionMIObjectId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountName2": {
              "type": "string"
            },
            "visonServiceName": {
              "type": "string"
            },
            "userObjectIds": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            }
          },
          "variables": {
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataPrivilegedContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "cognitiveServicesContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
            "storageBlobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiVisionMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiVisionMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "013"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataOwnerRoleId'), parameters('aiVisionMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiVisionMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataOwnerRoleId'))]",
                "description": "014"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataPrivilegedContributorRoleId'), parameters('aiVisionMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiVisionMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataPrivilegedContributorRoleId'))]",
                "description": "019b"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataPrivilegedContributorRoleId'), parameters('aiVisionMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiVisionMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataPrivilegedContributorRoleId'))]",
                "description": "019a"
              }
            },
            {
              "copy": {
                "name": "visionServiceOpenAICotributorUsers",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('visonServiceName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('visonServiceName')), variables('cognitiveServicesContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('023: CognitiveServicesUser to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('visonServiceName'))]"
              }
            },
            {
              "copy": {
                "name": "searchIndexDataContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('visonServiceName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('visonServiceName')), variables('cognitiveServicesContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesContributorRoleId to project service principal OID: {0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('visonServiceName'))]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentStorageBlobDataContributorName": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiVisionMIObjectId'))]"
            },
            "roleAssignmentStorageBlobDataContributorName2": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataOwnerRoleId'), parameters('aiVisionMIObjectId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[parameters('enableAzureSpeech')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacSpeech{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiSpeechMIObjectId": "[if(parameters('enableAzureSpeech'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', variables('speechName_Static')), '2024-10-01', 'full').identity.principalId), createObject('value', ''))]",
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "speechServiceName": {
            "value": "[variables('speechName_Static')]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4272164495390143512"
            }
          },
          "parameters": {
            "aiSpeechMIObjectId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountName2": {
              "type": "string"
            },
            "speechServiceName": {
              "type": "string"
            },
            "userObjectIds": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            }
          },
          "variables": {
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataPrivilegedContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "cognitiveServicesContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
            "storageBlobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiSpeechMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSpeechMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "013"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataOwnerRoleId'), parameters('aiSpeechMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSpeechMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataOwnerRoleId'))]",
                "description": "014"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataPrivilegedContributorRoleId'), parameters('aiSpeechMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiSpeechMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataPrivilegedContributorRoleId'))]",
                "description": "019b"
              }
            },
            {
              "copy": {
                "name": "speechServiceOpenAICotributorUsers",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('speechServiceName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('speechServiceName')), variables('cognitiveServicesContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('023: CognitiveServicesUser to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('speechServiceName'))]"
              }
            },
            {
              "copy": {
                "name": "searchIndexDataContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('speechServiceName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('speechServiceName')), variables('cognitiveServicesContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesContributorRoleId to project service principal OID: {0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('speechServiceName'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[parameters('enableAIDocIntelligence')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacDocs{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "aiDocsIntelMIObjectId": "[if(parameters('enableAIDocIntelligence'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', variables('docsName_Static')), '2024-10-01', 'full').identity.principalId), createObject('value', ''))]",
          "docsServiceName": {
            "value": "[variables('docsName_Static')]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2371144325820084205"
            }
          },
          "parameters": {
            "aiDocsIntelMIObjectId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountName2": {
              "type": "string"
            },
            "docsServiceName": {
              "type": "string"
            },
            "userObjectIds": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            }
          },
          "variables": {
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataPrivilegedContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "cognitiveServicesContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
            "storageBlobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiDocsIntelMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiDocsIntelMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "description": "013"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataOwnerRoleId'), parameters('aiDocsIntelMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiDocsIntelMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataOwnerRoleId'))]",
                "description": "014"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageFileDataPrivilegedContributorRoleId'), parameters('aiDocsIntelMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiDocsIntelMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataPrivilegedContributorRoleId'))]",
                "description": "019b"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageFileDataPrivilegedContributorRoleId'), parameters('aiDocsIntelMIObjectId'))]",
              "properties": {
                "principalId": "[parameters('aiDocsIntelMIObjectId')]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataPrivilegedContributorRoleId'))]",
                "description": "019a"
              }
            },
            {
              "copy": {
                "name": "docsServiceOpenAICotributorUsers",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('docsServiceName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('docsServiceName')), variables('cognitiveServicesContributorRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('023: cognitiveServicesContributor role to USER with OID  {0} for : {1} to call data on data plane', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('docsServiceName'))]"
              }
            },
            {
              "copy": {
                "name": "searchIndexDataContributorSP",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('docsServiceName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('docsServiceName')), variables('cognitiveServicesContributorRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('cognitiveServicesContributorRoleId to project service principal OID: {0} to {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('docsServiceName'))]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentStorageBlobDataContributorName": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), variables('storageBlobDataContributorRoleId'), parameters('aiDocsIntelMIObjectId'))]"
            },
            "roleAssignmentStorageBlobDataContributorName2": {
              "type": "string",
              "value": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), variables('storageBlobDataOwnerRoleId'), parameters('aiDocsIntelMIObjectId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(parameters('addBastionHost'), empty(parameters('bastionSubscription')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacGenAIUsVn{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('vnetResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "user_object_ids": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "vNetName": {
            "value": "[variables('vnetNameFull')]"
          },
          "common_bastion_subnet_name": {
            "value": "AzureBastionSubnet"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12912332237226903380"
            }
          },
          "parameters": {
            "vNetName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the name the datafactory resource"
              }
            },
            "common_bastion_subnet_name": {
              "type": "string"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "user_object_ids": {
              "type": "array",
              "metadata": {
                "description": "Additional optional Object ID of more people to access Resource group"
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "resources": [
            {
              "copy": {
                "name": "networkContributorUserVnet",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('vNetName'))]",
              "name": "[guid(format('{0}-nwContributor-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('vNetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Network Contributor to USER with OID  {0} for vNet: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('vNetName'))]"
              }
            },
            {
              "copy": {
                "name": "networkContributorSPVnet",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('vNetName'))]",
              "name": "[guid(format('{0}-nwContribSP-{1}-{2}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('vNetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('Network Contributor to SERVICE PRINCIPLE with OID  {0} for vNet: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('vNetName'))]"
              }
            },
            {
              "copy": {
                "name": "contributorUserBastionNSG",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/networkSecurityGroups/{0}', format('nsg-{0}', parameters('common_bastion_subnet_name')))]",
              "name": "[guid(format('{0}-contributor-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('common_bastion_subnet_name'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Contributor to USER with OID  {0} for Bastion NSG: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('common_bastion_subnet_name'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(parameters('addBastionHost'), not(empty(parameters('bastionSubscription'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacUseVnet{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('bastionSubscription')]",
      "resourceGroup": "[parameters('bastionResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "user_object_ids": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "vNetName": {
            "value": "[parameters('vnetNameFullBastion')]"
          },
          "common_bastion_subnet_name": {
            "value": "AzureBastionSubnet"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12912332237226903380"
            }
          },
          "parameters": {
            "vNetName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the name the datafactory resource"
              }
            },
            "common_bastion_subnet_name": {
              "type": "string"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "user_object_ids": {
              "type": "array",
              "metadata": {
                "description": "Additional optional Object ID of more people to access Resource group"
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "resources": [
            {
              "copy": {
                "name": "networkContributorUserVnet",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('vNetName'))]",
              "name": "[guid(format('{0}-nwContributor-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('vNetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Network Contributor to USER with OID  {0} for vNet: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('vNetName'))]"
              }
            },
            {
              "copy": {
                "name": "networkContributorSPVnet",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('vNetName'))]",
              "name": "[guid(format('{0}-nwContribSP-{1}-{2}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('vNetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('Network Contributor to SERVICE PRINCIPLE with OID  {0} for vNet: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('vNetName'))]"
              }
            },
            {
              "copy": {
                "name": "contributorUserBastionNSG",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Network/networkSecurityGroups/{0}', format('nsg-{0}', parameters('common_bastion_subnet_name')))]",
              "name": "[guid(format('{0}-contributor-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('common_bastion_subnet_name'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Contributor to USER with OID  {0} for Bastion NSG: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('common_bastion_subnet_name'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[parameters('useCommonACR')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacUsCmnACR{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('commonResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "commonRGId": {
            "value": "[resourceId(parameters('subscriptionIdDevTestProd'), 'Microsoft.Resources/resourceGroups', variables('commonResourceGroup'))]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "10636290043371289123"
            }
          },
          "parameters": {
            "commonRGId": {
              "type": "string"
            },
            "userObjectIds": {
              "type": "array"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "acrPushRoleId": "8311e382-0749-4cb8-b61a-304f252e45ec",
            "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
          },
          "resources": [
            {
              "copy": {
                "name": "acrPushCmn",
                "count": "[length(range(0, length(parameters('userObjectIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('commonRGId'), variables('acrPushRoleId'), parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('acrPushRoleId'))]",
                "principalId": "[parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('030: acrPush role on RG to USER with OID  {0} for RG: {1}', parameters('userObjectIds')[range(0, length(parameters('userObjectIds')))[copyIndex()]], parameters('commonRGId'))]"
              },
              "metadata": {
                "description": "Role Assignment for ResoureGroup: acrPushRoleId for users."
              }
            },
            {
              "copy": {
                "name": "acrPushSPCmn",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('commonRGId'), variables('acrPushRoleId'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('acrPushRoleId'))]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('acrPush role to project service principal OID:{0} for RG: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('commonRGId'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-rbacUsersAIHub{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacLake4Prj{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('commonResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "amlPrincipalId": "[if(and(not(parameters('amlExists')), parameters('enableAzureMachineLearning')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.MachineLearningServices/workspaces', variables('amlName_Static')), '2024-10-01-preview', 'full').identity.principalId), createObject('value', ''))]",
          "aiHubPrincipleId": "[if(and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.MachineLearningServices/workspaces', variables('aiHubName_Static')), '2024-10-01-preview', 'full').identity.principalId), createObject('value', ''))]",
          "projectTeamGroupOrUser": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "adfPrincipalId": {
            "value": ""
          },
          "datalakeName": {
            "value": "[variables('datalakeName')]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4566676250626908128"
            }
          },
          "parameters": {
            "amlPrincipalId": {
              "type": "string",
              "defaultValue": ""
            },
            "aiHubPrincipleId": {
              "type": "string",
              "defaultValue": ""
            },
            "projectTeamGroupOrUser": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": []
            },
            "adfPrincipalId": {
              "type": "string"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "datalakeName": {
              "type": "string"
            }
          },
          "variables": {
            "readerRoleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
            "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
          },
          "resources": {
            "datalakeFromCommon": {
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[parameters('datalakeName')]"
            },
            "readerAML": {
              "condition": "[not(empty(parameters('amlPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', variables('readerRoleDefinitionId'), parameters('amlPrincipalId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleDefinitionId'))]",
                "principalId": "[parameters('amlPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('READER to AML Managed Identity: {0} for Azure ML Studio to get access to datalake: {1}', parameters('amlPrincipalId'), parameters('datalakeName'))]"
              }
            },
            "lakeAIFoundry": {
              "condition": "[not(empty(parameters('aiHubPrincipleId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-contributor-{1}-{2}', variables('storageBlobDataContributor'), parameters('aiHubPrincipleId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributor'))]",
                "principalId": "[parameters('aiHubPrincipleId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('storageBlobDataContributor to Managed Identity: {0} for Azure AI Foundry to get access to datalake: {1}', parameters('aiHubPrincipleId'), parameters('datalakeName'))]"
              }
            },
            "readerUserGroup": {
              "copy": {
                "name": "readerUserGroup",
                "count": "[length(range(0, length(parameters('projectTeamGroupOrUser'))))]"
              },
              "condition": "[greater(length(parameters('projectTeamGroupOrUser')), 0)]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]], variables('readerRoleDefinitionId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleDefinitionId'))]",
                "principalId": "[parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('READER to USER or Group with OID  {0} for lake: {1}', parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]], parameters('datalakeName'))]"
              }
            },
            "storageBlobDataContributorADF": {
              "condition": "[not(empty(parameters('adfPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', variables('storageBlobDataContributor'), parameters('adfPrincipalId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributor'))]",
                "principalId": "[parameters('adfPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('READER to ADF Managed Identity: {0} for Azure Datafactory to get accesst to datalake: {1}', parameters('adfPrincipalId'), parameters('datalakeName'))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('amlExists')), parameters('enableAzureMachineLearning'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacLake4Amlv2{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('commonResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "amlPrincipalId": "[if(and(not(parameters('amlExists')), parameters('enableAzureMachineLearning')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.MachineLearningServices/workspaces', variables('amlName_Static')), '2024-10-01-preview', 'full').identity.principalId), createObject('value', ''))]",
          "aiHubPrincipleId": "[if(and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub')), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.MachineLearningServices/workspaces', variables('aiHubName_Static')), '2024-10-01-preview', 'full').identity.principalId), createObject('value', ''))]",
          "projectTeamGroupOrUser": {
            "value": []
          },
          "adfPrincipalId": {
            "value": ""
          },
          "datalakeName": {
            "value": "[variables('datalakeName')]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4566676250626908128"
            }
          },
          "parameters": {
            "amlPrincipalId": {
              "type": "string",
              "defaultValue": ""
            },
            "aiHubPrincipleId": {
              "type": "string",
              "defaultValue": ""
            },
            "projectTeamGroupOrUser": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": []
            },
            "adfPrincipalId": {
              "type": "string"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "datalakeName": {
              "type": "string"
            }
          },
          "variables": {
            "readerRoleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
            "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
          },
          "resources": {
            "datalakeFromCommon": {
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[parameters('datalakeName')]"
            },
            "readerAML": {
              "condition": "[not(empty(parameters('amlPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', variables('readerRoleDefinitionId'), parameters('amlPrincipalId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleDefinitionId'))]",
                "principalId": "[parameters('amlPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('READER to AML Managed Identity: {0} for Azure ML Studio to get access to datalake: {1}', parameters('amlPrincipalId'), parameters('datalakeName'))]"
              }
            },
            "lakeAIFoundry": {
              "condition": "[not(empty(parameters('aiHubPrincipleId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-contributor-{1}-{2}', variables('storageBlobDataContributor'), parameters('aiHubPrincipleId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributor'))]",
                "principalId": "[parameters('aiHubPrincipleId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('storageBlobDataContributor to Managed Identity: {0} for Azure AI Foundry to get access to datalake: {1}', parameters('aiHubPrincipleId'), parameters('datalakeName'))]"
              }
            },
            "readerUserGroup": {
              "copy": {
                "name": "readerUserGroup",
                "count": "[length(range(0, length(parameters('projectTeamGroupOrUser'))))]"
              },
              "condition": "[greater(length(parameters('projectTeamGroupOrUser')), 0)]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]], variables('readerRoleDefinitionId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleDefinitionId'))]",
                "principalId": "[parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('READER to USER or Group with OID  {0} for lake: {1}', parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]], parameters('datalakeName'))]"
              }
            },
            "storageBlobDataContributorADF": {
              "condition": "[not(empty(parameters('adfPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('datalakeName'))]",
              "name": "[guid(format('{0}-reader-{1}-{2}', variables('storageBlobDataContributor'), parameters('adfPrincipalId'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributor'))]",
                "principalId": "[parameters('adfPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "[format('READER to ADF Managed Identity: {0} for Azure Datafactory to get accesst to datalake: {1}', parameters('adfPrincipalId'), parameters('datalakeName'))]"
              }
            }
          }
        }
      }
    },
    {
      "condition": "[and(not(parameters('amlExists')), parameters('enableAzureMachineLearning'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacAmlCompute{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectTeamGroupOrUser": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "amlWorkspaceName": {
            "value": "[variables('amlName_Static')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "17955393235873800762"
            }
          },
          "parameters": {
            "projectTeamGroupOrUser": {
              "type": "array"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            },
            "amlWorkspaceName": {
              "type": "string"
            }
          },
          "variables": {
            "principalTypeUser": "[if(parameters('useAdGroups'), 'Group', 'User')]"
          },
          "resources": [
            {
              "copy": {
                "name": "computeOperatorUsers",
                "count": "[length(range(0, length(parameters('projectTeamGroupOrUser'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('amlWorkspaceName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('amlWorkspaceName')), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e503ece1-11d0-4e8e-8e2c-7a6c3bf38815'), parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e503ece1-11d0-4e8e-8e2c-7a6c3bf38815')]",
                "principalId": "[parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]]]",
                "principalType": "[variables('principalTypeUser')]",
                "description": "[format('Azure ML Compute Operator on workspace {0} for {1} {2}', parameters('amlWorkspaceName'), variables('principalTypeUser'), parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]])]"
              }
            },
            {
              "copy": {
                "name": "computeOperatorSPs",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('amlWorkspaceName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('amlWorkspaceName')), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e503ece1-11d0-4e8e-8e2c-7a6c3bf38815'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e503ece1-11d0-4e8e-8e2c-7a6c3bf38815')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('Azure ML Compute Operator on workspace {0} for SP/MI {1}', parameters('amlWorkspaceName'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]"
              }
            },
            {
              "copy": {
                "name": "registryUserUsers",
                "count": "[length(range(0, length(parameters('projectTeamGroupOrUser'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('amlWorkspaceName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('amlWorkspaceName')), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1823dd4f-9b8c-4ab6-ab4e-7397a3684615'), parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1823dd4f-9b8c-4ab6-ab4e-7397a3684615')]",
                "principalId": "[parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]]]",
                "principalType": "[variables('principalTypeUser')]",
                "description": "[format('Azure ML Registry User on workspace {0} for {1} {2}', parameters('amlWorkspaceName'), variables('principalTypeUser'), parameters('projectTeamGroupOrUser')[range(0, length(parameters('projectTeamGroupOrUser')))[copyIndex()]])]"
              }
            },
            {
              "copy": {
                "name": "registryUserSPs",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('amlWorkspaceName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('amlWorkspaceName')), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1823dd4f-9b8c-4ab6-ab4e-7397a3684615'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1823dd4f-9b8c-4ab6-ab4e-7397a3684615')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('Azure ML Registry User on workspace {0} for SP/MI {1}', parameters('amlWorkspaceName'), parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]])]"
              }
            }
          ],
          "outputs": {
            "amlWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Azure ML workspace resource ID where roles were assigned"
              },
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('amlWorkspaceName'))]"
            },
            "userRoleAssignmentCount": {
              "type": "int",
              "metadata": {
                "description": "Number of user role assignments created"
              },
              "value": "[mul(length(parameters('projectTeamGroupOrUser')), 2)]"
            },
            "spMiRoleAssignmentCount": {
              "type": "int",
              "metadata": {
                "description": "Number of SP/MI role assignments created"
              },
              "value": "[mul(length(parameters('servicePrincipleAndMIArray')), 2)]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-rbacUsersAIHub{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('amlExists')), parameters('enableAzureMachineLearning'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacSubnetAml{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[variables('subnetSubscriptionId')]",
      "resourceGroup": "[variables('subnetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vNetName": {
            "value": "[variables('subnetVNetName')]"
          },
          "subnetName": {
            "value": "[variables('subnetName')]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "user_object_ids": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "18342583910794035510"
            }
          },
          "parameters": {
            "vNetName": {
              "type": "string"
            },
            "subnetName": {
              "type": "string"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "user_object_ids": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "resources": [
            {
              "copy": {
                "name": "networkContributorUserSubnet",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', parameters('vNetName'), parameters('subnetName'))]",
              "name": "[guid(format('{0}-nwContributor-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('subnetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Network Contributor to USER with OID {0} for subnet: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('subnetName'))]"
              }
            },
            {
              "copy": {
                "name": "networkContributorSPSubnet",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', parameters('vNetName'), parameters('subnetName'))]",
              "name": "[guid(format('{0}-nwContribSP-{1}-{2}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('subnetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('Network Contributor to SERVICE PRINCIPAL with OID {0} for subnet: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('subnetName'))]"
              }
            }
          ],
          "outputs": {
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet resource ID where Network Contributor was assigned"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vNetName'), parameters('subnetName'))]"
            },
            "userRoleAssignmentCount": {
              "type": "int",
              "metadata": {
                "description": "Number of user role assignments created"
              },
              "value": "[length(parameters('user_object_ids'))]"
            },
            "spMiRoleAssignmentCount": {
              "type": "int",
              "metadata": {
                "description": "Number of SP/MI role assignments created"
              },
              "value": "[length(parameters('servicePrincipleAndMIArray'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('08-rbacGenAIUsVn{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('08-rbacSubnetHub{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[variables('subnetSubscriptionId')]",
      "resourceGroup": "[variables('subnetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vNetName": {
            "value": "[variables('subnetVNetName')]"
          },
          "subnetName": {
            "value": "[variables('subnetName')]"
          },
          "servicePrincipleAndMIArray": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "user_object_ids": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "18342583910794035510"
            }
          },
          "parameters": {
            "vNetName": {
              "type": "string"
            },
            "subnetName": {
              "type": "string"
            },
            "servicePrincipleAndMIArray": {
              "type": "array"
            },
            "user_object_ids": {
              "type": "array"
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "resources": [
            {
              "copy": {
                "name": "networkContributorUserSubnet",
                "count": "[length(range(0, length(parameters('user_object_ids'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', parameters('vNetName'), parameters('subnetName'))]",
              "name": "[guid(format('{0}-nwContributor-{1}-{2}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('subnetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "[format('Network Contributor to USER with OID {0} for subnet: {1}', parameters('user_object_ids')[range(0, length(parameters('user_object_ids')))[copyIndex()]], parameters('subnetName'))]"
              }
            },
            {
              "copy": {
                "name": "networkContributorSPSubnet",
                "count": "[length(range(0, length(parameters('servicePrincipleAndMIArray'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', parameters('vNetName'), parameters('subnetName'))]",
              "name": "[guid(format('{0}-nwContribSP-{1}-{2}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('subnetName'), resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]]]",
                "principalType": "ServicePrincipal",
                "description": "[format('Network Contributor to SERVICE PRINCIPAL with OID {0} for subnet: {1}', parameters('servicePrincipleAndMIArray')[range(0, length(parameters('servicePrincipleAndMIArray')))[copyIndex()]], parameters('subnetName'))]"
              }
            }
          ],
          "outputs": {
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet resource ID where Network Contributor was assigned"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vNetName'), parameters('subnetName'))]"
            },
            "userRoleAssignmentCount": {
              "type": "int",
              "metadata": {
                "description": "Number of user role assignments created"
              },
              "value": "[length(parameters('user_object_ids'))]"
            },
            "spMiRoleAssignmentCount": {
              "type": "int",
              "metadata": {
                "description": "Number of SP/MI role assignments created"
              },
              "value": "[length(parameters('servicePrincipleAndMIArray'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('08-rbacGenAIUsVn{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('08-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]"
      ]
    }
  ],
  "outputs": {
    "keystoreAndBastionRbacDeployed": {
      "type": "bool",
      "metadata": {
        "description": "Key Vault and Bastion RBAC deployment status"
      },
      "value": "[or(and(empty(parameters('bastionResourceGroup')), parameters('addBastionHost')), and(not(empty(parameters('bastionResourceGroup'))), not(empty(parameters('bastionSubscription')))))]"
    },
    "aiServicesRbacDeployed": {
      "type": "bool",
      "metadata": {
        "description": "AI Services RBAC deployment status"
      },
      "value": "[or(or(and(parameters('enableAzureOpenAI'), not(parameters('openaiExists'))), and(not(parameters('aiServicesExists')), parameters('enableAIServices'))), and(not(parameters('aiSearchExists')), parameters('enableAISearch')))]"
    },
    "aiHubMlRbacDeployed": {
      "type": "bool",
      "metadata": {
        "description": "AI Hub and ML Platform RBAC deployment status"
      },
      "value": "[or(or(and(and(not(parameters('aiHubExists')), not(empty(parameters('azureMachineLearningObjectId')))), parameters('enableAIFoundryHub')), and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub'))), and(not(parameters('aiSearchExists')), parameters('enableAISearch')))]"
    },
    "optionalCognitiveRbacDeployed": {
      "type": "bool",
      "metadata": {
        "description": "Optional Cognitive Services RBAC deployment status"
      },
      "value": "[or(or(parameters('enableAzureAIVision'), parameters('enableAzureSpeech')), parameters('enableAIDocIntelligence'))]"
    },
    "networkRbacDeployed": {
      "type": "bool",
      "metadata": {
        "description": "Network and VNet RBAC deployment status"
      },
      "value": "[or(and(parameters('addBastionHost'), empty(parameters('bastionSubscription'))), and(parameters('addBastionHost'), not(empty(parameters('bastionSubscription')))))]"
    },
    "commonResourceGroupRbacDeployed": {
      "type": "bool",
      "metadata": {
        "description": "Common Resource Group RBAC deployment status"
      },
      "value": "[parameters('useCommonACR')]"
    },
    "dataLakeRbacDeployed": {
      "type": "bool",
      "metadata": {
        "description": "Data Lake RBAC deployment status"
      },
      "value": "[or(and(not(parameters('aiHubExists')), parameters('enableAIFoundryHub')), and(not(parameters('amlExists')), parameters('enableAzureMachineLearning')))]"
    }
  }
}