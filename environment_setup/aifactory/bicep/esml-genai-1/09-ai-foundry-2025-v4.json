{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "14980684007735544069"
    }
  },
  "parameters": {
    "env": {
      "type": "string",
      "allowedValues": [
        "dev",
        "test",
        "prod"
      ],
      "metadata": {
        "description": "Environment: dev, test, prod"
      }
    },
    "containerAppsEnvExists": {
      "type": "bool",
      "defaultValue": false
    },
    "projectNumber": {
      "type": "string",
      "metadata": {
        "description": "Project number (e.g., \"005\")"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "locationSuffix": {
      "type": "string",
      "metadata": {
        "description": "Location suffix (e.g., \"weu\", \"swc\")"
      }
    },
    "commonResourceSuffix": {
      "type": "string",
      "metadata": {
        "description": "Common resource suffix (e.g., \"-001\")"
      }
    },
    "resourceSuffix": {
      "type": "string",
      "metadata": {
        "description": "Project-specific resource suffix"
      }
    },
    "enableAIFoundry": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable AI Foundry 2 features"
      }
    },
    "aiFoundryV2Exists": {
      "type": "bool",
      "defaultValue": false
    },
    "enableAIFactoryCreatedDefaultProjectForAIFv2": {
      "type": "bool",
      "defaultValue": true
    },
    "aiFoundryV2ProjectExists": {
      "type": "bool",
      "defaultValue": false
    },
    "foundryV22AccountOnly": {
      "type": "bool",
      "defaultValue": false
    },
    "useAVMFoundry": {
      "type": "bool",
      "defaultValue": false
    },
    "updateAIFoundry": {
      "type": "bool",
      "defaultValue": false
    },
    "addAIFoundry": {
      "type": "bool",
      "defaultValue": false
    },
    "diagnosticSettingLevel": {
      "type": "string",
      "defaultValue": "silver",
      "allowedValues": [
        "gold",
        "silver",
        "bronze"
      ],
      "metadata": {
        "description": "Diagnostic setting level for monitoring and logging"
      }
    },
    "enableCaphost": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Capability host for AI Foundry - BYO network and resources for thread, vector, storage"
      }
    },
    "enableAISearch": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable AI Search integration"
      }
    },
    "enableAISearchSharedPrivateLink": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable shared private link connections from Azure AI Search"
      }
    },
    "cmk": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Customer Managed Keys (CMK) encryption"
      }
    },
    "cmkKeyName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Customer Managed Key in Key Vault"
      }
    },
    "cmkKeyVersion": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Version of the Customer Managed Key in Key Vault"
      }
    },
    "enableCosmosDB": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Cosmos DB integration"
      }
    },
    "deployModel_gpt_X": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy GPT-X model"
      }
    },
    "modelGPTXName": {
      "type": "string",
      "defaultValue": "gpt-5-mini",
      "metadata": {
        "description": "GPT-X model name if deploying"
      }
    },
    "modelGPTXVersion": {
      "type": "string",
      "defaultValue": "1",
      "metadata": {
        "description": "GPT-X model version if deploying"
      }
    },
    "modelGPTXSku": {
      "type": "string",
      "defaultValue": "DataZoneStandard",
      "allowedValues": [
        "Standard",
        "DataZoneStandard",
        "GlobalStandard"
      ]
    },
    "modelGPTXCapacity": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "TPM:Tokens per Minute Rate Limit in K=1000) 30 meaning 30K"
      }
    },
    "deployModel_text_embedding_ada_002": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy text-embedding-ada-002 model"
      }
    },
    "deployModel_text_embedding_3_large": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy text-embedding-3-large model"
      }
    },
    "deployModel_text_embedding_3_small": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to deploy text-embedding-3-small model"
      }
    },
    "default_embedding_capacity": {
      "type": "int",
      "defaultValue": 25,
      "metadata": {
        "description": "Default capacity for embedding models"
      }
    },
    "default_gpt_capacity": {
      "type": "int",
      "defaultValue": 40,
      "metadata": {
        "description": "Default capacity for GPT models"
      }
    },
    "deployModel_gpt_4o": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy GPT-4o model"
      }
    },
    "default_gpt_4o_version": {
      "type": "string",
      "defaultValue": "2024-11-20"
    },
    "deployModel_gpt_4o_mini": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to deploy GPT-4o-mini model"
      }
    },
    "default_gpt_4o_mini_version": {
      "type": "string",
      "defaultValue": "2024-07-18"
    },
    "default_model_sku": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard",
        "DataZoneStandard",
        "GlobalStandard"
      ],
      "metadata": {
        "description": "Default SKU for models"
      }
    },
    "enablePublicAccessWithPerimeter": {
      "type": "bool",
      "defaultValue": false
    },
    "centralDnsZoneByPolicyInHub": {
      "type": "bool",
      "defaultValue": false
    },
    "genaiSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Required subnet IDs from subnet calculator: genai-1"
      }
    },
    "aksSubnetId": {
      "type": "string"
    },
    "acaSubnetId": {
      "type": "string"
    },
    "aca2SubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional subnets from subnet calculator: all"
      }
    },
    "aks2SubnetId": {
      "type": "string",
      "defaultValue": ""
    },
    "dbxPubSubnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "if projectype is not genai-1, but instead all"
      }
    },
    "dbxPrivSubnetName": {
      "type": "string",
      "defaultValue": ""
    },
    "vnetNameBase": {
      "type": "string"
    },
    "vnetResourceGroup_param": {
      "type": "string",
      "defaultValue": ""
    },
    "vnetNameFull_param": {
      "type": "string",
      "defaultValue": ""
    },
    "network_env": {
      "type": "string",
      "defaultValue": ""
    },
    "common_subnet_name": {
      "type": "string"
    },
    "subnetCommon": {
      "type": "string",
      "defaultValue": ""
    },
    "privDnsSubscription_param": {
      "type": "string",
      "defaultValue": ""
    },
    "privDnsResourceGroup_param": {
      "type": "string",
      "defaultValue": ""
    },
    "commonResourceGroup_param": {
      "type": "string",
      "defaultValue": ""
    },
    "tagsProject": {
      "type": "object",
      "defaultValue": {}
    },
    "aifactorySuffixRG": {
      "type": "string"
    },
    "commonRGNamePrefix": {
      "type": "string"
    },
    "aifactorySalt10char": {
      "type": "string",
      "defaultValue": ""
    },
    "randomValue": {
      "type": "string"
    },
    "technicalAdminsObjectID": {
      "type": "string",
      "defaultValue": ""
    },
    "technicalAdminsEmail": {
      "type": "string",
      "defaultValue": ""
    },
    "subscriptionIdDevTestProd": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]"
    },
    "projectPrefix": {
      "type": "string",
      "defaultValue": "esml-"
    },
    "projectSuffix": {
      "type": "string",
      "defaultValue": "-rg"
    },
    "addAISearch": {
      "type": "bool",
      "defaultValue": false
    },
    "inputKeyvault": {
      "type": "string"
    },
    "inputKeyvaultResourcegroup": {
      "type": "string"
    },
    "inputKeyvaultSubscription": {
      "type": "string"
    },
    "projectServicePrincipleOID_SeedingKeyvaultName": {
      "type": "string"
    },
    "useAdGroups": {
      "type": "bool",
      "defaultValue": true
    },
    "IPwhiteList": {
      "type": "string",
      "defaultValue": ""
    },
    "enablePublicGenAIAccess": {
      "type": "bool",
      "defaultValue": false
    },
    "allowPublicAccessWhenBehindVnet": {
      "type": "bool",
      "defaultValue": false
    },
    "disableAgentNetworkInjection": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Disable agent network injection even when agentSubnetResourceId is provided."
      }
    },
    "commonResourceName": {
      "type": "string",
      "defaultValue": "esml-common",
      "metadata": {
        "description": "Common resource name identifier. Default is \"esml-common\""
      }
    },
    "apiManagementResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional existing API Management resource ID used for private endpoint wiring."
      }
    },
    "enableDefenderforAISubLevel": {
      "type": "bool",
      "defaultValue": false
    },
    "enableDefenderforAIResourceLevel": {
      "type": "bool",
      "defaultValue": false
    }
  },
  "variables": {
    "copy": [
      {
        "name": "processedIpRules_ensure_32",
        "count": "[length(variables('filteredIpWhitelist_array'))]",
        "input": {
          "action": "Allow",
          "value": "[if(contains(variables('filteredIpWhitelist_array')[copyIndex('processedIpRules_ensure_32')], '/'), variables('filteredIpWhitelist_array')[copyIndex('processedIpRules_ensure_32')], format('{0}/32', variables('filteredIpWhitelist_array')[copyIndex('processedIpRules_ensure_32')]))]"
        }
      },
      {
        "name": "processedIpRules_remove32",
        "count": "[length(variables('filteredIpWhitelist_array'))]",
        "input": {
          "action": "Allow",
          "value": "[if(endsWith(variables('filteredIpWhitelist_array')[copyIndex('processedIpRules_remove32')], '/32'), substring(variables('filteredIpWhitelist_array')[copyIndex('processedIpRules_remove32')], 0, sub(length(variables('filteredIpWhitelist_array')[copyIndex('processedIpRules_remove32')]), 3)), variables('filteredIpWhitelist_array')[copyIndex('processedIpRules_remove32')])]"
        }
      },
      {
        "name": "aiFoundryDeployments",
        "count": "[length(variables('aiModels'))]",
        "input": {
          "name": "[variables('aiModels')[copyIndex('aiFoundryDeployments')].modelName]",
          "model": {
            "name": "[variables('aiModels')[copyIndex('aiFoundryDeployments')].modelName]",
            "format": "OpenAI",
            "version": "[variables('aiModels')[copyIndex('aiFoundryDeployments')].version]"
          },
          "sku": {
            "name": "[variables('aiModels')[copyIndex('aiFoundryDeployments')].skuLocation]",
            "capacity": "[variables('aiModels')[copyIndex('aiFoundryDeployments')].capacity]"
          },
          "raiPolicyName": "Microsoft.DefaultV2",
          "versionUpgradeOption": "OnceNewDefaultVersionAvailable"
        }
      }
    ],
    "projectName": "[format('prj{0}', parameters('projectNumber'))]",
    "commonResourceGroup": "[if(not(empty(parameters('commonResourceGroup_param'))), parameters('commonResourceGroup_param'), format('{0}{1}-{2}-{3}{4}', parameters('commonRGNamePrefix'), parameters('commonResourceName'), parameters('locationSuffix'), parameters('env'), parameters('aifactorySuffixRG')))]",
    "targetResourceGroup": "[format('{0}{1}{2}-{3}-{4}{5}{6}', parameters('commonRGNamePrefix'), parameters('projectPrefix'), replace(variables('projectName'), 'prj', 'project'), parameters('locationSuffix'), parameters('env'), parameters('aifactorySuffixRG'), parameters('projectSuffix'))]",
    "vnetNameFull": "[if(not(empty(parameters('vnetNameFull_param'))), replace(parameters('vnetNameFull_param'), '<network_env>', parameters('network_env')), format('{0}-{1}-{2}{3}', parameters('vnetNameBase'), parameters('locationSuffix'), parameters('env'), parameters('commonResourceSuffix')))]",
    "vnetResourceGroupName": "[if(not(empty(parameters('vnetResourceGroup_param'))), replace(parameters('vnetResourceGroup_param'), '<network_env>', parameters('network_env')), variables('commonResourceGroup'))]",
    "privDnsResourceGroupName": "[if(and(not(empty(parameters('privDnsResourceGroup_param'))), parameters('centralDnsZoneByPolicyInHub')), parameters('privDnsResourceGroup_param'), variables('vnetResourceGroupName'))]",
    "privDnsSubscription": "[if(and(not(empty(parameters('privDnsSubscription_param'))), parameters('centralDnsZoneByPolicyInHub')), parameters('privDnsSubscription_param'), parameters('subscriptionIdDevTestProd'))]",
    "randomSalt": "[substring(uniqueString(subscription().subscriptionId, variables('targetResourceGroup')), 0, 5)]",
    "deploymentProjSpecificUniqueSuffix": "[format('{0}{1}{2}', variables('projectName'), parameters('env'), variables('randomSalt'))]",
    "useCosmosForFoundry": "[and(parameters('enableCosmosDB'), not(or(parameters('disableAgentNetworkInjection'), parameters('enableCaphost'))))]",
    "commonSubnetPends": "[if(not(equals(parameters('subnetCommon'), '')), replace(parameters('subnetCommon'), '<network_env>', parameters('network_env')), parameters('common_subnet_name'))]",
    "ipWhitelist_array": "[if(not(empty(parameters('IPwhiteList'))), split(parameters('IPwhiteList'), ','), createArray())]",
    "filteredIpWhitelist_array": "[filter(variables('ipWhitelist_array'), lambda('ip', greater(length(lambdaVariables('ip')), 5)))]",
    "cmnName_Static": "cmn",
    "uniqueInAIFenv_Static": "[substring(uniqueString(subscriptionResourceId(parameters('subscriptionIdDevTestProd'), 'Microsoft.Resources/resourceGroups', variables('commonResourceGroup'))), 0, 5)]",
    "laWorkspaceName_Static": "[format('la-{0}-{1}-{2}-{3}{4}', variables('cmnName_Static'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv_Static'), parameters('commonResourceSuffix'))]",
    "defaultProjectDescription": "Enterprise Scale AI Factory (v1.24) Foundry creation of project for with enterprise grade security and your corp networking.",
    "aiModels": "[concat(if(parameters('deployModel_gpt_X'), createArray(createObject('modelName', parameters('modelGPTXName'), 'version', parameters('modelGPTXVersion'), 'capacity', parameters('modelGPTXCapacity'), 'skuLocation', parameters('modelGPTXSku'))), createArray()), if(parameters('deployModel_gpt_4o_mini'), createArray(createObject('modelName', 'gpt-4o-mini', 'version', parameters('default_gpt_4o_mini_version'), 'capacity', parameters('default_gpt_capacity'), 'skuLocation', parameters('default_model_sku'))), createArray()), if(parameters('deployModel_gpt_4o'), createArray(createObject('modelName', 'gpt-4o', 'version', parameters('default_gpt_4o_version'), 'capacity', parameters('default_gpt_capacity'), 'skuLocation', parameters('default_model_sku'))), createArray()), if(parameters('deployModel_text_embedding_ada_002'), createArray(createObject('modelName', 'text-embedding-ada-002', 'version', '2', 'capacity', parameters('default_embedding_capacity'), 'skuLocation', parameters('default_model_sku'))), createArray()), if(parameters('deployModel_text_embedding_3_large'), createArray(createObject('modelName', 'text-embedding-3-large', 'version', '1', 'capacity', parameters('default_embedding_capacity'), 'skuLocation', parameters('default_model_sku'))), createArray()), if(parameters('deployModel_text_embedding_3_small'), createArray(createObject('modelName', 'text-embedding-3-small', 'version', '1', 'capacity', parameters('default_embedding_capacity'), 'skuLocation', parameters('default_model_sku'))), createArray()))]",
    "shouldCreateNetworkAcls": "[or(or(or(not(empty(variables('processedIpRules_remove32'))), parameters('enablePublicGenAIAccess')), parameters('enablePublicAccessWithPerimeter')), parameters('allowPublicAccessWhenBehindVnet'))]",
    "networkAclVirtualNetworkRules": "[concat(createArray(createObject('id', parameters('genaiSubnetId'), 'ignoreMissingVnetServiceEndpoint', true())), if(not(empty(parameters('aca2SubnetId'))), createArray(createObject('id', parameters('aca2SubnetId'), 'ignoreMissingVnetServiceEndpoint', true())), createArray()))]",
    "networkAcls": "[if(variables('shouldCreateNetworkAcls'), createObject('defaultAction', if(and(parameters('enablePublicGenAIAccess'), empty(variables('processedIpRules_remove32'))), 'Allow', 'Deny'), 'virtualNetworkRules', variables('networkAclVirtualNetworkRules'), 'ipRules', if(empty(variables('processedIpRules_remove32')), createArray(), variables('processedIpRules_remove32'))), null())]",
    "networkAclsEmpty": {
      "defaultAction": "Deny",
      "virtualNetworkRules": [],
      "ipRules": []
    },
    "networkAclsObject": "[variables('networkAcls')]",
    "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68",
    "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908",
    "openAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
    "openAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
    "azureAIDeveloperRoleId": "64702f94-c441-49e6-a78b-ef80e0188fee",
    "keyVaultSecretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6",
    "keyVaultContributorRoleId": "f25e0fa2-a7c8-4377-a976-54943a77a395",
    "keyVaultSecretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
    "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c",
    "readerRoleId": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
    "hasModelDeploymentsV22": "[greater(length(variables('aiFoundryDeployments')), 0)]",
    "defaultModelDeploymentV22": "[if(variables('hasModelDeploymentsV22'), variables('aiFoundryDeployments')[0], createObject('name', 'gpt-4o', 'model', createObject('name', 'gpt-4o', 'format', 'OpenAI', 'version', parameters('default_gpt_4o_version')), 'sku', createObject('name', parameters('default_model_sku'), 'capacity', parameters('default_gpt_capacity')), 'raiPolicyName', 'Microsoft.DefaultV2', 'versionUpgradeOption', 'OnceNewDefaultVersionAvailable'))]",
    "extraModelDeploymentsV22": "[if(and(variables('hasModelDeploymentsV22'), greater(length(variables('aiFoundryDeployments')), 1)), skip(variables('aiFoundryDeployments'), 1), createArray())]",
    "defaultModelNameV22": "[string(variables('defaultModelDeploymentV22').model.name)]",
    "defaultModelFormatV22": "[string(variables('defaultModelDeploymentV22').model.format)]",
    "defaultModelVersionV22": "[string(variables('defaultModelDeploymentV22').model.version)]",
    "defaultModelSkuNameV22": "[string(variables('defaultModelDeploymentV22').sku.name)]",
    "defaultModelCapacityV22": "[int(variables('defaultModelDeploymentV22').sku.capacity)]",
    "requiresAcaDelegation": "[and(and(parameters('enableAIFoundry'), not(parameters('aiFoundryV2Exists'))), not(parameters('disableAgentNetworkInjection')))]",
    "safeLocation": "[toLower(parameters('location'))]",
    "acaLocationEndpoint": "[format('{0}.ext.azurecontainerapps.dev', variables('safeLocation'))]",
    "mcrLocationEndpoint": "[format('{0}.data.mcr.microsoft.com', variables('safeLocation'))]",
    "deployAvmFoundry": "[and(and(parameters('useAVMFoundry'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly'))))]",
    "shouldDeployFoundryPrivateEndpoints": "[and(not(parameters('foundryV22AccountOnly')), parameters('enableAIFoundry'))]",
    "projectModuleEnabled": "[parameters('enableAIFactoryCreatedDefaultProjectForAIFv2')]",
    "searchIndexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
    "searchIndexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
    "searchServiceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
    "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "storageFileDataPrivilegedContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
    "storageFileDataSMBPrivilegedContributorRoleId": "0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb",
    "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
    "enableSharedLinkDeployment": "[and(and(and(parameters('enableAISearchSharedPrivateLink'), parameters('enableAISearch')), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-naming-{0}', variables('targetResourceGroup')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "env": {
            "value": "[parameters('env')]"
          },
          "projectNumber": {
            "value": "[parameters('projectNumber')]"
          },
          "locationSuffix": {
            "value": "[parameters('locationSuffix')]"
          },
          "commonResourceSuffix": {
            "value": "[parameters('commonResourceSuffix')]"
          },
          "resourceSuffix": {
            "value": "[parameters('resourceSuffix')]"
          },
          "aifactorySalt10char": {
            "value": "[parameters('aifactorySalt10char')]"
          },
          "randomValue": {
            "value": "[parameters('randomValue')]"
          },
          "aifactorySuffixRG": {
            "value": "[parameters('aifactorySuffixRG')]"
          },
          "commonRGNamePrefix": {
            "value": "[parameters('commonRGNamePrefix')]"
          },
          "technicalAdminsObjectID": {
            "value": "[parameters('technicalAdminsObjectID')]"
          },
          "technicalAdminsEmail": {
            "value": "[parameters('technicalAdminsEmail')]"
          },
          "commonResourceGroupName": {
            "value": "[variables('commonResourceGroup')]"
          },
          "subscriptionIdDevTestProd": {
            "value": "[parameters('subscriptionIdDevTestProd')]"
          },
          "acaSubnetId": {
            "value": "[parameters('acaSubnetId')]"
          },
          "aksSubnetId": {
            "value": "[parameters('aksSubnetId')]"
          },
          "genaiSubnetId": {
            "value": "[parameters('genaiSubnetId')]"
          },
          "aca2SubnetId": {
            "value": "[parameters('aca2SubnetId')]"
          },
          "aks2SubnetId": {
            "value": "[parameters('aks2SubnetId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "18054918805968624102"
            }
          },
          "definitions": {
            "aifactoryNamingType": {
              "type": "object",
              "properties": {
                "genaiSubnetName": {
                  "type": "string"
                },
                "aksSubnetName": {
                  "type": "string"
                },
                "aks2SubnetName": {
                  "type": "string"
                },
                "acaSubnetName": {
                  "type": "string"
                },
                "aca2SubnetName": {
                  "type": "string"
                },
                "defaultSubnet": {
                  "type": "string"
                },
                "aifV1HubName": {
                  "type": "string"
                },
                "aifV1ProjectName": {
                  "type": "string"
                },
                "aifV2Name": {
                  "type": "string"
                },
                "aifV2PrjName": {
                  "type": "string"
                },
                "aifV2NameAdd": {
                  "type": "string"
                },
                "aifV2PrjNameAdd": {
                  "type": "string"
                },
                "aoaiName": {
                  "type": "string"
                },
                "amlName": {
                  "type": "string"
                },
                "safeNameAISearch": {
                  "type": "string"
                },
                "aiServicesName": {
                  "type": "string"
                },
                "dashboardInsightsName": {
                  "type": "string"
                },
                "applicationInsightName": {
                  "type": "string"
                },
                "applicationInsightName2": {
                  "type": "string"
                },
                "bingName": {
                  "type": "string"
                },
                "containerAppsEnvName": {
                  "type": "string"
                },
                "containerAppAName": {
                  "type": "string"
                },
                "containerAppWName": {
                  "type": "string"
                },
                "cosmosDBName": {
                  "type": "string"
                },
                "redisName": {
                  "type": "string"
                },
                "postgreSQLName": {
                  "type": "string"
                },
                "sqlServerName": {
                  "type": "string"
                },
                "sqlDBName": {
                  "type": "string"
                },
                "functionAppName": {
                  "type": "string"
                },
                "webAppName": {
                  "type": "string"
                },
                "funcAppServicePlanName": {
                  "type": "string"
                },
                "webbAppServicePlanName": {
                  "type": "string"
                },
                "vmName": {
                  "type": "string"
                },
                "keyvaultName": {
                  "type": "string"
                },
                "storageAccount1001Name": {
                  "type": "string"
                },
                "storageAccount2001Name": {
                  "type": "string"
                },
                "acrProjectName": {
                  "type": "string"
                },
                "acrCommonName": {
                  "type": "string"
                },
                "miACAName": {
                  "type": "string"
                },
                "miPrjName": {
                  "type": "string"
                },
                "laWorkspaceName": {
                  "type": "string"
                },
                "projectName": {
                  "type": "string"
                },
                "cmnName": {
                  "type": "string"
                },
                "kvNameCommon": {
                  "type": "string"
                },
                "genaiName": {
                  "type": "string"
                },
                "prjResourceSuffixNoDash": {
                  "type": "string"
                },
                "twoNumbers": {
                  "type": "string"
                },
                "p011_genai_team_lead_array": {
                  "type": "array"
                },
                "p011_genai_team_lead_email_array": {
                  "type": "array"
                },
                "uniqueInAIFenv": {
                  "type": "string"
                },
                "randomSalt": {
                  "type": "string"
                },
                "projectTypeESMLName": {
                  "type": "string"
                },
                "projectTypeGenAIName": {
                  "type": "string"
                },
                "aksClusterName": {
                  "type": "string"
                },
                "dataFactoryName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../types/aifactoryNaming.bicep"
                }
              }
            }
          },
          "parameters": {
            "env": {
              "type": "string",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Environment: dev, test, prod"
              }
            },
            "keepMIandKVsuffixAs001": {
              "type": "bool",
              "defaultValue": false
            },
            "projectNumber": {
              "type": "string",
              "metadata": {
                "description": "Project number (e.g., \"005\")"
              }
            },
            "locationSuffix": {
              "type": "string",
              "metadata": {
                "description": "Location suffix (e.g., \"weu\", \"swc\")"
              }
            },
            "commonResourceSuffix": {
              "type": "string",
              "metadata": {
                "description": "Common resource suffix (e.g., \"-001\")"
              }
            },
            "resourceSuffix": {
              "type": "string",
              "metadata": {
                "description": "Project-specific resource suffix"
              }
            },
            "aifactorySalt10char": {
              "type": "string",
              "metadata": {
                "description": "Random salt for unique naming"
              }
            },
            "randomValue": {
              "type": "string"
            },
            "aifactorySuffixRG": {
              "type": "string",
              "metadata": {
                "description": "AI Factory suffix for resource groups"
              }
            },
            "commonRGNamePrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Common resource group name prefix"
              }
            },
            "technicalAdminsObjectID": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "User Admins OID list"
              }
            },
            "technicalAdminsEmail": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "User Admins EMAIL list"
              }
            },
            "commonResourceGroupName": {
              "type": "string"
            },
            "subscriptionIdDevTestProd": {
              "type": "string"
            },
            "genaiSubnetId": {
              "type": "string"
            },
            "aksSubnetId": {
              "type": "string"
            },
            "aks2SubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "acaSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "aca2SubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "postGresAdminEmails": {
              "type": "string",
              "defaultValue": ""
            },
            "addAIFoundryHub": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Add AI Foundry Hub with random naming for debugging/testing"
              }
            },
            "addAzureMachineLearning": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Add Azure Machine Learning with random naming for debugging/testing"
              }
            }
          },
          "variables": {
            "projectName": "[format('prj{0}', parameters('projectNumber'))]",
            "cmnName": "cmn",
            "genaiName": "genai",
            "prjResourceSuffixNoDash": "[replace(parameters('resourceSuffix'), '-', '')]",
            "twoNumbers": "[substring(parameters('resourceSuffix'), 2, 2)]",
            "resourceSuffixPlusOne": "[format('-{0}', padLeft(string(add(int(substring(parameters('resourceSuffix'), 1, 3)), 1)), 3, '0'))]",
            "technicalAdminsObjectID_array": "[array(split(replace(parameters('technicalAdminsObjectID'), '\\s+', ''), ','))]",
            "p011_genai_team_lead_array": "[if(empty(parameters('technicalAdminsObjectID')), createArray(), union(variables('technicalAdminsObjectID_array'), createArray()))]",
            "postGresAdminEmailsLocal_array": "[array(split(replace(parameters('postGresAdminEmails'), '\\s+', ''), ','))]",
            "postGresAdminEmailsLocal": "[if(empty(parameters('postGresAdminEmails')), createArray(), union(variables('postGresAdminEmailsLocal_array'), createArray()))]",
            "technicalAdminsEmail_array": "[array(split(parameters('technicalAdminsEmail'), ','))]",
            "p011_genai_team_lead_email_array": "[if(empty(parameters('technicalAdminsEmail')), createArray(), variables('technicalAdminsEmail_array'))]",
            "randomSalt": "[if(or(empty(parameters('aifactorySalt10char')), lessOrEquals(length(parameters('aifactorySalt10char')), 5)), substring(parameters('randomValue'), 0, 10), parameters('aifactorySalt10char'))]",
            "uniqueInAIFenv": "[substring(uniqueString(subscriptionResourceId(parameters('subscriptionIdDevTestProd'), 'Microsoft.Resources/resourceGroups', parameters('commonResourceGroupName'))), 0, 5)]",
            "cleanRandomValue": "[toLower(replace(replace(variables('randomSalt'), '-', ''), '_', ''))]",
            "aifRandom": "[take(variables('cleanRandomValue'), 2)]",
            "aifWithRandom": "[take(format('aif-hub-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('aifRandom'), parameters('resourceSuffix')), 64)]",
            "aifV1HubName": "[if(parameters('addAIFoundryHub'), variables('aifWithRandom'), format('aif-hub-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix')))]",
            "aifV1ProjectName": "[format('aif-p-{0}-1-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "aifV2Name": "[take(replace(toLower(format('aif2{0}{1}', variables('uniqueInAIFenv'), variables('randomSalt'))), '-', ''), 12)]",
            "aifV2PrjName": "[take(toLower(format('aif2-p{0}-{1}{2}', parameters('projectNumber'), variables('uniqueInAIFenv'), variables('randomSalt'))), 12)]",
            "lastSuffixChar": "[if(and(not(empty(parameters('resourceSuffix'))), greater(length(parameters('resourceSuffix')), 0)), substring(parameters('resourceSuffix'), max(0, sub(length(parameters('resourceSuffix')), 1)), 1), '')]",
            "aif2Random": "[take(format('aif2{0}{1}', variables('lastSuffixChar'), variables('cleanRandomValue')), 12)]",
            "aifp2Random": "[take(format('aif2-p{0}-{1}{2}', parameters('projectNumber'), variables('lastSuffixChar'), variables('cleanRandomValue')), 12)]",
            "aifV2NameAdd": "[variables('aif2Random')]",
            "aifV2PrjNameAdd": "[variables('aifp2Random')]",
            "aoaiName": "[format('aoai-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "amlWithRandom": "[take(format('aml-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('aifRandom'), parameters('resourceSuffix')), 64)]",
            "amlName": "[if(parameters('addAzureMachineLearning'), variables('amlWithRandom'), format('aml-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix')))]",
            "safeNameAISearch": "[take(replace(toLower(format('aisearch{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('prjResourceSuffixNoDash'))), '-', ''), 64)]",
            "aiServicesName": "[take(replace(toLower(format('aiservices{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('prjResourceSuffixNoDash'))), '-', ''), 64)]",
            "dashboardInsightsName": "[format('AIFactory{0}-{1}-insights-{2}-{3}{4}', parameters('aifactorySuffixRG'), variables('projectName'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "applicationInsightName": "[format('ain-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "applicationInsightName2": "[format('ain-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('resourceSuffixPlusOne'))]",
            "bingName": "[format('bing-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppsEnvName": "[format('aca-env-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppAName": "[format('aca-a-{0}{1}{2}{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppWName": "[format('aca-w-{0}{1}{2}{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "cosmosDBName": "[format('cosmos-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "redisName": "[format('redis-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "postgreSQLName": "[format('pg-flex-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "sqlServerName": "[format('sql-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "sqlDBName": "[format('sqldb-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "functionAppName": "[format('func-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "webAppName": "[format('webapp-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "funcAppServicePlanName": "[format('func-{0}-{1}-{2}-{3}{4}-plan', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "webbAppServicePlanName": "[format('webapp-{0}-{1}-{2}-{3}{4}-plan', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "vmName": "[format('dsvm-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "keyvaultName": "[format('kv-p{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('twoNumbers'))]",
            "storageAccount1001Name": "[replace(format('sa{0}{1}{2}1{3}{4}', variables('projectName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), variables('prjResourceSuffixNoDash'), parameters('env')), '-', '')]",
            "storageAccount2001Name": "[replace(format('sa{0}{1}{2}2{3}{4}', variables('projectName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), variables('prjResourceSuffixNoDash'), parameters('env')), '-', '')]",
            "acrProjectName": "[format('acr{0}{1}{2}{3}{4}{5}', variables('projectName'), variables('genaiName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), parameters('env'), variables('prjResourceSuffixNoDash'))]",
            "acrCommonName": "[replace(format('acrcommon{0}{1}{2}{3}', variables('uniqueInAIFenv'), parameters('locationSuffix'), parameters('commonResourceSuffix'), parameters('env')), '-', '')]",
            "miSuffix": "[if(parameters('keepMIandKVsuffixAs001'), '-001', parameters('resourceSuffix'))]",
            "miACAName": "[format('mi-aca-{0}-{1}-{2}-{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('miSuffix'))]",
            "miPrjName": "[format('mi-{0}-{1}-{2}-{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('miSuffix'))]",
            "laWorkspaceName": "[format('la-{0}-{1}-{2}-{3}{4}', variables('cmnName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]",
            "segments": "[split(parameters('genaiSubnetId'), '/')]",
            "genaiSubnetName": "[variables('segments')[sub(length(variables('segments')), 1)]]",
            "defaultSubnet": "[variables('genaiSubnetName')]",
            "segmentsAKS": "[split(parameters('aksSubnetId'), '/')]",
            "segmentsAKS2": "[split(parameters('aks2SubnetId'), '/')]",
            "aksSubnetName": "[variables('segmentsAKS')[sub(length(variables('segmentsAKS')), 1)]]",
            "aks2SubnetName": "[variables('segmentsAKS2')[sub(length(variables('segmentsAKS2')), 1)]]",
            "segmentsACA": "[split(parameters('acaSubnetId'), '/')]",
            "segmentsACA2": "[split(parameters('aca2SubnetId'), '/')]",
            "acaSubnetName": "[variables('segmentsACA')[sub(length(variables('segmentsACA')), 1)]]",
            "aca2SubnetName": "[variables('segmentsACA2')[sub(length(variables('segmentsACA2')), 1)]]",
            "adfName": "[format('adf-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]"
          },
          "resources": {
            "commonResourceGroupRef": {
              "existing": true,
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-07-01",
              "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
              "name": "[parameters('commonResourceGroupName')]"
            }
          },
          "outputs": {
            "genaiSubnetName": {
              "type": "string",
              "value": "[variables('genaiSubnetName')]"
            },
            "aksSubnetName": {
              "type": "string",
              "value": "[variables('aksSubnetName')]"
            },
            "aks2SubnetName": {
              "type": "string",
              "value": "[variables('aks2SubnetName')]"
            },
            "acaSubnetName": {
              "type": "string",
              "value": "[variables('acaSubnetName')]"
            },
            "aca2SubnetName": {
              "type": "string",
              "value": "[variables('aca2SubnetName')]"
            },
            "defaultSubnet": {
              "type": "string",
              "value": "[variables('defaultSubnet')]"
            },
            "aoaiName": {
              "type": "string",
              "value": "[variables('aoaiName')]"
            },
            "amlName": {
              "type": "string",
              "value": "[variables('amlName')]"
            },
            "safeNameAISearch": {
              "type": "string",
              "value": "[variables('safeNameAISearch')]"
            },
            "aiServicesName": {
              "type": "string",
              "value": "[variables('aiServicesName')]"
            },
            "dashboardInsightsName": {
              "type": "string",
              "value": "[variables('dashboardInsightsName')]"
            },
            "applicationInsightName": {
              "type": "string",
              "value": "[variables('applicationInsightName')]"
            },
            "applicationInsightName2": {
              "type": "string",
              "value": "[variables('applicationInsightName2')]"
            },
            "bingName": {
              "type": "string",
              "value": "[variables('bingName')]"
            },
            "containerAppsEnvName": {
              "type": "string",
              "value": "[variables('containerAppsEnvName')]"
            },
            "containerAppAName": {
              "type": "string",
              "value": "[variables('containerAppAName')]"
            },
            "containerAppWName": {
              "type": "string",
              "value": "[variables('containerAppWName')]"
            },
            "cosmosDBName": {
              "type": "string",
              "value": "[variables('cosmosDBName')]"
            },
            "redisName": {
              "type": "string",
              "value": "[variables('redisName')]"
            },
            "postgreSQLName": {
              "type": "string",
              "value": "[variables('postgreSQLName')]"
            },
            "sqlServerName": {
              "type": "string",
              "value": "[variables('sqlServerName')]"
            },
            "sqlDBName": {
              "type": "string",
              "value": "[variables('sqlDBName')]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[variables('functionAppName')]"
            },
            "webAppName": {
              "type": "string",
              "value": "[variables('webAppName')]"
            },
            "funcAppServicePlanName": {
              "type": "string",
              "value": "[variables('funcAppServicePlanName')]"
            },
            "webbAppServicePlanName": {
              "type": "string",
              "value": "[variables('webbAppServicePlanName')]"
            },
            "vmName": {
              "type": "string",
              "value": "[variables('vmName')]"
            },
            "aifV1HubName": {
              "type": "string",
              "value": "[variables('aifV1HubName')]"
            },
            "aifV1ProjectName": {
              "type": "string",
              "value": "[variables('aifV1ProjectName')]"
            },
            "aifV2Name": {
              "type": "string",
              "value": "[variables('aifV2Name')]"
            },
            "aifV2PrjName": {
              "type": "string",
              "value": "[variables('aifV2PrjName')]"
            },
            "aifV2NameAdd": {
              "type": "string",
              "value": "[variables('aifV2NameAdd')]"
            },
            "aifV2PrjNameAdd": {
              "type": "string",
              "value": "[variables('aifV2PrjNameAdd')]"
            },
            "keyvaultName": {
              "type": "string",
              "value": "[variables('keyvaultName')]"
            },
            "storageAccount1001Name": {
              "type": "string",
              "value": "[variables('storageAccount1001Name')]"
            },
            "storageAccount2001Name": {
              "type": "string",
              "value": "[variables('storageAccount2001Name')]"
            },
            "acrProjectName": {
              "type": "string",
              "value": "[variables('acrProjectName')]"
            },
            "acrCommonName": {
              "type": "string",
              "value": "[variables('acrCommonName')]"
            },
            "miACAName": {
              "type": "string",
              "value": "[variables('miACAName')]"
            },
            "miPrjName": {
              "type": "string",
              "value": "[variables('miPrjName')]"
            },
            "laWorkspaceName": {
              "type": "string",
              "value": "[variables('laWorkspaceName')]"
            },
            "projectName": {
              "type": "string",
              "value": "[variables('projectName')]"
            },
            "cmnName": {
              "type": "string",
              "value": "[variables('cmnName')]"
            },
            "kvNameCommon": {
              "type": "string",
              "value": "[format('kv-{0}{1}-{2}{3}', variables('cmnName'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]"
            },
            "genaiName": {
              "type": "string",
              "value": "[variables('genaiName')]"
            },
            "prjResourceSuffixNoDash": {
              "type": "string",
              "value": "[variables('prjResourceSuffixNoDash')]"
            },
            "twoNumbers": {
              "type": "string",
              "value": "[variables('twoNumbers')]"
            },
            "p011_genai_team_lead_array": {
              "type": "array",
              "value": "[variables('p011_genai_team_lead_array')]"
            },
            "postGresAdminEmails": {
              "type": "array",
              "value": "[variables('postGresAdminEmailsLocal')]"
            },
            "p011_genai_team_lead_email_array": {
              "type": "array",
              "value": "[variables('p011_genai_team_lead_email_array')]"
            },
            "uniqueInAIFenv": {
              "type": "string",
              "value": "[variables('uniqueInAIFenv')]"
            },
            "randomSalt": {
              "type": "string",
              "value": "[variables('randomSalt')]"
            },
            "projectTypeESMLName": {
              "type": "string",
              "value": "esml"
            },
            "projectTypeGenAIName": {
              "type": "string",
              "value": "genai"
            },
            "aksClusterName": {
              "type": "string",
              "value": "[format('esml{0}-{1}-{2}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'))]"
            },
            "dataFactoryName": {
              "type": "string",
              "value": "[variables('adfName')]"
            },
            "namingConvention": {
              "$ref": "#/definitions/aifactoryNamingType",
              "value": {
                "genaiSubnetName": "[variables('genaiSubnetName')]",
                "aksSubnetName": "[variables('aksSubnetName')]",
                "aks2SubnetName": "[variables('aks2SubnetName')]",
                "acaSubnetName": "[variables('acaSubnetName')]",
                "aca2SubnetName": "[variables('aca2SubnetName')]",
                "defaultSubnet": "[variables('defaultSubnet')]",
                "aifV1HubName": "[variables('aifV1HubName')]",
                "aifV1ProjectName": "[variables('aifV1ProjectName')]",
                "aifV2Name": "[variables('aifV2Name')]",
                "aifV2PrjName": "[variables('aifV2PrjName')]",
                "aifV2NameAdd": "[variables('aifV2NameAdd')]",
                "aifV2PrjNameAdd": "[variables('aifV2PrjNameAdd')]",
                "aoaiName": "[variables('aoaiName')]",
                "amlName": "[variables('amlName')]",
                "safeNameAISearch": "[variables('safeNameAISearch')]",
                "aiServicesName": "[variables('aiServicesName')]",
                "dashboardInsightsName": "[variables('dashboardInsightsName')]",
                "applicationInsightName": "[variables('applicationInsightName')]",
                "applicationInsightName2": "[variables('applicationInsightName2')]",
                "bingName": "[variables('bingName')]",
                "containerAppsEnvName": "[variables('containerAppsEnvName')]",
                "containerAppAName": "[variables('containerAppAName')]",
                "containerAppWName": "[variables('containerAppWName')]",
                "cosmosDBName": "[variables('cosmosDBName')]",
                "redisName": "[variables('redisName')]",
                "postgreSQLName": "[variables('postgreSQLName')]",
                "sqlServerName": "[variables('sqlServerName')]",
                "sqlDBName": "[variables('sqlDBName')]",
                "functionAppName": "[variables('functionAppName')]",
                "webAppName": "[variables('webAppName')]",
                "funcAppServicePlanName": "[variables('funcAppServicePlanName')]",
                "webbAppServicePlanName": "[variables('webbAppServicePlanName')]",
                "vmName": "[variables('vmName')]",
                "keyvaultName": "[variables('keyvaultName')]",
                "storageAccount1001Name": "[variables('storageAccount1001Name')]",
                "storageAccount2001Name": "[variables('storageAccount2001Name')]",
                "acrProjectName": "[variables('acrProjectName')]",
                "acrCommonName": "[variables('acrCommonName')]",
                "miACAName": "[variables('miACAName')]",
                "miPrjName": "[variables('miPrjName')]",
                "laWorkspaceName": "[variables('laWorkspaceName')]",
                "projectName": "[variables('projectName')]",
                "cmnName": "[variables('cmnName')]",
                "kvNameCommon": "[format('kv-{0}{1}-{2}{3}', variables('cmnName'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]",
                "genaiName": "[variables('genaiName')]",
                "prjResourceSuffixNoDash": "[variables('prjResourceSuffixNoDash')]",
                "twoNumbers": "[variables('twoNumbers')]",
                "p011_genai_team_lead_array": "[variables('p011_genai_team_lead_array')]",
                "p011_genai_team_lead_email_array": "[variables('p011_genai_team_lead_email_array')]",
                "uniqueInAIFenv": "[variables('uniqueInAIFenv')]",
                "randomSalt": "[variables('randomSalt')]",
                "projectTypeESMLName": "esml",
                "projectTypeGenAIName": "genai",
                "aksClusterName": "[format('esml{0}-{1}-{2}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'))]",
                "dataFactoryName": "[variables('adfName')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-getMI-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.miPrjName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "1018302119329499090"
            }
          },
          "parameters": {
            "managedIdentityName": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity name"
              }
            }
          },
          "resources": [],
          "outputs": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').clientId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Managed identity name"
              },
              "value": "[parameters('managedIdentityName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-getAcaMI-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.miACAName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "1018302119329499090"
            }
          },
          "parameters": {
            "managedIdentityName": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity name"
              }
            }
          },
          "resources": [],
          "outputs": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the managed identity"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').clientId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed identity"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Managed identity name"
              },
              "value": "[parameters('managedIdentityName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityOID": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getMI-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.principalId.value]"
          },
          "servicePrincipleOIDFromSecret": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('inputKeyvaultSubscription'), parameters('inputKeyvaultResourcegroup')), 'Microsoft.KeyVault/vaults', parameters('inputKeyvault'))]"
              },
              "secretName": "[parameters('projectServicePrincipleOID_SeedingKeyvaultName')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4489054275663592001"
            }
          },
          "parameters": {
            "servicePrincipleOIDFromSecret": {
              "type": "securestring"
            },
            "managedIdentityOID": {
              "type": "string"
            }
          },
          "variables": {
            "toArray": [
              "[parameters('servicePrincipleOIDFromSecret')]",
              "[parameters('managedIdentityOID')]"
            ]
          },
          "resources": [],
          "outputs": {
            "spAndMiArray": {
              "type": "array",
              "value": "[variables('toArray')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getMI-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "privDnsResourceGroupName": {
            "value": "[variables('privDnsResourceGroupName')]"
          },
          "privDnsSubscription": {
            "value": "[variables('privDnsSubscription')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5482015564862547528"
            }
          },
          "parameters": {
            "privDnsSubscription": {
              "type": "string"
            },
            "privDnsResourceGroupName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "variables": {
            "privateDnsZoneName": {
              "azureusgovernment": "privatelink.api.ml.azure.us",
              "azurechinacloud": "privatelink.api.ml.azure.cn",
              "azurecloud": "privatelink.api.azureml.ms"
            },
            "privateAznbDnsZoneName": {
              "azureusgovernment": "privatelink.notebooks.usgovcloudapi.net",
              "azurechinacloud": "privatelink.notebooks.chinacloudapi.cn",
              "azurecloud": "privatelink.notebooks.azure.net"
            },
            "privateLinksDnsZones": {
              "blob": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.blob.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.blob.{0}', environment().suffixes.storage)]"
              },
              "file": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.file.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.file.{0}', environment().suffixes.storage)]"
              },
              "dfs": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.dfs.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.dfs.{0}', environment().suffixes.storage)]"
              },
              "queue": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.queue.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.queue.{0}', environment().suffixes.storage)]"
              },
              "table": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.table.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.table.{0}', environment().suffixes.storage)]"
              },
              "registry": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azurecr.io', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azurecr.io"
              },
              "registryregion": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/{2}.data.privatelink.azurecr.io', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), parameters('location'))]",
                "name": "[format('{0}.data.privatelink.azurecr.io', parameters('location'))]"
              },
              "vault": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.vaultcore.azure.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.vaultcore.azure.net"
              },
              "amlworkspace": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), variables('privateDnsZoneName')[toLower(environment().name)])]",
                "name": "[variables('privateDnsZoneName')[toLower(environment().name)]]"
              },
              "notebooks": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), variables('privateAznbDnsZoneName')[toLower(environment().name)])]",
                "name": "[variables('privateAznbDnsZoneName')[toLower(environment().name)]]"
              },
              "dataFactory": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.datafactory.azure.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.datafactory.azure.net"
              },
              "portal": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.adf.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.adf.azure.com"
              },
              "openai": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.openai.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.openai.azure.com"
              },
              "searchService": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.search.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.search.windows.net"
              },
              "azurewebapps": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azurewebsites.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azurewebsites.net"
              },
              "cosmosdbnosql": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.documents.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.documents.azure.com"
              },
              "cognitiveservices": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.cognitiveservices.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.cognitiveservices.azure.com"
              },
              "azuredatabricks": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azuredatabricks.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azuredatabricks.net"
              },
              "namespace": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.servicebus.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.servicebus.windows.net"
              },
              "azureeventgrid": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.eventgrid.azure.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.eventgrid.azure.net"
              },
              "azuremonitor": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.monitor.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.monitor.azure.com"
              },
              "azuremonitoroms": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.oms.opinsights.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.oms.opinsights.azure.com"
              },
              "azuremonitorods": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.ods.opinsights.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.ods.opinsights.azure.com"
              },
              "azuremonitoragentsvc": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.agentsvc.azure-automation.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.agentsvc.azure-automation.net"
              },
              "servicesai": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.services.ai.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.services.ai.azure.com"
              },
              "azurecontainerapps": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.{2}.azurecontainerapps.io', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), parameters('location'))]",
                "name": "[format('privatelink.{0}.azurecontainerapps.io', parameters('location'))]"
              },
              "redis": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.redis.cache.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.redis.cache.windows.net"
              },
              "postgres": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.postgres.database.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.postgres.database.azure.com"
              },
              "sql": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.database.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.database.windows.net"
              },
              "cosmosdbmongo": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.mongo.cosmos.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.mongo.cosmos.azure.com"
              },
              "apim": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azure-api.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azure-api.net"
              }
            }
          },
          "resources": [],
          "outputs": {
            "privateLinksDnsZones": {
              "type": "object",
              "value": "[variables('privateLinksDnsZones')]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(parameters('enableAISearch'), not(parameters('foundryV22AccountOnly')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-getAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": "[if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "3552789832125951078"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Search service"
              }
            }
          },
          "resources": [],
          "outputs": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the AI Search service system-assigned managed identity"
              },
              "value": "[reference(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), '2023-11-01', 'full').identity.principalId]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the AI Search service"
              },
              "value": "[resourceId('Microsoft.Search/searchServices', parameters('aiSearchName'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Search service"
              },
              "value": "[parameters('aiSearchName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(and(parameters('enableAIFoundry'), not(parameters('foundryV22AccountOnly'))), or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-roleBuilder-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "servicePrincipalIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "cognitiveServicesUserRoleId": {
            "value": "[variables('cognitiveServicesUserRoleId')]"
          },
          "cognitiveServicesContributorRoleId": {
            "value": "[variables('cognitiveServicesContributorRoleId')]"
          },
          "openAIUserRoleId": {
            "value": "[variables('openAIUserRoleId')]"
          },
          "openAIContributorRoleId": {
            "value": "[variables('openAIContributorRoleId')]"
          },
          "azureAIDeveloperRoleId": {
            "value": "[variables('azureAIDeveloperRoleId')]"
          },
          "keyVaultSecretsUserRoleId": {
            "value": "[variables('keyVaultSecretsUserRoleId')]"
          },
          "keyVaultContributorRoleId": {
            "value": "[variables('keyVaultContributorRoleId')]"
          },
          "storageBlobDataReaderRoleId": {
            "value": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "enableAISearch": {
            "value": "[parameters('enableAISearch')]"
          },
          "aiSearchPrincipalId": "[if(parameters('enableAISearch'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.principalId.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "678233841375157927"
            }
          },
          "definitions": {
            "roleAssignmentType": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                  }
                },
                "roleDefinitionIdOrName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                  }
                },
                "principalId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                  }
                },
                "principalType": {
                  "type": "string",
                  "allowedValues": [
                    "Device",
                    "ForeignGroup",
                    "Group",
                    "ServicePrincipal",
                    "User"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The principal type of the assigned principal ID."
                  }
                },
                "description": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The description of the role assignment."
                  }
                },
                "condition": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                  }
                },
                "conditionVersion": {
                  "type": "string",
                  "allowedValues": [
                    "2.0"
                  ],
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Version of the condition."
                  }
                },
                "delegatedManagedIdentityResourceId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                  }
                }
              },
              "metadata": {
                "description": "An AVM-aligned type for a role assignment.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                }
              }
            }
          },
          "parameters": {
            "userObjectIds": {
              "type": "array",
              "metadata": {
                "description": "Array of user object IDs"
              }
            },
            "servicePrincipalIds": {
              "type": "array",
              "metadata": {
                "description": "Array of service principal IDs"
              }
            },
            "cognitiveServicesUserRoleId": {
              "type": "string",
              "metadata": {
                "description": "Cognitive Services User role ID"
              }
            },
            "cognitiveServicesContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Cognitive Services Contributor role ID"
              }
            },
            "openAIUserRoleId": {
              "type": "string",
              "metadata": {
                "description": "OpenAI User role ID"
              }
            },
            "openAIContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "OpenAI Contributor role ID"
              }
            },
            "azureAIDeveloperRoleId": {
              "type": "string",
              "metadata": {
                "description": "Azure AI Developer role ID - Required for Chat with Data scenarios"
              }
            },
            "keyVaultSecretsUserRoleId": {
              "type": "string",
              "defaultValue": "4633458b-17de-408a-b874-0445c86b69e6",
              "metadata": {
                "description": "Key Vault Secrets User role ID - Required for Agent playground"
              }
            },
            "keyVaultContributorRoleId": {
              "type": "string",
              "defaultValue": "f25e0fa2-a7c8-4377-a976-54943a77a395",
              "metadata": {
                "description": "Key Vault Contributor role ID - Required for managing Agent secrets"
              }
            },
            "storageBlobDataReaderRoleId": {
              "type": "string",
              "defaultValue": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
              "metadata": {
                "description": "Storage Blob Data Reader role ID - Required for AI Search to access storage"
              }
            },
            "useAdGroups": {
              "type": "bool",
              "metadata": {
                "description": "Whether to use AD Groups"
              }
            },
            "enableAISearch": {
              "type": "bool",
              "defaultValue": false
            },
            "aiSearchPrincipalId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "copy": [
              {
                "name": "userRoleAssignments",
                "count": "[length(parameters('userObjectIds'))]",
                "input": {
                  "principalId": "[parameters('userObjectIds')[copyIndex('userRoleAssignments')]]",
                  "roleDefinitionIdOrName": "[parameters('cognitiveServicesUserRoleId')]",
                  "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]"
                }
              },
              {
                "name": "userOpenAIRoleAssignments",
                "count": "[length(parameters('userObjectIds'))]",
                "input": {
                  "principalId": "[parameters('userObjectIds')[copyIndex('userOpenAIRoleAssignments')]]",
                  "roleDefinitionIdOrName": "[parameters('openAIUserRoleId')]",
                  "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]"
                }
              },
              {
                "name": "spCognitiveRoleAssignments",
                "count": "[length(parameters('servicePrincipalIds'))]",
                "input": {
                  "principalId": "[parameters('servicePrincipalIds')[copyIndex('spCognitiveRoleAssignments')]]",
                  "roleDefinitionIdOrName": "[parameters('cognitiveServicesContributorRoleId')]",
                  "principalType": "ServicePrincipal"
                }
              },
              {
                "name": "spOpenAIRoleAssignments",
                "count": "[length(parameters('servicePrincipalIds'))]",
                "input": {
                  "principalId": "[parameters('servicePrincipalIds')[copyIndex('spOpenAIRoleAssignments')]]",
                  "roleDefinitionIdOrName": "[parameters('openAIContributorRoleId')]",
                  "principalType": "ServicePrincipal"
                }
              },
              {
                "name": "userKeyVaultRoleAssignments",
                "count": "[length(parameters('userObjectIds'))]",
                "input": {
                  "principalId": "[parameters('userObjectIds')[copyIndex('userKeyVaultRoleAssignments')]]",
                  "roleDefinitionIdOrName": "[parameters('keyVaultSecretsUserRoleId')]",
                  "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]"
                }
              },
              {
                "name": "spKeyVaultRoleAssignments",
                "count": "[length(parameters('servicePrincipalIds'))]",
                "input": {
                  "principalId": "[parameters('servicePrincipalIds')[copyIndex('spKeyVaultRoleAssignments')]]",
                  "roleDefinitionIdOrName": "[parameters('keyVaultContributorRoleId')]",
                  "principalType": "ServicePrincipal"
                }
              }
            ],
            "aiSearchRoleAssignments": "[if(and(parameters('enableAISearch'), not(empty(parameters('aiSearchPrincipalId')))), createArray(createObject('principalId', parameters('aiSearchPrincipalId'), 'roleDefinitionIdOrName', parameters('cognitiveServicesContributorRoleId'), 'principalType', 'ServicePrincipal'), createObject('principalId', parameters('aiSearchPrincipalId'), 'roleDefinitionIdOrName', parameters('openAIContributorRoleId'), 'principalType', 'ServicePrincipal'), createObject('principalId', parameters('aiSearchPrincipalId'), 'roleDefinitionIdOrName', parameters('openAIUserRoleId'), 'principalType', 'ServicePrincipal'), createObject('principalId', parameters('aiSearchPrincipalId'), 'roleDefinitionIdOrName', parameters('storageBlobDataReaderRoleId'), 'principalType', 'ServicePrincipal')), createArray())]",
            "allRoleAssignments": "[concat(variables('userRoleAssignments'), variables('userOpenAIRoleAssignments'), variables('userKeyVaultRoleAssignments'), variables('spCognitiveRoleAssignments'), variables('spOpenAIRoleAssignments'), variables('spKeyVaultRoleAssignments'), variables('aiSearchRoleAssignments'))]"
          },
          "resources": {},
          "outputs": {
            "roleAssignments": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/roleAssignmentType"
              },
              "metadata": {
                "description": "Combined role assignments array"
              },
              "value": "[variables('allRoleAssignments')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[variables('requiresAcaDelegation')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "resourceGroup": "[variables('vnetResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnetName": {
            "value": "[variables('vnetNameFull')]"
          },
          "subnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aca2SubnetName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetResourceGroupName": {
            "value": "[variables('vnetResourceGroupName')]"
          },
          "delegations": {
            "value": [
              {
                "name": "aca-delegation",
                "properties": {
                  "serviceName": "Microsoft.App/environments"
                }
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "6568380384425102977"
            }
          },
          "parameters": {
            "vnetName": {
              "type": "string"
            },
            "subnetName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "vnetResourceGroupName": {
              "type": "string"
            },
            "addressPrefix": {
              "type": "string",
              "defaultValue": ""
            },
            "existingAddressPrefix": {
              "type": "string",
              "defaultValue": ""
            },
            "serviceEndpoints": {
              "type": "array",
              "defaultValue": []
            },
            "delegations": {
              "type": "array"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('vnetName'), parameters('subnetName'))]",
              "properties": {
                "addressPrefix": "[if(not(empty(parameters('addressPrefix'))), parameters('addressPrefix'), if(not(empty(parameters('existingAddressPrefix'))), parameters('existingAddressPrefix'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.addressPrefix.value))]",
                "serviceEndpoints": "[if(not(empty(parameters('serviceEndpoints'))), parameters('serviceEndpoints'), if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.serviceEndpoints.value)), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.serviceEndpoints.value, null()))]",
                "routeTable": "[if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.routeTableId.value)), createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.routeTableId.value), null())]",
                "networkSecurityGroup": "[if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.networkSecurityGroupId.value)), createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.networkSecurityGroupId.value), null())]",
                "natGateway": "[if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.natGatewayId.value)), createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.natGatewayId.value), null())]",
                "delegations": "[parameters('delegations')]",
                "privateEndpointNetworkPolicies": "[if(not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.privateEndpointNetworkPolicies.value, 'Disabled')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.privateEndpointNetworkPolicies.value, 'Disabled')]",
                "privateLinkServiceNetworkPolicies": "[if(not(equals(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.privateLinkServiceNetworkPolicies.value, 'Enabled')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name))), '2022-09-01').outputs.privateLinkServiceNetworkPolicies.value, 'Enabled')]"
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Resources/deployments', format('get-snet-props-{0}', uniqueString(deployment().name)))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('get-snet-props-{0}', uniqueString(deployment().name))]",
              "resourceGroup": "[parameters('vnetResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vnetName": {
                    "value": "[parameters('vnetName')]"
                  },
                  "subnetName": {
                    "value": "[parameters('subnetName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "13551110709222064036"
                    }
                  },
                  "parameters": {
                    "vnetName": {
                      "type": "string"
                    },
                    "subnetName": {
                      "type": "string"
                    }
                  },
                  "resources": [],
                  "outputs": {
                    "addressPrefix": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').addressPrefix]"
                    },
                    "serviceEndpoints": {
                      "type": "array",
                      "value": "[if(contains(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01'), 'serviceEndpoints'), reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').serviceEndpoints, createArray())]"
                    },
                    "delegations": {
                      "type": "array",
                      "value": "[if(contains(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01'), 'delegations'), reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').delegations, createArray())]"
                    },
                    "networkSecurityGroupId": {
                      "type": "string",
                      "value": "[if(contains(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01'), 'networkSecurityGroup'), reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').networkSecurityGroup.id, '')]"
                    },
                    "routeTableId": {
                      "type": "string",
                      "value": "[if(contains(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01'), 'routeTable'), reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').routeTable.id, '')]"
                    },
                    "natGatewayId": {
                      "type": "string",
                      "value": "[if(contains(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01'), 'natGateway'), reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').natGateway.id, '')]"
                    },
                    "privateEndpointNetworkPolicies": {
                      "type": "string",
                      "value": "[if(contains(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01'), 'privateEndpointNetworkPolicies'), reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').privateEndpointNetworkPolicies, 'Disabled')]"
                    },
                    "privateLinkServiceNetworkPolicies": {
                      "type": "string",
                      "value": "[if(contains(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01'), 'privateLinkServiceNetworkPolicies'), reference(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName')), '2024-05-01').privateLinkServiceNetworkPolicies, 'Enabled')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "subnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
            },
            "subnetName": {
              "type": "string",
              "value": "[parameters('subnetName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(parameters('foundryV22AccountOnly'), parameters('enableAIFoundry')), not(parameters('useAVMFoundry'))), not(parameters('aiFoundryV2Exists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "allowedFqdnList": {
            "value": "[reduce(filter(createArray(format('privatelink.blob.{0}', environment().suffixes.storage), 'privatelink.cognitiveservices.azure.com', 'privatelink.documents.azure.com', format('privatelink.file.{0}', environment().suffixes.storage), 'privatelink.openai.azure.com', 'privatelink.search.windows.net', 'privatelink.services.ai.azure.com', format('{0}.blob.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value, environment().suffixes.storage), format('{0}.file.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value, environment().suffixes.storage), format('{0}.queue.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value, environment().suffixes.storage), format('{0}.blob.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value, environment().suffixes.storage), format('{0}.file.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value, environment().suffixes.storage), format('{0}.queue.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value, environment().suffixes.storage), if(parameters('enableAISearch'), format('{0}.search.windows.net', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60), '')), ''), format('{0}{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.keyvaultName.value, environment().suffixes.keyvaultDns), if(variables('useCosmosForFoundry'), format('{0}.documents.azure.com', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value), ''), format('{0}.cognitiveservices.azure.com', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), format('{0}.openai.azure.com', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), 'mcr.microsoft.com', variables('mcrLocationEndpoint'), variables('acaLocationEndpoint'), 'graph.microsoft.com', 'login.identity.azure.net', format('{0}.identity.azure.net', tenant().tenantId), 'sts.identity.azure.net', 'login.microsoft.com', 'account.login.microsoft.com', 'portal.login.microsoft.com', 'oauth.login.microsoft.com', 'secure.login.microsoft.com', 'sso.login.microsoft.com', 'device.login.microsoft.com', 'hub.docker.com', 'registry-1.docker.io', 'production.cloudflare.docker.com'), lambda('fqdnEntry', not(empty(lambdaVariables('fqdnEntry'))))), createArray(), lambda('current', 'next', if(contains(lambdaVariables('current'), lambdaVariables('next')), lambdaVariables('current'), union(lambdaVariables('current'), createArray(lambdaVariables('next'))))))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "foundryV22AccountOnly": {
            "value": "[parameters('foundryV22AccountOnly')]"
          },
          "aiAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "firstProjectName": "[if(parameters('enableAIFactoryCreatedDefaultProjectForAIFv2'), if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value)), createObject('value', format('{0}def', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value))))]",
          "projectDescription": {
            "value": "[variables('defaultProjectDescription')]"
          },
          "displayName": "[if(parameters('enableAIFactoryCreatedDefaultProjectForAIFv2'), if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value)), createObject('value', format('{0}def', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value))))]",
          "privateEndpointSubnetResourceId": {
            "value": "[parameters('genaiSubnetId')]"
          },
          "agentSubnetResourceId": "[if(and(not(parameters('disableAgentNetworkInjection')), not(empty(parameters('aca2SubnetId')))), createObject('value', parameters('aca2SubnetId')), createObject('value', ''))]",
          "disableAgentNetworkInjection": {
            "value": "[parameters('disableAgentNetworkInjection')]"
          },
          "allowPublicAccessWhenBehindVnet": {
            "value": "[parameters('allowPublicAccessWhenBehindVnet')]"
          },
          "enablePublicGenAIAccess": {
            "value": "[parameters('enablePublicGenAIAccess')]"
          },
          "ipAllowList": {
            "value": "[variables('filteredIpWhitelist_array')]"
          },
          "enableCapabilityHost": {
            "value": "[parameters('enableCaphost')]"
          },
          "projectCapHost": {
            "value": "[format('{0}caphost', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]"
          },
          "userRoleObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "servicePrincipalIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "extraModelDeployments": {
            "value": "[variables('extraModelDeploymentsV22')]"
          },
          "modelName": {
            "value": "[variables('defaultModelNameV22')]"
          },
          "modelFormat": {
            "value": "[variables('defaultModelFormatV22')]"
          },
          "modelVersion": {
            "value": "[variables('defaultModelVersionV22')]"
          },
          "modelSkuName": {
            "value": "[variables('defaultModelSkuNameV22')]"
          },
          "modelCapacity": {
            "value": "[variables('defaultModelCapacityV22')]"
          },
          "enableCosmosDb": {
            "value": "[variables('useCosmosForFoundry')]"
          },
          "enableAISearch": {
            "value": "[parameters('enableAISearch')]"
          },
          "enableProject": {
            "value": "[parameters('enableAIFactoryCreatedDefaultProjectForAIFv2')]"
          },
          "centralDnsZoneByPolicyInHub": {
            "value": "[parameters('centralDnsZoneByPolicyInHub')]"
          },
          "restrictOutboundNetworkAccess": {
            "value": false
          },
          "tags": {
            "value": "[parameters('tagsProject')]"
          },
          "privateLinksDnsZones": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value]"
          },
          "apiManagementResourceId": {
            "value": "[parameters('apiManagementResourceId')]"
          },
          "azureStorageAccountResourceId": {
            "value": "[resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Storage/storageAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value)]"
          },
          "azureStorageAccountResourceIdSecondary": {
            "value": "[resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Storage/storageAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value)]"
          },
          "azureCosmosDBAccountResourceId": "[if(variables('useCosmosForFoundry'), createObject('value', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value)), createObject('value', ''))]",
          "aiSearchResourceId": "[if(parameters('enableAISearch'), createObject('value', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Search/searchServices', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60), ''))), createObject('value', ''))]",
          "customerManagedKey": "[if(parameters('cmk'), createObject('value', createObject('keyName', parameters('cmkKeyName'), 'keyVaultResourceId', resourceId(parameters('inputKeyvaultSubscription'), parameters('inputKeyvaultResourcegroup'), 'Microsoft.KeyVault/vaults', parameters('inputKeyvault')), 'userAssignedIdentityResourceId', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.ManagedIdentity/userAssignedIdentities', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.miPrjName.value))), createObject('value', null()))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4688361601803930034"
            }
          },
          "definitions": {
            "customerManagedKeyType": {
              "type": "object",
              "properties": {
                "keyVaultResourceId": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The resource ID of a key vault to reference a customer managed key for encryption from."
                  }
                },
                "keyName": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. The name of the customer managed key to use for encryption."
                  }
                },
                "keyVersion": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The version of the customer managed key to reference for encryption. If not provided, the deployment will use the latest version available at deployment time."
                  }
                },
                "userAssignedIdentityResourceId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. User assigned identity to use when fetching the customer managed key. Required if no system assigned identity is available for use."
                  }
                }
              },
              "metadata": {
                "description": "An AVM-aligned type for a customer-managed key. To be used if the resource type does not support auto-rotation of the customer-managed key.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                }
              }
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "foundryV22AccountOnly": {
              "type": "bool",
              "defaultValue": false
            },
            "aiServices": {
              "type": "string",
              "defaultValue": "aiservices",
              "minLength": 3,
              "metadata": {
                "description": "Base name prefix for new AI Services resources when new resources are created."
              }
            },
            "aiAccountName": {
              "type": "string",
              "minLength": 2,
              "maxLength": 64,
              "metadata": {
                "description": "Optional override for the AI Services account name. When empty a unique name is generated."
              }
            },
            "allowedFqdnList": {
              "type": "array",
              "nullable": true,
              "metadata": {
                "description": "Optional. List of allowed FQDN."
              }
            },
            "apiProperties": {
              "type": "object",
              "nullable": true,
              "metadata": {
                "description": "Optional. The API properties for special APIs."
              }
            },
            "customerManagedKey": {
              "$ref": "#/definitions/customerManagedKeyType",
              "nullable": true,
              "metadata": {
                "description": "Optional. The customer managed key definition."
              }
            },
            "deploymentTimestamp": {
              "type": "string",
              "defaultValue": "[utcNow('yyyyMMddHHmmss')]",
              "metadata": {
                "description": "Timestamp used to generate deterministic resource names (format yyyyMMddHHmmss)."
              }
            },
            "firstProjectName": {
              "type": "string",
              "defaultValue": "project",
              "metadata": {
                "description": "Name prefix for the default project."
              }
            },
            "projectDescription": {
              "type": "string",
              "defaultValue": "A project for the AI Foundry account with network secured deployed Agent",
              "metadata": {
                "description": "Description for the default project."
              }
            },
            "displayName": {
              "type": "string",
              "defaultValue": "network secured agent project",
              "metadata": {
                "description": "Display name for the default project."
              }
            },
            "privateEndpointSubnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the subnet used for private endpoints."
              }
            },
            "agentSubnetResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of the subnet used for agent network injection. Leave empty to skip injection."
              }
            },
            "disableAgentNetworkInjection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Disable agent network injection even when an agent subnet is provided."
              }
            },
            "aiSearchResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing AI Search service resource ID. Leave empty to create a new instance."
              }
            },
            "azureStorageAccountResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing primary Storage account resource ID. Leave empty to create a new instance."
              }
            },
            "azureStorageAccountResourceIdSecondary": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing secondary Storage account resource ID. Leave empty to create a new instance for capability host workloads."
              }
            },
            "azureCosmosDBAccountResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing Cosmos DB account resource ID. Leave empty to create a new instance."
              }
            },
            "apiManagementResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing API Management resource ID (for optional private endpoint)."
              }
            },
            "existingDnsZones": {
              "type": "object",
              "defaultValue": {
                "privatelink.services.ai.azure.com": "",
                "privatelink.openai.azure.com": "",
                "privatelink.cognitiveservices.azure.com": "",
                "privatelink.search.windows.net": "",
                "[format('privatelink.blob.{0}', environment().suffixes.storage)]": "",
                "privatelink.documents.azure.com": "",
                "privatelink.azure-api.net": ""
              },
              "metadata": {
                "description": "Object mapping Private DNS zone names to their resource group. Leave value empty to create the zone in the current resource group."
              }
            },
            "privateLinksDnsZones": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Private DNS zones configuration emitted from the networking landing zone."
              }
            },
            "allowPublicAccessWhenBehindVnet": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow public HTTP access while traffic flows through perimeter controls."
              }
            },
            "enablePublicGenAIAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable public access to AI Services endpoints."
              }
            },
            "ipAllowList": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "IP addresses or CIDR ranges allowed through network ACLs when public access is enabled."
              }
            },
            "enableCapabilityHost": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable capability host configuration for the project."
              }
            },
            "projectCapHost": {
              "type": "string",
              "defaultValue": "caphostproj",
              "metadata": {
                "description": "Name suffix for the capability host resource."
              }
            },
            "userRoleObjectIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of user object IDs for Cognitive Services RBAC assignments."
              }
            },
            "servicePrincipalIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of service principal IDs for Cognitive Services RBAC assignments."
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Treat entries in userRoleObjectIds as Azure AD groups instead of users."
              }
            },
            "extraModelDeployments": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Optional list of additional model deployments to create. Expected shape matches Microsoft.CognitiveServices/accounts/deployments properties."
              }
            },
            "modelName": {
              "type": "string",
              "defaultValue": "gpt-4o",
              "metadata": {
                "description": "Model name for the default deployment."
              }
            },
            "modelFormat": {
              "type": "string",
              "defaultValue": "OpenAI",
              "metadata": {
                "description": "Model provider format for the default deployment."
              }
            },
            "modelVersion": {
              "type": "string",
              "defaultValue": "2024-11-20",
              "metadata": {
                "description": "Model version for the default deployment."
              }
            },
            "modelSkuName": {
              "type": "string",
              "defaultValue": "GlobalStandard",
              "metadata": {
                "description": "Model SKU for the default deployment."
              }
            },
            "modelCapacity": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Tokens per minute capacity for the default model deployment."
              }
            },
            "enableCosmosDb": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Cosmos DB integration."
              }
            },
            "enableAISearch": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable AI Search integration."
              }
            },
            "enableProject": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable creation of a default project."
              }
            },
            "centralDnsZoneByPolicyInHub": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Bypass Private DNS zone linking when central DNS zones are managed in a hub."
              }
            },
            "restrictOutboundNetworkAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Restrict outbound network access for the AI Services account."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags applied to newly created resources."
              }
            },
            "aiAccountSku": {
              "type": "string",
              "defaultValue": "S0",
              "allowedValues": [
                "S0",
                "S",
                "S1",
                "S2",
                "S3",
                "S4",
                "S5",
                "S6",
                "S7",
                "S8",
                "S9"
              ],
              "metadata": {
                "description": "SKU tier for the AI Services account."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "ipRules",
                "count": "[length(parameters('ipAllowList'))]",
                "input": {
                  "value": "[if(contains(parameters('ipAllowList')[copyIndex('ipRules')], '/'), toLower(parameters('ipAllowList')[copyIndex('ipRules')]), format('{0}/24', toLower(parameters('ipAllowList')[copyIndex('ipRules')])))]"
                }
              }
            ],
            "accountName": "[parameters('aiAccountName')]",
            "agentNetworkInjectionEnabled": "[and(not(parameters('disableAgentNetworkInjection')), not(empty(parameters('agentSubnetResourceId'))))]",
            "networkAclVirtualNetworkRules": "[concat(if(not(empty(parameters('privateEndpointSubnetResourceId'))), createArray(createObject('id', parameters('privateEndpointSubnetResourceId'), 'ignoreMissingVnetServiceEndpoint', true())), createArray()), if(variables('agentNetworkInjectionEnabled'), createArray(createObject('id', parameters('agentSubnetResourceId'), 'ignoreMissingVnetServiceEndpoint', true())), createArray()))]",
            "hasNetworkAcls": "[or(or(or(not(empty(variables('ipRules'))), parameters('enablePublicGenAIAccess')), parameters('allowPublicAccessWhenBehindVnet')), not(empty(variables('networkAclVirtualNetworkRules'))))]",
            "networkAcls": "[if(variables('hasNetworkAcls'), createObject('defaultAction', if(and(parameters('enablePublicGenAIAccess'), empty(variables('ipRules'))), 'Allow', 'Deny'), 'virtualNetworkRules', variables('networkAclVirtualNetworkRules'), 'ipRules', variables('ipRules'), 'bypass', 'AzureServices'), null())]",
            "publicNetworkAccess": "[if(or(parameters('enablePublicGenAIAccess'), parameters('allowPublicAccessWhenBehindVnet')), 'Enabled', 'Disabled')]",
            "aiAccountId": "[if(parameters('foundryV22AccountOnly'), resourceId('Microsoft.CognitiveServices/accounts', variables('accountName')), '')]"
          },
          "resources": {
            "cMKKeyVault": {
              "condition": "[not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId')))]",
              "existing": true,
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-11-01",
              "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[2]]",
              "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[4]]",
              "name": "[last(split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/'))]"
            },
            "aiAccount": {
              "condition": "[parameters('foundryV22AccountOnly')]",
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[variables('accountName')]",
              "kind": "AIServices",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('aiAccountSku')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "allowedFqdnList": "[parameters('allowedFqdnList')]",
                "apiProperties": "[parameters('apiProperties')]",
                "allowProjectManagement": true,
                "customSubDomainName": "[variables('accountName')]",
                "networkAcls": "[variables('networkAcls')]",
                "publicNetworkAccess": "[variables('publicNetworkAccess')]",
                "disableLocalAuth": false,
                "networkInjections": "[if(variables('agentNetworkInjectionEnabled'), createArray(createObject('scenario', 'agent', 'subnetArmId', parameters('agentSubnetResourceId'), 'useMicrosoftManagedNetwork', false())), null())]",
                "restrictOutboundNetworkAccess": "[parameters('restrictOutboundNetworkAccess')]",
                "dynamicThrottlingEnabled": false
              }
            },
            "kvRbacForAiAccount": {
              "condition": "[and(parameters('foundryV22AccountOnly'), not(empty(parameters('customerManagedKey'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('kvRbac-ai-{0}', variables('accountName')), 64)]",
              "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[2]]",
              "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[4]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[last(split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/'))]"
                  },
                  "principalId": "[if(parameters('foundryV22AccountOnly'), createObject('value', reference('aiAccount', '2025-04-01-preview', 'full').identity.principalId), createObject('value', ''))]",
                  "keyVaultRoleId": {
                    "value": "e147488a-f6f5-4113-8e2d-b22465e65bf6"
                  },
                  "principalType": {
                    "value": "ServicePrincipal"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "8907890740328049297"
                    }
                  },
                  "parameters": {
                    "assignmentName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional deterministic suffix. Leave empty to derive from scope + principal + role."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the Key Vault"
                      }
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID (user, service principal, or managed identity)"
                      }
                    },
                    "keyVaultRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Key Vault role ID to assign"
                      }
                    },
                    "principalType": {
                      "type": "string",
                      "defaultValue": "ServicePrincipal",
                      "allowedValues": [
                        "User",
                        "Group",
                        "ServicePrincipal"
                      ],
                      "metadata": {
                        "description": "Principal type"
                      }
                    },
                    "roleDescription": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional description for the role assignment"
                      }
                    }
                  },
                  "variables": {
                    "assignmentGuid": "[if(empty(parameters('assignmentName')), guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), parameters('keyVaultRoleId')), guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), parameters('keyVaultRoleId'), parameters('assignmentName')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
                      "name": "[variables('assignmentGuid')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultRoleId'))]",
                        "principalId": "[parameters('principalId')]",
                        "principalType": "[parameters('principalType')]",
                        "description": "[if(not(empty(parameters('roleDescription'))), parameters('roleDescription'), format('Key Vault RBAC assignment for {0}', parameters('principalType')))]"
                      }
                    }
                  ],
                  "outputs": {
                    "roleAssignmentCompleted": {
                      "type": "bool",
                      "metadata": {
                        "description": "Role assignment completed successfully"
                      },
                      "value": true
                    },
                    "roleAssignmentId": {
                      "type": "string",
                      "metadata": {
                        "description": "Role assignment resource ID"
                      },
                      "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', variables('assignmentGuid'))]"
                    },
                    "keyVaultId": {
                      "type": "string",
                      "metadata": {
                        "description": "Key Vault resource ID"
                      },
                      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccount"
              ]
            },
            "kvRbacForCosmosDb": {
              "condition": "[and(and(parameters('foundryV22AccountOnly'), not(empty(parameters('customerManagedKey')))), parameters('enableCosmosDb'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('kvRbac-cosmos-{0}', variables('accountName')), 64)]",
              "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[2]]",
              "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[4]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[last(split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/'))]"
                  },
                  "principalId": {
                    "value": "a232010e-820c-4083-83bb-3ace5fc29d0b"
                  },
                  "keyVaultRoleId": {
                    "value": "e147488a-f6f5-4113-8e2d-b22465e65bf6"
                  },
                  "principalType": {
                    "value": "ServicePrincipal"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "8907890740328049297"
                    }
                  },
                  "parameters": {
                    "assignmentName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional deterministic suffix. Leave empty to derive from scope + principal + role."
                      }
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the Key Vault"
                      }
                    },
                    "principalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID (user, service principal, or managed identity)"
                      }
                    },
                    "keyVaultRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Key Vault role ID to assign"
                      }
                    },
                    "principalType": {
                      "type": "string",
                      "defaultValue": "ServicePrincipal",
                      "allowedValues": [
                        "User",
                        "Group",
                        "ServicePrincipal"
                      ],
                      "metadata": {
                        "description": "Principal type"
                      }
                    },
                    "roleDescription": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional description for the role assignment"
                      }
                    }
                  },
                  "variables": {
                    "assignmentGuid": "[if(empty(parameters('assignmentName')), guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), parameters('keyVaultRoleId')), guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), parameters('keyVaultRoleId'), parameters('assignmentName')))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
                      "name": "[variables('assignmentGuid')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultRoleId'))]",
                        "principalId": "[parameters('principalId')]",
                        "principalType": "[parameters('principalType')]",
                        "description": "[if(not(empty(parameters('roleDescription'))), parameters('roleDescription'), format('Key Vault RBAC assignment for {0}', parameters('principalType')))]"
                      }
                    }
                  ],
                  "outputs": {
                    "roleAssignmentCompleted": {
                      "type": "bool",
                      "metadata": {
                        "description": "Role assignment completed successfully"
                      },
                      "value": true
                    },
                    "roleAssignmentId": {
                      "type": "string",
                      "metadata": {
                        "description": "Role assignment resource ID"
                      },
                      "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', variables('assignmentGuid'))]"
                    },
                    "keyVaultId": {
                      "type": "string",
                      "metadata": {
                        "description": "Key Vault resource ID"
                      },
                      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                    }
                  }
                }
              }
            }
          },
          "outputs": {
            "aiAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the cognitive services account."
              },
              "value": "[variables('accountName')]"
            },
            "aiAccountId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the cognitive services account."
              },
              "value": "[variables('aiAccountId')]"
            },
            "aiAccountEndpoint": {
              "type": "string",
              "metadata": {
                "description": "The service endpoint of the cognitive services account."
              },
              "value": "[if(parameters('foundryV22AccountOnly'), reference('aiAccount').endpoint, '')]"
            },
            "aiAccountPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the system assigned identity."
              },
              "value": "[if(parameters('foundryV22AccountOnly'), reference('aiAccount', '2025-04-01-preview', 'full').identity.principalId, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(not(parameters('foundryV22AccountOnly')), parameters('enableAIFoundry')), not(parameters('useAVMFoundry'))), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), parameters('cmk')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "allowedFqdnList": {
            "value": "[reduce(filter(createArray(format('privatelink.blob.{0}', environment().suffixes.storage), 'privatelink.cognitiveservices.azure.com', 'privatelink.documents.azure.com', format('privatelink.file.{0}', environment().suffixes.storage), 'privatelink.openai.azure.com', 'privatelink.search.windows.net', 'privatelink.services.ai.azure.com', format('{0}.blob.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value, environment().suffixes.storage), format('{0}.file.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value, environment().suffixes.storage), format('{0}.queue.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value, environment().suffixes.storage), format('{0}.blob.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value, environment().suffixes.storage), format('{0}.file.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value, environment().suffixes.storage), format('{0}.queue.{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value, environment().suffixes.storage), if(parameters('enableAISearch'), format('{0}.search.windows.net', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60), '')), ''), format('{0}{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.keyvaultName.value, environment().suffixes.keyvaultDns), if(variables('useCosmosForFoundry'), format('{0}.documents.azure.com', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value), ''), format('{0}.cognitiveservices.azure.com', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), format('{0}.openai.azure.com', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), 'mcr.microsoft.com', variables('mcrLocationEndpoint'), variables('acaLocationEndpoint'), 'graph.microsoft.com', 'login.identity.azure.net', format('{0}.identity.azure.net', tenant().tenantId), 'sts.identity.azure.net', 'login.microsoft.com', 'account.login.microsoft.com', 'portal.login.microsoft.com', 'oauth.login.microsoft.com', 'secure.login.microsoft.com', 'sso.login.microsoft.com', 'device.login.microsoft.com', 'hub.docker.com', 'registry-1.docker.io', 'production.cloudflare.docker.com'), lambda('fqdnEntry', not(empty(lambdaVariables('fqdnEntry'))))), createArray(), lambda('current', 'next', if(contains(lambdaVariables('current'), lambdaVariables('next')), lambdaVariables('current'), union(lambdaVariables('current'), createArray(lambdaVariables('next'))))))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "foundryV22AccountOnly": {
            "value": "[parameters('foundryV22AccountOnly')]"
          },
          "aiAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "firstProjectName": "[if(parameters('enableAIFactoryCreatedDefaultProjectForAIFv2'), if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value)), createObject('value', format('{0}def', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value))))]",
          "projectDescription": {
            "value": "[variables('defaultProjectDescription')]"
          },
          "displayName": "[if(parameters('enableAIFactoryCreatedDefaultProjectForAIFv2'), if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value)), createObject('value', format('{0}def', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value))))]",
          "privateEndpointSubnetResourceId": {
            "value": "[parameters('genaiSubnetId')]"
          },
          "agentSubnetResourceId": "[if(and(not(parameters('disableAgentNetworkInjection')), not(empty(parameters('aca2SubnetId')))), createObject('value', parameters('aca2SubnetId')), createObject('value', ''))]",
          "disableAgentNetworkInjection": {
            "value": "[parameters('disableAgentNetworkInjection')]"
          },
          "allowPublicAccessWhenBehindVnet": {
            "value": "[parameters('allowPublicAccessWhenBehindVnet')]"
          },
          "enablePublicGenAIAccess": {
            "value": "[parameters('enablePublicGenAIAccess')]"
          },
          "ipAllowList": {
            "value": "[variables('filteredIpWhitelist_array')]"
          },
          "enableCapabilityHost": {
            "value": "[parameters('enableCaphost')]"
          },
          "projectCapHost": {
            "value": "[format('{0}caphost', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]"
          },
          "userRoleObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "servicePrincipalIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          },
          "extraModelDeployments": {
            "value": "[variables('extraModelDeploymentsV22')]"
          },
          "modelName": {
            "value": "[variables('defaultModelNameV22')]"
          },
          "modelFormat": {
            "value": "[variables('defaultModelFormatV22')]"
          },
          "modelVersion": {
            "value": "[variables('defaultModelVersionV22')]"
          },
          "modelSkuName": {
            "value": "[variables('defaultModelSkuNameV22')]"
          },
          "modelCapacity": {
            "value": "[variables('defaultModelCapacityV22')]"
          },
          "enableCosmosDb": {
            "value": "[variables('useCosmosForFoundry')]"
          },
          "enableAISearch": {
            "value": "[parameters('enableAISearch')]"
          },
          "enableProject": {
            "value": "[parameters('enableAIFactoryCreatedDefaultProjectForAIFv2')]"
          },
          "centralDnsZoneByPolicyInHub": {
            "value": "[parameters('centralDnsZoneByPolicyInHub')]"
          },
          "restrictOutboundNetworkAccess": {
            "value": false
          },
          "tags": {
            "value": "[parameters('tagsProject')]"
          },
          "privateLinksDnsZones": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value]"
          },
          "privDnsSubscription": {
            "value": "[parameters('privDnsSubscription_param')]"
          },
          "privDnsResourceGroupName": {
            "value": "[variables('privDnsResourceGroupName')]"
          },
          "apiManagementResourceId": {
            "value": "[parameters('apiManagementResourceId')]"
          },
          "azureStorageAccountResourceId": {
            "value": "[resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Storage/storageAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value)]"
          },
          "azureStorageAccountResourceIdSecondary": {
            "value": "[resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Storage/storageAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value)]"
          },
          "azureCosmosDBAccountResourceId": "[if(variables('useCosmosForFoundry'), createObject('value', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value)), createObject('value', ''))]",
          "aiSearchResourceId": "[if(parameters('enableAISearch'), createObject('value', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Search/searchServices', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60), ''))), createObject('value', ''))]",
          "cmk": {
            "value": "[parameters('cmk')]"
          },
          "cmkKeyName": {
            "value": "[parameters('cmkKeyName')]"
          },
          "cmkKeyVersion": {
            "value": "[parameters('cmkKeyVersion')]"
          },
          "cmkKeyVaultResourceId": "[if(parameters('cmk'), createObject('value', resourceId(parameters('inputKeyvaultSubscription'), parameters('inputKeyvaultResourcegroup'), 'Microsoft.KeyVault/vaults', parameters('inputKeyvault'))), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11378135943752500744"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "foundryV22AccountOnly": {
              "type": "bool",
              "defaultValue": false
            },
            "aiAccountName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional override for the AI Services account name. When empty a unique name is generated."
              }
            },
            "allowedFqdnList": {
              "type": "array",
              "nullable": true,
              "metadata": {
                "description": "Optional. List of allowed FQDN."
              }
            },
            "apiProperties": {
              "type": "object",
              "nullable": true,
              "metadata": {
                "description": "Optional. The API properties for special APIs."
              }
            },
            "deploymentTimestamp": {
              "type": "string",
              "defaultValue": "[utcNow('yyyyMMddHHmmss')]",
              "metadata": {
                "description": "Timestamp used to generate deterministic resource names (format yyyyMMddHHmmss)."
              }
            },
            "firstProjectName": {
              "type": "string",
              "defaultValue": "project",
              "metadata": {
                "description": "Name prefix for the default project."
              }
            },
            "projectDescription": {
              "type": "string",
              "defaultValue": "A project for the AI Foundry account with network secured deployed Agent",
              "metadata": {
                "description": "Description for the default project."
              }
            },
            "displayName": {
              "type": "string",
              "defaultValue": "network secured agent project",
              "metadata": {
                "description": "Display name for the default project."
              }
            },
            "privateEndpointSubnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the subnet used for private endpoints."
              }
            },
            "agentSubnetResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource ID of the subnet used for agent network injection. Leave empty to skip injection."
              }
            },
            "disableAgentNetworkInjection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Disable agent network injection even when an agent subnet is provided."
              }
            },
            "aiSearchResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing AI Search service resource ID. Leave empty to create a new instance."
              }
            },
            "azureStorageAccountResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing primary Storage account resource ID. Leave empty to create a new instance."
              }
            },
            "azureStorageAccountResourceIdSecondary": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing secondary Storage account resource ID. Leave empty to create a new instance for capability host workloads."
              }
            },
            "azureCosmosDBAccountResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing Cosmos DB account resource ID. Leave empty to create a new instance."
              }
            },
            "apiManagementResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing API Management resource ID (for optional private endpoint)."
              }
            },
            "existingDnsZones": {
              "type": "object",
              "defaultValue": {
                "privatelink.services.ai.azure.com": "",
                "privatelink.openai.azure.com": "",
                "privatelink.cognitiveservices.azure.com": "",
                "privatelink.search.windows.net": "",
                "[format('privatelink.blob.{0}', environment().suffixes.storage)]": "",
                "privatelink.documents.azure.com": "",
                "privatelink.azure-api.net": ""
              },
              "metadata": {
                "description": "Object mapping private DNS zone names to either a full resource ID (preferred) or a legacy resource group name in the current subscription. Leave value empty to deploy a new zone alongside this module."
              }
            },
            "privateLinksDnsZones": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Private DNS zones configuration emitted from the networking landing zone."
              }
            },
            "privDnsSubscription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Subscription ID for the central private DNS zones."
              }
            },
            "privDnsResourceGroupName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource group name for the central private DNS zones."
              }
            },
            "allowPublicAccessWhenBehindVnet": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow public HTTP access while traffic flows through perimeter controls."
              }
            },
            "enablePublicGenAIAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable public access to AI Services endpoints."
              }
            },
            "ipAllowList": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "IP addresses or CIDR ranges allowed through network ACLs when public access is enabled."
              }
            },
            "enableCapabilityHost": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable capability host configuration for the project."
              }
            },
            "projectCapHost": {
              "type": "string",
              "defaultValue": "caphostproj",
              "metadata": {
                "description": "Name suffix for the capability host resource."
              }
            },
            "userRoleObjectIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of user object IDs for Cognitive Services RBAC assignments."
              }
            },
            "servicePrincipalIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of service principal IDs for Cognitive Services RBAC assignments."
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Treat entries in userRoleObjectIds as Azure AD groups instead of users."
              }
            },
            "extraModelDeployments": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Optional list of additional model deployments to create. Expected shape matches Microsoft.CognitiveServices/accounts/deployments properties."
              }
            },
            "modelName": {
              "type": "string",
              "defaultValue": "gpt-4o",
              "metadata": {
                "description": "Model name for the default deployment."
              }
            },
            "modelFormat": {
              "type": "string",
              "defaultValue": "OpenAI",
              "metadata": {
                "description": "Model provider format for the default deployment."
              }
            },
            "modelVersion": {
              "type": "string",
              "defaultValue": "2024-11-20",
              "metadata": {
                "description": "Model version for the default deployment."
              }
            },
            "modelSkuName": {
              "type": "string",
              "defaultValue": "GlobalStandard",
              "metadata": {
                "description": "Model SKU for the default deployment."
              }
            },
            "modelCapacity": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Tokens per minute capacity for the default model deployment."
              }
            },
            "enableCosmosDb": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Cosmos DB integration."
              }
            },
            "enableAISearch": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable AI Search integration."
              }
            },
            "enableProject": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable creation of a default project."
              }
            },
            "centralDnsZoneByPolicyInHub": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Bypass Private DNS zone linking when central DNS zones are managed in a hub."
              }
            },
            "restrictOutboundNetworkAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Restrict outbound network access for the AI Services account."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags applied to newly created resources."
              }
            },
            "cmk": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Customer-Managed Key (CMK) encryption for the AI Account."
              }
            },
            "cmkKeyName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "CMK Key name in the Key Vault."
              }
            },
            "cmkKeyVersion": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "CMK Key version in the Key Vault."
              }
            },
            "cmkKeyVaultResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "CMK Key Vault resource ID."
              }
            },
            "aiAccountSku": {
              "type": "string",
              "defaultValue": "S0",
              "allowedValues": [
                "S0",
                "S",
                "S1",
                "S2",
                "S3",
                "S4",
                "S5",
                "S6",
                "S7",
                "S8",
                "S9"
              ],
              "metadata": {
                "description": "SKU tier for the AI Services account."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "ipRules",
                "count": "[length(parameters('ipAllowList'))]",
                "input": {
                  "value": "[if(contains(parameters('ipAllowList')[copyIndex('ipRules')], '/'), toLower(parameters('ipAllowList')[copyIndex('ipRules')]), toLower(parameters('ipAllowList')[copyIndex('ipRules')]))]"
                }
              }
            ],
            "uniqueSuffix": "[substring(uniqueString(format('{0}-{1}', resourceGroup().id, parameters('deploymentTimestamp'))), 0, 4)]",
            "storagePassedIn": "[not(empty(parameters('azureStorageAccountResourceId')))]",
            "storageParts": "[if(variables('storagePassedIn'), split(parameters('azureStorageAccountResourceId'), '/'), split('', '/'))]",
            "storageSubscriptionId": "[if(variables('storagePassedIn'), variables('storageParts')[2], subscription().subscriptionId)]",
            "storageResourceGroupName": "[if(variables('storagePassedIn'), variables('storageParts')[4], resourceGroup().name)]",
            "storageAccountName": "[if(variables('storagePassedIn'), last(variables('storageParts')), take(replace(toLower(format('{0}{1}storage', parameters('aiAccountName'), variables('uniqueSuffix'))), '-', ''), 24))]",
            "storageSecondPassedIn": "[not(empty(parameters('azureStorageAccountResourceIdSecondary')))]",
            "storageSecondParts": "[if(variables('storageSecondPassedIn'), split(parameters('azureStorageAccountResourceIdSecondary'), '/'), split('', '/'))]",
            "storageSecondSubscriptionId": "[if(variables('storageSecondPassedIn'), variables('storageSecondParts')[2], subscription().subscriptionId)]",
            "storageSecondResourceGroupName": "[if(variables('storageSecondPassedIn'), variables('storageSecondParts')[4], resourceGroup().name)]",
            "storageAccountNameSecondary": "[if(variables('storageSecondPassedIn'), last(variables('storageSecondParts')), take(replace(toLower(format('{0}{1}stor2', parameters('aiAccountName'), variables('uniqueSuffix'))), '-', ''), 24))]",
            "searchPassedIn": "[not(empty(parameters('aiSearchResourceId')))]",
            "searchParts": "[if(variables('searchPassedIn'), split(parameters('aiSearchResourceId'), '/'), split('', '/'))]",
            "aiSearchSubscriptionId": "[if(variables('searchPassedIn'), variables('searchParts')[2], subscription().subscriptionId)]",
            "aiSearchServiceResourceGroupName": "[if(variables('searchPassedIn'), variables('searchParts')[4], resourceGroup().name)]",
            "aiSearchName": "[if(variables('searchPassedIn'), last(variables('searchParts')), take(replace(toLower(format('{0}{1}search', parameters('aiAccountName'), variables('uniqueSuffix'))), '-', ''), 24))]",
            "cosmosPassedIn": "[not(empty(parameters('azureCosmosDBAccountResourceId')))]",
            "cosmosParts": "[if(variables('cosmosPassedIn'), split(parameters('azureCosmosDBAccountResourceId'), '/'), split('', '/'))]",
            "cosmosSubscriptionId": "[if(variables('cosmosPassedIn'), variables('cosmosParts')[2], subscription().subscriptionId)]",
            "cosmosResourceGroupName": "[if(variables('cosmosPassedIn'), variables('cosmosParts')[4], resourceGroup().name)]",
            "cosmosAccountName": "[if(variables('cosmosPassedIn'), last(variables('cosmosParts')), take(replace(toLower(format('{0}{1}cosmosdb', parameters('aiAccountName'), variables('uniqueSuffix'))), '-', ''), 44))]",
            "apiManagementProvided": "[not(empty(parameters('apiManagementResourceId')))]",
            "apiManagementParts": "[if(variables('apiManagementProvided'), split(parameters('apiManagementResourceId'), '/'), split('', '/'))]",
            "apiManagementSubscriptionId": "[if(variables('apiManagementProvided'), variables('apiManagementParts')[2], '')]",
            "apiManagementResourceGroupName": "[if(variables('apiManagementProvided'), variables('apiManagementParts')[4], '')]",
            "apiManagementName": "[if(variables('apiManagementProvided'), last(variables('apiManagementParts')), '')]",
            "privateEndpointSubnetSegments": "[split(parameters('privateEndpointSubnetResourceId'), '/subnets/')]",
            "virtualNetworkId": "[variables('privateEndpointSubnetSegments')[0]]",
            "privateEndpointSubnetName": "[variables('privateEndpointSubnetSegments')[1]]",
            "vnetSegments": "[split(variables('virtualNetworkId'), '/')]",
            "virtualNetworkName": "[variables('vnetSegments')[sub(length(variables('vnetSegments')), 1)]]",
            "virtualNetworkResourceGroupName": "[variables('vnetSegments')[4]]",
            "virtualNetworkSubscriptionId": "[variables('vnetSegments')[2]]",
            "agentNetworkInjectionEnabled": "[and(not(parameters('disableAgentNetworkInjection')), not(empty(parameters('agentSubnetResourceId'))))]",
            "networkAclVirtualNetworkRules": "[concat(if(not(empty(parameters('privateEndpointSubnetResourceId'))), createArray(createObject('id', parameters('privateEndpointSubnetResourceId'), 'ignoreMissingVnetServiceEndpoint', true())), createArray()), if(variables('agentNetworkInjectionEnabled'), createArray(createObject('id', parameters('agentSubnetResourceId'), 'ignoreMissingVnetServiceEndpoint', true())), createArray()))]",
            "hasNetworkAcls": "[or(or(or(not(empty(variables('ipRules'))), parameters('enablePublicGenAIAccess')), parameters('allowPublicAccessWhenBehindVnet')), not(empty(variables('networkAclVirtualNetworkRules'))))]",
            "networkAcls": "[if(variables('hasNetworkAcls'), createObject('defaultAction', if(and(parameters('enablePublicGenAIAccess'), empty(variables('ipRules'))), 'Allow', 'Deny'), 'virtualNetworkRules', variables('networkAclVirtualNetworkRules'), 'ipRules', variables('ipRules'), 'bypass', 'AzureServices'), null())]",
            "publicNetworkAccess": "[if(or(parameters('enablePublicGenAIAccess'), parameters('allowPublicAccessWhenBehindVnet')), 'Enabled', 'Disabled')]",
            "storageInCurrentRg": "[and(equals(variables('storageResourceGroupName'), resourceGroup().name), equals(variables('storageSecondResourceGroupName'), resourceGroup().name))]",
            "searchInCurrentRg": "[equals(variables('aiSearchServiceResourceGroupName'), resourceGroup().name)]",
            "cosmosInCurrentRg": "[equals(variables('cosmosResourceGroupName'), resourceGroup().name)]",
            "defaultDeploymentName": "[take(format('{0}-{1}', parameters('modelName'), variables('uniqueSuffix')), 64)]",
            "aiAccountResourceId": "[if(parameters('foundryV22AccountOnly'), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiAccountName')), if(parameters('cmk'), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiAccountName'))))]",
            "projectCapHostUnique": "[format('{0}-{1}', parameters('projectCapHost'), variables('uniqueSuffix'))]",
            "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68",
            "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908",
            "openAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
            "openAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
            "searchServiceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
            "searchIndexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
            "searchIndexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
            "storageFileDataPrivilegedContributorRoleId": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
            "storageFileDataSMBPrivilegedContributorRoleId": "0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb",
            "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
            "aiAccountIdValue": "[variables('aiAccountResourceId')]",
            "storageAccountSubscriptionId": "[variables('storageSubscriptionId')]",
            "storageAccountResourceGroup": "[variables('storageResourceGroupName')]",
            "storageAccountSecondarySubscriptionId": "[variables('storageSecondSubscriptionId')]",
            "storageAccountSecondaryResourceGroup": "[variables('storageSecondResourceGroupName')]",
            "cosmosAccountSubscriptionId": "[variables('cosmosSubscriptionId')]",
            "cosmosAccountResourceGroup": "[variables('cosmosResourceGroupName')]",
            "aiSearchSubscriptionEffective": "[variables('aiSearchSubscriptionId')]",
            "aiSearchResourceGroupEffective": "[variables('aiSearchServiceResourceGroupName')]"
          },
          "resources": {
            "aiAccountCreate": {
              "condition": "[parameters('foundryV22AccountOnly')]",
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[parameters('aiAccountName')]",
              "kind": "AIServices",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('aiAccountSku')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "allowedFqdnList": "[parameters('allowedFqdnList')]",
                "apiProperties": "[parameters('apiProperties')]",
                "allowProjectManagement": "[parameters('enableProject')]",
                "customSubDomainName": "[parameters('aiAccountName')]",
                "networkAcls": "[variables('networkAcls')]",
                "publicNetworkAccess": "[variables('publicNetworkAccess')]",
                "disableLocalAuth": false,
                "networkInjections": "[if(variables('agentNetworkInjectionEnabled'), createArray(createObject('scenario', 'agent', 'subnetArmId', parameters('agentSubnetResourceId'), 'useMicrosoftManagedNetwork', false())), null())]",
                "restrictOutboundNetworkAccess": "[parameters('restrictOutboundNetworkAccess')]",
                "dynamicThrottlingEnabled": false
              }
            },
            "aiAccountExisting": {
              "condition": "[and(not(parameters('foundryV22AccountOnly')), not(parameters('cmk')))]",
              "existing": true,
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[parameters('aiAccountName')]"
            },
            "cMKKeyVault": {
              "condition": "[and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId'))))]",
              "existing": true,
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-11-01",
              "subscriptionId": "[split(parameters('cmkKeyVaultResourceId'), '/')[2]]",
              "resourceGroup": "[split(parameters('cmkKeyVaultResourceId'), '/')[4]]",
              "name": "[last(split(parameters('cmkKeyVaultResourceId'), '/'))]"
            },
            "cMKKey": {
              "condition": "[and(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId')))), not(empty(parameters('cmkKeyName'))))]",
              "existing": true,
              "type": "Microsoft.KeyVault/vaults/keys",
              "apiVersion": "2024-11-01",
              "subscriptionId": "[split(parameters('cmkKeyVaultResourceId'), '/')[2]]",
              "resourceGroup": "[split(parameters('cmkKeyVaultResourceId'), '/')[4]]",
              "name": "[format('{0}/{1}', last(split(parameters('cmkKeyVaultResourceId'), '/')), parameters('cmkKeyName'))]"
            },
            "aiAccountUpdateWithCMK": {
              "condition": "[and(not(parameters('foundryV22AccountOnly')), parameters('cmk'))]",
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[parameters('aiAccountName')]",
              "kind": "AIServices",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('aiAccountSku')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "allowedFqdnList": "[parameters('allowedFqdnList')]",
                "apiProperties": "[parameters('apiProperties')]",
                "allowProjectManagement": true,
                "customSubDomainName": "[parameters('aiAccountName')]",
                "networkAcls": "[variables('networkAcls')]",
                "publicNetworkAccess": "[variables('publicNetworkAccess')]",
                "disableLocalAuth": false,
                "networkInjections": "[if(variables('agentNetworkInjectionEnabled'), createArray(createObject('scenario', 'agent', 'subnetArmId', parameters('agentSubnetResourceId'), 'useMicrosoftManagedNetwork', false())), null())]",
                "restrictOutboundNetworkAccess": "[parameters('restrictOutboundNetworkAccess')]",
                "dynamicThrottlingEnabled": false,
                "encryption": {
                  "keySource": "Microsoft.KeyVault",
                  "keyVaultProperties": {
                    "keyName": "[parameters('cmkKeyName')]",
                    "keyVersion": "[if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyName')))), if(empty(parameters('cmkKeyVersion')), last(split(reference('cMKKey').keyUriWithVersion, '/')), parameters('cmkKeyVersion')), '')]",
                    "keyVaultUri": "[if(and(and(not(empty(if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId')))), reference('cMKKeyVault').vaultUri, ''))), greater(length(if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId')))), reference('cMKKeyVault').vaultUri, '')), 1)), endsWith(if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId')))), reference('cMKKeyVault').vaultUri, ''), '/')), substring(if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId')))), reference('cMKKeyVault').vaultUri, ''), 0, max(0, sub(length(if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId')))), reference('cMKKeyVault').vaultUri, '')), 1))), if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyVaultResourceId')))), reference('cMKKeyVault').vaultUri, ''))]"
                  }
                }
              },
              "dependsOn": [
                "cMKKey",
                "cMKKeyVault"
              ]
            },
            "aiAccountDeployment": {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('aiAccountName'), variables('defaultDeploymentName'))]",
              "properties": {
                "model": {
                  "name": "[parameters('modelName')]",
                  "format": "[parameters('modelFormat')]",
                  "version": "[parameters('modelVersion')]"
                }
              },
              "sku": {
                "name": "[parameters('modelSkuName')]",
                "capacity": "[parameters('modelCapacity')]"
              },
              "dependsOn": [
                "aiAccountCreate",
                "aiAccountExisting",
                "aiAccountUpdateWithCMK"
              ]
            },
            "aiAccountDeploymentsAdditional": {
              "copy": {
                "name": "aiAccountDeploymentsAdditional",
                "count": "[length(parameters('extraModelDeployments'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('aiAccountName'), take(string(coalesce(parameters('extraModelDeployments')[copyIndex()].name, format('deployment{0}', copyIndex()))), 64))]",
              "properties": {
                "model": "[parameters('extraModelDeployments')[copyIndex()].model]",
                "raiPolicyName": "[parameters('extraModelDeployments')[copyIndex()].raiPolicyName]",
                "versionUpgradeOption": "[parameters('extraModelDeployments')[copyIndex()].versionUpgradeOption]"
              },
              "sku": "[coalesce(parameters('extraModelDeployments')[copyIndex()].sku, createObject('name', parameters('modelSkuName'), 'capacity', parameters('modelCapacity')))]",
              "dependsOn": [
                "aiAccountCreate",
                "aiAccountDeployment",
                "aiAccountExisting",
                "aiAccountUpdateWithCMK"
              ]
            },
            "projectModule": {
              "condition": "[parameters('enableProject')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-project-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('firstProjectName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "cosmosDBname": "[if(parameters('enableCosmosDb'), createObject('value', variables('cosmosAccountName')), createObject('value', ''))]",
                  "storageName": {
                    "value": "[variables('storageAccountName')]"
                  },
                  "storageName2": {
                    "value": "[variables('storageAccountNameSecondary')]"
                  },
                  "aiFoundryV2Name": {
                    "value": "[parameters('aiAccountName')]"
                  },
                  "aiSearchName": "[if(parameters('enableAISearch'), createObject('value', variables('aiSearchName')), createObject('value', ''))]",
                  "enablePublicAccessWithPerimeter": {
                    "value": "[parameters('allowPublicAccessWhenBehindVnet')]"
                  },
                  "defaultProjectName": {
                    "value": "[parameters('firstProjectName')]"
                  },
                  "defaultProjectDisplayName": {
                    "value": "[parameters('displayName')]"
                  },
                  "defaultProjectDescription": {
                    "value": "[parameters('projectDescription')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "9587761100287127921"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "minLength": 3,
                      "maxLength": 12,
                      "metadata": {
                        "description": "The name of the environment. Use alphanumeric characters only."
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the location for all the Azure resources. Defaults to the location of the resource group."
                      }
                    },
                    "cosmosDBname": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the customers existing CosmosDB Resource"
                      }
                    },
                    "storageName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the customers existing Azure Storage Account"
                      }
                    },
                    "storageName2": {
                      "type": "string"
                    },
                    "aiFoundryV2Name": {
                      "type": "string",
                      "metadata": {
                        "description": "Foundry Account Name"
                      }
                    },
                    "aiSearchName": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure Search Service Name"
                      }
                    },
                    "enablePublicAccessWithPerimeter": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "defaultProjectName": {
                      "type": "string",
                      "defaultValue": "[parameters('name')]",
                      "metadata": {
                        "description": "Name of the first project"
                      }
                    },
                    "defaultProjectDisplayName": {
                      "type": "string",
                      "defaultValue": "[parameters('name')]"
                    },
                    "defaultProjectDescription": {
                      "type": "string",
                      "defaultValue": "AI Factory created this default project for AI Foundry with enterprise grade security and your corp networking."
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                      "location": "[parameters('location')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "displayName": "[parameters('defaultProjectDisplayName')]",
                        "description": "[parameters('defaultProjectDescription')]"
                      }
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName'))]",
                      "properties": {
                        "category": "AzureStorageAccount",
                        "target": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), '2023-01-01').primaryEndpoints.blob]",
                        "useWorkspaceManagedIdentity": true,
                        "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                        "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                        "authType": "AAD",
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]",
                          "location": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), '2023-01-01', 'full').location]",
                          "accountName": "[parameters('storageName')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName2'))]",
                      "properties": {
                        "category": "AzureStorageAccount",
                        "target": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2')), '2023-01-01').primaryEndpoints.blob]",
                        "useWorkspaceManagedIdentity": true,
                        "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                        "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                        "authType": "AAD",
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2'))]",
                          "location": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2')), '2023-01-01', 'full').location]",
                          "accountName": "[parameters('storageName2')]",
                          "containerName": "default"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('aiSearchName')))]",
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('aiSearchName'))]",
                      "properties": {
                        "category": "CognitiveSearch",
                        "target": "[format('https://{0}.search.windows.net/', parameters('aiSearchName'))]",
                        "authType": "AAD",
                        "isSharedToAll": true,
                        "useWorkspaceManagedIdentity": true,
                        "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                        "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[resourceId('Microsoft.Search/searchServices', parameters('aiSearchName'))]",
                          "location": "[reference(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), '2024-06-01-preview', 'full').location]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName2'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('cosmosDBname')))]",
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('cosmosDBname'))]",
                      "properties": {
                        "category": "CosmosDB",
                        "target": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname')), '2025-05-01-preview').documentEndpoint]",
                        "authType": "AAD",
                        "isSharedToAll": true,
                        "useWorkspaceManagedIdentity": true,
                        "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                        "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname'))]",
                          "location": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname')), '2025-05-01-preview', 'full').location]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('aiSearchName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "projectId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]"
                    },
                    "projectName": {
                      "type": "string",
                      "value": "[parameters('defaultProjectName')]"
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName')), '2025-04-01-preview', 'full').identity.principalId]"
                    },
                    "projectWorkspaceId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName')), '2025-04-01-preview').internalId]"
                    },
                    "cosmosDBConnection": {
                      "type": "string",
                      "value": "[parameters('cosmosDBname')]"
                    },
                    "azureStorageConnection": {
                      "type": "string",
                      "value": "[parameters('storageName')]"
                    },
                    "aiSearchConnection": {
                      "type": "string",
                      "value": "[parameters('aiSearchName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccountCreate",
                "aiAccountExisting",
                "aiAccountUpdateWithCMK"
              ]
            },
            "capabilityHostAccount": {
              "condition": "[and(and(and(parameters('enableCapabilityHost'), parameters('enableProject')), parameters('enableAISearch')), parameters('enableCosmosDb'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-caphost-acct-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "cosmosDBConnection": {
                    "value": "[string(reference('projectModule').outputs.cosmosDBConnection.value)]"
                  },
                  "azureStorageConnection": {
                    "value": "[string(reference('projectModule').outputs.azureStorageConnection.value)]"
                  },
                  "aiSearchConnection": {
                    "value": "[string(reference('projectModule').outputs.aiSearchConnection.value)]"
                  },
                  "projectName": {
                    "value": "[reference('projectModule').outputs.projectName.value]"
                  },
                  "accountName": {
                    "value": "[parameters('aiAccountName')]"
                  },
                  "projectCapHostName": {
                    "value": "[variables('projectCapHostUnique')]"
                  },
                  "accountLevel": {
                    "value": true
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "14627596929158472342"
                    }
                  },
                  "parameters": {
                    "cosmosDBConnection": {
                      "type": "string"
                    },
                    "azureStorageConnection": {
                      "type": "string"
                    },
                    "aiSearchConnection": {
                      "type": "string"
                    },
                    "projectName": {
                      "type": "string"
                    },
                    "accountName": {
                      "type": "string"
                    },
                    "projectCapHostName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional name for the capability host. If omitted, a deterministic name is generated based on the selected level."
                      }
                    },
                    "accountLevel": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, deploy the capability host at the account scope instead of the project scope."
                      }
                    }
                  },
                  "variables": {
                    "defaultProjectCapabilityHostName": "[format('chagent{0}', replace(parameters('projectName'), '-', ''))]",
                    "defaultAccountCapabilityHostName": "[format('chagent{0}', replace(parameters('accountName'), '-', ''))]",
                    "resolvedProjectCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultProjectCapabilityHostName'), parameters('projectCapHostName'))]",
                    "resolvedAccountCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultAccountCapabilityHostName'), parameters('projectCapHostName'))]"
                  },
                  "resources": [
                    {
                      "condition": "[parameters('accountLevel')]",
                      "type": "Microsoft.CognitiveServices/accounts/capabilityHosts",
                      "apiVersion": "2025-07-01-preview",
                      "name": "[format('{0}/{1}', parameters('accountName'), variables('resolvedAccountCapabilityHostName'))]",
                      "properties": {
                        "capabilityHostKind": "Agents"
                      }
                    },
                    {
                      "condition": "[not(parameters('accountLevel'))]",
                      "type": "Microsoft.CognitiveServices/accounts/projects/capabilityHosts",
                      "apiVersion": "2025-07-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), variables('resolvedProjectCapabilityHostName'))]",
                      "properties": {
                        "capabilityHostKind": "Agents",
                        "threadStorageConnections": [
                          "[format('{0}', parameters('cosmosDBConnection'))]"
                        ],
                        "vectorStoreConnections": [
                          "[format('{0}', parameters('aiSearchConnection'))]"
                        ],
                        "storageConnections": [
                          "[format('{0}', parameters('azureStorageConnection'))]"
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "projectCapHost": {
                      "type": "string",
                      "value": "[if(not(parameters('accountLevel')), string(variables('resolvedProjectCapabilityHostName')), '')]"
                    },
                    "accountCapHost": {
                      "type": "string",
                      "value": "[if(parameters('accountLevel'), string(variables('resolvedAccountCapabilityHostName')), '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "caphostRbacPre",
                "projectModule",
                "searchRbac",
                "storageRbac"
              ]
            },
            "capabilityHostProject": {
              "condition": "[and(and(and(parameters('enableCapabilityHost'), parameters('enableProject')), parameters('enableAISearch')), parameters('enableCosmosDb'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-caphost-proj-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "cosmosDBConnection": {
                    "value": "[string(reference('projectModule').outputs.cosmosDBConnection.value)]"
                  },
                  "azureStorageConnection": {
                    "value": "[string(reference('projectModule').outputs.azureStorageConnection.value)]"
                  },
                  "aiSearchConnection": {
                    "value": "[string(reference('projectModule').outputs.aiSearchConnection.value)]"
                  },
                  "projectName": {
                    "value": "[reference('projectModule').outputs.projectName.value]"
                  },
                  "accountName": {
                    "value": "[parameters('aiAccountName')]"
                  },
                  "projectCapHostName": {
                    "value": "[variables('projectCapHostUnique')]"
                  },
                  "accountLevel": {
                    "value": false
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "14627596929158472342"
                    }
                  },
                  "parameters": {
                    "cosmosDBConnection": {
                      "type": "string"
                    },
                    "azureStorageConnection": {
                      "type": "string"
                    },
                    "aiSearchConnection": {
                      "type": "string"
                    },
                    "projectName": {
                      "type": "string"
                    },
                    "accountName": {
                      "type": "string"
                    },
                    "projectCapHostName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional name for the capability host. If omitted, a deterministic name is generated based on the selected level."
                      }
                    },
                    "accountLevel": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "When true, deploy the capability host at the account scope instead of the project scope."
                      }
                    }
                  },
                  "variables": {
                    "defaultProjectCapabilityHostName": "[format('chagent{0}', replace(parameters('projectName'), '-', ''))]",
                    "defaultAccountCapabilityHostName": "[format('chagent{0}', replace(parameters('accountName'), '-', ''))]",
                    "resolvedProjectCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultProjectCapabilityHostName'), parameters('projectCapHostName'))]",
                    "resolvedAccountCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultAccountCapabilityHostName'), parameters('projectCapHostName'))]"
                  },
                  "resources": [
                    {
                      "condition": "[parameters('accountLevel')]",
                      "type": "Microsoft.CognitiveServices/accounts/capabilityHosts",
                      "apiVersion": "2025-07-01-preview",
                      "name": "[format('{0}/{1}', parameters('accountName'), variables('resolvedAccountCapabilityHostName'))]",
                      "properties": {
                        "capabilityHostKind": "Agents"
                      }
                    },
                    {
                      "condition": "[not(parameters('accountLevel'))]",
                      "type": "Microsoft.CognitiveServices/accounts/projects/capabilityHosts",
                      "apiVersion": "2025-07-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), variables('resolvedProjectCapabilityHostName'))]",
                      "properties": {
                        "capabilityHostKind": "Agents",
                        "threadStorageConnections": [
                          "[format('{0}', parameters('cosmosDBConnection'))]"
                        ],
                        "vectorStoreConnections": [
                          "[format('{0}', parameters('aiSearchConnection'))]"
                        ],
                        "storageConnections": [
                          "[format('{0}', parameters('azureStorageConnection'))]"
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "projectCapHost": {
                      "type": "string",
                      "value": "[if(not(parameters('accountLevel')), string(variables('resolvedProjectCapabilityHostName')), '')]"
                    },
                    "accountCapHost": {
                      "type": "string",
                      "value": "[if(parameters('accountLevel'), string(variables('resolvedAccountCapabilityHostName')), '')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "capabilityHostAccount",
                "projectModule"
              ]
            },
            "aiFoundryRbac": {
              "condition": "[or(or(not(empty(parameters('userRoleObjectIds'))), not(empty(parameters('servicePrincipalIds')))), parameters('enableProject'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-rbac-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "userObjectIds": {
                    "value": "[parameters('userRoleObjectIds')]"
                  },
                  "servicePrincipalIds": {
                    "value": "[parameters('servicePrincipalIds')]"
                  },
                  "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference('projectModule').outputs.projectPrincipalId.value), createObject('value', ''))]",
                  "cognitiveServicesAccountName": {
                    "value": "[parameters('aiAccountName')]"
                  },
                  "cognitiveServicesContributorRoleId": {
                    "value": "[variables('cognitiveServicesContributorRoleId')]"
                  },
                  "cognitiveServicesUserRoleId": {
                    "value": "[variables('cognitiveServicesUserRoleId')]"
                  },
                  "openAIContributorRoleId": {
                    "value": "[variables('openAIContributorRoleId')]"
                  },
                  "openAIUserRoleId": {
                    "value": "[variables('openAIUserRoleId')]"
                  },
                  "useAdGroups": {
                    "value": "[parameters('useAdGroups')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "11175577047624681490"
                    }
                  },
                  "parameters": {
                    "userObjectIds": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Array of user object IDs to assign roles to"
                      }
                    },
                    "servicePrincipalIds": {
                      "type": "array",
                      "defaultValue": [],
                      "metadata": {
                        "description": "Array of service principal IDs to assign roles to"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Project principal ID to assign roles to"
                      }
                    },
                    "cognitiveServicesAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Cognitive Services account to assign roles for"
                      }
                    },
                    "cognitiveServicesContributorRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Role definition ID for Cognitive Services Contributor"
                      }
                    },
                    "cognitiveServicesUserRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Role definition ID for Cognitive Services User"
                      }
                    },
                    "openAIContributorRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Role definition ID for OpenAI Contributor"
                      }
                    },
                    "openAIUserRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Role definition ID for OpenAI User"
                      }
                    },
                    "useAdGroups": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Whether to use AD Groups instead of individual users"
                      }
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "openAIContributorRoleAssignmentUsers",
                        "count": "[length(parameters('userObjectIds'))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('userObjectIds')[copyIndex()], parameters('openAIContributorRoleId'), 'user-openai-contributor-manual')]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIContributorRoleId'))]",
                        "principalId": "[parameters('userObjectIds')[copyIndex()]]",
                        "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                        "description": "!01: user-openai-contributor-manual"
                      }
                    },
                    {
                      "copy": {
                        "name": "cognitiveServicesContributorRoleAssignmentUsers",
                        "count": "[length(parameters('userObjectIds'))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('userObjectIds')[copyIndex()], parameters('cognitiveServicesContributorRoleId'), 'user-cs-contributor-manual')]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesContributorRoleId'))]",
                        "principalId": "[parameters('userObjectIds')[copyIndex()]]",
                        "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                        "description": "!02: user-cs-contributor-manual"
                      }
                    },
                    {
                      "copy": {
                        "name": "openAIUserRoleAssignmentServicePrincipals",
                        "count": "[length(parameters('servicePrincipalIds'))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('servicePrincipalIds')[copyIndex()], parameters('openAIUserRoleId'), 'sp-user-manual')]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIUserRoleId'))]",
                        "principalId": "[parameters('servicePrincipalIds')[copyIndex()]]",
                        "principalType": "ServicePrincipal",
                        "description": "!05: sp-user-manual (2 rows OK)"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('openAIContributorRoleId'), 'project-openai-contributor-manual')]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal",
                        "description": "!06:project-openai-contributor-manual: AI Foundry project managed identity - OpenAI Contributor for project operations"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('cognitiveServicesContributorRoleId'), 'project-cs-contributor-manual')]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal",
                        "description": "!07:project-cs-contributor-manual:AI Foundry project managed identity - Cognitive Services Contributor for project operations"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('cognitiveServicesUserRoleId'), 'project-cs-user-manual')]",
                      "properties": {
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesUserRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal",
                        "description": "!08:project-cs-user-manual: AI Foundry project managed identity - Cognitive Services User for project operations"
                      }
                    }
                  ],
                  "outputs": {
                    "userRoleNames": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('userObjectIds'))]",
                        "input": "[format('User {0} assigned OpenAI Contributor, Cognitive Services Contributor, and Cognitive Services User roles', parameters('userObjectIds')[copyIndex()])]"
                      }
                    },
                    "servicePrincipalRoleNames": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('servicePrincipalIds'))]",
                        "input": "[format('Service Principal {0} assigned OpenAI User role', parameters('servicePrincipalIds')[copyIndex()])]"
                      }
                    },
                    "projectPrincipalRoleNames": {
                      "type": "string",
                      "value": "[if(not(empty(parameters('projectPrincipalId'))), format('Project Principal {0} assigned OpenAI Contributor, Cognitive Services Contributor, and Cognitive Services User roles', parameters('projectPrincipalId')), 'No project principal provided')]"
                    },
                    "roleAssignmentsCount": {
                      "type": "int",
                      "metadata": {
                        "description": "Number of role assignments created"
                      },
                      "value": "[add(add(mul(length(parameters('userObjectIds')), 3), length(parameters('servicePrincipalIds'))), if(not(empty(parameters('projectPrincipalId'))), 3, 0))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccountCreate",
                "aiAccountExisting",
                "aiAccountUpdateWithCMK",
                "projectModule"
              ]
            },
            "searchRbac": {
              "condition": "[and(parameters('enableAISearch'), variables('searchInCurrentRg'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-rbacsearch-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aiSearchName": {
                    "value": "[variables('aiSearchName')]"
                  },
                  "aiFoundryAccountName": {
                    "value": "[parameters('aiAccountName')]"
                  },
                  "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference('projectModule').outputs.projectPrincipalId.value), createObject('value', ''))]",
                  "searchServiceContributorRoleId": {
                    "value": "[variables('searchServiceContributorRoleId')]"
                  },
                  "searchIndexDataReaderRoleId": {
                    "value": "[variables('searchIndexDataReaderRoleId')]"
                  },
                  "searchIndexDataContributorRoleId": {
                    "value": "[variables('searchIndexDataContributorRoleId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "2603168697541818607"
                    }
                  },
                  "parameters": {
                    "aiSearchName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the AI Search service"
                      }
                    },
                    "aiFoundryAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the AI Foundry account to get the principal ID from"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The principal ID of the AI Foundry project system-assigned managed identity"
                      }
                    },
                    "searchServiceContributorRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Search Service Contributor role ID"
                      }
                    },
                    "searchIndexDataReaderRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Search Index Data Reader role ID"
                      }
                    },
                    "searchIndexDataContributorRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Search Index Data Contributor role ID"
                      }
                    },
                    "azureAIDeveloperRoleId": {
                      "type": "string",
                      "defaultValue": "64702f94-c441-49e6-a78b-ef80e0188fee",
                      "metadata": {
                        "description": "Azure AI Developer role ID"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchServiceContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchServiceContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchIndexDataReaderRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataReaderRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchIndexDataContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('azureAIDeveloperRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('azureAIDeveloperRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchServiceContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchServiceContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchIndexDataReaderRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataReaderRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchIndexDataContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('azureAIDeveloperRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('azureAIDeveloperRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ],
                  "outputs": {
                    "rbacAssignmentsCompleted": {
                      "type": "bool",
                      "metadata": {
                        "description": "AI Search RBAC assignments completed successfully"
                      },
                      "value": true
                    },
                    "roleAssignmentsCount": {
                      "type": "int",
                      "metadata": {
                        "description": "Number of role assignments created"
                      },
                      "value": "[add(4, if(not(empty(parameters('projectPrincipalId'))), 4, 0))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccountCreate",
                "aiAccountExisting",
                "aiAccountUpdateWithCMK",
                "projectModule"
              ]
            },
            "storageRbac": {
              "condition": "[and(variables('storageInCurrentRg'), parameters('enableProject'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-rbacstorage-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[variables('storageAccountName')]"
                  },
                  "storageAccountName2": {
                    "value": "[variables('storageAccountNameSecondary')]"
                  },
                  "aiFoundryAccountName": {
                    "value": "[parameters('aiAccountName')]"
                  },
                  "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference('projectModule').outputs.projectPrincipalId.value), createObject('value', ''))]",
                  "storageBlobDataContributorRoleId": {
                    "value": "[variables('storageBlobDataContributorRoleId')]"
                  },
                  "storageFileDataPrivilegedContributorRoleId": {
                    "value": "[variables('storageFileDataPrivilegedContributorRoleId')]"
                  },
                  "storageFileDataSMBPrivilegedContributorRoleId": {
                    "value": "[variables('storageFileDataSMBPrivilegedContributorRoleId')]"
                  },
                  "storageQueueDataContributorRoleId": {
                    "value": "[variables('storageQueueDataContributorRoleId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "13139720558607161744"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the storage account"
                      }
                    },
                    "storageAccountName2": {
                      "type": "string"
                    },
                    "aiFoundryAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the AI Foundry account to get the principal ID from"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The principal ID of the AI Foundry project system-assigned managed identity"
                      }
                    },
                    "storageBlobDataContributorRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Storage Blob Data Contributor role ID"
                      }
                    },
                    "storageFileDataPrivilegedContributorRoleId": {
                      "type": "string",
                      "metadata": {
                        "description": "Storage File Data Privileged Contributor role ID"
                      }
                    },
                    "storageFileDataSMBPrivilegedContributorRoleId": {
                      "type": "string"
                    },
                    "storageQueueDataContributorRoleId": {
                      "type": "string",
                      "defaultValue": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
                      "metadata": {
                        "description": "Storage Queue Data Contributor role ID"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageBlobDataContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataPrivilegedContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataSMBPrivilegedContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataSMBPrivilegedContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageQueueDataContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageBlobDataContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageFileDataPrivilegedContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageQueueDataContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageBlobDataContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataPrivilegedContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageQueueDataContributorRoleId'))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                        "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageBlobDataContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageFileDataPrivilegedContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('projectPrincipalId')))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageQueueDataContributorRoleId'), 'project')]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                        "principalId": "[parameters('projectPrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ],
                  "outputs": {
                    "rbacAssignmentsCompleted": {
                      "type": "bool",
                      "metadata": {
                        "description": "Storage Account RBAC assignments completed successfully"
                      },
                      "value": true
                    },
                    "roleAssignmentsCount": {
                      "type": "int",
                      "metadata": {
                        "description": "Number of role assignments created"
                      },
                      "value": "[add(6, if(not(empty(parameters('projectPrincipalId'))), 6, 0))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "aiAccountCreate",
                "aiAccountExisting",
                "aiAccountUpdateWithCMK",
                "projectModule"
              ]
            },
            "caphostRbacPre": {
              "condition": "[and(and(and(parameters('enableCapabilityHost'), parameters('enableProject')), parameters('enableCosmosDb')), variables('cosmosInCurrentRg'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-rbaccap-pre-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "cosmosAccountName": {
                    "value": "[variables('cosmosAccountName')]"
                  },
                  "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference('projectModule').outputs.projectPrincipalId.value), createObject('value', ''))]"
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "2091610910663070548"
                    }
                  },
                  "parameters": {
                    "cosmosAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the CosmosDB Account resource"
                      }
                    },
                    "cosmosSQLDBName": {
                      "type": "string",
                      "defaultValue": "enterprise_memory",
                      "metadata": {
                        "description": "Name of the CosmosDB SQL Database in the account"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the AI project"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosAccountName'))]",
                      "name": "[guid(parameters('projectPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "projectModule"
              ]
            },
            "caphostRbacPost": {
              "condition": "[and(and(and(and(parameters('enableCapabilityHost'), parameters('enableProject')), parameters('enableCosmosDb')), variables('cosmosInCurrentRg')), variables('storageInCurrentRg'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[take(format('aifoundry-rbaccap-post-{0}', variables('uniqueSuffix')), 64)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "cosmosAccountName": {
                    "value": "[variables('cosmosAccountName')]"
                  },
                  "projectPrincipalId": "[if(parameters('enableProject'), createObject('value', reference('projectModule').outputs.projectPrincipalId.value), createObject('value', ''))]",
                  "storageName": {
                    "value": "[variables('storageAccountName')]"
                  },
                  "projectWorkspaceId": "[if(and(parameters('enableProject'), not(empty(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), '')))), createObject('value', format('{0}-{1}-{2}-{3}-{4}', substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 0, 8), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 8, 4), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 12, 4), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 16, 4), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 20, 12))), createObject('value', ''))]"
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "7103959165167896799"
                    }
                  },
                  "parameters": {
                    "cosmosAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the CosmosDB Account resource"
                      }
                    },
                    "cosmosSQLDBName": {
                      "type": "string",
                      "defaultValue": "enterprise_memory",
                      "metadata": {
                        "description": "Name of the CosmosDB SQL Database in the account"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the AI project"
                      }
                    },
                    "storageName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the storage account"
                      }
                    },
                    "projectWorkspaceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Workspace Id of the AI Project"
                      }
                    }
                  },
                  "variables": {
                    "userThreadName": "[format('{0}-thread-message-store', parameters('projectWorkspaceId'))]",
                    "systemThreadName": "[format('{0}-system-thread-message-store', parameters('projectWorkspaceId'))]",
                    "entityStoreName": "[format('{0}-agent-entity-store', parameters('projectWorkspaceId'))]",
                    "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosAccountName'), '00000000-0000-0000-0000-000000000002')]",
                    "scopeSystemContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('systemThreadName'))]",
                    "scopeUserContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('userThreadName'))]",
                    "scopeEntityContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('entityStoreName'))]",
                    "conditionStr": "[format('((!(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/read''}})  AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/filter/action''}}) AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/write''}}) ) OR (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringStartsWithIgnoreCase ''{0}'' AND @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringLikeIgnoreCase ''*-azureml-agent''))', parameters('projectWorkspaceId'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                      "apiVersion": "2022-05-15",
                      "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('userThreadName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[variables('roleDefinitionId')]",
                        "scope": "[variables('scopeUserContainer')]"
                      }
                    },
                    {
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                      "apiVersion": "2022-05-15",
                      "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('systemThreadName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[variables('roleDefinitionId')]",
                        "scope": "[variables('scopeSystemContainer')]"
                      }
                    },
                    {
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                      "apiVersion": "2022-05-15",
                      "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('entityStoreName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[variables('roleDefinitionId')]",
                        "scope": "[variables('scopeEntityContainer')]"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
                      "name": "[guid(resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b'), resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), parameters('projectPrincipalId'), parameters('projectWorkspaceId'))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                        "principalType": "ServicePrincipal",
                        "conditionVersion": "2.0",
                        "condition": "[variables('conditionStr')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "capabilityHostProject",
                "caphostRbacPre",
                "projectModule"
              ]
            }
          },
          "outputs": {
            "aiAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the cognitive services account."
              },
              "value": "[if(not(parameters('foundryV22AccountOnly')), parameters('aiAccountName'), '')]"
            },
            "aiAccountId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the cognitive services account."
              },
              "value": "[if(not(parameters('foundryV22AccountOnly')), variables('aiAccountIdValue'), '')]"
            },
            "aiAccountEndpoint": {
              "type": "string",
              "metadata": {
                "description": "The service endpoint of the cognitive services account."
              },
              "value": "[if(not(parameters('foundryV22AccountOnly')), if(not(parameters('foundryV22AccountOnly')), reference(variables('aiAccountResourceId'), '2025-04-01-preview', 'full').properties.endpoint, ''), '')]"
            },
            "aiAccountPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the system assigned identity."
              },
              "value": "[if(not(parameters('foundryV22AccountOnly')), if(not(parameters('foundryV22AccountOnly')), reference(variables('aiAccountResourceId'), '2025-04-01-preview', 'full').identity.principalId, ''), '')]"
            },
            "aiFoundryProjectDeployed": {
              "type": "bool",
              "metadata": {
                "description": "Indicates whether the default project was deployed."
              },
              "value": "[parameters('enableProject')]"
            },
            "cmkUpdateAttempted": {
              "type": "bool",
              "metadata": {
                "description": "Debug: Shows if CMK update was attempted"
              },
              "value": "[and(not(parameters('foundryV22AccountOnly')), parameters('cmk'))]"
            },
            "cmkDebugInfo": {
              "type": "object",
              "metadata": {
                "description": "Debug: CMK configuration parameters"
              },
              "value": {
                "cmkEnabled": "[parameters('cmk')]",
                "cmkKeyName": "[parameters('cmkKeyName')]",
                "cmkKeyVersionProvided": "[parameters('cmkKeyVersion')]",
                "cmkKeyVersionUsed": "[if(and(and(not(parameters('foundryV22AccountOnly')), parameters('cmk')), not(empty(parameters('cmkKeyName')))), if(empty(parameters('cmkKeyVersion')), last(split(reference('cMKKey').keyUriWithVersion, '/')), parameters('cmkKeyVersion')), '')]",
                "cmkKeyVaultResourceId": "[parameters('cmkKeyVaultResourceId')]",
                "foundryV22AccountOnly": "[parameters('foundryV22AccountOnly')]",
                "shouldUpdateWithCMK": "[and(not(parameters('foundryV22AccountOnly')), parameters('cmk'))]"
              }
            },
            "projectNameOutput": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry project."
              },
              "value": "[if(parameters('enableProject'), string(reference('projectModule').outputs.projectName.value), '')]"
            },
            "projectId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the AI Foundry project."
              },
              "value": "[if(parameters('enableProject'), string(reference('projectModule').outputs.projectId.value), '')]"
            },
            "projectPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the AI Foundry project managed identity."
              },
              "value": "[if(parameters('enableProject'), reference('projectModule').outputs.projectPrincipalId.value, '')]"
            },
            "projectWorkspaceGuid": {
              "type": "string",
              "metadata": {
                "description": "Formatted project workspace ID (GUID)."
              },
              "value": "[if(and(parameters('enableProject'), not(empty(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), '')))), format('{0}-{1}-{2}-{3}-{4}', substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 0, 8), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 8, 4), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 12, 4), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 16, 4), substring(if(parameters('enableProject'), string(reference('projectModule').outputs.projectWorkspaceId.value), ''), 20, 12)), '')]"
            },
            "storageAccount": {
              "type": "object",
              "metadata": {
                "description": "Primary storage account information."
              },
              "value": {
                "name": "[variables('storageAccountName')]",
                "subscriptionId": "[variables('storageAccountSubscriptionId')]",
                "resourceGroup": "[variables('storageAccountResourceGroup')]"
              }
            },
            "storageAccountSecondary": {
              "type": "object",
              "metadata": {
                "description": "Secondary storage account information."
              },
              "value": {
                "name": "[variables('storageAccountNameSecondary')]",
                "subscriptionId": "[variables('storageAccountSecondarySubscriptionId')]",
                "resourceGroup": "[variables('storageAccountSecondaryResourceGroup')]"
              }
            },
            "cosmosAccount": {
              "type": "object",
              "metadata": {
                "description": "Cosmos DB account information."
              },
              "value": "[if(parameters('enableCosmosDb'), createObject('name', variables('cosmosAccountName'), 'subscriptionId', variables('cosmosAccountSubscriptionId'), 'resourceGroup', variables('cosmosAccountResourceGroup')), createObject('name', '', 'subscriptionId', '', 'resourceGroup', ''))]"
            },
            "aiSearchService": {
              "type": "object",
              "metadata": {
                "description": "AI Search service information."
              },
              "value": "[if(parameters('enableAISearch'), createObject('name', variables('aiSearchName'), 'subscriptionId', variables('aiSearchSubscriptionEffective'), 'resourceGroup', variables('aiSearchResourceGroupEffective')), createObject('name', '', 'subscriptionId', '', 'resourceGroup', ''))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(variables('deployAvmFoundry'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiFoundry": {
            "value": "[union(createObject('baseName', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value), 'includeAssociatedResources', false(), 'location', parameters('location'), 'enableTelemetry', false(), 'tags', parameters('tagsProject'), 'privateEndpointSubnetResourceId', parameters('genaiSubnetId'), 'aiModelDeployments', variables('aiFoundryDeployments'), 'aiFoundryConfiguration', createObject('accountName', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value), 'allowProjectManagement', true(), 'createCapabilityHosts', parameters('enableCaphost'), 'location', parameters('location'), 'disableLocalAuth', true(), 'networking', union(createObject('aiServicesPrivateDnsZoneResourceId', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.servicesai.id, 'cognitiveServicesPrivateDnsZoneResourceId', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.cognitiveservices.id, 'openAiPrivateDnsZoneResourceId', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.openai.id), if(and(not(parameters('disableAgentNetworkInjection')), not(empty(parameters('aca2SubnetId')))), createObject('agentServiceSubnetResourceId', parameters('aca2SubnetId')), createObject())), 'project', createObject('name', if(parameters('enableAIFactoryCreatedDefaultProjectForAIFv2'), if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value), format('{0}def', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value))), 'displayName', if(parameters('enableAIFactoryCreatedDefaultProjectForAIFv2'), if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value), format('{0}def', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value)))), 'roleAssignments', if(and(parameters('enableAIFoundry'), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-roleBuilder-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.roleAssignments.value, createArray()), 'sku', 'S0')), if(and(variables('deployAvmFoundry'), parameters('enableAISearch')), createObject('aiSearchConfiguration', createObject('existingResourceId', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Search/searchServices', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60), '')), 'roleAssignments', createArray())), createObject()), if(variables('deployAvmFoundry'), createObject('keyVaultConfiguration', createObject('existingResourceId', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.KeyVault/vaults', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.keyvaultName.value), 'roleAssignments', createArray()), 'storageAccountConfiguration', createObject('existingResourceId', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Storage/storageAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value), 'roleAssignments', createArray()), 'storageAccountSecondaryConfiguration', createObject('existingResourceId', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.Storage/storageAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value), 'roleAssignments', createArray())), createObject()), if(and(variables('deployAvmFoundry'), variables('useCosmosForFoundry')), createObject('cosmosDbConfiguration', createObject('existingResourceId', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value), 'roleAssignments', createArray())), createObject()))]"
          },
          "enableTelemetry": {
            "value": false
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4468130579149985249"
            }
          },
          "definitions": {
            "aiFoundryDefinitionType": {
              "type": "object",
              "properties": {
                "baseName": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. A friendly application/environment name to serve as the base when using the default naming for all resources in this deployment."
                  }
                },
                "baseUniqueName": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. A unique text value for the application/environment. Used to ensure resource names are unique for global resources. Defaults to a 5-character substring of the unique string generated from the subscription ID, resource group name, and base name."
                  }
                },
                "enableTelemetry": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Enable/Disable usage telemetry for the module. Default is true."
                  }
                },
                "includeAssociatedResources": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Whether to include associated resources (Key Vault, AI Search, Storage Account, Cosmos DB). Defaults to false."
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Location for all resources. Defaults to the resource group location."
                  }
                },
                "lock": {
                  "type": "object",
                  "properties": {
                    "kind": {
                      "type": "string",
                      "allowedValues": [
                        "CanNotDelete",
                        "None",
                        "ReadOnly"
                      ],
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Lock type."
                      }
                    },
                    "name": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Lock name."
                      }
                    },
                    "notes": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Lock notes."
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Lock configuration for the AI resources."
                  }
                },
                "privateEndpointSubnetResourceId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. The Resource ID of the subnet to establish Private Endpoint(s). If provided, private endpoints will be created for the AI Foundry account and associated resources. Each resource will also require supplied private DNS zone resource ID(s)."
                  }
                },
                "tags": {
                  "type": "object",
                  "properties": {},
                  "additionalProperties": {
                    "type": "string",
                    "metadata": {
                      "description": "Required. Arbitrary key for each tag."
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Specifies the resource tags for all the resources."
                  }
                },
                "aiFoundryConfiguration": {
                  "type": "object",
                  "properties": {
                    "accountName": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The name of the AI Foundry account."
                      }
                    },
                    "allowProjectManagement": {
                      "type": "bool",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Whether to allow project management in the account. Defaults to true."
                      }
                    },
                    "createCapabilityHosts": {
                      "type": "bool",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Whether to create capability hosts for the AI Agent Service. Requires includeAssociatedResources = true. Defaults to false."
                      }
                    },
                    "disableLocalAuth": {
                      "type": "bool",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Disables local authentication methods so that the account requires Microsoft Entra ID identities exclusively for authentication. Defaults to false for backward compatibility."
                      }
                    },
                    "location": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Location of the AI Foundry account. Defaults to resource group location."
                      }
                    },
                    "networking": {
                      "type": "object",
                      "properties": {
                        "aiServicesPrivateDnsZoneResourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Private DNS Zone Resource ID for Azure AI Services."
                          }
                        },
                        "cognitiveServicesPrivateDnsZoneResourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Private DNS Zone Resource ID for Cognitive Services."
                          }
                        },
                        "openAiPrivateDnsZoneResourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. Private DNS Zone Resource ID for OpenAI."
                          }
                        },
                        "agentServiceSubnetResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Subnet Resource ID for Azure AI Services. Required if you want to deploy AI Agent Service."
                          }
                        }
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Networking configuration for the AI Foundry account and project."
                      }
                    },
                    "project": {
                      "type": "object",
                      "properties": {
                        "description": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Project description."
                          }
                        },
                        "displayName": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Friendly/display name of the project."
                          }
                        },
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Name of the project."
                          }
                        }
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Default AI Foundry project."
                      }
                    },
                    "roleAssignments": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Role assignments to apply to the AI Foundry account."
                      }
                    },
                    "sku": {
                      "type": "string",
                      "allowedValues": [
                        "F0",
                        "S0"
                      ],
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. SKU of the AI Foundry / Cognitive Services account. Defaults to S0."
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Custom configuration for the AI Foundry account."
                  }
                },
                "aiModelDeployments": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "model": {
                        "type": "object",
                        "properties": {
                          "format": {
                            "type": "string",
                            "metadata": {
                              "description": "Required. Format of the deployment model."
                            }
                          },
                          "name": {
                            "type": "string",
                            "metadata": {
                              "description": "Required. Name of the deployment model."
                            }
                          },
                          "version": {
                            "type": "string",
                            "metadata": {
                              "description": "Required. Version of the deployment model."
                            }
                          }
                        },
                        "metadata": {
                          "description": "Required. Deployment model configuration."
                        }
                      },
                      "name": {
                        "type": "string",
                        "nullable": true,
                        "metadata": {
                          "description": "Optional. Name of the deployment."
                        }
                      },
                      "raiPolicyName": {
                        "type": "string",
                        "nullable": true,
                        "metadata": {
                          "description": "Optional. Responsible AI policy name."
                        }
                      },
                      "sku": {
                        "type": "object",
                        "properties": {
                          "name": {
                            "type": "string",
                            "metadata": {
                              "description": "Required. SKU name."
                            }
                          },
                          "capacity": {
                            "type": "int",
                            "nullable": true,
                            "metadata": {
                              "description": "Optional. SKU capacity."
                            }
                          },
                          "family": {
                            "type": "string",
                            "nullable": true,
                            "metadata": {
                              "description": "Optional. SKU family."
                            }
                          },
                          "size": {
                            "type": "string",
                            "nullable": true,
                            "metadata": {
                              "description": "Optional. SKU size."
                            }
                          },
                          "tier": {
                            "type": "string",
                            "nullable": true,
                            "metadata": {
                              "description": "Optional. SKU tier."
                            }
                          }
                        },
                        "nullable": true,
                        "metadata": {
                          "description": "Optional. SKU configuration for the deployment."
                        }
                      },
                      "versionUpgradeOption": {
                        "type": "string",
                        "nullable": true,
                        "metadata": {
                          "description": "Optional. Version upgrade option."
                        }
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Specifies the OpenAI deployments to create."
                  }
                },
                "aiSearchConfiguration": {
                  "type": "object",
                  "properties": {
                    "existingResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Existing AI Search resource ID. If provided, other properties are ignored."
                      }
                    },
                    "name": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Name for the AI Search resource."
                      }
                    },
                    "privateDnsZoneResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Private DNS Zone Resource ID for AI Search. Required if private endpoints are used."
                      }
                    },
                    "roleAssignments": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Role assignments for the AI Search resource."
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Custom configuration for AI Search."
                  }
                },
                "cosmosDbConfiguration": {
                  "type": "object",
                  "properties": {
                    "existingResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Existing Cosmos DB resource ID. If provided, other properties are ignored."
                      }
                    },
                    "name": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Name for the Cosmos DB resource."
                      }
                    },
                    "privateDnsZoneResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Private DNS Zone Resource ID for Cosmos DB. Required if private endpoints are used."
                      }
                    },
                    "roleAssignments": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Role assignments for the Cosmos DB resource."
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Custom configuration for Cosmos DB."
                  }
                },
                "keyVaultConfiguration": {
                  "type": "object",
                  "properties": {
                    "existingResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Existing Key Vault resource ID. If provided, other properties are ignored."
                      }
                    },
                    "name": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Name for the Key Vault."
                      }
                    },
                    "privateDnsZoneResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Private DNS Zone Resource ID for Key Vault. Required if private endpoints are used."
                      }
                    },
                    "roleAssignments": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Role assignments for the Key Vault resource."
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Custom configuration for Key Vault."
                  }
                },
                "storageAccountConfiguration": {
                  "type": "object",
                  "properties": {
                    "existingResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Existing Storage Account resource ID. If provided, other properties are ignored."
                      }
                    },
                    "name": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Name for the Storage Account."
                      }
                    },
                    "blobPrivateDnsZoneResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Private DNS Zone Resource ID for blob endpoint. Required if private endpoints are used."
                      }
                    },
                    "roleAssignments": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      },
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Role assignments for the Storage Account."
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Optional. Custom configuration for Storage Account."
                  }
                }
              },
              "metadata": {
                "description": "Configuration object for AI Foundry and its associated resources.",
                "__bicep_imported_from!": {
                  "sourceTemplate": "../common/types.bicep"
                }
              }
            }
          },
          "parameters": {
            "aiFoundry": {
              "$ref": "#/definitions/aiFoundryDefinitionType",
              "metadata": {
                "description": "Required. AI Foundry deployment configuration object. This object contains all the settings for the AI Foundry account, project, and associated resources."
              }
            },
            "enableTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Enable telemetry collection for the module."
              }
            }
          },
          "resources": {
            "inner": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('aif-avm-{0}', parameters('aiFoundry').baseName)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "baseName": {
                    "value": "[parameters('aiFoundry').baseName]"
                  },
                  "baseUniqueName": {
                    "value": "[tryGet(parameters('aiFoundry'), 'baseUniqueName')]"
                  },
                  "enableTelemetry": {
                    "value": "[parameters('enableTelemetry')]"
                  },
                  "includeAssociatedResources": {
                    "value": "[tryGet(parameters('aiFoundry'), 'includeAssociatedResources')]"
                  },
                  "location": {
                    "value": "[tryGet(parameters('aiFoundry'), 'location')]"
                  },
                  "lock": {
                    "value": "[tryGet(parameters('aiFoundry'), 'lock')]"
                  },
                  "tags": {
                    "value": "[tryGet(parameters('aiFoundry'), 'tags')]"
                  },
                  "privateEndpointSubnetResourceId": {
                    "value": "[tryGet(parameters('aiFoundry'), 'privateEndpointSubnetResourceId')]"
                  },
                  "aiFoundryConfiguration": {
                    "value": "[tryGet(parameters('aiFoundry'), 'aiFoundryConfiguration')]"
                  },
                  "aiModelDeployments": {
                    "value": "[tryGet(parameters('aiFoundry'), 'aiModelDeployments')]"
                  },
                  "aiSearchConfiguration": {
                    "value": "[tryGet(parameters('aiFoundry'), 'aiSearchConfiguration')]"
                  },
                  "cosmosDbConfiguration": {
                    "value": "[tryGet(parameters('aiFoundry'), 'cosmosDbConfiguration')]"
                  },
                  "keyVaultConfiguration": {
                    "value": "[tryGet(parameters('aiFoundry'), 'keyVaultConfiguration')]"
                  },
                  "storageAccountConfiguration": {
                    "value": "[tryGet(parameters('aiFoundry'), 'storageAccountConfiguration')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "8697116776480571797"
                    },
                    "name": "ai-foundry",
                    "description": "Creates an AI Foundry account and project with Standard Agent Services."
                  },
                  "definitions": {
                    "resourceConfigurationType": {
                      "type": "object",
                      "properties": {
                        "existingResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Resource ID of an existing resource to use instead of creating a new one. If provided, other parameters are ignored."
                          }
                        },
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Name to be used when creating the resource. This is ignored if an existingResourceId is provided."
                          }
                        },
                        "privateDnsZoneResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The Resource ID of the Private DNS Zone that associates with the resource. This is required to establish a Private Endpoint and when 'privateEndpointSubnetResourceId' is provided."
                          }
                        },
                        "roleAssignments": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/roleAssignmentType"
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Role assignments to apply to the resource when creating it. This is ignored if an existingResourceId is provided."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "Custom configuration for a resource, including optional name, existing resource ID, and role assignments."
                      }
                    },
                    "storageAccountConfigurationType": {
                      "type": "object",
                      "properties": {
                        "existingResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Resource Id of an existing Storage Account to use instead of creating a new one. If provided, other parameters are ignored."
                          }
                        },
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Name to be used when creating the Storage Account. This is ignored if an existingResourceId is provided."
                          }
                        },
                        "blobPrivateDnsZoneResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The Resource ID of the DNS zone \"blob\" for the Azure Storage Account. This is required to establish a Private Endpoint and when 'privateEndpointSubnetResourceId' is provided."
                          }
                        },
                        "roleAssignments": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/roleAssignmentType"
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Role assignments to apply to the resource when creating it. This is ignored if an existingResourceId is provided."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "Custom configuration for a Storage Account, including optional name, existing resource ID, containers, and role assignments."
                      }
                    },
                    "foundryConfigurationType": {
                      "type": "object",
                      "properties": {
                        "accountName": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name of the AI Foundry account."
                          }
                        },
                        "location": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The location of the AI Foundry account. Will default to the resource group location if not specified."
                          }
                        },
                        "sku": {
                          "type": "string",
                          "allowedValues": [
                            "C2",
                            "C3",
                            "C4",
                            "DC0",
                            "F0",
                            "F1",
                            "S",
                            "S0",
                            "S1",
                            "S10",
                            "S2",
                            "S3",
                            "S4",
                            "S5",
                            "S6",
                            "S7",
                            "S8",
                            "S9"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. SKU of the AI Foundry / Cognitive Services account. Use 'Get-AzCognitiveServicesAccountSku' to determine a valid combinations of 'kind' and 'SKU' for your Azure region. Defaults to 'S0'."
                          }
                        },
                        "createCapabilityHosts": {
                          "type": "bool",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Whether to create Capability Hosts for the AI Agent Service. If true, the AI Foundry Account and default Project will be created with the capability host for the associated resources. Can only be true if 'includeAssociatedResources' is true. Defaults to false."
                          }
                        },
                        "disableLocalAuth": {
                          "type": "bool",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Allow only Azure AD authentication. Should be enabled for security reasons. Defaults to true."
                          }
                        },
                        "allowProjectManagement": {
                          "type": "bool",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Whether to allow project management in the AI Foundry account. If true, users can create and manage projects within the AI Foundry account. Defaults to true."
                          }
                        },
                        "networking": {
                          "$ref": "#/definitions/foundryNetworkConfigurationType",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Values to establish private networking for the AI Foundry account and project."
                          }
                        },
                        "project": {
                          "$ref": "#/definitions/foundryProjectConfigurationType",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. AI Foundry default project."
                          }
                        },
                        "roleAssignments": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/roleAssignmentType"
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Role assignments to apply to the AI Foundry resource when creating it."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "Custom configuration for a AI Foundry, including optional account name and project configuration."
                      }
                    },
                    "foundryNetworkConfigurationType": {
                      "type": "object",
                      "properties": {
                        "agentServiceSubnetResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The Resource ID of the subnet for the Azure AI Services account. This is required if 'createAIAgentService' is true."
                          }
                        },
                        "cognitiveServicesPrivateDnsZoneResourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The Resource ID of the Private DNS Zone for the Azure AI Services account."
                          }
                        },
                        "openAiPrivateDnsZoneResourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The Resource ID of the Private DNS Zone for the OpenAI account."
                          }
                        },
                        "aiServicesPrivateDnsZoneResourceId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The Resource ID of the Private DNS Zone for the Azure AI Services account."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "Values to establish private networking for the AI Foundry service."
                      }
                    },
                    "foundryProjectConfigurationType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name of the AI Foundry project."
                          }
                        },
                        "displayName": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The friendly/display name of the AI Foundry project."
                          }
                        },
                        "desc": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The description of the AI Foundry project."
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_export!": true,
                        "description": "Custom configuration for an AI Foundry project, including optional name, friendly name, and description."
                      }
                    },
                    "deploymentType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the name of cognitive service account deployment."
                          }
                        },
                        "model": {
                          "type": "object",
                          "properties": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The name of Cognitive Services account deployment model."
                              }
                            },
                            "format": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The format of Cognitive Services account deployment model."
                              }
                            },
                            "version": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The version of Cognitive Services account deployment model."
                              }
                            }
                          },
                          "metadata": {
                            "description": "Required. Properties of Cognitive Services account deployment model."
                          }
                        },
                        "sku": {
                          "type": "object",
                          "properties": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The name of the resource model definition representing SKU."
                              }
                            },
                            "capacity": {
                              "type": "int",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The capacity of the resource model definition representing SKU."
                              }
                            },
                            "tier": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The tier of the resource model definition representing SKU."
                              }
                            },
                            "size": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The size of the resource model definition representing SKU."
                              }
                            },
                            "family": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The family of the resource model definition representing SKU."
                              }
                            }
                          },
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The resource model definition representing SKU."
                          }
                        },
                        "raiPolicyName": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name of RAI policy."
                          }
                        },
                        "versionUpgradeOption": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The version upgrade option."
                          }
                        }
                      },
                      "metadata": {
                        "description": "The type for a cognitive services account deployment.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/res/cognitive-services/account:0.13.2"
                        }
                      }
                    },
                    "lockType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the name of lock."
                          }
                        },
                        "kind": {
                          "type": "string",
                          "allowedValues": [
                            "CanNotDelete",
                            "None",
                            "ReadOnly"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the type of lock."
                          }
                        },
                        "notes": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Specify the notes of the lock."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a lock.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                        }
                      }
                    },
                    "roleAssignmentType": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                          }
                        },
                        "roleDefinitionIdOrName": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                          }
                        },
                        "principalId": {
                          "type": "string",
                          "metadata": {
                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                          }
                        },
                        "principalType": {
                          "type": "string",
                          "allowedValues": [
                            "Device",
                            "ForeignGroup",
                            "Group",
                            "ServicePrincipal",
                            "User"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The principal type of the assigned principal ID."
                          }
                        },
                        "description": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The description of the role assignment."
                          }
                        },
                        "condition": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                          }
                        },
                        "conditionVersion": {
                          "type": "string",
                          "allowedValues": [
                            "2.0"
                          ],
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. Version of the condition."
                          }
                        },
                        "delegatedManagedIdentityResourceId": {
                          "type": "string",
                          "nullable": true,
                          "metadata": {
                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                          }
                        }
                      },
                      "metadata": {
                        "description": "An AVM-aligned type for a role assignment.",
                        "__bicep_imported_from!": {
                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "baseName": {
                      "type": "string",
                      "minLength": 3,
                      "maxLength": 12,
                      "metadata": {
                        "description": "Required. A friendly application/environment name to serve as the \"base\" when using the default naming for all resources in this deployment."
                      }
                    },
                    "baseUniqueName": {
                      "type": "string",
                      "defaultValue": "[substring(uniqueString(subscription().id, resourceGroup().name, parameters('baseName')), 0, 5)]",
                      "maxLength": 5,
                      "metadata": {
                        "description": "Optional. A unique text value for the application/environment. This is used to ensure resource names are unique for global resources. Defaults to a 5-character substring of the unique string generated from the subscription ID, resource group name, and base name."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Optional. Location for all Resources. Defaults to the location of the resource group."
                      }
                    },
                    "enableTelemetry": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Optional. Enable/Disable usage telemetry for module."
                      }
                    },
                    "aiModelDeployments": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/deploymentType"
                      },
                      "defaultValue": [],
                      "metadata": {
                        "description": "Optional. Specifies the OpenAI deployments to create."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "__bicep_resource_derived_type!": {
                          "source": "Microsoft.Resources/resourceGroups@2025-04-01#properties/tags"
                        },
                        "description": "Optional. Specifies the resource tags for all the resources."
                      },
                      "defaultValue": {}
                    },
                    "lock": {
                      "$ref": "#/definitions/lockType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The lock settings of the AI resources."
                      }
                    },
                    "includeAssociatedResources": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Optional. Whether to include associated resources: Key Vault, AI Search, Storage Account, and Cosmos DB. If true, these resources will be created. Optionally, existing resources of these types can be supplied in their respective parameters. Defaults to false."
                      }
                    },
                    "privateEndpointSubnetResourceId": {
                      "type": "string",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. The Resource ID of the subnet to establish Private Endpoint(s). If provided, private endpoints will be created for the AI Foundry account and associated resources when creating those resource. Each resource will also require supplied private DNS zone resource ID(s) to establish those private endpoints."
                      }
                    },
                    "aiFoundryConfiguration": {
                      "$ref": "#/definitions/foundryConfigurationType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Custom configuration for the AI Foundry."
                      }
                    },
                    "keyVaultConfiguration": {
                      "$ref": "#/definitions/resourceConfigurationType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Custom configuration for the Key Vault."
                      }
                    },
                    "aiSearchConfiguration": {
                      "$ref": "#/definitions/resourceConfigurationType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Custom configuration for the AI Search resource."
                      }
                    },
                    "storageAccountConfiguration": {
                      "$ref": "#/definitions/storageAccountConfigurationType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Custom configuration for the Storage Account."
                      }
                    },
                    "cosmosDbConfiguration": {
                      "$ref": "#/definitions/resourceConfigurationType",
                      "nullable": true,
                      "metadata": {
                        "description": "Optional. Custom configuration for the Cosmos DB Account."
                      }
                    }
                  },
                  "variables": {
                    "resourcesName": "[toLower(trim(replace(replace(replace(replace(replace(replace(format('{0}{1}', parameters('baseName'), parameters('baseUniqueName')), '-', ''), '_', ''), '.', ''), '/', ''), ' ', ''), '*', '')))]",
                    "projectName": "[if(not(empty(tryGet(tryGet(parameters('aiFoundryConfiguration'), 'project'), 'name'))), parameters('aiFoundryConfiguration').project.name, format('proj-{0}', variables('resourcesName')))]",
                    "createCapabilityHosts": "[and(coalesce(tryGet(parameters('aiFoundryConfiguration'), 'createCapabilityHosts'), false()), parameters('includeAssociatedResources'))]"
                  },
                  "resources": {
                    "avmTelemetry": {
                      "condition": "[parameters('enableTelemetry')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2024-03-01",
                      "name": "[format('46d3xbcp.ptn.aiml-aifoundry.{0}.{1}', replace('0.6.0', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                      "properties": {
                        "mode": "Incremental",
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "resources": [],
                          "outputs": {
                            "telemetry": {
                              "type": "String",
                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                            }
                          }
                        }
                      }
                    },
                    "foundryAccount": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[take(format('module.account.{0}', variables('resourcesName')), 64)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": "[if(not(empty(tryGet(parameters('aiFoundryConfiguration'), 'accountName'))), createObject('value', parameters('aiFoundryConfiguration').accountName), createObject('value', format('ai{0}', variables('resourcesName'))))]",
                          "location": "[if(not(empty(tryGet(parameters('aiFoundryConfiguration'), 'location'))), createObject('value', parameters('aiFoundryConfiguration').location), createObject('value', parameters('location')))]",
                          "sku": "[if(not(empty(tryGet(parameters('aiFoundryConfiguration'), 'sku'))), createObject('value', parameters('aiFoundryConfiguration').sku), createObject('value', 'S0'))]",
                          "disableLocalAuth": {
                            "value": "[coalesce(tryGet(parameters('aiFoundryConfiguration'), 'disableLocalAuth'), true())]"
                          },
                          "allowProjectManagement": {
                            "value": "[coalesce(tryGet(parameters('aiFoundryConfiguration'), 'allowProjectManagement'), true())]"
                          },
                          "aiModelDeployments": {
                            "value": "[parameters('aiModelDeployments')]"
                          },
                          "privateEndpointSubnetResourceId": {
                            "value": "[parameters('privateEndpointSubnetResourceId')]"
                          },
                          "agentSubnetResourceId": {
                            "value": "[tryGet(tryGet(parameters('aiFoundryConfiguration'), 'networking'), 'agentServiceSubnetResourceId')]"
                          },
                          "privateDnsZoneResourceIds": "[if(and(not(empty(parameters('privateEndpointSubnetResourceId'))), not(empty(tryGet(parameters('aiFoundryConfiguration'), 'networking')))), createObject('value', createArray(parameters('aiFoundryConfiguration').networking.cognitiveServicesPrivateDnsZoneResourceId, parameters('aiFoundryConfiguration').networking.openAiPrivateDnsZoneResourceId, parameters('aiFoundryConfiguration').networking.aiServicesPrivateDnsZoneResourceId)), createObject('value', createArray()))]",
                          "roleAssignments": {
                            "value": "[tryGet(parameters('aiFoundryConfiguration'), 'roleAssignments')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "enableTelemetry": {
                            "value": "[parameters('enableTelemetry')]"
                          },
                          "lock": {
                            "value": "[parameters('lock')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "9133352881482707682"
                            }
                          },
                          "definitions": {
                            "deploymentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the name of cognitive service account deployment."
                                  }
                                },
                                "model": {
                                  "type": "object",
                                  "properties": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of Cognitive Services account deployment model."
                                      }
                                    },
                                    "format": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The format of Cognitive Services account deployment model."
                                      }
                                    },
                                    "version": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The version of Cognitive Services account deployment model."
                                      }
                                    }
                                  },
                                  "metadata": {
                                    "description": "Required. Properties of Cognitive Services account deployment model."
                                  }
                                },
                                "sku": {
                                  "type": "object",
                                  "properties": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the resource model definition representing SKU."
                                      }
                                    },
                                    "capacity": {
                                      "type": "int",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The capacity of the resource model definition representing SKU."
                                      }
                                    },
                                    "tier": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The tier of the resource model definition representing SKU."
                                      }
                                    },
                                    "size": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The size of the resource model definition representing SKU."
                                      }
                                    },
                                    "family": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The family of the resource model definition representing SKU."
                                      }
                                    }
                                  },
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The resource model definition representing SKU."
                                  }
                                },
                                "raiPolicyName": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of RAI policy."
                                  }
                                },
                                "versionUpgradeOption": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The version upgrade option."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "The type for a cognitive services account deployment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/res/cognitive-services/account:0.13.2"
                                }
                              }
                            },
                            "lockType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the name of lock."
                                  }
                                },
                                "kind": {
                                  "type": "string",
                                  "allowedValues": [
                                    "CanNotDelete",
                                    "None",
                                    "ReadOnly"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the type of lock."
                                  }
                                },
                                "notes": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the notes of the lock."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a lock.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                }
                              }
                            },
                            "roleAssignmentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                  }
                                },
                                "roleDefinitionIdOrName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                  }
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                  }
                                },
                                "principalType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Device",
                                    "ForeignGroup",
                                    "Group",
                                    "ServicePrincipal",
                                    "User"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The principal type of the assigned principal ID."
                                  }
                                },
                                "description": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The description of the role assignment."
                                  }
                                },
                                "condition": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                  }
                                },
                                "conditionVersion": {
                                  "type": "string",
                                  "allowedValues": [
                                    "2.0"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Version of the condition."
                                  }
                                },
                                "delegatedManagedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a role assignment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                }
                              }
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The name of the AI Foundry resource."
                              }
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The location for the AI Foundry resource."
                              }
                            },
                            "sku": {
                              "type": "string",
                              "defaultValue": "S0",
                              "allowedValues": [
                                "C2",
                                "C3",
                                "C4",
                                "F0",
                                "F1",
                                "S",
                                "S0",
                                "S1",
                                "S10",
                                "S2",
                                "S3",
                                "S4",
                                "S5",
                                "S6",
                                "S7",
                                "S8",
                                "S9",
                                "DC0"
                              ],
                              "metadata": {
                                "description": "Optional. SKU of the AI Foundry / Cognitive Services account. Use 'Get-AzCognitiveServicesAccountSku' to determine a valid combinations of 'kind' and 'SKU' for your Azure region."
                              }
                            },
                            "allowProjectManagement": {
                              "type": "bool",
                              "metadata": {
                                "description": "Required. Whether to allow project management in AI Foundry. This is required to enable the AI Foundry UI and project management features."
                              }
                            },
                            "privateEndpointSubnetResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource Id of an existing subnet to use for private connectivity. This is required along with 'privateDnsZoneResourceIds' to establish private endpoints."
                              }
                            },
                            "agentSubnetResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource Id of an existing subnet to use for agent connectivity. This is required when using agents with private endpoints."
                              }
                            },
                            "disableLocalAuth": {
                              "type": "bool",
                              "metadata": {
                                "description": "Required. Allow only Azure AD authentication. Should be enabled for security reasons."
                              }
                            },
                            "roleAssignments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/roleAssignmentType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Specifies the role assignments for the AI Foundry resource."
                              }
                            },
                            "lock": {
                              "$ref": "#/definitions/lockType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The lock settings of AI Foundry resources."
                              }
                            },
                            "aiModelDeployments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/deploymentType"
                              },
                              "defaultValue": [],
                              "metadata": {
                                "description": "Optional. Specifies the OpenAI deployments to create."
                              }
                            },
                            "privateDnsZoneResourceIds": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. List of private DNS zone resource IDs to use for the AI Foundry resource. This is required when using private endpoints."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Resources/resourceGroups@2025-04-01#properties/tags"
                                },
                                "description": "Optional. Specifies the resource tags for all the resources."
                              },
                              "defaultValue": {}
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "privateDnsZoneResourceIdValues",
                                "count": "[length(coalesce(parameters('privateDnsZoneResourceIds'), createArray()))]",
                                "input": {
                                  "privateDnsZoneResourceId": "[coalesce(parameters('privateDnsZoneResourceIds'), createArray())[copyIndex('privateDnsZoneResourceIdValues')]]"
                                }
                              }
                            ],
                            "privateNetworkingEnabled": "[and(not(empty(variables('privateDnsZoneResourceIdValues'))), not(empty(parameters('privateEndpointSubnetResourceId'))))]"
                          },
                          "resources": {
                            "foundryAccount": {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('avm.res.cognitive-services.account.{0}', parameters('name')), 64)]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[parameters('name')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "sku": {
                                    "value": "[parameters('sku')]"
                                  },
                                  "kind": {
                                    "value": "AIServices"
                                  },
                                  "lock": {
                                    "value": "[parameters('lock')]"
                                  },
                                  "allowProjectManagement": {
                                    "value": "[parameters('allowProjectManagement')]"
                                  },
                                  "managedIdentities": {
                                    "value": {
                                      "systemAssigned": true
                                    }
                                  },
                                  "deployments": {
                                    "value": "[parameters('aiModelDeployments')]"
                                  },
                                  "customSubDomainName": {
                                    "value": "[parameters('name')]"
                                  },
                                  "disableLocalAuth": {
                                    "value": "[parameters('disableLocalAuth')]"
                                  },
                                  "publicNetworkAccess": "[if(variables('privateNetworkingEnabled'), createObject('value', 'Disabled'), createObject('value', 'Enabled'))]",
                                  "networkAcls": {
                                    "value": {
                                      "defaultAction": "Allow",
                                      "bypass": "AzureServices"
                                    }
                                  },
                                  "networkInjections": "[if(and(variables('privateNetworkingEnabled'), not(empty(parameters('agentSubnetResourceId')))), createObject('value', createObject('scenario', 'agent', 'subnetResourceId', parameters('agentSubnetResourceId'), 'useMicrosoftManagedNetwork', false())), createObject('value', null()))]",
                                  "privateEndpoints": "[if(variables('privateNetworkingEnabled'), createObject('value', createArray(createObject('privateDnsZoneGroup', createObject('privateDnsZoneGroupConfigs', variables('privateDnsZoneResourceIdValues')), 'subnetResourceId', parameters('privateEndpointSubnetResourceId')))), createObject('value', createArray()))]",
                                  "enableTelemetry": {
                                    "value": "[parameters('enableTelemetry')]"
                                  },
                                  "roleAssignments": {
                                    "value": "[parameters('roleAssignments')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.37.4.10188",
                                      "templateHash": "9381727816193702843"
                                    },
                                    "name": "Cognitive Services",
                                    "description": "This module deploys a Cognitive Service."
                                  },
                                  "definitions": {
                                    "privateEndpointOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the private endpoint."
                                          }
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the private endpoint."
                                          }
                                        },
                                        "groupId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "The group Id for the private endpoint Group."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "fqdn": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "FQDN that resolves to private endpoint IP address."
                                                }
                                              },
                                              "ipAddresses": {
                                                "type": "array",
                                                "items": {
                                                  "type": "string"
                                                },
                                                "metadata": {
                                                  "description": "A list of private IP addresses of the private endpoint."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "The custom DNS configurations of the private endpoint."
                                          }
                                        },
                                        "networkInterfaceResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "The IDs of the network interfaces associated with the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for the private endpoint output."
                                      }
                                    },
                                    "deploymentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of cognitive service account deployment."
                                          }
                                        },
                                        "model": {
                                          "type": "object",
                                          "properties": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of Cognitive Services account deployment model."
                                              }
                                            },
                                            "format": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The format of Cognitive Services account deployment model."
                                              }
                                            },
                                            "version": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The version of Cognitive Services account deployment model."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Properties of Cognitive Services account deployment model."
                                          }
                                        },
                                        "sku": {
                                          "type": "object",
                                          "properties": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of the resource model definition representing SKU."
                                              }
                                            },
                                            "capacity": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The capacity of the resource model definition representing SKU."
                                              }
                                            },
                                            "tier": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The tier of the resource model definition representing SKU."
                                              }
                                            },
                                            "size": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The size of the resource model definition representing SKU."
                                              }
                                            },
                                            "family": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The family of the resource model definition representing SKU."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource model definition representing SKU."
                                          }
                                        },
                                        "raiPolicyName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of RAI policy."
                                          }
                                        },
                                        "versionUpgradeOption": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The version upgrade option."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a cognitive services account deployment."
                                      }
                                    },
                                    "endpointType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Type of the endpoint."
                                          }
                                        },
                                        "endpoint": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "The endpoint URI."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a cognitive services account endpoint."
                                      }
                                    },
                                    "secretsExportConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "keyVaultResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The key vault name where to store the keys and connection strings generated by the modules."
                                          }
                                        },
                                        "accessKey1Name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name for the accessKey1 secret to create."
                                          }
                                        },
                                        "accessKey2Name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name for the accessKey2 secret to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of the secrets exported to the provided Key Vault."
                                      }
                                    },
                                    "commitmentPlanType": {
                                      "type": "object",
                                      "properties": {
                                        "autoRenew": {
                                          "type": "bool",
                                          "metadata": {
                                            "description": "Required. Whether the plan should auto-renew at the end of the current commitment period."
                                          }
                                        },
                                        "current": {
                                          "type": "object",
                                          "properties": {
                                            "count": {
                                              "type": "int",
                                              "metadata": {
                                                "description": "Required. The number of committed instances (e.g., number of containers or cores)."
                                              }
                                            },
                                            "tier": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The tier of the commitment plan (e.g., T1, T2)."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. The current commitment configuration."
                                          }
                                        },
                                        "hostingModel": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The hosting model for the commitment plan. (e.g., DisconnectedContainer, ConnectedContainer, ProvisionedWeb, Web)."
                                          }
                                        },
                                        "planType": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The plan type indicating which capability the plan applies to (e.g., NTTS, STT, CUSTOMSTT, ADDON)."
                                          }
                                        },
                                        "commitmentPlanGuid": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The unique identifier of an existing commitment plan to update. Set to null to create a new plan."
                                          }
                                        },
                                        "next": {
                                          "type": "object",
                                          "properties": {
                                            "count": {
                                              "type": "int",
                                              "metadata": {
                                                "description": "Required. The number of committed instances for the next period."
                                              }
                                            },
                                            "tier": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The tier for the next commitment period."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The configuration of the next commitment period, if scheduled."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a disconnected container commitment plan."
                                      }
                                    },
                                    "networkInjectionType": {
                                      "type": "object",
                                      "properties": {
                                        "scenario": {
                                          "type": "string",
                                          "allowedValues": [
                                            "agent",
                                            "none"
                                          ],
                                          "metadata": {
                                            "description": "Required. The scenario for the network injection."
                                          }
                                        },
                                        "subnetResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The Resource ID of the subnet on the Virtual Network on which to inject."
                                          }
                                        },
                                        "useMicrosoftManagedNetwork": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Whether to use Microsoft Managed Network. Defaults to false."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "Type for network configuration in AI Foundry where virtual network injection occurs to secure scenarios like Agents entirely within a private network."
                                      }
                                    },
                                    "_1.secretSetOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "secretResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resourceId of the exported secret."
                                          }
                                        },
                                        "secretUri": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The secret URI of the exported secret."
                                          }
                                        },
                                        "secretUriWithVersion": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The secret URI with version of the exported secret."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for the output of the secret set via the secrets export feature.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    },
                                    "_2.lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "notes": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the notes of the lock."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a lock.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_2.privateEndpointCustomDnsConfigType": {
                                      "type": "object",
                                      "properties": {
                                        "fqdn": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. FQDN that resolves to private endpoint IP address."
                                          }
                                        },
                                        "ipAddresses": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of private IP addresses of the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_2.privateEndpointIpConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the resource that is unique within a resource group."
                                          }
                                        },
                                        "properties": {
                                          "type": "object",
                                          "properties": {
                                            "groupId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "memberName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "privateIPAddress": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Properties of private endpoint IP configurations."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_2.privateEndpointPrivateDnsZoneGroupType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private DNS Zone Group."
                                          }
                                        },
                                        "privateDnsZoneGroupConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "name": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. The name of the private DNS Zone Group config."
                                                }
                                              },
                                              "privateDnsZoneResourceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource id of the private DNS zone."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. The private DNS Zone Groups to associate the Private Endpoint. A DNS Zone Group can support up to 5 DNS zones."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_2.roleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "roleDefinitionIdOrName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                          }
                                        },
                                        "principalType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Device",
                                            "ForeignGroup",
                                            "Group",
                                            "ServicePrincipal",
                                            "User"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The principal type of the assigned principal ID."
                                          }
                                        },
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The description of the role assignment."
                                          }
                                        },
                                        "condition": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                          }
                                        },
                                        "conditionVersion": {
                                          "type": "string",
                                          "allowedValues": [
                                            "2.0"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Version of the condition."
                                          }
                                        },
                                        "delegatedManagedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a role assignment.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "customerManagedKeyType": {
                                      "type": "object",
                                      "properties": {
                                        "keyVaultResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The resource ID of a key vault to reference a customer managed key for encryption from."
                                          }
                                        },
                                        "keyName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the customer managed key to use for encryption."
                                          }
                                        },
                                        "keyVersion": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The version of the customer managed key to reference for encryption. If not provided, the deployment will use the latest version available at deployment time."
                                          }
                                        },
                                        "userAssignedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. User assigned identity to use when fetching the customer managed key. Required if no system assigned identity is available for use."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a customer-managed key. To be used if the resource type does not support auto-rotation of the customer-managed key.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    },
                                    "diagnosticSettingFullType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the diagnostic setting."
                                          }
                                        },
                                        "logCategoriesAndGroups": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                }
                                              },
                                              "categoryGroup": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                          }
                                        },
                                        "metricCategories": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                          }
                                        },
                                        "logAnalyticsDestinationType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureDiagnostics",
                                            "Dedicated"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                          }
                                        },
                                        "workspaceResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "storageAccountResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "eventHubAuthorizationRuleResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                          }
                                        },
                                        "eventHubName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "marketplacePartnerResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    },
                                    "lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "notes": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the notes of the lock."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a lock.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    },
                                    "managedIdentityAllType": {
                                      "type": "object",
                                      "properties": {
                                        "systemAssigned": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enables system assigned managed identity on the resource."
                                          }
                                        },
                                        "userAssignedResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID(s) to assign to the resource. Required if a user assigned identity is used for encryption."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a managed identity configuration. To be used if both a system-assigned & user-assigned identities are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    },
                                    "privateEndpointSingleServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private Endpoint."
                                          }
                                        },
                                        "location": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The location to deploy the Private Endpoint to."
                                          }
                                        },
                                        "privateLinkServiceConnectionName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the private link connection to create."
                                          }
                                        },
                                        "service": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The subresource to deploy the Private Endpoint for. For example \"vault\" for a Key Vault Private Endpoint."
                                          }
                                        },
                                        "subnetResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                          }
                                        },
                                        "resourceGroupResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID of the Resource Group the Private Endpoint will be created in. If not specified, the Resource Group of the provided Virtual Network Subnet is used."
                                          }
                                        },
                                        "privateDnsZoneGroup": {
                                          "$ref": "#/definitions/_2.privateEndpointPrivateDnsZoneGroupType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The private DNS Zone Group to configure for the Private Endpoint."
                                          }
                                        },
                                        "isManualConnection": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. If Manual Private Link Connection is required."
                                          }
                                        },
                                        "manualConnectionRequestMessage": {
                                          "type": "string",
                                          "nullable": true,
                                          "maxLength": 140,
                                          "metadata": {
                                            "description": "Optional. A message passed to the owner of the remote resource with the manual connection request."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_2.privateEndpointCustomDnsConfigType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Custom DNS configurations."
                                          }
                                        },
                                        "ipConfigurations": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_2.privateEndpointIpConfigurationType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of IP configurations of the Private Endpoint. This will be used to map to the first-party Service endpoints."
                                          }
                                        },
                                        "applicationSecurityGroupResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Application security groups in which the Private Endpoint IP configuration is included."
                                          }
                                        },
                                        "customNetworkInterfaceName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The custom name of the network interface attached to the Private Endpoint."
                                          }
                                        },
                                        "lock": {
                                          "$ref": "#/definitions/_2.lockType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_2.roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Network/privateEndpoints@2024-07-01#properties/tags"
                                            },
                                            "description": "Optional. Tags to be applied on all resources/Resource Groups in this deployment."
                                          }
                                        },
                                        "enableTelemetry": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable/Disable usage telemetry for module."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a private endpoint. To be used if the private endpoint's default service / groupId can be assumed (i.e., for services that only have one Private Endpoint type like 'vault' for key vault).",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "roleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "roleDefinitionIdOrName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                          }
                                        },
                                        "principalType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Device",
                                            "ForeignGroup",
                                            "Group",
                                            "ServicePrincipal",
                                            "User"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The principal type of the assigned principal ID."
                                          }
                                        },
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The description of the role assignment."
                                          }
                                        },
                                        "condition": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                          }
                                        },
                                        "conditionVersion": {
                                          "type": "string",
                                          "allowedValues": [
                                            "2.0"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Version of the condition."
                                          }
                                        },
                                        "delegatedManagedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a role assignment.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    },
                                    "secretsOutputType": {
                                      "type": "object",
                                      "properties": {},
                                      "additionalProperties": {
                                        "$ref": "#/definitions/_1.secretSetOutputType",
                                        "metadata": {
                                          "description": "An exported secret's references."
                                        }
                                      },
                                      "metadata": {
                                        "description": "A map of the exported secrets",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of Cognitive Services account."
                                      }
                                    },
                                    "kind": {
                                      "type": "string",
                                      "allowedValues": [
                                        "AIServices",
                                        "AnomalyDetector",
                                        "CognitiveServices",
                                        "ComputerVision",
                                        "ContentModerator",
                                        "ContentSafety",
                                        "ConversationalLanguageUnderstanding",
                                        "CustomVision.Prediction",
                                        "CustomVision.Training",
                                        "Face",
                                        "FormRecognizer",
                                        "HealthInsights",
                                        "ImmersiveReader",
                                        "Internal.AllInOne",
                                        "LUIS",
                                        "LUIS.Authoring",
                                        "LanguageAuthoring",
                                        "MetricsAdvisor",
                                        "OpenAI",
                                        "Personalizer",
                                        "QnAMaker.v2",
                                        "SpeechServices",
                                        "TextAnalytics",
                                        "TextTranslation"
                                      ],
                                      "metadata": {
                                        "description": "Required. Kind of the Cognitive Services account. Use 'Get-AzCognitiveServicesAccountSku' to determine a valid combinations of 'kind' and 'SKU' for your Azure region."
                                      }
                                    },
                                    "sku": {
                                      "type": "string",
                                      "defaultValue": "S0",
                                      "allowedValues": [
                                        "C2",
                                        "C3",
                                        "C4",
                                        "F0",
                                        "F1",
                                        "S",
                                        "S0",
                                        "S1",
                                        "S10",
                                        "S2",
                                        "S3",
                                        "S4",
                                        "S5",
                                        "S6",
                                        "S7",
                                        "S8",
                                        "S9",
                                        "DC0"
                                      ],
                                      "metadata": {
                                        "description": "Optional. SKU of the Cognitive Services account. Use 'Get-AzCognitiveServicesAccountSku' to determine a valid combinations of 'kind' and 'SKU' for your Azure region."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Location for all Resources."
                                      }
                                    },
                                    "diagnosticSettings": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/diagnosticSettingFullType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The diagnostic settings of the service."
                                      }
                                    },
                                    "publicNetworkAccess": {
                                      "type": "string",
                                      "nullable": true,
                                      "allowedValues": [
                                        "Enabled",
                                        "Disabled"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Whether or not public network access is allowed for this resource. For security reasons it should be disabled. If not specified, it will be disabled by default if private endpoints are set and networkAcls are not set."
                                      }
                                    },
                                    "customSubDomainName": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Conditional. Subdomain name used for token-based authentication. Required if 'networkAcls' or 'privateEndpoints' are set."
                                      }
                                    },
                                    "networkAcls": {
                                      "type": "object",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. A collection of rules governing the accessibility from specific network locations."
                                      }
                                    },
                                    "networkInjections": {
                                      "$ref": "#/definitions/networkInjectionType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Specifies in AI Foundry where virtual network injection occurs to secure scenarios like Agents entirely within a private network."
                                      }
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointSingleServiceType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible."
                                      }
                                    },
                                    "lock": {
                                      "$ref": "#/definitions/lockType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The lock settings of the service."
                                      }
                                    },
                                    "roleAssignments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/roleAssignmentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Array of role assignments to create."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Tags of the resource."
                                      }
                                    },
                                    "allowedFqdnList": {
                                      "type": "array",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. List of allowed FQDN."
                                      }
                                    },
                                    "apiProperties": {
                                      "type": "object",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The API properties for special APIs."
                                      }
                                    },
                                    "disableLocalAuth": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Allow only Azure AD authentication. Should be enabled for security reasons."
                                      }
                                    },
                                    "customerManagedKey": {
                                      "$ref": "#/definitions/customerManagedKeyType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The customer managed key definition."
                                      }
                                    },
                                    "dynamicThrottlingEnabled": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. The flag to enable dynamic throttling."
                                      }
                                    },
                                    "migrationToken": {
                                      "type": "securestring",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Resource migration token."
                                      }
                                    },
                                    "restore": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Restore a soft-deleted cognitive service at deployment time. Will fail if no such soft-deleted resource exists."
                                      }
                                    },
                                    "restrictOutboundNetworkAccess": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Restrict outbound network access."
                                      }
                                    },
                                    "userOwnedStorage": {
                                      "type": "array",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.CognitiveServices/accounts@2025-04-01-preview#properties/properties/properties/userOwnedStorage"
                                        },
                                        "description": "Optional. The storage accounts for this resource."
                                      },
                                      "nullable": true
                                    },
                                    "managedIdentities": {
                                      "$ref": "#/definitions/managedIdentityAllType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The managed identity definition for this resource."
                                      }
                                    },
                                    "enableTelemetry": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                      }
                                    },
                                    "deployments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/deploymentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Array of deployments about cognitive service accounts to create."
                                      }
                                    },
                                    "secretsExportConfiguration": {
                                      "$ref": "#/definitions/secretsExportConfigurationType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Key vault reference and secret settings for the module's secrets export."
                                      }
                                    },
                                    "allowProjectManagement": {
                                      "type": "bool",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Enable/Disable project management feature for AI Foundry."
                                      }
                                    },
                                    "commitmentPlans": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/commitmentPlanType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Commitment plans to deploy for the cognitive services account."
                                      }
                                    }
                                  },
                                  "variables": {
                                    "copy": [
                                      {
                                        "name": "formattedRoleAssignments",
                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                      }
                                    ],
                                    "enableReferencedModulesTelemetry": false,
                                    "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
                                    "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', if(coalesce(tryGet(parameters('managedIdentities'), 'systemAssigned'), false()), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'SystemAssigned, UserAssigned', 'SystemAssigned'), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'UserAssigned', null())), 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
                                    "builtInRoleNames": {
                                      "Cognitive Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68')]",
                                      "Cognitive Services Custom Vision Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c1ff6cc2-c111-46fe-8896-e0ef812ad9f3')]",
                                      "Cognitive Services Custom Vision Deployment": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5c4089e1-6d96-4d2f-b296-c1bc7137275f')]",
                                      "Cognitive Services Custom Vision Labeler": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '88424f51-ebe7-446f-bc41-7fa16989e96c')]",
                                      "Cognitive Services Custom Vision Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '93586559-c37d-4a6b-ba08-b9f0940c2d73')]",
                                      "Cognitive Services Custom Vision Trainer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0a5ae4ab-0d65-4eeb-be61-29fc9b54394b')]",
                                      "Cognitive Services Data Reader (Preview)": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b59867f0-fa02-499b-be73-45a86b5b3e1c')]",
                                      "Cognitive Services Face Recognizer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '9894cab4-e18a-44aa-828b-cb588cd6f2d7')]",
                                      "Cognitive Services Immersive Reader User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b2de6794-95db-4659-8781-7e080d3f2b9d')]",
                                      "Cognitive Services Language Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f07febfe-79bc-46b1-8b37-790e26e6e498')]",
                                      "Cognitive Services Language Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7628b7b8-a8b2-4cdc-b46f-e9b35248918e')]",
                                      "Cognitive Services Language Writer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f2310ca1-dc64-4889-bb49-c8e0fa3d47a8')]",
                                      "Cognitive Services LUIS Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f72c8140-2111-481c-87ff-72b910f6e3f8')]",
                                      "Cognitive Services LUIS Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18e81cdc-4e98-4e29-a639-e7d10c5a6226')]",
                                      "Cognitive Services LUIS Writer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '6322a993-d5c9-4bed-b113-e49bbea25b27')]",
                                      "Cognitive Services Metrics Advisor Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'cb43c632-a144-4ec5-977c-e80c4affc34a')]",
                                      "Cognitive Services Metrics Advisor User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3b20f47b-3825-43cb-8114-4bd2201156a8')]",
                                      "Cognitive Services OpenAI Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a001fd3d-188f-4b5d-821b-7da978bf7442')]",
                                      "Cognitive Services OpenAI User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5e0bd9bd-7b93-4f28-af87-19fc36ad61bd')]",
                                      "Cognitive Services QnA Maker Editor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f4cc2bf9-21be-47a1-bdf1-5c5804381025')]",
                                      "Cognitive Services QnA Maker Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '466ccd10-b268-4a11-b098-b4849f024126')]",
                                      "Cognitive Services Speech Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0e75ca1e-0464-4b4d-8b93-68208a576181')]",
                                      "Cognitive Services Speech User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f2dc8367-1007-4938-bd23-fe263f013447')]",
                                      "Cognitive Services User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
                                      "Azure AI Developer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '64702f94-c441-49e6-a78b-ef80e0188fee')]",
                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                    }
                                  },
                                  "resources": {
                                    "cMKKeyVault::cMKKey": {
                                      "condition": "[and(not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'))), and(not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'))), not(empty(tryGet(parameters('customerManagedKey'), 'keyName')))))]",
                                      "existing": true,
                                      "type": "Microsoft.KeyVault/vaults/keys",
                                      "apiVersion": "2024-11-01",
                                      "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[4]]",
                                      "name": "[format('{0}/{1}', last(split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')), tryGet(parameters('customerManagedKey'), 'keyName'))]"
                                    },
                                    "avmTelemetry": {
                                      "condition": "[parameters('enableTelemetry')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2024-03-01",
                                      "name": "[format('46d3xbcp.res.cognitiveservices-account.{0}.{1}', replace('0.13.2', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                      "properties": {
                                        "mode": "Incremental",
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "resources": [],
                                          "outputs": {
                                            "telemetry": {
                                              "type": "String",
                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "cMKKeyVault": {
                                      "condition": "[not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId')))]",
                                      "existing": true,
                                      "type": "Microsoft.KeyVault/vaults",
                                      "apiVersion": "2024-11-01",
                                      "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[4]]",
                                      "name": "[last(split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/'))]"
                                    },
                                    "cMKUserAssignedIdentity": {
                                      "condition": "[not(empty(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId')))]",
                                      "existing": true,
                                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                                      "apiVersion": "2025-01-31-preview",
                                      "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/')[4]]",
                                      "name": "[last(split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/'))]"
                                    },
                                    "cognitiveService": {
                                      "type": "Microsoft.CognitiveServices/accounts",
                                      "apiVersion": "2025-06-01",
                                      "name": "[parameters('name')]",
                                      "kind": "[parameters('kind')]",
                                      "identity": "[variables('identity')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "sku": {
                                        "name": "[parameters('sku')]"
                                      },
                                      "properties": {
                                        "allowProjectManagement": "[parameters('allowProjectManagement')]",
                                        "customSubDomainName": "[parameters('customSubDomainName')]",
                                        "networkAcls": "[if(not(empty(coalesce(parameters('networkAcls'), createObject()))), createObject('defaultAction', tryGet(parameters('networkAcls'), 'defaultAction'), 'virtualNetworkRules', coalesce(tryGet(parameters('networkAcls'), 'virtualNetworkRules'), createArray()), 'ipRules', coalesce(tryGet(parameters('networkAcls'), 'ipRules'), createArray())), null())]",
                                        "networkInjections": "[if(not(empty(parameters('networkInjections'))), createArray(createObject('scenario', tryGet(parameters('networkInjections'), 'scenario'), 'subnetArmId', tryGet(parameters('networkInjections'), 'subnetResourceId'), 'useMicrosoftManagedNetwork', coalesce(tryGet(parameters('networkInjections'), 'useMicrosoftManagedNetwork'), false()))), null())]",
                                        "publicNetworkAccess": "[if(not(equals(parameters('publicNetworkAccess'), null())), parameters('publicNetworkAccess'), if(not(empty(parameters('networkAcls'))), 'Enabled', 'Disabled'))]",
                                        "allowedFqdnList": "[parameters('allowedFqdnList')]",
                                        "apiProperties": "[parameters('apiProperties')]",
                                        "disableLocalAuth": "[parameters('disableLocalAuth')]",
                                        "encryption": "[if(not(empty(parameters('customerManagedKey'))), createObject('keySource', 'Microsoft.KeyVault', 'keyVaultProperties', createObject('identityClientId', if(not(empty(coalesce(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), ''))), reference('cMKUserAssignedIdentity').clientId, null()), 'keyVaultUri', reference('cMKKeyVault').vaultUri, 'keyName', parameters('customerManagedKey').keyName, 'keyVersion', if(not(empty(coalesce(tryGet(parameters('customerManagedKey'), 'keyVersion'), ''))), tryGet(parameters('customerManagedKey'), 'keyVersion'), last(split(reference('cMKKeyVault::cMKKey').keyUriWithVersion, '/'))))), null())]",
                                        "migrationToken": "[parameters('migrationToken')]",
                                        "restore": "[parameters('restore')]",
                                        "restrictOutboundNetworkAccess": "[parameters('restrictOutboundNetworkAccess')]",
                                        "userOwnedStorage": "[if(not(empty(parameters('userOwnedStorage'))), parameters('userOwnedStorage'), null())]",
                                        "dynamicThrottlingEnabled": "[parameters('dynamicThrottlingEnabled')]"
                                      },
                                      "dependsOn": [
                                        "cMKKeyVault",
                                        "cMKKeyVault::cMKKey",
                                        "cMKUserAssignedIdentity"
                                      ]
                                    },
                                    "cognitiveService_deployments": {
                                      "copy": {
                                        "name": "cognitiveService_deployments",
                                        "count": "[length(coalesce(parameters('deployments'), createArray()))]",
                                        "mode": "serial",
                                        "batchSize": 1
                                      },
                                      "type": "Microsoft.CognitiveServices/accounts/deployments",
                                      "apiVersion": "2025-06-01",
                                      "name": "[format('{0}/{1}', parameters('name'), coalesce(tryGet(coalesce(parameters('deployments'), createArray())[copyIndex()], 'name'), format('{0}-deployments', parameters('name'))))]",
                                      "properties": {
                                        "model": "[coalesce(parameters('deployments'), createArray())[copyIndex()].model]",
                                        "raiPolicyName": "[tryGet(coalesce(parameters('deployments'), createArray())[copyIndex()], 'raiPolicyName')]",
                                        "versionUpgradeOption": "[tryGet(coalesce(parameters('deployments'), createArray())[copyIndex()], 'versionUpgradeOption')]"
                                      },
                                      "sku": "[coalesce(tryGet(coalesce(parameters('deployments'), createArray())[copyIndex()], 'sku'), createObject('name', parameters('sku'), 'capacity', tryGet(parameters('sku'), 'capacity'), 'tier', tryGet(parameters('sku'), 'tier'), 'size', tryGet(parameters('sku'), 'size'), 'family', tryGet(parameters('sku'), 'family')))]",
                                      "dependsOn": [
                                        "cognitiveService"
                                      ]
                                    },
                                    "cognitiveService_lock": {
                                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                      "type": "Microsoft.Authorization/locks",
                                      "apiVersion": "2020-05-01",
                                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                      "properties": {
                                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                        "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                                      },
                                      "dependsOn": [
                                        "cognitiveService"
                                      ]
                                    },
                                    "cognitiveService_commitmentPlans": {
                                      "copy": {
                                        "name": "cognitiveService_commitmentPlans",
                                        "count": "[length(coalesce(parameters('commitmentPlans'), createArray()))]"
                                      },
                                      "type": "Microsoft.CognitiveServices/accounts/commitmentPlans",
                                      "apiVersion": "2025-06-01",
                                      "name": "[format('{0}/{1}', parameters('name'), format('{0}-{1}', coalesce(parameters('commitmentPlans'), createArray())[copyIndex()].hostingModel, coalesce(parameters('commitmentPlans'), createArray())[copyIndex()].planType))]",
                                      "properties": "[coalesce(parameters('commitmentPlans'), createArray())[copyIndex()]]",
                                      "dependsOn": [
                                        "cognitiveService"
                                      ]
                                    },
                                    "cognitiveService_diagnosticSettings": {
                                      "copy": {
                                        "name": "cognitiveService_diagnosticSettings",
                                        "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                      },
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                                      "properties": {
                                        "copy": [
                                          {
                                            "name": "metrics",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                            "input": {
                                              "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                              "timeGrain": null
                                            }
                                          },
                                          {
                                            "name": "logs",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                            "input": {
                                              "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                              "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                            }
                                          }
                                        ],
                                        "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                        "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                        "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                        "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                        "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                        "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                      },
                                      "dependsOn": [
                                        "cognitiveService"
                                      ]
                                    },
                                    "cognitiveService_roleAssignments": {
                                      "copy": {
                                        "name": "cognitiveService_roleAssignments",
                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                      "properties": {
                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                      },
                                      "dependsOn": [
                                        "cognitiveService"
                                      ]
                                    },
                                    "cognitiveService_privateEndpoints": {
                                      "copy": {
                                        "name": "cognitiveService_privateEndpoints",
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-cognitiveService-PrivateEndpoint-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "subscriptionId": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[2]]",
                                      "resourceGroup": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'name'), format('pep-{0}-{1}-{2}', last(split(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'account'), copyIndex()))]"
                                          },
                                          "privateLinkServiceConnections": "[if(not(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true())), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'account'), copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), 'groupIds', createArray(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'account')))))), createObject('value', null()))]",
                                          "manualPrivateLinkServiceConnections": "[if(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true()), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'account'), copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), 'groupIds', createArray(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'account')), 'requestMessage', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'manualConnectionRequestMessage'), 'Manual approval required.'))))), createObject('value', null()))]",
                                          "subnetResourceId": {
                                            "value": "[coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          },
                                          "location": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'location'), reference(split(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                                          },
                                          "lock": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'lock'), parameters('lock'))]"
                                          },
                                          "privateDnsZoneGroup": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateDnsZoneGroup')]"
                                          },
                                          "roleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'roleAssignments')]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "customDnsConfigs": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customDnsConfigs')]"
                                          },
                                          "ipConfigurations": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'ipConfigurations')]"
                                          },
                                          "applicationSecurityGroupResourceIds": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'applicationSecurityGroupResourceIds')]"
                                          },
                                          "customNetworkInterfaceName": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customNetworkInterfaceName')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.34.44.8038",
                                              "templateHash": "12389807800450456797"
                                            },
                                            "name": "Private Endpoints",
                                            "description": "This module deploys a Private Endpoint."
                                          },
                                          "definitions": {
                                            "privateDnsZoneGroupType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the Private DNS Zone Group."
                                                  }
                                                },
                                                "privateDnsZoneGroupConfigs": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. The private DNS zone groups to associate the private endpoint. A DNS zone group can support up to 5 DNS zones."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "ipConfigurationType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the resource that is unique within a resource group."
                                                  }
                                                },
                                                "properties": {
                                                  "type": "object",
                                                  "properties": {
                                                    "groupId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string."
                                                      }
                                                    },
                                                    "memberName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string."
                                                      }
                                                    },
                                                    "privateIPAddress": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                                      }
                                                    }
                                                  },
                                                  "metadata": {
                                                    "description": "Required. Properties of private endpoint IP configurations."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "privateLinkServiceConnectionType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the private link service connection."
                                                  }
                                                },
                                                "properties": {
                                                  "type": "object",
                                                  "properties": {
                                                    "groupIds": {
                                                      "type": "array",
                                                      "items": {
                                                        "type": "string"
                                                      },
                                                      "metadata": {
                                                        "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string array `[]`."
                                                      }
                                                    },
                                                    "privateLinkServiceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The resource id of private link service."
                                                      }
                                                    },
                                                    "requestMessage": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. A message passed to the owner of the remote resource with this connection request. Restricted to 140 chars."
                                                      }
                                                    }
                                                  },
                                                  "metadata": {
                                                    "description": "Required. Properties of private link service connection."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "customDnsConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "fqdn": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. FQDN that resolves to private endpoint IP address."
                                                  }
                                                },
                                                "ipAddresses": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of private IP addresses of the private endpoint."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "lockType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the name of lock."
                                                  }
                                                },
                                                "kind": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "CanNotDelete",
                                                    "None",
                                                    "ReadOnly"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the type of lock."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a lock.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            },
                                            "privateDnsZoneGroupConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the private DNS zone group config."
                                                  }
                                                },
                                                "privateDnsZoneResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The resource id of the private DNS zone."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "private-dns-zone-group/main.bicep"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the private endpoint resource to create."
                                              }
                                            },
                                            "subnetResourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                              }
                                            },
                                            "applicationSecurityGroupResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                              }
                                            },
                                            "customNetworkInterfaceName": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                              }
                                            },
                                            "ipConfigurations": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/ipConfigurationType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                              }
                                            },
                                            "privateDnsZoneGroup": {
                                              "$ref": "#/definitions/privateDnsZoneGroupType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The private DNS zone group to configure for the private endpoint."
                                              }
                                            },
                                            "location": {
                                              "type": "string",
                                              "defaultValue": "[resourceGroup().location]",
                                              "metadata": {
                                                "description": "Optional. Location for all Resources."
                                              }
                                            },
                                            "lock": {
                                              "$ref": "#/definitions/lockType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The lock settings of the service."
                                              }
                                            },
                                            "roleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/roleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of role assignments to create."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                              }
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/customDnsConfigType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Custom DNS configurations."
                                              }
                                            },
                                            "manualPrivateLinkServiceConnections": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/privateLinkServiceConnectionType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Used when the network admin does not have access to approve connections to the remote resource. Required if `privateLinkServiceConnections` is empty."
                                              }
                                            },
                                            "privateLinkServiceConnections": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/privateLinkServiceConnectionType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Required if `manualPrivateLinkServiceConnections` is empty."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "formattedRoleAssignments",
                                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                              }
                                            ],
                                            "builtInRoleNames": {
                                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                              "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                                              "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                                              "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                                              "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                                              "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                              "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.network-privateendpoint.{0}.{1}', replace('0.11.0', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "privateEndpoint": {
                                              "type": "Microsoft.Network/privateEndpoints",
                                              "apiVersion": "2024-05-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "applicationSecurityGroups",
                                                    "count": "[length(coalesce(parameters('applicationSecurityGroupResourceIds'), createArray()))]",
                                                    "input": {
                                                      "id": "[coalesce(parameters('applicationSecurityGroupResourceIds'), createArray())[copyIndex('applicationSecurityGroups')]]"
                                                    }
                                                  }
                                                ],
                                                "customDnsConfigs": "[coalesce(parameters('customDnsConfigs'), createArray())]",
                                                "customNetworkInterfaceName": "[coalesce(parameters('customNetworkInterfaceName'), '')]",
                                                "ipConfigurations": "[coalesce(parameters('ipConfigurations'), createArray())]",
                                                "manualPrivateLinkServiceConnections": "[coalesce(parameters('manualPrivateLinkServiceConnections'), createArray())]",
                                                "privateLinkServiceConnections": "[coalesce(parameters('privateLinkServiceConnections'), createArray())]",
                                                "subnet": {
                                                  "id": "[parameters('subnetResourceId')]"
                                                }
                                              }
                                            },
                                            "privateEndpoint_lock": {
                                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                              "type": "Microsoft.Authorization/locks",
                                              "apiVersion": "2020-05-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                              "properties": {
                                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                                "notes": "[if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_roleAssignments": {
                                              "copy": {
                                                "name": "privateEndpoint_roleAssignments",
                                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2022-04-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                              "properties": {
                                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_privateDnsZoneGroup": {
                                              "condition": "[not(empty(parameters('privateDnsZoneGroup')))]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2022-09-01",
                                              "name": "[format('{0}-PrivateEndpoint-PrivateDnsZoneGroup', uniqueString(deployment().name))]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[tryGet(parameters('privateDnsZoneGroup'), 'name')]"
                                                  },
                                                  "privateEndpointName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "privateDnsZoneConfigs": {
                                                    "value": "[parameters('privateDnsZoneGroup').privateDnsZoneGroupConfigs]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.34.44.8038",
                                                      "templateHash": "13997305779829540948"
                                                    },
                                                    "name": "Private Endpoint Private DNS Zone Groups",
                                                    "description": "This module deploys a Private Endpoint Private DNS Zone Group."
                                                  },
                                                  "definitions": {
                                                    "privateDnsZoneGroupConfigType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name of the private DNS zone group config."
                                                          }
                                                        },
                                                        "privateDnsZoneResourceId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The resource id of the private DNS zone."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "privateEndpointName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "privateDnsZoneConfigs": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                      },
                                                      "minLength": 1,
                                                      "maxLength": 5,
                                                      "metadata": {
                                                        "description": "Required. Array of private DNS zone configurations of the private DNS zone group. A DNS zone group can support up to 5 DNS zones."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "defaultValue": "default",
                                                      "metadata": {
                                                        "description": "Optional. The name of the private DNS zone group."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "privateDnsZoneConfigsVar",
                                                        "count": "[length(parameters('privateDnsZoneConfigs'))]",
                                                        "input": {
                                                          "name": "[coalesce(tryGet(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')], 'name'), last(split(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')].privateDnsZoneResourceId, '/')))]",
                                                          "properties": {
                                                            "privateDnsZoneId": "[parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')].privateDnsZoneResourceId]"
                                                          }
                                                        }
                                                      }
                                                    ]
                                                  },
                                                  "resources": {
                                                    "privateEndpoint": {
                                                      "existing": true,
                                                      "type": "Microsoft.Network/privateEndpoints",
                                                      "apiVersion": "2024-05-01",
                                                      "name": "[parameters('privateEndpointName')]"
                                                    },
                                                    "privateDnsZoneGroup": {
                                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                                      "apiVersion": "2024-05-01",
                                                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                                      "properties": {
                                                        "privateDnsZoneConfigs": "[variables('privateDnsZoneConfigsVar')]"
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group the private endpoint DNS zone group was deployed into."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group the private endpoint was deployed into."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the private endpoint."
                                              },
                                              "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the private endpoint."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "location": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The location the resource was deployed into."
                                              },
                                              "value": "[reference('privateEndpoint', '2024-05-01', 'full').location]"
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/customDnsConfigType"
                                              },
                                              "metadata": {
                                                "description": "The custom DNS configurations of the private endpoint."
                                              },
                                              "value": "[reference('privateEndpoint').customDnsConfigs]"
                                            },
                                            "networkInterfaceResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "metadata": {
                                                "description": "The resource IDs of the network interfaces associated with the private endpoint."
                                              },
                                              "value": "[map(reference('privateEndpoint').networkInterfaces, lambda('nic', lambdaVariables('nic').id))]"
                                            },
                                            "groupId": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "The group Id for the private endpoint Group."
                                              },
                                              "value": "[coalesce(tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'manualPrivateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0), tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'privateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "cognitiveService"
                                      ]
                                    },
                                    "secretsExport": {
                                      "condition": "[not(equals(parameters('secretsExportConfiguration'), null()))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-secrets-kv', uniqueString(deployment().name, parameters('location')))]",
                                      "subscriptionId": "[split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "keyVaultName": {
                                            "value": "[last(split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/'))]"
                                          },
                                          "secretsToSet": {
                                            "value": "[union(createArray(), if(contains(parameters('secretsExportConfiguration'), 'accessKey1Name'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'accessKey1Name'), 'value', listKeys('cognitiveService', '2025-06-01').key1)), createArray()), if(contains(parameters('secretsExportConfiguration'), 'accessKey2Name'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'accessKey2Name'), 'value', listKeys('cognitiveService', '2025-06-01').key2)), createArray()))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.37.4.10188",
                                              "templateHash": "10828079590669389085"
                                            }
                                          },
                                          "definitions": {
                                            "secretSetOutputType": {
                                              "type": "object",
                                              "properties": {
                                                "secretResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The resourceId of the exported secret."
                                                  }
                                                },
                                                "secretUri": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The secret URI of the exported secret."
                                                  }
                                                },
                                                "secretUriWithVersion": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The secret URI with version of the exported secret."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for the output of the secret set via the secrets export feature.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            },
                                            "secretToSetType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the secret to set."
                                                  }
                                                },
                                                "value": {
                                                  "type": "securestring",
                                                  "metadata": {
                                                    "description": "Required. The value of the secret to set."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for the secret to set via the secrets export feature.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "keyVaultName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of the Key Vault to set the ecrets in."
                                              }
                                            },
                                            "secretsToSet": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/secretToSetType"
                                              },
                                              "metadata": {
                                                "description": "Required. The secrets to set in the Key Vault."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "keyVault": {
                                              "existing": true,
                                              "type": "Microsoft.KeyVault/vaults",
                                              "apiVersion": "2024-11-01",
                                              "name": "[parameters('keyVaultName')]"
                                            },
                                            "secrets": {
                                              "copy": {
                                                "name": "secrets",
                                                "count": "[length(parameters('secretsToSet'))]"
                                              },
                                              "type": "Microsoft.KeyVault/vaults/secrets",
                                              "apiVersion": "2024-11-01",
                                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretsToSet')[copyIndex()].name)]",
                                              "properties": {
                                                "value": "[parameters('secretsToSet')[copyIndex()].value]"
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "secretsSet": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/secretSetOutputType"
                                              },
                                              "metadata": {
                                                "description": "The references to the secrets exported to the provided Key Vault."
                                              },
                                              "copy": {
                                                "count": "[length(range(0, length(coalesce(parameters('secretsToSet'), createArray()))))]",
                                                "input": {
                                                  "secretResourceId": "[resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretsToSet')[range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()]].name)]",
                                                  "secretUri": "[reference(format('secrets[{0}]', range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()])).secretUri]",
                                                  "secretUriWithVersion": "[reference(format('secrets[{0}]', range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()])).secretUriWithVersion]"
                                                }
                                              }
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "cognitiveService"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the cognitive services account."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the cognitive services account."
                                      },
                                      "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource group the cognitive services account was deployed into."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "endpoint": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The service endpoint of the cognitive services account."
                                      },
                                      "value": "[reference('cognitiveService').endpoint]"
                                    },
                                    "endpoints": {
                                      "$ref": "#/definitions/endpointType",
                                      "metadata": {
                                        "description": "All endpoints available for the cognitive services account, types depends on the cognitive service kind."
                                      },
                                      "value": "[reference('cognitiveService').endpoints]"
                                    },
                                    "systemAssignedMIPrincipalId": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "The principal ID of the system assigned identity."
                                      },
                                      "value": "[tryGet(tryGet(reference('cognitiveService', '2025-06-01', 'full'), 'identity'), 'principalId')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('cognitiveService', '2025-06-01', 'full').location]"
                                    },
                                    "exportedSecrets": {
                                      "$ref": "#/definitions/secretsOutputType",
                                      "metadata": {
                                        "description": "A hashtable of references to the secrets exported to the provided Key Vault. The key of each reference is each secret's name."
                                      },
                                      "value": "[if(not(equals(parameters('secretsExportConfiguration'), null())), toObject(reference('secretsExport').outputs.secretsSet.value, lambda('secret', last(split(lambdaVariables('secret').secretResourceId, '/'))), lambda('secret', lambdaVariables('secret'))), createObject())]"
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointOutputType"
                                      },
                                      "metadata": {
                                        "description": "The private endpoints of the congitive services account."
                                      },
                                      "copy": {
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]",
                                        "input": {
                                          "name": "[reference(format('cognitiveService_privateEndpoints[{0}]', copyIndex())).outputs.name.value]",
                                          "resourceId": "[reference(format('cognitiveService_privateEndpoints[{0}]', copyIndex())).outputs.resourceId.value]",
                                          "groupId": "[tryGet(tryGet(reference(format('cognitiveService_privateEndpoints[{0}]', copyIndex())).outputs, 'groupId'), 'value')]",
                                          "customDnsConfigs": "[reference(format('cognitiveService_privateEndpoints[{0}]', copyIndex())).outputs.customDnsConfigs.value]",
                                          "networkInterfaceResourceIds": "[reference(format('cognitiveService_privateEndpoints[{0}]', copyIndex())).outputs.networkInterfaceResourceIds.value]"
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Name of the AI Foundry resource."
                              },
                              "value": "[reference('foundryAccount').outputs.name.value]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource ID of the AI Foundry resource."
                              },
                              "value": "[reference('foundryAccount').outputs.resourceId.value]"
                            },
                            "subscriptionId": {
                              "type": "string",
                              "metadata": {
                                "description": "Subscription ID of the AI Foundry resource."
                              },
                              "value": "[subscription().subscriptionId]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource Group Name of the AI Foundry resource."
                              },
                              "value": "[resourceGroup().name]"
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Location of the AI Foundry resource."
                              },
                              "value": "[parameters('location')]"
                            },
                            "systemAssignedMIPrincipalId": {
                              "type": "string",
                              "metadata": {
                                "description": "System assigned managed identity principal ID of the AI Foundry resource."
                              },
                              "value": "[reference('foundryAccount').outputs.systemAssignedMIPrincipalId.value]"
                            }
                          }
                        }
                      }
                    },
                    "keyVault": {
                      "condition": "[parameters('includeAssociatedResources')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[take(format('module.keyVault.{0}', variables('resourcesName')), 64)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "existingResourceId": {
                            "value": "[tryGet(parameters('keyVaultConfiguration'), 'existingResourceId')]"
                          },
                          "name": {
                            "value": "[take(if(and(not(empty(parameters('keyVaultConfiguration'))), not(empty(tryGet(parameters('keyVaultConfiguration'), 'name')))), parameters('keyVaultConfiguration').name, format('kv{0}', variables('resourcesName'))), 24)]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "enableTelemetry": {
                            "value": "[parameters('enableTelemetry')]"
                          },
                          "privateEndpointSubnetResourceId": {
                            "value": "[parameters('privateEndpointSubnetResourceId')]"
                          },
                          "privateDnsZoneResourceId": {
                            "value": "[tryGet(parameters('keyVaultConfiguration'), 'privateDnsZoneResourceId')]"
                          },
                          "roleAssignments": {
                            "value": "[tryGet(parameters('keyVaultConfiguration'), 'roleAssignments')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "10341613549995209032"
                            }
                          },
                          "definitions": {
                            "roleAssignmentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                  }
                                },
                                "roleDefinitionIdOrName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                  }
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                  }
                                },
                                "principalType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Device",
                                    "ForeignGroup",
                                    "Group",
                                    "ServicePrincipal",
                                    "User"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The principal type of the assigned principal ID."
                                  }
                                },
                                "description": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The description of the role assignment."
                                  }
                                },
                                "condition": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                  }
                                },
                                "conditionVersion": {
                                  "type": "string",
                                  "allowedValues": [
                                    "2.0"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Version of the condition."
                                  }
                                },
                                "delegatedManagedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a role assignment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                }
                              }
                            }
                          },
                          "functions": [
                            {
                              "namespace": "__bicep",
                              "members": {
                                "getResourceGroupName": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 4), parameters('parts')[4], resourceGroup().name)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Group Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceName": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    },
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(and(and(not(empty(parameters('resourceId'))), contains(parameters('resourceId'), '/')), not(empty(parameters('parts')))), last(parameters('parts')), coalesce(parameters('resourceId'), ''))]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceParts": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    }
                                  ],
                                  "output": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "value": "[split(coalesce(parameters('resourceId'), ''), '/')]"
                                  },
                                  "metadata": {
                                    "description": "Splits Resource ID into its components.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getSubscriptionId": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 2), parameters('parts')[2], subscription().subscriptionId)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Subscription ID from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                }
                              }
                            }
                          ],
                          "parameters": {
                            "name": {
                              "type": "string",
                              "maxLength": 24,
                              "metadata": {
                                "description": "Required. The name of the Key Vault."
                              }
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The location for the Key Vault."
                              }
                            },
                            "existingResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The full resource ID of an existing Key Vault to use instead of creating a new one."
                              }
                            },
                            "privateEndpointSubnetResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource Id of an existing subnet to use for private connectivity. This is required along with 'privateDnsZoneResourceId' to establish private endpoints."
                              }
                            },
                            "privateDnsZoneResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The resource ID of the private DNS zone for the Key Vault to establish private endpoints."
                              }
                            },
                            "roleAssignments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/roleAssignmentType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Specifies the role assignments for the Key Vault."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Resources/resourceGroups@2025-04-01#properties/tags"
                                },
                                "description": "Optional. Specifies the resource tags for all the resources."
                              },
                              "defaultValue": {}
                            }
                          },
                          "variables": {
                            "existingResourceParts": "[__bicep.getResourceParts(parameters('existingResourceId'))]",
                            "existingName": "[__bicep.getResourceName(parameters('existingResourceId'), variables('existingResourceParts'))]",
                            "existingSubscriptionId": "[__bicep.getSubscriptionId(variables('existingResourceParts'))]",
                            "existingResourceGroupName": "[__bicep.getResourceGroupName(variables('existingResourceParts'))]",
                            "privateNetworkingEnabled": "[and(not(empty(parameters('privateDnsZoneResourceId'))), not(empty(parameters('privateEndpointSubnetResourceId'))))]"
                          },
                          "resources": {
                            "existingKeyVault": {
                              "condition": "[not(empty(parameters('existingResourceId')))]",
                              "existing": true,
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2024-11-01",
                              "subscriptionId": "[variables('existingSubscriptionId')]",
                              "resourceGroup": "[variables('existingResourceGroupName')]",
                              "name": "[variables('existingName')]"
                            },
                            "keyVault": {
                              "condition": "[empty(parameters('existingResourceId'))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('avm.res.key-vault.vault.{0}', parameters('name')), 64)]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[parameters('name')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "enableTelemetry": {
                                    "value": "[parameters('enableTelemetry')]"
                                  },
                                  "publicNetworkAccess": "[if(variables('privateNetworkingEnabled'), createObject('value', 'Disabled'), createObject('value', 'Enabled'))]",
                                  "networkAcls": {
                                    "value": {
                                      "defaultAction": "[if(variables('privateNetworkingEnabled'), 'Deny', 'Allow')]"
                                    }
                                  },
                                  "enableVaultForDeployment": {
                                    "value": true
                                  },
                                  "enableVaultForDiskEncryption": {
                                    "value": true
                                  },
                                  "enableVaultForTemplateDeployment": {
                                    "value": true
                                  },
                                  "enablePurgeProtection": {
                                    "value": false
                                  },
                                  "enableRbacAuthorization": {
                                    "value": true
                                  },
                                  "enableSoftDelete": {
                                    "value": true
                                  },
                                  "softDeleteRetentionInDays": {
                                    "value": 7
                                  },
                                  "privateEndpoints": "[if(variables('privateNetworkingEnabled'), createObject('value', createArray(createObject('privateDnsZoneGroup', createObject('privateDnsZoneGroupConfigs', createArray(createObject('privateDnsZoneResourceId', parameters('privateDnsZoneResourceId')))), 'service', 'vault', 'subnetResourceId', parameters('privateEndpointSubnetResourceId')))), createObject('value', createArray()))]",
                                  "roleAssignments": {
                                    "value": "[parameters('roleAssignments')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.37.4.10188",
                                      "templateHash": "8811577289487069918"
                                    },
                                    "name": "Key Vaults",
                                    "description": "This module deploys a Key Vault."
                                  },
                                  "definitions": {
                                    "networkAclsType": {
                                      "type": "object",
                                      "properties": {
                                        "bypass": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureServices",
                                            "None"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The bypass options for traffic for the network ACLs."
                                          }
                                        },
                                        "defaultAction": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Allow",
                                            "Deny"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The default action for the network ACLs, when no rule matches."
                                          }
                                        },
                                        "ipRules": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "value": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. An IPv4 address range in CIDR notation, such as \"124.56.78.91\" (simple IP address) or \"124.56.78.0/24\"."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of IP rules."
                                          }
                                        },
                                        "virtualNetworkRules": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "id": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource ID of the virtual network subnet."
                                                }
                                              },
                                              "ignoreMissingVnetServiceEndpoint": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Whether NRP will ignore the check if parent subnet has serviceEndpoints configured."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of virtual network rules."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for rules governing the accessibility of the key vault from specific network locations."
                                      }
                                    },
                                    "privateEndpointOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the private endpoint."
                                          }
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the private endpoint."
                                          }
                                        },
                                        "groupId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "The group Id for the private endpoint Group."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "fqdn": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "FQDN that resolves to private endpoint IP address."
                                                }
                                              },
                                              "ipAddresses": {
                                                "type": "array",
                                                "items": {
                                                  "type": "string"
                                                },
                                                "metadata": {
                                                  "description": "A list of private IP addresses of the private endpoint."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "The custom DNS configurations of the private endpoint."
                                          }
                                        },
                                        "networkInterfaceResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "The IDs of the network interfaces associated with the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true
                                      }
                                    },
                                    "credentialOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The item's resourceId."
                                          }
                                        },
                                        "uri": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The item's uri."
                                          }
                                        },
                                        "uriWithVersion": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The item's uri with version."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a credential output."
                                      }
                                    },
                                    "accessPolicyType": {
                                      "type": "object",
                                      "properties": {
                                        "tenantId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The tenant ID that is used for authenticating requests to the key vault."
                                          }
                                        },
                                        "objectId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The object ID of a user, service principal or security group in the tenant for the vault."
                                          }
                                        },
                                        "applicationId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Application ID of the client making request on behalf of a principal."
                                          }
                                        },
                                        "permissions": {
                                          "type": "object",
                                          "properties": {
                                            "keys": {
                                              "type": "array",
                                              "allowedValues": [
                                                "all",
                                                "backup",
                                                "create",
                                                "decrypt",
                                                "delete",
                                                "encrypt",
                                                "get",
                                                "getrotationpolicy",
                                                "import",
                                                "list",
                                                "purge",
                                                "recover",
                                                "release",
                                                "restore",
                                                "rotate",
                                                "setrotationpolicy",
                                                "sign",
                                                "unwrapKey",
                                                "update",
                                                "verify",
                                                "wrapKey"
                                              ],
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Permissions to keys."
                                              }
                                            },
                                            "secrets": {
                                              "type": "array",
                                              "allowedValues": [
                                                "all",
                                                "backup",
                                                "delete",
                                                "get",
                                                "list",
                                                "purge",
                                                "recover",
                                                "restore",
                                                "set"
                                              ],
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Permissions to secrets."
                                              }
                                            },
                                            "certificates": {
                                              "type": "array",
                                              "allowedValues": [
                                                "all",
                                                "backup",
                                                "create",
                                                "delete",
                                                "deleteissuers",
                                                "get",
                                                "getissuers",
                                                "import",
                                                "list",
                                                "listissuers",
                                                "managecontacts",
                                                "manageissuers",
                                                "purge",
                                                "recover",
                                                "restore",
                                                "setissuers",
                                                "update"
                                              ],
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Permissions to certificates."
                                              }
                                            },
                                            "storage": {
                                              "type": "array",
                                              "allowedValues": [
                                                "all",
                                                "backup",
                                                "delete",
                                                "deletesas",
                                                "get",
                                                "getsas",
                                                "list",
                                                "listsas",
                                                "purge",
                                                "recover",
                                                "regeneratekey",
                                                "restore",
                                                "set",
                                                "setsas",
                                                "update"
                                              ],
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Permissions to storage accounts."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Permissions the identity has for keys, secrets and certificates."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for an access policy."
                                      }
                                    },
                                    "secretType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the secret."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource tags."
                                          }
                                        },
                                        "attributes": {
                                          "type": "object",
                                          "properties": {
                                            "enabled": {
                                              "type": "bool",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Defines whether the secret is enabled or disabled."
                                              }
                                            },
                                            "exp": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Defines when the secret will become invalid. Defined in seconds since 1970-01-01T00:00:00Z."
                                              }
                                            },
                                            "nbf": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. If set, defines the date from which onwards the secret becomes valid. Defined in seconds since 1970-01-01T00:00:00Z."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Contains attributes of the secret."
                                          }
                                        },
                                        "contentType": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The content type of the secret."
                                          }
                                        },
                                        "value": {
                                          "type": "securestring",
                                          "metadata": {
                                            "description": "Required. The value of the secret. NOTE: \"value\" will never be returned from the service, as APIs using this model are is intended for internal use in ARM deployments. Users should use the data-plane REST service for interaction with vault secrets."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a secret output."
                                      }
                                    },
                                    "keyType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the key."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource tags."
                                          }
                                        },
                                        "attributes": {
                                          "type": "object",
                                          "properties": {
                                            "enabled": {
                                              "type": "bool",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Defines whether the key is enabled or disabled."
                                              }
                                            },
                                            "exp": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Defines when the key will become invalid. Defined in seconds since 1970-01-01T00:00:00Z."
                                              }
                                            },
                                            "nbf": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. If set, defines the date from which onwards the key becomes valid. Defined in seconds since 1970-01-01T00:00:00Z."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Contains attributes of the key."
                                          }
                                        },
                                        "curveName": {
                                          "type": "string",
                                          "allowedValues": [
                                            "P-256",
                                            "P-256K",
                                            "P-384",
                                            "P-521"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The elliptic curve name. Only works if \"keySize\" equals \"EC\" or \"EC-HSM\". Default is \"P-256\"."
                                          }
                                        },
                                        "keyOps": {
                                          "type": "array",
                                          "allowedValues": [
                                            "decrypt",
                                            "encrypt",
                                            "import",
                                            "release",
                                            "sign",
                                            "unwrapKey",
                                            "verify",
                                            "wrapKey"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The allowed operations on this key."
                                          }
                                        },
                                        "keySize": {
                                          "type": "int",
                                          "allowedValues": [
                                            2048,
                                            3072,
                                            4096
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The key size in bits. Only works if \"keySize\" equals \"RSA\" or \"RSA-HSM\". Default is \"4096\"."
                                          }
                                        },
                                        "kty": {
                                          "type": "string",
                                          "allowedValues": [
                                            "EC",
                                            "EC-HSM",
                                            "RSA",
                                            "RSA-HSM"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The type of the key. Default is \"EC\"."
                                          }
                                        },
                                        "releasePolicy": {
                                          "type": "object",
                                          "properties": {
                                            "contentType": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Content type and version of key release policy."
                                              }
                                            },
                                            "data": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Blob encoding the policy rules under which the key can be released."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Key release policy."
                                          }
                                        },
                                        "rotationPolicy": {
                                          "$ref": "#/definitions/rotationPolicyType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Key rotation policy."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a key."
                                      }
                                    },
                                    "_1.privateEndpointCustomDnsConfigType": {
                                      "type": "object",
                                      "properties": {
                                        "fqdn": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. FQDN that resolves to private endpoint IP address."
                                          }
                                        },
                                        "ipAddresses": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of private IP addresses of the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.privateEndpointIpConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the resource that is unique within a resource group."
                                          }
                                        },
                                        "properties": {
                                          "type": "object",
                                          "properties": {
                                            "groupId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "memberName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "privateIPAddress": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Properties of private endpoint IP configurations."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.privateEndpointPrivateDnsZoneGroupType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private DNS Zone Group."
                                          }
                                        },
                                        "privateDnsZoneGroupConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "name": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. The name of the private DNS Zone Group config."
                                                }
                                              },
                                              "privateDnsZoneResourceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource id of the private DNS zone."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. The private DNS Zone Groups to associate the Private Endpoint. A DNS Zone Group can support up to 5 DNS zones."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "diagnosticSettingFullType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the diagnostic setting."
                                          }
                                        },
                                        "logCategoriesAndGroups": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                }
                                              },
                                              "categoryGroup": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                          }
                                        },
                                        "metricCategories": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                          }
                                        },
                                        "logAnalyticsDestinationType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureDiagnostics",
                                            "Dedicated"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                          }
                                        },
                                        "workspaceResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "storageAccountResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "eventHubAuthorizationRuleResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                          }
                                        },
                                        "eventHubName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "marketplacePartnerResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "notes": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the notes of the lock."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a lock.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "privateEndpointSingleServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private Endpoint."
                                          }
                                        },
                                        "location": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The location to deploy the Private Endpoint to."
                                          }
                                        },
                                        "privateLinkServiceConnectionName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the private link connection to create."
                                          }
                                        },
                                        "service": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The subresource to deploy the Private Endpoint for. For example \"vault\" for a Key Vault Private Endpoint."
                                          }
                                        },
                                        "subnetResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                          }
                                        },
                                        "resourceGroupResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID of the Resource Group the Private Endpoint will be created in. If not specified, the Resource Group of the provided Virtual Network Subnet is used."
                                          }
                                        },
                                        "privateDnsZoneGroup": {
                                          "$ref": "#/definitions/_1.privateEndpointPrivateDnsZoneGroupType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The private DNS Zone Group to configure for the Private Endpoint."
                                          }
                                        },
                                        "isManualConnection": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. If Manual Private Link Connection is required."
                                          }
                                        },
                                        "manualConnectionRequestMessage": {
                                          "type": "string",
                                          "nullable": true,
                                          "maxLength": 140,
                                          "metadata": {
                                            "description": "Optional. A message passed to the owner of the remote resource with the manual connection request."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_1.privateEndpointCustomDnsConfigType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Custom DNS configurations."
                                          }
                                        },
                                        "ipConfigurations": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_1.privateEndpointIpConfigurationType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of IP configurations of the Private Endpoint. This will be used to map to the first-party Service endpoints."
                                          }
                                        },
                                        "applicationSecurityGroupResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Application security groups in which the Private Endpoint IP configuration is included."
                                          }
                                        },
                                        "customNetworkInterfaceName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The custom name of the network interface attached to the Private Endpoint."
                                          }
                                        },
                                        "lock": {
                                          "$ref": "#/definitions/lockType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Network/privateEndpoints@2024-07-01#properties/tags"
                                            },
                                            "description": "Optional. Tags to be applied on all resources/Resource Groups in this deployment."
                                          }
                                        },
                                        "enableTelemetry": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable/Disable usage telemetry for module."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a private endpoint. To be used if the private endpoint's default service / groupId can be assumed (i.e., for services that only have one Private Endpoint type like 'vault' for key vault).",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "roleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "roleDefinitionIdOrName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                          }
                                        },
                                        "principalType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Device",
                                            "ForeignGroup",
                                            "Group",
                                            "ServicePrincipal",
                                            "User"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The principal type of the assigned principal ID."
                                          }
                                        },
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The description of the role assignment."
                                          }
                                        },
                                        "condition": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                          }
                                        },
                                        "conditionVersion": {
                                          "type": "string",
                                          "allowedValues": [
                                            "2.0"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Version of the condition."
                                          }
                                        },
                                        "delegatedManagedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a role assignment.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "rotationPolicyType": {
                                      "type": "object",
                                      "properties": {
                                        "attributes": {
                                          "type": "object",
                                          "properties": {
                                            "expiryTime": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The expiration time for the new key version. It should be in ISO8601 format. Eg: \"P90D\", \"P1Y\"."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The attributes of key rotation policy."
                                          }
                                        },
                                        "lifetimeActions": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "action": {
                                                "type": "object",
                                                "properties": {
                                                  "type": {
                                                    "type": "string",
                                                    "allowedValues": [
                                                      "notify",
                                                      "rotate"
                                                    ],
                                                    "nullable": true,
                                                    "metadata": {
                                                      "description": "Optional. The type of the action."
                                                    }
                                                  }
                                                },
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. The type of the action."
                                                }
                                              },
                                              "trigger": {
                                                "type": "object",
                                                "properties": {
                                                  "timeAfterCreate": {
                                                    "type": "string",
                                                    "nullable": true,
                                                    "metadata": {
                                                      "description": "Optional. The time duration after key creation to rotate the key. It only applies to rotate. It will be in ISO 8601 duration format. Eg: \"P90D\", \"P1Y\"."
                                                    }
                                                  },
                                                  "timeBeforeExpiry": {
                                                    "type": "string",
                                                    "nullable": true,
                                                    "metadata": {
                                                      "description": "Optional. The time duration before key expiring to rotate or notify. It will be in ISO 8601 duration format. Eg: \"P90D\", \"P1Y\"."
                                                    }
                                                  }
                                                },
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. The time duration for rotating the key."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The key rotation policy lifetime actions."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a rotation policy.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "key/main.bicep"
                                        }
                                      }
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string",
                                      "maxLength": 24,
                                      "metadata": {
                                        "description": "Required. Name of the Key Vault. Must be globally unique."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Location for all resources."
                                      }
                                    },
                                    "accessPolicies": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/accessPolicyType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. All access policies to create."
                                      }
                                    },
                                    "secrets": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/secretType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. All secrets to create."
                                      }
                                    },
                                    "keys": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/keyType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. All keys to create."
                                      }
                                    },
                                    "enableVaultForDeployment": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Specifies if the vault is enabled for deployment by script or compute."
                                      }
                                    },
                                    "enableVaultForTemplateDeployment": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Specifies if the vault is enabled for a template deployment."
                                      }
                                    },
                                    "enableVaultForDiskEncryption": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Specifies if the azure platform has access to the vault for enabling disk encryption scenarios."
                                      }
                                    },
                                    "enableSoftDelete": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Switch to enable/disable Key Vault's soft delete feature."
                                      }
                                    },
                                    "softDeleteRetentionInDays": {
                                      "type": "int",
                                      "defaultValue": 90,
                                      "metadata": {
                                        "description": "Optional. softDelete data retention days. It accepts >=7 and <=90."
                                      }
                                    },
                                    "enableRbacAuthorization": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Property that controls how data actions are authorized. When true, the key vault will use Role Based Access Control (RBAC) for authorization of data actions, and the access policies specified in vault properties will be ignored. When false, the key vault will use the access policies specified in vault properties, and any policy stored on Azure Resource Manager will be ignored. Note that management actions are always authorized with RBAC."
                                      }
                                    },
                                    "createMode": {
                                      "type": "string",
                                      "defaultValue": "default",
                                      "allowedValues": [
                                        "default",
                                        "recover"
                                      ],
                                      "metadata": {
                                        "description": "Optional. The vault's create mode to indicate whether the vault need to be recovered or not."
                                      }
                                    },
                                    "enablePurgeProtection": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Provide 'true' to enable Key Vault's purge protection feature."
                                      }
                                    },
                                    "sku": {
                                      "type": "string",
                                      "defaultValue": "premium",
                                      "allowedValues": [
                                        "premium",
                                        "standard"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Specifies the SKU for the vault."
                                      }
                                    },
                                    "networkAcls": {
                                      "$ref": "#/definitions/networkAclsType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Rules governing the accessibility of the resource from specific network locations."
                                      }
                                    },
                                    "publicNetworkAccess": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "allowedValues": [
                                        "",
                                        "Enabled",
                                        "Disabled"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Whether or not public network access is allowed for this resource. For security reasons it should be disabled. If not specified, it will be disabled by default if private endpoints are set and networkAcls are not set."
                                      }
                                    },
                                    "lock": {
                                      "$ref": "#/definitions/lockType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The lock settings of the service."
                                      }
                                    },
                                    "roleAssignments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/roleAssignmentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Array of role assignments to create."
                                      }
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointSingleServiceType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.KeyVault/vaults@2024-11-01#properties/tags"
                                        },
                                        "description": "Optional. Resource tags."
                                      },
                                      "nullable": true
                                    },
                                    "diagnosticSettings": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/diagnosticSettingFullType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The diagnostic settings of the service."
                                      }
                                    },
                                    "enableTelemetry": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                      }
                                    }
                                  },
                                  "variables": {
                                    "copy": [
                                      {
                                        "name": "formattedRoleAssignments",
                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                      },
                                      {
                                        "name": "formattedAccessPolicies",
                                        "count": "[length(coalesce(parameters('accessPolicies'), createArray()))]",
                                        "input": {
                                          "applicationId": "[coalesce(tryGet(coalesce(parameters('accessPolicies'), createArray())[copyIndex('formattedAccessPolicies')], 'applicationId'), '')]",
                                          "objectId": "[coalesce(parameters('accessPolicies'), createArray())[copyIndex('formattedAccessPolicies')].objectId]",
                                          "permissions": "[coalesce(parameters('accessPolicies'), createArray())[copyIndex('formattedAccessPolicies')].permissions]",
                                          "tenantId": "[coalesce(tryGet(coalesce(parameters('accessPolicies'), createArray())[copyIndex('formattedAccessPolicies')], 'tenantId'), tenant().tenantId)]"
                                        }
                                      }
                                    ],
                                    "enableReferencedModulesTelemetry": false,
                                    "builtInRoleNames": {
                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                      "Key Vault Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                                      "Key Vault Certificates Officer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a4417e6f-fecd-4de8-b567-7b0420556985')]",
                                      "Key Vault Certificate User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db79e9a7-68ee-4b58-9aeb-b90e7c24fcba')]",
                                      "Key Vault Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]",
                                      "Key Vault Crypto Officer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '14b46e9e-c2b7-41b4-b07b-48a6ebf60603')]",
                                      "Key Vault Crypto Service Encryption User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]",
                                      "Key Vault Crypto User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]",
                                      "Key Vault Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '21090545-7ca7-4776-b22c-e363652d74d2')]",
                                      "Key Vault Secrets Officer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
                                      "Key Vault Secrets User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                    }
                                  },
                                  "resources": {
                                    "avmTelemetry": {
                                      "condition": "[parameters('enableTelemetry')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2024-03-01",
                                      "name": "[format('46d3xbcp.res.keyvault-vault.{0}.{1}', replace('0.13.3', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                      "properties": {
                                        "mode": "Incremental",
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "resources": [],
                                          "outputs": {
                                            "telemetry": {
                                              "type": "String",
                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "keyVault": {
                                      "type": "Microsoft.KeyVault/vaults",
                                      "apiVersion": "2024-11-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": {
                                        "enabledForDeployment": "[parameters('enableVaultForDeployment')]",
                                        "enabledForTemplateDeployment": "[parameters('enableVaultForTemplateDeployment')]",
                                        "enabledForDiskEncryption": "[parameters('enableVaultForDiskEncryption')]",
                                        "enableSoftDelete": "[parameters('enableSoftDelete')]",
                                        "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                                        "enableRbacAuthorization": "[parameters('enableRbacAuthorization')]",
                                        "createMode": "[parameters('createMode')]",
                                        "enablePurgeProtection": "[if(parameters('enablePurgeProtection'), parameters('enablePurgeProtection'), null())]",
                                        "tenantId": "[subscription().tenantId]",
                                        "accessPolicies": "[variables('formattedAccessPolicies')]",
                                        "sku": {
                                          "name": "[parameters('sku')]",
                                          "family": "A"
                                        },
                                        "networkAcls": "[if(not(empty(coalesce(parameters('networkAcls'), createObject()))), createObject('bypass', tryGet(parameters('networkAcls'), 'bypass'), 'defaultAction', tryGet(parameters('networkAcls'), 'defaultAction'), 'virtualNetworkRules', coalesce(tryGet(parameters('networkAcls'), 'virtualNetworkRules'), createArray()), 'ipRules', coalesce(tryGet(parameters('networkAcls'), 'ipRules'), createArray())), null())]",
                                        "publicNetworkAccess": "[if(not(empty(parameters('publicNetworkAccess'))), parameters('publicNetworkAccess'), if(and(not(empty(coalesce(parameters('privateEndpoints'), createArray()))), empty(coalesce(parameters('networkAcls'), createObject()))), 'Disabled', null()))]"
                                      }
                                    },
                                    "keyVault_lock": {
                                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                      "type": "Microsoft.Authorization/locks",
                                      "apiVersion": "2020-05-01",
                                      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                      "properties": {
                                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                        "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                                      },
                                      "dependsOn": [
                                        "keyVault"
                                      ]
                                    },
                                    "keyVault_diagnosticSettings": {
                                      "copy": {
                                        "name": "keyVault_diagnosticSettings",
                                        "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                      },
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                                      "properties": {
                                        "copy": [
                                          {
                                            "name": "metrics",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                            "input": {
                                              "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                              "timeGrain": null
                                            }
                                          },
                                          {
                                            "name": "logs",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                            "input": {
                                              "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                              "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                            }
                                          }
                                        ],
                                        "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                        "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                        "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                        "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                        "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                        "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                      },
                                      "dependsOn": [
                                        "keyVault"
                                      ]
                                    },
                                    "keyVault_roleAssignments": {
                                      "copy": {
                                        "name": "keyVault_roleAssignments",
                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.KeyVault/vaults', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                      "properties": {
                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                      },
                                      "dependsOn": [
                                        "keyVault"
                                      ]
                                    },
                                    "keyVault_accessPolicies": {
                                      "condition": "[not(empty(parameters('accessPolicies')))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-KeyVault-AccessPolicies', uniqueString(deployment().name, parameters('location')))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "keyVaultName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "accessPolicies": {
                                            "value": "[parameters('accessPolicies')]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.37.4.10188",
                                              "templateHash": "8803020983329720581"
                                            },
                                            "name": "Key Vault Access Policies",
                                            "description": "This module deploys a Key Vault Access Policy."
                                          },
                                          "definitions": {
                                            "accessPoliciesType": {
                                              "type": "object",
                                              "properties": {
                                                "tenantId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The tenant ID that is used for authenticating requests to the key vault."
                                                  }
                                                },
                                                "objectId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The object ID of a user, service principal or security group in the tenant for the vault."
                                                  }
                                                },
                                                "applicationId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Application ID of the client making request on behalf of a principal."
                                                  }
                                                },
                                                "permissions": {
                                                  "type": "object",
                                                  "properties": {
                                                    "keys": {
                                                      "type": "array",
                                                      "allowedValues": [
                                                        "all",
                                                        "backup",
                                                        "create",
                                                        "decrypt",
                                                        "delete",
                                                        "encrypt",
                                                        "get",
                                                        "getrotationpolicy",
                                                        "import",
                                                        "list",
                                                        "purge",
                                                        "recover",
                                                        "release",
                                                        "restore",
                                                        "rotate",
                                                        "setrotationpolicy",
                                                        "sign",
                                                        "unwrapKey",
                                                        "update",
                                                        "verify",
                                                        "wrapKey"
                                                      ],
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Permissions to keys."
                                                      }
                                                    },
                                                    "secrets": {
                                                      "type": "array",
                                                      "allowedValues": [
                                                        "all",
                                                        "backup",
                                                        "delete",
                                                        "get",
                                                        "list",
                                                        "purge",
                                                        "recover",
                                                        "restore",
                                                        "set"
                                                      ],
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Permissions to secrets."
                                                      }
                                                    },
                                                    "certificates": {
                                                      "type": "array",
                                                      "allowedValues": [
                                                        "all",
                                                        "backup",
                                                        "create",
                                                        "delete",
                                                        "deleteissuers",
                                                        "get",
                                                        "getissuers",
                                                        "import",
                                                        "list",
                                                        "listissuers",
                                                        "managecontacts",
                                                        "manageissuers",
                                                        "purge",
                                                        "recover",
                                                        "restore",
                                                        "setissuers",
                                                        "update"
                                                      ],
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Permissions to certificates."
                                                      }
                                                    },
                                                    "storage": {
                                                      "type": "array",
                                                      "allowedValues": [
                                                        "all",
                                                        "backup",
                                                        "delete",
                                                        "deletesas",
                                                        "get",
                                                        "getsas",
                                                        "list",
                                                        "listsas",
                                                        "purge",
                                                        "recover",
                                                        "regeneratekey",
                                                        "restore",
                                                        "set",
                                                        "setsas",
                                                        "update"
                                                      ],
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Permissions to storage accounts."
                                                      }
                                                    }
                                                  },
                                                  "metadata": {
                                                    "description": "Required. Permissions the identity has for keys, secrets and certificates."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for an access policy."
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "keyVaultName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent key vault. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "accessPolicies": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/accessPoliciesType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. An array of 0 to 16 identities that have access to the key vault. All identities in the array must use the same tenant ID as the key vault's tenant ID."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.keyvault-accesspolicy.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "keyVault": {
                                              "existing": true,
                                              "type": "Microsoft.KeyVault/vaults",
                                              "apiVersion": "2024-11-01",
                                              "name": "[parameters('keyVaultName')]"
                                            },
                                            "policies": {
                                              "type": "Microsoft.KeyVault/vaults/accessPolicies",
                                              "apiVersion": "2024-11-01",
                                              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "accessPolicies",
                                                    "count": "[length(coalesce(parameters('accessPolicies'), createArray()))]",
                                                    "input": {
                                                      "applicationId": "[coalesce(tryGet(coalesce(parameters('accessPolicies'), createArray())[copyIndex('accessPolicies')], 'applicationId'), '')]",
                                                      "objectId": "[coalesce(parameters('accessPolicies'), createArray())[copyIndex('accessPolicies')].objectId]",
                                                      "permissions": "[coalesce(parameters('accessPolicies'), createArray())[copyIndex('accessPolicies')].permissions]",
                                                      "tenantId": "[coalesce(tryGet(coalesce(parameters('accessPolicies'), createArray())[copyIndex('accessPolicies')], 'tenantId'), tenant().tenantId)]"
                                                    }
                                                  }
                                                ]
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the access policies assignment was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the access policies assignment."
                                              },
                                              "value": "add"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the access policies assignment."
                                              },
                                              "value": "[resourceId('Microsoft.KeyVault/vaults/accessPolicies', parameters('keyVaultName'), 'add')]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "keyVault"
                                      ]
                                    },
                                    "keyVault_secrets": {
                                      "copy": {
                                        "name": "keyVault_secrets",
                                        "count": "[length(coalesce(parameters('secrets'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-KeyVault-Secret-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(parameters('secrets'), createArray())[copyIndex()].name]"
                                          },
                                          "value": {
                                            "value": "[coalesce(parameters('secrets'), createArray())[copyIndex()].value]"
                                          },
                                          "keyVaultName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "attributesEnabled": {
                                            "value": "[tryGet(tryGet(coalesce(parameters('secrets'), createArray())[copyIndex()], 'attributes'), 'enabled')]"
                                          },
                                          "attributesExp": {
                                            "value": "[tryGet(tryGet(coalesce(parameters('secrets'), createArray())[copyIndex()], 'attributes'), 'exp')]"
                                          },
                                          "attributesNbf": {
                                            "value": "[tryGet(tryGet(coalesce(parameters('secrets'), createArray())[copyIndex()], 'attributes'), 'nbf')]"
                                          },
                                          "contentType": {
                                            "value": "[tryGet(coalesce(parameters('secrets'), createArray())[copyIndex()], 'contentType')]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('secrets'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "roleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('secrets'), createArray())[copyIndex()], 'roleAssignments')]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.37.4.10188",
                                              "templateHash": "8701309639990049090"
                                            },
                                            "name": "Key Vault Secrets",
                                            "description": "This module deploys a Key Vault Secret."
                                          },
                                          "definitions": {
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "keyVaultName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent key vault. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "minLength": 1,
                                              "maxLength": 127,
                                              "metadata": {
                                                "description": "Required. The name of the secret (letters (upper and lower case), numbers, -)."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.KeyVault/vaults/secrets@2024-11-01#properties/tags"
                                                },
                                                "description": "Optional. Resource tags."
                                              },
                                              "nullable": true
                                            },
                                            "attributesEnabled": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Determines whether the object is enabled."
                                              }
                                            },
                                            "attributesExp": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Expiry date in seconds since 1970-01-01T00:00:00Z. For security reasons, it is recommended to set an expiration date whenever possible."
                                              }
                                            },
                                            "attributesNbf": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Not before date in seconds since 1970-01-01T00:00:00Z."
                                              }
                                            },
                                            "contentType": {
                                              "type": "securestring",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The content type of the secret."
                                              }
                                            },
                                            "value": {
                                              "type": "securestring",
                                              "metadata": {
                                                "description": "Required. The value of the secret. NOTE: \"value\" will never be returned from the service, as APIs using this model are is intended for internal use in ARM deployments. Users should use the data-plane REST service for interaction with vault secrets."
                                              }
                                            },
                                            "roleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/roleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of role assignments to create."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "formattedRoleAssignments",
                                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                              }
                                            ],
                                            "builtInRoleNames": {
                                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                              "Key Vault Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                                              "Key Vault Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]",
                                              "Key Vault Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '21090545-7ca7-4776-b22c-e363652d74d2')]",
                                              "Key Vault Secrets Officer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
                                              "Key Vault Secrets User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
                                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                              "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.keyvault-secret.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "keyVault": {
                                              "existing": true,
                                              "type": "Microsoft.KeyVault/vaults",
                                              "apiVersion": "2024-11-01",
                                              "name": "[parameters('keyVaultName')]"
                                            },
                                            "secret": {
                                              "type": "Microsoft.KeyVault/vaults/secrets",
                                              "apiVersion": "2024-11-01",
                                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('name'))]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "contentType": "[parameters('contentType')]",
                                                "attributes": {
                                                  "enabled": "[parameters('attributesEnabled')]",
                                                  "exp": "[parameters('attributesExp')]",
                                                  "nbf": "[parameters('attributesNbf')]"
                                                },
                                                "value": "[parameters('value')]"
                                              }
                                            },
                                            "secret_roleAssignments": {
                                              "copy": {
                                                "name": "secret_roleAssignments",
                                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2022-04-01",
                                              "scope": "[format('Microsoft.KeyVault/vaults/{0}/secrets/{1}', parameters('keyVaultName'), parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                              "properties": {
                                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                              },
                                              "dependsOn": [
                                                "secret"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the secret."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the secret."
                                              },
                                              "value": "[resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('name'))]"
                                            },
                                            "secretUri": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The uri of the secret."
                                              },
                                              "value": "[reference('secret').secretUri]"
                                            },
                                            "secretUriWithVersion": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The uri with version of the secret."
                                              },
                                              "value": "[reference('secret').secretUriWithVersion]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the secret was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "keyVault"
                                      ]
                                    },
                                    "keyVault_keys": {
                                      "copy": {
                                        "name": "keyVault_keys",
                                        "count": "[length(coalesce(parameters('keys'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-KeyVault-Key-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(parameters('keys'), createArray())[copyIndex()].name]"
                                          },
                                          "keyVaultName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "attributesEnabled": {
                                            "value": "[tryGet(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'attributes'), 'enabled')]"
                                          },
                                          "attributesExp": {
                                            "value": "[tryGet(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'attributes'), 'exp')]"
                                          },
                                          "attributesNbf": {
                                            "value": "[tryGet(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'attributes'), 'nbf')]"
                                          },
                                          "curveName": "[if(and(not(equals(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'kty'), 'RSA')), not(equals(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'kty'), 'RSA-HSM'))), createObject('value', coalesce(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'curveName'), 'P-256')), createObject('value', null()))]",
                                          "keyOps": {
                                            "value": "[tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'keyOps')]"
                                          },
                                          "keySize": "[if(or(equals(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'kty'), 'RSA'), equals(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'kty'), 'RSA-HSM')), createObject('value', coalesce(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'keySize'), 4096)), createObject('value', null()))]",
                                          "releasePolicy": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'releasePolicy'), createObject())]"
                                          },
                                          "kty": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'kty'), 'EC')]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "roleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'roleAssignments')]"
                                          },
                                          "rotationPolicy": {
                                            "value": "[tryGet(coalesce(parameters('keys'), createArray())[copyIndex()], 'rotationPolicy')]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.37.4.10188",
                                              "templateHash": "1266219369073699726"
                                            },
                                            "name": "Key Vault Keys",
                                            "description": "This module deploys a Key Vault Key."
                                          },
                                          "definitions": {
                                            "rotationPolicyType": {
                                              "type": "object",
                                              "properties": {
                                                "attributes": {
                                                  "type": "object",
                                                  "properties": {
                                                    "expiryTime": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. The expiration time for the new key version. It should be in ISO8601 format. Eg: \"P90D\", \"P1Y\"."
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The attributes of key rotation policy."
                                                  }
                                                },
                                                "lifetimeActions": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "action": {
                                                        "type": "object",
                                                        "properties": {
                                                          "type": {
                                                            "type": "string",
                                                            "allowedValues": [
                                                              "notify",
                                                              "rotate"
                                                            ],
                                                            "nullable": true,
                                                            "metadata": {
                                                              "description": "Optional. The type of the action."
                                                            }
                                                          }
                                                        },
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. The type of the action."
                                                        }
                                                      },
                                                      "trigger": {
                                                        "type": "object",
                                                        "properties": {
                                                          "timeAfterCreate": {
                                                            "type": "string",
                                                            "nullable": true,
                                                            "metadata": {
                                                              "description": "Optional. The time duration after key creation to rotate the key. It only applies to rotate. It will be in ISO 8601 duration format. Eg: \"P90D\", \"P1Y\"."
                                                            }
                                                          },
                                                          "timeBeforeExpiry": {
                                                            "type": "string",
                                                            "nullable": true,
                                                            "metadata": {
                                                              "description": "Optional. The time duration before key expiring to rotate or notify. It will be in ISO 8601 duration format. Eg: \"P90D\", \"P1Y\"."
                                                            }
                                                          }
                                                        },
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. The time duration for rotating the key."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The key rotation policy lifetime actions."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a rotation policy."
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "keyVaultName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent key vault. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of the key."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.KeyVault/vaults/keys@2024-11-01#properties/tags"
                                                },
                                                "description": "Optional. Resource tags."
                                              },
                                              "nullable": true
                                            },
                                            "attributesEnabled": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Determines whether the object is enabled."
                                              }
                                            },
                                            "attributesExp": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Expiry date in seconds since 1970-01-01T00:00:00Z. For security reasons, it is recommended to set an expiration date whenever possible."
                                              }
                                            },
                                            "attributesNbf": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Not before date in seconds since 1970-01-01T00:00:00Z."
                                              }
                                            },
                                            "curveName": {
                                              "type": "string",
                                              "defaultValue": "P-256",
                                              "allowedValues": [
                                                "P-256",
                                                "P-256K",
                                                "P-384",
                                                "P-521"
                                              ],
                                              "metadata": {
                                                "description": "Optional. The elliptic curve name."
                                              }
                                            },
                                            "keyOps": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "allowedValues": [
                                                "decrypt",
                                                "encrypt",
                                                "import",
                                                "sign",
                                                "unwrapKey",
                                                "verify",
                                                "wrapKey"
                                              ],
                                              "metadata": {
                                                "description": "Optional. Array of JsonWebKeyOperation."
                                              }
                                            },
                                            "keySize": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The key size in bits. For example: 2048, 3072, or 4096 for RSA."
                                              }
                                            },
                                            "kty": {
                                              "type": "string",
                                              "defaultValue": "EC",
                                              "allowedValues": [
                                                "EC",
                                                "EC-HSM",
                                                "RSA",
                                                "RSA-HSM"
                                              ],
                                              "metadata": {
                                                "description": "Optional. The type of the key."
                                              }
                                            },
                                            "releasePolicy": {
                                              "type": "object",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Key release policy."
                                              }
                                            },
                                            "roleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/roleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of role assignments to create."
                                              }
                                            },
                                            "rotationPolicy": {
                                              "$ref": "#/definitions/rotationPolicyType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Key rotation policy properties object."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "formattedRoleAssignments",
                                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                              }
                                            ],
                                            "builtInRoleNames": {
                                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                              "Key Vault Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                                              "Key Vault Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f25e0fa2-a7c8-4377-a976-54943a77a395')]",
                                              "Key Vault Crypto Officer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '14b46e9e-c2b7-41b4-b07b-48a6ebf60603')]",
                                              "Key Vault Crypto Service Encryption User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]",
                                              "Key Vault Crypto User": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]",
                                              "Key Vault Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '21090545-7ca7-4776-b22c-e363652d74d2')]",
                                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                              "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.keyvault-key.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "keyVault": {
                                              "existing": true,
                                              "type": "Microsoft.KeyVault/vaults",
                                              "apiVersion": "2024-11-01",
                                              "name": "[parameters('keyVaultName')]"
                                            },
                                            "key": {
                                              "type": "Microsoft.KeyVault/vaults/keys",
                                              "apiVersion": "2024-11-01",
                                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('name'))]",
                                              "tags": "[parameters('tags')]",
                                              "properties": "[shallowMerge(createArray(createObject('attributes', createObject('enabled', parameters('attributesEnabled'), 'exp', parameters('attributesExp'), 'nbf', parameters('attributesNbf')), 'curveName', parameters('curveName'), 'keyOps', parameters('keyOps'), 'keySize', parameters('keySize'), 'kty', parameters('kty'), 'release_policy', coalesce(parameters('releasePolicy'), createObject())), if(not(empty(parameters('rotationPolicy'))), createObject('rotationPolicy', parameters('rotationPolicy')), createObject())))]"
                                            },
                                            "key_roleAssignments": {
                                              "copy": {
                                                "name": "key_roleAssignments",
                                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2022-04-01",
                                              "scope": "[format('Microsoft.KeyVault/vaults/{0}/keys/{1}', parameters('keyVaultName'), parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                              "properties": {
                                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                              },
                                              "dependsOn": [
                                                "key"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "keyUri": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The uri of the key."
                                              },
                                              "value": "[reference('key').keyUri]"
                                            },
                                            "keyUriWithVersion": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The uri with version of the key."
                                              },
                                              "value": "[reference('key').keyUriWithVersion]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the key."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the key."
                                              },
                                              "value": "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the key was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "keyVault"
                                      ]
                                    },
                                    "keyVault_privateEndpoints": {
                                      "copy": {
                                        "name": "keyVault_privateEndpoints",
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-keyVault-PrivateEndpoint-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "subscriptionId": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[2]]",
                                      "resourceGroup": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'name'), format('pep-{0}-{1}-{2}', last(split(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'vault'), copyIndex()))]"
                                          },
                                          "privateLinkServiceConnections": "[if(not(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true())), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'vault'), copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.KeyVault/vaults', parameters('name')), 'groupIds', createArray(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'vault')))))), createObject('value', null()))]",
                                          "manualPrivateLinkServiceConnections": "[if(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true()), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'vault'), copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.KeyVault/vaults', parameters('name')), 'groupIds', createArray(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'vault')), 'requestMessage', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'manualConnectionRequestMessage'), 'Manual approval required.'))))), createObject('value', null()))]",
                                          "subnetResourceId": {
                                            "value": "[coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          },
                                          "location": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'location'), reference(split(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                                          },
                                          "lock": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'lock'), parameters('lock'))]"
                                          },
                                          "privateDnsZoneGroup": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateDnsZoneGroup')]"
                                          },
                                          "roleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'roleAssignments')]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "customDnsConfigs": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customDnsConfigs')]"
                                          },
                                          "ipConfigurations": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'ipConfigurations')]"
                                          },
                                          "applicationSecurityGroupResourceIds": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'applicationSecurityGroupResourceIds')]"
                                          },
                                          "customNetworkInterfaceName": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customNetworkInterfaceName')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.34.44.8038",
                                              "templateHash": "12389807800450456797"
                                            },
                                            "name": "Private Endpoints",
                                            "description": "This module deploys a Private Endpoint."
                                          },
                                          "definitions": {
                                            "privateDnsZoneGroupType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the Private DNS Zone Group."
                                                  }
                                                },
                                                "privateDnsZoneGroupConfigs": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. The private DNS zone groups to associate the private endpoint. A DNS zone group can support up to 5 DNS zones."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "ipConfigurationType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the resource that is unique within a resource group."
                                                  }
                                                },
                                                "properties": {
                                                  "type": "object",
                                                  "properties": {
                                                    "groupId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string."
                                                      }
                                                    },
                                                    "memberName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string."
                                                      }
                                                    },
                                                    "privateIPAddress": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                                      }
                                                    }
                                                  },
                                                  "metadata": {
                                                    "description": "Required. Properties of private endpoint IP configurations."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "privateLinkServiceConnectionType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the private link service connection."
                                                  }
                                                },
                                                "properties": {
                                                  "type": "object",
                                                  "properties": {
                                                    "groupIds": {
                                                      "type": "array",
                                                      "items": {
                                                        "type": "string"
                                                      },
                                                      "metadata": {
                                                        "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string array `[]`."
                                                      }
                                                    },
                                                    "privateLinkServiceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The resource id of private link service."
                                                      }
                                                    },
                                                    "requestMessage": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. A message passed to the owner of the remote resource with this connection request. Restricted to 140 chars."
                                                      }
                                                    }
                                                  },
                                                  "metadata": {
                                                    "description": "Required. Properties of private link service connection."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "customDnsConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "fqdn": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. FQDN that resolves to private endpoint IP address."
                                                  }
                                                },
                                                "ipAddresses": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of private IP addresses of the private endpoint."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "lockType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the name of lock."
                                                  }
                                                },
                                                "kind": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "CanNotDelete",
                                                    "None",
                                                    "ReadOnly"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the type of lock."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a lock.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            },
                                            "privateDnsZoneGroupConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the private DNS zone group config."
                                                  }
                                                },
                                                "privateDnsZoneResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The resource id of the private DNS zone."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "private-dns-zone-group/main.bicep"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the private endpoint resource to create."
                                              }
                                            },
                                            "subnetResourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                              }
                                            },
                                            "applicationSecurityGroupResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                              }
                                            },
                                            "customNetworkInterfaceName": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                              }
                                            },
                                            "ipConfigurations": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/ipConfigurationType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                              }
                                            },
                                            "privateDnsZoneGroup": {
                                              "$ref": "#/definitions/privateDnsZoneGroupType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The private DNS zone group to configure for the private endpoint."
                                              }
                                            },
                                            "location": {
                                              "type": "string",
                                              "defaultValue": "[resourceGroup().location]",
                                              "metadata": {
                                                "description": "Optional. Location for all Resources."
                                              }
                                            },
                                            "lock": {
                                              "$ref": "#/definitions/lockType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The lock settings of the service."
                                              }
                                            },
                                            "roleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/roleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of role assignments to create."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                              }
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/customDnsConfigType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Custom DNS configurations."
                                              }
                                            },
                                            "manualPrivateLinkServiceConnections": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/privateLinkServiceConnectionType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Used when the network admin does not have access to approve connections to the remote resource. Required if `privateLinkServiceConnections` is empty."
                                              }
                                            },
                                            "privateLinkServiceConnections": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/privateLinkServiceConnectionType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Required if `manualPrivateLinkServiceConnections` is empty."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "formattedRoleAssignments",
                                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                              }
                                            ],
                                            "builtInRoleNames": {
                                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                              "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                                              "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                                              "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                                              "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                                              "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                              "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.network-privateendpoint.{0}.{1}', replace('0.11.0', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "privateEndpoint": {
                                              "type": "Microsoft.Network/privateEndpoints",
                                              "apiVersion": "2024-05-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "applicationSecurityGroups",
                                                    "count": "[length(coalesce(parameters('applicationSecurityGroupResourceIds'), createArray()))]",
                                                    "input": {
                                                      "id": "[coalesce(parameters('applicationSecurityGroupResourceIds'), createArray())[copyIndex('applicationSecurityGroups')]]"
                                                    }
                                                  }
                                                ],
                                                "customDnsConfigs": "[coalesce(parameters('customDnsConfigs'), createArray())]",
                                                "customNetworkInterfaceName": "[coalesce(parameters('customNetworkInterfaceName'), '')]",
                                                "ipConfigurations": "[coalesce(parameters('ipConfigurations'), createArray())]",
                                                "manualPrivateLinkServiceConnections": "[coalesce(parameters('manualPrivateLinkServiceConnections'), createArray())]",
                                                "privateLinkServiceConnections": "[coalesce(parameters('privateLinkServiceConnections'), createArray())]",
                                                "subnet": {
                                                  "id": "[parameters('subnetResourceId')]"
                                                }
                                              }
                                            },
                                            "privateEndpoint_lock": {
                                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                              "type": "Microsoft.Authorization/locks",
                                              "apiVersion": "2020-05-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                              "properties": {
                                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                                "notes": "[if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_roleAssignments": {
                                              "copy": {
                                                "name": "privateEndpoint_roleAssignments",
                                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2022-04-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                              "properties": {
                                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_privateDnsZoneGroup": {
                                              "condition": "[not(empty(parameters('privateDnsZoneGroup')))]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2022-09-01",
                                              "name": "[format('{0}-PrivateEndpoint-PrivateDnsZoneGroup', uniqueString(deployment().name))]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[tryGet(parameters('privateDnsZoneGroup'), 'name')]"
                                                  },
                                                  "privateEndpointName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "privateDnsZoneConfigs": {
                                                    "value": "[parameters('privateDnsZoneGroup').privateDnsZoneGroupConfigs]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.34.44.8038",
                                                      "templateHash": "13997305779829540948"
                                                    },
                                                    "name": "Private Endpoint Private DNS Zone Groups",
                                                    "description": "This module deploys a Private Endpoint Private DNS Zone Group."
                                                  },
                                                  "definitions": {
                                                    "privateDnsZoneGroupConfigType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name of the private DNS zone group config."
                                                          }
                                                        },
                                                        "privateDnsZoneResourceId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The resource id of the private DNS zone."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "privateEndpointName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "privateDnsZoneConfigs": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                      },
                                                      "minLength": 1,
                                                      "maxLength": 5,
                                                      "metadata": {
                                                        "description": "Required. Array of private DNS zone configurations of the private DNS zone group. A DNS zone group can support up to 5 DNS zones."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "defaultValue": "default",
                                                      "metadata": {
                                                        "description": "Optional. The name of the private DNS zone group."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "privateDnsZoneConfigsVar",
                                                        "count": "[length(parameters('privateDnsZoneConfigs'))]",
                                                        "input": {
                                                          "name": "[coalesce(tryGet(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')], 'name'), last(split(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')].privateDnsZoneResourceId, '/')))]",
                                                          "properties": {
                                                            "privateDnsZoneId": "[parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')].privateDnsZoneResourceId]"
                                                          }
                                                        }
                                                      }
                                                    ]
                                                  },
                                                  "resources": {
                                                    "privateEndpoint": {
                                                      "existing": true,
                                                      "type": "Microsoft.Network/privateEndpoints",
                                                      "apiVersion": "2024-05-01",
                                                      "name": "[parameters('privateEndpointName')]"
                                                    },
                                                    "privateDnsZoneGroup": {
                                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                                      "apiVersion": "2024-05-01",
                                                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                                      "properties": {
                                                        "privateDnsZoneConfigs": "[variables('privateDnsZoneConfigsVar')]"
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group the private endpoint DNS zone group was deployed into."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group the private endpoint was deployed into."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the private endpoint."
                                              },
                                              "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the private endpoint."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "location": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The location the resource was deployed into."
                                              },
                                              "value": "[reference('privateEndpoint', '2024-05-01', 'full').location]"
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/customDnsConfigType"
                                              },
                                              "metadata": {
                                                "description": "The custom DNS configurations of the private endpoint."
                                              },
                                              "value": "[reference('privateEndpoint').customDnsConfigs]"
                                            },
                                            "networkInterfaceResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "metadata": {
                                                "description": "The resource IDs of the network interfaces associated with the private endpoint."
                                              },
                                              "value": "[map(reference('privateEndpoint').networkInterfaces, lambda('nic', lambdaVariables('nic').id))]"
                                            },
                                            "groupId": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "The group Id for the private endpoint Group."
                                              },
                                              "value": "[coalesce(tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'manualPrivateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0), tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'privateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "keyVault"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the key vault."
                                      },
                                      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the resource group the key vault was created in."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the key vault."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "uri": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The URI of the key vault."
                                      },
                                      "value": "[reference('keyVault').vaultUri]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('keyVault', '2024-11-01', 'full').location]"
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointOutputType"
                                      },
                                      "metadata": {
                                        "description": "The private endpoints of the key vault."
                                      },
                                      "copy": {
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]",
                                        "input": {
                                          "name": "[reference(format('keyVault_privateEndpoints[{0}]', copyIndex())).outputs.name.value]",
                                          "resourceId": "[reference(format('keyVault_privateEndpoints[{0}]', copyIndex())).outputs.resourceId.value]",
                                          "groupId": "[tryGet(tryGet(reference(format('keyVault_privateEndpoints[{0}]', copyIndex())).outputs, 'groupId'), 'value')]",
                                          "customDnsConfigs": "[reference(format('keyVault_privateEndpoints[{0}]', copyIndex())).outputs.customDnsConfigs.value]",
                                          "networkInterfaceResourceIds": "[reference(format('keyVault_privateEndpoints[{0}]', copyIndex())).outputs.networkInterfaceResourceIds.value]"
                                        }
                                      }
                                    },
                                    "secrets": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/credentialOutputType"
                                      },
                                      "metadata": {
                                        "description": "The properties of the created secrets."
                                      },
                                      "copy": {
                                        "count": "[length(range(0, length(coalesce(parameters('secrets'), createArray()))))]",
                                        "input": {
                                          "resourceId": "[reference(format('keyVault_secrets[{0}]', range(0, length(coalesce(parameters('secrets'), createArray())))[copyIndex()])).outputs.resourceId.value]",
                                          "uri": "[reference(format('keyVault_secrets[{0}]', range(0, length(coalesce(parameters('secrets'), createArray())))[copyIndex()])).outputs.secretUri.value]",
                                          "uriWithVersion": "[reference(format('keyVault_secrets[{0}]', range(0, length(coalesce(parameters('secrets'), createArray())))[copyIndex()])).outputs.secretUriWithVersion.value]"
                                        }
                                      }
                                    },
                                    "keys": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/credentialOutputType"
                                      },
                                      "metadata": {
                                        "description": "The properties of the created keys."
                                      },
                                      "copy": {
                                        "count": "[length(range(0, length(coalesce(parameters('keys'), createArray()))))]",
                                        "input": {
                                          "resourceId": "[reference(format('keyVault_keys[{0}]', range(0, length(coalesce(parameters('keys'), createArray())))[copyIndex()])).outputs.resourceId.value]",
                                          "uri": "[reference(format('keyVault_keys[{0}]', range(0, length(coalesce(parameters('keys'), createArray())))[copyIndex()])).outputs.keyUri.value]",
                                          "uriWithVersion": "[reference(format('keyVault_keys[{0}]', range(0, length(coalesce(parameters('keys'), createArray())))[copyIndex()])).outputs.keyUriWithVersion.value]"
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Name of the Key Vault."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('keyVault').outputs.name.value, variables('existingName'))]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource ID of the Key Vault."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('keyVault').outputs.resourceId.value, extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('existingSubscriptionId'), variables('existingResourceGroupName')), 'Microsoft.KeyVault/vaults', variables('existingName')))]"
                            },
                            "subscriptionId": {
                              "type": "string",
                              "metadata": {
                                "description": "Subscription ID of the Key Vault."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), subscription().subscriptionId, variables('existingSubscriptionId'))]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource Group Name of the Key Vault."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), resourceGroup().name, variables('existingResourceGroupName'))]"
                            }
                          }
                        }
                      }
                    },
                    "aiSearch": {
                      "condition": "[parameters('includeAssociatedResources')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[take(format('module.aiSearch.{0}', variables('resourcesName')), 64)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "existingResourceId": {
                            "value": "[tryGet(parameters('aiSearchConfiguration'), 'existingResourceId')]"
                          },
                          "name": {
                            "value": "[take(if(not(empty(tryGet(parameters('aiSearchConfiguration'), 'name'))), parameters('aiSearchConfiguration').name, format('srch{0}', variables('resourcesName'))), 60)]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "enableTelemetry": {
                            "value": "[parameters('enableTelemetry')]"
                          },
                          "privateEndpointSubnetResourceId": {
                            "value": "[parameters('privateEndpointSubnetResourceId')]"
                          },
                          "privateDnsZoneResourceId": {
                            "value": "[tryGet(parameters('aiSearchConfiguration'), 'privateDnsZoneResourceId')]"
                          },
                          "roleAssignments": {
                            "value": "[tryGet(parameters('aiSearchConfiguration'), 'roleAssignments')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "4285493545618522255"
                            }
                          },
                          "definitions": {
                            "roleAssignmentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                  }
                                },
                                "roleDefinitionIdOrName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                  }
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                  }
                                },
                                "principalType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Device",
                                    "ForeignGroup",
                                    "Group",
                                    "ServicePrincipal",
                                    "User"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The principal type of the assigned principal ID."
                                  }
                                },
                                "description": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The description of the role assignment."
                                  }
                                },
                                "condition": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                  }
                                },
                                "conditionVersion": {
                                  "type": "string",
                                  "allowedValues": [
                                    "2.0"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Version of the condition."
                                  }
                                },
                                "delegatedManagedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a role assignment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                }
                              }
                            }
                          },
                          "functions": [
                            {
                              "namespace": "__bicep",
                              "members": {
                                "getResourceGroupName": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 4), parameters('parts')[4], resourceGroup().name)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Group Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceName": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    },
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(and(and(not(empty(parameters('resourceId'))), contains(parameters('resourceId'), '/')), not(empty(parameters('parts')))), last(parameters('parts')), coalesce(parameters('resourceId'), ''))]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceParts": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    }
                                  ],
                                  "output": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "value": "[split(coalesce(parameters('resourceId'), ''), '/')]"
                                  },
                                  "metadata": {
                                    "description": "Splits Resource ID into its components.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getSubscriptionId": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 2), parameters('parts')[2], subscription().subscriptionId)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Subscription ID from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                }
                              }
                            }
                          ],
                          "parameters": {
                            "name": {
                              "type": "string",
                              "maxLength": 60,
                              "metadata": {
                                "description": "Required. The name of the AI Search resource."
                              }
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The location for the AI Search resource."
                              }
                            },
                            "existingResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The full resource ID of an existing AI Search resource to use instead of creating a new one."
                              }
                            },
                            "privateEndpointSubnetResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource Id of an existing subnet to use for private connectivity. This is required along with 'privateDnsZoneResourceId' to establish private endpoints."
                              }
                            },
                            "privateDnsZoneResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The resource ID of the private DNS zone for the AI Search resource to establish private endpoints."
                              }
                            },
                            "roleAssignments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/roleAssignmentType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Specifies the role assignments for the AI Search resource."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Resources/resourceGroups@2025-04-01#properties/tags"
                                },
                                "description": "Optional. Specifies the resource tags for all the resources."
                              },
                              "defaultValue": {}
                            }
                          },
                          "variables": {
                            "existingResourceParts": "[__bicep.getResourceParts(parameters('existingResourceId'))]",
                            "existingName": "[__bicep.getResourceName(parameters('existingResourceId'), variables('existingResourceParts'))]",
                            "existingSubscriptionId": "[__bicep.getSubscriptionId(variables('existingResourceParts'))]",
                            "existingResourceGroupName": "[__bicep.getResourceGroupName(variables('existingResourceParts'))]",
                            "privateNetworkingEnabled": "[and(not(empty(parameters('privateDnsZoneResourceId'))), not(empty(parameters('privateEndpointSubnetResourceId'))))]"
                          },
                          "resources": {
                            "existingSearchService": {
                              "condition": "[not(empty(parameters('existingResourceId')))]",
                              "existing": true,
                              "type": "Microsoft.Search/searchServices",
                              "apiVersion": "2025-05-01",
                              "subscriptionId": "[variables('existingSubscriptionId')]",
                              "resourceGroup": "[variables('existingResourceGroupName')]",
                              "name": "[variables('existingName')]"
                            },
                            "aiSearch": {
                              "condition": "[empty(parameters('existingResourceId'))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('avm.res.search.search-service.{0}', parameters('name')), 64)]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[parameters('name')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "enableTelemetry": {
                                    "value": "[parameters('enableTelemetry')]"
                                  },
                                  "cmkEnforcement": {
                                    "value": "Unspecified"
                                  },
                                  "managedIdentities": {
                                    "value": {
                                      "systemAssigned": true
                                    }
                                  },
                                  "publicNetworkAccess": "[if(variables('privateNetworkingEnabled'), createObject('value', 'Disabled'), createObject('value', 'Enabled'))]",
                                  "disableLocalAuth": {
                                    "value": "[variables('privateNetworkingEnabled')]"
                                  },
                                  "authOptions": "[if(variables('privateNetworkingEnabled'), createObject('value', null()), createObject('value', createObject('aadOrApiKey', createObject('aadAuthFailureMode', 'http401WithBearerChallenge'))))]",
                                  "sku": {
                                    "value": "standard"
                                  },
                                  "partitionCount": {
                                    "value": 1
                                  },
                                  "replicaCount": {
                                    "value": 3
                                  },
                                  "roleAssignments": {
                                    "value": "[parameters('roleAssignments')]"
                                  },
                                  "privateEndpoints": "[if(variables('privateNetworkingEnabled'), createObject('value', createArray(createObject('privateDnsZoneGroup', createObject('privateDnsZoneGroupConfigs', createArray(createObject('privateDnsZoneResourceId', parameters('privateDnsZoneResourceId')))), 'subnetResourceId', parameters('privateEndpointSubnetResourceId')))), createObject('value', createArray()))]",
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.37.4.10188",
                                      "templateHash": "10902281417196168235"
                                    },
                                    "name": "Search Services",
                                    "description": "This module deploys a Search Service."
                                  },
                                  "definitions": {
                                    "privateEndpointOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the private endpoint."
                                          }
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the private endpoint."
                                          }
                                        },
                                        "groupId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "The group Id for the private endpoint Group."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "fqdn": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "FQDN that resolves to private endpoint IP address."
                                                }
                                              },
                                              "ipAddresses": {
                                                "type": "array",
                                                "items": {
                                                  "type": "string"
                                                },
                                                "metadata": {
                                                  "description": "A list of private IP addresses of the private endpoint."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "The custom DNS configurations of the private endpoint."
                                          }
                                        },
                                        "networkInterfaceResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "The IDs of the network interfaces associated with the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true
                                      }
                                    },
                                    "secretsExportConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "keyVaultResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The key vault name where to store the API Admin keys generated by the modules."
                                          }
                                        },
                                        "primaryAdminKeyName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The primaryAdminKey secret name to create."
                                          }
                                        },
                                        "secondaryAdminKeyName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The secondaryAdminKey secret name to create."
                                          }
                                        }
                                      }
                                    },
                                    "secretsOutputType": {
                                      "type": "object",
                                      "properties": {},
                                      "additionalProperties": {
                                        "$ref": "#/definitions/secretSetType",
                                        "metadata": {
                                          "description": "An exported secret's references."
                                        }
                                      }
                                    },
                                    "authOptionsType": {
                                      "type": "object",
                                      "properties": {
                                        "aadOrApiKey": {
                                          "type": "object",
                                          "properties": {
                                            "aadAuthFailureMode": {
                                              "type": "string",
                                              "allowedValues": [
                                                "http401WithBearerChallenge",
                                                "http403"
                                              ],
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Describes what response the data plane API of a search service would send for requests that failed authentication."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Indicates that either the API key or an access token from a Microsoft Entra ID tenant can be used for authentication."
                                          }
                                        },
                                        "apiKeyOnly": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Indicates that only the API key can be used for authentication."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true
                                      }
                                    },
                                    "networkRuleSetType": {
                                      "type": "object",
                                      "properties": {
                                        "bypass": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzurePortal",
                                            "AzureServices",
                                            "None"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Network specific rules that determine how the Azure AI Search service may be reached."
                                          }
                                        },
                                        "ipRules": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/ipRuleType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of IP restriction rules that defines the inbound network(s) with allowing access to the search service endpoint. At the meantime, all other public IP networks are blocked by the firewall. These restriction rules are applied only when the 'publicNetworkAccess' of the search service is 'enabled'; otherwise, traffic over public interface is not allowed even with any public IP rules, and private endpoint connections would be the exclusive access method."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true
                                      }
                                    },
                                    "ipRuleType": {
                                      "type": "object",
                                      "properties": {
                                        "value": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Value corresponding to a single IPv4 address (eg., 123.1.2.3) or an IP range in CIDR format (eg., 123.1.2.3/24) to be allowed."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true
                                      }
                                    },
                                    "_1.lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "notes": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the notes of the lock."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a lock.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.privateEndpointCustomDnsConfigType": {
                                      "type": "object",
                                      "properties": {
                                        "fqdn": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. FQDN that resolves to private endpoint IP address."
                                          }
                                        },
                                        "ipAddresses": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of private IP addresses of the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.privateEndpointIpConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the resource that is unique within a resource group."
                                          }
                                        },
                                        "properties": {
                                          "type": "object",
                                          "properties": {
                                            "groupId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "memberName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "privateIPAddress": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Properties of private endpoint IP configurations."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.privateEndpointPrivateDnsZoneGroupType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private DNS Zone Group."
                                          }
                                        },
                                        "privateDnsZoneGroupConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "name": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. The name of the private DNS Zone Group config."
                                                }
                                              },
                                              "privateDnsZoneResourceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource id of the private DNS zone."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. The private DNS Zone Groups to associate the Private Endpoint. A DNS Zone Group can support up to 5 DNS zones."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.roleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "roleDefinitionIdOrName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                          }
                                        },
                                        "principalType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Device",
                                            "ForeignGroup",
                                            "Group",
                                            "ServicePrincipal",
                                            "User"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The principal type of the assigned principal ID."
                                          }
                                        },
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The description of the role assignment."
                                          }
                                        },
                                        "condition": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                          }
                                        },
                                        "conditionVersion": {
                                          "type": "string",
                                          "allowedValues": [
                                            "2.0"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Version of the condition."
                                          }
                                        },
                                        "delegatedManagedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a role assignment.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "diagnosticSettingFullType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the diagnostic setting."
                                          }
                                        },
                                        "logCategoriesAndGroups": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                }
                                              },
                                              "categoryGroup": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                          }
                                        },
                                        "metricCategories": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                          }
                                        },
                                        "logAnalyticsDestinationType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureDiagnostics",
                                            "Dedicated"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                          }
                                        },
                                        "workspaceResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "storageAccountResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "eventHubAuthorizationRuleResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                          }
                                        },
                                        "eventHubName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "marketplacePartnerResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                        }
                                      }
                                    },
                                    "lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "notes": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the notes of the lock."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a lock.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                        }
                                      }
                                    },
                                    "managedIdentityAllType": {
                                      "type": "object",
                                      "properties": {
                                        "systemAssigned": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enables system assigned managed identity on the resource."
                                          }
                                        },
                                        "userAssignedResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID(s) to assign to the resource. Required if a user assigned identity is used for encryption."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a managed identity configuration. To be used if both a system-assigned & user-assigned identities are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                        }
                                      }
                                    },
                                    "privateEndpointSingleServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private Endpoint."
                                          }
                                        },
                                        "location": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The location to deploy the Private Endpoint to."
                                          }
                                        },
                                        "privateLinkServiceConnectionName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the private link connection to create."
                                          }
                                        },
                                        "service": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The subresource to deploy the Private Endpoint for. For example \"vault\" for a Key Vault Private Endpoint."
                                          }
                                        },
                                        "subnetResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                          }
                                        },
                                        "resourceGroupResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID of the Resource Group the Private Endpoint will be created in. If not specified, the Resource Group of the provided Virtual Network Subnet is used."
                                          }
                                        },
                                        "privateDnsZoneGroup": {
                                          "$ref": "#/definitions/_1.privateEndpointPrivateDnsZoneGroupType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The private DNS Zone Group to configure for the Private Endpoint."
                                          }
                                        },
                                        "isManualConnection": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. If Manual Private Link Connection is required."
                                          }
                                        },
                                        "manualConnectionRequestMessage": {
                                          "type": "string",
                                          "nullable": true,
                                          "maxLength": 140,
                                          "metadata": {
                                            "description": "Optional. A message passed to the owner of the remote resource with the manual connection request."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_1.privateEndpointCustomDnsConfigType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Custom DNS configurations."
                                          }
                                        },
                                        "ipConfigurations": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_1.privateEndpointIpConfigurationType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of IP configurations of the Private Endpoint. This will be used to map to the first-party Service endpoints."
                                          }
                                        },
                                        "applicationSecurityGroupResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Application security groups in which the Private Endpoint IP configuration is included."
                                          }
                                        },
                                        "customNetworkInterfaceName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The custom name of the network interface attached to the Private Endpoint."
                                          }
                                        },
                                        "lock": {
                                          "$ref": "#/definitions/_1.lockType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_1.roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Network/privateEndpoints@2024-07-01#properties/tags"
                                            },
                                            "description": "Optional. Tags to be applied on all resources/Resource Groups in this deployment."
                                          }
                                        },
                                        "enableTelemetry": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable/Disable usage telemetry for module."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a private endpoint. To be used if the private endpoint's default service / groupId can be assumed (i.e., for services that only have one Private Endpoint type like 'vault' for key vault).",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "roleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "roleDefinitionIdOrName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                          }
                                        },
                                        "principalType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Device",
                                            "ForeignGroup",
                                            "Group",
                                            "ServicePrincipal",
                                            "User"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The principal type of the assigned principal ID."
                                          }
                                        },
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The description of the role assignment."
                                          }
                                        },
                                        "condition": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                          }
                                        },
                                        "conditionVersion": {
                                          "type": "string",
                                          "allowedValues": [
                                            "2.0"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Version of the condition."
                                          }
                                        },
                                        "delegatedManagedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a role assignment.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                        }
                                      }
                                    },
                                    "secretSetType": {
                                      "type": "object",
                                      "properties": {
                                        "secretResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resourceId of the exported secret."
                                          }
                                        },
                                        "secretUri": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The secret URI of the exported secret."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "modules/keyVaultExport.bicep"
                                        }
                                      }
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the Azure Cognitive Search service to create or update. Search service names must only contain lowercase letters, digits or dashes, cannot use dash as the first two or last one characters, cannot contain consecutive dashes, and must be between 2 and 60 characters in length. Search service names must be globally unique since they are part of the service URI (https://<name>.search.windows.net). You cannot change the service name after the service is created."
                                      }
                                    },
                                    "authOptions": {
                                      "$ref": "#/definitions/authOptionsType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Defines the options for how the data plane API of a Search service authenticates requests. Must remain an empty object {} if 'disableLocalAuth' is set to true."
                                      }
                                    },
                                    "disableLocalAuth": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. When set to true, calls to the search service will not be permitted to utilize API keys for authentication. This cannot be set to true if 'authOptions' are defined."
                                      }
                                    },
                                    "enableTelemetry": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                      }
                                    },
                                    "cmkEnforcement": {
                                      "type": "string",
                                      "defaultValue": "Unspecified",
                                      "allowedValues": [
                                        "Disabled",
                                        "Enabled",
                                        "Unspecified"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Describes a policy that determines how resources within the search service are to be encrypted with Customer Managed Keys."
                                      }
                                    },
                                    "hostingMode": {
                                      "type": "string",
                                      "defaultValue": "default",
                                      "allowedValues": [
                                        "default",
                                        "highDensity"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Applicable only for the standard3 SKU. You can set this property to enable up to 3 high density partitions that allow up to 1000 indexes, which is much higher than the maximum indexes allowed for any other SKU. For the standard3 SKU, the value is either 'default' or 'highDensity'. For all other SKUs, this value must be 'default'."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Location for all Resources."
                                      }
                                    },
                                    "lock": {
                                      "$ref": "#/definitions/lockType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The lock settings for all Resources in the solution."
                                      }
                                    },
                                    "networkRuleSet": {
                                      "$ref": "#/definitions/networkRuleSetType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Network specific rules that determine how the Azure Cognitive Search service may be reached."
                                      }
                                    },
                                    "partitionCount": {
                                      "type": "int",
                                      "defaultValue": 1,
                                      "minValue": 1,
                                      "maxValue": 12,
                                      "metadata": {
                                        "description": "Optional. The number of partitions in the search service; if specified, it can be 1, 2, 3, 4, 6, or 12. Values greater than 1 are only valid for standard SKUs. For 'standard3' services with hostingMode set to 'highDensity', the allowed values are between 1 and 3."
                                      }
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointSingleServiceType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible."
                                      }
                                    },
                                    "sharedPrivateLinkResources": {
                                      "type": "array",
                                      "defaultValue": [],
                                      "metadata": {
                                        "description": "Optional. The sharedPrivateLinkResources to create as part of the search Service."
                                      }
                                    },
                                    "publicNetworkAccess": {
                                      "type": "string",
                                      "defaultValue": "Enabled",
                                      "allowedValues": [
                                        "Enabled",
                                        "Disabled"
                                      ],
                                      "metadata": {
                                        "description": "Optional. This value can be set to 'Enabled' to avoid breaking changes on existing customer resources and templates. If set to 'Disabled', traffic over public interface is not allowed, and private endpoint connections would be the exclusive access method."
                                      }
                                    },
                                    "secretsExportConfiguration": {
                                      "$ref": "#/definitions/secretsExportConfigurationType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Key vault reference and secret settings for the module's secrets export."
                                      }
                                    },
                                    "replicaCount": {
                                      "type": "int",
                                      "defaultValue": 3,
                                      "minValue": 1,
                                      "maxValue": 12,
                                      "metadata": {
                                        "description": "Optional. The number of replicas in the search service. If specified, it must be a value between 1 and 12 inclusive for standard SKUs or between 1 and 3 inclusive for basic SKU."
                                      }
                                    },
                                    "roleAssignments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/roleAssignmentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Array of role assignments to create."
                                      }
                                    },
                                    "semanticSearch": {
                                      "type": "string",
                                      "nullable": true,
                                      "allowedValues": [
                                        "disabled",
                                        "free",
                                        "standard"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Sets options that control the availability of semantic search. This configuration is only possible for certain search SKUs in certain locations."
                                      }
                                    },
                                    "sku": {
                                      "type": "string",
                                      "defaultValue": "standard",
                                      "allowedValues": [
                                        "basic",
                                        "free",
                                        "standard",
                                        "standard2",
                                        "standard3",
                                        "storage_optimized_l1",
                                        "storage_optimized_l2"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Defines the SKU of an Azure Cognitive Search Service, which determines price tier and capacity limits."
                                      }
                                    },
                                    "managedIdentities": {
                                      "$ref": "#/definitions/managedIdentityAllType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The managed identity definition for this resource."
                                      }
                                    },
                                    "diagnosticSettings": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/diagnosticSettingFullType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The diagnostic settings of the service."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.Search/searchServices@2025-02-01-preview#properties/tags"
                                        },
                                        "description": "Optional. Tags to help categorize the resource in the Azure portal."
                                      },
                                      "nullable": true
                                    }
                                  },
                                  "variables": {
                                    "copy": [
                                      {
                                        "name": "formattedRoleAssignments",
                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                      }
                                    ],
                                    "enableReferencedModulesTelemetry": false,
                                    "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
                                    "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', if(coalesce(tryGet(parameters('managedIdentities'), 'systemAssigned'), false()), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'UserAssigned', '')), 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
                                    "builtInRoleNames": {
                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                      "Search Index Data Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                                      "Search Index Data Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1407120a-92aa-4202-b7e9-c0e197c71c8f')]",
                                      "Search Service Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0')]",
                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                    }
                                  },
                                  "resources": {
                                    "avmTelemetry": {
                                      "condition": "[parameters('enableTelemetry')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2024-03-01",
                                      "name": "[format('46d3xbcp.res.search-searchservice.{0}.{1}', replace('0.11.1', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                      "properties": {
                                        "mode": "Incremental",
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "resources": [],
                                          "outputs": {
                                            "telemetry": {
                                              "type": "String",
                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "searchService": {
                                      "type": "Microsoft.Search/searchServices",
                                      "apiVersion": "2025-02-01-preview",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "sku": {
                                        "name": "[parameters('sku')]"
                                      },
                                      "tags": "[parameters('tags')]",
                                      "identity": "[variables('identity')]",
                                      "properties": {
                                        "authOptions": "[parameters('authOptions')]",
                                        "disableLocalAuth": "[parameters('disableLocalAuth')]",
                                        "encryptionWithCmk": {
                                          "enforcement": "[parameters('cmkEnforcement')]"
                                        },
                                        "hostingMode": "[parameters('hostingMode')]",
                                        "networkRuleSet": "[parameters('networkRuleSet')]",
                                        "partitionCount": "[parameters('partitionCount')]",
                                        "replicaCount": "[parameters('replicaCount')]",
                                        "publicNetworkAccess": "[toLower(parameters('publicNetworkAccess'))]",
                                        "semanticSearch": "[parameters('semanticSearch')]"
                                      }
                                    },
                                    "searchService_diagnosticSettings": {
                                      "copy": {
                                        "name": "searchService_diagnosticSettings",
                                        "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                      },
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                                      "properties": {
                                        "copy": [
                                          {
                                            "name": "metrics",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                            "input": {
                                              "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                              "timeGrain": null
                                            }
                                          },
                                          {
                                            "name": "logs",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                            "input": {
                                              "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                              "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                            }
                                          }
                                        ],
                                        "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                        "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                        "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                        "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                        "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                        "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                      },
                                      "dependsOn": [
                                        "searchService"
                                      ]
                                    },
                                    "searchService_lock": {
                                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                      "type": "Microsoft.Authorization/locks",
                                      "apiVersion": "2020-05-01",
                                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                      "properties": {
                                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                        "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                                      },
                                      "dependsOn": [
                                        "searchService"
                                      ]
                                    },
                                    "searchService_roleAssignments": {
                                      "copy": {
                                        "name": "searchService_roleAssignments",
                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Search/searchServices', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                      "properties": {
                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                      },
                                      "dependsOn": [
                                        "searchService"
                                      ]
                                    },
                                    "searchService_privateEndpoints": {
                                      "copy": {
                                        "name": "searchService_privateEndpoints",
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-searchService-PrivateEndpoint-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "subscriptionId": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[2]]",
                                      "resourceGroup": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'name'), format('pep-{0}-{1}-{2}', last(split(resourceId('Microsoft.Search/searchServices', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'searchService'), copyIndex()))]"
                                          },
                                          "privateLinkServiceConnections": "[if(not(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true())), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.Search/searchServices', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'searchService'), copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.Search/searchServices', parameters('name')), 'groupIds', createArray(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'searchService')))))), createObject('value', null()))]",
                                          "manualPrivateLinkServiceConnections": "[if(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true()), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.Search/searchServices', parameters('name')), '/')), coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'searchService'), copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.Search/searchServices', parameters('name')), 'groupIds', createArray(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'service'), 'searchService')), 'requestMessage', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'manualConnectionRequestMessage'), 'Manual approval required.'))))), createObject('value', null()))]",
                                          "subnetResourceId": {
                                            "value": "[coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          },
                                          "location": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'location'), reference(split(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                                          },
                                          "lock": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'lock'), parameters('lock'))]"
                                          },
                                          "privateDnsZoneGroup": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateDnsZoneGroup')]"
                                          },
                                          "roleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'roleAssignments')]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "customDnsConfigs": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customDnsConfigs')]"
                                          },
                                          "ipConfigurations": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'ipConfigurations')]"
                                          },
                                          "applicationSecurityGroupResourceIds": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'applicationSecurityGroupResourceIds')]"
                                          },
                                          "customNetworkInterfaceName": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customNetworkInterfaceName')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.34.44.8038",
                                              "templateHash": "12389807800450456797"
                                            },
                                            "name": "Private Endpoints",
                                            "description": "This module deploys a Private Endpoint."
                                          },
                                          "definitions": {
                                            "privateDnsZoneGroupType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the Private DNS Zone Group."
                                                  }
                                                },
                                                "privateDnsZoneGroupConfigs": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. The private DNS zone groups to associate the private endpoint. A DNS zone group can support up to 5 DNS zones."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "ipConfigurationType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the resource that is unique within a resource group."
                                                  }
                                                },
                                                "properties": {
                                                  "type": "object",
                                                  "properties": {
                                                    "groupId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string."
                                                      }
                                                    },
                                                    "memberName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string."
                                                      }
                                                    },
                                                    "privateIPAddress": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                                      }
                                                    }
                                                  },
                                                  "metadata": {
                                                    "description": "Required. Properties of private endpoint IP configurations."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "privateLinkServiceConnectionType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the private link service connection."
                                                  }
                                                },
                                                "properties": {
                                                  "type": "object",
                                                  "properties": {
                                                    "groupIds": {
                                                      "type": "array",
                                                      "items": {
                                                        "type": "string"
                                                      },
                                                      "metadata": {
                                                        "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to. If used with private link service connection, this property must be defined as empty string array `[]`."
                                                      }
                                                    },
                                                    "privateLinkServiceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The resource id of private link service."
                                                      }
                                                    },
                                                    "requestMessage": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. A message passed to the owner of the remote resource with this connection request. Restricted to 140 chars."
                                                      }
                                                    }
                                                  },
                                                  "metadata": {
                                                    "description": "Required. Properties of private link service connection."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "customDnsConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "fqdn": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. FQDN that resolves to private endpoint IP address."
                                                  }
                                                },
                                                "ipAddresses": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of private IP addresses of the private endpoint."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "lockType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the name of lock."
                                                  }
                                                },
                                                "kind": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "CanNotDelete",
                                                    "None",
                                                    "ReadOnly"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the type of lock."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a lock.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            },
                                            "privateDnsZoneGroupConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the private DNS zone group config."
                                                  }
                                                },
                                                "privateDnsZoneResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The resource id of the private DNS zone."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "private-dns-zone-group/main.bicep"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.5.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the private endpoint resource to create."
                                              }
                                            },
                                            "subnetResourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                              }
                                            },
                                            "applicationSecurityGroupResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                              }
                                            },
                                            "customNetworkInterfaceName": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                              }
                                            },
                                            "ipConfigurations": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/ipConfigurationType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                              }
                                            },
                                            "privateDnsZoneGroup": {
                                              "$ref": "#/definitions/privateDnsZoneGroupType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The private DNS zone group to configure for the private endpoint."
                                              }
                                            },
                                            "location": {
                                              "type": "string",
                                              "defaultValue": "[resourceGroup().location]",
                                              "metadata": {
                                                "description": "Optional. Location for all Resources."
                                              }
                                            },
                                            "lock": {
                                              "$ref": "#/definitions/lockType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The lock settings of the service."
                                              }
                                            },
                                            "roleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/roleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of role assignments to create."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                              }
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/customDnsConfigType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Custom DNS configurations."
                                              }
                                            },
                                            "manualPrivateLinkServiceConnections": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/privateLinkServiceConnectionType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Used when the network admin does not have access to approve connections to the remote resource. Required if `privateLinkServiceConnections` is empty."
                                              }
                                            },
                                            "privateLinkServiceConnections": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/privateLinkServiceConnectionType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Required if `manualPrivateLinkServiceConnections` is empty."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "formattedRoleAssignments",
                                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                              }
                                            ],
                                            "builtInRoleNames": {
                                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                              "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                                              "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                                              "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                                              "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                                              "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                              "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.network-privateendpoint.{0}.{1}', replace('0.11.0', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "privateEndpoint": {
                                              "type": "Microsoft.Network/privateEndpoints",
                                              "apiVersion": "2024-05-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "applicationSecurityGroups",
                                                    "count": "[length(coalesce(parameters('applicationSecurityGroupResourceIds'), createArray()))]",
                                                    "input": {
                                                      "id": "[coalesce(parameters('applicationSecurityGroupResourceIds'), createArray())[copyIndex('applicationSecurityGroups')]]"
                                                    }
                                                  }
                                                ],
                                                "customDnsConfigs": "[coalesce(parameters('customDnsConfigs'), createArray())]",
                                                "customNetworkInterfaceName": "[coalesce(parameters('customNetworkInterfaceName'), '')]",
                                                "ipConfigurations": "[coalesce(parameters('ipConfigurations'), createArray())]",
                                                "manualPrivateLinkServiceConnections": "[coalesce(parameters('manualPrivateLinkServiceConnections'), createArray())]",
                                                "privateLinkServiceConnections": "[coalesce(parameters('privateLinkServiceConnections'), createArray())]",
                                                "subnet": {
                                                  "id": "[parameters('subnetResourceId')]"
                                                }
                                              }
                                            },
                                            "privateEndpoint_lock": {
                                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                              "type": "Microsoft.Authorization/locks",
                                              "apiVersion": "2020-05-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                              "properties": {
                                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                                "notes": "[if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_roleAssignments": {
                                              "copy": {
                                                "name": "privateEndpoint_roleAssignments",
                                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2022-04-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                              "properties": {
                                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_privateDnsZoneGroup": {
                                              "condition": "[not(empty(parameters('privateDnsZoneGroup')))]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2022-09-01",
                                              "name": "[format('{0}-PrivateEndpoint-PrivateDnsZoneGroup', uniqueString(deployment().name))]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[tryGet(parameters('privateDnsZoneGroup'), 'name')]"
                                                  },
                                                  "privateEndpointName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "privateDnsZoneConfigs": {
                                                    "value": "[parameters('privateDnsZoneGroup').privateDnsZoneGroupConfigs]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.34.44.8038",
                                                      "templateHash": "13997305779829540948"
                                                    },
                                                    "name": "Private Endpoint Private DNS Zone Groups",
                                                    "description": "This module deploys a Private Endpoint Private DNS Zone Group."
                                                  },
                                                  "definitions": {
                                                    "privateDnsZoneGroupConfigType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name of the private DNS zone group config."
                                                          }
                                                        },
                                                        "privateDnsZoneResourceId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The resource id of the private DNS zone."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "privateEndpointName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "privateDnsZoneConfigs": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                      },
                                                      "minLength": 1,
                                                      "maxLength": 5,
                                                      "metadata": {
                                                        "description": "Required. Array of private DNS zone configurations of the private DNS zone group. A DNS zone group can support up to 5 DNS zones."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "defaultValue": "default",
                                                      "metadata": {
                                                        "description": "Optional. The name of the private DNS zone group."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "privateDnsZoneConfigsVar",
                                                        "count": "[length(parameters('privateDnsZoneConfigs'))]",
                                                        "input": {
                                                          "name": "[coalesce(tryGet(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')], 'name'), last(split(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')].privateDnsZoneResourceId, '/')))]",
                                                          "properties": {
                                                            "privateDnsZoneId": "[parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigsVar')].privateDnsZoneResourceId]"
                                                          }
                                                        }
                                                      }
                                                    ]
                                                  },
                                                  "resources": {
                                                    "privateEndpoint": {
                                                      "existing": true,
                                                      "type": "Microsoft.Network/privateEndpoints",
                                                      "apiVersion": "2024-05-01",
                                                      "name": "[parameters('privateEndpointName')]"
                                                    },
                                                    "privateDnsZoneGroup": {
                                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                                      "apiVersion": "2024-05-01",
                                                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                                      "properties": {
                                                        "privateDnsZoneConfigs": "[variables('privateDnsZoneConfigsVar')]"
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group the private endpoint DNS zone group was deployed into."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group the private endpoint was deployed into."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the private endpoint."
                                              },
                                              "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the private endpoint."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "location": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The location the resource was deployed into."
                                              },
                                              "value": "[reference('privateEndpoint', '2024-05-01', 'full').location]"
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/customDnsConfigType"
                                              },
                                              "metadata": {
                                                "description": "The custom DNS configurations of the private endpoint."
                                              },
                                              "value": "[reference('privateEndpoint').customDnsConfigs]"
                                            },
                                            "networkInterfaceResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "metadata": {
                                                "description": "The resource IDs of the network interfaces associated with the private endpoint."
                                              },
                                              "value": "[map(reference('privateEndpoint').networkInterfaces, lambda('nic', lambdaVariables('nic').id))]"
                                            },
                                            "groupId": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "The group Id for the private endpoint Group."
                                              },
                                              "value": "[coalesce(tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'manualPrivateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0), tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'privateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "searchService"
                                      ]
                                    },
                                    "searchService_sharedPrivateLinkResources": {
                                      "copy": {
                                        "name": "searchService_sharedPrivateLinkResources",
                                        "count": "[length(parameters('sharedPrivateLinkResources'))]",
                                        "mode": "serial",
                                        "batchSize": 1
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-searchService-SharedPrvLink-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(tryGet(parameters('sharedPrivateLinkResources')[copyIndex()], 'name'), format('spl-{0}-{1}-{2}', last(split(resourceId('Microsoft.Search/searchServices', parameters('name')), '/')), parameters('sharedPrivateLinkResources')[copyIndex()].groupId, copyIndex()))]"
                                          },
                                          "searchServiceName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "privateLinkResourceId": {
                                            "value": "[parameters('sharedPrivateLinkResources')[copyIndex()].privateLinkResourceId]"
                                          },
                                          "groupId": {
                                            "value": "[parameters('sharedPrivateLinkResources')[copyIndex()].groupId]"
                                          },
                                          "requestMessage": {
                                            "value": "[parameters('sharedPrivateLinkResources')[copyIndex()].requestMessage]"
                                          },
                                          "resourceRegion": {
                                            "value": "[tryGet(parameters('sharedPrivateLinkResources')[copyIndex()], 'resourceRegion')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.37.4.10188",
                                              "templateHash": "557730297583881254"
                                            },
                                            "name": "Search Services Private Link Resources",
                                            "description": "This module deploys a Search Service Private Link Resource."
                                          },
                                          "parameters": {
                                            "searchServiceName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent searchServices. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of the shared private link resource managed by the Azure Cognitive Search service within the specified resource group."
                                              }
                                            },
                                            "privateLinkResourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The resource ID of the resource the shared private link resource is for."
                                              }
                                            },
                                            "groupId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The group ID from the provider of resource the shared private link resource is for."
                                              }
                                            },
                                            "requestMessage": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The request message for requesting approval of the shared private link resource."
                                              }
                                            },
                                            "resourceRegion": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Can be used to specify the Azure Resource Manager location of the resource to which a shared private link is to be created. This is only required for those resources whose DNS configuration are regional (such as Azure Kubernetes Service)."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "searchService": {
                                              "existing": true,
                                              "type": "Microsoft.Search/searchServices",
                                              "apiVersion": "2025-02-01-preview",
                                              "name": "[parameters('searchServiceName')]"
                                            },
                                            "sharedPrivateLinkResource": {
                                              "type": "Microsoft.Search/searchServices/sharedPrivateLinkResources",
                                              "apiVersion": "2025-02-01-preview",
                                              "name": "[format('{0}/{1}', parameters('searchServiceName'), parameters('name'))]",
                                              "properties": {
                                                "privateLinkResourceId": "[parameters('privateLinkResourceId')]",
                                                "groupId": "[parameters('groupId')]",
                                                "requestMessage": "[parameters('requestMessage')]",
                                                "resourceRegion": "[parameters('resourceRegion')]"
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the shared private link resource."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the shared private link resource."
                                              },
                                              "value": "[resourceId('Microsoft.Search/searchServices/sharedPrivateLinkResources', parameters('searchServiceName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the shared private link resource was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "searchService"
                                      ]
                                    },
                                    "secretsExport": {
                                      "condition": "[not(equals(parameters('secretsExportConfiguration'), null()))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2022-09-01",
                                      "name": "[format('{0}-secrets-kv', uniqueString(deployment().name, parameters('location')))]",
                                      "subscriptionId": "[split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "keyVaultName": {
                                            "value": "[last(split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/'))]"
                                          },
                                          "secretsToSet": {
                                            "value": "[union(createArray(), if(contains(parameters('secretsExportConfiguration'), 'primaryAdminKeyName'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'primaryAdminKeyName'), 'value', listAdminKeys('searchService', '2025-02-01-preview').primaryKey)), createArray()), if(contains(parameters('secretsExportConfiguration'), 'secondaryAdminKeyName'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'secondaryAdminKeyName'), 'value', listAdminKeys('searchService', '2025-02-01-preview').secondaryKey)), createArray()))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.37.4.10188",
                                              "templateHash": "7634110751636246703"
                                            }
                                          },
                                          "definitions": {
                                            "secretSetType": {
                                              "type": "object",
                                              "properties": {
                                                "secretResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The resourceId of the exported secret."
                                                  }
                                                },
                                                "secretUri": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The secret URI of the exported secret."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "secretToSetType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the secret to set."
                                                  }
                                                },
                                                "value": {
                                                  "type": "securestring",
                                                  "metadata": {
                                                    "description": "Required. The value of the secret to set."
                                                  }
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "keyVaultName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of the Key Vault to set the ecrets in."
                                              }
                                            },
                                            "secretsToSet": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/secretToSetType"
                                              },
                                              "metadata": {
                                                "description": "Required. The secrets to set in the Key Vault."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "keyVault": {
                                              "existing": true,
                                              "type": "Microsoft.KeyVault/vaults",
                                              "apiVersion": "2024-11-01",
                                              "name": "[parameters('keyVaultName')]"
                                            },
                                            "secrets": {
                                              "copy": {
                                                "name": "secrets",
                                                "count": "[length(parameters('secretsToSet'))]"
                                              },
                                              "type": "Microsoft.KeyVault/vaults/secrets",
                                              "apiVersion": "2024-11-01",
                                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretsToSet')[copyIndex()].name)]",
                                              "properties": {
                                                "value": "[parameters('secretsToSet')[copyIndex()].value]"
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "secretsSet": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/secretSetType"
                                              },
                                              "metadata": {
                                                "description": "The references to the secrets exported to the provided Key Vault."
                                              },
                                              "copy": {
                                                "count": "[length(range(0, length(coalesce(parameters('secretsToSet'), createArray()))))]",
                                                "input": {
                                                  "secretResourceId": "[resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretsToSet')[range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()]].name)]",
                                                  "secretUri": "[reference(format('secrets[{0}]', range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()])).secretUri]"
                                                }
                                              }
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "searchService"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the search service."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the search service."
                                      },
                                      "value": "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the resource group the search service was created in."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "systemAssignedMIPrincipalId": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "The principal ID of the system assigned identity."
                                      },
                                      "value": "[tryGet(tryGet(reference('searchService', '2025-02-01-preview', 'full'), 'identity'), 'principalId')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('searchService', '2025-02-01-preview', 'full').location]"
                                    },
                                    "endpoint": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The endpoint of the search service."
                                      },
                                      "value": "[reference('searchService').endpoint]"
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointOutputType"
                                      },
                                      "metadata": {
                                        "description": "The private endpoints of the search service."
                                      },
                                      "copy": {
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]",
                                        "input": {
                                          "name": "[reference(format('searchService_privateEndpoints[{0}]', copyIndex())).outputs.name.value]",
                                          "resourceId": "[reference(format('searchService_privateEndpoints[{0}]', copyIndex())).outputs.resourceId.value]",
                                          "groupId": "[tryGet(tryGet(reference(format('searchService_privateEndpoints[{0}]', copyIndex())).outputs, 'groupId'), 'value')]",
                                          "customDnsConfigs": "[reference(format('searchService_privateEndpoints[{0}]', copyIndex())).outputs.customDnsConfigs.value]",
                                          "networkInterfaceResourceIds": "[reference(format('searchService_privateEndpoints[{0}]', copyIndex())).outputs.networkInterfaceResourceIds.value]"
                                        }
                                      }
                                    },
                                    "exportedSecrets": {
                                      "$ref": "#/definitions/secretsOutputType",
                                      "metadata": {
                                        "description": "A hashtable of references to the secrets exported to the provided Key Vault. The key of each reference is each secret's name."
                                      },
                                      "value": "[if(not(equals(parameters('secretsExportConfiguration'), null())), toObject(reference('secretsExport').outputs.secretsSet.value, lambda('secret', last(split(lambdaVariables('secret').secretResourceId, '/'))), lambda('secret', lambdaVariables('secret'))), createObject())]"
                                    },
                                    "primaryKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The primary admin API key of the search service."
                                      },
                                      "value": "[listAdminKeys('searchService', '2025-02-01-preview').primaryKey]"
                                    },
                                    "secondaryKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The secondaryKey admin API key of the search service."
                                      },
                                      "value": "[listAdminKeys('searchService', '2025-02-01-preview').secondaryKey]"
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Name of the AI Search resource."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('aiSearch').outputs.name.value, variables('existingName'))]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource ID of the AI Search resource."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('aiSearch').outputs.resourceId.value, extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('existingSubscriptionId'), variables('existingResourceGroupName')), 'Microsoft.Search/searchServices', variables('existingName')))]"
                            },
                            "subscriptionId": {
                              "type": "string",
                              "metadata": {
                                "description": "Subscription ID of the AI Search resource."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), subscription().subscriptionId, variables('existingSubscriptionId'))]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource Group Name of the AI Search resource."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), resourceGroup().name, variables('existingResourceGroupName'))]"
                            },
                            "systemAssignedMIPrincipalId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "System assigned managed identity principal ID of the AI Search resource."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('aiSearch').outputs.systemAssignedMIPrincipalId.value, '')]"
                            }
                          }
                        }
                      }
                    },
                    "storageAccount": {
                      "condition": "[parameters('includeAssociatedResources')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[take(format('module.storageAccount.{0}', variables('resourcesName')), 64)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "existingResourceId": {
                            "value": "[tryGet(parameters('storageAccountConfiguration'), 'existingResourceId')]"
                          },
                          "name": {
                            "value": "[take(if(not(empty(tryGet(parameters('storageAccountConfiguration'), 'name'))), parameters('storageAccountConfiguration').name, format('st{0}', variables('resourcesName'))), 24)]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "enableTelemetry": {
                            "value": "[parameters('enableTelemetry')]"
                          },
                          "privateEndpointSubnetResourceId": {
                            "value": "[parameters('privateEndpointSubnetResourceId')]"
                          },
                          "blobPrivateDnsZoneResourceId": {
                            "value": "[tryGet(parameters('storageAccountConfiguration'), 'blobPrivateDnsZoneResourceId')]"
                          },
                          "roleAssignments": {
                            "value": "[concat(if(and(not(empty(parameters('storageAccountConfiguration'))), not(empty(tryGet(parameters('storageAccountConfiguration'), 'roleAssignments')))), parameters('storageAccountConfiguration').roleAssignments, createArray()), createArray(createObject('principalId', reference('foundryAccount').outputs.systemAssignedMIPrincipalId.value, 'principalType', 'ServicePrincipal', 'roleDefinitionIdOrName', 'Storage Blob Data Contributor')), if(empty(tryGet(parameters('aiSearchConfiguration'), 'existingResourceId')), createArray(createObject('principalId', reference('aiSearch').outputs.systemAssignedMIPrincipalId.value, 'principalType', 'ServicePrincipal', 'roleDefinitionIdOrName', 'Storage Blob Data Contributor')), createArray()))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "16651426455263024090"
                            }
                          },
                          "definitions": {
                            "roleAssignmentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                  }
                                },
                                "roleDefinitionIdOrName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                  }
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                  }
                                },
                                "principalType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Device",
                                    "ForeignGroup",
                                    "Group",
                                    "ServicePrincipal",
                                    "User"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The principal type of the assigned principal ID."
                                  }
                                },
                                "description": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The description of the role assignment."
                                  }
                                },
                                "condition": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                  }
                                },
                                "conditionVersion": {
                                  "type": "string",
                                  "allowedValues": [
                                    "2.0"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Version of the condition."
                                  }
                                },
                                "delegatedManagedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a role assignment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                }
                              }
                            }
                          },
                          "functions": [
                            {
                              "namespace": "__bicep",
                              "members": {
                                "getResourceGroupName": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 4), parameters('parts')[4], resourceGroup().name)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Group Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceName": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    },
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(and(and(not(empty(parameters('resourceId'))), contains(parameters('resourceId'), '/')), not(empty(parameters('parts')))), last(parameters('parts')), coalesce(parameters('resourceId'), ''))]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceParts": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    }
                                  ],
                                  "output": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "value": "[split(coalesce(parameters('resourceId'), ''), '/')]"
                                  },
                                  "metadata": {
                                    "description": "Splits Resource ID into its components.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getSubscriptionId": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 2), parameters('parts')[2], subscription().subscriptionId)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Subscription ID from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                }
                              }
                            }
                          ],
                          "parameters": {
                            "name": {
                              "type": "string",
                              "maxLength": 24,
                              "metadata": {
                                "description": "Required. The name of the storage account."
                              }
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The location for the storage account."
                              }
                            },
                            "existingResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The full resource ID of an existing storage account to use instead of creating a new one."
                              }
                            },
                            "privateEndpointSubnetResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource Id of an existing subnet to use for private connectivity. This is required along with 'blobPrivateDnsZoneResourceId' to establish private endpoints."
                              }
                            },
                            "blobPrivateDnsZoneResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The resource ID of the private DNS zone for the storage account blob service to establish private endpoints."
                              }
                            },
                            "roleAssignments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/roleAssignmentType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Specifies the role assignments for the storage account."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Resources/resourceGroups@2025-04-01#properties/tags"
                                },
                                "description": "Optional. Specifies the resource tags for all the resources."
                              },
                              "defaultValue": {}
                            }
                          },
                          "variables": {
                            "existingResourceParts": "[__bicep.getResourceParts(parameters('existingResourceId'))]",
                            "existingName": "[__bicep.getResourceName(parameters('existingResourceId'), variables('existingResourceParts'))]",
                            "existingSubscriptionId": "[__bicep.getSubscriptionId(variables('existingResourceParts'))]",
                            "existingResourceGroupName": "[__bicep.getResourceGroupName(variables('existingResourceParts'))]",
                            "privateNetworkingEnabled": "[and(not(empty(parameters('blobPrivateDnsZoneResourceId'))), not(empty(parameters('privateEndpointSubnetResourceId'))))]"
                          },
                          "resources": {
                            "existingStorageAccount": {
                              "condition": "[not(empty(parameters('existingResourceId')))]",
                              "existing": true,
                              "type": "Microsoft.Storage/storageAccounts",
                              "apiVersion": "2025-01-01",
                              "subscriptionId": "[variables('existingSubscriptionId')]",
                              "resourceGroup": "[variables('existingResourceGroupName')]",
                              "name": "[variables('existingName')]"
                            },
                            "storageAccount": {
                              "condition": "[empty(parameters('existingResourceId'))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('avm.res.storage.storage-account.{0}', parameters('name')), 64)]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[parameters('name')]"
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  },
                                  "enableTelemetry": {
                                    "value": "[parameters('enableTelemetry')]"
                                  },
                                  "publicNetworkAccess": "[if(variables('privateNetworkingEnabled'), createObject('value', 'Disabled'), createObject('value', 'Enabled'))]",
                                  "accessTier": {
                                    "value": "Hot"
                                  },
                                  "allowBlobPublicAccess": {
                                    "value": "[not(variables('privateNetworkingEnabled'))]"
                                  },
                                  "allowSharedKeyAccess": {
                                    "value": false
                                  },
                                  "allowCrossTenantReplication": {
                                    "value": false
                                  },
                                  "blobServices": {
                                    "value": {
                                      "deleteRetentionPolicyEnabled": true,
                                      "deleteRetentionPolicyDays": 7,
                                      "containerDeleteRetentionPolicyEnabled": true,
                                      "containerDeleteRetentionPolicyDays": 7
                                    }
                                  },
                                  "minimumTlsVersion": {
                                    "value": "TLS1_2"
                                  },
                                  "networkAcls": {
                                    "value": {
                                      "defaultAction": "[if(variables('privateNetworkingEnabled'), 'Deny', 'Allow')]",
                                      "bypass": "AzureServices"
                                    }
                                  },
                                  "supportsHttpsTrafficOnly": {
                                    "value": true
                                  },
                                  "privateEndpoints": "[if(variables('privateNetworkingEnabled'), createObject('value', createArray(createObject('privateDnsZoneGroup', createObject('privateDnsZoneGroupConfigs', createArray(createObject('privateDnsZoneResourceId', parameters('blobPrivateDnsZoneResourceId')))), 'service', 'blob', 'subnetResourceId', parameters('privateEndpointSubnetResourceId')))), createObject('value', createArray()))]",
                                  "roleAssignments": {
                                    "value": "[parameters('roleAssignments')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.38.33.27573",
                                      "templateHash": "1609510538398847306"
                                    },
                                    "name": "Storage Accounts",
                                    "description": "This module deploys a Storage Account."
                                  },
                                  "definitions": {
                                    "privateEndpointOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the private endpoint."
                                          }
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the private endpoint."
                                          }
                                        },
                                        "groupId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "The group Id for the private endpoint Group."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "fqdn": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "FQDN that resolves to private endpoint IP address."
                                                }
                                              },
                                              "ipAddresses": {
                                                "type": "array",
                                                "items": {
                                                  "type": "string"
                                                },
                                                "metadata": {
                                                  "description": "A list of private IP addresses of the private endpoint."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "The custom DNS configurations of the private endpoint."
                                          }
                                        },
                                        "networkInterfaceResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "The IDs of the network interfaces associated with the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for the private endpoints output."
                                      }
                                    },
                                    "networkAclsType": {
                                      "type": "object",
                                      "properties": {
                                        "resourceAccessRules": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "tenantId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The ID of the tenant in which the resource resides in."
                                                }
                                              },
                                              "resourceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource ID of the target service. Can also contain a wildcard, if multiple services e.g. in a resource group should be included."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Sets the resource access rules. Array entries must consist of \"tenantId\" and \"resourceId\" fields only."
                                          }
                                        },
                                        "bypass": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureServices",
                                            "AzureServices, Logging",
                                            "AzureServices, Logging, Metrics",
                                            "AzureServices, Metrics",
                                            "Logging",
                                            "Logging, Metrics",
                                            "Metrics",
                                            "None"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specifies whether traffic is bypassed for Logging/Metrics/AzureServices. Possible values are any combination of Logging,Metrics,AzureServices (For example, \"Logging, Metrics\"), or None to bypass none of those traffics."
                                          }
                                        },
                                        "virtualNetworkRules": {
                                          "type": "array",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Sets the virtual network rules."
                                          }
                                        },
                                        "ipRules": {
                                          "type": "array",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Sets the IP ACL rules."
                                          }
                                        },
                                        "defaultAction": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Allow",
                                            "Deny"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specifies the default action of allow or deny when no other rules match."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for the network configuration."
                                      }
                                    },
                                    "secretsExportConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "keyVaultResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The key vault name where to store the keys and connection strings generated by the modules."
                                          }
                                        },
                                        "accessKey1Name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The accessKey1 secret name to create."
                                          }
                                        },
                                        "connectionString1Name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The connectionString1 secret name to create."
                                          }
                                        },
                                        "accessKey2Name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The accessKey2 secret name to create."
                                          }
                                        },
                                        "connectionString2Name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The connectionString2 secret name to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of the exported secrets."
                                      }
                                    },
                                    "localUserType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the local user used for SFTP Authentication."
                                          }
                                        },
                                        "hasSharedKey": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Indicates whether shared key exists. Set it to false to remove existing shared key."
                                          }
                                        },
                                        "hasSshKey": {
                                          "type": "bool",
                                          "metadata": {
                                            "description": "Required. Indicates whether SSH key exists. Set it to false to remove existing SSH key."
                                          }
                                        },
                                        "hasSshPassword": {
                                          "type": "bool",
                                          "metadata": {
                                            "description": "Required. Indicates whether SSH password exists. Set it to false to remove existing SSH password."
                                          }
                                        },
                                        "homeDirectory": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The local user home directory."
                                          }
                                        },
                                        "permissionScopes": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/permissionScopeType"
                                          },
                                          "metadata": {
                                            "description": "Required. The permission scopes of the local user."
                                          }
                                        },
                                        "sshAuthorizedKeys": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/sshAuthorizedKeyType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The local user SSH authorized keys for SFTP."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of a local user."
                                      }
                                    },
                                    "blobServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "automaticSnapshotPolicyEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Automatic Snapshot is enabled if set to true."
                                          }
                                        },
                                        "changeFeedEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The blob service properties for change feed events. Indicates whether change feed event logging is enabled for the Blob service."
                                          }
                                        },
                                        "changeFeedRetentionInDays": {
                                          "type": "int",
                                          "nullable": true,
                                          "minValue": 1,
                                          "maxValue": 146000,
                                          "metadata": {
                                            "description": "Optional. Indicates whether change feed event logging is enabled for the Blob service. Indicates the duration of changeFeed retention in days. If left blank, it indicates an infinite retention of the change feed."
                                          }
                                        },
                                        "containerDeleteRetentionPolicyEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The blob service properties for container soft delete. Indicates whether DeleteRetentionPolicy is enabled."
                                          }
                                        },
                                        "containerDeleteRetentionPolicyDays": {
                                          "type": "int",
                                          "nullable": true,
                                          "minValue": 1,
                                          "maxValue": 365,
                                          "metadata": {
                                            "description": "Optional. Indicates the number of days that the deleted item should be retained."
                                          }
                                        },
                                        "containerDeleteRetentionPolicyAllowPermanentDelete": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. This property when set to true allows deletion of the soft deleted blob versions and snapshots. This property cannot be used with blob restore policy. This property only applies to blob service and does not apply to containers or file share."
                                          }
                                        },
                                        "corsRules": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/blobCorsRuleType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                          }
                                        },
                                        "defaultServiceVersion": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Indicates the default version to use for requests to the Blob service if an incoming request's version is not specified. Possible values include version 2008-10-27 and all more recent versions."
                                          }
                                        },
                                        "deleteRetentionPolicyEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The blob service properties for blob soft delete."
                                          }
                                        },
                                        "deleteRetentionPolicyDays": {
                                          "type": "int",
                                          "nullable": true,
                                          "minValue": 1,
                                          "maxValue": 365,
                                          "metadata": {
                                            "description": "Optional. Indicates the number of days that the deleted blob should be retained."
                                          }
                                        },
                                        "deleteRetentionPolicyAllowPermanentDelete": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. This property when set to true allows deletion of the soft deleted blob versions and snapshots. This property cannot be used with blob restore policy. This property only applies to blob service and does not apply to containers or file share."
                                          }
                                        },
                                        "isVersioningEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Use versioning to automatically maintain previous versions of your blobs. Cannot be enabled for ADLS Gen2 storage accounts."
                                          }
                                        },
                                        "versionDeletePolicyDays": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Number of days to keep a version before deleting. If set, a lifecycle management policy will be created to handle deleting previous versions."
                                          }
                                        },
                                        "lastAccessTimeTrackingPolicyEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The blob service property to configure last access time based tracking policy. When set to true last access time based tracking is enabled."
                                          }
                                        },
                                        "restorePolicyEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The blob service properties for blob restore policy. If point-in-time restore is enabled, then versioning, change feed, and blob soft delete must also be enabled."
                                          }
                                        },
                                        "restorePolicyDays": {
                                          "type": "int",
                                          "nullable": true,
                                          "minValue": 1,
                                          "metadata": {
                                            "description": "Optional. How long this blob can be restored. It should be less than DeleteRetentionPolicy days."
                                          }
                                        },
                                        "containers": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/containerType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Blob containers to create."
                                          }
                                        },
                                        "diagnosticSettings": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/diagnosticSettingFullType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The diagnostic settings of the service."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of a blob service."
                                      }
                                    },
                                    "fileServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "protocolSettings": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Storage/storageAccounts/fileServices@2024-01-01#properties/properties/properties/protocolSettings"
                                            },
                                            "description": "Optional. Protocol settings for file service."
                                          },
                                          "nullable": true
                                        },
                                        "shareDeleteRetentionPolicy": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Storage/storageAccounts/fileServices@2024-01-01#properties/properties/properties/shareDeleteRetentionPolicy"
                                            },
                                            "description": "Optional. The service properties for soft delete."
                                          },
                                          "nullable": true
                                        },
                                        "shares": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/fileShareType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. File shares to create."
                                          }
                                        },
                                        "corsRules": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/fileCorsRuleType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                          }
                                        },
                                        "diagnosticSettings": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/diagnosticSettingFullType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The diagnostic settings of the service."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of a file service."
                                      }
                                    },
                                    "queueServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "queues": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/queueType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Queues to create."
                                          }
                                        },
                                        "corsRules": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/queueCorsRuleType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                          }
                                        },
                                        "diagnosticSettings": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/diagnosticSettingFullType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The diagnostic settings of the service."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of a queue service."
                                      }
                                    },
                                    "tableServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "tables": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/tableType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Tables to create."
                                          }
                                        },
                                        "corsRules": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/tableCorsRuleType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                          }
                                        },
                                        "diagnosticSettings": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/diagnosticSettingFullType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The diagnostic settings of the service."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of a table service."
                                      }
                                    },
                                    "objectReplicationPolicyType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the object replication policy. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "destinationStorageAccountResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The resource ID of the destination storage account."
                                          }
                                        },
                                        "enableMetrics": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Indicates whether metrics are enabled for the object replication policy."
                                          }
                                        },
                                        "rules": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/objectReplicationPolicyRuleType"
                                          },
                                          "metadata": {
                                            "description": "Required. The storage account object replication rules."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type of an object replication policy."
                                      }
                                    },
                                    "_1.immutabilityPolicyType": {
                                      "type": "object",
                                      "properties": {
                                        "immutabilityPeriodSinceCreationInDays": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The immutability period for the blobs in the container since the policy creation, in days."
                                          }
                                        },
                                        "allowProtectedAppendWrites": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to an append blob while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API."
                                          }
                                        },
                                        "allowProtectedAppendWritesAll": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to both \"Append and Block Blobs\" while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API. The \"allowProtectedAppendWrites\" and \"allowProtectedAppendWritesAll\" properties are mutually exclusive."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for an immutability policy.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "blob-service/container/main.bicep"
                                        }
                                      }
                                    },
                                    "_2.privateEndpointCustomDnsConfigType": {
                                      "type": "object",
                                      "properties": {
                                        "fqdn": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. FQDN that resolves to private endpoint IP address."
                                          }
                                        },
                                        "ipAddresses": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of private IP addresses of the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_2.privateEndpointIpConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the resource that is unique within a resource group."
                                          }
                                        },
                                        "properties": {
                                          "type": "object",
                                          "properties": {
                                            "groupId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "memberName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "privateIPAddress": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Properties of private endpoint IP configurations."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_2.privateEndpointPrivateDnsZoneGroupType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private DNS Zone Group."
                                          }
                                        },
                                        "privateDnsZoneGroupConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "name": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. The name of the private DNS Zone Group config."
                                                }
                                              },
                                              "privateDnsZoneResourceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource id of the private DNS zone."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. The private DNS Zone Groups to associate the Private Endpoint. A DNS Zone Group can support up to 5 DNS zones."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_2.secretSetOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "secretResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resourceId of the exported secret."
                                          }
                                        },
                                        "secretUri": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The secret URI of the exported secret."
                                          }
                                        },
                                        "secretUriWithVersion": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The secret URI with version of the exported secret."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for the output of the secret set via the secrets export feature.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "blobCorsRuleType": {
                                      "type": "object",
                                      "properties": {
                                        "allowedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                          }
                                        },
                                        "allowedMethods": {
                                          "type": "array",
                                          "allowedValues": [
                                            "CONNECT",
                                            "DELETE",
                                            "GET",
                                            "HEAD",
                                            "MERGE",
                                            "OPTIONS",
                                            "PATCH",
                                            "POST",
                                            "PUT",
                                            "TRACE"
                                          ],
                                          "metadata": {
                                            "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                          }
                                        },
                                        "allowedOrigins": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                          }
                                        },
                                        "exposedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of response headers to expose to CORS clients."
                                          }
                                        },
                                        "maxAgeInSeconds": {
                                          "type": "int",
                                          "metadata": {
                                            "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a cors rule.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "blob-service/main.bicep",
                                          "originalIdentifier": "corsRuleType"
                                        }
                                      }
                                    },
                                    "containerType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the Storage Container to deploy."
                                          }
                                        },
                                        "defaultEncryptionScope": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Default the container to use specified encryption scope for all writes."
                                          }
                                        },
                                        "denyEncryptionScopeOverride": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Block override of encryption scope from the container default."
                                          }
                                        },
                                        "enableNfsV3AllSquash": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable NFSv3 all squash on blob container."
                                          }
                                        },
                                        "enableNfsV3RootSquash": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable NFSv3 root squash on blob container."
                                          }
                                        },
                                        "immutableStorageWithVersioningEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. This is an immutable property, when set to true it enables object level immutability at the container level. The property is immutable and can only be set to true at the container creation time. Existing containers must undergo a migration process."
                                          }
                                        },
                                        "immutabilityPolicy": {
                                          "$ref": "#/definitions/_1.immutabilityPolicyType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Configure immutability policy."
                                          }
                                        },
                                        "metadata": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Storage/storageAccounts/blobServices/containers@2024-01-01#properties/properties/properties/metadata"
                                            },
                                            "description": "Optional. A name-value pair to associate with the container as metadata."
                                          },
                                          "nullable": true
                                        },
                                        "publicAccess": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Blob",
                                            "Container",
                                            "None"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specifies whether data in the container may be accessed publicly and the level of access."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type of a storage container.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "blob-service/main.bicep"
                                        }
                                      }
                                    },
                                    "customerManagedKeyWithAutoRotateType": {
                                      "type": "object",
                                      "properties": {
                                        "keyVaultResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The resource ID of a key vault to reference a customer managed key for encryption from."
                                          }
                                        },
                                        "keyName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the customer managed key to use for encryption."
                                          }
                                        },
                                        "keyVersion": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The version of the customer managed key to reference for encryption. If not provided, using version as per 'autoRotationEnabled' setting."
                                          }
                                        },
                                        "autoRotationEnabled": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable or disable auto-rotating to the latest key version. Default is `true`. If set to `false`, the latest key version at the time of the deployment is used."
                                          }
                                        },
                                        "userAssignedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. User assigned identity to use when fetching the customer managed key. Required if no system assigned identity is available for use."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a customer-managed key. To be used if the resource type supports auto-rotation of the customer-managed key.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "diagnosticSettingFullType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the diagnostic setting."
                                          }
                                        },
                                        "logCategoriesAndGroups": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                }
                                              },
                                              "categoryGroup": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                          }
                                        },
                                        "metricCategories": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                          }
                                        },
                                        "logAnalyticsDestinationType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureDiagnostics",
                                            "Dedicated"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                          }
                                        },
                                        "workspaceResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "storageAccountResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "eventHubAuthorizationRuleResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                          }
                                        },
                                        "eventHubName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "marketplacePartnerResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "diagnosticSettingMetricsOnlyType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of diagnostic setting."
                                          }
                                        },
                                        "metricCategories": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                          }
                                        },
                                        "logAnalyticsDestinationType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureDiagnostics",
                                            "Dedicated"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                          }
                                        },
                                        "workspaceResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "storageAccountResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "eventHubAuthorizationRuleResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                          }
                                        },
                                        "eventHubName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "marketplacePartnerResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a diagnostic setting. To be used if only metrics are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "fileCorsRuleType": {
                                      "type": "object",
                                      "properties": {
                                        "allowedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                          }
                                        },
                                        "allowedMethods": {
                                          "type": "array",
                                          "allowedValues": [
                                            "CONNECT",
                                            "DELETE",
                                            "GET",
                                            "HEAD",
                                            "MERGE",
                                            "OPTIONS",
                                            "PATCH",
                                            "POST",
                                            "PUT",
                                            "TRACE"
                                          ],
                                          "metadata": {
                                            "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                          }
                                        },
                                        "allowedOrigins": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                          }
                                        },
                                        "exposedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of response headers to expose to CORS clients."
                                          }
                                        },
                                        "maxAgeInSeconds": {
                                          "type": "int",
                                          "metadata": {
                                            "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a cors rule.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "file-service/main.bicep",
                                          "originalIdentifier": "corsRuleType"
                                        }
                                      }
                                    },
                                    "fileShareType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the file share."
                                          }
                                        },
                                        "accessTier": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Cool",
                                            "Hot",
                                            "Premium",
                                            "TransactionOptimized"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Access tier for specific share. Required if the Storage Account kind is set to FileStorage (should be set to \"Premium\"). GpV2 account can choose between TransactionOptimized (default), Hot, and Cool."
                                          }
                                        },
                                        "enabledProtocols": {
                                          "type": "string",
                                          "allowedValues": [
                                            "NFS",
                                            "SMB"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The authentication protocol that is used for the file share. Can only be specified when creating a share."
                                          }
                                        },
                                        "rootSquash": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AllSquash",
                                            "NoRootSquash",
                                            "RootSquash"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Permissions for NFS file shares are enforced by the client OS rather than the Azure Files service. Toggling the root squash behavior reduces the rights of the root user for NFS shares."
                                          }
                                        },
                                        "shareQuota": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The maximum size of the share, in gigabytes. Must be greater than 0, and less than or equal to 5120 (5TB). For Large File Shares, the maximum size is 102400 (100TB)."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a file share.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "file-service/main.bicep"
                                        }
                                      }
                                    },
                                    "lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "notes": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the notes of the lock."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a lock.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "managedIdentityAllType": {
                                      "type": "object",
                                      "properties": {
                                        "systemAssigned": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enables system assigned managed identity on the resource."
                                          }
                                        },
                                        "userAssignedResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID(s) to assign to the resource. Required if a user assigned identity is used for encryption."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a managed identity configuration. To be used if both a system-assigned & user-assigned identities are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "objectReplicationPolicyRuleType": {
                                      "type": "object",
                                      "properties": {
                                        "ruleId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The ID of the rule. Auto-generated on destination account. Required for source account."
                                          }
                                        },
                                        "containerName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the source container."
                                          }
                                        },
                                        "destinationContainerName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the destination container. If not provided, the same name as the source container will be used."
                                          }
                                        },
                                        "filters": {
                                          "type": "object",
                                          "properties": {
                                            "prefixMatch": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The prefix to match for the replication policy rule."
                                              }
                                            },
                                            "minCreationTime": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The minimum creation time to match for the replication policy rule."
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The filters for the object replication policy rule."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type of an object replication policy rule.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "object-replication-policy/policy/main.bicep"
                                        }
                                      }
                                    },
                                    "permissionScopeType": {
                                      "type": "object",
                                      "properties": {
                                        "permissions": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The permissions for the local user. Possible values include: Read (r), Write (w), Delete (d), List (l), and Create (c)."
                                          }
                                        },
                                        "resourceName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of resource, normally the container name or the file share name, used by the local user."
                                          }
                                        },
                                        "service": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The service used by the local user, e.g. blob, file."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "local-user/main.bicep"
                                        }
                                      }
                                    },
                                    "privateEndpointMultiServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the private endpoint."
                                          }
                                        },
                                        "location": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The location to deploy the private endpoint to."
                                          }
                                        },
                                        "privateLinkServiceConnectionName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the private link connection to create."
                                          }
                                        },
                                        "service": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The subresource to deploy the private endpoint for. For example \"blob\", \"table\", \"queue\" or \"file\" for a Storage Account's Private Endpoints."
                                          }
                                        },
                                        "subnetResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                          }
                                        },
                                        "resourceGroupResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID of the Resource Group the Private Endpoint will be created in. If not specified, the Resource Group of the provided Virtual Network Subnet is used."
                                          }
                                        },
                                        "privateDnsZoneGroup": {
                                          "$ref": "#/definitions/_2.privateEndpointPrivateDnsZoneGroupType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The private DNS zone group to configure for the private endpoint."
                                          }
                                        },
                                        "isManualConnection": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. If Manual Private Link Connection is required."
                                          }
                                        },
                                        "manualConnectionRequestMessage": {
                                          "type": "string",
                                          "nullable": true,
                                          "maxLength": 140,
                                          "metadata": {
                                            "description": "Optional. A message passed to the owner of the remote resource with the manual connection request."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_2.privateEndpointCustomDnsConfigType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Custom DNS configurations."
                                          }
                                        },
                                        "ipConfigurations": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_2.privateEndpointIpConfigurationType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                          }
                                        },
                                        "applicationSecurityGroupResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                          }
                                        },
                                        "customNetworkInterfaceName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                          }
                                        },
                                        "lock": {
                                          "$ref": "#/definitions/lockType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Network/privateEndpoints@2024-07-01#properties/tags"
                                            },
                                            "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                          }
                                        },
                                        "enableTelemetry": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable/Disable usage telemetry for module."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a private endpoint. To be used if the private endpoint's default service / groupId can NOT be assumed (i.e., for services that have more than one subresource, like Storage Account with Blob (blob, table, queue, file, ...).",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "queueCorsRuleType": {
                                      "type": "object",
                                      "properties": {
                                        "allowedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                          }
                                        },
                                        "allowedMethods": {
                                          "type": "array",
                                          "allowedValues": [
                                            "CONNECT",
                                            "DELETE",
                                            "GET",
                                            "HEAD",
                                            "MERGE",
                                            "OPTIONS",
                                            "PATCH",
                                            "POST",
                                            "PUT",
                                            "TRACE"
                                          ],
                                          "metadata": {
                                            "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                          }
                                        },
                                        "allowedOrigins": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                          }
                                        },
                                        "exposedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of response headers to expose to CORS clients."
                                          }
                                        },
                                        "maxAgeInSeconds": {
                                          "type": "int",
                                          "metadata": {
                                            "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a cors rule.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "queue-service/main.bicep",
                                          "originalIdentifier": "corsRuleType"
                                        }
                                      }
                                    },
                                    "queueType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the queue."
                                          }
                                        },
                                        "metadata": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Storage/storageAccounts/queueServices/queues@2024-01-01#properties/properties/properties/metadata"
                                            },
                                            "description": "Optional. Metadata to set on the queue."
                                          },
                                          "nullable": true
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a queue.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "queue-service/main.bicep"
                                        }
                                      }
                                    },
                                    "roleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "roleDefinitionIdOrName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                          }
                                        },
                                        "principalType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Device",
                                            "ForeignGroup",
                                            "Group",
                                            "ServicePrincipal",
                                            "User"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The principal type of the assigned principal ID."
                                          }
                                        },
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The description of the role assignment."
                                          }
                                        },
                                        "condition": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                          }
                                        },
                                        "conditionVersion": {
                                          "type": "string",
                                          "allowedValues": [
                                            "2.0"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Version of the condition."
                                          }
                                        },
                                        "delegatedManagedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a role assignment.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "secretsOutputType": {
                                      "type": "object",
                                      "properties": {},
                                      "additionalProperties": {
                                        "$ref": "#/definitions/_2.secretSetOutputType",
                                        "metadata": {
                                          "description": "An exported secret's references."
                                        }
                                      },
                                      "metadata": {
                                        "description": "A map of the exported secrets",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "sshAuthorizedKeyType": {
                                      "type": "object",
                                      "properties": {
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Description used to store the function/usage of the key."
                                          }
                                        },
                                        "key": {
                                          "type": "securestring",
                                          "metadata": {
                                            "description": "Required. SSH public key base64 encoded. The format should be: '{keyType} {keyData}', e.g. ssh-rsa AAAABBBB."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "local-user/main.bicep"
                                        }
                                      }
                                    },
                                    "tableCorsRuleType": {
                                      "type": "object",
                                      "properties": {
                                        "allowedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                          }
                                        },
                                        "allowedMethods": {
                                          "type": "array",
                                          "allowedValues": [
                                            "CONNECT",
                                            "DELETE",
                                            "GET",
                                            "HEAD",
                                            "MERGE",
                                            "OPTIONS",
                                            "PATCH",
                                            "POST",
                                            "PUT",
                                            "TRACE"
                                          ],
                                          "metadata": {
                                            "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                          }
                                        },
                                        "allowedOrigins": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                          }
                                        },
                                        "exposedHeaders": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of response headers to expose to CORS clients."
                                          }
                                        },
                                        "maxAgeInSeconds": {
                                          "type": "int",
                                          "metadata": {
                                            "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a cors rule.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "table-service/main.bicep",
                                          "originalIdentifier": "corsRuleType"
                                        }
                                      }
                                    },
                                    "tableType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the table."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for a table.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "table-service/main.bicep"
                                        }
                                      }
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string",
                                      "maxLength": 24,
                                      "metadata": {
                                        "description": "Required. Name of the Storage Account. Must be lower-case."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Location for all resources."
                                      }
                                    },
                                    "extendedLocationZone": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Extended Zone location (ex 'losangeles'). When supplied, the storage account will be created in the specified zone under the parent location. The extended zone must be available in the supplied parent location."
                                      }
                                    },
                                    "roleAssignments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/roleAssignmentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Array of role assignments to create."
                                      }
                                    },
                                    "managedIdentities": {
                                      "$ref": "#/definitions/managedIdentityAllType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The managed identity definition for this resource."
                                      }
                                    },
                                    "kind": {
                                      "type": "string",
                                      "defaultValue": "StorageV2",
                                      "allowedValues": [
                                        "Storage",
                                        "StorageV2",
                                        "BlobStorage",
                                        "FileStorage",
                                        "BlockBlobStorage"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Type of Storage Account to create."
                                      }
                                    },
                                    "skuName": {
                                      "type": "string",
                                      "defaultValue": "Standard_GRS",
                                      "allowedValues": [
                                        "Standard_LRS",
                                        "Standard_ZRS",
                                        "Standard_GRS",
                                        "Standard_GZRS",
                                        "Standard_RAGRS",
                                        "Standard_RAGZRS",
                                        "StandardV2_LRS",
                                        "StandardV2_ZRS",
                                        "StandardV2_GRS",
                                        "StandardV2_GZRS",
                                        "Premium_LRS",
                                        "Premium_ZRS",
                                        "PremiumV2_LRS",
                                        "PremiumV2_ZRS"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Storage Account Sku Name - note: certain V2 SKUs require the use of: kind = FileStorage."
                                      }
                                    },
                                    "accessTier": {
                                      "type": "string",
                                      "defaultValue": "Hot",
                                      "allowedValues": [
                                        "Premium",
                                        "Hot",
                                        "Cool",
                                        "Cold"
                                      ],
                                      "metadata": {
                                        "description": "Conditional. Required if the Storage Account kind is set to BlobStorage. The access tier is used for billing. The \"Premium\" access tier is the default value for premium block blobs storage account type and it cannot be changed for the premium block blobs storage account type."
                                      }
                                    },
                                    "largeFileSharesState": {
                                      "type": "string",
                                      "defaultValue": "Disabled",
                                      "allowedValues": [
                                        "Disabled",
                                        "Enabled"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Allow large file shares if set to 'Enabled'. It cannot be disabled once it is enabled. Only supported on locally redundant and zone redundant file shares. It cannot be set on FileStorage storage accounts (storage accounts for premium file shares)."
                                      }
                                    },
                                    "azureFilesIdentityBasedAuthentication": {
                                      "type": "object",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.Storage/storageAccounts@2025-01-01#properties/properties/properties/azureFilesIdentityBasedAuthentication"
                                        },
                                        "description": "Optional. Provides the identity based authentication settings for Azure Files."
                                      },
                                      "nullable": true
                                    },
                                    "defaultToOAuthAuthentication": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. A boolean flag which indicates whether the default authentication is OAuth or not."
                                      }
                                    },
                                    "allowSharedKeyAccess": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Indicates whether the storage account permits requests to be authorized with the account access key via Shared Key. If false, then all requests, including shared access signatures, must be authorized with Azure Active Directory (Azure AD). The default value is null, which is equivalent to true."
                                      }
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointMultiServiceType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration details for private endpoints. For security reasons, it is recommended to use private endpoints whenever possible."
                                      }
                                    },
                                    "managementPolicyRules": {
                                      "type": "array",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.Storage/storageAccounts/managementPolicies@2025-01-01#properties/properties/properties/policy/properties/rules"
                                        },
                                        "description": "Optional. The Storage Account ManagementPolicies Rules."
                                      },
                                      "nullable": true
                                    },
                                    "networkAcls": {
                                      "$ref": "#/definitions/networkAclsType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Networks ACLs, this value contains IPs to whitelist and/or Subnet information. If in use, bypass needs to be supplied. For security reasons, it is recommended to set the DefaultAction Deny."
                                      }
                                    },
                                    "requireInfrastructureEncryption": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. A Boolean indicating whether or not the service applies a secondary layer of encryption with platform managed keys for data at rest. For security reasons, it is recommended to set it to true."
                                      }
                                    },
                                    "allowCrossTenantReplication": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Allow or disallow cross AAD tenant object replication."
                                      }
                                    },
                                    "customDomainName": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "metadata": {
                                        "description": "Optional. Sets the custom domain name assigned to the storage account. Name is the CNAME source."
                                      }
                                    },
                                    "customDomainUseSubDomainName": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Indicates whether indirect CName validation is enabled. This should only be set on updates."
                                      }
                                    },
                                    "dnsEndpointType": {
                                      "type": "string",
                                      "nullable": true,
                                      "allowedValues": [
                                        "AzureDnsZone",
                                        "Standard"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Allows you to specify the type of endpoint. Set this to AzureDNSZone to create a large number of accounts in a single subscription, which creates accounts in an Azure DNS Zone and the endpoint URL will have an alphanumeric DNS Zone identifier."
                                      }
                                    },
                                    "blobServices": {
                                      "$ref": "#/definitions/blobServiceType",
                                      "defaultValue": "[if(not(equals(parameters('kind'), 'FileStorage')), createObject('containerDeleteRetentionPolicyEnabled', true(), 'containerDeleteRetentionPolicyDays', 7, 'deleteRetentionPolicyEnabled', true(), 'deleteRetentionPolicyDays', 6), createObject())]",
                                      "metadata": {
                                        "description": "Optional. Blob service and containers to deploy."
                                      }
                                    },
                                    "fileServices": {
                                      "$ref": "#/definitions/fileServiceType",
                                      "defaultValue": {},
                                      "metadata": {
                                        "description": "Optional. File service and shares to deploy."
                                      }
                                    },
                                    "queueServices": {
                                      "$ref": "#/definitions/queueServiceType",
                                      "defaultValue": {},
                                      "metadata": {
                                        "description": "Optional. Queue service and queues to create."
                                      }
                                    },
                                    "tableServices": {
                                      "$ref": "#/definitions/tableServiceType",
                                      "defaultValue": {},
                                      "metadata": {
                                        "description": "Optional. Table service and tables to create."
                                      }
                                    },
                                    "allowBlobPublicAccess": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Indicates whether public access is enabled for all blobs or containers in the storage account. For security reasons, it is recommended to set it to false."
                                      }
                                    },
                                    "minimumTlsVersion": {
                                      "type": "string",
                                      "defaultValue": "TLS1_2",
                                      "allowedValues": [
                                        "TLS1_2"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Set the minimum TLS version on request to storage. The TLS versions 1.0 and 1.1 are deprecated and not supported anymore."
                                      }
                                    },
                                    "enableHierarchicalNamespace": {
                                      "type": "bool",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Conditional. If true, enables Hierarchical Namespace for the storage account. Required if enableSftp or enableNfsV3 is set to true."
                                      }
                                    },
                                    "enableSftp": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. If true, enables Secure File Transfer Protocol for the storage account. Requires enableHierarchicalNamespace to be true."
                                      }
                                    },
                                    "localUsers": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/localUserType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Local users to deploy for SFTP authentication."
                                      }
                                    },
                                    "isLocalUserEnabled": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Enables local users feature, if set to true."
                                      }
                                    },
                                    "enableNfsV3": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. If true, enables NFS 3.0 support for the storage account. Requires enableHierarchicalNamespace to be true."
                                      }
                                    },
                                    "diagnosticSettings": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/diagnosticSettingMetricsOnlyType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The diagnostic settings of the service."
                                      }
                                    },
                                    "lock": {
                                      "$ref": "#/definitions/lockType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The lock settings of the service."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.Storage/storageAccounts@2025-01-01#properties/tags"
                                        },
                                        "description": "Optional. Tags of the resource."
                                      },
                                      "nullable": true
                                    },
                                    "enableTelemetry": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                      }
                                    },
                                    "allowedCopyScope": {
                                      "type": "string",
                                      "nullable": true,
                                      "allowedValues": [
                                        "AAD",
                                        "PrivateLink"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Restrict copy to and from Storage Accounts within an AAD tenant or with Private Links to the same VNet."
                                      }
                                    },
                                    "publicNetworkAccess": {
                                      "type": "string",
                                      "nullable": true,
                                      "allowedValues": [
                                        "Enabled",
                                        "Disabled"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Whether or not public network access is allowed for this resource. For security reasons it should be disabled. If not specified, it will be disabled by default if private endpoints are set and networkAcls are not set."
                                      }
                                    },
                                    "supportsHttpsTrafficOnly": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Allows HTTPS traffic only to storage service if sets to true."
                                      }
                                    },
                                    "customerManagedKey": {
                                      "$ref": "#/definitions/customerManagedKeyWithAutoRotateType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The customer managed key definition."
                                      }
                                    },
                                    "sasExpirationPeriod": {
                                      "type": "string",
                                      "defaultValue": "",
                                      "metadata": {
                                        "description": "Optional. The SAS expiration period. DD.HH:MM:SS."
                                      }
                                    },
                                    "sasExpirationAction": {
                                      "type": "string",
                                      "defaultValue": "Log",
                                      "allowedValues": [
                                        "Block",
                                        "Log"
                                      ],
                                      "metadata": {
                                        "description": "Optional. The SAS expiration action. Allowed values are Block and Log."
                                      }
                                    },
                                    "keyType": {
                                      "type": "string",
                                      "nullable": true,
                                      "allowedValues": [
                                        "Account",
                                        "Service"
                                      ],
                                      "metadata": {
                                        "description": "Optional. The keyType to use with Queue & Table services."
                                      }
                                    },
                                    "secretsExportConfiguration": {
                                      "$ref": "#/definitions/secretsExportConfigurationType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Key vault reference and secret settings for the module's secrets export."
                                      }
                                    },
                                    "immutableStorageWithVersioning": {
                                      "type": "object",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.Storage/storageAccounts@2025-01-01#properties/properties/properties/immutableStorageWithVersioning"
                                        },
                                        "description": "Optional. The property is immutable and can only be set to true at the account creation time. When set to true, it enables object level immutability for all the new containers in the account by default. Cannot be enabled for ADLS Gen2 storage accounts."
                                      },
                                      "nullable": true
                                    },
                                    "objectReplicationPolicies": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/objectReplicationPolicyType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Object replication policies for the storage account."
                                      }
                                    }
                                  },
                                  "variables": {
                                    "copy": [
                                      {
                                        "name": "formattedRoleAssignments",
                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                      }
                                    ],
                                    "enableReferencedModulesTelemetry": false,
                                    "immutabilityValidation": "[if(and(equals(parameters('enableHierarchicalNamespace'), true()), not(empty(parameters('immutableStorageWithVersioning')))), fail('Configuration error: Immutable storage with versioning cannot be enabled when hierarchical namespace is enabled.'), null())]",
                                    "supportsBlobService": "[or(or(or(equals(parameters('kind'), 'BlockBlobStorage'), equals(parameters('kind'), 'BlobStorage')), equals(parameters('kind'), 'StorageV2')), equals(parameters('kind'), 'Storage'))]",
                                    "supportsFileService": "[or(or(equals(parameters('kind'), 'FileStorage'), equals(parameters('kind'), 'StorageV2')), equals(parameters('kind'), 'Storage'))]",
                                    "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
                                    "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', if(coalesce(tryGet(parameters('managedIdentities'), 'systemAssigned'), false()), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'UserAssigned', 'None')), 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
                                    "builtInRoleNames": {
                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                      "Reader and Data Access": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c12c1c16-33a1-487b-954d-41c89c60f349')]",
                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                      "Storage Account Backup Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e5e2a7ff-d759-4cd2-bb51-3152d37e2eb1')]",
                                      "Storage Account Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
                                      "Storage Account Key Operator Service Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '81a9662b-bebf-436f-a333-f67b29880f12')]",
                                      "Storage Blob Data Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                                      "Storage Blob Data Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                                      "Storage Blob Data Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                                      "Storage Blob Delegator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db58b8e5-c6ad-4a2a-8342-4190687cbf4a')]",
                                      "Storage File Data Privileged Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '69566ab7-960f-475b-8e7c-b3118f30c6bd')]",
                                      "Storage File Data Privileged Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b8eda974-7b85-4f76-af95-65846b26df6d')]",
                                      "Storage File Data SMB Share Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb')]",
                                      "Storage File Data SMB Share Elevated Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a7264617-510b-434b-a828-9731dc254ea7')]",
                                      "Storage File Data SMB Share Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'aba4ae5f-2193-4029-9191-0cb91df5e314')]",
                                      "Storage Queue Data Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '974c5e8b-45b9-4653-ba55-5f855dd0fb88')]",
                                      "Storage Queue Data Message Processor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8a0f0c08-91a1-4084-bc3d-661d67233fed')]",
                                      "Storage Queue Data Message Sender": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c6a89b2d-59bc-44d0-9896-0f6e12d7b80a')]",
                                      "Storage Queue Data Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '19e7f393-937e-4f77-808e-94535e297925')]",
                                      "Storage Table Data Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3')]",
                                      "Storage Table Data Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '76199698-9eea-4c19-bc75-cec21354c6b6')]",
                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                    },
                                    "formattedManagementPolicies": "[union(coalesce(parameters('managementPolicyRules'), createArray()), if(and(and(not(empty(parameters('blobServices'))), coalesce(tryGet(parameters('blobServices'), 'isVersioningEnabled'), false())), not(equals(tryGet(parameters('blobServices'), 'versionDeletePolicyDays'), null()))), createArray(createObject('name', 'DeletePreviousVersions (auto-created)', 'enabled', true(), 'type', 'Lifecycle', 'definition', createObject('actions', createObject('version', createObject('delete', createObject('daysAfterCreationGreaterThan', parameters('blobServices').versionDeletePolicyDays))), 'filters', createObject('blobTypes', createArray('blockBlob', 'appendBlob'))))), createArray()))]"
                                  },
                                  "resources": {
                                    "cMKKeyVault::cMKKey": {
                                      "condition": "[and(not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'))), and(not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'))), not(empty(tryGet(parameters('customerManagedKey'), 'keyName')))))]",
                                      "existing": true,
                                      "type": "Microsoft.KeyVault/vaults/keys",
                                      "apiVersion": "2024-11-01",
                                      "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[4]]",
                                      "name": "[format('{0}/{1}', last(split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')), tryGet(parameters('customerManagedKey'), 'keyName'))]"
                                    },
                                    "avmTelemetry": {
                                      "condition": "[parameters('enableTelemetry')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('46d3xbcp.res.storage-storageaccount.{0}.{1}', replace('0.28.0', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                      "properties": {
                                        "mode": "Incremental",
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "resources": [],
                                          "outputs": {
                                            "telemetry": {
                                              "type": "String",
                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "cMKKeyVault": {
                                      "condition": "[not(empty(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId')))]",
                                      "existing": true,
                                      "type": "Microsoft.KeyVault/vaults",
                                      "apiVersion": "2025-05-01",
                                      "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/')[4]]",
                                      "name": "[last(split(tryGet(parameters('customerManagedKey'), 'keyVaultResourceId'), '/'))]"
                                    },
                                    "cMKUserAssignedIdentity": {
                                      "condition": "[not(empty(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId')))]",
                                      "existing": true,
                                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                                      "apiVersion": "2024-11-30",
                                      "subscriptionId": "[split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/')[4]]",
                                      "name": "[last(split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/'))]"
                                    },
                                    "storageAccount": {
                                      "type": "Microsoft.Storage/storageAccounts",
                                      "apiVersion": "2025-01-01",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "extendedLocation": "[if(not(empty(parameters('extendedLocationZone'))), createObject('name', parameters('extendedLocationZone'), 'type', 'EdgeZone'), null())]",
                                      "kind": "[parameters('kind')]",
                                      "sku": {
                                        "name": "[parameters('skuName')]"
                                      },
                                      "identity": "[variables('identity')]",
                                      "tags": "[parameters('tags')]",
                                      "properties": "[shallowMerge(createArray(createObject('allowSharedKeyAccess', parameters('allowSharedKeyAccess'), 'defaultToOAuthAuthentication', parameters('defaultToOAuthAuthentication'), 'allowCrossTenantReplication', parameters('allowCrossTenantReplication'), 'allowedCopyScope', parameters('allowedCopyScope'), 'customDomain', createObject('name', parameters('customDomainName'), 'useSubDomainName', parameters('customDomainUseSubDomainName')), 'dnsEndpointType', parameters('dnsEndpointType'), 'isLocalUserEnabled', parameters('isLocalUserEnabled'), 'encryption', union(createObject('keySource', if(not(empty(parameters('customerManagedKey'))), 'Microsoft.Keyvault', 'Microsoft.Storage'), 'services', createObject('blob', if(variables('supportsBlobService'), createObject('enabled', true()), null()), 'file', if(variables('supportsFileService'), createObject('enabled', true()), null()), 'table', createObject('enabled', true(), 'keyType', parameters('keyType')), 'queue', createObject('enabled', true(), 'keyType', parameters('keyType'))), 'keyvaultproperties', if(not(empty(parameters('customerManagedKey'))), createObject('keyname', parameters('customerManagedKey').keyName, 'keyvaulturi', reference('cMKKeyVault').vaultUri, 'keyversion', if(not(empty(tryGet(parameters('customerManagedKey'), 'keyVersion'))), parameters('customerManagedKey').keyVersion, if(coalesce(tryGet(parameters('customerManagedKey'), 'autoRotationEnabled'), true()), null(), last(split(reference('cMKKeyVault::cMKKey').keyUriWithVersion, '/'))))), null()), 'identity', createObject('userAssignedIdentity', if(not(empty(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'))), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/')[2], split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/')[4]), 'Microsoft.ManagedIdentity/userAssignedIdentities', last(split(tryGet(parameters('customerManagedKey'), 'userAssignedIdentityResourceId'), '/'))), null()))), if(parameters('requireInfrastructureEncryption'), createObject('requireInfrastructureEncryption', if(not(equals(parameters('kind'), 'Storage')), parameters('requireInfrastructureEncryption'), null())), createObject())), 'accessTier', if(and(not(equals(parameters('kind'), 'Storage')), not(equals(parameters('kind'), 'BlockBlobStorage'))), parameters('accessTier'), null()), 'sasPolicy', if(not(empty(parameters('sasExpirationPeriod'))), createObject('expirationAction', parameters('sasExpirationAction'), 'sasExpirationPeriod', parameters('sasExpirationPeriod')), null()), 'supportsHttpsTrafficOnly', parameters('supportsHttpsTrafficOnly'), 'isSftpEnabled', parameters('enableSftp'), 'isNfsV3Enabled', if(parameters('enableNfsV3'), parameters('enableNfsV3'), ''), 'largeFileSharesState', if(or(equals(parameters('skuName'), 'Standard_LRS'), equals(parameters('skuName'), 'Standard_ZRS')), parameters('largeFileSharesState'), null()), 'minimumTlsVersion', parameters('minimumTlsVersion'), 'networkAcls', if(not(empty(parameters('networkAcls'))), union(createObject('resourceAccessRules', tryGet(parameters('networkAcls'), 'resourceAccessRules'), 'defaultAction', coalesce(tryGet(parameters('networkAcls'), 'defaultAction'), 'Deny'), 'virtualNetworkRules', tryGet(parameters('networkAcls'), 'virtualNetworkRules'), 'ipRules', tryGet(parameters('networkAcls'), 'ipRules')), if(contains(parameters('networkAcls'), 'bypass'), createObject('bypass', tryGet(parameters('networkAcls'), 'bypass')), createObject())), createObject('bypass', 'AzureServices', 'defaultAction', 'Deny')), 'allowBlobPublicAccess', parameters('allowBlobPublicAccess'), 'publicNetworkAccess', if(not(empty(parameters('publicNetworkAccess'))), parameters('publicNetworkAccess'), if(and(not(empty(parameters('privateEndpoints'))), empty(parameters('networkAcls'))), 'Disabled', null()))), if(not(empty(parameters('azureFilesIdentityBasedAuthentication'))), createObject('azureFilesIdentityBasedAuthentication', parameters('azureFilesIdentityBasedAuthentication')), createObject()), if(not(equals(parameters('enableHierarchicalNamespace'), null())), createObject('isHnsEnabled', parameters('enableHierarchicalNamespace')), createObject()), createObject('immutableStorageWithVersioning', parameters('immutableStorageWithVersioning'))))]",
                                      "dependsOn": [
                                        "cMKKeyVault",
                                        "cMKKeyVault::cMKKey"
                                      ]
                                    },
                                    "storageAccount_diagnosticSettings": {
                                      "copy": {
                                        "name": "storageAccount_diagnosticSettings",
                                        "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                      },
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                                      "properties": {
                                        "copy": [
                                          {
                                            "name": "metrics",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                            "input": {
                                              "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                              "timeGrain": null
                                            }
                                          }
                                        ],
                                        "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                        "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                        "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                        "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                        "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                        "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_lock": {
                                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                      "type": "Microsoft.Authorization/locks",
                                      "apiVersion": "2020-05-01",
                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                      "properties": {
                                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                        "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_roleAssignments": {
                                      "copy": {
                                        "name": "storageAccount_roleAssignments",
                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                      "properties": {
                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_privateEndpoints": {
                                      "copy": {
                                        "name": "storageAccount_privateEndpoints",
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-sa-PrivateEndpoint-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "subscriptionId": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[2]]",
                                      "resourceGroup": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'name'), format('pep-{0}-{1}-{2}', last(split(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '/')), coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service, copyIndex()))]"
                                          },
                                          "privateLinkServiceConnections": "[if(not(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true())), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '/')), coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service, copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.Storage/storageAccounts', parameters('name')), 'groupIds', createArray(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service))))), createObject('value', null()))]",
                                          "manualPrivateLinkServiceConnections": "[if(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true()), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '/')), coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service, copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.Storage/storageAccounts', parameters('name')), 'groupIds', createArray(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service), 'requestMessage', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'manualConnectionRequestMessage'), 'Manual approval required.'))))), createObject('value', null()))]",
                                          "subnetResourceId": {
                                            "value": "[coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          },
                                          "location": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'location'), reference(split(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                                          },
                                          "lock": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'lock'), parameters('lock'))]"
                                          },
                                          "privateDnsZoneGroup": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateDnsZoneGroup')]"
                                          },
                                          "roleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'roleAssignments')]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "customDnsConfigs": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customDnsConfigs')]"
                                          },
                                          "ipConfigurations": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'ipConfigurations')]"
                                          },
                                          "applicationSecurityGroupResourceIds": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'applicationSecurityGroupResourceIds')]"
                                          },
                                          "customNetworkInterfaceName": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customNetworkInterfaceName')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.5.1644",
                                              "templateHash": "16604612898799598358"
                                            },
                                            "name": "Private Endpoints",
                                            "description": "This module deploys a Private Endpoint."
                                          },
                                          "definitions": {
                                            "privateDnsZoneGroupType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the Private DNS Zone Group."
                                                  }
                                                },
                                                "privateDnsZoneGroupConfigs": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. The private DNS zone groups to associate the private endpoint. A DNS zone group can support up to 5 DNS zones."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a private dns zone group."
                                              }
                                            },
                                            "lockType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the name of lock."
                                                  }
                                                },
                                                "kind": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "CanNotDelete",
                                                    "None",
                                                    "ReadOnly"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the type of lock."
                                                  }
                                                },
                                                "notes": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the notes of the lock."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a lock.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            },
                                            "privateDnsZoneGroupConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the private DNS zone group config."
                                                  }
                                                },
                                                "privateDnsZoneResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The resource id of the private DNS zone."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "The type of a private DNS zone group configuration.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "private-dns-zone-group/main.bicep"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the private endpoint resource to create."
                                              }
                                            },
                                            "subnetResourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                              }
                                            },
                                            "applicationSecurityGroupResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                              }
                                            },
                                            "customNetworkInterfaceName": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                              }
                                            },
                                            "ipConfigurations": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/ipConfigurations"
                                                },
                                                "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                              },
                                              "nullable": true
                                            },
                                            "privateDnsZoneGroup": {
                                              "$ref": "#/definitions/privateDnsZoneGroupType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The private DNS zone group to configure for the private endpoint."
                                              }
                                            },
                                            "location": {
                                              "type": "string",
                                              "defaultValue": "[resourceGroup().location]",
                                              "metadata": {
                                                "description": "Optional. Location for all Resources."
                                              }
                                            },
                                            "lock": {
                                              "$ref": "#/definitions/lockType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The lock settings of the service."
                                              }
                                            },
                                            "roleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/roleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of role assignments to create."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/tags"
                                                },
                                                "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                              },
                                              "nullable": true
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/customDnsConfigs"
                                                },
                                                "description": "Optional. Custom DNS configurations."
                                              },
                                              "nullable": true
                                            },
                                            "manualPrivateLinkServiceConnections": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/manualPrivateLinkServiceConnections"
                                                },
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Used when the network admin does not have access to approve connections to the remote resource. Required if `privateLinkServiceConnections` is empty."
                                              },
                                              "nullable": true
                                            },
                                            "privateLinkServiceConnections": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/privateLinkServiceConnections"
                                                },
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Required if `manualPrivateLinkServiceConnections` is empty."
                                              },
                                              "nullable": true
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "formattedRoleAssignments",
                                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                              }
                                            ],
                                            "builtInRoleNames": {
                                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                              "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                                              "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                                              "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                                              "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                                              "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                              "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('46d3xbcp.res.network-privateendpoint.{0}.{1}', replace('0.11.1', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "privateEndpoint": {
                                              "type": "Microsoft.Network/privateEndpoints",
                                              "apiVersion": "2024-10-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "applicationSecurityGroups",
                                                    "count": "[length(coalesce(parameters('applicationSecurityGroupResourceIds'), createArray()))]",
                                                    "input": {
                                                      "id": "[coalesce(parameters('applicationSecurityGroupResourceIds'), createArray())[copyIndex('applicationSecurityGroups')]]"
                                                    }
                                                  }
                                                ],
                                                "customDnsConfigs": "[coalesce(parameters('customDnsConfigs'), createArray())]",
                                                "customNetworkInterfaceName": "[coalesce(parameters('customNetworkInterfaceName'), '')]",
                                                "ipConfigurations": "[coalesce(parameters('ipConfigurations'), createArray())]",
                                                "manualPrivateLinkServiceConnections": "[coalesce(parameters('manualPrivateLinkServiceConnections'), createArray())]",
                                                "privateLinkServiceConnections": "[coalesce(parameters('privateLinkServiceConnections'), createArray())]",
                                                "subnet": {
                                                  "id": "[parameters('subnetResourceId')]"
                                                }
                                              }
                                            },
                                            "privateEndpoint_lock": {
                                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                              "type": "Microsoft.Authorization/locks",
                                              "apiVersion": "2020-05-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                              "properties": {
                                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                                "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_roleAssignments": {
                                              "copy": {
                                                "name": "privateEndpoint_roleAssignments",
                                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2022-04-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                              "properties": {
                                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_privateDnsZoneGroup": {
                                              "condition": "[not(empty(parameters('privateDnsZoneGroup')))]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-PrivateEndpoint-PrivateDnsZoneGroup', uniqueString(deployment().name))]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[tryGet(parameters('privateDnsZoneGroup'), 'name')]"
                                                  },
                                                  "privateEndpointName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "privateDnsZoneConfigs": {
                                                    "value": "[parameters('privateDnsZoneGroup').privateDnsZoneGroupConfigs]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.5.1644",
                                                      "templateHash": "24141742673128945"
                                                    },
                                                    "name": "Private Endpoint Private DNS Zone Groups",
                                                    "description": "This module deploys a Private Endpoint Private DNS Zone Group."
                                                  },
                                                  "definitions": {
                                                    "privateDnsZoneGroupConfigType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name of the private DNS zone group config."
                                                          }
                                                        },
                                                        "privateDnsZoneResourceId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The resource id of the private DNS zone."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true,
                                                        "description": "The type of a private DNS zone group configuration."
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "privateEndpointName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "privateDnsZoneConfigs": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                      },
                                                      "minLength": 1,
                                                      "maxLength": 5,
                                                      "metadata": {
                                                        "description": "Required. Array of private DNS zone configurations of the private DNS zone group. A DNS zone group can support up to 5 DNS zones."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "defaultValue": "default",
                                                      "metadata": {
                                                        "description": "Optional. The name of the private DNS zone group."
                                                      }
                                                    }
                                                  },
                                                  "resources": {
                                                    "privateEndpoint": {
                                                      "existing": true,
                                                      "type": "Microsoft.Network/privateEndpoints",
                                                      "apiVersion": "2024-10-01",
                                                      "name": "[parameters('privateEndpointName')]"
                                                    },
                                                    "privateDnsZoneGroup": {
                                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                                      "apiVersion": "2024-10-01",
                                                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                                      "properties": {
                                                        "copy": [
                                                          {
                                                            "name": "privateDnsZoneConfigs",
                                                            "count": "[length(parameters('privateDnsZoneConfigs'))]",
                                                            "input": {
                                                              "name": "[coalesce(tryGet(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigs')], 'name'), last(split(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigs')].privateDnsZoneResourceId, '/')))]",
                                                              "properties": {
                                                                "privateDnsZoneId": "[parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigs')].privateDnsZoneResourceId]"
                                                              }
                                                            }
                                                          }
                                                        ]
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group the private endpoint DNS zone group was deployed into."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group the private endpoint was deployed into."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the private endpoint."
                                              },
                                              "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the private endpoint."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "location": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The location the resource was deployed into."
                                              },
                                              "value": "[reference('privateEndpoint', '2024-10-01', 'full').location]"
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/customDnsConfigs",
                                                  "output": true
                                                },
                                                "description": "The custom DNS configurations of the private endpoint."
                                              },
                                              "value": "[reference('privateEndpoint').customDnsConfigs]"
                                            },
                                            "networkInterfaceResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "metadata": {
                                                "description": "The resource IDs of the network interfaces associated with the private endpoint."
                                              },
                                              "value": "[map(reference('privateEndpoint').networkInterfaces, lambda('nic', lambdaVariables('nic').id))]"
                                            },
                                            "groupId": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "The group Id for the private endpoint Group."
                                              },
                                              "value": "[coalesce(tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'manualPrivateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0), tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'privateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_managementPolicies": {
                                      "condition": "[not(empty(coalesce(variables('formattedManagementPolicies'), createArray())))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-Storage-ManagementPolicies', uniqueString(deployment().name, parameters('location')))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "storageAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "rules": {
                                            "value": "[variables('formattedManagementPolicies')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "6960218931054567030"
                                            },
                                            "name": "Storage Account Management Policies",
                                            "description": "This module deploys a Storage Account Management Policy."
                                          },
                                          "parameters": {
                                            "storageAccountName": {
                                              "type": "string",
                                              "maxLength": 24,
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "rules": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Storage/storageAccounts/managementPolicies@2024-01-01#properties/properties/properties/policy/properties/rules"
                                                },
                                                "description": "Required. The Storage Account ManagementPolicies Rules."
                                              }
                                            }
                                          },
                                          "resources": [
                                            {
                                              "type": "Microsoft.Storage/storageAccounts/managementPolicies",
                                              "apiVersion": "2024-01-01",
                                              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
                                              "properties": {
                                                "policy": {
                                                  "rules": "[parameters('rules')]"
                                                }
                                              }
                                            }
                                          ],
                                          "outputs": {
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the deployed management policy."
                                              },
                                              "value": "default"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the deployed management policy."
                                              },
                                              "value": "default"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group of the deployed management policy."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount",
                                        "storageAccount_blobServices"
                                      ]
                                    },
                                    "storageAccount_localUsers": {
                                      "copy": {
                                        "name": "storageAccount_localUsers",
                                        "count": "[length(coalesce(parameters('localUsers'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-Storage-LocalUsers-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "storageAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "name": {
                                            "value": "[coalesce(parameters('localUsers'), createArray())[copyIndex()].name]"
                                          },
                                          "hasSshKey": {
                                            "value": "[coalesce(parameters('localUsers'), createArray())[copyIndex()].hasSshKey]"
                                          },
                                          "hasSshPassword": {
                                            "value": "[coalesce(parameters('localUsers'), createArray())[copyIndex()].hasSshPassword]"
                                          },
                                          "permissionScopes": {
                                            "value": "[coalesce(parameters('localUsers'), createArray())[copyIndex()].permissionScopes]"
                                          },
                                          "hasSharedKey": {
                                            "value": "[tryGet(coalesce(parameters('localUsers'), createArray())[copyIndex()], 'hasSharedKey')]"
                                          },
                                          "homeDirectory": {
                                            "value": "[tryGet(coalesce(parameters('localUsers'), createArray())[copyIndex()], 'homeDirectory')]"
                                          },
                                          "sshAuthorizedKeys": {
                                            "value": "[tryGet(coalesce(parameters('localUsers'), createArray())[copyIndex()], 'sshAuthorizedKeys')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "9436518181019837288"
                                            },
                                            "name": "Storage Account Local Users",
                                            "description": "This module deploys a Storage Account Local User, which is used for SFTP authentication."
                                          },
                                          "definitions": {
                                            "sshAuthorizedKeyType": {
                                              "type": "object",
                                              "properties": {
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Description used to store the function/usage of the key."
                                                  }
                                                },
                                                "key": {
                                                  "type": "securestring",
                                                  "metadata": {
                                                    "description": "Required. SSH public key base64 encoded. The format should be: '{keyType} {keyData}', e.g. ssh-rsa AAAABBBB."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            },
                                            "permissionScopeType": {
                                              "type": "object",
                                              "properties": {
                                                "permissions": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The permissions for the local user. Possible values include: Read (r), Write (w), Delete (d), List (l), and Create (c)."
                                                  }
                                                },
                                                "resourceName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of resource, normally the container name or the file share name, used by the local user."
                                                  }
                                                },
                                                "service": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The service used by the local user, e.g. blob, file."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "storageAccountName": {
                                              "type": "string",
                                              "maxLength": 24,
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of the local user used for SFTP Authentication."
                                              }
                                            },
                                            "hasSharedKey": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. Indicates whether shared key exists. Set it to false to remove existing shared key."
                                              }
                                            },
                                            "hasSshKey": {
                                              "type": "bool",
                                              "metadata": {
                                                "description": "Required. Indicates whether SSH key exists. Set it to false to remove existing SSH key."
                                              }
                                            },
                                            "hasSshPassword": {
                                              "type": "bool",
                                              "metadata": {
                                                "description": "Required. Indicates whether SSH password exists. Set it to false to remove existing SSH password."
                                              }
                                            },
                                            "homeDirectory": {
                                              "type": "string",
                                              "defaultValue": "",
                                              "metadata": {
                                                "description": "Optional. The local user home directory."
                                              }
                                            },
                                            "permissionScopes": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/permissionScopeType"
                                              },
                                              "metadata": {
                                                "description": "Required. The permission scopes of the local user."
                                              }
                                            },
                                            "sshAuthorizedKeys": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/sshAuthorizedKeyType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The local user SSH authorized keys for SFTP."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "storageAccount": {
                                              "existing": true,
                                              "type": "Microsoft.Storage/storageAccounts",
                                              "apiVersion": "2024-01-01",
                                              "name": "[parameters('storageAccountName')]"
                                            },
                                            "localUsers": {
                                              "type": "Microsoft.Storage/storageAccounts/localUsers",
                                              "apiVersion": "2024-01-01",
                                              "name": "[format('{0}/{1}', parameters('storageAccountName'), parameters('name'))]",
                                              "properties": {
                                                "hasSharedKey": "[parameters('hasSharedKey')]",
                                                "hasSshKey": "[parameters('hasSshKey')]",
                                                "hasSshPassword": "[parameters('hasSshPassword')]",
                                                "homeDirectory": "[parameters('homeDirectory')]",
                                                "permissionScopes": "[parameters('permissionScopes')]",
                                                "sshAuthorizedKeys": "[parameters('sshAuthorizedKeys')]"
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the deployed local user."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group of the deployed local user."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the deployed local user."
                                              },
                                              "value": "[resourceId('Microsoft.Storage/storageAccounts/localUsers', parameters('storageAccountName'), parameters('name'))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_blobServices": {
                                      "condition": "[not(empty(parameters('blobServices')))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-Storage-BlobServices', uniqueString(deployment().name, parameters('location')))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "storageAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "containers": {
                                            "value": "[tryGet(parameters('blobServices'), 'containers')]"
                                          },
                                          "automaticSnapshotPolicyEnabled": {
                                            "value": "[tryGet(parameters('blobServices'), 'automaticSnapshotPolicyEnabled')]"
                                          },
                                          "changeFeedEnabled": {
                                            "value": "[tryGet(parameters('blobServices'), 'changeFeedEnabled')]"
                                          },
                                          "changeFeedRetentionInDays": {
                                            "value": "[tryGet(parameters('blobServices'), 'changeFeedRetentionInDays')]"
                                          },
                                          "containerDeleteRetentionPolicyEnabled": {
                                            "value": "[tryGet(parameters('blobServices'), 'containerDeleteRetentionPolicyEnabled')]"
                                          },
                                          "containerDeleteRetentionPolicyDays": {
                                            "value": "[tryGet(parameters('blobServices'), 'containerDeleteRetentionPolicyDays')]"
                                          },
                                          "containerDeleteRetentionPolicyAllowPermanentDelete": {
                                            "value": "[tryGet(parameters('blobServices'), 'containerDeleteRetentionPolicyAllowPermanentDelete')]"
                                          },
                                          "corsRules": {
                                            "value": "[tryGet(parameters('blobServices'), 'corsRules')]"
                                          },
                                          "defaultServiceVersion": {
                                            "value": "[tryGet(parameters('blobServices'), 'defaultServiceVersion')]"
                                          },
                                          "deleteRetentionPolicyAllowPermanentDelete": {
                                            "value": "[tryGet(parameters('blobServices'), 'deleteRetentionPolicyAllowPermanentDelete')]"
                                          },
                                          "deleteRetentionPolicyEnabled": {
                                            "value": "[tryGet(parameters('blobServices'), 'deleteRetentionPolicyEnabled')]"
                                          },
                                          "deleteRetentionPolicyDays": {
                                            "value": "[tryGet(parameters('blobServices'), 'deleteRetentionPolicyDays')]"
                                          },
                                          "isVersioningEnabled": {
                                            "value": "[tryGet(parameters('blobServices'), 'isVersioningEnabled')]"
                                          },
                                          "lastAccessTimeTrackingPolicyEnabled": {
                                            "value": "[tryGet(parameters('blobServices'), 'lastAccessTimeTrackingPolicyEnabled')]"
                                          },
                                          "restorePolicyEnabled": {
                                            "value": "[tryGet(parameters('blobServices'), 'restorePolicyEnabled')]"
                                          },
                                          "restorePolicyDays": {
                                            "value": "[tryGet(parameters('blobServices'), 'restorePolicyDays')]"
                                          },
                                          "diagnosticSettings": {
                                            "value": "[tryGet(parameters('blobServices'), 'diagnosticSettings')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "8062953820630056631"
                                            },
                                            "name": "Storage Account blob Services",
                                            "description": "This module deploys a Storage Account Blob Service."
                                          },
                                          "definitions": {
                                            "corsRuleType": {
                                              "type": "object",
                                              "properties": {
                                                "allowedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                                  }
                                                },
                                                "allowedMethods": {
                                                  "type": "array",
                                                  "allowedValues": [
                                                    "CONNECT",
                                                    "DELETE",
                                                    "GET",
                                                    "HEAD",
                                                    "MERGE",
                                                    "OPTIONS",
                                                    "PATCH",
                                                    "POST",
                                                    "PUT",
                                                    "TRACE"
                                                  ],
                                                  "metadata": {
                                                    "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                                  }
                                                },
                                                "allowedOrigins": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                                  }
                                                },
                                                "exposedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of response headers to expose to CORS clients."
                                                  }
                                                },
                                                "maxAgeInSeconds": {
                                                  "type": "int",
                                                  "metadata": {
                                                    "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a cors rule."
                                              }
                                            },
                                            "containerType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the Storage Container to deploy."
                                                  }
                                                },
                                                "defaultEncryptionScope": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Default the container to use specified encryption scope for all writes."
                                                  }
                                                },
                                                "denyEncryptionScopeOverride": {
                                                  "type": "bool",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Block override of encryption scope from the container default."
                                                  }
                                                },
                                                "enableNfsV3AllSquash": {
                                                  "type": "bool",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Enable NFSv3 all squash on blob container."
                                                  }
                                                },
                                                "enableNfsV3RootSquash": {
                                                  "type": "bool",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Enable NFSv3 root squash on blob container."
                                                  }
                                                },
                                                "immutableStorageWithVersioningEnabled": {
                                                  "type": "bool",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. This is an immutable property, when set to true it enables object level immutability at the container level. The property is immutable and can only be set to true at the container creation time. Existing containers must undergo a migration process."
                                                  }
                                                },
                                                "immutabilityPolicy": {
                                                  "$ref": "#/definitions/immutabilityPolicyType",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Configure immutability policy."
                                                  }
                                                },
                                                "metadata": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.Storage/storageAccounts/blobServices/containers@2024-01-01#properties/properties/properties/metadata"
                                                    },
                                                    "description": "Optional. A name-value pair to associate with the container as metadata."
                                                  },
                                                  "nullable": true
                                                },
                                                "publicAccess": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Blob",
                                                    "Container",
                                                    "None"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specifies whether data in the container may be accessed publicly and the level of access."
                                                  }
                                                },
                                                "roleAssignments": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/roleAssignmentType"
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Array of role assignments to create."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a storage container."
                                              }
                                            },
                                            "diagnosticSettingFullType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the diagnostic setting."
                                                  }
                                                },
                                                "logCategoriesAndGroups": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                        }
                                                      },
                                                      "categoryGroup": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                                  }
                                                },
                                                "metricCategories": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "metadata": {
                                                          "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                                  }
                                                },
                                                "logAnalyticsDestinationType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "AzureDiagnostics",
                                                    "Dedicated"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                                  }
                                                },
                                                "workspaceResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "storageAccountResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "eventHubAuthorizationRuleResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                                  }
                                                },
                                                "eventHubName": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "marketplacePartnerResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            },
                                            "immutabilityPolicyType": {
                                              "type": "object",
                                              "properties": {
                                                "immutabilityPeriodSinceCreationInDays": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The immutability period for the blobs in the container since the policy creation, in days."
                                                  }
                                                },
                                                "allowProtectedAppendWrites": {
                                                  "type": "bool",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to an append blob while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API."
                                                  }
                                                },
                                                "allowProtectedAppendWritesAll": {
                                                  "type": "bool",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to both \"Append and Block Blobs\" while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API. The \"allowProtectedAppendWrites\" and \"allowProtectedAppendWritesAll\" properties are mutually exclusive."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "The type for an immutability policy.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "container/main.bicep"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "storageAccountName": {
                                              "type": "string",
                                              "maxLength": 24,
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "automaticSnapshotPolicyEnabled": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. Automatic Snapshot is enabled if set to true."
                                              }
                                            },
                                            "changeFeedEnabled": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. The blob service properties for change feed events. Indicates whether change feed event logging is enabled for the Blob service."
                                              }
                                            },
                                            "changeFeedRetentionInDays": {
                                              "type": "int",
                                              "nullable": true,
                                              "minValue": 1,
                                              "maxValue": 146000,
                                              "metadata": {
                                                "description": "Optional. Indicates whether change feed event logging is enabled for the Blob service. Indicates the duration of changeFeed retention in days. If left blank, it indicates an infinite retention of the change feed."
                                              }
                                            },
                                            "containerDeleteRetentionPolicyEnabled": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. The blob service properties for container soft delete. Indicates whether DeleteRetentionPolicy is enabled."
                                              }
                                            },
                                            "containerDeleteRetentionPolicyDays": {
                                              "type": "int",
                                              "nullable": true,
                                              "minValue": 1,
                                              "maxValue": 365,
                                              "metadata": {
                                                "description": "Optional. Indicates the number of days that the deleted item should be retained."
                                              }
                                            },
                                            "containerDeleteRetentionPolicyAllowPermanentDelete": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. This property when set to true allows deletion of the soft deleted blob versions and snapshots. This property cannot be used with blob restore policy. This property only applies to blob service and does not apply to containers or file share."
                                              }
                                            },
                                            "corsRules": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/corsRuleType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                              }
                                            },
                                            "defaultServiceVersion": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Indicates the default version to use for requests to the Blob service if an incoming request's version is not specified. Possible values include version 2008-10-27 and all more recent versions."
                                              }
                                            },
                                            "deleteRetentionPolicyEnabled": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. The blob service properties for blob soft delete."
                                              }
                                            },
                                            "deleteRetentionPolicyDays": {
                                              "type": "int",
                                              "defaultValue": 7,
                                              "minValue": 1,
                                              "maxValue": 365,
                                              "metadata": {
                                                "description": "Optional. Indicates the number of days that the deleted blob should be retained."
                                              }
                                            },
                                            "deleteRetentionPolicyAllowPermanentDelete": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. This property when set to true allows deletion of the soft deleted blob versions and snapshots. This property cannot be used with blob restore policy. This property only applies to blob service and does not apply to containers or file share."
                                              }
                                            },
                                            "isVersioningEnabled": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. Use versioning to automatically maintain previous versions of your blobs. Cannot be enabled for ADLS Gen2 storage accounts."
                                              }
                                            },
                                            "lastAccessTimeTrackingPolicyEnabled": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. The blob service property to configure last access time based tracking policy. When set to true last access time based tracking is enabled."
                                              }
                                            },
                                            "restorePolicyEnabled": {
                                              "type": "bool",
                                              "defaultValue": false,
                                              "metadata": {
                                                "description": "Optional. The blob service properties for blob restore policy. If point-in-time restore is enabled, then versioning, change feed, and blob soft delete must also be enabled."
                                              }
                                            },
                                            "restorePolicyDays": {
                                              "type": "int",
                                              "defaultValue": 7,
                                              "minValue": 1,
                                              "metadata": {
                                                "description": "Optional. How long this blob can be restored. It should be less than DeleteRetentionPolicy days."
                                              }
                                            },
                                            "containers": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/containerType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Blob containers to create."
                                              }
                                            },
                                            "diagnosticSettings": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/diagnosticSettingFullType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The diagnostic settings of the service."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "enableReferencedModulesTelemetry": false,
                                            "name": "default"
                                          },
                                          "resources": {
                                            "storageAccount": {
                                              "existing": true,
                                              "type": "Microsoft.Storage/storageAccounts",
                                              "apiVersion": "2025-01-01",
                                              "name": "[parameters('storageAccountName')]"
                                            },
                                            "blobServices": {
                                              "type": "Microsoft.Storage/storageAccounts/blobServices",
                                              "apiVersion": "2025-01-01",
                                              "name": "[format('{0}/{1}', parameters('storageAccountName'), variables('name'))]",
                                              "properties": {
                                                "automaticSnapshotPolicyEnabled": "[parameters('automaticSnapshotPolicyEnabled')]",
                                                "changeFeed": "[if(parameters('changeFeedEnabled'), createObject('enabled', true(), 'retentionInDays', parameters('changeFeedRetentionInDays')), null())]",
                                                "containerDeleteRetentionPolicy": {
                                                  "enabled": "[parameters('containerDeleteRetentionPolicyEnabled')]",
                                                  "days": "[parameters('containerDeleteRetentionPolicyDays')]",
                                                  "allowPermanentDelete": "[if(equals(parameters('containerDeleteRetentionPolicyEnabled'), true()), parameters('containerDeleteRetentionPolicyAllowPermanentDelete'), null())]"
                                                },
                                                "cors": "[if(not(equals(parameters('corsRules'), null())), createObject('corsRules', parameters('corsRules')), null())]",
                                                "defaultServiceVersion": "[parameters('defaultServiceVersion')]",
                                                "deleteRetentionPolicy": {
                                                  "enabled": "[parameters('deleteRetentionPolicyEnabled')]",
                                                  "days": "[parameters('deleteRetentionPolicyDays')]",
                                                  "allowPermanentDelete": "[if(and(parameters('deleteRetentionPolicyEnabled'), parameters('deleteRetentionPolicyAllowPermanentDelete')), true(), null())]"
                                                },
                                                "isVersioningEnabled": "[parameters('isVersioningEnabled')]",
                                                "lastAccessTimeTrackingPolicy": "[if(and(not(equals(reference('storageAccount', '2025-01-01', 'full').kind, 'Storage')), empty(tryGet(reference('storageAccount', '2025-01-01', 'full'), 'extendedLocation'))), createObject('enable', parameters('lastAccessTimeTrackingPolicyEnabled'), 'name', if(equals(parameters('lastAccessTimeTrackingPolicyEnabled'), true()), 'AccessTimeTracking', null()), 'trackingGranularityInDays', if(equals(parameters('lastAccessTimeTrackingPolicyEnabled'), true()), 1, null())), null())]",
                                                "restorePolicy": "[if(parameters('restorePolicyEnabled'), createObject('enabled', true(), 'days', parameters('restorePolicyDays')), null())]"
                                              },
                                              "dependsOn": [
                                                "storageAccount"
                                              ]
                                            },
                                            "blobServices_diagnosticSettings": {
                                              "copy": {
                                                "name": "blobServices_diagnosticSettings",
                                                "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                              },
                                              "type": "Microsoft.Insights/diagnosticSettings",
                                              "apiVersion": "2021-05-01-preview",
                                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}', parameters('storageAccountName'), variables('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', variables('name')))]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "metrics",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                                    "input": {
                                                      "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                                      "timeGrain": null
                                                    }
                                                  },
                                                  {
                                                    "name": "logs",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                                    "input": {
                                                      "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                                      "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                                    }
                                                  }
                                                ],
                                                "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                                "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                                "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                                "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                                "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                                "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                              },
                                              "dependsOn": [
                                                "blobServices"
                                              ]
                                            },
                                            "blobServices_container": {
                                              "copy": {
                                                "name": "blobServices_container",
                                                "count": "[length(coalesce(parameters('containers'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-Container-{1}', deployment().name, copyIndex())]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "storageAccountName": {
                                                    "value": "[parameters('storageAccountName')]"
                                                  },
                                                  "blobServiceName": {
                                                    "value": "[variables('name')]"
                                                  },
                                                  "name": {
                                                    "value": "[coalesce(parameters('containers'), createArray())[copyIndex()].name]"
                                                  },
                                                  "defaultEncryptionScope": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'defaultEncryptionScope')]"
                                                  },
                                                  "denyEncryptionScopeOverride": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'denyEncryptionScopeOverride')]"
                                                  },
                                                  "enableNfsV3AllSquash": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'enableNfsV3AllSquash')]"
                                                  },
                                                  "enableNfsV3RootSquash": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'enableNfsV3RootSquash')]"
                                                  },
                                                  "immutableStorageWithVersioningEnabled": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'immutableStorageWithVersioningEnabled')]"
                                                  },
                                                  "metadata": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'metadata')]"
                                                  },
                                                  "publicAccess": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'publicAccess')]"
                                                  },
                                                  "roleAssignments": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'roleAssignments')]"
                                                  },
                                                  "immutabilityPolicy": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'immutabilityPolicy')]"
                                                  },
                                                  "enableTelemetry": {
                                                    "value": "[variables('enableReferencedModulesTelemetry')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "12049267755110696809"
                                                    },
                                                    "name": "Storage Account Blob Containers",
                                                    "description": "This module deploys a Storage Account Blob Container."
                                                  },
                                                  "definitions": {
                                                    "immutabilityPolicyType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "immutabilityPeriodSinceCreationInDays": {
                                                          "type": "int",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The immutability period for the blobs in the container since the policy creation, in days."
                                                          }
                                                        },
                                                        "allowProtectedAppendWrites": {
                                                          "type": "bool",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to an append blob while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API."
                                                          }
                                                        },
                                                        "allowProtectedAppendWritesAll": {
                                                          "type": "bool",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to both \"Append and Block Blobs\" while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API. The \"allowProtectedAppendWrites\" and \"allowProtectedAppendWritesAll\" properties are mutually exclusive."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true,
                                                        "description": "The type for an immutability policy."
                                                      }
                                                    },
                                                    "roleAssignmentType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                          }
                                                        },
                                                        "roleDefinitionIdOrName": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                          }
                                                        },
                                                        "principalId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                          }
                                                        },
                                                        "principalType": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "Device",
                                                            "ForeignGroup",
                                                            "Group",
                                                            "ServicePrincipal",
                                                            "User"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The principal type of the assigned principal ID."
                                                          }
                                                        },
                                                        "description": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The description of the role assignment."
                                                          }
                                                        },
                                                        "condition": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                          }
                                                        },
                                                        "conditionVersion": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "2.0"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. Version of the condition."
                                                          }
                                                        },
                                                        "delegatedManagedIdentityResourceId": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "description": "An AVM-aligned type for a role assignment.",
                                                        "__bicep_imported_from!": {
                                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "storageAccountName": {
                                                      "type": "string",
                                                      "maxLength": 24,
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "blobServiceName": {
                                                      "type": "string",
                                                      "defaultValue": "default",
                                                      "metadata": {
                                                        "description": "Optional. The name of the parent Blob Service. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The name of the Storage Container to deploy."
                                                      }
                                                    },
                                                    "defaultEncryptionScope": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Default the container to use specified encryption scope for all writes."
                                                      }
                                                    },
                                                    "denyEncryptionScopeOverride": {
                                                      "type": "bool",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Block override of encryption scope from the container default."
                                                      }
                                                    },
                                                    "enableNfsV3AllSquash": {
                                                      "type": "bool",
                                                      "defaultValue": false,
                                                      "metadata": {
                                                        "description": "Optional. Enable NFSv3 all squash on blob container."
                                                      }
                                                    },
                                                    "enableNfsV3RootSquash": {
                                                      "type": "bool",
                                                      "defaultValue": false,
                                                      "metadata": {
                                                        "description": "Optional. Enable NFSv3 root squash on blob container."
                                                      }
                                                    },
                                                    "immutableStorageWithVersioningEnabled": {
                                                      "type": "bool",
                                                      "defaultValue": false,
                                                      "metadata": {
                                                        "description": "Optional. This is an immutable property, when set to true it enables object level immutability at the container level. The property is immutable and can only be set to true at the container creation time. Existing containers must undergo a migration process."
                                                      }
                                                    },
                                                    "immutabilityPolicy": {
                                                      "$ref": "#/definitions/immutabilityPolicyType",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Configure immutability policy."
                                                      }
                                                    },
                                                    "metadata": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.Storage/storageAccounts/blobServices/containers@2024-01-01#properties/properties/properties/metadata"
                                                        },
                                                        "description": "Optional. A name-value pair to associate with the container as metadata."
                                                      },
                                                      "defaultValue": {}
                                                    },
                                                    "publicAccess": {
                                                      "type": "string",
                                                      "defaultValue": "None",
                                                      "allowedValues": [
                                                        "Container",
                                                        "Blob",
                                                        "None"
                                                      ],
                                                      "metadata": {
                                                        "description": "Optional. Specifies whether data in the container may be accessed publicly and the level of access."
                                                      }
                                                    },
                                                    "enableTelemetry": {
                                                      "type": "bool",
                                                      "defaultValue": true,
                                                      "metadata": {
                                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                                      }
                                                    },
                                                    "roleAssignments": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/roleAssignmentType"
                                                      },
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Array of role assignments to create."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "formattedRoleAssignments",
                                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                                      }
                                                    ],
                                                    "builtInRoleNames": {
                                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                                      "Reader and Data Access": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c12c1c16-33a1-487b-954d-41c89c60f349')]",
                                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                                      "Storage Account Backup Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e5e2a7ff-d759-4cd2-bb51-3152d37e2eb1')]",
                                                      "Storage Account Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
                                                      "Storage Account Key Operator Service Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '81a9662b-bebf-436f-a333-f67b29880f12')]",
                                                      "Storage Blob Data Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                                                      "Storage Blob Data Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                                                      "Storage Blob Data Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                                                      "Storage Blob Delegator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db58b8e5-c6ad-4a2a-8342-4190687cbf4a')]",
                                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                                    }
                                                  },
                                                  "resources": {
                                                    "storageAccount::blobServices": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts/blobServices",
                                                      "apiVersion": "2025-01-01",
                                                      "name": "[format('{0}/{1}', parameters('storageAccountName'), parameters('blobServiceName'))]"
                                                    },
                                                    "avmTelemetry": {
                                                      "condition": "[parameters('enableTelemetry')]",
                                                      "type": "Microsoft.Resources/deployments",
                                                      "apiVersion": "2024-03-01",
                                                      "name": "[format('46d3xbcp.res.storage-blobcontainer.{0}.{1}', replace('0.3.1', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                                      "properties": {
                                                        "mode": "Incremental",
                                                        "template": {
                                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                          "contentVersion": "1.0.0.0",
                                                          "resources": [],
                                                          "outputs": {
                                                            "telemetry": {
                                                              "type": "String",
                                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                            }
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "storageAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts",
                                                      "apiVersion": "2025-01-01",
                                                      "name": "[parameters('storageAccountName')]"
                                                    },
                                                    "container": {
                                                      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                                                      "apiVersion": "2025-01-01",
                                                      "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), parameters('blobServiceName'), parameters('name'))]",
                                                      "properties": {
                                                        "defaultEncryptionScope": "[parameters('defaultEncryptionScope')]",
                                                        "denyEncryptionScopeOverride": "[parameters('denyEncryptionScopeOverride')]",
                                                        "enableNfsV3AllSquash": "[if(equals(parameters('enableNfsV3AllSquash'), true()), parameters('enableNfsV3AllSquash'), null())]",
                                                        "enableNfsV3RootSquash": "[if(equals(parameters('enableNfsV3RootSquash'), true()), parameters('enableNfsV3RootSquash'), null())]",
                                                        "immutableStorageWithVersioning": "[if(parameters('immutableStorageWithVersioningEnabled'), createObject('enabled', parameters('immutableStorageWithVersioningEnabled')), null())]",
                                                        "metadata": "[parameters('metadata')]",
                                                        "publicAccess": "[parameters('publicAccess')]"
                                                      }
                                                    },
                                                    "container_roleAssignments": {
                                                      "copy": {
                                                        "name": "container_roleAssignments",
                                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                                      },
                                                      "type": "Microsoft.Authorization/roleAssignments",
                                                      "apiVersion": "2022-04-01",
                                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}/containers/{2}', parameters('storageAccountName'), parameters('blobServiceName'), parameters('name'))]",
                                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('storageAccountName'), parameters('blobServiceName'), parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                                      "properties": {
                                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                                      },
                                                      "dependsOn": [
                                                        "container"
                                                      ]
                                                    },
                                                    "container_immutabilityPolicy": {
                                                      "condition": "[not(empty(coalesce(parameters('immutabilityPolicy'), createObject())))]",
                                                      "type": "Microsoft.Resources/deployments",
                                                      "apiVersion": "2025-04-01",
                                                      "name": "[take(format('{0}-ImmutPol', deployment().name), 64)]",
                                                      "properties": {
                                                        "expressionEvaluationOptions": {
                                                          "scope": "inner"
                                                        },
                                                        "mode": "Incremental",
                                                        "parameters": {
                                                          "storageAccountName": {
                                                            "value": "[parameters('storageAccountName')]"
                                                          },
                                                          "containerName": {
                                                            "value": "[parameters('name')]"
                                                          },
                                                          "immutabilityPeriodSinceCreationInDays": {
                                                            "value": "[tryGet(parameters('immutabilityPolicy'), 'immutabilityPeriodSinceCreationInDays')]"
                                                          },
                                                          "allowProtectedAppendWrites": {
                                                            "value": "[tryGet(parameters('immutabilityPolicy'), 'allowProtectedAppendWrites')]"
                                                          },
                                                          "allowProtectedAppendWritesAll": {
                                                            "value": "[tryGet(parameters('immutabilityPolicy'), 'allowProtectedAppendWritesAll')]"
                                                          }
                                                        },
                                                        "template": {
                                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                          "contentVersion": "1.0.0.0",
                                                          "metadata": {
                                                            "_generator": {
                                                              "name": "bicep",
                                                              "version": "0.38.33.27573",
                                                              "templateHash": "1872120962131123050"
                                                            },
                                                            "name": "Storage Account Blob Container Immutability Policies",
                                                            "description": "This module deploys a Storage Account Blob Container Immutability Policy."
                                                          },
                                                          "parameters": {
                                                            "storageAccountName": {
                                                              "type": "string",
                                                              "maxLength": 24,
                                                              "metadata": {
                                                                "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                                              }
                                                            },
                                                            "containerName": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "Conditional. The name of the parent container to apply the policy to. Required if the template is used in a standalone deployment."
                                                              }
                                                            },
                                                            "immutabilityPeriodSinceCreationInDays": {
                                                              "type": "int",
                                                              "defaultValue": 365,
                                                              "metadata": {
                                                                "description": "Optional. The immutability period for the blobs in the container since the policy creation, in days."
                                                              }
                                                            },
                                                            "allowProtectedAppendWrites": {
                                                              "type": "bool",
                                                              "defaultValue": true,
                                                              "metadata": {
                                                                "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to an append blob while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API. The \"allowProtectedAppendWrites\" and \"allowProtectedAppendWritesAll\" properties are mutually exclusive."
                                                              }
                                                            },
                                                            "allowProtectedAppendWritesAll": {
                                                              "type": "bool",
                                                              "defaultValue": true,
                                                              "metadata": {
                                                                "description": "Optional. This property can only be changed for unlocked time-based retention policies. When enabled, new blocks can be written to both \"Append and Block Blobs\" while maintaining immutability protection and compliance. Only new blocks can be added and any existing blocks cannot be modified or deleted. This property cannot be changed with ExtendImmutabilityPolicy API. The \"allowProtectedAppendWrites\" and \"allowProtectedAppendWritesAll\" properties are mutually exclusive."
                                                              }
                                                            }
                                                          },
                                                          "variables": {
                                                            "name": "default"
                                                          },
                                                          "resources": [
                                                            {
                                                              "type": "Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies",
                                                              "apiVersion": "2025-01-01",
                                                              "name": "[format('{0}/{1}/{2}/{3}', parameters('storageAccountName'), 'default', parameters('containerName'), variables('name'))]",
                                                              "properties": {
                                                                "immutabilityPeriodSinceCreationInDays": "[parameters('immutabilityPeriodSinceCreationInDays')]",
                                                                "allowProtectedAppendWrites": "[parameters('allowProtectedAppendWrites')]",
                                                                "allowProtectedAppendWritesAll": "[parameters('allowProtectedAppendWritesAll')]"
                                                              }
                                                            }
                                                          ],
                                                          "outputs": {
                                                            "name": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "The name of the deployed immutability policy."
                                                              },
                                                              "value": "[variables('name')]"
                                                            },
                                                            "resourceId": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "The resource ID of the deployed immutability policy."
                                                              },
                                                              "value": "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies', parameters('storageAccountName'), 'default', parameters('containerName'), variables('name'))]"
                                                            },
                                                            "resourceGroupName": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "The resource group of the deployed immutability policy."
                                                              },
                                                              "value": "[resourceGroup().name]"
                                                            }
                                                          }
                                                        }
                                                      },
                                                      "dependsOn": [
                                                        "container"
                                                      ]
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the deployed container."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the deployed container."
                                                      },
                                                      "value": "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('storageAccountName'), parameters('blobServiceName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group of the deployed container."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "blobServices"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the deployed blob service."
                                              },
                                              "value": "[variables('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the deployed blob service."
                                              },
                                              "value": "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), variables('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the deployed blob service."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_fileServices": {
                                      "condition": "[not(empty(parameters('fileServices')))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-Storage-FileServices', uniqueString(deployment().name, parameters('location')))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "storageAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "diagnosticSettings": {
                                            "value": "[tryGet(parameters('fileServices'), 'diagnosticSettings')]"
                                          },
                                          "protocolSettings": {
                                            "value": "[tryGet(parameters('fileServices'), 'protocolSettings')]"
                                          },
                                          "shareDeleteRetentionPolicy": {
                                            "value": "[tryGet(parameters('fileServices'), 'shareDeleteRetentionPolicy')]"
                                          },
                                          "shares": {
                                            "value": "[tryGet(parameters('fileServices'), 'shares')]"
                                          },
                                          "corsRules": {
                                            "value": "[tryGet(parameters('fileServices'), 'corsRules')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "7372615490119026510"
                                            },
                                            "name": "Storage Account File Share Services",
                                            "description": "This module deploys a Storage Account File Share Service."
                                          },
                                          "definitions": {
                                            "corsRuleType": {
                                              "type": "object",
                                              "properties": {
                                                "allowedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                                  }
                                                },
                                                "allowedMethods": {
                                                  "type": "array",
                                                  "allowedValues": [
                                                    "CONNECT",
                                                    "DELETE",
                                                    "GET",
                                                    "HEAD",
                                                    "MERGE",
                                                    "OPTIONS",
                                                    "PATCH",
                                                    "POST",
                                                    "PUT",
                                                    "TRACE"
                                                  ],
                                                  "metadata": {
                                                    "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                                  }
                                                },
                                                "allowedOrigins": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                                  }
                                                },
                                                "exposedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of response headers to expose to CORS clients."
                                                  }
                                                },
                                                "maxAgeInSeconds": {
                                                  "type": "int",
                                                  "metadata": {
                                                    "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a cors rule."
                                              }
                                            },
                                            "fileShareType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the file share."
                                                  }
                                                },
                                                "accessTier": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Cool",
                                                    "Hot",
                                                    "Premium",
                                                    "TransactionOptimized"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Access tier for specific share. Required if the Storage Account kind is set to FileStorage (should be set to \"Premium\"). GpV2 account can choose between TransactionOptimized (default), Hot, and Cool."
                                                  }
                                                },
                                                "enabledProtocols": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "NFS",
                                                    "SMB"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The authentication protocol that is used for the file share. Can only be specified when creating a share."
                                                  }
                                                },
                                                "rootSquash": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "AllSquash",
                                                    "NoRootSquash",
                                                    "RootSquash"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Permissions for NFS file shares are enforced by the client OS rather than the Azure Files service. Toggling the root squash behavior reduces the rights of the root user for NFS shares."
                                                  }
                                                },
                                                "shareQuota": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The maximum size of the share, in gigabytes. Must be greater than 0, and less than or equal to 5120 (5TB). For Large File Shares, the maximum size is 102400 (100TB)."
                                                  }
                                                },
                                                "roleAssignments": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/roleAssignmentType"
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Array of role assignments to create."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a file share."
                                              }
                                            },
                                            "diagnosticSettingFullType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the diagnostic setting."
                                                  }
                                                },
                                                "logCategoriesAndGroups": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                        }
                                                      },
                                                      "categoryGroup": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                                  }
                                                },
                                                "metricCategories": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "metadata": {
                                                          "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                                  }
                                                },
                                                "logAnalyticsDestinationType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "AzureDiagnostics",
                                                    "Dedicated"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                                  }
                                                },
                                                "workspaceResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "storageAccountResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "eventHubAuthorizationRuleResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                                  }
                                                },
                                                "eventHubName": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "marketplacePartnerResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "storageAccountName": {
                                              "type": "string",
                                              "maxLength": 24,
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "defaultValue": "default",
                                              "metadata": {
                                                "description": "Optional. The name of the file service."
                                              }
                                            },
                                            "protocolSettings": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Storage/storageAccounts/fileServices@2024-01-01#properties/properties/properties/protocolSettings"
                                                },
                                                "description": "Optional. Protocol settings for file service."
                                              },
                                              "defaultValue": {}
                                            },
                                            "shareDeleteRetentionPolicy": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Storage/storageAccounts/fileServices@2024-01-01#properties/properties/properties/shareDeleteRetentionPolicy"
                                                },
                                                "description": "Optional. The service properties for soft delete."
                                              },
                                              "defaultValue": {
                                                "enabled": true,
                                                "days": 7
                                              }
                                            },
                                            "corsRules": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/corsRuleType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                              }
                                            },
                                            "diagnosticSettings": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/diagnosticSettingFullType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The diagnostic settings of the service."
                                              }
                                            },
                                            "shares": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/fileShareType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. File shares to create."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "enableReferencedModulesTelemetry": false
                                          },
                                          "resources": {
                                            "storageAccount": {
                                              "existing": true,
                                              "type": "Microsoft.Storage/storageAccounts",
                                              "apiVersion": "2024-01-01",
                                              "name": "[parameters('storageAccountName')]"
                                            },
                                            "fileServices": {
                                              "type": "Microsoft.Storage/storageAccounts/fileServices",
                                              "apiVersion": "2024-01-01",
                                              "name": "[format('{0}/{1}', parameters('storageAccountName'), parameters('name'))]",
                                              "properties": {
                                                "cors": "[if(not(equals(parameters('corsRules'), null())), createObject('corsRules', parameters('corsRules')), null())]",
                                                "protocolSettings": "[parameters('protocolSettings')]",
                                                "shareDeleteRetentionPolicy": "[parameters('shareDeleteRetentionPolicy')]"
                                              }
                                            },
                                            "fileServices_diagnosticSettings": {
                                              "copy": {
                                                "name": "fileServices_diagnosticSettings",
                                                "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                              },
                                              "type": "Microsoft.Insights/diagnosticSettings",
                                              "apiVersion": "2021-05-01-preview",
                                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/fileServices/{1}', parameters('storageAccountName'), parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "metrics",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                                    "input": {
                                                      "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                                      "timeGrain": null
                                                    }
                                                  },
                                                  {
                                                    "name": "logs",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                                    "input": {
                                                      "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                                      "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                                    }
                                                  }
                                                ],
                                                "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                                "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                                "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                                "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                                "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                                "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                              },
                                              "dependsOn": [
                                                "fileServices"
                                              ]
                                            },
                                            "fileServices_shares": {
                                              "copy": {
                                                "name": "fileServices_shares",
                                                "count": "[length(coalesce(parameters('shares'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-FileShare-{1}', deployment().name, copyIndex())]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "storageAccountName": {
                                                    "value": "[parameters('storageAccountName')]"
                                                  },
                                                  "fileServicesName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "name": {
                                                    "value": "[coalesce(parameters('shares'), createArray())[copyIndex()].name]"
                                                  },
                                                  "accessTier": {
                                                    "value": "[coalesce(tryGet(coalesce(parameters('shares'), createArray())[copyIndex()], 'accessTier'), if(equals(reference('storageAccount', '2024-01-01', 'full').kind, 'FileStorage'), 'Premium', 'TransactionOptimized'))]"
                                                  },
                                                  "enabledProtocols": {
                                                    "value": "[tryGet(coalesce(parameters('shares'), createArray())[copyIndex()], 'enabledProtocols')]"
                                                  },
                                                  "rootSquash": {
                                                    "value": "[tryGet(coalesce(parameters('shares'), createArray())[copyIndex()], 'rootSquash')]"
                                                  },
                                                  "shareQuota": {
                                                    "value": "[tryGet(coalesce(parameters('shares'), createArray())[copyIndex()], 'shareQuota')]"
                                                  },
                                                  "roleAssignments": {
                                                    "value": "[tryGet(coalesce(parameters('shares'), createArray())[copyIndex()], 'roleAssignments')]"
                                                  },
                                                  "enableTelemetry": {
                                                    "value": "[variables('enableReferencedModulesTelemetry')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "6443667442431835489"
                                                    },
                                                    "name": "Storage Account File Shares",
                                                    "description": "This module deploys a Storage Account File Share."
                                                  },
                                                  "definitions": {
                                                    "roleAssignmentType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                          }
                                                        },
                                                        "roleDefinitionIdOrName": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                          }
                                                        },
                                                        "principalId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                          }
                                                        },
                                                        "principalType": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "Device",
                                                            "ForeignGroup",
                                                            "Group",
                                                            "ServicePrincipal",
                                                            "User"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The principal type of the assigned principal ID."
                                                          }
                                                        },
                                                        "description": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The description of the role assignment."
                                                          }
                                                        },
                                                        "condition": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                          }
                                                        },
                                                        "conditionVersion": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "2.0"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. Version of the condition."
                                                          }
                                                        },
                                                        "delegatedManagedIdentityResourceId": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "description": "An AVM-aligned type for a role assignment.",
                                                        "__bicep_imported_from!": {
                                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "storageAccountName": {
                                                      "type": "string",
                                                      "maxLength": 24,
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "fileServicesName": {
                                                      "type": "string",
                                                      "defaultValue": "default",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent file service. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The name of the file share to create."
                                                      }
                                                    },
                                                    "accessTier": {
                                                      "type": "string",
                                                      "defaultValue": "TransactionOptimized",
                                                      "allowedValues": [
                                                        "Premium",
                                                        "Hot",
                                                        "Cool",
                                                        "TransactionOptimized"
                                                      ],
                                                      "metadata": {
                                                        "description": "Conditional. Access tier for specific share. Required if the Storage Account kind is set to FileStorage (should be set to \"Premium\"). GpV2 account can choose between TransactionOptimized (default), Hot, and Cool."
                                                      }
                                                    },
                                                    "shareQuota": {
                                                      "type": "int",
                                                      "defaultValue": 5120,
                                                      "metadata": {
                                                        "description": "Optional. The maximum size of the share, in gigabytes. Must be greater than 0, and less than or equal to 5120 (5TB). For Large File Shares, the maximum size is 102400 (100TB)."
                                                      }
                                                    },
                                                    "enabledProtocols": {
                                                      "type": "string",
                                                      "defaultValue": "SMB",
                                                      "allowedValues": [
                                                        "NFS",
                                                        "SMB"
                                                      ],
                                                      "metadata": {
                                                        "description": "Optional. The authentication protocol that is used for the file share. Can only be specified when creating a share."
                                                      }
                                                    },
                                                    "rootSquash": {
                                                      "type": "string",
                                                      "defaultValue": "NoRootSquash",
                                                      "allowedValues": [
                                                        "AllSquash",
                                                        "NoRootSquash",
                                                        "RootSquash"
                                                      ],
                                                      "metadata": {
                                                        "description": "Optional. Permissions for NFS file shares are enforced by the client OS rather than the Azure Files service. Toggling the root squash behavior reduces the rights of the root user for NFS shares."
                                                      }
                                                    },
                                                    "enableTelemetry": {
                                                      "type": "bool",
                                                      "defaultValue": true,
                                                      "metadata": {
                                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                                      }
                                                    },
                                                    "roleAssignments": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/roleAssignmentType"
                                                      },
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Array of role assignments to create."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "formattedRoleAssignments",
                                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                                      }
                                                    ],
                                                    "builtInRoleNames": {
                                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                                      "Reader and Data Access": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c12c1c16-33a1-487b-954d-41c89c60f349')]",
                                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                                      "Storage Account Backup Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e5e2a7ff-d759-4cd2-bb51-3152d37e2eb1')]",
                                                      "Storage Account Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
                                                      "Storage Account Key Operator Service Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '81a9662b-bebf-436f-a333-f67b29880f12')]",
                                                      "Storage File Data SMB Share Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb')]",
                                                      "Storage File Data SMB Share Elevated Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a7264617-510b-434b-a828-9731dc254ea7')]",
                                                      "Storage File Data SMB Share Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'aba4ae5f-2193-4029-9191-0cb91df5e314')]",
                                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                                    }
                                                  },
                                                  "resources": {
                                                    "storageAccount::fileService": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts/fileServices",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[format('{0}/{1}', parameters('storageAccountName'), parameters('fileServicesName'))]"
                                                    },
                                                    "avmTelemetry": {
                                                      "condition": "[parameters('enableTelemetry')]",
                                                      "type": "Microsoft.Resources/deployments",
                                                      "apiVersion": "2024-03-01",
                                                      "name": "[format('46d3xbcp.res.storage-fileshare.{0}.{1}', replace('0.1.1', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                                      "properties": {
                                                        "mode": "Incremental",
                                                        "template": {
                                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                          "contentVersion": "1.0.0.0",
                                                          "resources": [],
                                                          "outputs": {
                                                            "telemetry": {
                                                              "type": "String",
                                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                            }
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "storageAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[parameters('storageAccountName')]"
                                                    },
                                                    "fileShare": {
                                                      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), parameters('fileServicesName'), parameters('name'))]",
                                                      "properties": {
                                                        "accessTier": "[parameters('accessTier')]",
                                                        "shareQuota": "[parameters('shareQuota')]",
                                                        "rootSquash": "[if(equals(parameters('enabledProtocols'), 'NFS'), parameters('rootSquash'), null())]",
                                                        "enabledProtocols": "[parameters('enabledProtocols')]"
                                                      }
                                                    },
                                                    "fileShare_roleAssignments": {
                                                      "copy": {
                                                        "name": "fileShare_roleAssignments",
                                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                                      },
                                                      "type": "Microsoft.Resources/deployments",
                                                      "apiVersion": "2025-04-01",
                                                      "name": "[format('{0}-Share-Rbac-{1}', uniqueString(deployment().name), copyIndex())]",
                                                      "properties": {
                                                        "expressionEvaluationOptions": {
                                                          "scope": "inner"
                                                        },
                                                        "mode": "Incremental",
                                                        "parameters": {
                                                          "scope": {
                                                            "value": "[replace(resourceId('Microsoft.Storage/storageAccounts/fileServices/shares', parameters('storageAccountName'), parameters('fileServicesName'), parameters('name')), '/shares/', '/fileshares/')]"
                                                          },
                                                          "name": {
                                                            "value": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Storage/storageAccounts/fileServices/shares', parameters('storageAccountName'), parameters('fileServicesName'), parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]"
                                                          },
                                                          "roleDefinitionId": {
                                                            "value": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]"
                                                          },
                                                          "principalId": {
                                                            "value": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]"
                                                          },
                                                          "principalType": {
                                                            "value": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]"
                                                          },
                                                          "condition": {
                                                            "value": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]"
                                                          },
                                                          "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), createObject('value', coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0')), createObject('value', null()))]",
                                                          "delegatedManagedIdentityResourceId": {
                                                            "value": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                                          },
                                                          "description": {
                                                            "value": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]"
                                                          }
                                                        },
                                                        "template": {
                                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                          "contentVersion": "1.0.0.0",
                                                          "parameters": {
                                                            "scope": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "Required. The scope to deploy the role assignment to."
                                                              }
                                                            },
                                                            "name": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "Required. The name of the role assignment."
                                                              }
                                                            },
                                                            "roleDefinitionId": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "Required. The role definition Id to assign."
                                                              }
                                                            },
                                                            "principalId": {
                                                              "type": "string",
                                                              "metadata": {
                                                                "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                              }
                                                            },
                                                            "principalType": {
                                                              "type": "string",
                                                              "allowedValues": [
                                                                "Device",
                                                                "ForeignGroup",
                                                                "Group",
                                                                "ServicePrincipal",
                                                                "User",
                                                                ""
                                                              ],
                                                              "defaultValue": "",
                                                              "metadata": {
                                                                "description": "Optional. The principal type of the assigned principal ID."
                                                              }
                                                            },
                                                            "description": {
                                                              "type": "string",
                                                              "defaultValue": "",
                                                              "metadata": {
                                                                "description": "Optional. The description of the role assignment."
                                                              }
                                                            },
                                                            "condition": {
                                                              "type": "string",
                                                              "defaultValue": "",
                                                              "metadata": {
                                                                "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\""
                                                              }
                                                            },
                                                            "conditionVersion": {
                                                              "type": "string",
                                                              "allowedValues": [
                                                                "2.0"
                                                              ],
                                                              "defaultValue": "2.0",
                                                              "metadata": {
                                                                "description": "Optional. Version of the condition."
                                                              }
                                                            },
                                                            "delegatedManagedIdentityResourceId": {
                                                              "type": "string",
                                                              "defaultValue": "",
                                                              "metadata": {
                                                                "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                              }
                                                            }
                                                          },
                                                          "resources": [
                                                            {
                                                              "type": "Microsoft.Authorization/roleAssignments",
                                                              "apiVersion": "2022-04-01",
                                                              "scope": "[parameters('scope')]",
                                                              "name": "[parameters('name')]",
                                                              "properties": {
                                                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                                                "principalId": "[parameters('principalId')]",
                                                                "description": "[parameters('description')]",
                                                                "principalType": "[if(not(empty(parameters('principalType'))), parameters('principalType'), null())]",
                                                                "condition": "[if(not(empty(parameters('condition'))), parameters('condition'), null())]",
                                                                "conditionVersion": "[if(and(not(empty(parameters('conditionVersion'))), not(empty(parameters('condition')))), parameters('conditionVersion'), null())]",
                                                                "delegatedManagedIdentityResourceId": "[if(not(empty(parameters('delegatedManagedIdentityResourceId'))), parameters('delegatedManagedIdentityResourceId'), null())]"
                                                              }
                                                            }
                                                          ]
                                                        }
                                                      },
                                                      "dependsOn": [
                                                        "fileShare"
                                                      ]
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the deployed file share."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the deployed file share."
                                                      },
                                                      "value": "[resourceId('Microsoft.Storage/storageAccounts/fileServices/shares', parameters('storageAccountName'), parameters('fileServicesName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group of the deployed file share."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "fileServices",
                                                "storageAccount"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the deployed file share service."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the deployed file share service."
                                              },
                                              "value": "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('storageAccountName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group of the deployed file share service."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_queueServices": {
                                      "condition": "[not(empty(parameters('queueServices')))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-Storage-QueueServices', uniqueString(deployment().name, parameters('location')))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "storageAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "diagnosticSettings": {
                                            "value": "[tryGet(parameters('queueServices'), 'diagnosticSettings')]"
                                          },
                                          "queues": {
                                            "value": "[tryGet(parameters('queueServices'), 'queues')]"
                                          },
                                          "corsRules": {
                                            "value": "[tryGet(parameters('queueServices'), 'corsRules')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "14320740623684459446"
                                            },
                                            "name": "Storage Account Queue Services",
                                            "description": "This module deploys a Storage Account Queue Service."
                                          },
                                          "definitions": {
                                            "corsRuleType": {
                                              "type": "object",
                                              "properties": {
                                                "allowedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                                  }
                                                },
                                                "allowedMethods": {
                                                  "type": "array",
                                                  "allowedValues": [
                                                    "CONNECT",
                                                    "DELETE",
                                                    "GET",
                                                    "HEAD",
                                                    "MERGE",
                                                    "OPTIONS",
                                                    "PATCH",
                                                    "POST",
                                                    "PUT",
                                                    "TRACE"
                                                  ],
                                                  "metadata": {
                                                    "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                                  }
                                                },
                                                "allowedOrigins": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                                  }
                                                },
                                                "exposedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of response headers to expose to CORS clients."
                                                  }
                                                },
                                                "maxAgeInSeconds": {
                                                  "type": "int",
                                                  "metadata": {
                                                    "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a cors rule."
                                              }
                                            },
                                            "queueType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the queue."
                                                  }
                                                },
                                                "metadata": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.Storage/storageAccounts/queueServices/queues@2024-01-01#properties/properties/properties/metadata"
                                                    },
                                                    "description": "Optional. Metadata to set on the queue."
                                                  },
                                                  "nullable": true
                                                },
                                                "roleAssignments": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/roleAssignmentType"
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Array of role assignments to create."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a queue."
                                              }
                                            },
                                            "diagnosticSettingFullType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the diagnostic setting."
                                                  }
                                                },
                                                "logCategoriesAndGroups": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                        }
                                                      },
                                                      "categoryGroup": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                                  }
                                                },
                                                "metricCategories": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "metadata": {
                                                          "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                                  }
                                                },
                                                "logAnalyticsDestinationType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "AzureDiagnostics",
                                                    "Dedicated"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                                  }
                                                },
                                                "workspaceResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "storageAccountResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "eventHubAuthorizationRuleResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                                  }
                                                },
                                                "eventHubName": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "marketplacePartnerResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "storageAccountName": {
                                              "type": "string",
                                              "maxLength": 24,
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "queues": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/queueType"
                                              },
                                              "defaultValue": [],
                                              "metadata": {
                                                "description": "Optional. Queues to create."
                                              }
                                            },
                                            "corsRules": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/corsRuleType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                              }
                                            },
                                            "diagnosticSettings": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/diagnosticSettingFullType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The diagnostic settings of the service."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "name": "default"
                                          },
                                          "resources": {
                                            "storageAccount": {
                                              "existing": true,
                                              "type": "Microsoft.Storage/storageAccounts",
                                              "apiVersion": "2024-01-01",
                                              "name": "[parameters('storageAccountName')]"
                                            },
                                            "queueServices": {
                                              "type": "Microsoft.Storage/storageAccounts/queueServices",
                                              "apiVersion": "2024-01-01",
                                              "name": "[format('{0}/{1}', parameters('storageAccountName'), variables('name'))]",
                                              "properties": {
                                                "cors": "[if(not(equals(parameters('corsRules'), null())), createObject('corsRules', parameters('corsRules')), null())]"
                                              }
                                            },
                                            "queueServices_diagnosticSettings": {
                                              "copy": {
                                                "name": "queueServices_diagnosticSettings",
                                                "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                              },
                                              "type": "Microsoft.Insights/diagnosticSettings",
                                              "apiVersion": "2021-05-01-preview",
                                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/queueServices/{1}', parameters('storageAccountName'), variables('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', variables('name')))]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "metrics",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                                    "input": {
                                                      "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                                      "timeGrain": null
                                                    }
                                                  },
                                                  {
                                                    "name": "logs",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                                    "input": {
                                                      "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                                      "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                                    }
                                                  }
                                                ],
                                                "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                                "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                                "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                                "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                                "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                                "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                              },
                                              "dependsOn": [
                                                "queueServices"
                                              ]
                                            },
                                            "queueServices_queues": {
                                              "copy": {
                                                "name": "queueServices_queues",
                                                "count": "[length(coalesce(parameters('queues'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-Queue-{1}', deployment().name, copyIndex())]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "storageAccountName": {
                                                    "value": "[parameters('storageAccountName')]"
                                                  },
                                                  "name": {
                                                    "value": "[coalesce(parameters('queues'), createArray())[copyIndex()].name]"
                                                  },
                                                  "metadata": {
                                                    "value": "[tryGet(coalesce(parameters('queues'), createArray())[copyIndex()], 'metadata')]"
                                                  },
                                                  "roleAssignments": {
                                                    "value": "[tryGet(coalesce(parameters('queues'), createArray())[copyIndex()], 'roleAssignments')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "17820569818642693530"
                                                    },
                                                    "name": "Storage Account Queues",
                                                    "description": "This module deploys a Storage Account Queue."
                                                  },
                                                  "definitions": {
                                                    "roleAssignmentType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                          }
                                                        },
                                                        "roleDefinitionIdOrName": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                          }
                                                        },
                                                        "principalId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                          }
                                                        },
                                                        "principalType": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "Device",
                                                            "ForeignGroup",
                                                            "Group",
                                                            "ServicePrincipal",
                                                            "User"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The principal type of the assigned principal ID."
                                                          }
                                                        },
                                                        "description": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The description of the role assignment."
                                                          }
                                                        },
                                                        "condition": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                          }
                                                        },
                                                        "conditionVersion": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "2.0"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. Version of the condition."
                                                          }
                                                        },
                                                        "delegatedManagedIdentityResourceId": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "description": "An AVM-aligned type for a role assignment.",
                                                        "__bicep_imported_from!": {
                                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "storageAccountName": {
                                                      "type": "string",
                                                      "maxLength": 24,
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The name of the storage queue to deploy."
                                                      }
                                                    },
                                                    "metadata": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.Storage/storageAccounts/queueServices/queues@2024-01-01#properties/properties/properties/metadata"
                                                        },
                                                        "description": "Optional. A name-value pair that represents queue metadata."
                                                      },
                                                      "defaultValue": {}
                                                    },
                                                    "roleAssignments": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/roleAssignmentType"
                                                      },
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Array of role assignments to create."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "formattedRoleAssignments",
                                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                                      }
                                                    ],
                                                    "builtInRoleNames": {
                                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                                      "Reader and Data Access": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c12c1c16-33a1-487b-954d-41c89c60f349')]",
                                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                                      "Storage Account Backup Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e5e2a7ff-d759-4cd2-bb51-3152d37e2eb1')]",
                                                      "Storage Account Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
                                                      "Storage Account Key Operator Service Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '81a9662b-bebf-436f-a333-f67b29880f12')]",
                                                      "Storage Queue Data Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '974c5e8b-45b9-4653-ba55-5f855dd0fb88')]",
                                                      "Storage Queue Data Message Processor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8a0f0c08-91a1-4084-bc3d-661d67233fed')]",
                                                      "Storage Queue Data Message Sender": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c6a89b2d-59bc-44d0-9896-0f6e12d7b80a')]",
                                                      "Storage Queue Data Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '19e7f393-937e-4f77-808e-94535e297925')]",
                                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                                    }
                                                  },
                                                  "resources": {
                                                    "storageAccount::queueServices": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts/queueServices",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]"
                                                    },
                                                    "storageAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[parameters('storageAccountName')]"
                                                    },
                                                    "queue": {
                                                      "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('name'))]",
                                                      "properties": {
                                                        "metadata": "[parameters('metadata')]"
                                                      }
                                                    },
                                                    "queue_roleAssignments": {
                                                      "copy": {
                                                        "name": "queue_roleAssignments",
                                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                                      },
                                                      "type": "Microsoft.Authorization/roleAssignments",
                                                      "apiVersion": "2022-04-01",
                                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}/queueServices/{1}/queues/{2}', parameters('storageAccountName'), 'default', parameters('name'))]",
                                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Storage/storageAccounts/queueServices/queues', parameters('storageAccountName'), 'default', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                                      "properties": {
                                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                                      },
                                                      "dependsOn": [
                                                        "queue"
                                                      ]
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the deployed queue."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the deployed queue."
                                                      },
                                                      "value": "[resourceId('Microsoft.Storage/storageAccounts/queueServices/queues', parameters('storageAccountName'), 'default', parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group of the deployed queue."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the deployed queue service."
                                              },
                                              "value": "[variables('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the deployed queue service."
                                              },
                                              "value": "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('storageAccountName'), variables('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group of the deployed queue service."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_tableServices": {
                                      "condition": "[not(empty(parameters('tableServices')))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-Storage-TableServices', uniqueString(deployment().name, parameters('location')))]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "storageAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "diagnosticSettings": {
                                            "value": "[tryGet(parameters('tableServices'), 'diagnosticSettings')]"
                                          },
                                          "tables": {
                                            "value": "[tryGet(parameters('tableServices'), 'tables')]"
                                          },
                                          "corsRules": {
                                            "value": "[tryGet(parameters('tableServices'), 'corsRules')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "15397070691540239144"
                                            },
                                            "name": "Storage Account Table Services",
                                            "description": "This module deploys a Storage Account Table Service."
                                          },
                                          "definitions": {
                                            "corsRuleType": {
                                              "type": "object",
                                              "properties": {
                                                "allowedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of headers allowed to be part of the cross-origin request."
                                                  }
                                                },
                                                "allowedMethods": {
                                                  "type": "array",
                                                  "allowedValues": [
                                                    "CONNECT",
                                                    "DELETE",
                                                    "GET",
                                                    "HEAD",
                                                    "MERGE",
                                                    "OPTIONS",
                                                    "PATCH",
                                                    "POST",
                                                    "PUT",
                                                    "TRACE"
                                                  ],
                                                  "metadata": {
                                                    "description": "Required. A list of HTTP methods that are allowed to be executed by the origin."
                                                  }
                                                },
                                                "allowedOrigins": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of origin domains that will be allowed via CORS, or \"*\" to allow all domains."
                                                  }
                                                },
                                                "exposedHeaders": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. A list of response headers to expose to CORS clients."
                                                  }
                                                },
                                                "maxAgeInSeconds": {
                                                  "type": "int",
                                                  "metadata": {
                                                    "description": "Required. The number of seconds that the client/browser should cache a preflight response."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a cors rule."
                                              }
                                            },
                                            "tableType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the table."
                                                  }
                                                },
                                                "roleAssignments": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/roleAssignmentType"
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Array of role assignments to create."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for a table."
                                              }
                                            },
                                            "diagnosticSettingFullType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the diagnostic setting."
                                                  }
                                                },
                                                "logCategoriesAndGroups": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                        }
                                                      },
                                                      "categoryGroup": {
                                                        "type": "string",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                                  }
                                                },
                                                "metricCategories": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "object",
                                                    "properties": {
                                                      "category": {
                                                        "type": "string",
                                                        "metadata": {
                                                          "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                        }
                                                      },
                                                      "enabled": {
                                                        "type": "bool",
                                                        "nullable": true,
                                                        "metadata": {
                                                          "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                                  }
                                                },
                                                "logAnalyticsDestinationType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "AzureDiagnostics",
                                                    "Dedicated"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                                  }
                                                },
                                                "workspaceResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "storageAccountResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "eventHubAuthorizationRuleResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                                  }
                                                },
                                                "eventHubName": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                                  }
                                                },
                                                "marketplacePartnerResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "storageAccountName": {
                                              "type": "string",
                                              "maxLength": 24,
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "tables": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/tableType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Tables to create."
                                              }
                                            },
                                            "corsRules": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/corsRuleType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The List of CORS rules. You can include up to five CorsRule elements in the request."
                                              }
                                            },
                                            "diagnosticSettings": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/diagnosticSettingFullType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The diagnostic settings of the service."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "name": "default"
                                          },
                                          "resources": {
                                            "storageAccount": {
                                              "existing": true,
                                              "type": "Microsoft.Storage/storageAccounts",
                                              "apiVersion": "2024-01-01",
                                              "name": "[parameters('storageAccountName')]"
                                            },
                                            "tableServices": {
                                              "type": "Microsoft.Storage/storageAccounts/tableServices",
                                              "apiVersion": "2024-01-01",
                                              "name": "[format('{0}/{1}', parameters('storageAccountName'), variables('name'))]",
                                              "properties": {
                                                "cors": "[if(not(equals(parameters('corsRules'), null())), createObject('corsRules', parameters('corsRules')), null())]"
                                              }
                                            },
                                            "tableServices_diagnosticSettings": {
                                              "copy": {
                                                "name": "tableServices_diagnosticSettings",
                                                "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                              },
                                              "type": "Microsoft.Insights/diagnosticSettings",
                                              "apiVersion": "2021-05-01-preview",
                                              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/tableServices/{1}', parameters('storageAccountName'), variables('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', variables('name')))]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "metrics",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                                    "input": {
                                                      "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                                      "timeGrain": null
                                                    }
                                                  },
                                                  {
                                                    "name": "logs",
                                                    "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                                    "input": {
                                                      "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                                      "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                                      "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                                    }
                                                  }
                                                ],
                                                "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                                "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                                "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                                "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                                "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                                "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                              },
                                              "dependsOn": [
                                                "tableServices"
                                              ]
                                            },
                                            "tableServices_tables": {
                                              "copy": {
                                                "name": "tableServices_tables",
                                                "count": "[length(coalesce(parameters('tables'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-Table-{1}', deployment().name, copyIndex())]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[coalesce(parameters('tables'), createArray())[copyIndex()].name]"
                                                  },
                                                  "storageAccountName": {
                                                    "value": "[parameters('storageAccountName')]"
                                                  },
                                                  "roleAssignments": {
                                                    "value": "[tryGet(coalesce(parameters('tables'), createArray())[copyIndex()], 'roleAssignments')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "2494851345252564065"
                                                    },
                                                    "name": "Storage Account Table",
                                                    "description": "This module deploys a Storage Account Table."
                                                  },
                                                  "definitions": {
                                                    "roleAssignmentType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                          }
                                                        },
                                                        "roleDefinitionIdOrName": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                          }
                                                        },
                                                        "principalId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                          }
                                                        },
                                                        "principalType": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "Device",
                                                            "ForeignGroup",
                                                            "Group",
                                                            "ServicePrincipal",
                                                            "User"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The principal type of the assigned principal ID."
                                                          }
                                                        },
                                                        "description": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The description of the role assignment."
                                                          }
                                                        },
                                                        "condition": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                          }
                                                        },
                                                        "conditionVersion": {
                                                          "type": "string",
                                                          "allowedValues": [
                                                            "2.0"
                                                          ],
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. Version of the condition."
                                                          }
                                                        },
                                                        "delegatedManagedIdentityResourceId": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "description": "An AVM-aligned type for a role assignment.",
                                                        "__bicep_imported_from!": {
                                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "storageAccountName": {
                                                      "type": "string",
                                                      "maxLength": 24,
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Storage Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "roleAssignments": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/roleAssignmentType"
                                                      },
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Array of role assignments to create."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the table."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "formattedRoleAssignments",
                                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                                      }
                                                    ],
                                                    "builtInRoleNames": {
                                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                                      "Reader and Data Access": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c12c1c16-33a1-487b-954d-41c89c60f349')]",
                                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                                      "Storage Account Backup Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e5e2a7ff-d759-4cd2-bb51-3152d37e2eb1')]",
                                                      "Storage Account Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
                                                      "Storage Account Key Operator Service Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '81a9662b-bebf-436f-a333-f67b29880f12')]",
                                                      "Storage Table Data Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3')]",
                                                      "Storage Table Data Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '76199698-9eea-4c19-bc75-cec21354c6b6')]",
                                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                                    }
                                                  },
                                                  "resources": {
                                                    "storageAccount::tableServices": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts/tableServices",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]"
                                                    },
                                                    "storageAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[parameters('storageAccountName')]"
                                                    },
                                                    "table": {
                                                      "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
                                                      "apiVersion": "2024-01-01",
                                                      "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('name'))]"
                                                    },
                                                    "table_roleAssignments": {
                                                      "copy": {
                                                        "name": "table_roleAssignments",
                                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                                      },
                                                      "type": "Microsoft.Authorization/roleAssignments",
                                                      "apiVersion": "2022-04-01",
                                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}/tableServices/{1}/tables/{2}', parameters('storageAccountName'), 'default', parameters('name'))]",
                                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Storage/storageAccounts/tableServices/tables', parameters('storageAccountName'), 'default', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                                      "properties": {
                                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                                      },
                                                      "dependsOn": [
                                                        "table"
                                                      ]
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the deployed table."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the deployed table."
                                                      },
                                                      "value": "[resourceId('Microsoft.Storage/storageAccounts/tableServices/tables', parameters('storageAccountName'), 'default', parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group of the deployed table."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the deployed table service."
                                              },
                                              "value": "[variables('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the deployed table service."
                                              },
                                              "value": "[resourceId('Microsoft.Storage/storageAccounts/tableServices', parameters('storageAccountName'), variables('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group of the deployed table service."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "secretsExport": {
                                      "condition": "[not(equals(parameters('secretsExportConfiguration'), null()))]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-secrets-kv', uniqueString(deployment().name, parameters('location')))]",
                                      "subscriptionId": "[split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/')[2]]",
                                      "resourceGroup": "[split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "keyVaultName": {
                                            "value": "[last(split(tryGet(parameters('secretsExportConfiguration'), 'keyVaultResourceId'), '/'))]"
                                          },
                                          "secretsToSet": {
                                            "value": "[union(createArray(), if(contains(parameters('secretsExportConfiguration'), 'accessKey1Name'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'accessKey1Name'), 'value', listKeys('storageAccount', '2025-01-01').keys[0].value)), createArray()), if(contains(parameters('secretsExportConfiguration'), 'connectionString1Name'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'connectionString1Name'), 'value', format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('name'), listKeys('storageAccount', '2025-01-01').keys[0].value, environment().suffixes.storage))), createArray()), if(contains(parameters('secretsExportConfiguration'), 'accessKey2Name'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'accessKey2Name'), 'value', listKeys('storageAccount', '2025-01-01').keys[1].value)), createArray()), if(contains(parameters('secretsExportConfiguration'), 'connectionString2Name'), createArray(createObject('name', tryGet(parameters('secretsExportConfiguration'), 'connectionString2Name'), 'value', format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('name'), listKeys('storageAccount', '2025-01-01').keys[1].value, environment().suffixes.storage))), createArray()))]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "15162266628501794465"
                                            }
                                          },
                                          "definitions": {
                                            "secretSetOutputType": {
                                              "type": "object",
                                              "properties": {
                                                "secretResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The resourceId of the exported secret."
                                                  }
                                                },
                                                "secretUri": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The secret URI of the exported secret."
                                                  }
                                                },
                                                "secretUriWithVersion": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "The secret URI with version of the exported secret."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for the output of the secret set via the secrets export feature.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                                }
                                              }
                                            },
                                            "secretToSetType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the secret to set."
                                                  }
                                                },
                                                "value": {
                                                  "type": "securestring",
                                                  "metadata": {
                                                    "description": "Required. The value of the secret to set."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for the secret to set via the secrets export feature.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.0"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "keyVaultName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The name of the Key Vault to set the ecrets in."
                                              }
                                            },
                                            "secretsToSet": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/secretToSetType"
                                              },
                                              "metadata": {
                                                "description": "Required. The secrets to set in the Key Vault."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "keyVault": {
                                              "existing": true,
                                              "type": "Microsoft.KeyVault/vaults",
                                              "apiVersion": "2024-11-01",
                                              "name": "[parameters('keyVaultName')]"
                                            },
                                            "secrets": {
                                              "copy": {
                                                "name": "secrets",
                                                "count": "[length(parameters('secretsToSet'))]"
                                              },
                                              "type": "Microsoft.KeyVault/vaults/secrets",
                                              "apiVersion": "2024-11-01",
                                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretsToSet')[copyIndex()].name)]",
                                              "properties": {
                                                "value": "[parameters('secretsToSet')[copyIndex()].value]"
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "secretsSet": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/secretSetOutputType"
                                              },
                                              "metadata": {
                                                "description": "The references to the secrets exported to the provided Key Vault."
                                              },
                                              "copy": {
                                                "count": "[length(range(0, length(coalesce(parameters('secretsToSet'), createArray()))))]",
                                                "input": {
                                                  "secretResourceId": "[resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretsToSet')[range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()]].name)]",
                                                  "secretUri": "[reference(format('secrets[{0}]', range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()])).secretUri]",
                                                  "secretUriWithVersion": "[reference(format('secrets[{0}]', range(0, length(coalesce(parameters('secretsToSet'), createArray())))[copyIndex()])).secretUriWithVersion]"
                                                }
                                              }
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount"
                                      ]
                                    },
                                    "storageAccount_objectReplicationPolicies": {
                                      "copy": {
                                        "name": "storageAccount_objectReplicationPolicies",
                                        "count": "[length(coalesce(parameters('objectReplicationPolicies'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-Storage-ObjRepPolicy-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "storageAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "destinationAccountResourceId": {
                                            "value": "[coalesce(parameters('objectReplicationPolicies'), createArray())[copyIndex()].destinationStorageAccountResourceId]"
                                          },
                                          "enableMetrics": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('objectReplicationPolicies'), createArray())[copyIndex()], 'enableMetrics'), false())]"
                                          },
                                          "rules": {
                                            "value": "[tryGet(coalesce(parameters('objectReplicationPolicies'), createArray())[copyIndex()], 'rules')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "7981342209922290627"
                                            },
                                            "name": "Storage Account Object Replication Policy",
                                            "description": "This module deploys a Storage Account Object Replication Policy for both the source account and destination account."
                                          },
                                          "definitions": {
                                            "objectReplicationPolicyRuleType": {
                                              "type": "object",
                                              "properties": {
                                                "ruleId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The ID of the rule. Auto-generated on destination account. Required for source account."
                                                  }
                                                },
                                                "containerName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The name of the source container."
                                                  }
                                                },
                                                "destinationContainerName": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the destination container. If not provided, the same name as the source container will be used."
                                                  }
                                                },
                                                "filters": {
                                                  "type": "object",
                                                  "properties": {
                                                    "prefixMatch": {
                                                      "type": "array",
                                                      "items": {
                                                        "type": "string"
                                                      },
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. The prefix to match for the replication policy rule."
                                                      }
                                                    },
                                                    "minCreationTime": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. The minimum creation time to match for the replication policy rule."
                                                      }
                                                    }
                                                  },
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The filters for the object replication policy rule."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "The type of an object replication policy rule.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "policy/main.bicep"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Name of the policy."
                                              }
                                            },
                                            "storageAccountName": {
                                              "type": "string",
                                              "maxLength": 24,
                                              "metadata": {
                                                "description": "Required. The name of the parent Storage Account."
                                              }
                                            },
                                            "destinationAccountResourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Resource ID of the destination storage account for replication."
                                              }
                                            },
                                            "enableMetrics": {
                                              "type": "bool",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Whether metrics are enabled for the object replication policy."
                                              }
                                            },
                                            "rules": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/objectReplicationPolicyRuleType"
                                              },
                                              "metadata": {
                                                "description": "Required. Rules for the object replication policy."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "destAccountResourceIdParts": "[split(parameters('destinationAccountResourceId'), '/')]",
                                            "destAccountName": "[if(not(empty(variables('destAccountResourceIdParts'))), last(variables('destAccountResourceIdParts')), parameters('destinationAccountResourceId'))]",
                                            "destAccountSubscription": "[if(greater(length(variables('destAccountResourceIdParts')), 2), variables('destAccountResourceIdParts')[2], subscription().subscriptionId)]",
                                            "destAccountResourceGroupName": "[if(greater(length(variables('destAccountResourceIdParts')), 4), variables('destAccountResourceIdParts')[4], resourceGroup().name)]"
                                          },
                                          "resources": {
                                            "storageAccount": {
                                              "existing": true,
                                              "type": "Microsoft.Storage/storageAccounts",
                                              "apiVersion": "2025-01-01",
                                              "name": "[parameters('storageAccountName')]"
                                            },
                                            "destinationPolicy": {
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[take(format('{0}-ObjRep-Policy-dest-{1}', deployment().name, variables('destAccountName')), 64)]",
                                              "subscriptionId": "[variables('destAccountSubscription')]",
                                              "resourceGroup": "[variables('destAccountResourceGroupName')]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[coalesce(parameters('name'), 'default')]"
                                                  },
                                                  "storageAccountName": {
                                                    "value": "[variables('destAccountName')]"
                                                  },
                                                  "sourceStorageAccountResourceId": {
                                                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                                                  },
                                                  "destinationAccountResourceId": {
                                                    "value": "[parameters('destinationAccountResourceId')]"
                                                  },
                                                  "enableMetrics": {
                                                    "value": "[parameters('enableMetrics')]"
                                                  },
                                                  "rules": {
                                                    "value": "[parameters('rules')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "13231340475360081313"
                                                    },
                                                    "name": "Storage Account Object Replication Policy",
                                                    "description": "This module deploys a Storage Account Object Replication Policy for a provided storage account."
                                                  },
                                                  "definitions": {
                                                    "objectReplicationPolicyRuleType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "ruleId": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The ID of the rule. Auto-generated on destination account. Required for source account."
                                                          }
                                                        },
                                                        "containerName": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The name of the source container."
                                                          }
                                                        },
                                                        "destinationContainerName": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name of the destination container. If not provided, the same name as the source container will be used."
                                                          }
                                                        },
                                                        "filters": {
                                                          "type": "object",
                                                          "properties": {
                                                            "prefixMatch": {
                                                              "type": "array",
                                                              "items": {
                                                                "type": "string"
                                                              },
                                                              "nullable": true,
                                                              "metadata": {
                                                                "description": "Optional. The prefix to match for the replication policy rule."
                                                              }
                                                            },
                                                            "minCreationTime": {
                                                              "type": "string",
                                                              "nullable": true,
                                                              "metadata": {
                                                                "description": "Optional. The minimum creation time to match for the replication policy rule."
                                                              }
                                                            }
                                                          },
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The filters for the object replication policy rule."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true,
                                                        "description": "The type of an object replication policy rule."
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the policy."
                                                      }
                                                    },
                                                    "storageAccountName": {
                                                      "type": "string",
                                                      "maxLength": 24,
                                                      "metadata": {
                                                        "description": "Required. The name of the Storage Account on which to create the policy."
                                                      }
                                                    },
                                                    "sourceStorageAccountResourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Resource ID of the source storage account for replication."
                                                      }
                                                    },
                                                    "destinationAccountResourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Resource ID of the destination storage account for replication."
                                                      }
                                                    },
                                                    "enableMetrics": {
                                                      "type": "bool",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Whether metrics are enabled for the object replication policy."
                                                      }
                                                    },
                                                    "rules": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/objectReplicationPolicyRuleType"
                                                      },
                                                      "metadata": {
                                                        "description": "Required. Rules for the object replication policy."
                                                      }
                                                    }
                                                  },
                                                  "resources": {
                                                    "storageAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts",
                                                      "apiVersion": "2025-01-01",
                                                      "name": "[parameters('storageAccountName')]"
                                                    },
                                                    "objectReplicationPolicy": {
                                                      "type": "Microsoft.Storage/storageAccounts/objectReplicationPolicies",
                                                      "apiVersion": "2025-01-01",
                                                      "name": "[format('{0}/{1}', parameters('storageAccountName'), parameters('name'))]",
                                                      "properties": {
                                                        "copy": [
                                                          {
                                                            "name": "rules",
                                                            "count": "[length(parameters('rules'))]",
                                                            "input": {
                                                              "ruleId": "[tryGet(parameters('rules')[copyIndex('rules')], 'ruleId')]",
                                                              "sourceContainer": "[parameters('rules')[copyIndex('rules')].containerName]",
                                                              "destinationContainer": "[coalesce(tryGet(parameters('rules')[copyIndex('rules')], 'destinationContainerName'), parameters('rules')[copyIndex('rules')].containerName)]",
                                                              "filters": "[if(not(equals(tryGet(parameters('rules')[copyIndex('rules')], 'filters'), null())), createObject('prefixMatch', tryGet(tryGet(parameters('rules')[copyIndex('rules')], 'filters'), 'prefixMatch'), 'minCreationTime', tryGet(tryGet(parameters('rules')[copyIndex('rules')], 'filters'), 'minCreationTime')), null())]"
                                                            }
                                                          }
                                                        ],
                                                        "destinationAccount": "[parameters('destinationAccountResourceId')]",
                                                        "metrics": {
                                                          "enabled": "[coalesce(parameters('enableMetrics'), false())]"
                                                        },
                                                        "sourceAccount": "[parameters('sourceStorageAccountResourceId')]"
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Resource group name of the provisioned resources."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    },
                                                    "objectReplicationPolicyId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Resource ID of the created Object Replication Policy."
                                                      },
                                                      "value": "[resourceId('Microsoft.Storage/storageAccounts/objectReplicationPolicies', parameters('storageAccountName'), parameters('name'))]"
                                                    },
                                                    "policyId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Policy ID of the created Object Replication Policy."
                                                      },
                                                      "value": "[reference('objectReplicationPolicy').policyId]"
                                                    },
                                                    "rules": {
                                                      "type": "array",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.Storage/storageAccounts/objectReplicationPolicies@2025-01-01#properties/properties/properties/rules",
                                                          "output": true
                                                        },
                                                        "description": "Rules created Object Replication Policy."
                                                      },
                                                      "value": "[reference('objectReplicationPolicy').rules]"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "sourcePolicy": {
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[take(format('{0}-ObjRep-Policy-source-{1}', deployment().name, parameters('storageAccountName')), 64)]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[reference('destinationPolicy').outputs.policyId.value]"
                                                  },
                                                  "storageAccountName": {
                                                    "value": "[parameters('storageAccountName')]"
                                                  },
                                                  "sourceStorageAccountResourceId": {
                                                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                                                  },
                                                  "destinationAccountResourceId": {
                                                    "value": "[parameters('destinationAccountResourceId')]"
                                                  },
                                                  "enableMetrics": {
                                                    "value": "[parameters('enableMetrics')]"
                                                  },
                                                  "rules": {
                                                    "copy": [
                                                      {
                                                        "name": "value",
                                                        "count": "[length(parameters('rules'))]",
                                                        "input": "[union(parameters('rules')[copyIndex('value')], createObject('ruleId', reference('destinationPolicy').outputs.rules.value[copyIndex('value')].ruleId))]"
                                                      }
                                                    ]
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "13231340475360081313"
                                                    },
                                                    "name": "Storage Account Object Replication Policy",
                                                    "description": "This module deploys a Storage Account Object Replication Policy for a provided storage account."
                                                  },
                                                  "definitions": {
                                                    "objectReplicationPolicyRuleType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "ruleId": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The ID of the rule. Auto-generated on destination account. Required for source account."
                                                          }
                                                        },
                                                        "containerName": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The name of the source container."
                                                          }
                                                        },
                                                        "destinationContainerName": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name of the destination container. If not provided, the same name as the source container will be used."
                                                          }
                                                        },
                                                        "filters": {
                                                          "type": "object",
                                                          "properties": {
                                                            "prefixMatch": {
                                                              "type": "array",
                                                              "items": {
                                                                "type": "string"
                                                              },
                                                              "nullable": true,
                                                              "metadata": {
                                                                "description": "Optional. The prefix to match for the replication policy rule."
                                                              }
                                                            },
                                                            "minCreationTime": {
                                                              "type": "string",
                                                              "nullable": true,
                                                              "metadata": {
                                                                "description": "Optional. The minimum creation time to match for the replication policy rule."
                                                              }
                                                            }
                                                          },
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The filters for the object replication policy rule."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true,
                                                        "description": "The type of an object replication policy rule."
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the policy."
                                                      }
                                                    },
                                                    "storageAccountName": {
                                                      "type": "string",
                                                      "maxLength": 24,
                                                      "metadata": {
                                                        "description": "Required. The name of the Storage Account on which to create the policy."
                                                      }
                                                    },
                                                    "sourceStorageAccountResourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Resource ID of the source storage account for replication."
                                                      }
                                                    },
                                                    "destinationAccountResourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Resource ID of the destination storage account for replication."
                                                      }
                                                    },
                                                    "enableMetrics": {
                                                      "type": "bool",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Whether metrics are enabled for the object replication policy."
                                                      }
                                                    },
                                                    "rules": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/objectReplicationPolicyRuleType"
                                                      },
                                                      "metadata": {
                                                        "description": "Required. Rules for the object replication policy."
                                                      }
                                                    }
                                                  },
                                                  "resources": {
                                                    "storageAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.Storage/storageAccounts",
                                                      "apiVersion": "2025-01-01",
                                                      "name": "[parameters('storageAccountName')]"
                                                    },
                                                    "objectReplicationPolicy": {
                                                      "type": "Microsoft.Storage/storageAccounts/objectReplicationPolicies",
                                                      "apiVersion": "2025-01-01",
                                                      "name": "[format('{0}/{1}', parameters('storageAccountName'), parameters('name'))]",
                                                      "properties": {
                                                        "copy": [
                                                          {
                                                            "name": "rules",
                                                            "count": "[length(parameters('rules'))]",
                                                            "input": {
                                                              "ruleId": "[tryGet(parameters('rules')[copyIndex('rules')], 'ruleId')]",
                                                              "sourceContainer": "[parameters('rules')[copyIndex('rules')].containerName]",
                                                              "destinationContainer": "[coalesce(tryGet(parameters('rules')[copyIndex('rules')], 'destinationContainerName'), parameters('rules')[copyIndex('rules')].containerName)]",
                                                              "filters": "[if(not(equals(tryGet(parameters('rules')[copyIndex('rules')], 'filters'), null())), createObject('prefixMatch', tryGet(tryGet(parameters('rules')[copyIndex('rules')], 'filters'), 'prefixMatch'), 'minCreationTime', tryGet(tryGet(parameters('rules')[copyIndex('rules')], 'filters'), 'minCreationTime')), null())]"
                                                            }
                                                          }
                                                        ],
                                                        "destinationAccount": "[parameters('destinationAccountResourceId')]",
                                                        "metrics": {
                                                          "enabled": "[coalesce(parameters('enableMetrics'), false())]"
                                                        },
                                                        "sourceAccount": "[parameters('sourceStorageAccountResourceId')]"
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Resource group name of the provisioned resources."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    },
                                                    "objectReplicationPolicyId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Resource ID of the created Object Replication Policy."
                                                      },
                                                      "value": "[resourceId('Microsoft.Storage/storageAccounts/objectReplicationPolicies', parameters('storageAccountName'), parameters('name'))]"
                                                    },
                                                    "policyId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Policy ID of the created Object Replication Policy."
                                                      },
                                                      "value": "[reference('objectReplicationPolicy').policyId]"
                                                    },
                                                    "rules": {
                                                      "type": "array",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.Storage/storageAccounts/objectReplicationPolicies@2025-01-01#properties/properties/properties/rules",
                                                          "output": true
                                                        },
                                                        "description": "Rules created Object Replication Policy."
                                                      },
                                                      "value": "[reference('objectReplicationPolicy').rules]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "destinationPolicy"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Resource group name of the provisioned resources."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "objectReplicationPolicyId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Resource ID of the created Object Replication Policy in the source account."
                                              },
                                              "value": "[reference('sourcePolicy').outputs.objectReplicationPolicyId.value]"
                                            },
                                            "policyId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Policy ID of the created Object Replication Policy in the source account."
                                              },
                                              "value": "[reference('sourcePolicy').outputs.policyId.value]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "storageAccount",
                                        "storageAccount_blobServices"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the deployed storage account."
                                      },
                                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                                    },
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the deployed storage account."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource group of the deployed storage account."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "primaryBlobEndpoint": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The primary blob endpoint reference if blob services are deployed."
                                      },
                                      "value": "[if(and(not(empty(parameters('blobServices'))), contains(parameters('blobServices'), 'containers')), reference(format('Microsoft.Storage/storageAccounts/{0}', parameters('name')), '2019-04-01').primaryEndpoints.blob, '')]"
                                    },
                                    "systemAssignedMIPrincipalId": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "The principal ID of the system assigned identity."
                                      },
                                      "value": "[tryGet(tryGet(reference('storageAccount', '2025-01-01', 'full'), 'identity'), 'principalId')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('storageAccount', '2025-01-01', 'full').location]"
                                    },
                                    "serviceEndpoints": {
                                      "type": "object",
                                      "metadata": {
                                        "description": "All service endpoints of the deployed storage account, Note Standard_LRS and Standard_ZRS accounts only have a blob service endpoint."
                                      },
                                      "value": "[reference('storageAccount').primaryEndpoints]"
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointOutputType"
                                      },
                                      "metadata": {
                                        "description": "The private endpoints of the Storage Account."
                                      },
                                      "copy": {
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]",
                                        "input": {
                                          "name": "[reference(format('storageAccount_privateEndpoints[{0}]', copyIndex())).outputs.name.value]",
                                          "resourceId": "[reference(format('storageAccount_privateEndpoints[{0}]', copyIndex())).outputs.resourceId.value]",
                                          "groupId": "[tryGet(tryGet(reference(format('storageAccount_privateEndpoints[{0}]', copyIndex())).outputs, 'groupId'), 'value')]",
                                          "customDnsConfigs": "[reference(format('storageAccount_privateEndpoints[{0}]', copyIndex())).outputs.customDnsConfigs.value]",
                                          "networkInterfaceResourceIds": "[reference(format('storageAccount_privateEndpoints[{0}]', copyIndex())).outputs.networkInterfaceResourceIds.value]"
                                        }
                                      }
                                    },
                                    "exportedSecrets": {
                                      "$ref": "#/definitions/secretsOutputType",
                                      "metadata": {
                                        "description": "A hashtable of references to the secrets exported to the provided Key Vault. The key of each reference is each secret's name."
                                      },
                                      "value": "[if(not(equals(parameters('secretsExportConfiguration'), null())), toObject(reference('secretsExport').outputs.secretsSet.value, lambda('secret', last(split(lambdaVariables('secret').secretResourceId, '/'))), lambda('secret', lambdaVariables('secret'))), createObject())]"
                                    },
                                    "primaryAccessKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The primary access key of the storage account."
                                      },
                                      "value": "[listKeys('storageAccount', '2025-01-01').keys[0].value]"
                                    },
                                    "secondaryAccessKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The secondary access key of the storage account."
                                      },
                                      "value": "[listKeys('storageAccount', '2025-01-01').keys[1].value]"
                                    },
                                    "primaryConnectionString": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The primary connection string of the storage account."
                                      },
                                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('name'), listKeys('storageAccount', '2025-01-01').keys[0].value, environment().suffixes.storage)]"
                                    },
                                    "secondaryConnectionString": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The secondary connection string of the storage account."
                                      },
                                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('name'), listKeys('storageAccount', '2025-01-01').keys[1].value, environment().suffixes.storage)]"
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Name of the Storage Account."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('storageAccount').outputs.name.value, variables('existingName'))]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource ID of the Storage Account."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('storageAccount').outputs.resourceId.value, extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('existingSubscriptionId'), variables('existingResourceGroupName')), 'Microsoft.Storage/storageAccounts', variables('existingName')))]"
                            },
                            "subscriptionId": {
                              "type": "string",
                              "metadata": {
                                "description": "Subscription ID of the Storage Account."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), subscription().subscriptionId, variables('existingSubscriptionId'))]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource Group Name of the Storage Account."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), resourceGroup().name, variables('existingResourceGroupName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "aiSearch",
                        "foundryAccount"
                      ]
                    },
                    "cosmosDb": {
                      "condition": "[parameters('includeAssociatedResources')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[take(format('module.cosmosDb.{0}', variables('resourcesName')), 64)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "existingResourceId": {
                            "value": "[tryGet(parameters('cosmosDbConfiguration'), 'existingResourceId')]"
                          },
                          "name": {
                            "value": "[take(if(not(empty(tryGet(parameters('cosmosDbConfiguration'), 'name'))), parameters('cosmosDbConfiguration').name, format('cos{0}', variables('resourcesName'))), 44)]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "enableTelemetry": {
                            "value": "[parameters('enableTelemetry')]"
                          },
                          "privateEndpointSubnetResourceId": {
                            "value": "[parameters('privateEndpointSubnetResourceId')]"
                          },
                          "privateDnsZoneResourceId": {
                            "value": "[tryGet(parameters('cosmosDbConfiguration'), 'privateDnsZoneResourceId')]"
                          },
                          "roleAssignments": {
                            "value": "[tryGet(parameters('cosmosDbConfiguration'), 'roleAssignments')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "4729737487417358981"
                            }
                          },
                          "definitions": {
                            "roleAssignmentType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                  }
                                },
                                "roleDefinitionIdOrName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                  }
                                },
                                "principalId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                  }
                                },
                                "principalType": {
                                  "type": "string",
                                  "allowedValues": [
                                    "Device",
                                    "ForeignGroup",
                                    "Group",
                                    "ServicePrincipal",
                                    "User"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The principal type of the assigned principal ID."
                                  }
                                },
                                "description": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The description of the role assignment."
                                  }
                                },
                                "condition": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                  }
                                },
                                "conditionVersion": {
                                  "type": "string",
                                  "allowedValues": [
                                    "2.0"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Version of the condition."
                                  }
                                },
                                "delegatedManagedIdentityResourceId": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a role assignment.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                }
                              }
                            }
                          },
                          "functions": [
                            {
                              "namespace": "__bicep",
                              "members": {
                                "getResourceGroupName": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 4), parameters('parts')[4], resourceGroup().name)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Group Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceName": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    },
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(and(and(not(empty(parameters('resourceId'))), contains(parameters('resourceId'), '/')), not(empty(parameters('parts')))), last(parameters('parts')), coalesce(parameters('resourceId'), ''))]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Resource Name from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getResourceParts": {
                                  "parameters": [
                                    {
                                      "type": "string",
                                      "nullable": true,
                                      "name": "resourceId"
                                    }
                                  ],
                                  "output": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "value": "[split(coalesce(parameters('resourceId'), ''), '/')]"
                                  },
                                  "metadata": {
                                    "description": "Splits Resource ID into its components.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                },
                                "getSubscriptionId": {
                                  "parameters": [
                                    {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "name": "parts"
                                    }
                                  ],
                                  "output": {
                                    "type": "string",
                                    "value": "[if(greater(length(parameters('parts')), 2), parameters('parts')[2], subscription().subscriptionId)]"
                                  },
                                  "metadata": {
                                    "description": "Extracts the Subscription ID from a Resource ID.",
                                    "__bicep_imported_from!": {
                                      "sourceTemplate": "parseResourceIdFunctions.bicep"
                                    }
                                  }
                                }
                              }
                            }
                          ],
                          "parameters": {
                            "name": {
                              "type": "string",
                              "maxLength": 44,
                              "metadata": {
                                "description": "Required. The name of the Cosmos DB."
                              }
                            },
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. The location for the Cosmos DB."
                              }
                            },
                            "existingResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The full resource ID of an existing Cosmos DB to use instead of creating a new one."
                              }
                            },
                            "privateEndpointSubnetResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Resource Id of an existing subnet to use for private connectivity. This is required along with 'privateDnsZoneResourceId' to establish private endpoints."
                              }
                            },
                            "privateDnsZoneResourceId": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The resource ID of the private DNS zone for the Cosmos DB to establish private endpoints."
                              }
                            },
                            "roleAssignments": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/roleAssignmentType"
                              },
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Specifies the role assignments for the Cosmos DB."
                              }
                            },
                            "enableTelemetry": {
                              "type": "bool",
                              "defaultValue": true,
                              "metadata": {
                                "description": "Optional. Enable/Disable usage telemetry for module."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Resources/resourceGroups@2025-04-01#properties/tags"
                                },
                                "description": "Optional. Specifies the resource tags for all the resources."
                              },
                              "defaultValue": {}
                            }
                          },
                          "variables": {
                            "existingResourceParts": "[__bicep.getResourceParts(parameters('existingResourceId'))]",
                            "existingName": "[__bicep.getResourceName(parameters('existingResourceId'), variables('existingResourceParts'))]",
                            "existingSubscriptionId": "[__bicep.getSubscriptionId(variables('existingResourceParts'))]",
                            "existingResourceGroupName": "[__bicep.getResourceGroupName(variables('existingResourceParts'))]",
                            "privateNetworkingEnabled": "[and(not(empty(parameters('privateDnsZoneResourceId'))), not(empty(parameters('privateEndpointSubnetResourceId'))))]"
                          },
                          "resources": {
                            "existingCosmosDb": {
                              "condition": "[not(empty(parameters('existingResourceId')))]",
                              "existing": true,
                              "type": "Microsoft.DocumentDB/databaseAccounts",
                              "apiVersion": "2025-04-15",
                              "subscriptionId": "[variables('existingSubscriptionId')]",
                              "resourceGroup": "[variables('existingResourceGroupName')]",
                              "name": "[variables('existingName')]"
                            },
                            "cosmosDb": {
                              "condition": "[empty(parameters('existingResourceId'))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('avm.res.document-db.database-account.{0}', parameters('name')), 64)]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "name": {
                                    "value": "[parameters('name')]"
                                  },
                                  "enableTelemetry": {
                                    "value": "[parameters('enableTelemetry')]"
                                  },
                                  "enableAutomaticFailover": {
                                    "value": true
                                  },
                                  "disableKeyBasedMetadataWriteAccess": {
                                    "value": true
                                  },
                                  "disableLocalAuthentication": {
                                    "value": true
                                  },
                                  "location": {
                                    "value": "[parameters('location')]"
                                  },
                                  "minimumTlsVersion": {
                                    "value": "Tls12"
                                  },
                                  "defaultConsistencyLevel": {
                                    "value": "Session"
                                  },
                                  "networkRestrictions": {
                                    "value": {
                                      "networkAclBypass": "AzureServices",
                                      "publicNetworkAccess": "[if(variables('privateNetworkingEnabled'), 'Disabled', 'Enabled')]"
                                    }
                                  },
                                  "privateEndpoints": "[if(variables('privateNetworkingEnabled'), createObject('value', createArray(createObject('privateDnsZoneGroup', createObject('privateDnsZoneGroupConfigs', createArray(createObject('privateDnsZoneResourceId', parameters('privateDnsZoneResourceId')))), 'service', 'Sql', 'subnetResourceId', parameters('privateEndpointSubnetResourceId')))), createObject('value', createArray()))]",
                                  "roleAssignments": {
                                    "value": "[parameters('roleAssignments')]"
                                  },
                                  "tags": {
                                    "value": "[parameters('tags')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "languageVersion": "2.0",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.38.33.27573",
                                      "templateHash": "11889744396543212232"
                                    },
                                    "name": "Azure Cosmos DB account",
                                    "description": "This module deploys an Azure Cosmos DB account. The API used for the account is determined by the child resources that are deployed."
                                  },
                                  "definitions": {
                                    "privateEndpointOutputType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The name of the private endpoint."
                                          }
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "The resource ID of the private endpoint."
                                          }
                                        },
                                        "groupId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "The group ID for the private endpoint group."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "fqdn": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "fully-qualified domain name (FQDN) that resolves to private endpoint IP address."
                                                }
                                              },
                                              "ipAddresses": {
                                                "type": "array",
                                                "items": {
                                                  "type": "string"
                                                },
                                                "metadata": {
                                                  "description": "A list of private IP addresses for the private endpoint."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "The custom DNS configurations of the private endpoint."
                                          }
                                        },
                                        "networkInterfaceResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "The IDs of the network interfaces associated with the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for the private endpoint output."
                                      }
                                    },
                                    "failoverLocationType": {
                                      "type": "object",
                                      "properties": {
                                        "failoverPriority": {
                                          "type": "int",
                                          "metadata": {
                                            "description": "Required. The failover priority of the region. A failover priority of 0 indicates a write region. The maximum value for a failover priority = (total number of regions - 1). Failover priority values must be unique for each of the regions in which the database account exists."
                                          }
                                        },
                                        "isZoneRedundant": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Flag to indicate whether or not this region is an AvailabilityZone region. Defaults to true."
                                          }
                                        },
                                        "locationName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the region."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for the failover location."
                                      }
                                    },
                                    "sqlRoleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The unique name of the role assignment."
                                          }
                                        },
                                        "roleDefinitionId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The unique identifier of the Azure Cosmos DB for NoSQL native role-based access control definition."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The unique identifier for the associated Microsoft Entra ID principal to which access is being granted through this role-based access control assignment. The tenant ID for the principal is inferred using the tenant associated with the subscription."
                                          }
                                        },
                                        "scope": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The data plane resource id for which access is being granted through this Role Assignment. Defaults to the root of the database account, but can also be scoped to e.g., the container and database level."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for an Azure Cosmos DB for NoSQL native role-based access control assignment."
                                      }
                                    },
                                    "sqlRoleDefinitionType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The unique identifier of the role-based access control definition."
                                          }
                                        },
                                        "roleName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. A user-friendly name for the role-based access control definition. This must be unique within the database account."
                                          }
                                        },
                                        "dataActions": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "minLength": 1,
                                          "metadata": {
                                            "description": "Required. An array of data actions that are allowed."
                                          }
                                        },
                                        "assignableScopes": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A set of fully-qualified scopes at or below which role-based access control assignments may be created using this definition. This setting allows application of this definition on the entire account or any underlying resource. This setting must have at least one element. Scopes higher than the account level are not enforceable as assignable scopes. Resources referenced in assignable scopes do not need to exist at creation. Defaults to the current account scope."
                                          }
                                        },
                                        "assignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/nestedSqlRoleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. An array of role-based access control assignments to be created for the definition."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for an Azure Cosmos DB for NoSQL or Table native role-based access control definition."
                                      }
                                    },
                                    "networkRestrictionType": {
                                      "type": "object",
                                      "properties": {
                                        "ipRules": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A single IPv4 address or a single IPv4 address range in Classless Inter-Domain Routing (CIDR) format. Provided IPs must be well-formatted and cannot be contained in one of the following ranges: `10.0.0.0/8`, `100.64.0.0/10`, `172.16.0.0/12`, `192.168.0.0/16`, since these are not enforceable by the IP address filter. Example of valid inputs: `23.40.210.245` or `23.40.210.0/8`."
                                          }
                                        },
                                        "networkAclBypass": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureServices",
                                            "None"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specifies the network ACL bypass for Azure services. Default to \"None\"."
                                          }
                                        },
                                        "publicNetworkAccess": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Disabled",
                                            "Enabled"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Whether requests from the public network are allowed. Default to \"Disabled\"."
                                          }
                                        },
                                        "virtualNetworkRules": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "subnetResourceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. Resource ID of a subnet."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. List of virtual network access control list (ACL) rules configured for the account."
                                          }
                                        },
                                        "networkAclBypassResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. An array that contains the Resource Ids for Network Acl Bypass for the Cosmos DB account."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for the network restriction."
                                      }
                                    },
                                    "gremlinDatabaseType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the Gremlin database."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases@2024-11-15#properties/tags"
                                            },
                                            "description": "Optional. Tags of the Gremlin database resource."
                                          },
                                          "nullable": true
                                        },
                                        "graphs": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/graphType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of graphs to deploy in the Gremlin database."
                                          }
                                        },
                                        "maxThroughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored. Setting throughput at the database level is only recommended for development/test or when workload across all graphs in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the graph level and not at the database level."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `maxThroughput`. Setting throughput at the database level is only recommended for development/test or when workload across all graphs in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the graph level and not at the database level."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a gremlin databae."
                                      }
                                    },
                                    "mongoDbType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the mongodb database."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request Units per second. Setting throughput at the database level is only recommended for development/test or when workload across all collections in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the collection level and not at the database level."
                                          }
                                        },
                                        "collections": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/collectionType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Collections in the mongodb database."
                                          }
                                        },
                                        "autoscaleSettings": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases@2025-04-15#properties/properties/properties/options/properties/autoscaleSettings"
                                            },
                                            "description": "Optional. Specifies the Autoscale settings. Note: Either throughput or autoscaleSettings is required, but not both."
                                          },
                                          "nullable": true
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases@2025-04-15#properties/tags"
                                            },
                                            "description": "Optional. Tags of the resource."
                                          },
                                          "nullable": true
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a mongo databae."
                                      }
                                    },
                                    "sqlDatabaseType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the SQL database ."
                                          }
                                        },
                                        "containers": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/containerType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of containers to deploy in the SQL database."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request units per second. Will be ignored if autoscaleSettingsMaxThroughput is used. Setting throughput at the database level is only recommended for development/test or when workload across all containers in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                          }
                                        },
                                        "autoscaleSettingsMaxThroughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specifies the Autoscale settings and represents maximum throughput, the resource can scale up to. The autoscale throughput should have valid throughput values between 1000 and 1000000 inclusive in increments of 1000. If value is set to null, then autoscale will be disabled. Setting throughput at the database level is only recommended for development/test or when workload across all containers in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases@2025-04-15#properties/tags"
                                            },
                                            "description": "Optional. Tags of the SQL database resource."
                                          },
                                          "nullable": true
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a sql database."
                                      }
                                    },
                                    "tableType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the table."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/tables@2025-04-15#properties/tags"
                                            },
                                            "description": "Optional. Tags for the table."
                                          },
                                          "nullable": true
                                        },
                                        "maxThroughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `maxThroughput`."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for a table."
                                      }
                                    },
                                    "cassandraStandaloneRoleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The unique name of the role assignment."
                                          }
                                        },
                                        "roleDefinitionId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The unique identifier of the Azure Cosmos DB for Apache Cassandra native role-based access control definition."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The unique identifier for the associated Microsoft Entra ID principal to which access is being granted through this role-based access control assignment. The tenant ID for the principal is inferred using the tenant associated with the subscription."
                                          }
                                        },
                                        "scope": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The data plane resource path for which access is being granted through this role-based access control assignment. Defaults to the current account."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for an Azure Cosmos DB for Apache Cassandra native role-based access control assignment."
                                      }
                                    },
                                    "cassandraRoleDefinitionType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The unique identifier of the role-based access control definition."
                                          }
                                        },
                                        "roleName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. A user-friendly name for the role-based access control definition. Must be unique for the database account."
                                          }
                                        },
                                        "dataActions": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. An array of data actions that are allowed. Note: Valid data action strings are currently undocumented (API version 2025-05-01-preview). Expected to follow format similar to SQL RBAC once documented by Microsoft."
                                          }
                                        },
                                        "notDataActions": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. An array of data actions that are denied. Note: Unlike SQL RBAC, Cassandra supports deny rules for granular access control. Valid data action strings are currently undocumented (API version 2025-05-01-preview)."
                                          }
                                        },
                                        "assignableScopes": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A set of fully qualified Scopes at or below which Role Assignments may be created using this Role Definition."
                                          }
                                        },
                                        "assignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/cassandraRoleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. An array of role-based access control assignments to be created for the definition."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for an Azure Cosmos DB for Apache Cassandra native role-based access control definition."
                                      }
                                    },
                                    "cassandraKeyspaceType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the Cassandra keyspace."
                                          }
                                        },
                                        "tables": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/cassandraTableType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of Cassandra tables to deploy in the keyspace."
                                          }
                                        },
                                        "views": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/cassandraViewType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of Cassandra views (materialized views) to deploy in the keyspace."
                                          }
                                        },
                                        "autoscaleSettingsMaxThroughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored. Setting throughput at the keyspace level is only recommended for development/test or when workload across all tables in the shared throughput keyspace is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the table level and not at the keyspace level."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `autoscaleSettingsMaxThroughput`. Setting throughput at the keyspace level is only recommended for development/test or when workload across all tables in the shared throughput keyspace is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the table level and not at the keyspace level."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces@2024-11-15#properties/tags"
                                            },
                                            "description": "Optional. Tags of the Cassandra keyspace resource."
                                          },
                                          "nullable": true
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for an Azure Cosmos DB Cassandra keyspace."
                                      }
                                    },
                                    "defaultIdentityType": {
                                      "type": "object",
                                      "discriminator": {
                                        "propertyName": "name",
                                        "mapping": {
                                          "FirstPartyIdentity": {
                                            "$ref": "#/definitions/defaultIdentityFirstPartyType"
                                          },
                                          "SystemAssignedIdentity": {
                                            "$ref": "#/definitions/defaultIdentitySystemAssignedType"
                                          },
                                          "UserAssignedIdentity": {
                                            "$ref": "#/definitions/defaultIdentityUserAssignedType"
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_export!": true,
                                        "description": "The type for the default identity."
                                      }
                                    },
                                    "defaultIdentityFirstPartyType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "allowedValues": [
                                            "FirstPartyIdentity"
                                          ],
                                          "metadata": {
                                            "description": "Required. The type of default identity to use."
                                          }
                                        }
                                      }
                                    },
                                    "defaultIdentitySystemAssignedType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "allowedValues": [
                                            "SystemAssignedIdentity"
                                          ],
                                          "metadata": {
                                            "description": "Required. The type of default identity to use."
                                          }
                                        }
                                      }
                                    },
                                    "defaultIdentityUserAssignedType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "allowedValues": [
                                            "UserAssignedIdentity"
                                          ],
                                          "metadata": {
                                            "description": "Required. The type of default identity to use."
                                          }
                                        },
                                        "resourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The resource ID of the user assigned identity to use as the default identity."
                                          }
                                        }
                                      }
                                    },
                                    "_1.privateEndpointCustomDnsConfigType": {
                                      "type": "object",
                                      "properties": {
                                        "fqdn": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. FQDN that resolves to private endpoint IP address."
                                          }
                                        },
                                        "ipAddresses": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "metadata": {
                                            "description": "Required. A list of private IP addresses of the private endpoint."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.privateEndpointIpConfigurationType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The name of the resource that is unique within a resource group."
                                          }
                                        },
                                        "properties": {
                                          "type": "object",
                                          "properties": {
                                            "groupId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The ID of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "memberName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The member name of a group obtained from the remote resource that this private endpoint should connect to."
                                              }
                                            },
                                            "privateIPAddress": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A private IP address obtained from the private endpoint's subnet."
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. Properties of private endpoint IP configurations."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "_1.privateEndpointPrivateDnsZoneGroupType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the Private DNS Zone Group."
                                          }
                                        },
                                        "privateDnsZoneGroupConfigs": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "name": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. The name of the private DNS Zone Group config."
                                                }
                                              },
                                              "privateDnsZoneResourceId": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. The resource id of the private DNS zone."
                                                }
                                              }
                                            }
                                          },
                                          "metadata": {
                                            "description": "Required. The private DNS Zone Groups to associate the Private Endpoint. A DNS Zone Group can support up to 5 DNS zones."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "cassandraRoleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The unique identifier of the role assignment."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The unique identifier for the associated AAD principal."
                                          }
                                        },
                                        "scope": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The data plane resource path for which access is being granted. Defaults to the current account."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "cassandra-role-definition/main.bicep"
                                        }
                                      }
                                    },
                                    "cassandraTableType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the table."
                                          }
                                        },
                                        "schema": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/properties/properties/resource/properties/schema"
                                            },
                                            "description": "Required. Schema definition for the table."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/tags"
                                            },
                                            "description": "Optional. Tags for the table."
                                          },
                                          "nullable": true
                                        },
                                        "defaultTtl": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Default TTL (Time To Live) in seconds for data in the table."
                                          }
                                        },
                                        "analyticalStorageTtl": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Analytical TTL for the table."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput."
                                          }
                                        },
                                        "autoscaleSettingsMaxThroughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Maximum autoscale throughput for the table. Cannot be used with throughput."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type of a Cassandra table.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "cassandra-keyspace/main.bicep",
                                          "originalIdentifier": "tableType"
                                        }
                                      }
                                    },
                                    "cassandraViewType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the view."
                                          }
                                        },
                                        "viewDefinition": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. View definition (CQL statement)."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/views@2025-05-01-preview#properties/tags"
                                            },
                                            "description": "Optional. Tags for the view."
                                          },
                                          "nullable": true
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput."
                                          }
                                        },
                                        "autoscaleSettingsMaxThroughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Maximum autoscale throughput for the view. Cannot be used with throughput."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type of a Cassandra view (materialized view).",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "cassandra-keyspace/main.bicep",
                                          "originalIdentifier": "viewType"
                                        }
                                      }
                                    },
                                    "collectionType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the collection."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Request Units per second. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the collection level and not at the database level."
                                          }
                                        },
                                        "indexes": {
                                          "type": "array",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/indexes"
                                            },
                                            "description": "Required. Indexes for the collection."
                                          }
                                        },
                                        "shardKey": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/shardKey"
                                            },
                                            "description": "Required. ShardKey for the collection."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type of a collection.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "mongodb-database/main.bicep"
                                        }
                                      }
                                    },
                                    "containerType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the container."
                                          }
                                        },
                                        "analyticalStorageTtl": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Default to 0. Indicates how long data should be retained in the analytical store, for a container. Analytical store is enabled when ATTL is set with a value other than 0. If the value is set to -1, the analytical store retains all historical data, irrespective of the retention of the data in the transactional store."
                                          }
                                        },
                                        "conflictResolutionPolicy": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/conflictResolutionPolicy"
                                            },
                                            "description": "Optional. The conflict resolution policy for the container. Conflicts and conflict resolution policies are applicable if the Azure Cosmos DB account is configured with multiple write regions."
                                          },
                                          "nullable": true
                                        },
                                        "defaultTtl": {
                                          "type": "int",
                                          "nullable": true,
                                          "minValue": -1,
                                          "maxValue": 2147483647,
                                          "metadata": {
                                            "description": "Optional. Default to -1. Default time to live (in seconds). With Time to Live or TTL, Azure Cosmos DB provides the ability to delete items automatically from a container after a certain time period. If the value is set to \"-1\", it is equal to infinity, and items don't expire by default."
                                          }
                                        },
                                        "throughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Default to 400. Request Units per second. Will be ignored if autoscaleSettingsMaxThroughput is used. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                          }
                                        },
                                        "autoscaleSettingsMaxThroughput": {
                                          "type": "int",
                                          "nullable": true,
                                          "maxValue": 1000000,
                                          "metadata": {
                                            "description": "Optional. Specifies the Autoscale settings and represents maximum throughput, the resource can scale up to. The autoscale throughput should have valid throughput values between 1000 and 1000000 inclusive in increments of 1000. If value is set to null, then autoscale will be disabled. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/tags"
                                            },
                                            "description": "Optional. Tags of the SQL Database resource."
                                          },
                                          "nullable": true
                                        },
                                        "paths": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "minLength": 1,
                                          "maxLength": 3,
                                          "metadata": {
                                            "description": "Required. List of paths using which data within the container can be partitioned. For kind=MultiHash it can be up to 3. For anything else it needs to be exactly 1."
                                          }
                                        },
                                        "indexingPolicy": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                                            },
                                            "description": "Optional. Indexing policy of the container."
                                          },
                                          "nullable": true
                                        },
                                        "uniqueKeyPolicyKeys": {
                                          "type": "array",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/uniqueKeyPolicy/properties/uniqueKeys"
                                            },
                                            "description": "Optional. The unique key policy configuration containing a list of unique keys that enforces uniqueness constraint on documents in the collection in the Azure Cosmos DB service."
                                          },
                                          "nullable": true
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Hash",
                                            "MultiHash"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Default to Hash. Indicates the kind of algorithm used for partitioning."
                                          }
                                        },
                                        "version": {
                                          "type": "int",
                                          "allowedValues": [
                                            1,
                                            2
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Default to 1 for Hash and 2 for MultiHash - 1 is not allowed for MultiHash. Version of the partition key definition."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type of a container.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "sql-database/main.bicep"
                                        }
                                      }
                                    },
                                    "diagnosticSettingFullType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the diagnostic setting."
                                          }
                                        },
                                        "logCategoriesAndGroups": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category for a resource type this setting is applied to. Set the specific logs to collect here."
                                                }
                                              },
                                              "categoryGroup": {
                                                "type": "string",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Name of a Diagnostic Log category group for a resource type this setting is applied to. Set to `allLogs` to collect all logs."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of logs that will be streamed. \"allLogs\" includes all possible logs for the resource. Set to `[]` to disable log collection."
                                          }
                                        },
                                        "metricCategories": {
                                          "type": "array",
                                          "items": {
                                            "type": "object",
                                            "properties": {
                                              "category": {
                                                "type": "string",
                                                "metadata": {
                                                  "description": "Required. Name of a Diagnostic Metric category for a resource type this setting is applied to. Set to `AllMetrics` to collect all metrics."
                                                }
                                              },
                                              "enabled": {
                                                "type": "bool",
                                                "nullable": true,
                                                "metadata": {
                                                  "description": "Optional. Enable or disable the category explicitly. Default is `true`."
                                                }
                                              }
                                            }
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of metrics that will be streamed. \"allMetrics\" includes all possible metrics for the resource. Set to `[]` to disable metric collection."
                                          }
                                        },
                                        "logAnalyticsDestinationType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "AzureDiagnostics",
                                            "Dedicated"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A string indicating whether the export to Log Analytics should use the default destination type, i.e. AzureDiagnostics, or use a destination type."
                                          }
                                        },
                                        "workspaceResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic log analytics workspace. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "storageAccountResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic storage account. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "eventHubAuthorizationRuleResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Resource ID of the diagnostic event hub authorization rule for the Event Hubs namespace in which the event hub should be created or streamed to."
                                          }
                                        },
                                        "eventHubName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name of the diagnostic event hub within the namespace to which logs are streamed. Without this, an event hub is created for each log category. For security reasons, it is recommended to set diagnostic settings to send data to either storage account, log analytics workspace or event hub."
                                          }
                                        },
                                        "marketplacePartnerResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The full ARM resource ID of the Marketplace resource to which you would like to send Diagnostic Logs."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a diagnostic setting. To be used if both logs & metrics are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "graphType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Name of the graph."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/tags"
                                            },
                                            "description": "Optional. Tags of the Gremlin graph resource."
                                          },
                                          "nullable": true
                                        },
                                        "indexingPolicy": {
                                          "type": "object",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                                            },
                                            "description": "Optional. Indexing policy of the graph."
                                          },
                                          "nullable": true
                                        },
                                        "partitionKeyPaths": {
                                          "type": "array",
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/partitionKey/properties/paths"
                                            },
                                            "description": "Optional. List of paths using which data within the container can be partitioned."
                                          },
                                          "nullable": true
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type of a graph.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "gremlin-database/main.bicep"
                                        }
                                      }
                                    },
                                    "lockType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the name of lock."
                                          }
                                        },
                                        "kind": {
                                          "type": "string",
                                          "allowedValues": [
                                            "CanNotDelete",
                                            "None",
                                            "ReadOnly"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "notes": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the notes of the lock."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a lock.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "managedIdentityAllType": {
                                      "type": "object",
                                      "properties": {
                                        "systemAssigned": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enables system assigned managed identity on the resource."
                                          }
                                        },
                                        "userAssignedResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID(s) to assign to the resource. Required if a user assigned identity is used for encryption."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a managed identity configuration. To be used if both a system-assigned & user-assigned identities are supported by the resource provider.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "nestedSqlRoleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Name unique identifier of the SQL Role Assignment."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The unique identifier for the associated AAD principal in the AAD graph to which access is being granted through this Role Assignment. Tenant ID for the principal is inferred using the tenant associated with the subscription."
                                          }
                                        },
                                        "scope": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The data plane resource id for which access is being granted through this Role Assignment. Defaults to the root of the database account, but can also be scoped to e.g., the container and database level."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "The type for the SQL Role Assignments.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "sql-role-definition/main.bicep",
                                          "originalIdentifier": "sqlRoleAssignmentType"
                                        }
                                      }
                                    },
                                    "privateEndpointMultiServiceType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the private endpoint."
                                          }
                                        },
                                        "location": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The location to deploy the private endpoint to."
                                          }
                                        },
                                        "privateLinkServiceConnectionName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name of the private link connection to create."
                                          }
                                        },
                                        "service": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The subresource to deploy the private endpoint for. For example \"blob\", \"table\", \"queue\" or \"file\" for a Storage Account's Private Endpoints."
                                          }
                                        },
                                        "subnetResourceId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                          }
                                        },
                                        "resourceGroupResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The resource ID of the Resource Group the Private Endpoint will be created in. If not specified, the Resource Group of the provided Virtual Network Subnet is used."
                                          }
                                        },
                                        "privateDnsZoneGroup": {
                                          "$ref": "#/definitions/_1.privateEndpointPrivateDnsZoneGroupType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The private DNS zone group to configure for the private endpoint."
                                          }
                                        },
                                        "isManualConnection": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. If Manual Private Link Connection is required."
                                          }
                                        },
                                        "manualConnectionRequestMessage": {
                                          "type": "string",
                                          "nullable": true,
                                          "maxLength": 140,
                                          "metadata": {
                                            "description": "Optional. A message passed to the owner of the remote resource with the manual connection request."
                                          }
                                        },
                                        "customDnsConfigs": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_1.privateEndpointCustomDnsConfigType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Custom DNS configurations."
                                          }
                                        },
                                        "ipConfigurations": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/_1.privateEndpointIpConfigurationType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                          }
                                        },
                                        "applicationSecurityGroupResourceIds": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                          }
                                        },
                                        "customNetworkInterfaceName": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                          }
                                        },
                                        "lock": {
                                          "$ref": "#/definitions/lockType",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Specify the type of lock."
                                          }
                                        },
                                        "roleAssignments": {
                                          "type": "array",
                                          "items": {
                                            "$ref": "#/definitions/roleAssignmentType"
                                          },
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Array of role assignments to create."
                                          }
                                        },
                                        "tags": {
                                          "type": "object",
                                          "nullable": true,
                                          "metadata": {
                                            "__bicep_resource_derived_type!": {
                                              "source": "Microsoft.Network/privateEndpoints@2024-07-01#properties/tags"
                                            },
                                            "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                          }
                                        },
                                        "enableTelemetry": {
                                          "type": "bool",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Enable/Disable usage telemetry for module."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a private endpoint. To be used if the private endpoint's default service / groupId can NOT be assumed (i.e., for services that have more than one subresource, like Storage Account with Blob (blob, table, queue, file, ...).",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    },
                                    "roleAssignmentType": {
                                      "type": "object",
                                      "properties": {
                                        "name": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                          }
                                        },
                                        "roleDefinitionIdOrName": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                          }
                                        },
                                        "principalId": {
                                          "type": "string",
                                          "metadata": {
                                            "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                          }
                                        },
                                        "principalType": {
                                          "type": "string",
                                          "allowedValues": [
                                            "Device",
                                            "ForeignGroup",
                                            "Group",
                                            "ServicePrincipal",
                                            "User"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The principal type of the assigned principal ID."
                                          }
                                        },
                                        "description": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The description of the role assignment."
                                          }
                                        },
                                        "condition": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                          }
                                        },
                                        "conditionVersion": {
                                          "type": "string",
                                          "allowedValues": [
                                            "2.0"
                                          ],
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. Version of the condition."
                                          }
                                        },
                                        "delegatedManagedIdentityResourceId": {
                                          "type": "string",
                                          "nullable": true,
                                          "metadata": {
                                            "description": "Optional. The Resource Id of the delegated managed identity resource."
                                          }
                                        }
                                      },
                                      "metadata": {
                                        "description": "An AVM-aligned type for a role assignment.",
                                        "__bicep_imported_from!": {
                                          "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                        }
                                      }
                                    }
                                  },
                                  "parameters": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the account."
                                      }
                                    },
                                    "location": {
                                      "type": "string",
                                      "defaultValue": "[resourceGroup().location]",
                                      "metadata": {
                                        "description": "Optional. Defaults to the current resource group scope location. Location for all resources."
                                      }
                                    },
                                    "tags": {
                                      "type": "object",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.DocumentDB/databaseAccounts@2024-11-15#properties/tags"
                                        },
                                        "description": "Optional. Tags for the resource."
                                      },
                                      "nullable": true
                                    },
                                    "managedIdentities": {
                                      "$ref": "#/definitions/managedIdentityAllType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The managed identity definition for this resource."
                                      }
                                    },
                                    "databaseAccountOfferType": {
                                      "type": "string",
                                      "defaultValue": "Standard",
                                      "allowedValues": [
                                        "Standard"
                                      ],
                                      "metadata": {
                                        "description": "Optional. The offer type for the account. Defaults to \"Standard\"."
                                      }
                                    },
                                    "failoverLocations": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/failoverLocationType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The set of locations enabled for the account. Defaults to the location where the account is deployed."
                                      }
                                    },
                                    "zoneRedundant": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Indicates whether the single-region account is zone redundant. Defaults to true. This property is ignored for multi-region accounts."
                                      }
                                    },
                                    "defaultConsistencyLevel": {
                                      "type": "string",
                                      "defaultValue": "Session",
                                      "allowedValues": [
                                        "Eventual",
                                        "ConsistentPrefix",
                                        "Session",
                                        "BoundedStaleness",
                                        "Strong"
                                      ],
                                      "metadata": {
                                        "description": "Optional. The default consistency level of the account. Defaults to \"Session\"."
                                      }
                                    },
                                    "disableLocalAuthentication": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Opt-out of local authentication and ensure that only Microsoft Entra can be used exclusively for authentication. Defaults to true."
                                      }
                                    },
                                    "enableAnalyticalStorage": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Flag to indicate whether to enable storage analytics. Defaults to false."
                                      }
                                    },
                                    "enableAutomaticFailover": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Enable automatic failover for regions. Defaults to true."
                                      }
                                    },
                                    "enableFreeTier": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Flag to indicate whether \"Free Tier\" is enabled. Defaults to false."
                                      }
                                    },
                                    "enableMultipleWriteLocations": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Enables the account to write in multiple locations. Periodic backup must be used if enabled. Defaults to false."
                                      }
                                    },
                                    "disableKeyBasedMetadataWriteAccess": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Disable write operations on metadata resources (databases, containers, throughput) via account keys. Defaults to true."
                                      }
                                    },
                                    "maxStalenessPrefix": {
                                      "type": "int",
                                      "defaultValue": 100000,
                                      "minValue": 1,
                                      "maxValue": 2147483647,
                                      "metadata": {
                                        "description": "Optional. The maximum stale requests. Required for \"BoundedStaleness\" consistency level. Valid ranges, Single Region: 10 to 1000000. Multi Region: 100000 to 1000000. Defaults to 100000."
                                      }
                                    },
                                    "maxIntervalInSeconds": {
                                      "type": "int",
                                      "defaultValue": 300,
                                      "minValue": 5,
                                      "maxValue": 86400,
                                      "metadata": {
                                        "description": "Optional. The maximum lag time in minutes. Required for \"BoundedStaleness\" consistency level. Valid ranges, Single Region: 5 to 84600. Multi Region: 300 to 86400. Defaults to 300."
                                      }
                                    },
                                    "serverVersion": {
                                      "type": "string",
                                      "defaultValue": "4.2",
                                      "allowedValues": [
                                        "3.2",
                                        "3.6",
                                        "4.0",
                                        "4.2",
                                        "5.0",
                                        "6.0",
                                        "7.0"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Specifies the MongoDB server version to use if using Azure Cosmos DB for MongoDB RU. Defaults to \"4.2\"."
                                      }
                                    },
                                    "sqlDatabases": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/sqlDatabaseType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration for databases when using Azure Cosmos DB for NoSQL."
                                      }
                                    },
                                    "mongodbDatabases": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/mongoDbType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration for databases when using Azure Cosmos DB for MongoDB RU."
                                      }
                                    },
                                    "gremlinDatabases": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/gremlinDatabaseType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration for databases when using Azure Cosmos DB for Apache Gremlin."
                                      }
                                    },
                                    "tables": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/tableType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration for databases when using Azure Cosmos DB for Table."
                                      }
                                    },
                                    "cassandraKeyspaces": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/cassandraKeyspaceType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration for keyspaces when using Azure Cosmos DB for Apache Cassandra."
                                      }
                                    },
                                    "enableTelemetry": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                      }
                                    },
                                    "totalThroughputLimit": {
                                      "type": "int",
                                      "defaultValue": -1,
                                      "metadata": {
                                        "description": "Optional. The total throughput limit imposed on this account in request units per second (RU/s). Default to unlimited throughput."
                                      }
                                    },
                                    "lock": {
                                      "$ref": "#/definitions/lockType",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The lock settings of the service."
                                      }
                                    },
                                    "roleAssignments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/roleAssignmentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. An array of control plane Azure role-based access control assignments."
                                      }
                                    },
                                    "sqlRoleDefinitions": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/sqlRoleDefinitionType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configurations for Azure Cosmos DB for NoSQL native role-based access control definitions. Allows the creations of custom role definitions."
                                      }
                                    },
                                    "sqlRoleAssignments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/sqlRoleAssignmentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configurations for Azure Cosmos DB for NoSQL native role-based access control assignments."
                                      }
                                    },
                                    "cassandraRoleDefinitions": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/cassandraRoleDefinitionType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configurations for Azure Cosmos DB for Apache Cassandra native role-based access control definitions. Allows the creations of custom role definitions."
                                      }
                                    },
                                    "cassandraRoleAssignments": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/cassandraStandaloneRoleAssignmentType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Azure Cosmos DB for Apache Cassandra native data plane role-based access control assignments. Each assignment references a role definition unique identifier and a principal identifier."
                                      }
                                    },
                                    "diagnosticSettings": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/diagnosticSettingFullType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. The diagnostic settings for the service."
                                      }
                                    },
                                    "capabilitiesToAdd": {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "nullable": true,
                                      "allowedValues": [
                                        "EnableCassandra",
                                        "EnableTable",
                                        "EnableGremlin",
                                        "EnableMongo",
                                        "DisableRateLimitingResponses",
                                        "EnableServerless",
                                        "EnableNoSQLVectorSearch",
                                        "EnableNoSQLFullTextSearch",
                                        "EnableMaterializedViews",
                                        "DeleteAllItemsByPartitionKey"
                                      ],
                                      "metadata": {
                                        "description": "Optional. A list of Azure Cosmos DB specific capabilities for the account."
                                      }
                                    },
                                    "backupPolicyType": {
                                      "type": "string",
                                      "defaultValue": "Continuous",
                                      "allowedValues": [
                                        "Periodic",
                                        "Continuous"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Configures the backup mode. Periodic backup must be used if multiple write locations are used. Defaults to \"Continuous\"."
                                      }
                                    },
                                    "backupPolicyContinuousTier": {
                                      "type": "string",
                                      "defaultValue": "Continuous30Days",
                                      "allowedValues": [
                                        "Continuous30Days",
                                        "Continuous7Days"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Configuration values to specify the retention period for continuous mode backup. Default to \"Continuous30Days\"."
                                      }
                                    },
                                    "backupIntervalInMinutes": {
                                      "type": "int",
                                      "defaultValue": 240,
                                      "minValue": 60,
                                      "maxValue": 1440,
                                      "metadata": {
                                        "description": "Optional. An integer representing the interval in minutes between two backups. This setting only applies to the periodic backup type. Defaults to 240."
                                      }
                                    },
                                    "backupRetentionIntervalInHours": {
                                      "type": "int",
                                      "defaultValue": 8,
                                      "minValue": 2,
                                      "maxValue": 720,
                                      "metadata": {
                                        "description": "Optional. An integer representing the time (in hours) that each backup is retained. This setting only applies to the periodic backup type. Defaults to 8."
                                      }
                                    },
                                    "backupStorageRedundancy": {
                                      "type": "string",
                                      "defaultValue": "Local",
                                      "allowedValues": [
                                        "Geo",
                                        "Local",
                                        "Zone"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Setting that indicates the type of backup residency. This setting only applies to the periodic backup type. Defaults to \"Local\"."
                                      }
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointMultiServiceType"
                                      },
                                      "nullable": true,
                                      "metadata": {
                                        "description": "Optional. Configuration details for private endpoints. For security reasons, it is advised to use private endpoints whenever possible."
                                      }
                                    },
                                    "networkRestrictions": {
                                      "$ref": "#/definitions/networkRestrictionType",
                                      "defaultValue": {
                                        "ipRules": [],
                                        "virtualNetworkRules": [],
                                        "publicNetworkAccess": "Disabled"
                                      },
                                      "metadata": {
                                        "description": "Optional. The network configuration of this module. Defaults to `{ ipRules: [], virtualNetworkRules: [], publicNetworkAccess: 'Disabled' }`."
                                      }
                                    },
                                    "minimumTlsVersion": {
                                      "type": "string",
                                      "defaultValue": "Tls12",
                                      "allowedValues": [
                                        "Tls12"
                                      ],
                                      "metadata": {
                                        "description": "Optional. Setting that indicates the minimum allowed TLS version. Azure Cosmos DB for MongoDB RU and Apache Cassandra only work with TLS 1.2 or later. Defaults to \"Tls12\" (TLS 1.2)."
                                      }
                                    },
                                    "enableBurstCapacity": {
                                      "type": "bool",
                                      "defaultValue": true,
                                      "metadata": {
                                        "description": "Optional. Flag to indicate enabling/disabling of Burst Capacity feature on the account. Cannot be enabled for serverless accounts."
                                      }
                                    },
                                    "enableCassandraConnector": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Enables the cassandra connector on the Cosmos DB C* account."
                                      }
                                    },
                                    "enablePartitionMerge": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Flag to enable/disable the 'Partition Merge' feature on the account."
                                      }
                                    },
                                    "enablePerRegionPerPartitionAutoscale": {
                                      "type": "bool",
                                      "defaultValue": false,
                                      "metadata": {
                                        "description": "Optional. Flag to enable/disable the 'PerRegionPerPartitionAutoscale' feature on the account."
                                      }
                                    },
                                    "analyticalStorageConfiguration": {
                                      "type": "object",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.DocumentDB/databaseAccounts@2025-04-15#properties/properties/properties/analyticalStorageConfiguration"
                                        },
                                        "description": "Optional. Analytical storage specific properties."
                                      },
                                      "nullable": true
                                    },
                                    "cors": {
                                      "type": "array",
                                      "metadata": {
                                        "__bicep_resource_derived_type!": {
                                          "source": "Microsoft.DocumentDB/databaseAccounts@2025-04-15#properties/properties/properties/cors"
                                        },
                                        "description": "Optional. The CORS policy for the Cosmos DB database account."
                                      },
                                      "nullable": true
                                    },
                                    "defaultIdentity": {
                                      "$ref": "#/definitions/defaultIdentityType",
                                      "defaultValue": {
                                        "name": "FirstPartyIdentity"
                                      },
                                      "metadata": {
                                        "description": "Optional. The default identity for accessing key vault used in features like customer managed keys. Use `FirstPartyIdentity` to use the tenant-level CosmosDB enterprise application. The default identity needs to be explicitly set by the users."
                                      }
                                    }
                                  },
                                  "variables": {
                                    "copy": [
                                      {
                                        "name": "formattedRoleAssignments",
                                        "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                        "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInControlPlaneRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                      }
                                    ],
                                    "enableReferencedModulesTelemetry": false,
                                    "formattedUserAssignedIdentities": "[reduce(map(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createArray()), lambda('id', createObject(format('{0}', lambdaVariables('id')), createObject()))), createObject(), lambda('cur', 'next', union(lambdaVariables('cur'), lambdaVariables('next'))))]",
                                    "identity": "[if(not(empty(parameters('managedIdentities'))), createObject('type', if(coalesce(tryGet(parameters('managedIdentities'), 'systemAssigned'), false()), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'SystemAssigned,UserAssigned', 'SystemAssigned'), if(not(empty(coalesce(tryGet(parameters('managedIdentities'), 'userAssignedResourceIds'), createObject()))), 'UserAssigned', null())), 'userAssignedIdentities', if(not(empty(variables('formattedUserAssignedIdentities'))), variables('formattedUserAssignedIdentities'), null())), null())]",
                                    "builtInControlPlaneRoleNames": {
                                      "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                      "Cosmos DB Account Reader Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'fbdf93bf-df7d-467e-a4d2-9458aa1360c8')]",
                                      "Cosmos DB Operator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa')]",
                                      "CosmosBackupOperator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db7b14f2-5adf-42da-9f96-f2ee17bab5cb')]",
                                      "CosmosRestoreOperator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5432c526-bc82-444a-b7ba-57c5b0b5b34f')]",
                                      "DocumentDB Account Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5bd9cd88-fe45-4216-938b-f97437e15450')]",
                                      "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                      "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                      "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]",
                                      "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
                                    }
                                  },
                                  "resources": {
                                    "avmTelemetry": {
                                      "condition": "[parameters('enableTelemetry')]",
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2024-07-01",
                                      "name": "[format('46d3xbcp.res.documentdb-databaseaccount.{0}.{1}', replace('0.18.0', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                      "properties": {
                                        "mode": "Incremental",
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "contentVersion": "1.0.0.0",
                                          "resources": [],
                                          "outputs": {
                                            "telemetry": {
                                              "type": "String",
                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "databaseAccount": {
                                      "type": "Microsoft.DocumentDB/databaseAccounts",
                                      "apiVersion": "2025-04-15",
                                      "name": "[parameters('name')]",
                                      "location": "[parameters('location')]",
                                      "tags": "[parameters('tags')]",
                                      "identity": "[variables('identity')]",
                                      "kind": "[if(not(empty(parameters('mongodbDatabases'))), 'MongoDB', 'GlobalDocumentDB')]",
                                      "properties": "[shallowMerge(createArray(createObject('enableBurstCapacity', if(not(contains(coalesce(parameters('capabilitiesToAdd'), createArray()), 'EnableServerless')), parameters('enableBurstCapacity'), false()), 'analyticalStorageConfiguration', parameters('analyticalStorageConfiguration'), 'defaultIdentity', if(and(not(empty(parameters('defaultIdentity'))), not(equals(tryGet(parameters('defaultIdentity'), 'name'), 'UserAssignedIdentity'))), parameters('defaultIdentity').name, format('UserAssignedIdentity={0}', tryGet(parameters('defaultIdentity'), 'resourceId'))), 'enablePartitionMerge', parameters('enablePartitionMerge'), 'enablePerRegionPerPartitionAutoscale', parameters('enablePerRegionPerPartitionAutoscale'), 'databaseAccountOfferType', parameters('databaseAccountOfferType'), 'backupPolicy', shallowMerge(createArray(createObject('type', parameters('backupPolicyType')), if(equals(parameters('backupPolicyType'), 'Continuous'), createObject('continuousModeProperties', createObject('tier', parameters('backupPolicyContinuousTier'))), createObject()), if(equals(parameters('backupPolicyType'), 'Periodic'), createObject('periodicModeProperties', createObject('backupIntervalInMinutes', parameters('backupIntervalInMinutes'), 'backupRetentionIntervalInHours', parameters('backupRetentionIntervalInHours'), 'backupStorageRedundancy', parameters('backupStorageRedundancy'))), createObject()))), 'capabilities', map(coalesce(parameters('capabilitiesToAdd'), createArray()), lambda('capability', createObject('name', lambdaVariables('capability'))))), if(not(empty(parameters('cors'))), createObject('cors', parameters('cors')), createObject()), if(contains(coalesce(parameters('capabilitiesToAdd'), createArray()), 'EnableCassandra'), createObject('connectorOffer', if(parameters('enableCassandraConnector'), 'Small', null()), 'enableCassandraConnector', parameters('enableCassandraConnector')), createObject()), createObject('minimalTlsVersion', parameters('minimumTlsVersion'), 'capacity', createObject('totalThroughputLimit', parameters('totalThroughputLimit')), 'publicNetworkAccess', coalesce(tryGet(parameters('networkRestrictions'), 'publicNetworkAccess'), 'Disabled')), if(or(or(or(or(not(empty(parameters('sqlDatabases'))), not(empty(parameters('mongodbDatabases')))), not(empty(parameters('gremlinDatabases')))), not(empty(parameters('tables')))), not(empty(parameters('cassandraKeyspaces')))), createObject('consistencyPolicy', shallowMerge(createArray(createObject('defaultConsistencyLevel', parameters('defaultConsistencyLevel')), if(equals(parameters('defaultConsistencyLevel'), 'BoundedStaleness'), createObject('maxStalenessPrefix', parameters('maxStalenessPrefix'), 'maxIntervalInSeconds', parameters('maxIntervalInSeconds')), createObject()))), 'enableMultipleWriteLocations', parameters('enableMultipleWriteLocations'), 'locations', if(not(empty(parameters('failoverLocations'))), map(parameters('failoverLocations'), lambda('failoverLocation', createObject('failoverPriority', lambdaVariables('failoverLocation').failoverPriority, 'locationName', lambdaVariables('failoverLocation').locationName, 'isZoneRedundant', coalesce(tryGet(lambdaVariables('failoverLocation'), 'isZoneRedundant'), true())))), createArray(createObject('failoverPriority', 0, 'locationName', parameters('location'), 'isZoneRedundant', parameters('zoneRedundant')))), 'ipRules', map(coalesce(tryGet(parameters('networkRestrictions'), 'ipRules'), createArray()), lambda('ipRule', createObject('ipAddressOrRange', lambdaVariables('ipRule')))), 'virtualNetworkRules', map(coalesce(tryGet(parameters('networkRestrictions'), 'virtualNetworkRules'), createArray()), lambda('rule', createObject('id', lambdaVariables('rule').subnetResourceId, 'ignoreMissingVNetServiceEndpoint', false()))), 'networkAclBypass', coalesce(tryGet(parameters('networkRestrictions'), 'networkAclBypass'), 'None'), 'networkAclBypassResourceIds', tryGet(parameters('networkRestrictions'), 'networkAclBypassResourceIds'), 'isVirtualNetworkFilterEnabled', or(not(empty(tryGet(parameters('networkRestrictions'), 'ipRules'))), not(empty(tryGet(parameters('networkRestrictions'), 'virtualNetworkRules')))), 'enableFreeTier', parameters('enableFreeTier'), 'enableAutomaticFailover', parameters('enableAutomaticFailover'), 'enableAnalyticalStorage', parameters('enableAnalyticalStorage')), createObject()), if(or(or(not(empty(parameters('mongodbDatabases'))), not(empty(parameters('gremlinDatabases')))), not(empty(parameters('cassandraKeyspaces')))), createObject('disableLocalAuth', false(), 'disableKeyBasedMetadataWriteAccess', false()), createObject('disableLocalAuth', parameters('disableLocalAuthentication'), 'disableKeyBasedMetadataWriteAccess', parameters('disableKeyBasedMetadataWriteAccess'))), if(not(empty(parameters('mongodbDatabases'))), createObject('apiProperties', createObject('serverVersion', parameters('serverVersion'))), createObject())))]"
                                    },
                                    "databaseAccount_lock": {
                                      "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                      "type": "Microsoft.Authorization/locks",
                                      "apiVersion": "2020-05-01",
                                      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                      "properties": {
                                        "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                        "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_diagnosticSettings": {
                                      "copy": {
                                        "name": "databaseAccount_diagnosticSettings",
                                        "count": "[length(coalesce(parameters('diagnosticSettings'), createArray()))]"
                                      },
                                      "type": "Microsoft.Insights/diagnosticSettings",
                                      "apiVersion": "2021-05-01-preview",
                                      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'name'), format('{0}-diagnosticSettings', parameters('name')))]",
                                      "properties": {
                                        "copy": [
                                          {
                                            "name": "metrics",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics'))))]",
                                            "input": {
                                              "category": "[coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')].category]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'metricCategories'), createArray(createObject('category', 'AllMetrics')))[copyIndex('metrics')], 'enabled'), true())]",
                                              "timeGrain": null
                                            }
                                          },
                                          {
                                            "name": "logs",
                                            "count": "[length(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs'))))]",
                                            "input": {
                                              "categoryGroup": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'categoryGroup')]",
                                              "category": "[tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'category')]",
                                              "enabled": "[coalesce(tryGet(coalesce(tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logCategoriesAndGroups'), createArray(createObject('categoryGroup', 'allLogs')))[copyIndex('logs')], 'enabled'), true())]"
                                            }
                                          }
                                        ],
                                        "storageAccountId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'storageAccountResourceId')]",
                                        "workspaceId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'workspaceResourceId')]",
                                        "eventHubAuthorizationRuleId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubAuthorizationRuleResourceId')]",
                                        "eventHubName": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'eventHubName')]",
                                        "marketplacePartnerId": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'marketplacePartnerResourceId')]",
                                        "logAnalyticsDestinationType": "[tryGet(coalesce(parameters('diagnosticSettings'), createArray())[copyIndex()], 'logAnalyticsDestinationType')]"
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_roleAssignments": {
                                      "copy": {
                                        "name": "databaseAccount_roleAssignments",
                                        "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('name'))]",
                                      "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                      "properties": {
                                        "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                        "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                        "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                        "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                        "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                        "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                        "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_sqlDatabases": {
                                      "copy": {
                                        "name": "databaseAccount_sqlDatabases",
                                        "count": "[length(coalesce(parameters('sqlDatabases'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-sqldb-{1}', uniqueString(deployment().name, parameters('location')), coalesce(parameters('sqlDatabases'), createArray())[copyIndex()].name)]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(parameters('sqlDatabases'), createArray())[copyIndex()].name]"
                                          },
                                          "containers": {
                                            "value": "[tryGet(coalesce(parameters('sqlDatabases'), createArray())[copyIndex()], 'containers')]"
                                          },
                                          "throughput": {
                                            "value": "[tryGet(coalesce(parameters('sqlDatabases'), createArray())[copyIndex()], 'throughput')]"
                                          },
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "autoscaleSettingsMaxThroughput": {
                                            "value": "[tryGet(coalesce(parameters('sqlDatabases'), createArray())[copyIndex()], 'autoscaleSettingsMaxThroughput')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "1549250134356326406"
                                            },
                                            "name": "DocumentDB Database Account SQL Databases",
                                            "description": "This module deploys a SQL Database in a CosmosDB Account."
                                          },
                                          "definitions": {
                                            "containerType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. Name of the container."
                                                  }
                                                },
                                                "analyticalStorageTtl": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Default to 0. Indicates how long data should be retained in the analytical store, for a container. Analytical store is enabled when ATTL is set with a value other than 0. If the value is set to -1, the analytical store retains all historical data, irrespective of the retention of the data in the transactional store."
                                                  }
                                                },
                                                "conflictResolutionPolicy": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/conflictResolutionPolicy"
                                                    },
                                                    "description": "Optional. The conflict resolution policy for the container. Conflicts and conflict resolution policies are applicable if the Azure Cosmos DB account is configured with multiple write regions."
                                                  },
                                                  "nullable": true
                                                },
                                                "defaultTtl": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "minValue": -1,
                                                  "maxValue": 2147483647,
                                                  "metadata": {
                                                    "description": "Optional. Default to -1. Default time to live (in seconds). With Time to Live or TTL, Azure Cosmos DB provides the ability to delete items automatically from a container after a certain time period. If the value is set to \"-1\", it is equal to infinity, and items don't expire by default."
                                                  }
                                                },
                                                "throughput": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Default to 400. Request Units per second. Will be ignored if autoscaleSettingsMaxThroughput is used. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                                  }
                                                },
                                                "autoscaleSettingsMaxThroughput": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "maxValue": 1000000,
                                                  "metadata": {
                                                    "description": "Optional. Specifies the Autoscale settings and represents maximum throughput, the resource can scale up to. The autoscale throughput should have valid throughput values between 1000 and 1000000 inclusive in increments of 1000. If value is set to null, then autoscale will be disabled. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                                  }
                                                },
                                                "tags": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/tags"
                                                    },
                                                    "description": "Optional. Tags of the SQL Database resource."
                                                  },
                                                  "nullable": true
                                                },
                                                "paths": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "minLength": 1,
                                                  "maxLength": 3,
                                                  "metadata": {
                                                    "description": "Required. List of paths using which data within the container can be partitioned. For kind=MultiHash it can be up to 3. For anything else it needs to be exactly 1."
                                                  }
                                                },
                                                "indexingPolicy": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                                                    },
                                                    "description": "Optional. Indexing policy of the container."
                                                  },
                                                  "nullable": true
                                                },
                                                "uniqueKeyPolicyKeys": {
                                                  "type": "array",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/uniqueKeyPolicy/properties/uniqueKeys"
                                                    },
                                                    "description": "Optional. The unique key policy configuration containing a list of unique keys that enforces uniqueness constraint on documents in the collection in the Azure Cosmos DB service."
                                                  },
                                                  "nullable": true
                                                },
                                                "kind": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Hash",
                                                    "MultiHash"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Default to Hash. Indicates the kind of algorithm used for partitioning."
                                                  }
                                                },
                                                "version": {
                                                  "type": "int",
                                                  "allowedValues": [
                                                    1,
                                                    2
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Default to 1 for Hash and 2 for MultiHash - 1 is not allowed for MultiHash. Version of the partition key definition."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a container."
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the SQL database ."
                                              }
                                            },
                                            "containers": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/containerType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of containers to deploy in the SQL database."
                                              }
                                            },
                                            "throughput": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Request units per second. Will be ignored if autoscaleSettingsMaxThroughput is used. Setting throughput at the database level is only recommended for development/test or when workload across all containers in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                              }
                                            },
                                            "autoscaleSettingsMaxThroughput": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Specifies the Autoscale settings and represents maximum throughput, the resource can scale up to. The autoscale throughput should have valid throughput values between 1000 and 1000000 inclusive in increments of 1000. If value is set to null, then autoscale will be disabled. Setting throughput at the database level is only recommended for development/test or when workload across all containers in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases@2025-04-15#properties/tags"
                                                },
                                                "description": "Optional. Tags of the SQL database resource."
                                              },
                                              "nullable": true
                                            }
                                          },
                                          "resources": {
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2025-04-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "sqlDatabase": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
                                              "apiVersion": "2025-04-15",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('name'))]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "resource": {
                                                  "id": "[parameters('name')]"
                                                },
                                                "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), null(), createObject('throughput', if(equals(parameters('autoscaleSettingsMaxThroughput'), null()), parameters('throughput'), null()), 'autoscaleSettings', if(not(equals(parameters('autoscaleSettingsMaxThroughput'), null())), createObject('maxThroughput', parameters('autoscaleSettingsMaxThroughput')), null())))]"
                                              },
                                              "dependsOn": [
                                                "databaseAccount"
                                              ]
                                            },
                                            "container": {
                                              "copy": {
                                                "name": "container",
                                                "count": "[length(coalesce(parameters('containers'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-sqldb-{1}', uniqueString(deployment().name, parameters('name')), coalesce(parameters('containers'), createArray())[copyIndex()].name)]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "databaseAccountName": {
                                                    "value": "[parameters('databaseAccountName')]"
                                                  },
                                                  "sqlDatabaseName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "name": {
                                                    "value": "[coalesce(parameters('containers'), createArray())[copyIndex()].name]"
                                                  },
                                                  "analyticalStorageTtl": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'analyticalStorageTtl')]"
                                                  },
                                                  "autoscaleSettingsMaxThroughput": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'autoscaleSettingsMaxThroughput')]"
                                                  },
                                                  "conflictResolutionPolicy": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'conflictResolutionPolicy')]"
                                                  },
                                                  "defaultTtl": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'defaultTtl')]"
                                                  },
                                                  "indexingPolicy": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'indexingPolicy')]"
                                                  },
                                                  "kind": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'kind')]"
                                                  },
                                                  "version": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'version')]"
                                                  },
                                                  "paths": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'paths')]"
                                                  },
                                                  "throughput": "[if(and(or(not(equals(parameters('throughput'), null())), not(equals(parameters('autoscaleSettingsMaxThroughput'), null()))), equals(tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'throughput'), null())), createObject('value', -1), createObject('value', tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'throughput')))]",
                                                  "uniqueKeyPolicyKeys": {
                                                    "value": "[tryGet(coalesce(parameters('containers'), createArray())[copyIndex()], 'uniqueKeyPolicyKeys')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "1005439058963058082"
                                                    },
                                                    "name": "DocumentDB Database Account SQL Database Containers",
                                                    "description": "This module deploys a SQL Database Container in a CosmosDB Account."
                                                  },
                                                  "parameters": {
                                                    "databaseAccountName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "sqlDatabaseName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent SQL Database. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the container."
                                                      }
                                                    },
                                                    "analyticalStorageTtl": {
                                                      "type": "int",
                                                      "defaultValue": 0,
                                                      "metadata": {
                                                        "description": "Optional. Default to 0. Indicates how long data should be retained in the analytical store, for a container. Analytical store is enabled when ATTL is set with a value other than 0. If the value is set to -1, the analytical store retains all historical data, irrespective of the retention of the data in the transactional store."
                                                      }
                                                    },
                                                    "conflictResolutionPolicy": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/conflictResolutionPolicy"
                                                        },
                                                        "description": "Optional. The conflict resolution policy for the container. Conflicts and conflict resolution policies are applicable if the Azure Cosmos DB account is configured with multiple write regions."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "defaultTtl": {
                                                      "type": "int",
                                                      "nullable": true,
                                                      "minValue": -1,
                                                      "maxValue": 2147483647,
                                                      "metadata": {
                                                        "description": "Optional. Default to -1. Default time to live (in seconds). With Time to Live or TTL, Azure Cosmos DB provides the ability to delete items automatically from a container after a certain time period. If the value is set to \"-1\", it is equal to infinity, and items don't expire by default."
                                                      }
                                                    },
                                                    "throughput": {
                                                      "type": "int",
                                                      "defaultValue": 400,
                                                      "metadata": {
                                                        "description": "Optional. Default to 400. Request Units per second. Will be ignored if autoscaleSettingsMaxThroughput is used. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                                      }
                                                    },
                                                    "autoscaleSettingsMaxThroughput": {
                                                      "type": "int",
                                                      "nullable": true,
                                                      "maxValue": 1000000,
                                                      "metadata": {
                                                        "description": "Optional. Specifies the Autoscale settings and represents maximum throughput, the resource can scale up to. The autoscale throughput should have valid throughput values between 1000 and 1000000 inclusive in increments of 1000. If value is set to null, then autoscale will be disabled. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the container level and not at the database level."
                                                      }
                                                    },
                                                    "tags": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/tags"
                                                        },
                                                        "description": "Optional. Tags of the SQL Database resource."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "paths": {
                                                      "type": "array",
                                                      "items": {
                                                        "type": "string"
                                                      },
                                                      "minLength": 1,
                                                      "maxLength": 3,
                                                      "metadata": {
                                                        "description": "Required. List of paths using which data within the container can be partitioned. For kind=MultiHash it can be up to 3. For anything else it needs to be exactly 1."
                                                      }
                                                    },
                                                    "indexingPolicy": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                                                        },
                                                        "description": "Optional. Indexing policy of the container."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "uniqueKeyPolicyKeys": {
                                                      "type": "array",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2025-04-15#properties/properties/properties/resource/properties/uniqueKeyPolicy/properties/uniqueKeys"
                                                        },
                                                        "description": "Optional. The unique key policy configuration containing a list of unique keys that enforces uniqueness constraint on documents in the collection in the Azure Cosmos DB service."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "kind": {
                                                      "type": "string",
                                                      "defaultValue": "Hash",
                                                      "allowedValues": [
                                                        "Hash",
                                                        "MultiHash"
                                                      ],
                                                      "metadata": {
                                                        "description": "Optional. Default to Hash. Indicates the kind of algorithm used for partitioning."
                                                      }
                                                    },
                                                    "version": {
                                                      "type": "int",
                                                      "defaultValue": 1,
                                                      "allowedValues": [
                                                        1,
                                                        2
                                                      ],
                                                      "metadata": {
                                                        "description": "Optional. Default to 1 for Hash and 2 for MultiHash - 1 is not allowed for MultiHash. Version of the partition key definition."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "copy": [
                                                      {
                                                        "name": "partitionKeyPaths",
                                                        "count": "[length(parameters('paths'))]",
                                                        "input": "[if(startsWith(parameters('paths')[copyIndex('partitionKeyPaths')], '/'), parameters('paths')[copyIndex('partitionKeyPaths')], format('/{0}', parameters('paths')[copyIndex('partitionKeyPaths')]))]"
                                                      }
                                                    ]
                                                  },
                                                  "resources": {
                                                    "databaseAccount::sqlDatabase": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
                                                      "apiVersion": "2025-04-15",
                                                      "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('sqlDatabaseName'))]"
                                                    },
                                                    "databaseAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts",
                                                      "apiVersion": "2025-04-15",
                                                      "name": "[parameters('databaseAccountName')]"
                                                    },
                                                    "container": {
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
                                                      "apiVersion": "2025-04-15",
                                                      "name": "[format('{0}/{1}/{2}', parameters('databaseAccountName'), parameters('sqlDatabaseName'), parameters('name'))]",
                                                      "tags": "[parameters('tags')]",
                                                      "properties": {
                                                        "resource": "[shallowMerge(createArray(createObject('conflictResolutionPolicy', parameters('conflictResolutionPolicy'), 'id', parameters('name'), 'indexingPolicy', parameters('indexingPolicy'), 'partitionKey', createObject('paths', variables('partitionKeyPaths'), 'kind', parameters('kind'), 'version', if(equals(parameters('kind'), 'MultiHash'), 2, parameters('version'))), 'uniqueKeyPolicy', if(not(empty(parameters('uniqueKeyPolicyKeys'))), createObject('uniqueKeys', parameters('uniqueKeyPolicyKeys')), null())), if(not(equals(parameters('analyticalStorageTtl'), 0)), createObject('analyticalStorageTtl', parameters('analyticalStorageTtl')), createObject()), if(not(equals(parameters('defaultTtl'), null())), createObject('defaultTtl', parameters('defaultTtl')), createObject())))]",
                                                        "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), null(), createObject('throughput', if(and(equals(parameters('autoscaleSettingsMaxThroughput'), null()), not(equals(parameters('throughput'), -1))), parameters('throughput'), null()), 'autoscaleSettings', if(not(equals(parameters('autoscaleSettingsMaxThroughput'), null())), createObject('maxThroughput', parameters('autoscaleSettingsMaxThroughput')), null())))]"
                                                      },
                                                      "dependsOn": [
                                                        "databaseAccount"
                                                      ]
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the container."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the container."
                                                      },
                                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('databaseAccountName'), parameters('sqlDatabaseName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the resource group the container was created in."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "sqlDatabase"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the SQL database."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the SQL database."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('databaseAccountName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the SQL database was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_sqlRoleDefinitions": {
                                      "copy": {
                                        "name": "databaseAccount_sqlRoleDefinitions",
                                        "count": "[length(coalesce(parameters('sqlRoleDefinitions'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-sqlrd-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "name": {
                                            "value": "[tryGet(coalesce(parameters('sqlRoleDefinitions'), createArray())[copyIndex()], 'name')]"
                                          },
                                          "dataActions": {
                                            "value": "[coalesce(parameters('sqlRoleDefinitions'), createArray())[copyIndex()].dataActions]"
                                          },
                                          "roleName": {
                                            "value": "[coalesce(parameters('sqlRoleDefinitions'), createArray())[copyIndex()].roleName]"
                                          },
                                          "assignableScopes": {
                                            "value": "[tryGet(coalesce(parameters('sqlRoleDefinitions'), createArray())[copyIndex()], 'assignableScopes')]"
                                          },
                                          "sqlRoleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('sqlRoleDefinitions'), createArray())[copyIndex()], 'assignments')]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "8600771348637416058"
                                            },
                                            "name": "DocumentDB Database Account SQL Role Definitions.",
                                            "description": "This module deploys a SQL Role Definision in a CosmosDB Account."
                                          },
                                          "definitions": {
                                            "sqlRoleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Name unique identifier of the SQL Role Assignment."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The unique identifier for the associated AAD principal in the AAD graph to which access is being granted through this Role Assignment. Tenant ID for the principal is inferred using the tenant associated with the subscription."
                                                  }
                                                },
                                                "scope": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The data plane resource id for which access is being granted through this Role Assignment. Defaults to the root of the database account, but can also be scoped to e.g., the container and database level."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type for the SQL Role Assignments."
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The unique identifier of the Role Definition."
                                              }
                                            },
                                            "roleName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A user-friendly name for the Role Definition. Must be unique for the database account."
                                              }
                                            },
                                            "dataActions": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "minLength": 1,
                                              "metadata": {
                                                "description": "Required. An array of data actions that are allowed."
                                              }
                                            },
                                            "assignableScopes": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. A set of fully qualified Scopes at or below which Role Assignments may be created using this Role Definition. This will allow application of this Role Definition on the entire database account or any underlying Database / Collection. Must have at least one element. Scopes higher than Database account are not enforceable as assignable Scopes. Note that resources referenced in assignable Scopes need not exist. Defaults to the current account."
                                              }
                                            },
                                            "sqlRoleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/sqlRoleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. An array of SQL Role Assignments to be created for the SQL Role Definition."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "enableReferencedModulesTelemetry": false
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.doctdb-dbacct-sqlroledefinition.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2024-11-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "sqlRoleDefinition": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions",
                                              "apiVersion": "2024-11-15",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName'))))]",
                                              "properties": {
                                                "assignableScopes": "[coalesce(parameters('assignableScopes'), createArray(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName'))))]",
                                                "permissions": [
                                                  {
                                                    "dataActions": "[parameters('dataActions')]"
                                                  }
                                                ],
                                                "roleName": "[parameters('roleName')]",
                                                "type": "CustomRole"
                                              }
                                            },
                                            "databaseAccount_sqlRoleAssignments": {
                                              "copy": {
                                                "name": "databaseAccount_sqlRoleAssignments",
                                                "count": "[length(coalesce(parameters('sqlRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-sqlra-{1}', uniqueString(deployment().name), copyIndex())]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "databaseAccountName": {
                                                    "value": "[parameters('databaseAccountName')]"
                                                  },
                                                  "roleDefinitionIdOrName": {
                                                    "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('databaseAccountName'), coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName'))))]"
                                                  },
                                                  "principalId": {
                                                    "value": "[coalesce(parameters('sqlRoleAssignments'), createArray())[copyIndex()].principalId]"
                                                  },
                                                  "name": {
                                                    "value": "[tryGet(coalesce(parameters('sqlRoleAssignments'), createArray())[copyIndex()], 'name')]"
                                                  },
                                                  "enableTelemetry": {
                                                    "value": "[variables('enableReferencedModulesTelemetry')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "17007224102611744259"
                                                    },
                                                    "name": "DocumentDB Database Account SQL Role Assignments.",
                                                    "description": "This module deploys a SQL Role Assignment in a CosmosDB Account."
                                                  },
                                                  "parameters": {
                                                    "databaseAccountName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Name unique identifier of the SQL Role Assignment."
                                                      }
                                                    },
                                                    "principalId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The unique identifier for the associated AAD principal in the AAD graph to which access is being granted through this Role Assignment. Tenant ID for the principal is inferred using the tenant associated with the subscription."
                                                      }
                                                    },
                                                    "roleDefinitionIdOrName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The unique identifier of the associated SQL Role Definition."
                                                      }
                                                    },
                                                    "enableTelemetry": {
                                                      "type": "bool",
                                                      "defaultValue": true,
                                                      "metadata": {
                                                        "description": "Optional. Enable/Disable usage telemetry for module."
                                                      }
                                                    },
                                                    "scope": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. The data plane resource id for which access is being granted through this Role Assignment. Defaults to the root of the database account, but can also be scoped to e.g., the container and database level."
                                                      }
                                                    }
                                                  },
                                                  "variables": {
                                                    "builtInDataPlaneRoleNames": {
                                                      "Cosmos DB Built-in Data Reader": "[format('{0}/sqlRoleDefinitions/00000000-0000-0000-0000-000000000001', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))]",
                                                      "Cosmos DB Built-in Data Contributor": "[format('{0}/sqlRoleDefinitions/00000000-0000-0000-0000-000000000002', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))]"
                                                    },
                                                    "formattedRoleDefinition": "[coalesce(tryGet(variables('builtInDataPlaneRoleNames'), parameters('roleDefinitionIdOrName')), if(contains(parameters('roleDefinitionIdOrName'), '/sqlRoleDefinitions/'), parameters('roleDefinitionIdOrName'), format('{0}/sqlRoleDefinitions/{1}', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('roleDefinitionIdOrName'))))]",
                                                    "formattedScope": "[replace(replace(coalesce(parameters('scope'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName'))), '/sqlDatabases/', '/dbs/'), '/containers/', '/colls/')]"
                                                  },
                                                  "resources": {
                                                    "avmTelemetry": {
                                                      "condition": "[parameters('enableTelemetry')]",
                                                      "type": "Microsoft.Resources/deployments",
                                                      "apiVersion": "2024-03-01",
                                                      "name": "[format('46d3xbcp.res.doctdb-dbacct-sqlroleassignment.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                                      "properties": {
                                                        "mode": "Incremental",
                                                        "template": {
                                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                          "contentVersion": "1.0.0.0",
                                                          "resources": [],
                                                          "outputs": {
                                                            "telemetry": {
                                                              "type": "String",
                                                              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                            }
                                                          }
                                                        }
                                                      }
                                                    },
                                                    "databaseAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts",
                                                      "apiVersion": "2024-11-15",
                                                      "name": "[parameters('databaseAccountName')]"
                                                    },
                                                    "sqlRoleAssignment": {
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                                                      "apiVersion": "2024-11-15",
                                                      "name": "[format('{0}/{1}', parameters('databaseAccountName'), coalesce(parameters('name'), guid(variables('formattedRoleDefinition'), parameters('principalId'), variables('formattedScope'))))]",
                                                      "properties": {
                                                        "principalId": "[parameters('principalId')]",
                                                        "roleDefinitionId": "[variables('formattedRoleDefinition')]",
                                                        "scope": "[variables('formattedScope')]"
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the SQL Role Assignment."
                                                      },
                                                      "value": "[coalesce(parameters('name'), guid(variables('formattedRoleDefinition'), parameters('principalId'), variables('formattedScope')))]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the SQL Role Assignment."
                                                      },
                                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments', parameters('databaseAccountName'), coalesce(parameters('name'), guid(variables('formattedRoleDefinition'), parameters('principalId'), variables('formattedScope'))))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the resource group the SQL Role Definition was created in."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "sqlRoleDefinition"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the SQL Role Definition."
                                              },
                                              "value": "[coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName')))]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the SQL Role Definition."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('databaseAccountName'), coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName'))))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the SQL Role Definition was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "roleName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The role name of the SQL Role Definition."
                                              },
                                              "value": "[reference('sqlRoleDefinition').roleName]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_sqlRoleAssignments": {
                                      "copy": {
                                        "name": "databaseAccount_sqlRoleAssignments",
                                        "count": "[length(coalesce(parameters('sqlRoleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-sqlra-{1}', uniqueString(deployment().name), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "roleDefinitionIdOrName": {
                                            "value": "[coalesce(parameters('sqlRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]"
                                          },
                                          "principalId": {
                                            "value": "[coalesce(parameters('sqlRoleAssignments'), createArray())[copyIndex()].principalId]"
                                          },
                                          "name": {
                                            "value": "[tryGet(coalesce(parameters('sqlRoleAssignments'), createArray())[copyIndex()], 'name')]"
                                          },
                                          "scope": {
                                            "value": "[tryGet(coalesce(parameters('sqlRoleAssignments'), createArray())[copyIndex()], 'scope')]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "17007224102611744259"
                                            },
                                            "name": "DocumentDB Database Account SQL Role Assignments.",
                                            "description": "This module deploys a SQL Role Assignment in a CosmosDB Account."
                                          },
                                          "parameters": {
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Name unique identifier of the SQL Role Assignment."
                                              }
                                            },
                                            "principalId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The unique identifier for the associated AAD principal in the AAD graph to which access is being granted through this Role Assignment. Tenant ID for the principal is inferred using the tenant associated with the subscription."
                                              }
                                            },
                                            "roleDefinitionIdOrName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The unique identifier of the associated SQL Role Definition."
                                              }
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            },
                                            "scope": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The data plane resource id for which access is being granted through this Role Assignment. Defaults to the root of the database account, but can also be scoped to e.g., the container and database level."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "builtInDataPlaneRoleNames": {
                                              "Cosmos DB Built-in Data Reader": "[format('{0}/sqlRoleDefinitions/00000000-0000-0000-0000-000000000001', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))]",
                                              "Cosmos DB Built-in Data Contributor": "[format('{0}/sqlRoleDefinitions/00000000-0000-0000-0000-000000000002', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))]"
                                            },
                                            "formattedRoleDefinition": "[coalesce(tryGet(variables('builtInDataPlaneRoleNames'), parameters('roleDefinitionIdOrName')), if(contains(parameters('roleDefinitionIdOrName'), '/sqlRoleDefinitions/'), parameters('roleDefinitionIdOrName'), format('{0}/sqlRoleDefinitions/{1}', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('roleDefinitionIdOrName'))))]",
                                            "formattedScope": "[replace(replace(coalesce(parameters('scope'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName'))), '/sqlDatabases/', '/dbs/'), '/containers/', '/colls/')]"
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2024-03-01",
                                              "name": "[format('46d3xbcp.res.doctdb-dbacct-sqlroleassignment.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2024-11-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "sqlRoleAssignment": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                                              "apiVersion": "2024-11-15",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), coalesce(parameters('name'), guid(variables('formattedRoleDefinition'), parameters('principalId'), variables('formattedScope'))))]",
                                              "properties": {
                                                "principalId": "[parameters('principalId')]",
                                                "roleDefinitionId": "[variables('formattedRoleDefinition')]",
                                                "scope": "[variables('formattedScope')]"
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the SQL Role Assignment."
                                              },
                                              "value": "[coalesce(parameters('name'), guid(variables('formattedRoleDefinition'), parameters('principalId'), variables('formattedScope')))]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the SQL Role Assignment."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments', parameters('databaseAccountName'), coalesce(parameters('name'), guid(variables('formattedRoleDefinition'), parameters('principalId'), variables('formattedScope'))))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the SQL Role Definition was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount",
                                        "databaseAccount_sqlDatabases",
                                        "databaseAccount_sqlRoleDefinitions"
                                      ]
                                    },
                                    "databaseAccount_cassandraRoleDefinitions": {
                                      "copy": {
                                        "name": "databaseAccount_cassandraRoleDefinitions",
                                        "count": "[length(coalesce(parameters('cassandraRoleDefinitions'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-cassandra-rd-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "name": {
                                            "value": "[tryGet(coalesce(parameters('cassandraRoleDefinitions'), createArray())[copyIndex()], 'name')]"
                                          },
                                          "roleName": {
                                            "value": "[coalesce(parameters('cassandraRoleDefinitions'), createArray())[copyIndex()].roleName]"
                                          },
                                          "dataActions": {
                                            "value": "[tryGet(coalesce(parameters('cassandraRoleDefinitions'), createArray())[copyIndex()], 'dataActions')]"
                                          },
                                          "notDataActions": {
                                            "value": "[tryGet(coalesce(parameters('cassandraRoleDefinitions'), createArray())[copyIndex()], 'notDataActions')]"
                                          },
                                          "assignableScopes": {
                                            "value": "[tryGet(coalesce(parameters('cassandraRoleDefinitions'), createArray())[copyIndex()], 'assignableScopes')]"
                                          },
                                          "cassandraRoleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('cassandraRoleDefinitions'), createArray())[copyIndex()], 'assignments')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "17859939500809924517"
                                            },
                                            "name": "DocumentDB Database Account Cassandra Role Definitions.",
                                            "description": "This module deploys a Cassandra Role Definition in a CosmosDB Account."
                                          },
                                          "definitions": {
                                            "cassandraRoleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The unique identifier of the role assignment."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The unique identifier for the associated AAD principal."
                                                  }
                                                },
                                                "scope": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The data plane resource path for which access is being granted. Defaults to the current account."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The unique identifier of the Role Definition."
                                              }
                                            },
                                            "roleName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. A user-friendly name for the Role Definition. Must be unique for the database account."
                                              }
                                            },
                                            "dataActions": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "defaultValue": [],
                                              "metadata": {
                                                "description": "Optional. An array of data actions that are allowed. Note: Valid data action strings for Cassandra API are currently undocumented (as of API version 2025-05-01-preview). Please refer to official Azure documentation once available."
                                              }
                                            },
                                            "notDataActions": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "defaultValue": [],
                                              "metadata": {
                                                "description": "Optional. An array of data actions that are denied. Note: Unlike SQL RBAC, Cassandra RBAC supports deny rules (notDataActions) for granular access control. Valid data action strings are currently undocumented (as of API version 2025-05-01-preview)."
                                              }
                                            },
                                            "assignableScopes": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. A set of fully qualified Scopes at or below which Role Assignments may be created using this Role Definition. This will allow application of this Role Definition on the entire database account or any underlying Database / Keyspace. Must have at least one element. Scopes higher than Database account are not enforceable as assignable Scopes. Note that resources referenced in assignable Scopes need not exist. Defaults to the current account."
                                              }
                                            },
                                            "cassandraRoleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/cassandraRoleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. An array of Cassandra Role Assignments to be created for the Cassandra Role Definition."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2024-11-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "cassandraRoleDefinition": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/cassandraRoleDefinitions",
                                              "apiVersion": "2025-05-01-preview",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName'))))]",
                                              "properties": {
                                                "assignableScopes": "[coalesce(parameters('assignableScopes'), createArray(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName'))))]",
                                                "permissions": [
                                                  {
                                                    "dataActions": "[parameters('dataActions')]",
                                                    "notDataActions": "[parameters('notDataActions')]"
                                                  }
                                                ],
                                                "roleName": "[parameters('roleName')]",
                                                "type": "CustomRole"
                                              }
                                            },
                                            "databaseAccount_cassandraRoleAssignments": {
                                              "copy": {
                                                "name": "databaseAccount_cassandraRoleAssignments",
                                                "count": "[length(coalesce(parameters('cassandraRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-cassandra-ra-{1}', uniqueString(deployment().name), copyIndex())]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "databaseAccountName": {
                                                    "value": "[parameters('databaseAccountName')]"
                                                  },
                                                  "roleDefinitionId": {
                                                    "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/cassandraRoleDefinitions', parameters('databaseAccountName'), coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName'))))]"
                                                  },
                                                  "principalId": {
                                                    "value": "[coalesce(parameters('cassandraRoleAssignments'), createArray())[copyIndex()].principalId]"
                                                  },
                                                  "name": {
                                                    "value": "[tryGet(coalesce(parameters('cassandraRoleAssignments'), createArray())[copyIndex()], 'name')]"
                                                  },
                                                  "scope": {
                                                    "value": "[tryGet(coalesce(parameters('cassandraRoleAssignments'), createArray())[copyIndex()], 'scope')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "552115240340341941"
                                                    },
                                                    "name": "DocumentDB Database Account Cassandra Role Assignments.",
                                                    "description": "This module deploys a Cassandra Role Assignment in a CosmosDB Account."
                                                  },
                                                  "parameters": {
                                                    "databaseAccountName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Name unique identifier of the Cassandra Role Assignment."
                                                      }
                                                    },
                                                    "principalId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The unique identifier for the associated AAD principal in the AAD graph to which access is being granted through this Role Assignment. Tenant ID for the principal is inferred using the tenant associated with the subscription."
                                                      }
                                                    },
                                                    "roleDefinitionId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. The unique identifier of the associated Cassandra Role Definition."
                                                      }
                                                    },
                                                    "scope": {
                                                      "type": "string",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. The data plane resource path for which access is being granted through this Cassandra Role Assignment. Defaults to the current account."
                                                      }
                                                    }
                                                  },
                                                  "resources": {
                                                    "databaseAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts",
                                                      "apiVersion": "2024-11-15",
                                                      "name": "[parameters('databaseAccountName')]"
                                                    },
                                                    "cassandraRoleAssignment": {
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/cassandraRoleAssignments",
                                                      "apiVersion": "2025-05-01-preview",
                                                      "name": "[format('{0}/{1}', parameters('databaseAccountName'), coalesce(parameters('name'), guid(parameters('roleDefinitionId'), parameters('principalId'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))))]",
                                                      "properties": {
                                                        "principalId": "[parameters('principalId')]",
                                                        "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                                        "scope": "[coalesce(parameters('scope'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))]"
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the Cassandra Role Assignment."
                                                      },
                                                      "value": "[coalesce(parameters('name'), guid(parameters('roleDefinitionId'), parameters('principalId'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName'))))]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the Cassandra Role Assignment."
                                                      },
                                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/cassandraRoleAssignments', parameters('databaseAccountName'), coalesce(parameters('name'), guid(parameters('roleDefinitionId'), parameters('principalId'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the resource group the Cassandra Role Assignment was created in."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "cassandraRoleDefinition"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the cassandra role definition."
                                              },
                                              "value": "[coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName')))]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the cassandra role definition."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/cassandraRoleDefinitions', parameters('databaseAccountName'), coalesce(parameters('name'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), parameters('databaseAccountName'), parameters('roleName'))))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the cassandra role definition was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_cassandraRoleAssignments": {
                                      "copy": {
                                        "name": "databaseAccount_cassandraRoleAssignments",
                                        "count": "[length(coalesce(parameters('cassandraRoleAssignments'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-cassandra-ra-{1}', uniqueString(deployment().name), copyIndex())]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "roleDefinitionId": {
                                            "value": "[coalesce(parameters('cassandraRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]"
                                          },
                                          "principalId": {
                                            "value": "[coalesce(parameters('cassandraRoleAssignments'), createArray())[copyIndex()].principalId]"
                                          },
                                          "name": {
                                            "value": "[tryGet(coalesce(parameters('cassandraRoleAssignments'), createArray())[copyIndex()], 'name')]"
                                          },
                                          "scope": {
                                            "value": "[tryGet(coalesce(parameters('cassandraRoleAssignments'), createArray())[copyIndex()], 'scope')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "552115240340341941"
                                            },
                                            "name": "DocumentDB Database Account Cassandra Role Assignments.",
                                            "description": "This module deploys a Cassandra Role Assignment in a CosmosDB Account."
                                          },
                                          "parameters": {
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Name unique identifier of the Cassandra Role Assignment."
                                              }
                                            },
                                            "principalId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The unique identifier for the associated AAD principal in the AAD graph to which access is being granted through this Role Assignment. Tenant ID for the principal is inferred using the tenant associated with the subscription."
                                              }
                                            },
                                            "roleDefinitionId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. The unique identifier of the associated Cassandra Role Definition."
                                              }
                                            },
                                            "scope": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The data plane resource path for which access is being granted through this Cassandra Role Assignment. Defaults to the current account."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2024-11-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "cassandraRoleAssignment": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/cassandraRoleAssignments",
                                              "apiVersion": "2025-05-01-preview",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), coalesce(parameters('name'), guid(parameters('roleDefinitionId'), parameters('principalId'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))))]",
                                              "properties": {
                                                "principalId": "[parameters('principalId')]",
                                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                                "scope": "[coalesce(parameters('scope'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))]"
                                              }
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the Cassandra Role Assignment."
                                              },
                                              "value": "[coalesce(parameters('name'), guid(parameters('roleDefinitionId'), parameters('principalId'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName'))))]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the Cassandra Role Assignment."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/cassandraRoleAssignments', parameters('databaseAccountName'), coalesce(parameters('name'), guid(parameters('roleDefinitionId'), parameters('principalId'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')))))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the Cassandra Role Assignment was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount",
                                        "databaseAccount_cassandraKeyspaces",
                                        "databaseAccount_cassandraRoleDefinitions"
                                      ]
                                    },
                                    "databaseAccount_mongodbDatabases": {
                                      "copy": {
                                        "name": "databaseAccount_mongodbDatabases",
                                        "count": "[length(coalesce(parameters('mongodbDatabases'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-mongodb-{1}', uniqueString(deployment().name, parameters('location')), coalesce(parameters('mongodbDatabases'), createArray())[copyIndex()].name)]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "name": {
                                            "value": "[coalesce(parameters('mongodbDatabases'), createArray())[copyIndex()].name]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('mongodbDatabases'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "collections": {
                                            "value": "[tryGet(coalesce(parameters('mongodbDatabases'), createArray())[copyIndex()], 'collections')]"
                                          },
                                          "throughput": {
                                            "value": "[tryGet(coalesce(parameters('mongodbDatabases'), createArray())[copyIndex()], 'throughput')]"
                                          },
                                          "autoscaleSettings": {
                                            "value": "[tryGet(coalesce(parameters('mongodbDatabases'), createArray())[copyIndex()], 'autoscaleSettings')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "7289795303297936310"
                                            },
                                            "name": "DocumentDB Database Account MongoDB Databases",
                                            "description": "This module deploys a MongoDB Database within a CosmosDB Account."
                                          },
                                          "definitions": {
                                            "collectionType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. Name of the collection."
                                                  }
                                                },
                                                "throughput": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Request Units per second. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the collection level and not at the database level."
                                                  }
                                                },
                                                "indexes": {
                                                  "type": "array",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/indexes"
                                                    },
                                                    "description": "Required. Indexes for the collection."
                                                  }
                                                },
                                                "shardKey": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/shardKey"
                                                    },
                                                    "description": "Required. ShardKey for the collection."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a collection."
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Cosmos DB database account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the mongodb database."
                                              }
                                            },
                                            "throughput": {
                                              "type": "int",
                                              "defaultValue": 400,
                                              "metadata": {
                                                "description": "Optional. Request Units per second. Setting throughput at the database level is only recommended for development/test or when workload across all collections in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the collection level and not at the database level."
                                              }
                                            },
                                            "collections": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/collectionType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Collections in the mongodb database."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases@2025-04-15#properties/tags"
                                                },
                                                "description": "Optional. Tags of the resource."
                                              },
                                              "nullable": true
                                            },
                                            "autoscaleSettings": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases@2025-04-15#properties/properties/properties/options/properties/autoscaleSettings"
                                                },
                                                "description": "Optional. Specifies the Autoscale settings. Note: Either throughput or autoscaleSettings is required, but not both."
                                              },
                                              "nullable": true
                                            }
                                          },
                                          "resources": {
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2025-04-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "mongodbDatabase": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases",
                                              "apiVersion": "2025-04-15",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('name'))]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "resource": {
                                                  "id": "[parameters('name')]"
                                                },
                                                "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), null(), createObject('throughput', parameters('throughput'), 'autoscaleSettings', parameters('autoscaleSettings')))]"
                                              },
                                              "dependsOn": [
                                                "databaseAccount"
                                              ]
                                            },
                                            "mongodbDatabase_collections": {
                                              "copy": {
                                                "name": "mongodbDatabase_collections",
                                                "count": "[length(coalesce(parameters('collections'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-collection-{1}', uniqueString(deployment().name, parameters('name')), coalesce(parameters('collections'), createArray())[copyIndex()].name)]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "databaseAccountName": {
                                                    "value": "[parameters('databaseAccountName')]"
                                                  },
                                                  "mongodbDatabaseName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "name": {
                                                    "value": "[coalesce(parameters('collections'), createArray())[copyIndex()].name]"
                                                  },
                                                  "indexes": {
                                                    "value": "[coalesce(parameters('collections'), createArray())[copyIndex()].indexes]"
                                                  },
                                                  "shardKey": {
                                                    "value": "[coalesce(parameters('collections'), createArray())[copyIndex()].shardKey]"
                                                  },
                                                  "throughput": {
                                                    "value": "[tryGet(coalesce(parameters('collections'), createArray())[copyIndex()], 'throughput')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "4317369978166598876"
                                                    },
                                                    "name": "DocumentDB Database Account MongoDB Database Collections",
                                                    "description": "This module deploys a MongoDB Database Collection."
                                                  },
                                                  "parameters": {
                                                    "databaseAccountName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Cosmos DB database account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "mongodbDatabaseName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent mongodb database. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the collection."
                                                      }
                                                    },
                                                    "throughput": {
                                                      "type": "int",
                                                      "defaultValue": 400,
                                                      "metadata": {
                                                        "description": "Optional. Request Units per second. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the collection level and not at the database level."
                                                      }
                                                    },
                                                    "indexes": {
                                                      "type": "array",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/indexes"
                                                        },
                                                        "description": "Required. Indexes for the collection."
                                                      }
                                                    },
                                                    "shardKey": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections@2025-04-15#properties/properties/properties/resource/properties/shardKey"
                                                        },
                                                        "description": "Required. ShardKey for the collection."
                                                      }
                                                    }
                                                  },
                                                  "resources": [
                                                    {
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections",
                                                      "apiVersion": "2025-04-15",
                                                      "name": "[format('{0}/{1}/{2}', parameters('databaseAccountName'), parameters('mongodbDatabaseName'), parameters('name'))]",
                                                      "properties": {
                                                        "options": "[if(contains(reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccountName')), '2025-04-15').capabilities, createObject('name', 'EnableServerless')), null(), createObject('throughput', parameters('throughput')))]",
                                                        "resource": {
                                                          "id": "[parameters('name')]",
                                                          "indexes": "[parameters('indexes')]",
                                                          "shardKey": "[parameters('shardKey')]"
                                                        }
                                                      }
                                                    }
                                                  ],
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the mongodb database collection."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the mongodb database collection."
                                                      },
                                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections', parameters('databaseAccountName'), parameters('mongodbDatabaseName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the resource group the mongodb database collection was created in."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "mongodbDatabase"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the mongodb database."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the mongodb database."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/mongodbDatabases', parameters('databaseAccountName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the mongodb database was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_gremlinDatabases": {
                                      "copy": {
                                        "name": "databaseAccount_gremlinDatabases",
                                        "count": "[length(coalesce(parameters('gremlinDatabases'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-gremlin-{1}', uniqueString(deployment().name, parameters('location')), coalesce(parameters('gremlinDatabases'), createArray())[copyIndex()].name)]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "name": {
                                            "value": "[coalesce(parameters('gremlinDatabases'), createArray())[copyIndex()].name]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('gremlinDatabases'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "graphs": {
                                            "value": "[tryGet(coalesce(parameters('gremlinDatabases'), createArray())[copyIndex()], 'graphs')]"
                                          },
                                          "maxThroughput": {
                                            "value": "[tryGet(coalesce(parameters('gremlinDatabases'), createArray())[copyIndex()], 'maxThroughput')]"
                                          },
                                          "throughput": {
                                            "value": "[tryGet(coalesce(parameters('gremlinDatabases'), createArray())[copyIndex()], 'throughput')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "14708982296215631776"
                                            },
                                            "name": "DocumentDB Database Account Gremlin Databases",
                                            "description": "This module deploys a Gremlin Database within a CosmosDB Account."
                                          },
                                          "definitions": {
                                            "graphType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. Name of the graph."
                                                  }
                                                },
                                                "tags": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/tags"
                                                    },
                                                    "description": "Optional. Tags of the Gremlin graph resource."
                                                  },
                                                  "nullable": true
                                                },
                                                "indexingPolicy": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                                                    },
                                                    "description": "Optional. Indexing policy of the graph."
                                                  },
                                                  "nullable": true
                                                },
                                                "partitionKeyPaths": {
                                                  "type": "array",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/partitionKey/properties/paths"
                                                    },
                                                    "description": "Optional. List of paths using which data within the container can be partitioned."
                                                  },
                                                  "nullable": true
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a graph."
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the Gremlin database."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases@2024-11-15#properties/tags"
                                                },
                                                "description": "Optional. Tags of the Gremlin database resource."
                                              },
                                              "nullable": true
                                            },
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Gremlin database. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "graphs": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/graphType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of graphs to deploy in the Gremlin database."
                                              }
                                            },
                                            "maxThroughput": {
                                              "type": "int",
                                              "defaultValue": 4000,
                                              "metadata": {
                                                "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored. Setting throughput at the database level is only recommended for development/test or when workload across all graphs in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the graph level and not at the database level."
                                              }
                                            },
                                            "throughput": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `maxThroughput`. Setting throughput at the database level is only recommended for development/test or when workload across all graphs in the shared throughput database is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the graph level and not at the database level."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2025-04-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "gremlinDatabase": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases",
                                              "apiVersion": "2025-04-15",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('name'))]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), createObject(), createObject('autoscaleSettings', if(equals(parameters('throughput'), null()), createObject('maxThroughput', parameters('maxThroughput')), null()), 'throughput', parameters('throughput')))]",
                                                "resource": {
                                                  "id": "[parameters('name')]"
                                                }
                                              },
                                              "dependsOn": [
                                                "databaseAccount"
                                              ]
                                            },
                                            "gremlinDatabase_gremlinGraphs": {
                                              "copy": {
                                                "name": "gremlinDatabase_gremlinGraphs",
                                                "count": "[length(coalesce(parameters('graphs'), createArray()))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-gremlindb-{1}', uniqueString(deployment().name, parameters('name')), coalesce(parameters('graphs'), createArray())[copyIndex()].name)]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[coalesce(parameters('graphs'), createArray())[copyIndex()].name]"
                                                  },
                                                  "gremlinDatabaseName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "databaseAccountName": {
                                                    "value": "[parameters('databaseAccountName')]"
                                                  },
                                                  "indexingPolicy": {
                                                    "value": "[tryGet(coalesce(parameters('graphs'), createArray())[copyIndex()], 'indexingPolicy')]"
                                                  },
                                                  "partitionKeyPaths": {
                                                    "value": "[tryGet(coalesce(parameters('graphs'), createArray())[copyIndex()], 'partitionKeyPaths')]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "15097132107382000570"
                                                    },
                                                    "name": "DocumentDB Database Accounts Gremlin Databases Graphs",
                                                    "description": "This module deploys a DocumentDB Database Accounts Gremlin Database Graph."
                                                  },
                                                  "parameters": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the graph."
                                                      }
                                                    },
                                                    "tags": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/tags"
                                                        },
                                                        "description": "Optional. Tags of the Gremlin graph resource."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "databaseAccountName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "gremlinDatabaseName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Gremlin Database. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "indexingPolicy": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/indexingPolicy"
                                                        },
                                                        "description": "Optional. Indexing policy of the graph."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "partitionKeyPaths": {
                                                      "type": "array",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs@2025-04-15#properties/properties/properties/resource/properties/partitionKey/properties/paths"
                                                        },
                                                        "description": "Optional. List of paths using which data within the container can be partitioned."
                                                      },
                                                      "nullable": true
                                                    }
                                                  },
                                                  "resources": {
                                                    "databaseAccount::gremlinDatabase": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases",
                                                      "apiVersion": "2025-04-15",
                                                      "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('gremlinDatabaseName'))]"
                                                    },
                                                    "databaseAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts",
                                                      "apiVersion": "2025-04-15",
                                                      "name": "[parameters('databaseAccountName')]"
                                                    },
                                                    "gremlinGraph": {
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs",
                                                      "apiVersion": "2025-04-15",
                                                      "name": "[format('{0}/{1}/{2}', parameters('databaseAccountName'), parameters('gremlinDatabaseName'), parameters('name'))]",
                                                      "tags": "[parameters('tags')]",
                                                      "properties": {
                                                        "resource": {
                                                          "id": "[parameters('name')]",
                                                          "indexingPolicy": "[parameters('indexingPolicy')]",
                                                          "partitionKey": {
                                                            "paths": "[parameters('partitionKeyPaths')]"
                                                          }
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the graph."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the graph."
                                                      },
                                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/gremlinDatabases/graphs', parameters('databaseAccountName'), parameters('gremlinDatabaseName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the resource group the graph was created in."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "gremlinDatabase"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the Gremlin database."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the Gremlin database."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/gremlinDatabases', parameters('databaseAccountName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the Gremlin database was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_tables": {
                                      "copy": {
                                        "name": "databaseAccount_tables",
                                        "count": "[length(coalesce(parameters('tables'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-table-{1}', uniqueString(deployment().name, parameters('location')), coalesce(parameters('tables'), createArray())[copyIndex()].name)]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "name": {
                                            "value": "[coalesce(parameters('tables'), createArray())[copyIndex()].name]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('tables'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "maxThroughput": {
                                            "value": "[tryGet(coalesce(parameters('tables'), createArray())[copyIndex()], 'maxThroughput')]"
                                          },
                                          "throughput": {
                                            "value": "[tryGet(coalesce(parameters('tables'), createArray())[copyIndex()], 'throughput')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "11768488776074268398"
                                            },
                                            "name": "Azure Cosmos DB account tables",
                                            "description": "This module deploys a table within an Azure Cosmos DB Account."
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the table."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.DocumentDB/databaseAccounts/tables@2025-04-15#properties/tags"
                                                },
                                                "description": "Optional. Tags for the table."
                                              },
                                              "nullable": true
                                            },
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Azure Cosmos DB account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "maxThroughput": {
                                              "type": "int",
                                              "defaultValue": 4000,
                                              "metadata": {
                                                "description": "Optional. Represents maximum throughput, the resource can scale up to. Cannot be set together with `throughput`. If `throughput` is set to something else than -1, this autoscale setting is ignored."
                                              }
                                            },
                                            "throughput": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Request Units per second (for example 10000). Cannot be set together with `maxThroughput`."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2025-04-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "table": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/tables",
                                              "apiVersion": "2025-04-15",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('name'))]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), createObject(), createObject('autoscaleSettings', if(equals(parameters('throughput'), null()), createObject('maxThroughput', parameters('maxThroughput')), null()), 'throughput', parameters('throughput')))]",
                                                "resource": {
                                                  "id": "[parameters('name')]"
                                                }
                                              },
                                              "dependsOn": [
                                                "databaseAccount"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the table."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the table."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/tables', parameters('databaseAccountName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the table was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_cassandraKeyspaces": {
                                      "copy": {
                                        "name": "databaseAccount_cassandraKeyspaces",
                                        "count": "[length(coalesce(parameters('cassandraKeyspaces'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-cassandradb-{1}', uniqueString(deployment().name, parameters('location')), coalesce(parameters('cassandraKeyspaces'), createArray())[copyIndex()].name)]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "databaseAccountName": {
                                            "value": "[parameters('name')]"
                                          },
                                          "name": {
                                            "value": "[coalesce(parameters('cassandraKeyspaces'), createArray())[copyIndex()].name]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('cassandraKeyspaces'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "tables": {
                                            "value": "[tryGet(coalesce(parameters('cassandraKeyspaces'), createArray())[copyIndex()], 'tables')]"
                                          },
                                          "views": {
                                            "value": "[tryGet(coalesce(parameters('cassandraKeyspaces'), createArray())[copyIndex()], 'views')]"
                                          },
                                          "autoscaleSettingsMaxThroughput": {
                                            "value": "[tryGet(coalesce(parameters('cassandraKeyspaces'), createArray())[copyIndex()], 'autoscaleSettingsMaxThroughput')]"
                                          },
                                          "throughput": {
                                            "value": "[tryGet(coalesce(parameters('cassandraKeyspaces'), createArray())[copyIndex()], 'throughput')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.33.27573",
                                              "templateHash": "63327155428300562"
                                            },
                                            "name": "DocumentDB Database Account Cassandra Keyspaces",
                                            "description": "This module deploys a Cassandra Keyspace within a CosmosDB Account."
                                          },
                                          "definitions": {
                                            "tableType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. Name of the table."
                                                  }
                                                },
                                                "schema": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/properties/properties/resource/properties/schema"
                                                    },
                                                    "description": "Required. Schema definition for the table."
                                                  }
                                                },
                                                "tags": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/tags"
                                                    },
                                                    "description": "Optional. Tags for the table."
                                                  },
                                                  "nullable": true
                                                },
                                                "defaultTtl": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Default TTL (Time To Live) in seconds for data in the table."
                                                  }
                                                },
                                                "analyticalStorageTtl": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Analytical TTL for the table."
                                                  }
                                                },
                                                "throughput": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput."
                                                  }
                                                },
                                                "autoscaleSettingsMaxThroughput": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Maximum autoscale throughput for the table. Cannot be used with throughput."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a Cassandra table."
                                              }
                                            },
                                            "viewType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. Name of the view."
                                                  }
                                                },
                                                "viewDefinition": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. View definition (CQL statement)."
                                                  }
                                                },
                                                "tags": {
                                                  "type": "object",
                                                  "metadata": {
                                                    "__bicep_resource_derived_type!": {
                                                      "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/views@2025-05-01-preview#properties/tags"
                                                    },
                                                    "description": "Optional. Tags for the view."
                                                  },
                                                  "nullable": true
                                                },
                                                "throughput": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput."
                                                  }
                                                },
                                                "autoscaleSettingsMaxThroughput": {
                                                  "type": "int",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Maximum autoscale throughput for the view. Cannot be used with throughput."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a Cassandra view (materialized view)."
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the Cassandra keyspace."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces@2024-11-15#properties/tags"
                                                },
                                                "description": "Optional. Tags of the Cassandra keyspace resource."
                                              },
                                              "nullable": true
                                            },
                                            "databaseAccountName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Conditional. The name of the parent Cosmos DB account. Required if the template is used in a standalone deployment."
                                              }
                                            },
                                            "tables": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/tableType"
                                              },
                                              "defaultValue": [],
                                              "metadata": {
                                                "description": "Optional. Array of Cassandra tables to deploy in the keyspace."
                                              }
                                            },
                                            "views": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/viewType"
                                              },
                                              "defaultValue": [],
                                              "metadata": {
                                                "description": "Optional. Array of Cassandra views (materialized views) to deploy in the keyspace."
                                              }
                                            },
                                            "autoscaleSettingsMaxThroughput": {
                                              "type": "int",
                                              "defaultValue": 4000,
                                              "metadata": {
                                                "description": "Optional. Maximum autoscale throughput for the keyspace. If not set, autoscale will be disabled. Setting throughput at the keyspace level is only recommended for development/test or when workload across all tables in the shared throughput keyspace is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the table level."
                                              }
                                            },
                                            "throughput": {
                                              "type": "int",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput. Setting throughput at the keyspace level is only recommended for development/test or when workload across all tables in the shared throughput keyspace is uniform. For best performance for large production workloads, it is recommended to set dedicated throughput (autoscale or manual) at the table level."
                                              }
                                            }
                                          },
                                          "resources": {
                                            "databaseAccount": {
                                              "existing": true,
                                              "type": "Microsoft.DocumentDB/databaseAccounts",
                                              "apiVersion": "2024-11-15",
                                              "name": "[parameters('databaseAccountName')]"
                                            },
                                            "cassandraKeyspace": {
                                              "type": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces",
                                              "apiVersion": "2024-11-15",
                                              "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('name'))]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), createObject(), createObject('autoscaleSettings', if(equals(parameters('throughput'), null()), createObject('maxThroughput', parameters('autoscaleSettingsMaxThroughput')), null()), 'throughput', parameters('throughput')))]",
                                                "resource": {
                                                  "id": "[parameters('name')]"
                                                }
                                              },
                                              "dependsOn": [
                                                "databaseAccount"
                                              ]
                                            },
                                            "cassandraKeyspace_tables": {
                                              "copy": {
                                                "name": "cassandraKeyspace_tables",
                                                "count": "[length(parameters('tables'))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-cassandradb-{1}', uniqueString(deployment().name, parameters('name')), parameters('tables')[copyIndex()].name)]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[parameters('tables')[copyIndex()].name]"
                                                  },
                                                  "cassandraKeyspaceName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "databaseAccountName": {
                                                    "value": "[parameters('databaseAccountName')]"
                                                  },
                                                  "schema": {
                                                    "value": "[parameters('tables')[copyIndex()].schema]"
                                                  },
                                                  "analyticalStorageTtl": {
                                                    "value": "[tryGet(parameters('tables')[copyIndex()], 'analyticalStorageTtl')]"
                                                  },
                                                  "throughput": {
                                                    "value": "[tryGet(parameters('tables')[copyIndex()], 'throughput')]"
                                                  },
                                                  "autoscaleSettingsMaxThroughput": {
                                                    "value": "[tryGet(parameters('tables')[copyIndex()], 'autoscaleSettingsMaxThroughput')]"
                                                  },
                                                  "defaultTtl": {
                                                    "value": "[tryGet(parameters('tables')[copyIndex()], 'defaultTtl')]"
                                                  },
                                                  "tags": {
                                                    "value": "[coalesce(tryGet(parameters('tables')[copyIndex()], 'tags'), parameters('tags'))]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "785607874724829202"
                                                    },
                                                    "name": "DocumentDB Database Account Cassandra Keyspaces Tables",
                                                    "description": "This module deploys a Cassandra Table within a Cassandra Keyspace in a CosmosDB Account."
                                                  },
                                                  "parameters": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the Cassandra table."
                                                      }
                                                    },
                                                    "tags": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/tags"
                                                        },
                                                        "description": "Optional. Tags of the Cassandra table resource."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "databaseAccountName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "cassandraKeyspaceName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Cassandra Keyspace. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "schema": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables@2024-11-15#properties/properties/properties/resource/properties/schema"
                                                        },
                                                        "description": "Required. Schema definition for the Cassandra table."
                                                      }
                                                    },
                                                    "analyticalStorageTtl": {
                                                      "type": "int",
                                                      "defaultValue": 0,
                                                      "metadata": {
                                                        "description": "Optional. Analytical TTL for the table. Default to 0 (disabled). Analytical store is enabled when set to a value other than 0. If set to -1, analytical store retains all historical data."
                                                      }
                                                    },
                                                    "throughput": {
                                                      "type": "int",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput. If not specified, the table will inherit throughput from the keyspace."
                                                      }
                                                    },
                                                    "autoscaleSettingsMaxThroughput": {
                                                      "type": "int",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Maximum autoscale throughput for the table. Cannot be used with throughput. If not specified, the table will inherit throughput from the keyspace."
                                                      }
                                                    },
                                                    "defaultTtl": {
                                                      "type": "int",
                                                      "defaultValue": 0,
                                                      "metadata": {
                                                        "description": "Optional. Default time to live in seconds. Default to 0 (disabled). If set to -1, items do not expire."
                                                      }
                                                    }
                                                  },
                                                  "resources": {
                                                    "databaseAccount::cassandraKeyspace": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces",
                                                      "apiVersion": "2024-11-15",
                                                      "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('cassandraKeyspaceName'))]"
                                                    },
                                                    "databaseAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts",
                                                      "apiVersion": "2024-11-15",
                                                      "name": "[parameters('databaseAccountName')]"
                                                    },
                                                    "cassandraTable": {
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables",
                                                      "apiVersion": "2024-11-15",
                                                      "name": "[format('{0}/{1}/{2}', parameters('databaseAccountName'), parameters('cassandraKeyspaceName'), parameters('name'))]",
                                                      "tags": "[parameters('tags')]",
                                                      "properties": {
                                                        "resource": {
                                                          "id": "[parameters('name')]",
                                                          "schema": "[parameters('schema')]",
                                                          "defaultTtl": "[parameters('defaultTtl')]",
                                                          "analyticalStorageTtl": "[parameters('analyticalStorageTtl')]"
                                                        },
                                                        "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), createObject(), createObject('autoscaleSettings', if(and(equals(parameters('throughput'), null()), not(equals(parameters('autoscaleSettingsMaxThroughput'), null()))), createObject('maxThroughput', parameters('autoscaleSettingsMaxThroughput')), null()), 'throughput', parameters('throughput')))]"
                                                      },
                                                      "dependsOn": [
                                                        "databaseAccount"
                                                      ]
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the Cassandra table."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the Cassandra table."
                                                      },
                                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/tables', parameters('databaseAccountName'), parameters('cassandraKeyspaceName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the resource group the Cassandra table was created in."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "cassandraKeyspace"
                                              ]
                                            },
                                            "cassandraKeyspace_views": {
                                              "copy": {
                                                "name": "cassandraKeyspace_views",
                                                "count": "[length(parameters('views'))]"
                                              },
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-cassandraview-{1}', uniqueString(deployment().name, parameters('name')), parameters('views')[copyIndex()].name)]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[parameters('views')[copyIndex()].name]"
                                                  },
                                                  "cassandraKeyspaceName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "databaseAccountName": {
                                                    "value": "[parameters('databaseAccountName')]"
                                                  },
                                                  "viewDefinition": {
                                                    "value": "[parameters('views')[copyIndex()].viewDefinition]"
                                                  },
                                                  "throughput": {
                                                    "value": "[tryGet(parameters('views')[copyIndex()], 'throughput')]"
                                                  },
                                                  "autoscaleSettingsMaxThroughput": {
                                                    "value": "[tryGet(parameters('views')[copyIndex()], 'autoscaleSettingsMaxThroughput')]"
                                                  },
                                                  "tags": {
                                                    "value": "[coalesce(tryGet(parameters('views')[copyIndex()], 'tags'), parameters('tags'))]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.33.27573",
                                                      "templateHash": "14021794949328228224"
                                                    },
                                                    "name": "DocumentDB Database Account Cassandra Keyspaces Views",
                                                    "description": "This module deploys a Cassandra View (Materialized View) within a Cassandra Keyspace in a CosmosDB Account."
                                                  },
                                                  "parameters": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. Name of the Cassandra view."
                                                      }
                                                    },
                                                    "tags": {
                                                      "type": "object",
                                                      "metadata": {
                                                        "__bicep_resource_derived_type!": {
                                                          "source": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/views@2025-05-01-preview#properties/tags"
                                                        },
                                                        "description": "Optional. Tags of the Cassandra view resource."
                                                      },
                                                      "nullable": true
                                                    },
                                                    "databaseAccountName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Database Account. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "cassandraKeyspaceName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent Cassandra Keyspace. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "viewDefinition": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Required. View definition of the Cassandra view. This is the CQL statement that defines the materialized view."
                                                      }
                                                    },
                                                    "throughput": {
                                                      "type": "int",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Request units per second. Cannot be used with autoscaleSettingsMaxThroughput."
                                                      }
                                                    },
                                                    "autoscaleSettingsMaxThroughput": {
                                                      "type": "int",
                                                      "nullable": true,
                                                      "metadata": {
                                                        "description": "Optional. Maximum autoscale throughput for the view. Cannot be used with throughput."
                                                      }
                                                    },
                                                    "location": {
                                                      "type": "string",
                                                      "defaultValue": "[resourceGroup().location]",
                                                      "metadata": {
                                                        "description": "Optional. Location for all resources."
                                                      }
                                                    }
                                                  },
                                                  "resources": {
                                                    "databaseAccount::cassandraKeyspace": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces",
                                                      "apiVersion": "2025-05-01-preview",
                                                      "name": "[format('{0}/{1}', parameters('databaseAccountName'), parameters('cassandraKeyspaceName'))]"
                                                    },
                                                    "databaseAccount": {
                                                      "existing": true,
                                                      "type": "Microsoft.DocumentDB/databaseAccounts",
                                                      "apiVersion": "2025-05-01-preview",
                                                      "name": "[parameters('databaseAccountName')]"
                                                    },
                                                    "cassandraView": {
                                                      "type": "Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/views",
                                                      "apiVersion": "2025-05-01-preview",
                                                      "name": "[format('{0}/{1}/{2}', parameters('databaseAccountName'), parameters('cassandraKeyspaceName'), parameters('name'))]",
                                                      "tags": "[parameters('tags')]",
                                                      "location": "[parameters('location')]",
                                                      "properties": {
                                                        "resource": {
                                                          "id": "[parameters('name')]",
                                                          "viewDefinition": "[parameters('viewDefinition')]"
                                                        },
                                                        "options": "[if(contains(reference('databaseAccount').capabilities, createObject('name', 'EnableServerless')), createObject(), createObject('autoscaleSettings', if(and(equals(parameters('throughput'), null()), not(equals(parameters('autoscaleSettingsMaxThroughput'), null()))), createObject('maxThroughput', parameters('autoscaleSettingsMaxThroughput')), null()), 'throughput', parameters('throughput')))]"
                                                      },
                                                      "dependsOn": [
                                                        "databaseAccount"
                                                      ]
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the Cassandra view."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the Cassandra view."
                                                      },
                                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces/views', parameters('databaseAccountName'), parameters('cassandraKeyspaceName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the resource group the Cassandra view was created in."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "cassandraKeyspace"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the Cassandra keyspace."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the Cassandra keyspace."
                                              },
                                              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/cassandraKeyspaces', parameters('databaseAccountName'), parameters('name'))]"
                                            },
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the resource group the Cassandra keyspace was created in."
                                              },
                                              "value": "[resourceGroup().name]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    },
                                    "databaseAccount_privateEndpoints": {
                                      "copy": {
                                        "name": "databaseAccount_privateEndpoints",
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]"
                                      },
                                      "type": "Microsoft.Resources/deployments",
                                      "apiVersion": "2025-04-01",
                                      "name": "[format('{0}-dbAccount-PrivateEndpoint-{1}', uniqueString(deployment().name, parameters('location')), copyIndex())]",
                                      "subscriptionId": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[2]]",
                                      "resourceGroup": "[split(coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'resourceGroupResourceId'), resourceGroup().id), '/')[4]]",
                                      "properties": {
                                        "expressionEvaluationOptions": {
                                          "scope": "inner"
                                        },
                                        "mode": "Incremental",
                                        "parameters": {
                                          "name": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'name'), format('pep-{0}-{1}-{2}', last(split(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '/')), coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service, copyIndex()))]"
                                          },
                                          "privateLinkServiceConnections": "[if(not(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true())), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '/')), coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service, copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), 'groupIds', createArray(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service))))), createObject('value', null()))]",
                                          "manualPrivateLinkServiceConnections": "[if(equals(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'isManualConnection'), true()), createObject('value', createArray(createObject('name', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateLinkServiceConnectionName'), format('{0}-{1}-{2}', last(split(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '/')), coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service, copyIndex())), 'properties', createObject('privateLinkServiceId', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), 'groupIds', createArray(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].service), 'requestMessage', coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'manualConnectionRequestMessage'), 'Manual approval required.'))))), createObject('value', null()))]",
                                          "subnetResourceId": {
                                            "value": "[coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId]"
                                          },
                                          "enableTelemetry": {
                                            "value": "[variables('enableReferencedModulesTelemetry')]"
                                          },
                                          "location": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'location'), reference(split(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()].subnetResourceId, '/subnets/')[0], '2020-06-01', 'Full').location)]"
                                          },
                                          "lock": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'lock'), parameters('lock'))]"
                                          },
                                          "privateDnsZoneGroup": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'privateDnsZoneGroup')]"
                                          },
                                          "roleAssignments": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'roleAssignments')]"
                                          },
                                          "tags": {
                                            "value": "[coalesce(tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'tags'), parameters('tags'))]"
                                          },
                                          "customDnsConfigs": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customDnsConfigs')]"
                                          },
                                          "ipConfigurations": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'ipConfigurations')]"
                                          },
                                          "applicationSecurityGroupResourceIds": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'applicationSecurityGroupResourceIds')]"
                                          },
                                          "customNetworkInterfaceName": {
                                            "value": "[tryGet(coalesce(parameters('privateEndpoints'), createArray())[copyIndex()], 'customNetworkInterfaceName')]"
                                          }
                                        },
                                        "template": {
                                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                          "languageVersion": "2.0",
                                          "contentVersion": "1.0.0.0",
                                          "metadata": {
                                            "_generator": {
                                              "name": "bicep",
                                              "version": "0.38.5.1644",
                                              "templateHash": "16604612898799598358"
                                            },
                                            "name": "Private Endpoints",
                                            "description": "This module deploys a Private Endpoint."
                                          },
                                          "definitions": {
                                            "privateDnsZoneGroupType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the Private DNS Zone Group."
                                                  }
                                                },
                                                "privateDnsZoneGroupConfigs": {
                                                  "type": "array",
                                                  "items": {
                                                    "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                  },
                                                  "metadata": {
                                                    "description": "Required. The private DNS zone groups to associate the private endpoint. A DNS zone group can support up to 5 DNS zones."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "__bicep_export!": true,
                                                "description": "The type of a private dns zone group."
                                              }
                                            },
                                            "lockType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the name of lock."
                                                  }
                                                },
                                                "kind": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "CanNotDelete",
                                                    "None",
                                                    "ReadOnly"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the type of lock."
                                                  }
                                                },
                                                "notes": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Specify the notes of the lock."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a lock.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            },
                                            "privateDnsZoneGroupConfigType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name of the private DNS zone group config."
                                                  }
                                                },
                                                "privateDnsZoneResourceId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The resource id of the private DNS zone."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "The type of a private DNS zone group configuration.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "private-dns-zone-group/main.bicep"
                                                }
                                              }
                                            },
                                            "roleAssignmentType": {
                                              "type": "object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The name (as GUID) of the role assignment. If not provided, a GUID will be generated."
                                                  }
                                                },
                                                "roleDefinitionIdOrName": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The role to assign. You can provide either the display name of the role definition, the role definition GUID, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
                                                  }
                                                },
                                                "principalId": {
                                                  "type": "string",
                                                  "metadata": {
                                                    "description": "Required. The principal ID of the principal (user/group/identity) to assign the role to."
                                                  }
                                                },
                                                "principalType": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "Device",
                                                    "ForeignGroup",
                                                    "Group",
                                                    "ServicePrincipal",
                                                    "User"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The principal type of the assigned principal ID."
                                                  }
                                                },
                                                "description": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The description of the role assignment."
                                                  }
                                                },
                                                "condition": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The conditions on the role assignment. This limits the resources it can be assigned to. e.g.: @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:ContainerName] StringEqualsIgnoreCase \"foo_storage_container\"."
                                                  }
                                                },
                                                "conditionVersion": {
                                                  "type": "string",
                                                  "allowedValues": [
                                                    "2.0"
                                                  ],
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. Version of the condition."
                                                  }
                                                },
                                                "delegatedManagedIdentityResourceId": {
                                                  "type": "string",
                                                  "nullable": true,
                                                  "metadata": {
                                                    "description": "Optional. The Resource Id of the delegated managed identity resource."
                                                  }
                                                }
                                              },
                                              "metadata": {
                                                "description": "An AVM-aligned type for a role assignment.",
                                                "__bicep_imported_from!": {
                                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                                }
                                              }
                                            }
                                          },
                                          "parameters": {
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Name of the private endpoint resource to create."
                                              }
                                            },
                                            "subnetResourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "Required. Resource ID of the subnet where the endpoint needs to be created."
                                              }
                                            },
                                            "applicationSecurityGroupResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Application security groups in which the private endpoint IP configuration is included."
                                              }
                                            },
                                            "customNetworkInterfaceName": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The custom name of the network interface attached to the private endpoint."
                                              }
                                            },
                                            "ipConfigurations": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/ipConfigurations"
                                                },
                                                "description": "Optional. A list of IP configurations of the private endpoint. This will be used to map to the First Party Service endpoints."
                                              },
                                              "nullable": true
                                            },
                                            "privateDnsZoneGroup": {
                                              "$ref": "#/definitions/privateDnsZoneGroupType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The private DNS zone group to configure for the private endpoint."
                                              }
                                            },
                                            "location": {
                                              "type": "string",
                                              "defaultValue": "[resourceGroup().location]",
                                              "metadata": {
                                                "description": "Optional. Location for all Resources."
                                              }
                                            },
                                            "lock": {
                                              "$ref": "#/definitions/lockType",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. The lock settings of the service."
                                              }
                                            },
                                            "roleAssignments": {
                                              "type": "array",
                                              "items": {
                                                "$ref": "#/definitions/roleAssignmentType"
                                              },
                                              "nullable": true,
                                              "metadata": {
                                                "description": "Optional. Array of role assignments to create."
                                              }
                                            },
                                            "tags": {
                                              "type": "object",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/tags"
                                                },
                                                "description": "Optional. Tags to be applied on all resources/resource groups in this deployment."
                                              },
                                              "nullable": true
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/customDnsConfigs"
                                                },
                                                "description": "Optional. Custom DNS configurations."
                                              },
                                              "nullable": true
                                            },
                                            "manualPrivateLinkServiceConnections": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/manualPrivateLinkServiceConnections"
                                                },
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Used when the network admin does not have access to approve connections to the remote resource. Required if `privateLinkServiceConnections` is empty."
                                              },
                                              "nullable": true
                                            },
                                            "privateLinkServiceConnections": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/privateLinkServiceConnections"
                                                },
                                                "description": "Conditional. A grouping of information about the connection to the remote resource. Required if `manualPrivateLinkServiceConnections` is empty."
                                              },
                                              "nullable": true
                                            },
                                            "enableTelemetry": {
                                              "type": "bool",
                                              "defaultValue": true,
                                              "metadata": {
                                                "description": "Optional. Enable/Disable usage telemetry for module."
                                              }
                                            }
                                          },
                                          "variables": {
                                            "copy": [
                                              {
                                                "name": "formattedRoleAssignments",
                                                "count": "[length(coalesce(parameters('roleAssignments'), createArray()))]",
                                                "input": "[union(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')], createObject('roleDefinitionId', coalesce(tryGet(variables('builtInRoleNames'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName), if(contains(coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, '/providers/Microsoft.Authorization/roleDefinitions/'), coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName, subscriptionResourceId('Microsoft.Authorization/roleDefinitions', coalesce(parameters('roleAssignments'), createArray())[copyIndex('formattedRoleAssignments')].roleDefinitionIdOrName)))))]"
                                              }
                                            ],
                                            "builtInRoleNames": {
                                              "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                              "DNS Resolver Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0f2ebee7-ffd4-4fc0-b3b7-664099fdad5d')]",
                                              "DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'befefa01-2a29-4197-83a8-272ff33ce314')]",
                                              "Domain Services Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'eeaeda52-9324-47f6-8069-5d5bade478b2')]",
                                              "Domain Services Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '361898ef-9ed1-48c2-849c-a832951106bb')]",
                                              "Network Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                                              "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                                              "Private DNS Zone Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b12aa53e-6015-4669-85d0-8515ebb3ae7f')]",
                                              "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                                              "Role Based Access Control Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f58310d9-a9f6-439a-9e8d-f62e7b41a168')]"
                                            }
                                          },
                                          "resources": {
                                            "avmTelemetry": {
                                              "condition": "[parameters('enableTelemetry')]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('46d3xbcp.res.network-privateendpoint.{0}.{1}', replace('0.11.1', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
                                              "properties": {
                                                "mode": "Incremental",
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "contentVersion": "1.0.0.0",
                                                  "resources": [],
                                                  "outputs": {
                                                    "telemetry": {
                                                      "type": "String",
                                                      "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
                                                    }
                                                  }
                                                }
                                              }
                                            },
                                            "privateEndpoint": {
                                              "type": "Microsoft.Network/privateEndpoints",
                                              "apiVersion": "2024-10-01",
                                              "name": "[parameters('name')]",
                                              "location": "[parameters('location')]",
                                              "tags": "[parameters('tags')]",
                                              "properties": {
                                                "copy": [
                                                  {
                                                    "name": "applicationSecurityGroups",
                                                    "count": "[length(coalesce(parameters('applicationSecurityGroupResourceIds'), createArray()))]",
                                                    "input": {
                                                      "id": "[coalesce(parameters('applicationSecurityGroupResourceIds'), createArray())[copyIndex('applicationSecurityGroups')]]"
                                                    }
                                                  }
                                                ],
                                                "customDnsConfigs": "[coalesce(parameters('customDnsConfigs'), createArray())]",
                                                "customNetworkInterfaceName": "[coalesce(parameters('customNetworkInterfaceName'), '')]",
                                                "ipConfigurations": "[coalesce(parameters('ipConfigurations'), createArray())]",
                                                "manualPrivateLinkServiceConnections": "[coalesce(parameters('manualPrivateLinkServiceConnections'), createArray())]",
                                                "privateLinkServiceConnections": "[coalesce(parameters('privateLinkServiceConnections'), createArray())]",
                                                "subnet": {
                                                  "id": "[parameters('subnetResourceId')]"
                                                }
                                              }
                                            },
                                            "privateEndpoint_lock": {
                                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                                              "type": "Microsoft.Authorization/locks",
                                              "apiVersion": "2020-05-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                                              "properties": {
                                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                                "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_roleAssignments": {
                                              "copy": {
                                                "name": "privateEndpoint_roleAssignments",
                                                "count": "[length(coalesce(variables('formattedRoleAssignments'), createArray()))]"
                                              },
                                              "type": "Microsoft.Authorization/roleAssignments",
                                              "apiVersion": "2022-04-01",
                                              "scope": "[format('Microsoft.Network/privateEndpoints/{0}', parameters('name'))]",
                                              "name": "[coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'name'), guid(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId, coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId))]",
                                              "properties": {
                                                "roleDefinitionId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].roleDefinitionId]",
                                                "principalId": "[coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()].principalId]",
                                                "description": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'description')]",
                                                "principalType": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'principalType')]",
                                                "condition": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition')]",
                                                "conditionVersion": "[if(not(empty(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'condition'))), coalesce(tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'conditionVersion'), '2.0'), null())]",
                                                "delegatedManagedIdentityResourceId": "[tryGet(coalesce(variables('formattedRoleAssignments'), createArray())[copyIndex()], 'delegatedManagedIdentityResourceId')]"
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            },
                                            "privateEndpoint_privateDnsZoneGroup": {
                                              "condition": "[not(empty(parameters('privateDnsZoneGroup')))]",
                                              "type": "Microsoft.Resources/deployments",
                                              "apiVersion": "2025-04-01",
                                              "name": "[format('{0}-PrivateEndpoint-PrivateDnsZoneGroup', uniqueString(deployment().name))]",
                                              "properties": {
                                                "expressionEvaluationOptions": {
                                                  "scope": "inner"
                                                },
                                                "mode": "Incremental",
                                                "parameters": {
                                                  "name": {
                                                    "value": "[tryGet(parameters('privateDnsZoneGroup'), 'name')]"
                                                  },
                                                  "privateEndpointName": {
                                                    "value": "[parameters('name')]"
                                                  },
                                                  "privateDnsZoneConfigs": {
                                                    "value": "[parameters('privateDnsZoneGroup').privateDnsZoneGroupConfigs]"
                                                  }
                                                },
                                                "template": {
                                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                                  "languageVersion": "2.0",
                                                  "contentVersion": "1.0.0.0",
                                                  "metadata": {
                                                    "_generator": {
                                                      "name": "bicep",
                                                      "version": "0.38.5.1644",
                                                      "templateHash": "24141742673128945"
                                                    },
                                                    "name": "Private Endpoint Private DNS Zone Groups",
                                                    "description": "This module deploys a Private Endpoint Private DNS Zone Group."
                                                  },
                                                  "definitions": {
                                                    "privateDnsZoneGroupConfigType": {
                                                      "type": "object",
                                                      "properties": {
                                                        "name": {
                                                          "type": "string",
                                                          "nullable": true,
                                                          "metadata": {
                                                            "description": "Optional. The name of the private DNS zone group config."
                                                          }
                                                        },
                                                        "privateDnsZoneResourceId": {
                                                          "type": "string",
                                                          "metadata": {
                                                            "description": "Required. The resource id of the private DNS zone."
                                                          }
                                                        }
                                                      },
                                                      "metadata": {
                                                        "__bicep_export!": true,
                                                        "description": "The type of a private DNS zone group configuration."
                                                      }
                                                    }
                                                  },
                                                  "parameters": {
                                                    "privateEndpointName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "Conditional. The name of the parent private endpoint. Required if the template is used in a standalone deployment."
                                                      }
                                                    },
                                                    "privateDnsZoneConfigs": {
                                                      "type": "array",
                                                      "items": {
                                                        "$ref": "#/definitions/privateDnsZoneGroupConfigType"
                                                      },
                                                      "minLength": 1,
                                                      "maxLength": 5,
                                                      "metadata": {
                                                        "description": "Required. Array of private DNS zone configurations of the private DNS zone group. A DNS zone group can support up to 5 DNS zones."
                                                      }
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "defaultValue": "default",
                                                      "metadata": {
                                                        "description": "Optional. The name of the private DNS zone group."
                                                      }
                                                    }
                                                  },
                                                  "resources": {
                                                    "privateEndpoint": {
                                                      "existing": true,
                                                      "type": "Microsoft.Network/privateEndpoints",
                                                      "apiVersion": "2024-10-01",
                                                      "name": "[parameters('privateEndpointName')]"
                                                    },
                                                    "privateDnsZoneGroup": {
                                                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                                      "apiVersion": "2024-10-01",
                                                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), parameters('name'))]",
                                                      "properties": {
                                                        "copy": [
                                                          {
                                                            "name": "privateDnsZoneConfigs",
                                                            "count": "[length(parameters('privateDnsZoneConfigs'))]",
                                                            "input": {
                                                              "name": "[coalesce(tryGet(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigs')], 'name'), last(split(parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigs')].privateDnsZoneResourceId, '/')))]",
                                                              "properties": {
                                                                "privateDnsZoneId": "[parameters('privateDnsZoneConfigs')[copyIndex('privateDnsZoneConfigs')].privateDnsZoneResourceId]"
                                                              }
                                                            }
                                                          }
                                                        ]
                                                      }
                                                    }
                                                  },
                                                  "outputs": {
                                                    "name": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The name of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[parameters('name')]"
                                                    },
                                                    "resourceId": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource ID of the private endpoint DNS zone group."
                                                      },
                                                      "value": "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', parameters('privateEndpointName'), parameters('name'))]"
                                                    },
                                                    "resourceGroupName": {
                                                      "type": "string",
                                                      "metadata": {
                                                        "description": "The resource group the private endpoint DNS zone group was deployed into."
                                                      },
                                                      "value": "[resourceGroup().name]"
                                                    }
                                                  }
                                                }
                                              },
                                              "dependsOn": [
                                                "privateEndpoint"
                                              ]
                                            }
                                          },
                                          "outputs": {
                                            "resourceGroupName": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource group the private endpoint was deployed into."
                                              },
                                              "value": "[resourceGroup().name]"
                                            },
                                            "resourceId": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The resource ID of the private endpoint."
                                              },
                                              "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                                            },
                                            "name": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The name of the private endpoint."
                                              },
                                              "value": "[parameters('name')]"
                                            },
                                            "location": {
                                              "type": "string",
                                              "metadata": {
                                                "description": "The location the resource was deployed into."
                                              },
                                              "value": "[reference('privateEndpoint', '2024-10-01', 'full').location]"
                                            },
                                            "customDnsConfigs": {
                                              "type": "array",
                                              "metadata": {
                                                "__bicep_resource_derived_type!": {
                                                  "source": "Microsoft.Network/privateEndpoints@2024-01-01#properties/properties/properties/customDnsConfigs",
                                                  "output": true
                                                },
                                                "description": "The custom DNS configurations of the private endpoint."
                                              },
                                              "value": "[reference('privateEndpoint').customDnsConfigs]"
                                            },
                                            "networkInterfaceResourceIds": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "metadata": {
                                                "description": "The resource IDs of the network interfaces associated with the private endpoint."
                                              },
                                              "value": "[map(reference('privateEndpoint').networkInterfaces, lambda('nic', lambdaVariables('nic').id))]"
                                            },
                                            "groupId": {
                                              "type": "string",
                                              "nullable": true,
                                              "metadata": {
                                                "description": "The group Id for the private endpoint Group."
                                              },
                                              "value": "[coalesce(tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'manualPrivateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0), tryGet(tryGet(tryGet(tryGet(reference('privateEndpoint'), 'privateLinkServiceConnections'), 0, 'properties'), 'groupIds'), 0))]"
                                            }
                                          }
                                        }
                                      },
                                      "dependsOn": [
                                        "databaseAccount"
                                      ]
                                    }
                                  },
                                  "outputs": {
                                    "name": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the database account."
                                      },
                                      "value": "[parameters('name')]"
                                    },
                                    "resourceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The resource ID of the database account."
                                      },
                                      "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
                                    },
                                    "resourceGroupName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The name of the resource group the database account was created in."
                                      },
                                      "value": "[resourceGroup().name]"
                                    },
                                    "systemAssignedMIPrincipalId": {
                                      "type": "string",
                                      "nullable": true,
                                      "metadata": {
                                        "description": "The principal ID of the system assigned identity."
                                      },
                                      "value": "[tryGet(tryGet(reference('databaseAccount', '2025-04-15', 'full'), 'identity'), 'principalId')]"
                                    },
                                    "location": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The location the resource was deployed into."
                                      },
                                      "value": "[reference('databaseAccount', '2025-04-15', 'full').location]"
                                    },
                                    "endpoint": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "The endpoint of the database account."
                                      },
                                      "value": "[reference('databaseAccount').documentEndpoint]"
                                    },
                                    "privateEndpoints": {
                                      "type": "array",
                                      "items": {
                                        "$ref": "#/definitions/privateEndpointOutputType"
                                      },
                                      "metadata": {
                                        "description": "The private endpoints of the database account."
                                      },
                                      "copy": {
                                        "count": "[length(coalesce(parameters('privateEndpoints'), createArray()))]",
                                        "input": {
                                          "name": "[reference(format('databaseAccount_privateEndpoints[{0}]', copyIndex())).outputs.name.value]",
                                          "resourceId": "[reference(format('databaseAccount_privateEndpoints[{0}]', copyIndex())).outputs.resourceId.value]",
                                          "groupId": "[tryGet(tryGet(reference(format('databaseAccount_privateEndpoints[{0}]', copyIndex())).outputs, 'groupId'), 'value')]",
                                          "customDnsConfigs": "[reference(format('databaseAccount_privateEndpoints[{0}]', copyIndex())).outputs.customDnsConfigs.value]",
                                          "networkInterfaceResourceIds": "[reference(format('databaseAccount_privateEndpoints[{0}]', copyIndex())).outputs.networkInterfaceResourceIds.value]"
                                        }
                                      }
                                    },
                                    "primaryReadWriteKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The primary read-write key."
                                      },
                                      "value": "[listKeys('databaseAccount', '2025-04-15').primaryMasterKey]"
                                    },
                                    "primaryReadOnlyKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The primary read-only key."
                                      },
                                      "value": "[listKeys('databaseAccount', '2025-04-15').primaryReadonlyMasterKey]"
                                    },
                                    "primaryReadWriteConnectionString": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The primary read-write connection string."
                                      },
                                      "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[0].connectionString]"
                                    },
                                    "primaryReadOnlyConnectionString": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The primary read-only connection string."
                                      },
                                      "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[2].connectionString]"
                                    },
                                    "secondaryReadWriteKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The secondary read-write key."
                                      },
                                      "value": "[listKeys('databaseAccount', '2025-04-15').secondaryMasterKey]"
                                    },
                                    "secondaryReadOnlyKey": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The secondary read-only key."
                                      },
                                      "value": "[listKeys('databaseAccount', '2025-04-15').secondaryReadonlyMasterKey]"
                                    },
                                    "secondaryReadWriteConnectionString": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The secondary read-write connection string."
                                      },
                                      "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[1].connectionString]"
                                    },
                                    "secondaryReadOnlyConnectionString": {
                                      "type": "securestring",
                                      "metadata": {
                                        "description": "The secondary read-only connection string."
                                      },
                                      "value": "[listConnectionStrings('databaseAccount', '2025-04-15').connectionStrings[3].connectionString]"
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "outputs": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Name of the Cosmos DB."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('cosmosDb').outputs.name.value, variables('existingName'))]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource ID of the Cosmos DB."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), reference('cosmosDb').outputs.resourceId.value, extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('existingSubscriptionId'), variables('existingResourceGroupName')), 'Microsoft.DocumentDB/databaseAccounts', variables('existingName')))]"
                            },
                            "subscriptionId": {
                              "type": "string",
                              "metadata": {
                                "description": "Subscription ID of the Cosmos DB."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), subscription().subscriptionId, variables('existingSubscriptionId'))]"
                            },
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource Group Name of the Cosmos DB."
                              },
                              "value": "[if(empty(parameters('existingResourceId')), resourceGroup().name, variables('existingResourceGroupName'))]"
                            }
                          }
                        }
                      }
                    },
                    "foundryProject": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[take(format('module.project.main.{0}', variables('projectName')), 64)]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": {
                            "value": "[variables('projectName')]"
                          },
                          "desc": "[if(not(empty(tryGet(tryGet(parameters('aiFoundryConfiguration'), 'project'), 'desc'))), createObject('value', parameters('aiFoundryConfiguration').project.desc), createObject('value', 'This is the default project for AI Foundry.'))]",
                          "displayName": "[if(not(empty(tryGet(tryGet(parameters('aiFoundryConfiguration'), 'project'), 'displayName'))), createObject('value', parameters('aiFoundryConfiguration').project.displayName), createObject('value', format('{0} Default Project', parameters('baseName'))))]",
                          "accountName": {
                            "value": "[reference('foundryAccount').outputs.name.value]"
                          },
                          "location": {
                            "value": "[reference('foundryAccount').outputs.location.value]"
                          },
                          "createAccountCapabilityHost": {
                            "value": "[and(variables('createCapabilityHosts'), empty(tryGet(tryGet(parameters('aiFoundryConfiguration'), 'networking'), 'agentServiceSubnetResourceId')))]"
                          },
                          "createProjectCapabilityHost": {
                            "value": "[variables('createCapabilityHosts')]"
                          },
                          "storageAccountConnection": "[if(parameters('includeAssociatedResources'), createObject('value', createObject('resourceName', reference('storageAccount').outputs.name.value, 'subscriptionId', reference('storageAccount').outputs.subscriptionId.value, 'resourceGroupName', reference('storageAccount').outputs.resourceGroupName.value)), createObject('value', null()))]",
                          "aiSearchConnection": "[if(parameters('includeAssociatedResources'), createObject('value', createObject('resourceName', reference('aiSearch').outputs.name.value, 'subscriptionId', reference('aiSearch').outputs.subscriptionId.value, 'resourceGroupName', reference('aiSearch').outputs.resourceGroupName.value)), createObject('value', null()))]",
                          "cosmosDbConnection": "[if(parameters('includeAssociatedResources'), createObject('value', createObject('resourceName', reference('cosmosDb').outputs.name.value, 'subscriptionId', reference('cosmosDb').outputs.subscriptionId.value, 'resourceGroupName', reference('cosmosDb').outputs.resourceGroupName.value)), createObject('value', null()))]",
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "lock": {
                            "value": "[parameters('lock')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "languageVersion": "2.0",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "4456142376294516992"
                            },
                            "name": "AI Foundry Project",
                            "description": "Creates an AI Foundry project and any associated Azure service connections."
                          },
                          "definitions": {
                            "azureConnectionType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. The name of the project connection. Will default to the resource name if not provided."
                                  }
                                },
                                "resourceName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The resource name of the Azure resource for the connection."
                                  }
                                },
                                "subscriptionId": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The subscription ID of the resource."
                                  }
                                },
                                "resourceGroupName": {
                                  "type": "string",
                                  "metadata": {
                                    "description": "Required. The resource group name of the resource."
                                  }
                                }
                              },
                              "metadata": {
                                "__bicep_export!": true,
                                "description": "Type representing values to create an Azure connection to an AI Foundry project."
                              }
                            },
                            "lockType": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the name of lock."
                                  }
                                },
                                "kind": {
                                  "type": "string",
                                  "allowedValues": [
                                    "CanNotDelete",
                                    "None",
                                    "ReadOnly"
                                  ],
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the type of lock."
                                  }
                                },
                                "notes": {
                                  "type": "string",
                                  "nullable": true,
                                  "metadata": {
                                    "description": "Optional. Specify the notes of the lock."
                                  }
                                }
                              },
                              "metadata": {
                                "description": "An AVM-aligned type for a lock.",
                                "__bicep_imported_from!": {
                                  "sourceTemplate": "br:mcr.microsoft.com/bicep/avm/utl/types/avm-common-types:0.6.1"
                                }
                              }
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "minLength": 2,
                              "maxLength": 64,
                              "metadata": {
                                "description": "Required. The name of the AI Foundry project."
                              }
                            },
                            "displayName": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The display name of the AI Foundry project."
                              }
                            },
                            "desc": {
                              "type": "string",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The description of the AI Foundry project."
                              }
                            },
                            "location": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().location]",
                              "metadata": {
                                "description": "Optional. Specifies the location for all the Azure resources."
                              }
                            },
                            "accountName": {
                              "type": "string",
                              "metadata": {
                                "description": "Required. Name of the existing parent Foundry Account resource."
                              }
                            },
                            "createAccountCapabilityHost": {
                              "type": "bool",
                              "metadata": {
                                "description": "Required. Whether to create the capability host for the Foundry account. Requires associated resource connections to be provided."
                              }
                            },
                            "createProjectCapabilityHost": {
                              "type": "bool",
                              "metadata": {
                                "description": "Required. Whether to create the capability host for the Foundry project. Requires associated resource connections to be provided."
                              }
                            },
                            "cosmosDbConnection": {
                              "$ref": "#/definitions/azureConnectionType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Azure Cosmos DB connection for the project."
                              }
                            },
                            "aiSearchConnection": {
                              "$ref": "#/definitions/azureConnectionType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Azure Cognitive Search connection for the project."
                              }
                            },
                            "storageAccountConnection": {
                              "$ref": "#/definitions/azureConnectionType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. Storage Account connection for the project."
                              }
                            },
                            "lock": {
                              "$ref": "#/definitions/lockType",
                              "nullable": true,
                              "metadata": {
                                "description": "Optional. The lock settings of the service."
                              }
                            },
                            "tags": {
                              "type": "object",
                              "metadata": {
                                "__bicep_resource_derived_type!": {
                                  "source": "Microsoft.Resources/resourceGroups@2025-04-01#properties/tags"
                                },
                                "description": "Optional. Tags to be applied to the resources."
                              },
                              "defaultValue": {}
                            }
                          },
                          "variables": {
                            "createProjectCapabilityHostInternal": "[and(and(and(parameters('createProjectCapabilityHost'), not(empty(parameters('cosmosDbConnection')))), not(empty(parameters('aiSearchConnection')))), not(empty(parameters('storageAccountConnection'))))]",
                            "createAccountCapabilityHostInternal": "[and(and(and(parameters('createAccountCapabilityHost'), not(empty(parameters('cosmosDbConnection')))), not(empty(parameters('aiSearchConnection')))), not(empty(parameters('storageAccountConnection'))))]"
                          },
                          "resources": {
                            "foundryAccount": {
                              "existing": true,
                              "type": "Microsoft.CognitiveServices/accounts",
                              "apiVersion": "2025-06-01",
                              "name": "[parameters('accountName')]"
                            },
                            "storageAccount": {
                              "condition": "[not(empty(parameters('storageAccountConnection')))]",
                              "existing": true,
                              "type": "Microsoft.Storage/storageAccounts",
                              "apiVersion": "2025-01-01",
                              "subscriptionId": "[parameters('storageAccountConnection').subscriptionId]",
                              "resourceGroup": "[parameters('storageAccountConnection').resourceGroupName]",
                              "name": "[parameters('storageAccountConnection').resourceName]"
                            },
                            "aiSearch": {
                              "condition": "[not(empty(parameters('aiSearchConnection')))]",
                              "existing": true,
                              "type": "Microsoft.Search/searchServices",
                              "apiVersion": "2025-05-01",
                              "subscriptionId": "[parameters('aiSearchConnection').subscriptionId]",
                              "resourceGroup": "[parameters('aiSearchConnection').resourceGroupName]",
                              "name": "[parameters('aiSearchConnection').resourceName]"
                            },
                            "cosmosDb": {
                              "condition": "[not(empty(parameters('cosmosDbConnection')))]",
                              "existing": true,
                              "type": "Microsoft.DocumentDB/databaseAccounts",
                              "apiVersion": "2025-04-15",
                              "subscriptionId": "[parameters('cosmosDbConnection').subscriptionId]",
                              "resourceGroup": "[parameters('cosmosDbConnection').resourceGroupName]",
                              "name": "[parameters('cosmosDbConnection').resourceName]"
                            },
                            "project": {
                              "type": "Microsoft.CognitiveServices/accounts/projects",
                              "apiVersion": "2025-07-01-preview",
                              "name": "[format('{0}/{1}', parameters('accountName'), parameters('name'))]",
                              "location": "[parameters('location')]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "displayName": "[if(not(empty(parameters('displayName'))), parameters('displayName'), parameters('name'))]",
                                "description": "[if(not(empty(parameters('desc'))), parameters('desc'), parameters('name'))]"
                              },
                              "tags": "[parameters('tags')]"
                            },
                            "cosmosDbConnectionResource": {
                              "condition": "[not(empty(parameters('cosmosDbConnection')))]",
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-07-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('name'), parameters('cosmosDbConnection').resourceName)]",
                              "properties": {
                                "category": "CosmosDB",
                                "target": "[reference('cosmosDb').documentEndpoint]",
                                "authType": "AAD",
                                "metadata": {
                                  "ApiType": "Azure",
                                  "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('cosmosDbConnection').subscriptionId, parameters('cosmosDbConnection').resourceGroupName), 'Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbConnection').resourceName)]",
                                  "location": "[reference('cosmosDb', '2025-04-15', 'full').location]"
                                }
                              },
                              "dependsOn": [
                                "cosmosDb",
                                "cosmosDbRoleAssignments",
                                "project"
                              ]
                            },
                            "storageAccountConnectionResource": {
                              "condition": "[not(empty(parameters('storageAccountConnection')))]",
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-07-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('name'), parameters('storageAccountConnection').resourceName)]",
                              "properties": {
                                "category": "AzureStorageAccount",
                                "target": "[reference('storageAccount').primaryEndpoints.blob]",
                                "authType": "AAD",
                                "metadata": {
                                  "ApiType": "Azure",
                                  "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('storageAccountConnection').subscriptionId, parameters('storageAccountConnection').resourceGroupName), 'Microsoft.Storage/storageAccounts', parameters('storageAccountConnection').resourceName)]",
                                  "location": "[reference('storageAccount', '2025-01-01', 'full').location]"
                                }
                              },
                              "dependsOn": [
                                "cosmosDbConnectionResource",
                                "project",
                                "storageAccount",
                                "storageAccountRoleAssignments"
                              ]
                            },
                            "aiSearchConnectionResource": {
                              "condition": "[not(empty(parameters('aiSearchConnection')))]",
                              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                              "apiVersion": "2025-07-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('name'), parameters('aiSearchConnection').resourceName)]",
                              "properties": {
                                "category": "CognitiveSearch",
                                "target": "[format('https://{0}.search.windows.net/', parameters('aiSearchConnection').resourceName)]",
                                "authType": "AAD",
                                "metadata": {
                                  "ApiType": "Azure",
                                  "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('aiSearchConnection').subscriptionId, parameters('aiSearchConnection').resourceGroupName), 'Microsoft.Search/searchServices', parameters('aiSearchConnection').resourceName)]",
                                  "location": "[reference('aiSearch', '2025-05-01', 'full').location]"
                                }
                              },
                              "dependsOn": [
                                "aiSearch",
                                "aiSearchRoleAssignments",
                                "cosmosDbConnectionResource",
                                "project",
                                "storageAccountConnectionResource"
                              ]
                            },
                            "accountCapabilityHost": {
                              "condition": "[variables('createAccountCapabilityHostInternal')]",
                              "type": "Microsoft.CognitiveServices/accounts/capabilityHosts",
                              "apiVersion": "2025-07-01-preview",
                              "name": "[format('{0}/{1}', parameters('accountName'), format('chagent{0}', replace(parameters('accountName'), '-', '')))]",
                              "properties": {
                                "capabilityHostKind": "Agents",
                                "tags": "[parameters('tags')]"
                              },
                              "dependsOn": [
                                "aiSearchConnectionResource",
                                "cosmosDbConnectionResource",
                                "project",
                                "storageAccountConnectionResource"
                              ]
                            },
                            "capabilityHost": {
                              "condition": "[variables('createProjectCapabilityHostInternal')]",
                              "type": "Microsoft.CognitiveServices/accounts/projects/capabilityHosts",
                              "apiVersion": "2025-07-01-preview",
                              "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('name'), format('chagent{0}', replace(parameters('name'), '-', '')))]",
                              "properties": {
                                "capabilityHostKind": "Agents",
                                "threadStorageConnections": [
                                  "[format('{0}', parameters('cosmosDbConnection').resourceName)]"
                                ],
                                "vectorStoreConnections": [
                                  "[format('{0}', parameters('aiSearchConnection').resourceName)]"
                                ],
                                "storageConnections": [
                                  "[format('{0}', parameters('storageAccountConnection').resourceName)]"
                                ],
                                "tags": "[parameters('tags')]"
                              },
                              "dependsOn": [
                                "accountCapabilityHost",
                                "aiSearchConnectionResource",
                                "cosmosDbConnectionResource",
                                "project",
                                "storageAccountConnectionResource"
                              ]
                            },
                            "projectLock": {
                              "condition": "[and(not(empty(coalesce(parameters('lock'), createObject()))), not(equals(tryGet(parameters('lock'), 'kind'), 'None')))]",
                              "type": "Microsoft.Authorization/locks",
                              "apiVersion": "2020-05-01",
                              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}/projects/{1}', parameters('accountName'), parameters('name'))]",
                              "name": "[coalesce(tryGet(parameters('lock'), 'name'), format('lock-{0}', parameters('name')))]",
                              "properties": {
                                "level": "[coalesce(tryGet(parameters('lock'), 'kind'), '')]",
                                "notes": "[coalesce(tryGet(parameters('lock'), 'notes'), if(equals(tryGet(parameters('lock'), 'kind'), 'CanNotDelete'), 'Cannot delete resource or child resources.', 'Cannot delete or modify the resource or child resources.'))]"
                              },
                              "dependsOn": [
                                "capabilityHost",
                                "project"
                              ]
                            },
                            "cosmosDbRoleAssignments": {
                              "condition": "[not(empty(parameters('cosmosDbConnection')))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('module.project.role-assign.cosmosDb.{0}', parameters('name')), 64)]",
                              "subscriptionId": "[parameters('cosmosDbConnection').subscriptionId]",
                              "resourceGroup": "[parameters('cosmosDbConnection').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "cosmosDbName": {
                                    "value": "[parameters('cosmosDbConnection').resourceName]"
                                  },
                                  "projectIdentityPrincipalId": {
                                    "value": "[reference('project', '2025-07-01-preview', 'full').identity.principalId]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.38.33.27573",
                                      "templateHash": "2297586848184477491"
                                    }
                                  },
                                  "parameters": {
                                    "cosmosDbName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the Cosmos DB account."
                                      }
                                    },
                                    "projectIdentityPrincipalId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The principal ID of the project identity."
                                      }
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosDbName'))]",
                                      "name": "[guid(parameters('projectIdentityPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbName')))]",
                                      "properties": {
                                        "principalId": "[parameters('projectIdentityPrincipalId')]",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa')]",
                                        "principalType": "ServicePrincipal"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "project"
                              ]
                            },
                            "storageAccountRoleAssignments": {
                              "condition": "[not(empty(parameters('storageAccountConnection')))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('module.project.role-assign.storageAccount.{0}', parameters('name')), 64)]",
                              "subscriptionId": "[parameters('storageAccountConnection').subscriptionId]",
                              "resourceGroup": "[parameters('storageAccountConnection').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "storageAccountName": {
                                    "value": "[parameters('storageAccountConnection').resourceName]"
                                  },
                                  "projectIdentityPrincipalId": {
                                    "value": "[reference('project', '2025-07-01-preview', 'full').identity.principalId]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.38.33.27573",
                                      "templateHash": "16405095293780360423"
                                    }
                                  },
                                  "parameters": {
                                    "storageAccountName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the storage account."
                                      }
                                    },
                                    "projectIdentityPrincipalId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The principal ID of the project identity."
                                      }
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), parameters('storageAccountName'), parameters('projectIdentityPrincipalId'))]",
                                      "properties": {
                                        "principalId": "[parameters('projectIdentityPrincipalId')]",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                                        "principalType": "ServicePrincipal"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "project"
                              ]
                            },
                            "aiSearchRoleAssignments": {
                              "condition": "[not(empty(parameters('aiSearchConnection')))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('module.project.role-assign.aiSearch.{0}', parameters('name')), 64)]",
                              "subscriptionId": "[parameters('aiSearchConnection').subscriptionId]",
                              "resourceGroup": "[parameters('aiSearchConnection').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "aiSearchName": {
                                    "value": "[parameters('aiSearchConnection').resourceName]"
                                  },
                                  "projectIdentityPrincipalId": {
                                    "value": "[reference('project', '2025-07-01-preview', 'full').identity.principalId]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.38.33.27573",
                                      "templateHash": "16025941000331400340"
                                    }
                                  },
                                  "parameters": {
                                    "aiSearchName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the AI Search resource."
                                      }
                                    },
                                    "projectIdentityPrincipalId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The principal ID of the project identity."
                                      }
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                                      "name": "[guid(parameters('projectIdentityPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7'), resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')))]",
                                      "properties": {
                                        "principalId": "[parameters('projectIdentityPrincipalId')]",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                                        "principalType": "ServicePrincipal"
                                      }
                                    },
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                                      "name": "[guid(parameters('projectIdentityPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0'), resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')))]",
                                      "properties": {
                                        "principalId": "[parameters('projectIdentityPrincipalId')]",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0')]",
                                        "principalType": "ServicePrincipal"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "project"
                              ]
                            },
                            "cosmosDbSqlRoleAssignments": {
                              "condition": "[and(not(empty(parameters('cosmosDbConnection'))), variables('createProjectCapabilityHostInternal'))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('module.project.role-assign.cosmosDbDataPlane.{0}', parameters('name')), 64)]",
                              "subscriptionId": "[parameters('cosmosDbConnection').subscriptionId]",
                              "resourceGroup": "[parameters('cosmosDbConnection').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "cosmosDbName": {
                                    "value": "[parameters('cosmosDbConnection').resourceName]"
                                  },
                                  "projectIdentityPrincipalId": {
                                    "value": "[reference('project', '2025-07-01-preview', 'full').identity.principalId]"
                                  },
                                  "projectWorkspaceId": {
                                    "value": "[format('{0}-{1}-{2}-{3}-{4}', if(greaterOrEquals(length(reference('project').internalId), 8), substring(reference('project').internalId, 0, 8), ''), if(greaterOrEquals(length(reference('project').internalId), 12), substring(reference('project').internalId, 8, 4), ''), if(greaterOrEquals(length(reference('project').internalId), 16), substring(reference('project').internalId, 12, 4), ''), if(greaterOrEquals(length(reference('project').internalId), 20), substring(reference('project').internalId, 16, 4), ''), if(greaterOrEquals(length(reference('project').internalId), 32), substring(reference('project').internalId, 20, 12), ''))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.38.33.27573",
                                      "templateHash": "11649050309693252000"
                                    }
                                  },
                                  "parameters": {
                                    "cosmosDbName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the Cosmos DB account."
                                      }
                                    },
                                    "projectIdentityPrincipalId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The principal ID of the project identity."
                                      }
                                    },
                                    "projectWorkspaceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The project workspace ID."
                                      }
                                    }
                                  },
                                  "variables": {
                                    "cosmosContainerNameSuffixes": [
                                      "thread-message-store",
                                      "system-thread-message-store",
                                      "agent-entity-store"
                                    ],
                                    "cosmosDefaultSqlRoleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosDbName'), '00000000-0000-0000-0000-000000000002')]"
                                  },
                                  "resources": [
                                    {
                                      "copy": {
                                        "name": "cosmosDataRoleAssigment",
                                        "count": "[length(variables('cosmosContainerNameSuffixes'))]",
                                        "mode": "serial",
                                        "batchSize": 1
                                      },
                                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                                      "apiVersion": "2025-04-15",
                                      "name": "[format('{0}/{1}', parameters('cosmosDbName'), guid(variables('cosmosDefaultSqlRoleDefinitionId'), parameters('cosmosDbName'), variables('cosmosContainerNameSuffixes')[copyIndex()], parameters('projectIdentityPrincipalId')))]",
                                      "properties": {
                                        "principalId": "[parameters('projectIdentityPrincipalId')]",
                                        "roleDefinitionId": "[variables('cosmosDefaultSqlRoleDefinitionId')]",
                                        "scope": "[format('{0}/dbs/enterprise_memory/colls/{1}-{2}', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbName')), parameters('projectWorkspaceId'), variables('cosmosContainerNameSuffixes')[copyIndex()])]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "capabilityHost",
                                "cosmosDbRoleAssignments",
                                "project"
                              ]
                            },
                            "storageAccountContainerRoleAssignments": {
                              "condition": "[and(not(empty(parameters('storageAccountConnection'))), variables('createProjectCapabilityHostInternal'))]",
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[take(format('module.project.role-assign.storageAccountDataPlane.{0}', parameters('name')), 64)]",
                              "subscriptionId": "[parameters('storageAccountConnection').subscriptionId]",
                              "resourceGroup": "[parameters('storageAccountConnection').resourceGroupName]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "storageAccountName": {
                                    "value": "[parameters('storageAccountConnection').resourceName]"
                                  },
                                  "projectIdentityPrincipalId": {
                                    "value": "[reference('project', '2025-07-01-preview', 'full').identity.principalId]"
                                  },
                                  "projectWorkspaceId": {
                                    "value": "[format('{0}-{1}-{2}-{3}-{4}', if(greaterOrEquals(length(reference('project').internalId), 8), substring(reference('project').internalId, 0, 8), ''), if(greaterOrEquals(length(reference('project').internalId), 12), substring(reference('project').internalId, 8, 4), ''), if(greaterOrEquals(length(reference('project').internalId), 16), substring(reference('project').internalId, 12, 4), ''), if(greaterOrEquals(length(reference('project').internalId), 20), substring(reference('project').internalId, 16, 4), ''), if(greaterOrEquals(length(reference('project').internalId), 32), substring(reference('project').internalId, 20, 12), ''))]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.38.33.27573",
                                      "templateHash": "12109249428053532616"
                                    }
                                  },
                                  "parameters": {
                                    "storageAccountName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The name of the storage account."
                                      }
                                    },
                                    "projectIdentityPrincipalId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The principal ID of the project identity."
                                      }
                                    },
                                    "projectWorkspaceId": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Required. The project workspace ID."
                                      }
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2022-04-01",
                                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
                                      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b'), parameters('storageAccountName'), parameters('projectIdentityPrincipalId'))]",
                                      "properties": {
                                        "principalId": "[parameters('projectIdentityPrincipalId')]",
                                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                                        "principalType": "ServicePrincipal",
                                        "conditionVersion": "2.0",
                                        "condition": "[replace('      (\n        (\n          !(ActionMatches{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/read''})\n          AND  !(ActionMatches{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/filter/action''})\n          AND  !(ActionMatches{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/write''})\n        )\n        OR\n        (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringStartsWithIgnoreCase ''#projectWorkspaceId#''\n        AND @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringLikeIgnoreCase ''*-azureml-agent'')\n      )\n      ', '#projectWorkspaceId#', parameters('projectWorkspaceId'))]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "capabilityHost",
                                "cosmosDbSqlRoleAssignments",
                                "project",
                                "storageAccountRoleAssignments"
                              ]
                            }
                          },
                          "outputs": {
                            "resourceGroupName": {
                              "type": "string",
                              "metadata": {
                                "description": "Name of the deployed Azure Resource Group."
                              },
                              "value": "[resourceGroup().name]"
                            },
                            "resourceId": {
                              "type": "string",
                              "metadata": {
                                "description": "Resource ID of the Project."
                              },
                              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('accountName'), parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "Name of the Project."
                              },
                              "value": "[parameters('name')]"
                            },
                            "displayName": {
                              "type": "string",
                              "metadata": {
                                "description": "Display name of the Project."
                              },
                              "value": "[reference('project').displayName]"
                            },
                            "desc": {
                              "type": "string",
                              "metadata": {
                                "description": "Description of the Project."
                              },
                              "value": "[reference('project').description]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "aiSearch",
                        "cosmosDb",
                        "foundryAccount",
                        "keyVault",
                        "storageAccount"
                      ]
                    }
                  },
                  "outputs": {
                    "resourceGroupName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the deployed Azure Resource Group."
                      },
                      "value": "[resourceGroup().name]"
                    },
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the deployed Azure Key Vault."
                      },
                      "value": "[if(parameters('includeAssociatedResources'), reference('keyVault').outputs.name.value, '')]"
                    },
                    "aiServicesName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the deployed Azure AI Services account."
                      },
                      "value": "[reference('foundryAccount').outputs.name.value]"
                    },
                    "aiSearchName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the deployed Azure AI Search service."
                      },
                      "value": "[if(parameters('includeAssociatedResources'), reference('aiSearch').outputs.name.value, '')]"
                    },
                    "aiProjectName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the deployed Azure AI Project."
                      },
                      "value": "[reference('foundryProject').outputs.name.value]"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the deployed Azure Storage Account."
                      },
                      "value": "[if(parameters('includeAssociatedResources'), reference('storageAccount').outputs.name.value, '')]"
                    },
                    "cosmosAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the deployed Azure Cosmos DB account."
                      },
                      "value": "[if(parameters('includeAssociatedResources'), reference('cosmosDb').outputs.name.value, '')]"
                    }
                  }
                }
              }
            }
          },
          "outputs": {
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry resource group name."
              },
              "value": "[reference('inner').outputs.resourceGroupName.value]"
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry project name."
              },
              "value": "[reference('inner').outputs.aiProjectName.value]"
            },
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry AI Search service name."
              },
              "value": "[reference('inner').outputs.aiSearchName.value]"
            },
            "aiServicesName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry AI Services name."
              },
              "value": "[reference('inner').outputs.aiServicesName.value]"
            },
            "cosmosAccountName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry Cosmos DB account name."
              },
              "value": "[reference('inner').outputs.cosmosAccountName.value]"
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry Key Vault name."
              },
              "value": "[reference('inner').outputs.keyVaultName.value]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry Storage Account name."
              },
              "value": "[reference('inner').outputs.storageAccountName.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-roleBuilder-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value))]",
          "location": {
            "value": "[parameters('location')]"
          },
          "storageName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiFoundryV2Name": "[if(parameters('foundryV22AccountOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value), if(variables('deployAvmFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiServicesName.value), if(parameters('aiFoundryV2Exists'), createObject('value', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value))))]",
          "aiSearchName": "[if(parameters('enableAISearch'), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', '')), createObject('value', ''))]",
          "cosmosDBname": "[if(variables('useCosmosForFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value), createObject('value', ''))]",
          "enablePublicAccessWithPerimeter": {
            "value": "[parameters('enablePublicAccessWithPerimeter')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "9587761100287127921"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "minLength": 3,
              "maxLength": 12,
              "metadata": {
                "description": "The name of the environment. Use alphanumeric characters only."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Specifies the location for all the Azure resources. Defaults to the location of the resource group."
              }
            },
            "cosmosDBname": {
              "type": "string",
              "metadata": {
                "description": "Name of the customers existing CosmosDB Resource"
              }
            },
            "storageName": {
              "type": "string",
              "metadata": {
                "description": "Name of the customers existing Azure Storage Account"
              }
            },
            "storageName2": {
              "type": "string"
            },
            "aiFoundryV2Name": {
              "type": "string",
              "metadata": {
                "description": "Foundry Account Name"
              }
            },
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "Azure Search Service Name"
              }
            },
            "enablePublicAccessWithPerimeter": {
              "type": "bool",
              "defaultValue": false
            },
            "defaultProjectName": {
              "type": "string",
              "defaultValue": "[parameters('name')]",
              "metadata": {
                "description": "Name of the first project"
              }
            },
            "defaultProjectDisplayName": {
              "type": "string",
              "defaultValue": "[parameters('name')]"
            },
            "defaultProjectDescription": {
              "type": "string",
              "defaultValue": "AI Factory created this default project for AI Foundry with enterprise grade security and your corp networking."
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "displayName": "[parameters('defaultProjectDisplayName')]",
                "description": "[parameters('defaultProjectDescription')]"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName'))]",
              "properties": {
                "category": "AzureStorageAccount",
                "target": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), '2023-01-01').primaryEndpoints.blob]",
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "authType": "AAD",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]",
                  "location": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), '2023-01-01', 'full').location]",
                  "accountName": "[parameters('storageName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName2'))]",
              "properties": {
                "category": "AzureStorageAccount",
                "target": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2')), '2023-01-01').primaryEndpoints.blob]",
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "authType": "AAD",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2'))]",
                  "location": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName2')), '2023-01-01', 'full').location]",
                  "accountName": "[parameters('storageName2')]",
                  "containerName": "default"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('aiSearchName')))]",
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('aiSearchName'))]",
              "properties": {
                "category": "CognitiveSearch",
                "target": "[format('https://{0}.search.windows.net/', parameters('aiSearchName'))]",
                "authType": "AAD",
                "isSharedToAll": true,
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.Search/searchServices', parameters('aiSearchName'))]",
                  "location": "[reference(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), '2024-06-01-preview', 'full').location]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('storageName2'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('cosmosDBname')))]",
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('cosmosDBname'))]",
              "properties": {
                "category": "CosmosDB",
                "target": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname')), '2025-05-01-preview').documentEndpoint]",
                "authType": "AAD",
                "isSharedToAll": true,
                "useWorkspaceManagedIdentity": true,
                "peRequirement": "[if(parameters('enablePublicAccessWithPerimeter'), 'NotRequired', 'Required')]",
                "peStatus": "[if(parameters('enablePublicAccessWithPerimeter'), 'Inactive', 'Active')]",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname'))]",
                  "location": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBname')), '2025-05-01-preview', 'full').location]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/projects/connections', parameters('aiFoundryV2Name'), parameters('defaultProjectName'), parameters('aiSearchName'))]"
              ]
            }
          ],
          "outputs": {
            "projectId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName'))]"
            },
            "projectName": {
              "type": "string",
              "value": "[parameters('defaultProjectName')]"
            },
            "projectPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName')), '2025-04-01-preview', 'full').identity.principalId]"
            },
            "projectWorkspaceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiFoundryV2Name'), parameters('defaultProjectName')), '2025-04-01-preview').internalId]"
            },
            "cosmosDBConnection": {
              "type": "string",
              "value": "[parameters('cosmosDBname')]"
            },
            "azureStorageConnection": {
              "type": "string",
              "value": "[parameters('storageName')]"
            },
            "aiSearchConnection": {
              "type": "string",
              "value": "[parameters('aiSearchName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(and(not(parameters('enablePublicAccessWithPerimeter')), not(variables('deployAvmFoundry'))), variables('shouldDeployFoundryPrivateEndpoints')), or(parameters('updateAIFoundry'), not(parameters('foundryV22AccountOnly')))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV21-PrivateEndpoints_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cognitiveServiceName": "[if(parameters('foundryV22AccountOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value), if(variables('deployAvmFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiServicesName.value), if(parameters('aiFoundryV2Exists'), createObject('value', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value))))]",
          "cognitiveServiceId": "[if(parameters('aiFoundryV2Exists'), createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountId.value))]",
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tagsProject')]"
          },
          "privateEndpointSubnetRID": {
            "value": "[parameters('genaiSubnetId')]"
          },
          "privateLinksDnsZones": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value]"
          },
          "createPrivateEndpointsAIFactoryWay": {
            "value": true
          },
          "centralDnsZoneByPolicyInHub": {
            "value": "[parameters('centralDnsZoneByPolicyInHub')]"
          },
          "apiManagementResourceId": {
            "value": "[parameters('apiManagementResourceId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12849275121321187162"
            },
            "name": "AI Foundry Private Endpoints",
            "description": "This module deploys private endpoints for AI Foundry Cognitive Services."
          },
          "parameters": {
            "cognitiveServiceName": {
              "type": "string",
              "metadata": {
                "description": "Required. The name of the Cognitive Services account to create private endpoints for."
              }
            },
            "cognitiveServiceId": {
              "type": "string",
              "metadata": {
                "description": "Required. The resource ID of the Cognitive Services account."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Required. Location for all Resources."
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Optional. Tags of the resource."
              }
            },
            "privateLinksDnsZones": {
              "type": "object",
              "metadata": {
                "description": "Required. Private DNS zones configuration."
              }
            },
            "privateEndpointSubnetRID": {
              "type": "string",
              "metadata": {
                "description": "Required. The resource ID of the subnet for private endpoints."
              }
            },
            "createPrivateEndpointsAIFactoryWay": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Optional. Whether to create private endpoints the AI Factory way."
              }
            },
            "centralDnsZoneByPolicyInHub": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Optional. Whether central DNS zone is managed by policy in hub."
              }
            },
            "apiManagementResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing API Management resource ID (for optional private endpoint)."
              }
            }
          },
          "variables": {
            "apiManagementProvided": "[not(empty(parameters('apiManagementResourceId')))]",
            "apiManagementParts": "[if(variables('apiManagementProvided'), split(parameters('apiManagementResourceId'), '/'), split('', '/'))]",
            "apiManagementName": "[if(variables('apiManagementProvided'), last(variables('apiManagementParts')), '')]"
          },
          "resources": [
            {
              "condition": "[parameters('createPrivateEndpointsAIFactoryWay')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}-pend', parameters('cognitiveServiceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "customNetworkInterfaceName": "[format('{0}-pend-nic', parameters('cognitiveServiceName'))]",
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pend', parameters('cognitiveServiceName'))]",
                    "properties": {
                      "groupIds": [
                        "account"
                      ],
                      "privateLinkServiceId": "[parameters('cognitiveServiceId')]",
                      "privateLinkServiceConnectionState": {
                        "status": "Approved",
                        "description": "Auto-Approved",
                        "actionsRequired": "None"
                      }
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetRID')]"
                }
              }
            },
            {
              "condition": "[and(not(parameters('centralDnsZoneByPolicyInHub')), parameters('createPrivateEndpointsAIFactoryWay'))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', format('{0}-pend', parameters('cognitiveServiceName')), format('{0}DnsZone', format('{0}-pend', parameters('cognitiveServiceName'))))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[parameters('privateLinksDnsZones').openai.name]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateLinksDnsZones').openai.id]"
                    }
                  },
                  {
                    "name": "[parameters('privateLinksDnsZones').cognitiveservices.name]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateLinksDnsZones').cognitiveservices.id]"
                    }
                  },
                  {
                    "name": "[parameters('privateLinksDnsZones').servicesai.name]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateLinksDnsZones').servicesai.id]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pend', parameters('cognitiveServiceName')))]"
              ]
            },
            {
              "condition": "[and(variables('apiManagementProvided'), parameters('createPrivateEndpointsAIFactoryWay'))]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}-pend', take(variables('apiManagementName'), 40))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetRID')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pend-nic', take(variables('apiManagementName'), 40))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('apiManagementResourceId')]",
                      "privateLinkServiceConnectionState": {
                        "status": "Approved",
                        "description": "Auto-Approved",
                        "actionsRequired": "None"
                      },
                      "groupIds": [
                        "Gateway"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pend', parameters('cognitiveServiceName')))]"
              ]
            },
            {
              "condition": "[and(and(not(parameters('centralDnsZoneByPolicyInHub')), variables('apiManagementProvided')), parameters('createPrivateEndpointsAIFactoryWay'))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', format('{0}-pend', take(variables('apiManagementName'), 40)), format('{0}DnsZone', format('{0}-pend', take(variables('apiManagementName'), 40))))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[parameters('privateLinksDnsZones').apim.name]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateLinksDnsZones').apim.id]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pend', take(variables('apiManagementName'), 40)))]"
              ]
            }
          ],
          "outputs": {
            "privateEndpointName": {
              "type": "string",
              "metadata": {
                "description": "The name of the private endpoint."
              },
              "value": "[if(parameters('createPrivateEndpointsAIFactoryWay'), format('{0}-pend', parameters('cognitiveServiceName')), '')]"
            },
            "privateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the private endpoint."
              },
              "value": "[if(parameters('createPrivateEndpointsAIFactoryWay'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pend', parameters('cognitiveServiceName'))), '')]"
            },
            "privateDnsZoneGroupId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the private DNS zone group."
              },
              "value": "[if(and(not(parameters('centralDnsZoneByPolicyInHub')), parameters('createPrivateEndpointsAIFactoryWay')), resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', format('{0}-pend', parameters('cognitiveServiceName')), format('{0}DnsZone', format('{0}-pend', parameters('cognitiveServiceName')))), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', format('07-AifV21_UserRBAC-{0}', variables('deploymentProjSpecificUniqueSuffix')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getPrivDnsZ-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-rbacAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-rbacStorage-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-rbacPrjKV-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(parameters('enableAIFoundry'), or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV2-Diagnostics_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cognitiveServiceName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "logAnalyticsWorkspaceId": {
            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('commonResourceGroup')), 'Microsoft.OperationalInsights/workspaces', variables('laWorkspaceName_Static'))]"
          },
          "diagnosticSettingLevel": {
            "value": "[parameters('diagnosticSettingLevel')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12231778751925622571"
            }
          },
          "parameters": {
            "cognitiveServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Cognitive Services resource"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace for diagnostics"
              }
            },
            "diagnosticSettingLevel": {
              "type": "string",
              "defaultValue": "silver",
              "allowedValues": [
                "gold",
                "silver",
                "bronze"
              ],
              "metadata": {
                "description": "Diagnostic setting level - determines metrics and logs collected"
              }
            },
            "diagnosticSettingName": {
              "type": "string",
              "defaultValue": "[format('diag-{0}', parameters('cognitiveServiceName'))]",
              "metadata": {
                "description": "Optional. Cognitive Service name prefix for diagnostic setting"
              }
            }
          },
          "variables": {
            "goldMetrics": [
              {
                "category": "AllMetrics",
                "enabled": true
              }
            ],
            "silverMetrics": [
              {
                "category": "AllMetrics",
                "enabled": true
              }
            ],
            "bronzeMetrics": [
              {
                "category": "AllMetrics",
                "enabled": true
              }
            ],
            "goldLogs": [
              {
                "category": "Audit",
                "enabled": true
              },
              {
                "category": "RequestResponse",
                "enabled": true
              },
              {
                "category": "Trace",
                "enabled": true
              }
            ],
            "silverLogs": [
              {
                "category": "Audit",
                "enabled": true
              },
              {
                "category": "RequestResponse",
                "enabled": true
              }
            ],
            "bronzeLogs": [
              {
                "category": "Audit",
                "enabled": true
              }
            ],
            "selectedMetrics": "[if(equals(parameters('diagnosticSettingLevel'), 'gold'), variables('goldMetrics'), if(equals(parameters('diagnosticSettingLevel'), 'silver'), variables('silverMetrics'), variables('bronzeMetrics')))]",
            "selectedLogs": "[if(equals(parameters('diagnosticSettingLevel'), 'gold'), variables('goldLogs'), if(equals(parameters('diagnosticSettingLevel'), 'silver'), variables('silverLogs'), variables('bronzeLogs')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServiceName'))]",
              "name": "[parameters('diagnosticSettingName')]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": "[variables('selectedMetrics')]",
                "logs": "[variables('selectedLogs')]"
              }
            }
          ],
          "outputs": {
            "diagnosticSettingId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServiceName')), 'Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('07-AifV21_UserRBAC-{0}', variables('deploymentProjSpecificUniqueSuffix'))]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "userObjectIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.p011_genai_team_lead_array.value]"
          },
          "servicePrincipalIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.spAndMiArray.value]"
          },
          "projectPrincipalId": "[if(and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]",
          "cognitiveServicesAccountName": "[if(parameters('foundryV22AccountOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value), if(variables('deployAvmFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiServicesName.value), if(parameters('aiFoundryV2Exists'), createObject('value', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value))))]",
          "cognitiveServicesContributorRoleId": {
            "value": "[variables('cognitiveServicesContributorRoleId')]"
          },
          "cognitiveServicesUserRoleId": {
            "value": "[variables('cognitiveServicesUserRoleId')]"
          },
          "openAIContributorRoleId": {
            "value": "[variables('openAIContributorRoleId')]"
          },
          "openAIUserRoleId": {
            "value": "[variables('openAIUserRoleId')]"
          },
          "useAdGroups": {
            "value": "[parameters('useAdGroups')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11175577047624681490"
            }
          },
          "parameters": {
            "userObjectIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of user object IDs to assign roles to"
              }
            },
            "servicePrincipalIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Array of service principal IDs to assign roles to"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Project principal ID to assign roles to"
              }
            },
            "cognitiveServicesAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Cognitive Services account to assign roles for"
              }
            },
            "cognitiveServicesContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for Cognitive Services Contributor"
              }
            },
            "cognitiveServicesUserRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for Cognitive Services User"
              }
            },
            "openAIContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for OpenAI Contributor"
              }
            },
            "openAIUserRoleId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID for OpenAI User"
              }
            },
            "useAdGroups": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to use AD Groups instead of individual users"
              }
            }
          },
          "resources": [
            {
              "copy": {
                "name": "openAIContributorRoleAssignmentUsers",
                "count": "[length(parameters('userObjectIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('userObjectIds')[copyIndex()], parameters('openAIContributorRoleId'), 'user-openai-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[copyIndex()]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "!01: user-openai-contributor-manual"
              }
            },
            {
              "copy": {
                "name": "cognitiveServicesContributorRoleAssignmentUsers",
                "count": "[length(parameters('userObjectIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('userObjectIds')[copyIndex()], parameters('cognitiveServicesContributorRoleId'), 'user-cs-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('userObjectIds')[copyIndex()]]",
                "principalType": "[if(parameters('useAdGroups'), 'Group', 'User')]",
                "description": "!02: user-cs-contributor-manual"
              }
            },
            {
              "copy": {
                "name": "openAIUserRoleAssignmentServicePrincipals",
                "count": "[length(parameters('servicePrincipalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('servicePrincipalIds')[copyIndex()], parameters('openAIUserRoleId'), 'sp-user-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIUserRoleId'))]",
                "principalId": "[parameters('servicePrincipalIds')[copyIndex()]]",
                "principalType": "ServicePrincipal",
                "description": "!05: sp-user-manual (2 rows OK)"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('openAIContributorRoleId'), 'project-openai-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "!06:project-openai-contributor-manual: AI Foundry project managed identity - OpenAI Contributor for project operations"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('cognitiveServicesContributorRoleId'), 'project-cs-contributor-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "!07:project-cs-contributor-manual:AI Foundry project managed identity - Cognitive Services Contributor for project operations"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('cognitiveServicesAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('cognitiveServicesAccountName')), parameters('projectPrincipalId'), parameters('cognitiveServicesUserRoleId'), 'project-cs-user-manual')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', parameters('cognitiveServicesUserRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "!08:project-cs-user-manual: AI Foundry project managed identity - Cognitive Services User for project operations"
              }
            }
          ],
          "outputs": {
            "userRoleNames": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('userObjectIds'))]",
                "input": "[format('User {0} assigned OpenAI Contributor, Cognitive Services Contributor, and Cognitive Services User roles', parameters('userObjectIds')[copyIndex()])]"
              }
            },
            "servicePrincipalRoleNames": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('servicePrincipalIds'))]",
                "input": "[format('Service Principal {0} assigned OpenAI User role', parameters('servicePrincipalIds')[copyIndex()])]"
              }
            },
            "projectPrincipalRoleNames": {
              "type": "string",
              "value": "[if(not(empty(parameters('projectPrincipalId'))), format('Project Principal {0} assigned OpenAI Contributor, Cognitive Services Contributor, and Cognitive Services User roles', parameters('projectPrincipalId')), 'No project principal provided')]"
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(add(mul(length(parameters('userObjectIds')), 3), length(parameters('servicePrincipalIds'))), if(not(empty(parameters('projectPrincipalId'))), 3, 0))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-spAndMI2Array-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ],
      "metadata": {
        "description": "Function to assign roles to users and service principals for a cognitive services account"
      }
    },
    {
      "condition": "[and(and(and(and(and(and(parameters('enableCaphost'), parameters('enableAIFactoryCreatedDefaultProjectForAIFv2')), parameters('enableAISearch')), variables('useCosmosForFoundry')), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV21_RBACpreCH_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectPrincipalId": "[if(and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]",
          "cosmosAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2091610910663070548"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the CosmosDB Account resource"
              }
            },
            "cosmosSQLDBName": {
              "type": "string",
              "defaultValue": "enterprise_memory",
              "metadata": {
                "description": "Name of the CosmosDB SQL Database in the account"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the AI project"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosAccountName'))]",
              "name": "[guid(parameters('projectPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(parameters('enableAISearch'), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-rbacAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": "[if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', ''))]",
          "aiFoundryAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "projectPrincipalId": "[if(variables('projectModuleEnabled'), if(and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', '')), createObject('value', ''))]",
          "searchServiceContributorRoleId": {
            "value": "[variables('searchServiceContributorRoleId')]"
          },
          "searchIndexDataReaderRoleId": {
            "value": "[variables('searchIndexDataReaderRoleId')]"
          },
          "searchIndexDataContributorRoleId": {
            "value": "[variables('searchIndexDataContributorRoleId')]"
          },
          "azureAIDeveloperRoleId": {
            "value": "[variables('azureAIDeveloperRoleId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2603168697541818607"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Search service"
              }
            },
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry account to get the principal ID from"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The principal ID of the AI Foundry project system-assigned managed identity"
              }
            },
            "searchServiceContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Search Service Contributor role ID"
              }
            },
            "searchIndexDataReaderRoleId": {
              "type": "string",
              "metadata": {
                "description": "Search Index Data Reader role ID"
              }
            },
            "searchIndexDataContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Search Index Data Contributor role ID"
              }
            },
            "azureAIDeveloperRoleId": {
              "type": "string",
              "defaultValue": "64702f94-c441-49e6-a78b-ef80e0188fee",
              "metadata": {
                "description": "Azure AI Developer role ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchServiceContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchServiceContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchIndexDataReaderRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataReaderRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('searchIndexDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('azureAIDeveloperRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('azureAIDeveloperRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchServiceContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchServiceContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchIndexDataReaderRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataReaderRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('searchIndexDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('searchIndexDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('projectPrincipalId'), parameters('azureAIDeveloperRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('azureAIDeveloperRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "rbacAssignmentsCompleted": {
              "type": "bool",
              "metadata": {
                "description": "AI Search RBAC assignments completed successfully"
              },
              "value": true
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(4, if(not(empty(parameters('projectPrincipalId'))), 4, 0))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(not(parameters('foundryV22AccountOnly')), parameters('enableAISearch')), parameters('enableAIFoundry'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-rbacAISearchOAUser-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiFoundryAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "aiSearchPrincipalId": "[if(parameters('enableAISearch'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.principalId.value), createObject('value', ''))]",
          "openAIUserRoleId": {
            "value": "[variables('openAIUserRoleId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "16982159623764770828"
            }
          },
          "parameters": {
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry account name to scope the role assignment"
              }
            },
            "aiSearchPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the AI Search service managed identity"
              }
            },
            "openAIUserRoleId": {
              "type": "string",
              "defaultValue": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
              "metadata": {
                "description": "Role definition ID for Cognitive Services OpenAI User"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiFoundryAccountName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('aiSearchPrincipalId'), parameters('openAIUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('openAIUserRoleId'))]",
                "principalId": "[parameters('aiSearchPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "roleAssignmentCreated": {
              "type": "bool",
              "value": true
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-getAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(parameters('enableAIFoundry'), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-rbacStorage-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "storageAccountName2": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount2001Name.value]"
          },
          "aiFoundryAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "projectPrincipalId": "[if(variables('projectModuleEnabled'), if(and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', '')), createObject('value', ''))]",
          "storageBlobDataContributorRoleId": {
            "value": "[variables('storageBlobDataContributorRoleId')]"
          },
          "storageFileDataPrivilegedContributorRoleId": {
            "value": "[variables('storageFileDataPrivilegedContributorRoleId')]"
          },
          "storageFileDataSMBPrivilegedContributorRoleId": {
            "value": "[variables('storageFileDataSMBPrivilegedContributorRoleId')]"
          },
          "storageQueueDataContributorRoleId": {
            "value": "[variables('storageQueueDataContributorRoleId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "13139720558607161744"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account"
              }
            },
            "storageAccountName2": {
              "type": "string"
            },
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry account to get the principal ID from"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The principal ID of the AI Foundry project system-assigned managed identity"
              }
            },
            "storageBlobDataContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Storage Blob Data Contributor role ID"
              }
            },
            "storageFileDataPrivilegedContributorRoleId": {
              "type": "string",
              "metadata": {
                "description": "Storage File Data Privileged Contributor role ID"
              }
            },
            "storageFileDataSMBPrivilegedContributorRoleId": {
              "type": "string"
            },
            "storageQueueDataContributorRoleId": {
              "type": "string",
              "defaultValue": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
              "metadata": {
                "description": "Storage Queue Data Contributor role ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataPrivilegedContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataSMBPrivilegedContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataSMBPrivilegedContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageBlobDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageFileDataPrivilegedContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('projectPrincipalId'), parameters('storageQueueDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageFileDataPrivilegedContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('storageQueueDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageBlobDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageFileDataPrivilegedContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageFileDataPrivilegedContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName2'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName2')), parameters('projectPrincipalId'), parameters('storageQueueDataContributorRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('storageQueueDataContributorRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "rbacAssignmentsCompleted": {
              "type": "bool",
              "metadata": {
                "description": "Storage Account RBAC assignments completed successfully"
              },
              "value": true
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(6, if(not(empty(parameters('projectPrincipalId'))), 6, 0))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(and(and(and(parameters('enableCaphost'), parameters('enableAIFactoryCreatedDefaultProjectForAIFv2')), parameters('enableAISearch')), variables('useCosmosForFoundry')), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV21_PrjCapHost_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "accountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "projectName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjNameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2PrjName.value))]",
          "cosmosDBConnection": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value]"
          },
          "azureStorageConnection": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "aiSearchConnection": "[if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', ''))]",
          "projectCapHostName": {
            "value": "[format('{0}caphost', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14627596929158472342"
            }
          },
          "parameters": {
            "cosmosDBConnection": {
              "type": "string"
            },
            "azureStorageConnection": {
              "type": "string"
            },
            "aiSearchConnection": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "accountName": {
              "type": "string"
            },
            "projectCapHostName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional name for the capability host. If omitted, a deterministic name is generated based on the selected level."
              }
            },
            "accountLevel": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "When true, deploy the capability host at the account scope instead of the project scope."
              }
            }
          },
          "variables": {
            "defaultProjectCapabilityHostName": "[format('chagent{0}', replace(parameters('projectName'), '-', ''))]",
            "defaultAccountCapabilityHostName": "[format('chagent{0}', replace(parameters('accountName'), '-', ''))]",
            "resolvedProjectCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultProjectCapabilityHostName'), parameters('projectCapHostName'))]",
            "resolvedAccountCapabilityHostName": "[if(empty(parameters('projectCapHostName')), variables('defaultAccountCapabilityHostName'), parameters('projectCapHostName'))]"
          },
          "resources": [
            {
              "condition": "[parameters('accountLevel')]",
              "type": "Microsoft.CognitiveServices/accounts/capabilityHosts",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}', parameters('accountName'), variables('resolvedAccountCapabilityHostName'))]",
              "properties": {
                "capabilityHostKind": "Agents"
              }
            },
            {
              "condition": "[not(parameters('accountLevel'))]",
              "type": "Microsoft.CognitiveServices/accounts/projects/capabilityHosts",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), variables('resolvedProjectCapabilityHostName'))]",
              "properties": {
                "capabilityHostKind": "Agents",
                "threadStorageConnections": [
                  "[format('{0}', parameters('cosmosDBConnection'))]"
                ],
                "vectorStoreConnections": [
                  "[format('{0}', parameters('aiSearchConnection'))]"
                ],
                "storageConnections": [
                  "[format('{0}', parameters('azureStorageConnection'))]"
                ]
              }
            }
          ],
          "outputs": {
            "projectCapHost": {
              "type": "string",
              "value": "[if(not(parameters('accountLevel')), string(variables('resolvedProjectCapabilityHostName')), '')]"
            },
            "accountCapHost": {
              "type": "string",
              "value": "[if(parameters('accountLevel'), string(variables('resolvedAccountCapabilityHostName')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-rbacAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-rbacStorage-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_RBACpreCH_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(and(and(and(parameters('enableCaphost'), parameters('enableAIFactoryCreatedDefaultProjectForAIFv2')), parameters('enableAISearch')), variables('useCosmosForFoundry')), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV21_PrjWID_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectWorkspaceId": "[if(and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceId.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "8377605865688192705"
            }
          },
          "parameters": {
            "projectWorkspaceId": {
              "type": "string"
            }
          },
          "variables": {
            "part1": "[substring(parameters('projectWorkspaceId'), 0, 8)]",
            "part2": "[substring(parameters('projectWorkspaceId'), 8, 4)]",
            "part3": "[substring(parameters('projectWorkspaceId'), 12, 4)]",
            "part4": "[substring(parameters('projectWorkspaceId'), 16, 4)]",
            "part5": "[substring(parameters('projectWorkspaceId'), 20, 12)]",
            "formattedGuid": "[format('{0}-{1}-{2}-{3}-{4}', variables('part1'), variables('part2'), variables('part3'), variables('part4'), variables('part5'))]"
          },
          "resources": [],
          "outputs": {
            "projectWorkspaceIdGuid": {
              "type": "string",
              "value": "[variables('formattedGuid')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_PrjCapHost_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(and(and(and(and(parameters('enableCaphost'), parameters('enableAIFactoryCreatedDefaultProjectForAIFv2')), parameters('enableAISearch')), variables('useCosmosForFoundry')), parameters('enableAIFoundry')), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-AifV21_RBACpostCH_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectPrincipalId": "[if(and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', ''))]",
          "storageName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value]"
          },
          "projectWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_PrjWID_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectWorkspaceIdGuid.value]"
          },
          "cosmosAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "7103959165167896799"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the CosmosDB Account resource"
              }
            },
            "cosmosSQLDBName": {
              "type": "string",
              "defaultValue": "enterprise_memory",
              "metadata": {
                "description": "Name of the CosmosDB SQL Database in the account"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the AI project"
              }
            },
            "storageName": {
              "type": "string",
              "metadata": {
                "description": "Name of the storage account"
              }
            },
            "projectWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Workspace Id of the AI Project"
              }
            }
          },
          "variables": {
            "userThreadName": "[format('{0}-thread-message-store', parameters('projectWorkspaceId'))]",
            "systemThreadName": "[format('{0}-system-thread-message-store', parameters('projectWorkspaceId'))]",
            "entityStoreName": "[format('{0}-agent-entity-store', parameters('projectWorkspaceId'))]",
            "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosAccountName'), '00000000-0000-0000-0000-000000000002')]",
            "scopeSystemContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('systemThreadName'))]",
            "scopeUserContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('userThreadName'))]",
            "scopeEntityContainer": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory/colls/{3}', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'), variables('entityStoreName'))]",
            "conditionStr": "[format('((!(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/read''}})  AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/filter/action''}}) AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/write''}}) ) OR (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringStartsWithIgnoreCase ''{0}'' AND @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringLikeIgnoreCase ''*-azureml-agent''))', parameters('projectWorkspaceId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('userThreadName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "scope": "[variables('scopeUserContainer')]"
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('systemThreadName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "scope": "[variables('scopeSystemContainer')]"
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosSQLDBName'), variables('entityStoreName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "scope": "[variables('scopeEntityContainer')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
              "name": "[guid(resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b'), resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), parameters('projectPrincipalId'), parameters('projectWorkspaceId'))]",
              "properties": {
                "principalId": "[parameters('projectPrincipalId')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                "principalType": "ServicePrincipal",
                "conditionVersion": "2.0",
                "condition": "[variables('conditionStr')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_PrjCapHost_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_PrjWID_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(parameters('enableAIFoundry'), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-rbacKeyVault-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.keyvaultName.value]"
          },
          "aiFoundryAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "projectPrincipalId": "[if(variables('projectModuleEnabled'), if(and(and(and(variables('projectModuleEnabled'), parameters('enableAIFoundry')), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), not(parameters('foundryV22AccountOnly')))), not(parameters('foundryV22AccountOnly'))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.projectPrincipalId.value), createObject('value', '')), createObject('value', ''))]",
          "keyVaultSecretsUserRoleId": {
            "value": "[variables('keyVaultSecretsUserRoleId')]"
          },
          "keyVaultContributorRoleId": {
            "value": "[variables('keyVaultContributorRoleId')]"
          },
          "keyVaultSecretsOfficerRoleId": {
            "value": "[variables('keyVaultSecretsOfficerRoleId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "13399252647474571129"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault service"
              }
            },
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry account to get the principal ID from"
              }
            },
            "projectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The principal ID of the AI Foundry project system-assigned managed identity"
              }
            },
            "keyVaultSecretsUserRoleId": {
              "type": "string",
              "defaultValue": "4633458b-17de-408a-b874-0445c86b69e6",
              "metadata": {
                "description": "Key Vault Secrets User role ID"
              }
            },
            "keyVaultContributorRoleId": {
              "type": "string",
              "defaultValue": "f25e0fa2-a7c8-4377-a976-54943a77a395",
              "metadata": {
                "description": "Key Vault Contributor role ID"
              }
            },
            "keyVaultSecretsOfficerRoleId": {
              "type": "string",
              "defaultValue": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
              "metadata": {
                "description": "Key Vault Secrets Officer role ID - For Agent operations"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultSecretsUserRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('keyVaultContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultContributorRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('projectPrincipalId'), parameters('keyVaultSecretsUserRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultSecretsUserRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "AI Foundry project managed identity - Key Vault Secrets User for Agent operations"
              }
            },
            {
              "condition": "[not(empty(parameters('projectPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('projectPrincipalId'), parameters('keyVaultSecretsOfficerRoleId'), 'project')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[parameters('projectPrincipalId')]",
                "principalType": "ServicePrincipal",
                "description": "AI Foundry project managed identity - Key Vault Secrets Officer for Agent operations"
              }
            }
          ],
          "outputs": {
            "rbacAssignmentsCompleted": {
              "type": "bool",
              "metadata": {
                "description": "Key Vault RBAC assignments completed successfully"
              },
              "value": true
            },
            "roleAssignmentsCount": {
              "type": "int",
              "metadata": {
                "description": "Number of role assignments created"
              },
              "value": "[add(2, if(not(empty(parameters('projectPrincipalId'))), 2, 0))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21_Prj_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(and(parameters('enableAIFoundry'), not(parameters('foundryV22AccountOnly'))), not(parameters('aiFoundryV2ProjectExists')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-rbacPrjKV-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.keyvaultName.value]"
          },
          "aiFoundryAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "keyVaultSecretsOfficerRoleId": {
            "value": "[variables('keyVaultSecretsOfficerRoleId')]"
          },
          "keyVaultSecretsUserRoleId": {
            "value": "[variables('keyVaultSecretsUserRoleId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "9376116566536553631"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the project Key Vault"
              }
            },
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry account to get the principal ID from"
              }
            },
            "keyVaultSecretsOfficerRoleId": {
              "type": "string",
              "defaultValue": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
              "metadata": {
                "description": "Key Vault Secrets Officer role ID - Can manage secrets"
              }
            },
            "keyVaultSecretsUserRoleId": {
              "type": "string",
              "defaultValue": "4633458b-17de-408a-b874-0445c86b69e6",
              "metadata": {
                "description": "Key Vault Secrets User role ID - Can read secrets"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), parameters('keyVaultSecretsOfficerRoleId'), 'aifoundry-mi')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('keyVaultSecretsOfficerRoleId'))]",
                "principalId": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiFoundryAccountName')), '2025-07-01-preview', 'full').identity.principalId]",
                "principalType": "ServicePrincipal",
                "description": "AI Foundry system managed identity - Key Vault Secrets Officer for Agent operations"
              }
            }
          ],
          "outputs": {
            "rbacAssignmentCompleted": {
              "type": "bool",
              "metadata": {
                "description": "AI Foundry Key Vault RBAC assignment completed"
              },
              "value": true
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('vnetResourceGroupName')), 'Microsoft.Resources/deployments', take(format('09-snetDelegACA{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[variables('enableSharedLinkDeployment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('09-aiSearchSPL-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": "[if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), createObject('value', take(if(parameters('addAISearch'), format('{0}{1}{2}', if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), take(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0)), ''), take(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.randomSalt.value, 2), if(and(parameters('enableAISearch'), not(empty(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), substring(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, ''), max(sub(length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 3), 0), min(3, length(if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')))), '')), if(parameters('enableAISearch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value, '')), 60)), createObject('value', ''))]",
          "aiFoundryResourceId": "[if(parameters('foundryV22AccountOnly'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountId.value), if(variables('deployAvmFoundry'), createObject('value', resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.CognitiveServices/accounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiServicesName.value)), if(parameters('aiFoundryV2Exists'), createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountId.value))))]",
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "6522796908740948571"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "Name of the existing Azure AI Search service that will request the shared private link"
              }
            },
            "aiFoundryResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Azure AI Foundry account that will receive the shared private link request"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for the shared private link request"
              }
            },
            "requestMessage": {
              "type": "string",
              "defaultValue": "Azure AI Search shared private link to Azure AI Foundry",
              "metadata": {
                "description": "Optional message included with the shared private link request"
              }
            }
          },
          "resources": [
            {
              "condition": "[and(not(empty(parameters('aiFoundryResourceId'))), not(empty(parameters('aiSearchName'))))]",
              "type": "Microsoft.Search/searchServices/sharedPrivateLinkResources",
              "apiVersion": "2025-05-01",
              "name": "[format('{0}/{1}', parameters('aiSearchName'), 'shared-pe-foundry-openai')]",
              "properties": {
                "privateLinkResourceId": "[parameters('aiFoundryResourceId')]",
                "groupId": "openai_account",
                "requestMessage": "[parameters('requestMessage')]",
                "resourceRegion": "[parameters('location')]"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiFoundryResourceId'))), not(empty(parameters('aiSearchName'))))]",
              "type": "Microsoft.Search/searchServices/sharedPrivateLinkResources",
              "apiVersion": "2025-05-01",
              "name": "[format('{0}/{1}', parameters('aiSearchName'), 'shared-pe-foundry-cogsvc')]",
              "properties": {
                "privateLinkResourceId": "[parameters('aiFoundryResourceId')]",
                "groupId": "cognitiveservices_account",
                "requestMessage": "[parameters('requestMessage')]",
                "resourceRegion": "[parameters('location')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices/sharedPrivateLinkResources', parameters('aiSearchName'), 'shared-pe-foundry-openai')]"
              ]
            }
          ],
          "outputs": {
            "sharedPrivateLinkName": {
              "type": "string",
              "value": "[if(and(not(empty(parameters('aiFoundryResourceId'))), not(empty(parameters('aiSearchName')))), 'shared-pe-foundry-openai', '')]"
            },
            "sharedPrivateLinkName2": {
              "type": "string",
              "value": "[if(and(not(empty(parameters('aiFoundryResourceId'))), not(empty(parameters('aiSearchName')))), 'shared-pe-foundry-cogsvc', '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV21-PrivateEndpoints_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-rbacAISearch-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    },
    {
      "condition": "[and(not(parameters('enableDefenderforAISubLevel')), parameters('enableDefenderforAIResourceLevel'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('defender-for-ai-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)]",
      "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
      "resourceGroup": "[variables('targetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiAccountName": "[if(parameters('addAIFoundry'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value))]",
          "profileName": {
            "value": "default"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14654697985689812191"
            }
          },
          "parameters": {
            "aiAccountName": {
              "type": "string",
              "metadata": {
                "description": "Existing Azure AI (Cognitive Services) account name."
              }
            },
            "profileName": {
              "type": "string",
              "defaultValue": "default"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/defenderForAISettings",
              "apiVersion": "2025-10-01-preview",
              "name": "[format('{0}/{1}', parameters('aiAccountName'), parameters('profileName'))]",
              "properties": {
                "state": "Enabled"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-rbacKeyVault-{0}', variables('deploymentProjSpecificUniqueSuffix')), 64))]"
      ]
    }
  ],
  "outputs": {
    "rbacSecurityPhaseCompleted": {
      "type": "bool",
      "metadata": {
        "description": "RBAC Security Phase 7 deployment completed successfully"
      },
      "value": true
    },
    "aiModelsConfiguration": {
      "type": "array",
      "metadata": {
        "description": "AI Models configuration for debugging"
      },
      "value": "[variables('aiModels')]"
    },
    "aiFoundryV2Deployed": {
      "type": "bool",
      "metadata": {
        "description": "AI Foundry V2 deployment status"
      },
      "value": "[parameters('enableAIFoundry')]"
    },
    "aiFoundryV2Name": {
      "type": "string",
      "metadata": {
        "description": "AI Foundry V2 name"
      },
      "value": "[if(parameters('enableAIFoundry'), if(parameters('foundryV22AccountOnly'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value, if(variables('deployAvmFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiServicesName.value, if(parameters('aiFoundryV2Exists'), if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountName.value))), '')]"
    },
    "aiFoundryV2ResourceId": {
      "type": "string",
      "metadata": {
        "description": "AI Foundry V2 resource ID"
      },
      "value": "[if(parameters('enableAIFoundry'), if(parameters('foundryV22AccountOnly'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvmAccountOnly_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountId.value, if(variables('deployAvmFoundry'), resourceId(parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup'), 'Microsoft.CognitiveServices/accounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV2-Avm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiServicesName.value), if(parameters('aiFoundryV2Exists'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.CognitiveServices/accounts', if(parameters('addAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2NameAdd.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-naming-{0}', variables('targetResourceGroup')), 64)), '2022-09-01').outputs.aifV2Name.value)), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiAccountId.value))), '')]"
    },
    "aiFoundryProjectDeployed": {
      "type": "bool",
      "metadata": {
        "description": "AI Foundry Project deployment status"
      },
      "value": "[if(parameters('foundryV22AccountOnly'), false(), if(variables('deployAvmFoundry'), and(parameters('enableAIFoundry'), variables('projectModuleEnabled')), if(or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), parameters('cmk')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.aiFoundryProjectDeployed.value, and(parameters('enableAIFoundry'), variables('projectModuleEnabled')))))]"
    },
    "debugModuleConditions": {
      "type": "object",
      "metadata": {
        "description": "Debug: Shows module deployment conditions"
      },
      "value": {
        "foundryV22AccountOnly": "[parameters('foundryV22AccountOnly')]",
        "enableAIFoundry": "[parameters('enableAIFoundry')]",
        "useAVMFoundry": "[parameters('useAVMFoundry')]",
        "aiFoundryV2Exists": "[parameters('aiFoundryV2Exists')]",
        "updateAIFoundry": "[parameters('updateAIFoundry')]",
        "cmk": "[parameters('cmk')]",
        "moduleWillDeploy": "[and(and(and(not(parameters('foundryV22AccountOnly')), parameters('enableAIFoundry')), not(parameters('useAVMFoundry'))), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), parameters('cmk')))]"
      }
    },
    "debugCmkUpdate": {
      "type": "object",
      "metadata": {
        "description": "Debug: CMK update status from child module"
      },
      "value": "[if(and(and(and(not(parameters('foundryV22AccountOnly')), parameters('enableAIFoundry')), not(parameters('useAVMFoundry'))), or(or(not(parameters('aiFoundryV2Exists')), parameters('updateAIFoundry')), parameters('cmk'))), createObject('cmkUpdateAttempted', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.cmkUpdateAttempted.value, 'cmkDebugInfo', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionIdDevTestProd'), variables('targetResourceGroup')), 'Microsoft.Resources/deployments', take(format('09-AifV22-NoAvm_{0}', variables('deploymentProjSpecificUniqueSuffix')), 64)), '2022-09-01').outputs.cmkDebugInfo.value), createObject('cmkUpdateAttempted', false(), 'cmkDebugInfo', createObject()))]"
    },
    "aiModelsDeployed": {
      "type": "int",
      "metadata": {
        "description": "AI Models deployed count"
      },
      "value": "[length(variables('aiModels'))]"
    }
  }
}