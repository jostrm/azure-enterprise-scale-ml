{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "1477020545186117311"
    }
  },
  "parameters": {
    "targetSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "Subscription that hosts the target resource group. Defaults to the current subscription when omitted."
      }
    },
    "targetResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Explicit target resource group name. Leave empty to derive from the common naming convention inputs."
      }
    },
    "commonResourceGroup_param": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional pre-calculated common resource group name."
      }
    },
    "commonRGNamePrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Prefix for common resource groups (for example \"esml-\")."
      }
    },
    "commonResourceName": {
      "type": "string",
      "defaultValue": "esml-common",
      "metadata": {
        "description": "Common resource base name (for example \"common\")."
      }
    },
    "locationSuffix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Location suffix component used in naming (for example \"weu\")."
      }
    },
    "env": {
      "type": "string",
      "allowedValues": [
        "dev",
        "test",
        "prod"
      ],
      "metadata": {
        "description": "Deployment environment moniker such as dev, test, or prod."
      }
    },
    "projectNumber": {
      "type": "string",
      "metadata": {
        "description": "Project number (three digits) used in naming, for example \"001\"."
      }
    },
    "commonResourceSuffix": {
      "type": "string",
      "metadata": {
        "description": "Suffix used for shared/common resources (for example \"-001\")."
      }
    },
    "resourceSuffix": {
      "type": "string",
      "metadata": {
        "description": "Suffix appended to project specific resources (for example \"-001\")."
      }
    },
    "aifactorySuffixRG": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Suffix appended to resource group names (for example \"-rg\")."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "metadata": {
        "description": "Azure region for all resources. Defaults to swedencentral per design guidance."
      }
    },
    "aifactorySalt10char": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional deterministic salt (10 chars) used for naming. Leave empty to derive from randomValue."
      }
    },
    "randomValue": {
      "type": "string",
      "defaultValue": "[uniqueString(subscription().subscriptionId, parameters('locationSuffix'), parameters('env'))]",
      "metadata": {
        "description": "Random value used for deterministic naming fallback."
      }
    },
    "technicalAdminsObjectID": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Comma separated list of technical admin object IDs."
      }
    },
    "technicalAdminsEmail": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Comma separated list of technical admin emails."
      }
    },
    "subscriptionIdDevTestProd": {
      "type": "string",
      "defaultValue": "[parameters('targetSubscriptionId')]",
      "metadata": {
        "description": "Subscription that hosts the project resources. Defaults to the deployment subscription when not provided."
      }
    },
    "existingVnetResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing virtual network Resource ID. Leave empty to derive from project subnet inputs."
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "agent-vnet-test",
      "metadata": {
        "description": "Virtual network name when creating a new network."
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Address space for the VNet when creating a new network."
      }
    },
    "agentSubnetName": {
      "type": "string",
      "defaultValue": "agent-subnet",
      "metadata": {
        "description": "Subnet name dedicated to agents."
      }
    },
    "peSubnetName": {
      "type": "string",
      "defaultValue": "pe-subnet",
      "metadata": {
        "description": "Subnet name dedicated to private endpoints."
      }
    },
    "agentSubnetPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "CIDR prefix for the agent subnet."
      }
    },
    "peSubnetPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "CIDR prefix for the private endpoint subnet."
      }
    },
    "aiSearchResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Azure AI Search resource ID override. Leave empty to derive from the naming module output."
      }
    },
    "azureStorageAccountResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Azure Storage Account resource ID override. Leave empty to derive from the naming module output."
      }
    },
    "azureCosmosDBAccountResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Azure Cosmos DB resource ID override. Leave empty to derive from the naming module output."
      }
    },
    "apiManagementResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing API Management instance resource ID. Optional input that can remain empty."
      }
    },
    "existingDnsZones": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "JSON encoded object describing existing DNS zones keyed by zone name. Leave blank to auto-resolve."
      }
    },
    "dnsZoneNames": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "JSON encoded array identifying DNS zones that should be validated. Leave blank to auto-resolve."
      }
    },
    "privDnsSubscription_param": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Subscription hosting private DNS zones when centrally managed."
      }
    },
    "privDnsResourceGroup_param": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource group hosting private DNS zones when centrally managed."
      }
    },
    "centralDnsZoneByPolicyInHub": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Set to true when private DNS zones are enforced centrally via policy."
      }
    },
    "genaiSubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Subnet resource ID dedicated to private endpoints (genai subnet)."
      }
    },
    "aksSubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Primary AKS subnet resource ID."
      }
    },
    "acaSubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Primary ACA subnet resource ID used for agents."
      }
    },
    "aca2SubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional secondary ACA subnet resource ID."
      }
    },
    "aks2SubnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional secondary AKS subnet resource ID."
      }
    }
  },
  "variables": {
    "resolvedCommonResourceGroup": "[if(not(empty(trim(parameters('commonResourceGroup_param')))), parameters('commonResourceGroup_param'), format('{0}{1}-{2}-{3}{4}', parameters('commonRGNamePrefix'), parameters('commonResourceName'), parameters('locationSuffix'), parameters('env'), parameters('aifactorySuffixRG')))]",
    "resolvedTargetResourceGroup": "[if(not(empty(trim(parameters('targetResourceGroupName')))), parameters('targetResourceGroupName'), variables('resolvedCommonResourceGroup'))]",
    "resolvedSubscriptionId": "[if(not(empty(trim(parameters('subscriptionIdDevTestProd')))), parameters('subscriptionIdDevTestProd'), parameters('targetSubscriptionId'))]",
    "moduleDeploymentSuffix": "[uniqueString(variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup'), parameters('location'))]",
    "resolvedPrivDnsSubscription": "[if(not(empty(trim(parameters('privDnsSubscription_param')))), parameters('privDnsSubscription_param'), variables('resolvedSubscriptionId'))]",
    "resolvedPrivDnsResourceGroup": "[if(and(not(empty(trim(parameters('privDnsResourceGroup_param')))), parameters('centralDnsZoneByPolicyInHub')), parameters('privDnsResourceGroup_param'), variables('resolvedTargetResourceGroup'))]",
    "subnetSourceForVnet": "[if(not(empty(trim(parameters('genaiSubnetId')))), parameters('genaiSubnetId'), if(not(empty(trim(parameters('acaSubnetId')))), parameters('acaSubnetId'), ''))]",
    "vnetResourceIdFromSubnet": "[if(not(empty(variables('subnetSourceForVnet'))), split(variables('subnetSourceForVnet'), '/subnets/')[0], '')]",
    "resolvedExistingVnetResourceId": "[if(not(empty(trim(parameters('existingVnetResourceId')))), parameters('existingVnetResourceId'), variables('vnetResourceIdFromSubnet'))]",
    "resolvedVnetName": "[if(not(empty(trim(parameters('vnetName')))), parameters('vnetName'), if(not(empty(variables('resolvedExistingVnetResourceId'))), last(split(variables('resolvedExistingVnetResourceId'), '/')), parameters('vnetName')))]",
    "resolvedAgentSubnetId": "[if(not(empty(trim(parameters('acaSubnetId')))), parameters('acaSubnetId'), variables('subnetSourceForVnet'))]",
    "resolvedPeSubnetId": "[if(not(empty(trim(parameters('genaiSubnetId')))), parameters('genaiSubnetId'), variables('resolvedAgentSubnetId'))]",
    "resolvedAgentSubnetName": "[if(not(empty(trim(parameters('agentSubnetName')))), parameters('agentSubnetName'), if(not(empty(variables('resolvedAgentSubnetId'))), last(split(variables('resolvedAgentSubnetId'), '/')), parameters('agentSubnetName')))]",
    "resolvedPeSubnetName": "[if(not(empty(trim(parameters('peSubnetName')))), parameters('peSubnetName'), if(not(empty(variables('resolvedPeSubnetId'))), last(split(variables('resolvedPeSubnetId'), '/')), parameters('peSubnetName')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64)]",
      "subscriptionId": "[variables('resolvedSubscriptionId')]",
      "resourceGroup": "[variables('resolvedTargetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "env": {
            "value": "[parameters('env')]"
          },
          "projectNumber": {
            "value": "[parameters('projectNumber')]"
          },
          "locationSuffix": {
            "value": "[parameters('locationSuffix')]"
          },
          "commonResourceSuffix": {
            "value": "[parameters('commonResourceSuffix')]"
          },
          "resourceSuffix": {
            "value": "[parameters('resourceSuffix')]"
          },
          "aifactorySalt10char": {
            "value": "[parameters('aifactorySalt10char')]"
          },
          "randomValue": {
            "value": "[parameters('randomValue')]"
          },
          "aifactorySuffixRG": {
            "value": "[parameters('aifactorySuffixRG')]"
          },
          "commonRGNamePrefix": {
            "value": "[parameters('commonRGNamePrefix')]"
          },
          "technicalAdminsObjectID": {
            "value": "[parameters('technicalAdminsObjectID')]"
          },
          "technicalAdminsEmail": {
            "value": "[parameters('technicalAdminsEmail')]"
          },
          "commonResourceGroupName": {
            "value": "[variables('resolvedCommonResourceGroup')]"
          },
          "subscriptionIdDevTestProd": {
            "value": "[variables('resolvedSubscriptionId')]"
          },
          "genaiSubnetId": {
            "value": "[parameters('genaiSubnetId')]"
          },
          "aksSubnetId": {
            "value": "[parameters('aksSubnetId')]"
          },
          "acaSubnetId": {
            "value": "[parameters('acaSubnetId')]"
          },
          "aca2SubnetId": {
            "value": "[parameters('aca2SubnetId')]"
          },
          "aks2SubnetId": {
            "value": "[parameters('aks2SubnetId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14620113903890155467"
            }
          },
          "definitions": {
            "aifactoryNamingType": {
              "type": "object",
              "properties": {
                "genaiSubnetName": {
                  "type": "string"
                },
                "aksSubnetName": {
                  "type": "string"
                },
                "aks2SubnetName": {
                  "type": "string"
                },
                "acaSubnetName": {
                  "type": "string"
                },
                "aca2SubnetName": {
                  "type": "string"
                },
                "defaultSubnet": {
                  "type": "string"
                },
                "aifV1HubName": {
                  "type": "string"
                },
                "aifV1ProjectName": {
                  "type": "string"
                },
                "aifV2Name": {
                  "type": "string"
                },
                "aifV2PrjName": {
                  "type": "string"
                },
                "aoaiName": {
                  "type": "string"
                },
                "amlName": {
                  "type": "string"
                },
                "safeNameAISearch": {
                  "type": "string"
                },
                "aiServicesName": {
                  "type": "string"
                },
                "dashboardInsightsName": {
                  "type": "string"
                },
                "applicationInsightName": {
                  "type": "string"
                },
                "applicationInsightName2": {
                  "type": "string"
                },
                "bingName": {
                  "type": "string"
                },
                "containerAppsEnvName": {
                  "type": "string"
                },
                "containerAppAName": {
                  "type": "string"
                },
                "containerAppWName": {
                  "type": "string"
                },
                "cosmosDBName": {
                  "type": "string"
                },
                "redisName": {
                  "type": "string"
                },
                "postgreSQLName": {
                  "type": "string"
                },
                "sqlServerName": {
                  "type": "string"
                },
                "sqlDBName": {
                  "type": "string"
                },
                "functionAppName": {
                  "type": "string"
                },
                "webAppName": {
                  "type": "string"
                },
                "funcAppServicePlanName": {
                  "type": "string"
                },
                "webbAppServicePlanName": {
                  "type": "string"
                },
                "vmName": {
                  "type": "string"
                },
                "keyvaultName": {
                  "type": "string"
                },
                "storageAccount1001Name": {
                  "type": "string"
                },
                "storageAccount2001Name": {
                  "type": "string"
                },
                "acrProjectName": {
                  "type": "string"
                },
                "acrCommonName": {
                  "type": "string"
                },
                "miACAName": {
                  "type": "string"
                },
                "miPrjName": {
                  "type": "string"
                },
                "laWorkspaceName": {
                  "type": "string"
                },
                "projectName": {
                  "type": "string"
                },
                "cmnName": {
                  "type": "string"
                },
                "kvNameCommon": {
                  "type": "string"
                },
                "genaiName": {
                  "type": "string"
                },
                "prjResourceSuffixNoDash": {
                  "type": "string"
                },
                "twoNumbers": {
                  "type": "string"
                },
                "p011_genai_team_lead_array": {
                  "type": "array"
                },
                "p011_genai_team_lead_email_array": {
                  "type": "array"
                },
                "uniqueInAIFenv": {
                  "type": "string"
                },
                "randomSalt": {
                  "type": "string"
                },
                "projectTypeESMLName": {
                  "type": "string"
                },
                "projectTypeGenAIName": {
                  "type": "string"
                },
                "aksClusterName": {
                  "type": "string"
                },
                "dataFactoryName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../types/aifactoryNaming.bicep"
                }
              }
            }
          },
          "parameters": {
            "env": {
              "type": "string",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Environment: dev, test, prod"
              }
            },
            "projectNumber": {
              "type": "string",
              "metadata": {
                "description": "Project number (e.g., \"005\")"
              }
            },
            "locationSuffix": {
              "type": "string",
              "metadata": {
                "description": "Location suffix (e.g., \"weu\", \"swc\")"
              }
            },
            "commonResourceSuffix": {
              "type": "string",
              "metadata": {
                "description": "Common resource suffix (e.g., \"-001\")"
              }
            },
            "resourceSuffix": {
              "type": "string",
              "metadata": {
                "description": "Project-specific resource suffix"
              }
            },
            "aifactorySalt10char": {
              "type": "string",
              "metadata": {
                "description": "Random salt for unique naming"
              }
            },
            "randomValue": {
              "type": "string"
            },
            "aifactorySuffixRG": {
              "type": "string",
              "metadata": {
                "description": "AI Factory suffix for resource groups"
              }
            },
            "commonRGNamePrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Common resource group name prefix"
              }
            },
            "technicalAdminsObjectID": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "User Admins OID list"
              }
            },
            "technicalAdminsEmail": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "User Admins EMAIL list"
              }
            },
            "commonResourceGroupName": {
              "type": "string"
            },
            "subscriptionIdDevTestProd": {
              "type": "string"
            },
            "genaiSubnetId": {
              "type": "string"
            },
            "aksSubnetId": {
              "type": "string"
            },
            "aks2SubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "acaSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "aca2SubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "postGresAdminEmails": {
              "type": "string",
              "defaultValue": ""
            },
            "addAIFoundryHub": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Add AI Foundry Hub with random naming for debugging/testing"
              }
            },
            "addAzureMachineLearning": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Add Azure Machine Learning with random naming for debugging/testing"
              }
            }
          },
          "variables": {
            "projectName": "[format('prj{0}', parameters('projectNumber'))]",
            "cmnName": "cmn",
            "genaiName": "genai",
            "prjResourceSuffixNoDash": "[replace(parameters('resourceSuffix'), '-', '')]",
            "twoNumbers": "[substring(parameters('resourceSuffix'), 2, 2)]",
            "resourceSuffixPlusOne": "[format('-{0}', padLeft(string(add(int(substring(parameters('resourceSuffix'), 1, 3)), 1)), 3, '0'))]",
            "technicalAdminsObjectID_array": "[array(split(replace(parameters('technicalAdminsObjectID'), '\\s+', ''), ','))]",
            "p011_genai_team_lead_array": "[if(empty(parameters('technicalAdminsObjectID')), createArray(), union(variables('technicalAdminsObjectID_array'), createArray()))]",
            "postGresAdminEmailsLocal_array": "[array(split(replace(parameters('postGresAdminEmails'), '\\s+', ''), ','))]",
            "postGresAdminEmailsLocal": "[if(empty(parameters('postGresAdminEmails')), createArray(), union(variables('postGresAdminEmailsLocal_array'), createArray()))]",
            "technicalAdminsEmail_array": "[array(split(parameters('technicalAdminsEmail'), ','))]",
            "p011_genai_team_lead_email_array": "[if(empty(parameters('technicalAdminsEmail')), createArray(), variables('technicalAdminsEmail_array'))]",
            "randomSalt": "[if(or(empty(parameters('aifactorySalt10char')), lessOrEquals(length(parameters('aifactorySalt10char')), 5)), substring(parameters('randomValue'), 0, 10), parameters('aifactorySalt10char'))]",
            "uniqueInAIFenv": "[substring(uniqueString(subscriptionResourceId(parameters('subscriptionIdDevTestProd'), 'Microsoft.Resources/resourceGroups', parameters('commonResourceGroupName'))), 0, 5)]",
            "cleanRandomValue": "[toLower(replace(replace(variables('randomSalt'), '-', ''), '_', ''))]",
            "aifRandom": "[take(variables('cleanRandomValue'), 2)]",
            "aifWithRandom": "[take(format('aif-hub-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('aifRandom'), parameters('resourceSuffix')), 64)]",
            "aifV1HubName": "[if(parameters('addAIFoundryHub'), variables('aifWithRandom'), format('aif-hub-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix')))]",
            "aifV1ProjectName": "[format('aif-p-{0}-1-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "aifV2Name": "[take(replace(toLower(format('aif2{0}{1}', variables('uniqueInAIFenv'), variables('randomSalt'))), '-', ''), 12)]",
            "aifV2PrjName": "[take(replace(toLower(format('aif2p{0}{1}', variables('uniqueInAIFenv'), variables('randomSalt'))), '-', ''), 12)]",
            "aoaiName": "[format('aoai-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "amlWithRandom": "[take(format('aml-{0}-{1}-{2}-{3}{4}{5}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('aifRandom'), parameters('resourceSuffix')), 64)]",
            "amlName": "[if(parameters('addAzureMachineLearning'), variables('amlWithRandom'), format('aml-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix')))]",
            "safeNameAISearch": "[take(replace(toLower(format('aisearch{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('prjResourceSuffixNoDash'))), '-', ''), 64)]",
            "aiServicesName": "[take(replace(toLower(format('aiservices{0}{1}{2}{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), variables('prjResourceSuffixNoDash'))), '-', ''), 64)]",
            "dashboardInsightsName": "[format('AIFactory{0}-{1}-insights-{2}-{3}{4}', parameters('aifactorySuffixRG'), variables('projectName'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "applicationInsightName": "[format('ain-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "applicationInsightName2": "[format('ain-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('resourceSuffixPlusOne'))]",
            "bingName": "[format('bing-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppsEnvName": "[format('aca-env-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppAName": "[format('aca-a-{0}{1}{2}{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "containerAppWName": "[format('aca-w-{0}{1}{2}{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "cosmosDBName": "[format('cosmos-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "redisName": "[format('redis-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "postgreSQLName": "[format('pg-flex-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "sqlServerName": "[format('sql-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "sqlDBName": "[format('sqldb-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "functionAppName": "[format('func-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "webAppName": "[format('webapp-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "funcAppServicePlanName": "[format('func-{0}-{1}-{2}-{3}{4}-plan', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "webbAppServicePlanName": "[format('webapp-{0}-{1}-{2}-{3}{4}-plan', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "vmName": "[format('dsvm-{0}-{1}-{2}-{3}{4}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]",
            "keyvaultName": "[format('kv-p{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('twoNumbers'))]",
            "storageAccount1001Name": "[replace(format('sa{0}{1}{2}1{3}{4}', variables('projectName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), variables('prjResourceSuffixNoDash'), parameters('env')), '-', '')]",
            "storageAccount2001Name": "[replace(format('sa{0}{1}{2}2{3}{4}', variables('projectName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), variables('prjResourceSuffixNoDash'), parameters('env')), '-', '')]",
            "acrProjectName": "[format('acr{0}{1}{2}{3}{4}{5}', variables('projectName'), variables('genaiName'), parameters('locationSuffix'), variables('uniqueInAIFenv'), parameters('env'), variables('prjResourceSuffixNoDash'))]",
            "acrCommonName": "[replace(format('acrcommon{0}{1}{2}{3}', variables('uniqueInAIFenv'), parameters('locationSuffix'), parameters('commonResourceSuffix'), parameters('env')), '-', '')]",
            "miACAName": "[format('mi-aca-{0}-{1}-{2}-{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), parameters('resourceSuffix'))]",
            "miPrjName": "[format('mi-{0}-{1}-{2}-{3}{4}{5}', variables('projectName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), variables('randomSalt'), parameters('resourceSuffix'))]",
            "laWorkspaceName": "[format('la-{0}-{1}-{2}-{3}{4}', variables('cmnName'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]",
            "segments": "[split(parameters('genaiSubnetId'), '/')]",
            "genaiSubnetName": "[variables('segments')[sub(length(variables('segments')), 1)]]",
            "defaultSubnet": "[variables('genaiSubnetName')]",
            "segmentsAKS": "[split(parameters('aksSubnetId'), '/')]",
            "segmentsAKS2": "[split(parameters('aks2SubnetId'), '/')]",
            "aksSubnetName": "[variables('segmentsAKS')[sub(length(variables('segmentsAKS')), 1)]]",
            "aks2SubnetName": "[variables('segmentsAKS2')[sub(length(variables('segmentsAKS2')), 1)]]",
            "segmentsACA": "[split(parameters('acaSubnetId'), '/')]",
            "segmentsACA2": "[split(parameters('aca2SubnetId'), '/')]",
            "acaSubnetName": "[variables('segmentsACA')[sub(length(variables('segmentsACA')), 1)]]",
            "aca2SubnetName": "[variables('segmentsACA2')[sub(length(variables('segmentsACA2')), 1)]]",
            "adfName": "[format('adf-{0}-{1}-{2}-{3}{4}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'), variables('uniqueInAIFenv'), parameters('resourceSuffix'))]"
          },
          "resources": {
            "commonResourceGroupRef": {
              "existing": true,
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2024-07-01",
              "subscriptionId": "[parameters('subscriptionIdDevTestProd')]",
              "name": "[parameters('commonResourceGroupName')]"
            }
          },
          "outputs": {
            "genaiSubnetName": {
              "type": "string",
              "value": "[variables('genaiSubnetName')]"
            },
            "aksSubnetName": {
              "type": "string",
              "value": "[variables('aksSubnetName')]"
            },
            "aks2SubnetName": {
              "type": "string",
              "value": "[variables('aks2SubnetName')]"
            },
            "acaSubnetName": {
              "type": "string",
              "value": "[variables('acaSubnetName')]"
            },
            "aca2SubnetName": {
              "type": "string",
              "value": "[variables('aca2SubnetName')]"
            },
            "defaultSubnet": {
              "type": "string",
              "value": "[variables('defaultSubnet')]"
            },
            "aoaiName": {
              "type": "string",
              "value": "[variables('aoaiName')]"
            },
            "amlName": {
              "type": "string",
              "value": "[variables('amlName')]"
            },
            "safeNameAISearch": {
              "type": "string",
              "value": "[variables('safeNameAISearch')]"
            },
            "aiServicesName": {
              "type": "string",
              "value": "[variables('aiServicesName')]"
            },
            "dashboardInsightsName": {
              "type": "string",
              "value": "[variables('dashboardInsightsName')]"
            },
            "applicationInsightName": {
              "type": "string",
              "value": "[variables('applicationInsightName')]"
            },
            "applicationInsightName2": {
              "type": "string",
              "value": "[variables('applicationInsightName2')]"
            },
            "bingName": {
              "type": "string",
              "value": "[variables('bingName')]"
            },
            "containerAppsEnvName": {
              "type": "string",
              "value": "[variables('containerAppsEnvName')]"
            },
            "containerAppAName": {
              "type": "string",
              "value": "[variables('containerAppAName')]"
            },
            "containerAppWName": {
              "type": "string",
              "value": "[variables('containerAppWName')]"
            },
            "cosmosDBName": {
              "type": "string",
              "value": "[variables('cosmosDBName')]"
            },
            "redisName": {
              "type": "string",
              "value": "[variables('redisName')]"
            },
            "postgreSQLName": {
              "type": "string",
              "value": "[variables('postgreSQLName')]"
            },
            "sqlServerName": {
              "type": "string",
              "value": "[variables('sqlServerName')]"
            },
            "sqlDBName": {
              "type": "string",
              "value": "[variables('sqlDBName')]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[variables('functionAppName')]"
            },
            "webAppName": {
              "type": "string",
              "value": "[variables('webAppName')]"
            },
            "funcAppServicePlanName": {
              "type": "string",
              "value": "[variables('funcAppServicePlanName')]"
            },
            "webbAppServicePlanName": {
              "type": "string",
              "value": "[variables('webbAppServicePlanName')]"
            },
            "vmName": {
              "type": "string",
              "value": "[variables('vmName')]"
            },
            "aifV1HubName": {
              "type": "string",
              "value": "[variables('aifV1HubName')]"
            },
            "aifV1ProjectName": {
              "type": "string",
              "value": "[variables('aifV1ProjectName')]"
            },
            "aifV2Name": {
              "type": "string",
              "value": "[variables('aifV2Name')]"
            },
            "aifV2PrjName": {
              "type": "string",
              "value": "[variables('aifV2PrjName')]"
            },
            "keyvaultName": {
              "type": "string",
              "value": "[variables('keyvaultName')]"
            },
            "storageAccount1001Name": {
              "type": "string",
              "value": "[variables('storageAccount1001Name')]"
            },
            "storageAccount2001Name": {
              "type": "string",
              "value": "[variables('storageAccount2001Name')]"
            },
            "acrProjectName": {
              "type": "string",
              "value": "[variables('acrProjectName')]"
            },
            "acrCommonName": {
              "type": "string",
              "value": "[variables('acrCommonName')]"
            },
            "miACAName": {
              "type": "string",
              "value": "[variables('miACAName')]"
            },
            "miPrjName": {
              "type": "string",
              "value": "[variables('miPrjName')]"
            },
            "laWorkspaceName": {
              "type": "string",
              "value": "[variables('laWorkspaceName')]"
            },
            "projectName": {
              "type": "string",
              "value": "[variables('projectName')]"
            },
            "cmnName": {
              "type": "string",
              "value": "[variables('cmnName')]"
            },
            "kvNameCommon": {
              "type": "string",
              "value": "[format('kv-{0}{1}-{2}{3}', variables('cmnName'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]"
            },
            "genaiName": {
              "type": "string",
              "value": "[variables('genaiName')]"
            },
            "prjResourceSuffixNoDash": {
              "type": "string",
              "value": "[variables('prjResourceSuffixNoDash')]"
            },
            "twoNumbers": {
              "type": "string",
              "value": "[variables('twoNumbers')]"
            },
            "p011_genai_team_lead_array": {
              "type": "array",
              "value": "[variables('p011_genai_team_lead_array')]"
            },
            "postGresAdminEmails": {
              "type": "array",
              "value": "[variables('postGresAdminEmailsLocal')]"
            },
            "p011_genai_team_lead_email_array": {
              "type": "array",
              "value": "[variables('p011_genai_team_lead_email_array')]"
            },
            "uniqueInAIFenv": {
              "type": "string",
              "value": "[variables('uniqueInAIFenv')]"
            },
            "randomSalt": {
              "type": "string",
              "value": "[variables('randomSalt')]"
            },
            "projectTypeESMLName": {
              "type": "string",
              "value": "esml"
            },
            "projectTypeGenAIName": {
              "type": "string",
              "value": "genai"
            },
            "aksClusterName": {
              "type": "string",
              "value": "[format('esml{0}-{1}-{2}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'))]"
            },
            "dataFactoryName": {
              "type": "string",
              "value": "[variables('adfName')]"
            },
            "namingConvention": {
              "$ref": "#/definitions/aifactoryNamingType",
              "value": {
                "genaiSubnetName": "[variables('genaiSubnetName')]",
                "aksSubnetName": "[variables('aksSubnetName')]",
                "aks2SubnetName": "[variables('aks2SubnetName')]",
                "acaSubnetName": "[variables('acaSubnetName')]",
                "aca2SubnetName": "[variables('aca2SubnetName')]",
                "defaultSubnet": "[variables('defaultSubnet')]",
                "aifV1HubName": "[variables('aifV1HubName')]",
                "aifV1ProjectName": "[variables('aifV1ProjectName')]",
                "aifV2Name": "[variables('aifV2Name')]",
                "aifV2PrjName": "[variables('aifV2PrjName')]",
                "aoaiName": "[variables('aoaiName')]",
                "amlName": "[variables('amlName')]",
                "safeNameAISearch": "[variables('safeNameAISearch')]",
                "aiServicesName": "[variables('aiServicesName')]",
                "dashboardInsightsName": "[variables('dashboardInsightsName')]",
                "applicationInsightName": "[variables('applicationInsightName')]",
                "applicationInsightName2": "[variables('applicationInsightName2')]",
                "bingName": "[variables('bingName')]",
                "containerAppsEnvName": "[variables('containerAppsEnvName')]",
                "containerAppAName": "[variables('containerAppAName')]",
                "containerAppWName": "[variables('containerAppWName')]",
                "cosmosDBName": "[variables('cosmosDBName')]",
                "redisName": "[variables('redisName')]",
                "postgreSQLName": "[variables('postgreSQLName')]",
                "sqlServerName": "[variables('sqlServerName')]",
                "sqlDBName": "[variables('sqlDBName')]",
                "functionAppName": "[variables('functionAppName')]",
                "webAppName": "[variables('webAppName')]",
                "funcAppServicePlanName": "[variables('funcAppServicePlanName')]",
                "webbAppServicePlanName": "[variables('webbAppServicePlanName')]",
                "vmName": "[variables('vmName')]",
                "keyvaultName": "[variables('keyvaultName')]",
                "storageAccount1001Name": "[variables('storageAccount1001Name')]",
                "storageAccount2001Name": "[variables('storageAccount2001Name')]",
                "acrProjectName": "[variables('acrProjectName')]",
                "acrCommonName": "[variables('acrCommonName')]",
                "miACAName": "[variables('miACAName')]",
                "miPrjName": "[variables('miPrjName')]",
                "laWorkspaceName": "[variables('laWorkspaceName')]",
                "projectName": "[variables('projectName')]",
                "cmnName": "[variables('cmnName')]",
                "kvNameCommon": "[format('kv-{0}{1}-{2}{3}', variables('cmnName'), parameters('env'), variables('uniqueInAIFenv'), parameters('commonResourceSuffix'))]",
                "genaiName": "[variables('genaiName')]",
                "prjResourceSuffixNoDash": "[variables('prjResourceSuffixNoDash')]",
                "twoNumbers": "[variables('twoNumbers')]",
                "p011_genai_team_lead_array": "[variables('p011_genai_team_lead_array')]",
                "p011_genai_team_lead_email_array": "[variables('p011_genai_team_lead_email_array')]",
                "uniqueInAIFenv": "[variables('uniqueInAIFenv')]",
                "randomSalt": "[variables('randomSalt')]",
                "projectTypeESMLName": "esml",
                "projectTypeGenAIName": "genai",
                "aksClusterName": "[format('esml{0}-{1}-{2}', parameters('projectNumber'), parameters('locationSuffix'), parameters('env'))]",
                "dataFactoryName": "[variables('adfName')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)]",
      "subscriptionId": "[variables('resolvedSubscriptionId')]",
      "resourceGroup": "[variables('resolvedTargetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "privDnsResourceGroupName": {
            "value": "[variables('resolvedPrivDnsResourceGroup')]"
          },
          "privDnsSubscription": {
            "value": "[variables('resolvedPrivDnsSubscription')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5482015564862547528"
            }
          },
          "parameters": {
            "privDnsSubscription": {
              "type": "string"
            },
            "privDnsResourceGroupName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "variables": {
            "privateDnsZoneName": {
              "azureusgovernment": "privatelink.api.ml.azure.us",
              "azurechinacloud": "privatelink.api.ml.azure.cn",
              "azurecloud": "privatelink.api.azureml.ms"
            },
            "privateAznbDnsZoneName": {
              "azureusgovernment": "privatelink.notebooks.usgovcloudapi.net",
              "azurechinacloud": "privatelink.notebooks.chinacloudapi.cn",
              "azurecloud": "privatelink.notebooks.azure.net"
            },
            "privateLinksDnsZones": {
              "blob": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.blob.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.blob.{0}', environment().suffixes.storage)]"
              },
              "file": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.file.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.file.{0}', environment().suffixes.storage)]"
              },
              "dfs": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.dfs.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.dfs.{0}', environment().suffixes.storage)]"
              },
              "queue": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.queue.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.queue.{0}', environment().suffixes.storage)]"
              },
              "table": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.table.{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), environment().suffixes.storage)]",
                "name": "[format('privatelink.table.{0}', environment().suffixes.storage)]"
              },
              "registry": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azurecr.io', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azurecr.io"
              },
              "registryregion": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/{2}.data.privatelink.azurecr.io', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), parameters('location'))]",
                "name": "[format('{0}.data.privatelink.azurecr.io', parameters('location'))]"
              },
              "vault": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.vaultcore.azure.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.vaultcore.azure.net"
              },
              "amlworkspace": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), variables('privateDnsZoneName')[toLower(environment().name)])]",
                "name": "[variables('privateDnsZoneName')[toLower(environment().name)]]"
              },
              "notebooks": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/{2}', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), variables('privateAznbDnsZoneName')[toLower(environment().name)])]",
                "name": "[variables('privateAznbDnsZoneName')[toLower(environment().name)]]"
              },
              "dataFactory": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.datafactory.azure.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.datafactory.azure.net"
              },
              "portal": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.adf.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.adf.azure.com"
              },
              "openai": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.openai.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.openai.azure.com"
              },
              "searchService": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.search.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.search.windows.net"
              },
              "azurewebapps": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azurewebsites.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azurewebsites.net"
              },
              "cosmosdbnosql": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.documents.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.documents.azure.com"
              },
              "cognitiveservices": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.cognitiveservices.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.cognitiveservices.azure.com"
              },
              "azuredatabricks": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azuredatabricks.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azuredatabricks.net"
              },
              "namespace": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.servicebus.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.servicebus.windows.net"
              },
              "azureeventgrid": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.eventgrid.azure.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.eventgrid.azure.net"
              },
              "azuremonitor": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.monitor.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.monitor.azure.com"
              },
              "azuremonitoroms": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.oms.opinsights.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.oms.opinsights.azure.com"
              },
              "azuremonitorods": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.ods.opinsights.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.ods.opinsights.azure.com"
              },
              "azuremonitoragentsvc": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.agentsvc.azure-automation.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.agentsvc.azure-automation.net"
              },
              "servicesai": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.services.ai.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.services.ai.azure.com"
              },
              "azurecontainerapps": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.{2}.azurecontainerapps.io', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'), parameters('location'))]",
                "name": "[format('privatelink.{0}.azurecontainerapps.io', parameters('location'))]"
              },
              "redis": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.redis.cache.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.redis.cache.windows.net"
              },
              "postgres": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.postgres.database.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.postgres.database.azure.com"
              },
              "sql": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.database.windows.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.database.windows.net"
              },
              "cosmosdbmongo": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.mongo.cosmos.azure.com', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.mongo.cosmos.azure.com"
              },
              "apim": {
                "id": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/privateDnsZones/privatelink.azure-api.net', parameters('privDnsSubscription'), parameters('privDnsResourceGroupName'))]",
                "name": "privatelink.azure-api.net"
              }
            }
          },
          "resources": [],
          "outputs": {
            "privateLinksDnsZones": {
              "type": "object",
              "value": "[variables('privateLinksDnsZones')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[take(format('foundry-apim-{0}', variables('moduleDeploymentSuffix')), 64)]",
      "subscriptionId": "[variables('resolvedSubscriptionId')]",
      "resourceGroup": "[variables('resolvedTargetResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "existingVnetResourceId": {
            "value": "[variables('resolvedExistingVnetResourceId')]"
          },
          "vnetName": {
            "value": "[variables('resolvedVnetName')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('vnetAddressPrefix')]"
          },
          "agentSubnetName": {
            "value": "[variables('resolvedAgentSubnetName')]"
          },
          "peSubnetName": {
            "value": "[variables('resolvedPeSubnetName')]"
          },
          "agentSubnetPrefix": {
            "value": "[parameters('agentSubnetPrefix')]"
          },
          "peSubnetPrefix": {
            "value": "[parameters('peSubnetPrefix')]"
          },
          "aiSearchResourceId": "[if(not(empty(trim(parameters('aiSearchResourceId')))), createObject('value', parameters('aiSearchResourceId')), if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value)), createObject('value', resourceId(variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup'), 'Microsoft.Search/searchServices', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.safeNameAISearch.value)), createObject('value', '')))]",
          "azureStorageAccountResourceId": "[if(not(empty(trim(parameters('azureStorageAccountResourceId')))), createObject('value', parameters('azureStorageAccountResourceId')), if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value)), createObject('value', resourceId(variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup'), 'Microsoft.Storage/storageAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.storageAccount1001Name.value)), createObject('value', '')))]",
          "azureCosmosDBAccountResourceId": "[if(not(empty(trim(parameters('azureCosmosDBAccountResourceId')))), createObject('value', parameters('azureCosmosDBAccountResourceId')), if(not(empty(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value)), createObject('value', resourceId(variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.cosmosDBName.value)), createObject('value', '')))]",
          "apiManagementResourceId": {
            "value": "[parameters('apiManagementResourceId')]"
          },
          "existingDnsZones": "[if(not(empty(trim(parameters('existingDnsZones')))), createObject('value', json(parameters('existingDnsZones'))), createObject('value', createObject(format('{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.servicesai.name), variables('resolvedPrivDnsResourceGroup'), format('{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.openai.name), variables('resolvedPrivDnsResourceGroup'), format('{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.cognitiveservices.name), variables('resolvedPrivDnsResourceGroup'), format('{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.searchService.name), variables('resolvedPrivDnsResourceGroup'), format('{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.blob.name), variables('resolvedPrivDnsResourceGroup'), format('{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.cosmosdbnosql.name), variables('resolvedPrivDnsResourceGroup'), format('{0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.apim.name), variables('resolvedPrivDnsResourceGroup'))))]",
          "dnsZoneNames": "[if(not(empty(trim(parameters('dnsZoneNames')))), createObject('value', json(parameters('dnsZoneNames'))), createObject('value', createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.servicesai.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.openai.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.cognitiveservices.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.searchService.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.blob.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.cosmosdbnosql.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64)), '2022-09-01').outputs.privateLinksDnsZones.value.apim.name)))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "3367892518241028443"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "eastus2",
              "allowedValues": [
                "westus",
                "eastus",
                "eastus2",
                "japaneast",
                "francecentral",
                "spaincentral",
                "uaenorth",
                "southcentralus",
                "italynorth",
                "germanywestcentral",
                "brazilsouth",
                "southafricanorth",
                "australiaeast",
                "swedencentral",
                "canadaeast",
                "westeurope",
                "westus3",
                "uksouth",
                "southindia",
                "koreacentral",
                "polandcentral",
                "switzerlandnorth",
                "norwayeast"
              ],
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "aiServices": {
              "type": "string",
              "defaultValue": "aiservices",
              "metadata": {
                "description": "Name for your AI Services resource."
              }
            },
            "modelName": {
              "type": "string",
              "defaultValue": "gpt-4o",
              "metadata": {
                "description": "The name of the model you want to deploy"
              }
            },
            "modelFormat": {
              "type": "string",
              "defaultValue": "OpenAI",
              "metadata": {
                "description": "The provider of your model"
              }
            },
            "modelVersion": {
              "type": "string",
              "defaultValue": "2024-11-20",
              "metadata": {
                "description": "The version of your model"
              }
            },
            "modelSkuName": {
              "type": "string",
              "defaultValue": "GlobalStandard",
              "metadata": {
                "description": "The sku of your model deployment"
              }
            },
            "modelCapacity": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "The tokens per minute (TPM) of your model deployment"
              }
            },
            "deploymentTimestamp": {
              "type": "string",
              "defaultValue": "[utcNow('yyyyMMddHHmmss')]"
            },
            "firstProjectName": {
              "type": "string",
              "defaultValue": "project",
              "metadata": {
                "description": "Name for your project resource."
              }
            },
            "projectDescription": {
              "type": "string",
              "defaultValue": "A project for the AI Foundry account with network secured deployed Agent",
              "metadata": {
                "description": "This project will be a sub-resource of your account"
              }
            },
            "displayName": {
              "type": "string",
              "defaultValue": "network secured agent project",
              "metadata": {
                "description": "The display name of the project"
              }
            },
            "vnetName": {
              "type": "string",
              "defaultValue": "agent-vnet-test",
              "metadata": {
                "description": "Virtual Network name for the Agent to create new or existing virtual network"
              }
            },
            "agentSubnetName": {
              "type": "string",
              "defaultValue": "agent-subnet",
              "metadata": {
                "description": "The name of Agents Subnet to create new or existing subnet for agents"
              }
            },
            "peSubnetName": {
              "type": "string",
              "defaultValue": "pe-subnet",
              "metadata": {
                "description": "The name of Private Endpoint subnet to create new or existing subnet for private endpoints"
              }
            },
            "existingVnetResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Existing Virtual Network name Resource ID"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Address space for the VNet (only used for new VNet)"
              }
            },
            "agentSubnetPrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Address prefix for the agent subnet. The default value is 192.168.0.0/24 but you can choose any size /26 or any class like 10.0.0.0 or 172.168.0.0"
              }
            },
            "peSubnetPrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Address prefix for the private endpoint subnet"
              }
            },
            "aiSearchResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The AI Search Service full ARM Resource ID. This is an optional field, and if not provided, the resource will be created."
              }
            },
            "azureStorageAccountResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The AI Storage Account full ARM Resource ID. This is an optional field, and if not provided, the resource will be created."
              }
            },
            "azureCosmosDBAccountResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The Cosmos DB Account full ARM Resource ID. This is an optional field, and if not provided, the resource will be created."
              }
            },
            "apiManagementResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The API Management Service full ARM Resource ID. This is an optional field for existing API Management services."
              }
            },
            "existingDnsZones": {
              "type": "object",
              "defaultValue": {
                "privatelink.services.ai.azure.com": "",
                "privatelink.openai.azure.com": "",
                "privatelink.cognitiveservices.azure.com": "",
                "privatelink.search.windows.net": "",
                "privatelink.blob.core.windows.net": "",
                "privatelink.documents.azure.com": "",
                "privatelink.azure-api.net": ""
              },
              "metadata": {
                "description": "Object mapping DNS zone names to their resource group, or empty string to indicate creation"
              }
            },
            "dnsZoneNames": {
              "type": "array",
              "defaultValue": [
                "privatelink.services.ai.azure.com",
                "privatelink.openai.azure.com",
                "privatelink.cognitiveservices.azure.com",
                "privatelink.search.windows.net",
                "privatelink.blob.core.windows.net",
                "privatelink.documents.azure.com",
                "privatelink.azure-api.net"
              ],
              "metadata": {
                "description": "Zone Names for Validation of existing Private Dns Zones"
              }
            },
            "projectCapHost": {
              "type": "string",
              "defaultValue": "caphostproj",
              "metadata": {
                "description": "The name of the project capability host to be created"
              }
            }
          },
          "variables": {
            "uniqueSuffix": "[substring(uniqueString(format('{0}-{1}', resourceGroup().id, parameters('deploymentTimestamp'))), 0, 4)]",
            "accountName": "[toLower(format('{0}{1}', parameters('aiServices'), variables('uniqueSuffix')))]",
            "projectName": "[toLower(format('{0}{1}', parameters('firstProjectName'), variables('uniqueSuffix')))]",
            "cosmosDBName": "[toLower(format('{0}{1}cosmosdb', parameters('aiServices'), variables('uniqueSuffix')))]",
            "aiSearchName": "[toLower(format('{0}{1}search', parameters('aiServices'), variables('uniqueSuffix')))]",
            "azureStorageName": "[toLower(format('{0}{1}storage', parameters('aiServices'), variables('uniqueSuffix')))]",
            "storagePassedIn": "[not(equals(parameters('azureStorageAccountResourceId'), ''))]",
            "searchPassedIn": "[not(equals(parameters('aiSearchResourceId'), ''))]",
            "cosmosPassedIn": "[not(equals(parameters('azureCosmosDBAccountResourceId'), ''))]",
            "existingVnetPassedIn": "[not(equals(parameters('existingVnetResourceId'), ''))]",
            "acsParts": "[split(parameters('aiSearchResourceId'), '/')]",
            "aiSearchServiceSubscriptionId": "[if(variables('searchPassedIn'), variables('acsParts')[2], subscription().subscriptionId)]",
            "aiSearchServiceResourceGroupName": "[if(variables('searchPassedIn'), variables('acsParts')[4], resourceGroup().name)]",
            "cosmosParts": "[split(parameters('azureCosmosDBAccountResourceId'), '/')]",
            "cosmosDBSubscriptionId": "[if(variables('cosmosPassedIn'), variables('cosmosParts')[2], subscription().subscriptionId)]",
            "cosmosDBResourceGroupName": "[if(variables('cosmosPassedIn'), variables('cosmosParts')[4], resourceGroup().name)]",
            "storageParts": "[split(parameters('azureStorageAccountResourceId'), '/')]",
            "azureStorageSubscriptionId": "[if(variables('storagePassedIn'), variables('storageParts')[2], subscription().subscriptionId)]",
            "azureStorageResourceGroupName": "[if(variables('storagePassedIn'), variables('storageParts')[4], resourceGroup().name)]",
            "vnetParts": "[split(parameters('existingVnetResourceId'), '/')]",
            "vnetSubscriptionId": "[if(variables('existingVnetPassedIn'), variables('vnetParts')[2], subscription().subscriptionId)]",
            "vnetResourceGroupName": "[if(variables('existingVnetPassedIn'), variables('vnetParts')[4], resourceGroup().name)]",
            "existingVnetName": "[if(variables('existingVnetPassedIn'), last(variables('vnetParts')), parameters('vnetName'))]",
            "trimVnetName": "[trim(variables('existingVnetName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "vnetName": {
                    "value": "[variables('trimVnetName')]"
                  },
                  "useExistingVnet": {
                    "value": "[variables('existingVnetPassedIn')]"
                  },
                  "existingVnetResourceGroupName": {
                    "value": "[variables('vnetResourceGroupName')]"
                  },
                  "agentSubnetName": {
                    "value": "[parameters('agentSubnetName')]"
                  },
                  "peSubnetName": {
                    "value": "[parameters('peSubnetName')]"
                  },
                  "vnetAddressPrefix": {
                    "value": "[parameters('vnetAddressPrefix')]"
                  },
                  "agentSubnetPrefix": {
                    "value": "[parameters('agentSubnetPrefix')]"
                  },
                  "peSubnetPrefix": {
                    "value": "[parameters('peSubnetPrefix')]"
                  },
                  "existingVnetSubscriptionId": {
                    "value": "[variables('vnetSubscriptionId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "10919077993927687050"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for the deployment"
                      }
                    },
                    "vnetName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the virtual network"
                      }
                    },
                    "useExistingVnet": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Indicates if an existing VNet should be used"
                      }
                    },
                    "existingVnetSubscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Subscription ID of the existing VNet (if different from current subscription)"
                      }
                    },
                    "existingVnetResourceGroupName": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Resource Group name of the existing VNet (if different from current resource group)"
                      }
                    },
                    "agentSubnetName": {
                      "type": "string",
                      "defaultValue": "agent-subnet",
                      "metadata": {
                        "description": "The name of Agents Subnet"
                      }
                    },
                    "peSubnetName": {
                      "type": "string",
                      "defaultValue": "pe-subnet",
                      "metadata": {
                        "description": "The name of Private Endpoint subnet"
                      }
                    },
                    "vnetAddressPrefix": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Address space for the VNet (only used for new VNet)"
                      }
                    },
                    "agentSubnetPrefix": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Address prefix for the agent subnet"
                      }
                    },
                    "peSubnetPrefix": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Address prefix for the private endpoint subnet"
                      }
                    }
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('useExistingVnet'))]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "vnet-deployment",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "vnetName": {
                            "value": "[parameters('vnetName')]"
                          },
                          "agentSubnetName": {
                            "value": "[parameters('agentSubnetName')]"
                          },
                          "peSubnetName": {
                            "value": "[parameters('peSubnetName')]"
                          },
                          "vnetAddressPrefix": {
                            "value": "[parameters('vnetAddressPrefix')]"
                          },
                          "agentSubnetPrefix": {
                            "value": "[parameters('agentSubnetPrefix')]"
                          },
                          "peSubnetPrefix": {
                            "value": "[parameters('peSubnetPrefix')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.37.4.10188",
                              "templateHash": "7085351233854231162"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string",
                              "metadata": {
                                "description": "Azure region for the deployment"
                              }
                            },
                            "vnetName": {
                              "type": "string",
                              "defaultValue": "agents-vnet-test",
                              "metadata": {
                                "description": "The name of the virtual network"
                              }
                            },
                            "agentSubnetName": {
                              "type": "string",
                              "defaultValue": "agent-subnet",
                              "metadata": {
                                "description": "The name of Agents Subnet"
                              }
                            },
                            "peSubnetName": {
                              "type": "string",
                              "defaultValue": "pe-subnet",
                              "metadata": {
                                "description": "The name of Hub subnet"
                              }
                            },
                            "vnetAddressPrefix": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "Address space for the VNet"
                              }
                            },
                            "agentSubnetPrefix": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "Address prefix for the agent subnet"
                              }
                            },
                            "peSubnetPrefix": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "Address prefix for the private endpoint subnet"
                              }
                            }
                          },
                          "variables": {
                            "defaultVnetAddressPrefix": "192.168.0.0/16",
                            "vnetAddress": "[if(empty(parameters('vnetAddressPrefix')), variables('defaultVnetAddressPrefix'), parameters('vnetAddressPrefix'))]",
                            "agentSubnet": "[if(empty(parameters('agentSubnetPrefix')), cidrSubnet(variables('vnetAddress'), 24, 0), parameters('agentSubnetPrefix'))]",
                            "peSubnet": "[if(empty(parameters('peSubnetPrefix')), cidrSubnet(variables('vnetAddress'), 24, 1), parameters('peSubnetPrefix'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/virtualNetworks",
                              "apiVersion": "2024-05-01",
                              "name": "[parameters('vnetName')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "addressSpace": {
                                  "addressPrefixes": [
                                    "[variables('vnetAddress')]"
                                  ]
                                },
                                "subnets": [
                                  {
                                    "name": "[parameters('agentSubnetName')]",
                                    "properties": {
                                      "addressPrefix": "[variables('agentSubnet')]",
                                      "delegations": [
                                        {
                                          "name": "Microsoft.app/environments",
                                          "properties": {
                                            "serviceName": "Microsoft.App/environments"
                                          }
                                        }
                                      ]
                                    }
                                  },
                                  {
                                    "name": "[parameters('peSubnetName')]",
                                    "properties": {
                                      "addressPrefix": "[variables('peSubnet')]"
                                    }
                                  }
                                ]
                              }
                            }
                          ],
                          "outputs": {
                            "peSubnetName": {
                              "type": "string",
                              "value": "[parameters('peSubnetName')]"
                            },
                            "agentSubnetName": {
                              "type": "string",
                              "value": "[parameters('agentSubnetName')]"
                            },
                            "agentSubnetId": {
                              "type": "string",
                              "value": "[format('{0}/subnets/{1}', resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), parameters('agentSubnetName'))]"
                            },
                            "peSubnetId": {
                              "type": "string",
                              "value": "[format('{0}/subnets/{1}', resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), parameters('peSubnetName'))]"
                            },
                            "virtualNetworkName": {
                              "type": "string",
                              "value": "[parameters('vnetName')]"
                            },
                            "virtualNetworkId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                            },
                            "virtualNetworkResourceGroup": {
                              "type": "string",
                              "value": "[resourceGroup().name]"
                            },
                            "virtualNetworkSubscriptionId": {
                              "type": "string",
                              "value": "[subscription().subscriptionId]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "condition": "[parameters('useExistingVnet')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "existing-vnet-deployment",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "vnetName": {
                            "value": "[parameters('vnetName')]"
                          },
                          "vnetResourceGroupName": {
                            "value": "[parameters('existingVnetResourceGroupName')]"
                          },
                          "vnetSubscriptionId": {
                            "value": "[parameters('existingVnetSubscriptionId')]"
                          },
                          "agentSubnetName": {
                            "value": "[parameters('agentSubnetName')]"
                          },
                          "peSubnetName": {
                            "value": "[parameters('peSubnetName')]"
                          },
                          "agentSubnetPrefix": {
                            "value": "[parameters('agentSubnetPrefix')]"
                          },
                          "peSubnetPrefix": {
                            "value": "[parameters('peSubnetPrefix')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.37.4.10188",
                              "templateHash": "13730000354097581091"
                            }
                          },
                          "parameters": {
                            "vnetName": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the existing virtual network"
                              }
                            },
                            "vnetSubscriptionId": {
                              "type": "string",
                              "defaultValue": "[subscription().subscriptionId]",
                              "metadata": {
                                "description": "Subscription ID of virtual network (if different from current subscription)"
                              }
                            },
                            "vnetResourceGroupName": {
                              "type": "string",
                              "defaultValue": "[resourceGroup().name]",
                              "metadata": {
                                "description": "Resource Group name of the existing VNet (if different from current resource group)"
                              }
                            },
                            "agentSubnetName": {
                              "type": "string",
                              "defaultValue": "agent-subnet",
                              "metadata": {
                                "description": "The name of Agents Subnet"
                              }
                            },
                            "peSubnetName": {
                              "type": "string",
                              "defaultValue": "pe-subnet",
                              "metadata": {
                                "description": "The name of Private Endpoint subnet"
                              }
                            },
                            "agentSubnetPrefix": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "Address prefix for the agent subnet (only needed if creating new subnet)"
                              }
                            },
                            "peSubnetPrefix": {
                              "type": "string",
                              "defaultValue": "",
                              "metadata": {
                                "description": "Address prefix for the private endpoint subnet (only needed if creating new subnet)"
                              }
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('agent-subnet-{0}', uniqueString(deployment().name, parameters('agentSubnetName')))]",
                              "resourceGroup": "[parameters('vnetResourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "vnetName": {
                                    "value": "[parameters('vnetName')]"
                                  },
                                  "subnetName": {
                                    "value": "[parameters('agentSubnetName')]"
                                  },
                                  "addressPrefix": "[if(empty(parameters('agentSubnetPrefix')), createObject('value', cidrSubnet(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')), '2024-05-01').addressSpace.addressPrefixes[0], 24, 0)), createObject('value', parameters('agentSubnetPrefix')))]",
                                  "delegations": {
                                    "value": [
                                      {
                                        "name": "Microsoft.App/environments",
                                        "properties": {
                                          "serviceName": "Microsoft.App/environments"
                                        }
                                      }
                                    ]
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.37.4.10188",
                                      "templateHash": "5406780699922367374"
                                    }
                                  },
                                  "parameters": {
                                    "vnetName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Name of the virtual network"
                                      }
                                    },
                                    "subnetName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Name of the subnet"
                                      }
                                    },
                                    "addressPrefix": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Address prefix for the subnet"
                                      }
                                    },
                                    "delegations": {
                                      "type": "array",
                                      "defaultValue": [],
                                      "metadata": {
                                        "description": "Array of subnet delegations"
                                      }
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/virtualNetworks/subnets",
                                      "apiVersion": "2024-05-01",
                                      "name": "[format('{0}/{1}', parameters('vnetName'), parameters('subnetName'))]",
                                      "properties": {
                                        "addressPrefix": "[parameters('addressPrefix')]",
                                        "delegations": "[parameters('delegations')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "subnetId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('vnetName'), parameters('subnetName')), '/')[0], split(format('{0}/{1}', parameters('vnetName'), parameters('subnetName')), '/')[1])]"
                                    },
                                    "subnetName": {
                                      "type": "string",
                                      "value": "[parameters('subnetName')]"
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('pe-subnet-{0}', uniqueString(deployment().name, parameters('peSubnetName')))]",
                              "resourceGroup": "[parameters('vnetResourceGroupName')]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "vnetName": {
                                    "value": "[parameters('vnetName')]"
                                  },
                                  "subnetName": {
                                    "value": "[parameters('peSubnetName')]"
                                  },
                                  "addressPrefix": "[if(empty(parameters('peSubnetPrefix')), createObject('value', cidrSubnet(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')), '2024-05-01').addressSpace.addressPrefixes[0], 24, 1)), createObject('value', parameters('peSubnetPrefix')))]",
                                  "delegations": {
                                    "value": []
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.37.4.10188",
                                      "templateHash": "5406780699922367374"
                                    }
                                  },
                                  "parameters": {
                                    "vnetName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Name of the virtual network"
                                      }
                                    },
                                    "subnetName": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Name of the subnet"
                                      }
                                    },
                                    "addressPrefix": {
                                      "type": "string",
                                      "metadata": {
                                        "description": "Address prefix for the subnet"
                                      }
                                    },
                                    "delegations": {
                                      "type": "array",
                                      "defaultValue": [],
                                      "metadata": {
                                        "description": "Array of subnet delegations"
                                      }
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Network/virtualNetworks/subnets",
                                      "apiVersion": "2024-05-01",
                                      "name": "[format('{0}/{1}', parameters('vnetName'), parameters('subnetName'))]",
                                      "properties": {
                                        "addressPrefix": "[parameters('addressPrefix')]",
                                        "delegations": "[parameters('delegations')]"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "subnetId": {
                                      "type": "string",
                                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('vnetName'), parameters('subnetName')), '/')[0], split(format('{0}/{1}', parameters('vnetName'), parameters('subnetName')), '/')[1])]"
                                    },
                                    "subnetName": {
                                      "type": "string",
                                      "value": "[parameters('subnetName')]"
                                    }
                                  }
                                }
                              }
                            }
                          ],
                          "outputs": {
                            "peSubnetName": {
                              "type": "string",
                              "value": "[parameters('peSubnetName')]"
                            },
                            "agentSubnetName": {
                              "type": "string",
                              "value": "[parameters('agentSubnetName')]"
                            },
                            "agentSubnetId": {
                              "type": "string",
                              "value": "[format('{0}/subnets/{1}', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')), parameters('agentSubnetName'))]"
                            },
                            "peSubnetId": {
                              "type": "string",
                              "value": "[format('{0}/subnets/{1}', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')), parameters('peSubnetName'))]"
                            },
                            "virtualNetworkName": {
                              "type": "string",
                              "value": "[parameters('vnetName')]"
                            },
                            "virtualNetworkId": {
                              "type": "string",
                              "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                            },
                            "virtualNetworkResourceGroup": {
                              "type": "string",
                              "value": "[parameters('vnetResourceGroupName')]"
                            },
                            "virtualNetworkSubscriptionId": {
                              "type": "string",
                              "value": "[parameters('vnetSubscriptionId')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "virtualNetworkName": {
                      "type": "string",
                      "value": "[if(parameters('useExistingVnet'), reference(resourceId('Microsoft.Resources/deployments', 'existing-vnet-deployment'), '2022-09-01').outputs.virtualNetworkName.value, reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2022-09-01').outputs.virtualNetworkName.value)]"
                    },
                    "virtualNetworkId": {
                      "type": "string",
                      "value": "[if(parameters('useExistingVnet'), reference(resourceId('Microsoft.Resources/deployments', 'existing-vnet-deployment'), '2022-09-01').outputs.virtualNetworkId.value, reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2022-09-01').outputs.virtualNetworkId.value)]"
                    },
                    "virtualNetworkSubscriptionId": {
                      "type": "string",
                      "value": "[if(parameters('useExistingVnet'), reference(resourceId('Microsoft.Resources/deployments', 'existing-vnet-deployment'), '2022-09-01').outputs.virtualNetworkSubscriptionId.value, reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2022-09-01').outputs.virtualNetworkSubscriptionId.value)]"
                    },
                    "virtualNetworkResourceGroup": {
                      "type": "string",
                      "value": "[if(parameters('useExistingVnet'), reference(resourceId('Microsoft.Resources/deployments', 'existing-vnet-deployment'), '2022-09-01').outputs.virtualNetworkResourceGroup.value, reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2022-09-01').outputs.virtualNetworkResourceGroup.value)]"
                    },
                    "agentSubnetName": {
                      "type": "string",
                      "value": "[parameters('agentSubnetName')]"
                    },
                    "peSubnetName": {
                      "type": "string",
                      "value": "[parameters('peSubnetName')]"
                    },
                    "agentSubnetId": {
                      "type": "string",
                      "value": "[if(parameters('useExistingVnet'), reference(resourceId('Microsoft.Resources/deployments', 'existing-vnet-deployment'), '2022-09-01').outputs.agentSubnetId.value, reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2022-09-01').outputs.agentSubnetId.value)]"
                    },
                    "peSubnetId": {
                      "type": "string",
                      "value": "[if(parameters('useExistingVnet'), reference(resourceId('Microsoft.Resources/deployments', 'existing-vnet-deployment'), '2022-09-01').outputs.peSubnetId.value, reference(resourceId('Microsoft.Resources/deployments', 'vnet-deployment'), '2022-09-01').outputs.peSubnetId.value)]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('ai-{0}-{1}-deployment', variables('accountName'), variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "accountName": {
                    "value": "[variables('accountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "modelName": {
                    "value": "[parameters('modelName')]"
                  },
                  "modelFormat": {
                    "value": "[parameters('modelFormat')]"
                  },
                  "modelVersion": {
                    "value": "[parameters('modelVersion')]"
                  },
                  "modelSkuName": {
                    "value": "[parameters('modelSkuName')]"
                  },
                  "modelCapacity": {
                    "value": "[parameters('modelCapacity')]"
                  },
                  "agentSubnetId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix'))), '2022-09-01').outputs.agentSubnetId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "11881917012710137242"
                    }
                  },
                  "parameters": {
                    "accountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "modelName": {
                      "type": "string"
                    },
                    "modelFormat": {
                      "type": "string"
                    },
                    "modelVersion": {
                      "type": "string"
                    },
                    "modelSkuName": {
                      "type": "string"
                    },
                    "modelCapacity": {
                      "type": "int"
                    },
                    "agentSubnetId": {
                      "type": "string"
                    },
                    "networkInjection": {
                      "type": "string",
                      "defaultValue": "true"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.CognitiveServices/accounts",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[parameters('accountName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "S0"
                      },
                      "kind": "AIServices",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "allowProjectManagement": true,
                        "customSubDomainName": "[parameters('accountName')]",
                        "networkAcls": {
                          "defaultAction": "Deny",
                          "virtualNetworkRules": [],
                          "ipRules": [],
                          "bypass": "AzureServices"
                        },
                        "publicNetworkAccess": "Disabled",
                        "networkInjections": "[if(equals(parameters('networkInjection'), 'true'), createArray(createObject('scenario', 'agent', 'subnetArmId', parameters('agentSubnetId'), 'useMicrosoftManagedNetwork', false())), null())]",
                        "disableLocalAuth": false
                      }
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/deployments",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}', parameters('accountName'), parameters('modelName'))]",
                      "sku": {
                        "capacity": "[parameters('modelCapacity')]",
                        "name": "[parameters('modelSkuName')]"
                      },
                      "properties": {
                        "model": {
                          "name": "[parameters('modelName')]",
                          "format": "[parameters('modelFormat')]",
                          "version": "[parameters('modelVersion')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts', parameters('accountName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "accountName": {
                      "type": "string",
                      "value": "[parameters('accountName')]"
                    },
                    "accountID": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('accountName'))]"
                    },
                    "accountTarget": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('accountName')), '2025-04-01-preview').endpoint]"
                    },
                    "accountPrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('accountName')), '2025-04-01-preview', 'full').identity.principalId]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aiSearchResourceId": {
                    "value": "[parameters('aiSearchResourceId')]"
                  },
                  "azureStorageAccountResourceId": {
                    "value": "[parameters('azureStorageAccountResourceId')]"
                  },
                  "azureCosmosDBAccountResourceId": {
                    "value": "[parameters('azureCosmosDBAccountResourceId')]"
                  },
                  "apiManagementResourceId": {
                    "value": "[parameters('apiManagementResourceId')]"
                  },
                  "existingDnsZones": {
                    "value": "[parameters('existingDnsZones')]"
                  },
                  "dnsZoneNames": {
                    "value": "[parameters('dnsZoneNames')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "15369197585500198758"
                    }
                  },
                  "parameters": {
                    "aiSearchResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the AI Search Service."
                      }
                    },
                    "azureStorageAccountResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Azure Storage Account."
                      }
                    },
                    "azureCosmosDBAccountResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "ResourceId of Cosmos DB Account"
                      }
                    },
                    "apiManagementResourceId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Resource ID of the API Management service (optional)"
                      }
                    },
                    "existingDnsZones": {
                      "type": "object",
                      "metadata": {
                        "description": "Object mapping DNS zone names to their resource group, or empty string to indicate creation"
                      }
                    },
                    "dnsZoneNames": {
                      "type": "array",
                      "metadata": {
                        "description": "List of private DNS zone names to validate"
                      }
                    }
                  },
                  "variables": {
                    "storagePassedIn": "[not(equals(parameters('azureStorageAccountResourceId'), ''))]",
                    "searchPassedIn": "[not(equals(parameters('aiSearchResourceId'), ''))]",
                    "cosmosPassedIn": "[not(equals(parameters('azureCosmosDBAccountResourceId'), ''))]",
                    "apiManagementPassedIn": "[not(equals(parameters('apiManagementResourceId'), ''))]",
                    "storageParts": "[split(parameters('azureStorageAccountResourceId'), '/')]",
                    "azureStorageSubscriptionId": "[if(and(variables('storagePassedIn'), greater(length(variables('storageParts')), 2)), variables('storageParts')[2], subscription().subscriptionId)]",
                    "azureStorageResourceGroupName": "[if(and(variables('storagePassedIn'), greater(length(variables('storageParts')), 4)), variables('storageParts')[4], resourceGroup().name)]",
                    "acsParts": "[split(parameters('aiSearchResourceId'), '/')]",
                    "aiSearchServiceSubscriptionId": "[if(and(variables('searchPassedIn'), greater(length(variables('acsParts')), 2)), variables('acsParts')[2], subscription().subscriptionId)]",
                    "aiSearchServiceResourceGroupName": "[if(and(variables('searchPassedIn'), greater(length(variables('acsParts')), 4)), variables('acsParts')[4], resourceGroup().name)]",
                    "cosmosParts": "[split(parameters('azureCosmosDBAccountResourceId'), '/')]",
                    "cosmosDBSubscriptionId": "[if(and(variables('cosmosPassedIn'), greater(length(variables('cosmosParts')), 2)), variables('cosmosParts')[2], subscription().subscriptionId)]",
                    "cosmosDBResourceGroupName": "[if(and(variables('cosmosPassedIn'), greater(length(variables('cosmosParts')), 4)), variables('cosmosParts')[4], resourceGroup().name)]",
                    "apiManagementParts": "[split(parameters('apiManagementResourceId'), '/')]",
                    "apiManagementSubscriptionId": "[if(and(variables('apiManagementPassedIn'), greater(length(variables('apiManagementParts')), 2)), variables('apiManagementParts')[2], subscription().subscriptionId)]",
                    "apiManagementResourceGroupName": "[if(and(variables('apiManagementPassedIn'), greater(length(variables('apiManagementParts')), 4)), variables('apiManagementParts')[4], resourceGroup().name)]",
                    "dnsZoneTypes": [
                      "Microsoft.Network/privateDnsZones"
                    ]
                  },
                  "resources": [],
                  "outputs": {
                    "aiSearchExists": {
                      "type": "bool",
                      "value": "[and(variables('searchPassedIn'), equals(last(split(parameters('aiSearchResourceId'), '/')), variables('acsParts')[8]))]"
                    },
                    "cosmosDBExists": {
                      "type": "bool",
                      "value": "[and(variables('cosmosPassedIn'), equals(last(split(parameters('azureCosmosDBAccountResourceId'), '/')), variables('cosmosParts')[8]))]"
                    },
                    "azureStorageExists": {
                      "type": "bool",
                      "value": "[and(variables('storagePassedIn'), equals(last(split(parameters('azureStorageAccountResourceId'), '/')), variables('storageParts')[8]))]"
                    },
                    "apiManagementExists": {
                      "type": "bool",
                      "value": "[and(variables('apiManagementPassedIn'), equals(last(split(parameters('apiManagementResourceId'), '/')), variables('apiManagementParts')[8]))]"
                    },
                    "apiManagementName": {
                      "type": "string",
                      "value": "[if(variables('apiManagementPassedIn'), last(split(parameters('apiManagementResourceId'), '/')), '')]"
                    },
                    "aiSearchServiceSubscriptionId": {
                      "type": "string",
                      "value": "[variables('aiSearchServiceSubscriptionId')]"
                    },
                    "aiSearchServiceResourceGroupName": {
                      "type": "string",
                      "value": "[variables('aiSearchServiceResourceGroupName')]"
                    },
                    "cosmosDBSubscriptionId": {
                      "type": "string",
                      "value": "[variables('cosmosDBSubscriptionId')]"
                    },
                    "cosmosDBResourceGroupName": {
                      "type": "string",
                      "value": "[variables('cosmosDBResourceGroupName')]"
                    },
                    "azureStorageSubscriptionId": {
                      "type": "string",
                      "value": "[variables('azureStorageSubscriptionId')]"
                    },
                    "azureStorageResourceGroupName": {
                      "type": "string",
                      "value": "[variables('azureStorageResourceGroupName')]"
                    },
                    "apiManagementSubscriptionId": {
                      "type": "string",
                      "value": "[variables('apiManagementSubscriptionId')]"
                    },
                    "apiManagementResourceGroupName": {
                      "type": "string",
                      "value": "[variables('apiManagementResourceGroupName')]"
                    },
                    "dnsZoneExists": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('dnsZoneNames'))]",
                        "input": {
                          "name": "[parameters('dnsZoneNames')[copyIndex()]]",
                          "exists": "[not(empty(parameters('existingDnsZones')[parameters('dnsZoneNames')[copyIndex()]]))]"
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('dependencies-{0}-deployment', variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "azureStorageName": {
                    "value": "[variables('azureStorageName')]"
                  },
                  "aiSearchName": {
                    "value": "[variables('aiSearchName')]"
                  },
                  "cosmosDBName": {
                    "value": "[variables('cosmosDBName')]"
                  },
                  "aiSearchResourceId": {
                    "value": "[parameters('aiSearchResourceId')]"
                  },
                  "aiSearchExists": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.aiSearchExists.value]"
                  },
                  "azureStorageAccountResourceId": {
                    "value": "[parameters('azureStorageAccountResourceId')]"
                  },
                  "azureStorageExists": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageExists.value]"
                  },
                  "cosmosDBResourceId": {
                    "value": "[parameters('azureCosmosDBAccountResourceId')]"
                  },
                  "cosmosDBExists": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBExists.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "12678471838706931131"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region of the deployment"
                      }
                    },
                    "aiSearchName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the AI Search resource"
                      }
                    },
                    "azureStorageName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the storage account"
                      }
                    },
                    "cosmosDBName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the new Cosmos DB account"
                      }
                    },
                    "aiSearchResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The AI Search Service full ARM Resource ID. This is an optional field, and if not provided, the resource will be created."
                      }
                    },
                    "azureStorageAccountResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The AI Storage Account full ARM Resource ID. This is an optional field, and if not provided, the resource will be created."
                      }
                    },
                    "cosmosDBResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The Cosmos DB Account full ARM Resource ID. This is an optional field, and if not provided, the resource will be created."
                      }
                    },
                    "aiSearchExists": {
                      "type": "bool"
                    },
                    "azureStorageExists": {
                      "type": "bool"
                    },
                    "cosmosDBExists": {
                      "type": "bool"
                    },
                    "noZRSRegions": {
                      "type": "array",
                      "defaultValue": [
                        "southindia",
                        "westus"
                      ]
                    },
                    "sku": {
                      "type": "object",
                      "defaultValue": "[if(contains(parameters('noZRSRegions'), parameters('location')), createObject('name', 'Standard_GRS'), createObject('name', 'Standard_ZRS'))]"
                    }
                  },
                  "variables": {
                    "cosmosParts": "[split(parameters('cosmosDBResourceId'), '/')]",
                    "canaryRegions": [
                      "eastus2euap",
                      "centraluseuap"
                    ],
                    "cosmosDbRegion": "[if(contains(variables('canaryRegions'), parameters('location')), 'westus', parameters('location'))]",
                    "acsParts": "[split(parameters('aiSearchResourceId'), '/')]",
                    "azureStorageParts": "[split(parameters('azureStorageAccountResourceId'), '/')]"
                  },
                  "resources": [
                    {
                      "condition": "[not(parameters('cosmosDBExists'))]",
                      "type": "Microsoft.DocumentDB/databaseAccounts",
                      "apiVersion": "2024-11-15",
                      "name": "[parameters('cosmosDBName')]",
                      "location": "[variables('cosmosDbRegion')]",
                      "kind": "GlobalDocumentDB",
                      "properties": {
                        "consistencyPolicy": {
                          "defaultConsistencyLevel": "Session"
                        },
                        "disableLocalAuth": true,
                        "enableAutomaticFailover": false,
                        "enableMultipleWriteLocations": false,
                        "publicNetworkAccess": "Disabled",
                        "enableFreeTier": false,
                        "locations": [
                          {
                            "locationName": "[parameters('location')]",
                            "failoverPriority": 0,
                            "isZoneRedundant": false
                          }
                        ],
                        "databaseAccountOfferType": "Standard"
                      }
                    },
                    {
                      "condition": "[not(parameters('aiSearchExists'))]",
                      "type": "Microsoft.Search/searchServices",
                      "apiVersion": "2024-06-01-preview",
                      "name": "[parameters('aiSearchName')]",
                      "location": "[parameters('location')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "disableLocalAuth": false,
                        "authOptions": {
                          "aadOrApiKey": {
                            "aadAuthFailureMode": "http401WithBearerChallenge"
                          }
                        },
                        "encryptionWithCmk": {
                          "enforcement": "Unspecified"
                        },
                        "hostingMode": "default",
                        "partitionCount": 1,
                        "publicNetworkAccess": "disabled",
                        "replicaCount": 1,
                        "semanticSearch": "disabled",
                        "networkRuleSet": {
                          "bypass": "None",
                          "ipRules": []
                        }
                      },
                      "sku": {
                        "name": "standard"
                      }
                    },
                    {
                      "condition": "[not(parameters('azureStorageExists'))]",
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-05-01",
                      "name": "[parameters('azureStorageName')]",
                      "location": "[parameters('location')]",
                      "kind": "StorageV2",
                      "sku": "[parameters('sku')]",
                      "properties": {
                        "minimumTlsVersion": "TLS1_2",
                        "allowBlobPublicAccess": false,
                        "publicNetworkAccess": "Disabled",
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "defaultAction": "Deny",
                          "virtualNetworkRules": []
                        },
                        "allowSharedKeyAccess": false
                      }
                    }
                  ],
                  "outputs": {
                    "aiSearchName": {
                      "type": "string",
                      "value": "[if(parameters('aiSearchExists'), variables('acsParts')[8], parameters('aiSearchName'))]"
                    },
                    "aiSearchID": {
                      "type": "string",
                      "value": "[if(parameters('aiSearchExists'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('acsParts')[2], variables('acsParts')[4]), 'Microsoft.Search/searchServices', variables('acsParts')[8]), resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')))]"
                    },
                    "aiSearchServiceResourceGroupName": {
                      "type": "string",
                      "value": "[if(parameters('aiSearchExists'), variables('acsParts')[4], resourceGroup().name)]"
                    },
                    "aiSearchServiceSubscriptionId": {
                      "type": "string",
                      "value": "[if(parameters('aiSearchExists'), variables('acsParts')[2], subscription().subscriptionId)]"
                    },
                    "azureStorageName": {
                      "type": "string",
                      "value": "[if(parameters('azureStorageExists'), variables('azureStorageParts')[8], parameters('azureStorageName'))]"
                    },
                    "azureStorageId": {
                      "type": "string",
                      "value": "[if(parameters('azureStorageExists'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('azureStorageParts')[2], variables('azureStorageParts')[4]), 'Microsoft.Storage/storageAccounts', variables('azureStorageParts')[8]), resourceId('Microsoft.Storage/storageAccounts', parameters('azureStorageName')))]"
                    },
                    "azureStorageResourceGroupName": {
                      "type": "string",
                      "value": "[if(parameters('azureStorageExists'), variables('azureStorageParts')[4], resourceGroup().name)]"
                    },
                    "azureStorageSubscriptionId": {
                      "type": "string",
                      "value": "[if(parameters('azureStorageExists'), variables('azureStorageParts')[2], subscription().subscriptionId)]"
                    },
                    "cosmosDBName": {
                      "type": "string",
                      "value": "[if(parameters('cosmosDBExists'), variables('cosmosParts')[8], parameters('cosmosDBName'))]"
                    },
                    "cosmosDBId": {
                      "type": "string",
                      "value": "[if(parameters('cosmosDBExists'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('cosmosParts')[2], variables('cosmosParts')[4]), 'Microsoft.DocumentDB/databaseAccounts', variables('cosmosParts')[8]), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName')))]"
                    },
                    "cosmosDBResourceGroupName": {
                      "type": "string",
                      "value": "[if(parameters('cosmosDBExists'), variables('cosmosParts')[4], resourceGroup().name)]"
                    },
                    "cosmosDBSubscriptionId": {
                      "type": "string",
                      "value": "[if(parameters('cosmosDBExists'), variables('cosmosParts')[2], subscription().subscriptionId)]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-private-endpoint', variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aiAccountName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('accountName'), variables('uniqueSuffix'))), '2022-09-01').outputs.accountName.value]"
                  },
                  "aiSearchName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.aiSearchName.value]"
                  },
                  "storageName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageName.value]"
                  },
                  "cosmosDBName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBName.value]"
                  },
                  "apiManagementName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.apiManagementName.value]"
                  },
                  "vnetName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix'))), '2022-09-01').outputs.virtualNetworkName.value]"
                  },
                  "peSubnetName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix'))), '2022-09-01').outputs.peSubnetName.value]"
                  },
                  "suffix": {
                    "value": "[variables('uniqueSuffix')]"
                  },
                  "vnetResourceGroupName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix'))), '2022-09-01').outputs.virtualNetworkResourceGroup.value]"
                  },
                  "vnetSubscriptionId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix'))), '2022-09-01').outputs.virtualNetworkSubscriptionId.value]"
                  },
                  "cosmosDBSubscriptionId": {
                    "value": "[variables('cosmosDBSubscriptionId')]"
                  },
                  "cosmosDBResourceGroupName": {
                    "value": "[variables('cosmosDBResourceGroupName')]"
                  },
                  "aiSearchSubscriptionId": {
                    "value": "[variables('aiSearchServiceSubscriptionId')]"
                  },
                  "aiSearchResourceGroupName": {
                    "value": "[variables('aiSearchServiceResourceGroupName')]"
                  },
                  "storageAccountResourceGroupName": {
                    "value": "[variables('azureStorageResourceGroupName')]"
                  },
                  "storageAccountSubscriptionId": {
                    "value": "[variables('azureStorageSubscriptionId')]"
                  },
                  "apiManagementResourceGroupName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.apiManagementResourceGroupName.value]"
                  },
                  "apiManagementSubscriptionId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.apiManagementSubscriptionId.value]"
                  },
                  "existingDnsZones": {
                    "value": "[parameters('existingDnsZones')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "14373091188177026597"
                    }
                  },
                  "parameters": {
                    "aiAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AI Foundry account"
                      }
                    },
                    "aiSearchName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AI Search service"
                      }
                    },
                    "storageName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the storage account"
                      }
                    },
                    "cosmosDBName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Cosmos DB account"
                      }
                    },
                    "apiManagementName": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Name of the API Management service (optional)"
                      }
                    },
                    "vnetName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Vnet"
                      }
                    },
                    "peSubnetName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Customer subnet"
                      }
                    },
                    "suffix": {
                      "type": "string",
                      "metadata": {
                        "description": "Suffix for unique resource names"
                      }
                    },
                    "vnetResourceGroupName": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Resource Group name for existing Virtual Network (if different from current resource group)"
                      }
                    },
                    "vnetSubscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Subscription ID for Virtual Network"
                      }
                    },
                    "storageAccountResourceGroupName": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Resource Group name for Storage Account"
                      }
                    },
                    "storageAccountSubscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Subscription ID for Storage account"
                      }
                    },
                    "aiSearchSubscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Subscription ID for AI Search service"
                      }
                    },
                    "aiSearchResourceGroupName": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Resource Group name for AI Search service"
                      }
                    },
                    "cosmosDBSubscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Subscription ID for Cosmos DB account"
                      }
                    },
                    "cosmosDBResourceGroupName": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Resource group name for Cosmos DB account"
                      }
                    },
                    "apiManagementSubscriptionId": {
                      "type": "string",
                      "defaultValue": "[subscription().subscriptionId]",
                      "metadata": {
                        "description": "Subscription ID for API Management service (optional)"
                      }
                    },
                    "apiManagementResourceGroupName": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().name]",
                      "metadata": {
                        "description": "Resource group name for API Management service (optional)"
                      }
                    },
                    "existingDnsZones": {
                      "type": "object",
                      "defaultValue": {
                        "privatelink.services.ai.azure.com": "",
                        "privatelink.openai.azure.com": "",
                        "privatelink.cognitiveservices.azure.com": "",
                        "privatelink.search.windows.net": "",
                        "[format('privatelink.blob.{0}', environment().suffixes.storage)]": "",
                        "privatelink.documents.azure.com": "",
                        "privatelink.azure-api.net": ""
                      },
                      "metadata": {
                        "description": "Map of DNS zone FQDNs to resource group names. If provided, reference existing DNS zones in this resource group instead of creating them."
                      }
                    }
                  },
                  "variables": {
                    "aiServicesDnsZoneName": "privatelink.services.ai.azure.com",
                    "openAiDnsZoneName": "privatelink.openai.azure.com",
                    "cognitiveServicesDnsZoneName": "privatelink.cognitiveservices.azure.com",
                    "aiSearchDnsZoneName": "privatelink.search.windows.net",
                    "storageDnsZoneName": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
                    "cosmosDBDnsZoneName": "privatelink.documents.azure.com",
                    "apiManagementDnsZoneName": "privatelink.azure-api.net",
                    "aiServicesDnsZoneRG": "[parameters('existingDnsZones')[variables('aiServicesDnsZoneName')]]",
                    "openAiDnsZoneRG": "[parameters('existingDnsZones')[variables('openAiDnsZoneName')]]",
                    "cognitiveServicesDnsZoneRG": "[parameters('existingDnsZones')[variables('cognitiveServicesDnsZoneName')]]",
                    "aiSearchDnsZoneRG": "[parameters('existingDnsZones')[variables('aiSearchDnsZoneName')]]",
                    "storageDnsZoneRG": "[parameters('existingDnsZones')[variables('storageDnsZoneName')]]",
                    "cosmosDBDnsZoneRG": "[parameters('existingDnsZones')[variables('cosmosDBDnsZoneName')]]",
                    "apiManagementDnsZoneRG": "[parameters('existingDnsZones')[variables('apiManagementDnsZoneName')]]",
                    "aiServicesDnsZoneId": "[if(empty(variables('aiServicesDnsZoneRG')), resourceId('Microsoft.Network/privateDnsZones', variables('aiServicesDnsZoneName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('aiServicesDnsZoneRG')), 'Microsoft.Network/privateDnsZones', variables('aiServicesDnsZoneName')))]",
                    "openAiDnsZoneId": "[if(empty(variables('openAiDnsZoneRG')), resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('openAiDnsZoneRG')), 'Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName')))]",
                    "cognitiveServicesDnsZoneId": "[if(empty(variables('cognitiveServicesDnsZoneRG')), resourceId('Microsoft.Network/privateDnsZones', variables('cognitiveServicesDnsZoneName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('cognitiveServicesDnsZoneRG')), 'Microsoft.Network/privateDnsZones', variables('cognitiveServicesDnsZoneName')))]",
                    "aiSearchDnsZoneId": "[if(empty(variables('aiSearchDnsZoneRG')), resourceId('Microsoft.Network/privateDnsZones', variables('aiSearchDnsZoneName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('aiSearchDnsZoneRG')), 'Microsoft.Network/privateDnsZones', variables('aiSearchDnsZoneName')))]",
                    "storageDnsZoneId": "[if(empty(variables('storageDnsZoneRG')), resourceId('Microsoft.Network/privateDnsZones', variables('storageDnsZoneName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('storageDnsZoneRG')), 'Microsoft.Network/privateDnsZones', variables('storageDnsZoneName')))]",
                    "cosmosDBDnsZoneId": "[if(empty(variables('cosmosDBDnsZoneRG')), resourceId('Microsoft.Network/privateDnsZones', variables('cosmosDBDnsZoneName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('cosmosDBDnsZoneRG')), 'Microsoft.Network/privateDnsZones', variables('cosmosDBDnsZoneName')))]",
                    "apiManagementDnsZoneId": "[if(not(empty(parameters('apiManagementName'))), if(empty(variables('apiManagementDnsZoneRG')), resourceId('Microsoft.Network/privateDnsZones', variables('apiManagementDnsZoneName')), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('apiManagementDnsZoneRG')), 'Microsoft.Network/privateDnsZones', variables('apiManagementDnsZoneName'))), '')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}-private-endpoint', parameters('aiAccountName'))]",
                      "location": "[resourceGroup().location]",
                      "properties": {
                        "subnet": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('peSubnetName'))]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[format('{0}-private-link-service-connection', parameters('aiAccountName'))]",
                            "properties": {
                              "privateLinkServiceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiAccountName'))]",
                              "groupIds": [
                                "account"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}-private-endpoint', parameters('aiSearchName'))]",
                      "location": "[resourceGroup().location]",
                      "properties": {
                        "subnet": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('peSubnetName'))]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[format('{0}-private-link-service-connection', parameters('aiSearchName'))]",
                            "properties": {
                              "privateLinkServiceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('aiSearchSubscriptionId'), parameters('aiSearchResourceGroupName')), 'Microsoft.Search/searchServices', parameters('aiSearchName'))]",
                              "groupIds": [
                                "searchService"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}-private-endpoint', parameters('storageName'))]",
                      "location": "[resourceGroup().location]",
                      "properties": {
                        "subnet": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('peSubnetName'))]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[format('{0}-private-link-service-connection', parameters('storageName'))]",
                            "properties": {
                              "privateLinkServiceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('storageAccountSubscriptionId'), parameters('storageAccountResourceGroupName')), 'Microsoft.Storage/storageAccounts', parameters('storageName'))]",
                              "groupIds": [
                                "blob"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}-private-endpoint', parameters('cosmosDBName'))]",
                      "location": "[resourceGroup().location]",
                      "properties": {
                        "subnet": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('peSubnetName'))]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[format('{0}-private-link-service-connection', parameters('cosmosDBName'))]",
                            "properties": {
                              "privateLinkServiceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('cosmosDBSubscriptionId'), parameters('cosmosDBResourceGroupName')), 'Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName'))]",
                              "groupIds": [
                                "Sql"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('apiManagementName')))]",
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}-private-endpoint', parameters('apiManagementName'))]",
                      "location": "[resourceGroup().location]",
                      "properties": {
                        "subnet": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('peSubnetName'))]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[format('{0}-private-link-service-connection', parameters('apiManagementName'))]",
                            "properties": {
                              "privateLinkServiceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('apiManagementSubscriptionId'), parameters('apiManagementResourceGroupName')), 'Microsoft.ApiManagement/service', parameters('apiManagementName'))]",
                              "groupIds": [
                                "Gateway"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[empty(variables('aiServicesDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('aiServicesDnsZoneName')]",
                      "location": "global"
                    },
                    {
                      "condition": "[empty(variables('openAiDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('openAiDnsZoneName')]",
                      "location": "global"
                    },
                    {
                      "condition": "[empty(variables('cognitiveServicesDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('cognitiveServicesDnsZoneName')]",
                      "location": "global"
                    },
                    {
                      "condition": "[empty(variables('aiSearchDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('aiSearchDnsZoneName')]",
                      "location": "global"
                    },
                    {
                      "condition": "[empty(variables('storageDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('storageDnsZoneName')]",
                      "location": "global"
                    },
                    {
                      "condition": "[empty(variables('cosmosDBDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('cosmosDBDnsZoneName')]",
                      "location": "global"
                    },
                    {
                      "condition": "[and(empty(variables('apiManagementDnsZoneRG')), not(empty(parameters('apiManagementName'))))]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('apiManagementDnsZoneName')]",
                      "location": "global"
                    },
                    {
                      "condition": "[empty(variables('aiServicesDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2024-06-01",
                      "name": "[format('{0}/{1}', variables('aiServicesDnsZoneName'), format('aiServices-{0}-link', parameters('suffix')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('aiServicesDnsZoneName'))]"
                      ]
                    },
                    {
                      "condition": "[empty(variables('openAiDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2024-06-01",
                      "name": "[format('{0}/{1}', variables('openAiDnsZoneName'), format('aiServicesOpenAI-{0}-link', parameters('suffix')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))]"
                      ]
                    },
                    {
                      "condition": "[empty(variables('cognitiveServicesDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2024-06-01",
                      "name": "[format('{0}/{1}', variables('cognitiveServicesDnsZoneName'), format('aiServicesCognitiveServices-{0}-link', parameters('suffix')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('cognitiveServicesDnsZoneName'))]"
                      ]
                    },
                    {
                      "condition": "[empty(variables('aiSearchDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2024-06-01",
                      "name": "[format('{0}/{1}', variables('aiSearchDnsZoneName'), format('aiSearch-{0}-link', parameters('suffix')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('aiSearchDnsZoneName'))]"
                      ]
                    },
                    {
                      "condition": "[empty(variables('storageDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2024-06-01",
                      "name": "[format('{0}/{1}', variables('storageDnsZoneName'), format('storage-{0}-link', parameters('suffix')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('storageDnsZoneName'))]"
                      ]
                    },
                    {
                      "condition": "[empty(variables('cosmosDBDnsZoneRG'))]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2024-06-01",
                      "name": "[format('{0}/{1}', variables('cosmosDBDnsZoneName'), format('cosmosDB-{0}-link', parameters('suffix')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('cosmosDBDnsZoneName'))]"
                      ]
                    },
                    {
                      "condition": "[and(empty(variables('apiManagementDnsZoneRG')), not(empty(parameters('apiManagementName'))))]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2024-06-01",
                      "name": "[format('{0}/{1}', variables('apiManagementDnsZoneName'), format('apiManagement-{0}-link', parameters('suffix')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('vnetSubscriptionId'), parameters('vnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('apiManagementDnsZoneName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', format('{0}-private-endpoint', parameters('aiAccountName')), format('{0}-dns-group', parameters('aiAccountName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('{0}-dns-aiserv-config', parameters('aiAccountName'))]",
                            "properties": {
                              "privateDnsZoneId": "[variables('aiServicesDnsZoneId')]"
                            }
                          },
                          {
                            "name": "[format('{0}-dns-openai-config', parameters('aiAccountName'))]",
                            "properties": {
                              "privateDnsZoneId": "[variables('openAiDnsZoneId')]"
                            }
                          },
                          {
                            "name": "[format('{0}-dns-cogserv-config', parameters('aiAccountName'))]",
                            "properties": {
                              "privateDnsZoneId": "[variables('cognitiveServicesDnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-private-endpoint', parameters('aiAccountName')))]",
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('aiServicesDnsZoneName'))]",
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('cognitiveServicesDnsZoneName'))]",
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('openAiDnsZoneName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', format('{0}-private-endpoint', parameters('aiSearchName')), format('{0}-dns-group', parameters('aiSearchName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('{0}-dns-config', parameters('aiSearchName'))]",
                            "properties": {
                              "privateDnsZoneId": "[variables('aiSearchDnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('aiSearchDnsZoneName'))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-private-endpoint', parameters('aiSearchName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', format('{0}-private-endpoint', parameters('storageName')), format('{0}-dns-group', parameters('storageName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('{0}-dns-config', parameters('storageName'))]",
                            "properties": {
                              "privateDnsZoneId": "[variables('storageDnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('storageDnsZoneName'))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-private-endpoint', parameters('storageName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', format('{0}-private-endpoint', parameters('cosmosDBName')), format('{0}-dns-group', parameters('cosmosDBName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('{0}-dns-config', parameters('cosmosDBName'))]",
                            "properties": {
                              "privateDnsZoneId": "[variables('cosmosDBDnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('cosmosDBDnsZoneName'))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-private-endpoint', parameters('cosmosDBName')))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('apiManagementName')))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-05-01",
                      "name": "[format('{0}/{1}', format('{0}-private-endpoint', parameters('apiManagementName')), format('{0}-dns-group', parameters('apiManagementName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('{0}-dns-config', parameters('apiManagementName'))]",
                            "properties": {
                              "privateDnsZoneId": "[variables('apiManagementDnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', variables('apiManagementDnsZoneName'), format('apiManagement-{0}-link', parameters('suffix')))]",
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('apiManagementDnsZoneName'))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-private-endpoint', parameters('apiManagementName')))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('accountName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('validate-existing-resources-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('vnet-{0}-{1}-deployment', variables('trimVnetName'), variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "projectName": {
                    "value": "[variables('projectName')]"
                  },
                  "projectDescription": {
                    "value": "[parameters('projectDescription')]"
                  },
                  "displayName": {
                    "value": "[parameters('displayName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "aiSearchName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.aiSearchName.value]"
                  },
                  "aiSearchServiceResourceGroupName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.aiSearchServiceResourceGroupName.value]"
                  },
                  "aiSearchServiceSubscriptionId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.aiSearchServiceSubscriptionId.value]"
                  },
                  "cosmosDBName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBName.value]"
                  },
                  "cosmosDBSubscriptionId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBSubscriptionId.value]"
                  },
                  "cosmosDBResourceGroupName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBResourceGroupName.value]"
                  },
                  "azureStorageName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageName.value]"
                  },
                  "azureStorageSubscriptionId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageSubscriptionId.value]"
                  },
                  "azureStorageResourceGroupName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageResourceGroupName.value]"
                  },
                  "accountName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('accountName'), variables('uniqueSuffix'))), '2022-09-01').outputs.accountName.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "13015324414040487580"
                    }
                  },
                  "parameters": {
                    "accountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "projectName": {
                      "type": "string"
                    },
                    "projectDescription": {
                      "type": "string"
                    },
                    "displayName": {
                      "type": "string"
                    },
                    "aiSearchName": {
                      "type": "string"
                    },
                    "aiSearchServiceResourceGroupName": {
                      "type": "string"
                    },
                    "aiSearchServiceSubscriptionId": {
                      "type": "string"
                    },
                    "cosmosDBName": {
                      "type": "string"
                    },
                    "cosmosDBSubscriptionId": {
                      "type": "string"
                    },
                    "cosmosDBResourceGroupName": {
                      "type": "string"
                    },
                    "azureStorageName": {
                      "type": "string"
                    },
                    "azureStorageSubscriptionId": {
                      "type": "string"
                    },
                    "azureStorageResourceGroupName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), parameters('cosmosDBName'))]",
                      "properties": {
                        "category": "CosmosDB",
                        "target": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('cosmosDBSubscriptionId'), parameters('cosmosDBResourceGroupName')), 'Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName')), '2024-12-01-preview').documentEndpoint]",
                        "authType": "AAD",
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('cosmosDBSubscriptionId'), parameters('cosmosDBResourceGroupName')), 'Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName'))]",
                          "location": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('cosmosDBSubscriptionId'), parameters('cosmosDBResourceGroupName')), 'Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName')), '2024-12-01-preview', 'full').location]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('accountName'), parameters('projectName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), parameters('azureStorageName'))]",
                      "properties": {
                        "category": "AzureStorageAccount",
                        "target": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('azureStorageSubscriptionId'), parameters('azureStorageResourceGroupName')), 'Microsoft.Storage/storageAccounts', parameters('azureStorageName')), '2023-05-01').primaryEndpoints.blob]",
                        "authType": "AAD",
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('azureStorageSubscriptionId'), parameters('azureStorageResourceGroupName')), 'Microsoft.Storage/storageAccounts', parameters('azureStorageName'))]",
                          "location": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('azureStorageSubscriptionId'), parameters('azureStorageResourceGroupName')), 'Microsoft.Storage/storageAccounts', parameters('azureStorageName')), '2023-05-01', 'full').location]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('accountName'), parameters('projectName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects/connections",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), parameters('aiSearchName'))]",
                      "properties": {
                        "category": "CognitiveSearch",
                        "target": "[format('https://{0}.search.windows.net', parameters('aiSearchName'))]",
                        "authType": "AAD",
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('aiSearchServiceSubscriptionId'), parameters('aiSearchServiceResourceGroupName')), 'Microsoft.Search/searchServices', parameters('aiSearchName'))]",
                          "location": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('aiSearchServiceSubscriptionId'), parameters('aiSearchServiceResourceGroupName')), 'Microsoft.Search/searchServices', parameters('aiSearchName')), '2024-06-01-preview', 'full').location]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('accountName'), parameters('projectName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}', parameters('accountName'), parameters('projectName'))]",
                      "location": "[parameters('location')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "description": "[parameters('projectDescription')]",
                        "displayName": "[parameters('displayName')]"
                      }
                    }
                  ],
                  "outputs": {
                    "projectName": {
                      "type": "string",
                      "value": "[parameters('projectName')]"
                    },
                    "projectId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('accountName'), parameters('projectName'))]"
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('accountName'), parameters('projectName')), '2025-04-01-preview', 'full').identity.principalId]"
                    },
                    "projectWorkspaceId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('accountName'), parameters('projectName')), '2025-04-01-preview').internalId]"
                    },
                    "cosmosDBConnection": {
                      "type": "string",
                      "value": "[parameters('cosmosDBName')]"
                    },
                    "azureStorageConnection": {
                      "type": "string",
                      "value": "[parameters('azureStorageName')]"
                    },
                    "aiSearchConnection": {
                      "type": "string",
                      "value": "[parameters('aiSearchName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('accountName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}-private-endpoint', variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('format-project-workspace-id-{0}-deployment', variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "projectWorkspaceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.projectWorkspaceId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "8377605865688192705"
                    }
                  },
                  "parameters": {
                    "projectWorkspaceId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "part1": "[substring(parameters('projectWorkspaceId'), 0, 8)]",
                    "part2": "[substring(parameters('projectWorkspaceId'), 8, 4)]",
                    "part3": "[substring(parameters('projectWorkspaceId'), 12, 4)]",
                    "part4": "[substring(parameters('projectWorkspaceId'), 16, 4)]",
                    "part5": "[substring(parameters('projectWorkspaceId'), 20, 12)]",
                    "formattedGuid": "[format('{0}-{1}-{2}-{3}-{4}', variables('part1'), variables('part2'), variables('part3'), variables('part4'), variables('part5'))]"
                  },
                  "resources": [],
                  "outputs": {
                    "projectWorkspaceIdGuid": {
                      "type": "string",
                      "value": "[variables('formattedGuid')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('storage-ra-{0}-deployment', variables('uniqueSuffix'))]",
              "subscriptionId": "[variables('azureStorageSubscriptionId')]",
              "resourceGroup": "[variables('azureStorageResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "azureStorageName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageName.value]"
                  },
                  "projectPrincipalId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.projectPrincipalId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "4249888543967924849"
                    }
                  },
                  "parameters": {
                    "azureStorageName": {
                      "type": "string"
                    },
                    "projectPrincipalId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('azureStorageName'))]",
                      "name": "[guid(parameters('projectPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), resourceId('Microsoft.Storage/storageAccounts', parameters('azureStorageName')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}-private-endpoint', variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('cosmos-account-ra-{0}-deployment', variables('uniqueSuffix'))]",
              "subscriptionId": "[variables('cosmosDBSubscriptionId')]",
              "resourceGroup": "[variables('cosmosDBResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "cosmosDBName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBName.value]"
                  },
                  "projectPrincipalId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.projectPrincipalId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "6132395890022031665"
                    }
                  },
                  "parameters": {
                    "cosmosDBName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AI Search resource"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the AI project"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosDBName'))]",
                      "name": "[guid(parameters('projectPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBName')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '230815da-be43-4aae-9cb4-875f7bd000aa')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}-private-endpoint', variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('ai-search-ra-{0}-deployment', variables('uniqueSuffix'))]",
              "subscriptionId": "[variables('aiSearchServiceSubscriptionId')]",
              "resourceGroup": "[variables('aiSearchServiceResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aiSearchName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.aiSearchName.value]"
                  },
                  "projectPrincipalId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.projectPrincipalId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "1394521226822648818"
                    }
                  },
                  "parameters": {
                    "aiSearchName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AI Search resource"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the AI project"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(parameters('projectPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7'), resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                        "principalType": "ServicePrincipal"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
                      "name": "[guid(parameters('projectPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0'), resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}-private-endpoint', variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('capabilityHost-configuration-{0}-deployment', variables('uniqueSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "accountName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('accountName'), variables('uniqueSuffix'))), '2022-09-01').outputs.accountName.value]"
                  },
                  "projectName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.projectName.value]"
                  },
                  "cosmosDBConnection": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBConnection.value]"
                  },
                  "azureStorageConnection": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageConnection.value]"
                  },
                  "aiSearchConnection": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.aiSearchConnection.value]"
                  },
                  "projectCapHost": {
                    "value": "[parameters('projectCapHost')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "17808151692204226228"
                    }
                  },
                  "parameters": {
                    "cosmosDBConnection": {
                      "type": "string"
                    },
                    "azureStorageConnection": {
                      "type": "string"
                    },
                    "aiSearchConnection": {
                      "type": "string"
                    },
                    "projectName": {
                      "type": "string"
                    },
                    "accountName": {
                      "type": "string"
                    },
                    "projectCapHost": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "threadConnections": [
                      "[format('{0}', parameters('cosmosDBConnection'))]"
                    ],
                    "storageConnections": [
                      "[format('{0}', parameters('azureStorageConnection'))]"
                    ],
                    "vectorStoreConnections": [
                      "[format('{0}', parameters('aiSearchConnection'))]"
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects/capabilityHosts",
                      "apiVersion": "2025-04-01-preview",
                      "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('projectName'), parameters('projectCapHost'))]",
                      "properties": {
                        "capabilityHostKind": "Agents",
                        "vectorStoreConnections": "[variables('vectorStoreConnections')]",
                        "storageConnections": "[variables('storageConnections')]",
                        "threadStorageConnections": "[variables('threadConnections')]"
                      }
                    }
                  ],
                  "outputs": {
                    "projectCapHost": {
                      "type": "string",
                      "value": "[parameters('projectCapHost')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('accountName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('aiSearchServiceSubscriptionId'), variables('aiSearchServiceResourceGroupName')), 'Microsoft.Resources/deployments', format('ai-search-ra-{0}-deployment', variables('uniqueSuffix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('cosmosDBSubscriptionId'), variables('cosmosDBResourceGroupName')), 'Microsoft.Resources/deployments', format('cosmos-account-ra-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('{0}-private-endpoint', variables('uniqueSuffix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('azureStorageSubscriptionId'), variables('azureStorageResourceGroupName')), 'Microsoft.Resources/deployments', format('storage-ra-{0}-deployment', variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('storage-containers-ra-{0}-deployment', variables('uniqueSuffix'))]",
              "subscriptionId": "[variables('azureStorageSubscriptionId')]",
              "resourceGroup": "[variables('azureStorageResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "aiProjectPrincipalId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.projectPrincipalId.value]"
                  },
                  "storageName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.azureStorageName.value]"
                  },
                  "workspaceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('format-project-workspace-id-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.projectWorkspaceIdGuid.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "15407014014992135484"
                    }
                  },
                  "parameters": {
                    "storageName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the storage account"
                      }
                    },
                    "aiProjectPrincipalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Principal ID of the AI Project"
                      }
                    },
                    "workspaceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Workspace Id of the AI Project"
                      }
                    }
                  },
                  "variables": {
                    "conditionStr": "[format('((!(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/read''}})  AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/filter/action''}}) AND  !(ActionMatches{{''Microsoft.Storage/storageAccounts/blobServices/containers/blobs/tags/write''}}) ) OR (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringStartsWithIgnoreCase ''{0}'' AND @Resource[Microsoft.Storage/storageAccounts/blobServices/containers:name] StringLikeIgnoreCase ''*-azureml-agent''))', parameters('workspaceId'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
                      "name": "[guid(resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b'), resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')))]",
                      "properties": {
                        "principalId": "[parameters('aiProjectPrincipalId')]",
                        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                        "principalType": "ServicePrincipal",
                        "conditionVersion": "2.0",
                        "condition": "[variables('conditionStr')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('capabilityHost-configuration-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('format-project-workspace-id-{0}-deployment', variables('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('cosmos-container-ra-{0}-deployment', variables('uniqueSuffix'))]",
              "subscriptionId": "[variables('cosmosDBSubscriptionId')]",
              "resourceGroup": "[variables('cosmosDBResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "cosmosAccountName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.cosmosDBName.value]"
                  },
                  "projectWorkspaceId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('format-project-workspace-id-{0}-deployment', variables('uniqueSuffix'))), '2022-09-01').outputs.projectWorkspaceIdGuid.value]"
                  },
                  "projectPrincipalId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix'))), '2022-09-01').outputs.projectPrincipalId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "1567375665913909101"
                    }
                  },
                  "parameters": {
                    "cosmosAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AI Search resource"
                      }
                    },
                    "projectPrincipalId": {
                      "type": "string",
                      "metadata": {
                        "description": "Project name"
                      }
                    },
                    "projectWorkspaceId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "userThreadName": "[format('{0}-thread-message-store', parameters('projectWorkspaceId'))]",
                    "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmosAccountName'), '00000000-0000-0000-0000-000000000002')]",
                    "accountScope": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/dbs/enterprise_memory', subscription().subscriptionId, resourceGroup().name, parameters('cosmosAccountName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                      "apiVersion": "2022-05-15",
                      "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(parameters('projectWorkspaceId'), resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), 'enterprise_memory', variables('userThreadName')), variables('roleDefinitionId'), parameters('projectPrincipalId')))]",
                      "properties": {
                        "principalId": "[parameters('projectPrincipalId')]",
                        "roleDefinitionId": "[variables('roleDefinitionId')]",
                        "scope": "[variables('accountScope')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('capabilityHost-configuration-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('dependencies-{0}-deployment', variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('ai-{0}-{1}-deployment', variables('projectName'), variables('uniqueSuffix')))]",
                "[resourceId('Microsoft.Resources/deployments', format('format-project-workspace-id-{0}-deployment', variables('uniqueSuffix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('azureStorageSubscriptionId'), variables('azureStorageResourceGroupName')), 'Microsoft.Resources/deployments', format('storage-containers-ra-{0}-deployment', variables('uniqueSuffix')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-naming-{0}', variables('resolvedTargetResourceGroup')), 64))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('resolvedSubscriptionId'), variables('resolvedTargetResourceGroup')), 'Microsoft.Resources/deployments', take(format('foundryv2-dns-{0}', variables('resolvedTargetResourceGroup')), 64))]"
      ]
    }
  ]
}